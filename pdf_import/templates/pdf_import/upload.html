{% extends "base.html" %}
{% load static %}

{% block title %}PDFæ™ºèƒ½å¯¼å…¥{% endblock %}

{% block extra_css %}
<style>
    .upload-container {
        max-width: 900px;
        margin: 40px auto;
    }
    
    .upload-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 30px;
    }
    
    .upload-header {
        text-align: center;
        margin-bottom: 30px;
    }
    
    .upload-header h2 {
        color: #2c3e50;
        margin-bottom: 10px;
    }
    
    .upload-method {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 25px;
        margin-bottom: 20px;
        transition: all 0.3s;
    }
    
    .upload-method:hover {
        border-color: #007bff;
        background: #e7f3ff;
    }
    
    .file-preview {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        margin-top: 20px;
    }
    
    .file-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .file-item:last-child {
        border-bottom: none;
    }
    
    .file-icon {
        color: #dc3545;
        font-size: 24px;
        margin-right: 15px;
    }
    
    .info-box {
        background: #e7f3ff;
        border-left: 4px solid #007bff;
        padding: 15px;
        margin-top: 20px;
        border-radius: 4px;
    }
    
    .supported-types {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 20px;
        margin-top: 20px;
    }
    
    .type-badge {
        display: inline-block;
        background: #007bff;
        color: white;
        padding: 5px 12px;
        border-radius: 4px;
        margin: 5px;
        font-size: 13px;
    }
</style>
{% endblock %}

{% block content %}
<div class="upload-container">
    <div class="upload-card">
        <div class="upload-header">
            <h2>ğŸ“„ PDFæ™ºèƒ½å¯¼å…¥</h2>
            <p class="text-muted">æ”¯æŒè‡ªåŠ¨è¯†åˆ«é‡‡è´­æ–‡ä»¶ç±»å‹ï¼Œæå–22ä¸ªå…³é”®å­—æ®µ</p>
        </div>

        {% if messages %}
        <div class="mb-3">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" id="uploadForm">
            {% csrf_token %}
            
            <!-- æ–¹å¼1: é€‰æ‹©æ–‡ä»¶å¤¹ -->
            <div class="upload-method">
                <h5>ğŸ—‚ï¸ æ–¹å¼1ï¼šé€‰æ‹©æ–‡ä»¶å¤¹ï¼ˆæ¨èï¼‰</h5>
                <p class="text-muted small mb-3">ç³»ç»Ÿä¼šè‡ªåŠ¨æ‰«ææ–‡ä»¶å¤¹ä¸­çš„æ‰€æœ‰PDFæ–‡ä»¶</p>
                <input type="file" 
                       class="form-control" 
                       id="folder_input" 
                       name="pdf_files"
                       webkitdirectory 
                       directory 
                       multiple 
                       accept=".pdf">
            </div>

            <div class="text-center my-3">
                <strong class="text-muted">æˆ–</strong>
            </div>

            <!-- æ–¹å¼2: å¤šé€‰æ–‡ä»¶ -->
            <div class="upload-method">
                <h5>ğŸ“„ æ–¹å¼2ï¼šå¤šé€‰PDFæ–‡ä»¶</h5>
                <p class="text-muted small mb-3">æŒ‰ä½Ctrl/Cmdé”®å¯é€‰æ‹©å¤šä¸ªæ–‡ä»¶ï¼ˆæœ€å¤š10ä¸ªï¼‰</p>
                <input type="file" 
                       class="form-control" 
                       id="file_input" 
                       name="pdf_files"
                       multiple 
                       accept=".pdf">
            </div>

            <!-- æ–‡ä»¶é¢„è§ˆ -->
            <div id="file_preview" class="file-preview" style="display:none;">
                <h6>å·²é€‰æ‹©æ–‡ä»¶ï¼š</h6>
                <div id="file_list"></div>
            </div>

            <!-- æäº¤æŒ‰é’® -->
            <div class="d-grid gap-2 mt-4">
                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                    <i class="bi bi-upload"></i> ä¸Šä¼ å¹¶è¯†åˆ«
                </button>
                <a href="{% url 'procurement_list' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> è¿”å›åˆ—è¡¨
                </a>
            </div>
        </form>

        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="info-box">
            <h6><i class="bi bi-info-circle"></i> ä½¿ç”¨è¯´æ˜</h6>
            <ul class="mb-0 small">
                <li><strong>æ™ºèƒ½è¿‡æ»¤ï¼š</strong>ç³»ç»Ÿä»…å¤„ç†æ–‡ä»¶ååŒ…å«ç‰¹å®šç¼–å·çš„PDFï¼ˆ2-21ã€2-23ã€2-24ã€2-25ã€2-44ã€2-45ã€2-47ï¼‰</li>
                <li><strong>è‡ªåŠ¨è¯†åˆ«ï¼š</strong>è‡ªåŠ¨è¯†åˆ«PDFç±»å‹ï¼ˆé‡‡è´­è¯·ç¤ºã€é‡‡è´­å…¬å‘Šã€å€™é€‰äººå…¬ç¤ºã€ç»“æœå…¬ç¤ºï¼‰</li>
                <li><strong>æ•°æ®æå–ï¼š</strong>è‡ªåŠ¨æå–22ä¸ªå…³é”®å­—æ®µï¼Œå‡†ç¡®ç‡â‰¥85%</li>
                <li><strong>æ‰¹é‡å¤„ç†ï¼š</strong>æ”¯æŒæ–‡ä»¶å¤¹æ‰¹é‡ä¸Šä¼ ï¼Œè‡ªåŠ¨ç­›é€‰å¹¶è¿‡æ»¤ä¸ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶</li>
                <li>å•ä¸ªæ–‡ä»¶å¤§å°é™åˆ¶ï¼š10MB</li>
            </ul>
        </div>

        <!-- æ”¯æŒçš„PDFç±»å‹ -->
        <div class="supported-types">
            <h6>ğŸ“‹ æ”¯æŒå¤„ç†çš„PDFç±»å‹ï¼ˆå¿…é¡»åŒ…å«ä»¥ä¸‹ç¼–å·ï¼‰ï¼š</h6>
            <div>
                <span class="type-badge">2-21 é‡‡è´­æ§åˆ¶ä»·å®¡æ‰¹</span>
                <span class="type-badge">2-23 é‡‡è´­è¯·ç¤º</span>
                <span class="type-badge">2-24 é‡‡è´­å…¬å‘Š</span>
                <span class="type-badge">2-25 é‡‡è´­ç»“æœå®¡æ‰¹</span>
                <span class="type-badge">2-44 é‡‡è´­ç»“æœå®¡æ‰¹</span>
                <span class="type-badge">2-45 å€™é€‰äººå…¬ç¤º</span>
                <span class="type-badge">2-47 ç»“æœå…¬ç¤º</span>
            </div>
            <p class="text-muted small mt-2 mb-0">
                <i class="bi bi-exclamation-circle"></i> <strong>é‡è¦æç¤ºï¼š</strong>æ–‡ä»¶åå¿…é¡»åŒ…å«ä¸Šè¿°ç¼–å·ä¹‹ä¸€ï¼Œå¦åˆ™å°†è¢«è‡ªåŠ¨è¿‡æ»¤ã€‚ä¾‹å¦‚ï¼š<code>2-21.é‡‡è´­æ§åˆ¶ä»·OAå®¡æ‰¹.pdf</code>
            </p>
        </div>
    </div>
</div>

<script>
// å…è®¸çš„PDFæ–‡ä»¶ç¼–å·ï¼ˆå·²è¿‡æ»¤2-25ï¼Œå› ä¸ºå®ƒä¸2-24é‡å¤ï¼‰
const ALLOWED_NUMBERS = ['2-21', '2-23', '2-24', '2-44', '2-45', '2-47'];

// ç¼–å·å¯¹åº”çš„æ–‡æ¡£ç±»å‹
const NUMBER_DESCRIPTIONS = {
    '2-21': 'é‡‡è´­æ§åˆ¶ä»·OAå®¡æ‰¹',
    '2-23': 'é‡‡è´­è¯·ç¤ºOAå®¡æ‰¹',
    '2-24': 'é‡‡è´­å…¬å‘Š-ç‰¹åŒºå»ºå·¥é‡‡è´­å¹³å°',
    '2-44': 'é‡‡è´­ç»“æœOAå®¡æ‰¹',
    '2-45': 'ä¸­æ ‡å€™é€‰äººå…¬ç¤º-ç‰¹åŒºå»ºå·¥é‡‡è´­å¹³å°',
    '2-47': 'é‡‡è´­ç»“æœå…¬ç¤º-ç‰¹åŒºå»ºå·¥é‡‡è´­å¹³å°',
};

// æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦åŒ…å«å…è®¸çš„ç¼–å·
function shouldProcessFile(filename) {
    // æå–æ–‡ä»¶åä¸­çš„ç¼–å·æ¨¡å¼
    const pattern = /(\d+[-_.]?\d+)/g;
    const matches = filename.match(pattern);
    
    if (!matches) {
        return { allowed: false, number: null, reason: 'æ–‡ä»¶åä¸­æœªæ‰¾åˆ°ç¼–å·æ¨¡å¼' };
    }
    
    // æ ‡å‡†åŒ–ç¼–å·æ ¼å¼å¹¶æ£€æŸ¥æ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­
    for (const match of matches) {
        const normalized = match.replace(/[_.]/g, '-');
        if (ALLOWED_NUMBERS.includes(normalized)) {
            return {
                allowed: true,
                number: normalized,
                docType: NUMBER_DESCRIPTIONS[normalized],
                reason: `åŒ¹é…ç¼–å· ${normalized}`
            };
        }
    }
    
    const foundNumbers = matches.map(m => m.replace(/[_.]/g, '-')).join(', ');
    return {
        allowed: false,
        number: null,
        reason: `æ–‡ä»¶ç¼–å· ${foundNumbers} ä¸åœ¨å¤„ç†èŒƒå›´å†…`
    };
}

// æ–‡ä»¶é€‰æ‹©å¤„ç†
function handleFileSelect(input) {
    const allFiles = Array.from(input.files).filter(f => f.name.toLowerCase().endsWith('.pdf'));
    
    if (allFiles.length === 0) {
        document.getElementById('file_preview').style.display = 'none';
        return;
    }
    
    // è¿‡æ»¤æ–‡ä»¶ï¼šåªä¿ç•™ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶
    const allowedFiles = [];
    const filteredFiles = [];
    
    allFiles.forEach(file => {
        const checkResult = shouldProcessFile(file.name);
        if (checkResult.allowed) {
            allowedFiles.push({ file, ...checkResult });
        } else {
            filteredFiles.push({ file, ...checkResult });
        }
    });
    
    // å…³é”®ä¿®å¤ï¼šåˆ›å»ºæ–°çš„DataTransferå¯¹è±¡ï¼ŒåªåŒ…å«å…è®¸çš„æ–‡ä»¶
    const dataTransfer = new DataTransfer();
    allowedFiles.forEach(item => {
        dataTransfer.items.add(item.file);
    });
    
    // æ›¿æ¢inputçš„fileså±æ€§ï¼Œè¿™æ ·æäº¤æ—¶åªä¼šä¸Šä¼ è¿‡æ»¤åçš„æ–‡ä»¶
    input.files = dataTransfer.files;
    
    // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨ï¼ˆä»…æ˜¾ç¤ºå…è®¸çš„æ–‡ä»¶ï¼‰
    const fileList = document.getElementById('file_list');
    fileList.innerHTML = '';
    
    if (allowedFiles.length === 0) {
        // æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶
        const noFilesMsg = document.createElement('div');
        noFilesMsg.className = 'alert alert-warning mb-0';
        noFilesMsg.innerHTML = `
            <strong>âš ï¸ æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„PDFæ–‡ä»¶ï¼</strong><br>
            <small>
                æ€»å…±é€‰æ‹©äº† ${allFiles.length} ä¸ªPDFæ–‡ä»¶ï¼Œä½†æ²¡æœ‰ä¸€ä¸ªæ–‡ä»¶ååŒ…å«å…è®¸çš„ç¼–å·ã€‚<br>
                ç³»ç»Ÿä»…å¤„ç†åŒ…å«ä»¥ä¸‹ç¼–å·çš„PDFæ–‡ä»¶ï¼š${ALLOWED_NUMBERS.join('ã€')}<br>
                <br>
                <strong>è¢«è¿‡æ»¤çš„æ–‡ä»¶ï¼š</strong><br>
                ${filteredFiles.map(f => `â€¢ ${f.file.name} (${f.reason})`).join('<br>')}
            </small>
        `;
        fileList.appendChild(noFilesMsg);
        document.getElementById('file_preview').style.display = 'block';
        return;
    }
    
    // æ˜¾ç¤ºè¿‡æ»¤æ‘˜è¦ï¼ˆå¦‚æœæœ‰æ–‡ä»¶è¢«è¿‡æ»¤ï¼‰
    if (filteredFiles.length > 0) {
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'alert alert-info mb-3';
        summaryDiv.innerHTML = `
            <strong>ğŸ“Š æ–‡ä»¶è¿‡æ»¤æ‘˜è¦ï¼š</strong><br>
            <small>
                â€¢ æ€»æ–‡ä»¶æ•°ï¼š${allFiles.length}<br>
                â€¢ âœ… ç¬¦åˆæ¡ä»¶ï¼š${allowedFiles.length}<br>
                â€¢ âŒ å·²è¿‡æ»¤ï¼š${filteredFiles.length}<br>
                <br>
                <em>ä»¥ä¸‹ä»…æ˜¾ç¤ºç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶ï¼Œè¢«è¿‡æ»¤çš„æ–‡ä»¶ä¸ä¼šè¿›è¡Œå¤„ç†ã€‚</em>
            </small>
        `;
        fileList.appendChild(summaryDiv);
    }
    
    // æ˜¾ç¤ºç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶
    allowedFiles.forEach(({ file, number, docType }) => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `
            <span class="file-icon">âœ…</span>
            <div class="flex-grow-1">
                <strong>${file.name}</strong>
                <div class="text-muted small">
                    ${(file.size / 1024).toFixed(1)} KB
                    <span class="badge bg-primary ms-2">${number}</span>
                    <span class="badge bg-secondary ms-1">${docType}</span>
                </div>
            </div>
        `;
        fileList.appendChild(fileItem);
    });
    
    document.getElementById('file_preview').style.display = 'block';
}

// æ–‡ä»¶å¤¹é€‰æ‹©
document.getElementById('folder_input').addEventListener('change', function(e) {
    handleFileSelect(this);
    // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
    document.getElementById('file_input').value = '';
});

// æ–‡ä»¶é€‰æ‹©
document.getElementById('file_input').addEventListener('change', function(e) {
    handleFileSelect(this);
    // æ¸…ç©ºæ–‡ä»¶å¤¹é€‰æ‹©
    document.getElementById('folder_input').value = '';
});

// è¡¨å•æäº¤éªŒè¯
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    const folderFiles = document.getElementById('folder_input').files;
    const regularFiles = document.getElementById('file_input').files;
    
    if (folderFiles.length === 0 && regularFiles.length === 0) {
        e.preventDefault();
        alert('è¯·é€‰æ‹©PDFæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹');
        return false;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ä¸Šä¼ ä¸­...';
    submitBtn.disabled = true;
});
</script>
{% endblock %}