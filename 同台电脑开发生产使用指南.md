# 同台电脑开发+生产使用指南

## 🎯 使用场景

您的电脑需要：
1. **运行生产环境** - 供局域网其他人访问使用
2. **进行开发工作** - 自己开发新功能、修复bug

---

## ✅ 推荐方案: 双环境同时运行

### 核心原理

```
同一台电脑,同一份代码目录
├── 生产服务 (main分支, HTTPS:3500) → 一直运行
└── 开发服务 (dev分支, HTTP:8000)   → 开发时运行
```

**关键点:**
- ✅ 两个服务使用**不同端口**,可以同时运行
- ✅ 使用**不同数据库**,数据完全隔离
- ✅ Git分支切换**不影响正在运行的服务**

---

## 📋 完整操作流程

### 第一步: 启动生产环境 (一次性)

```bash
# 1. 确保在main分支
git checkout main

# 2. 启动生产服务
start_prod.bat

# 3. 生产环境信息
# - 访问地址: https://10.168.3.240:3500
# - 数据库: db.sqlite3
# - 用途: 供局域网其他人使用
# - 状态: 保持运行,不要关闭这个窗口!
```

**重要:** 生产服务启动后,**不要关闭这个命令行窗口**,让它一直运行。

---

### 第二步: 切换到开发环境

```bash
# 1. 打开新的命令行窗口 (不要关闭生产服务窗口!)

# 2. 切换到dev分支
switch_to_dev_branch.bat

# 3. 启动开发服务
start_dev.bat

# 4. 开发环境信息
# - 访问地址: http://10.168.3.240:8000
# - 数据库: db_dev.sqlite3
# - 用途: 自己开发测试
# - 状态: 开发时运行,不用时可以关闭
```

---

### 第三步: 日常开发

```bash
# 在dev分支开发
# - 修改代码
# - 访问 http://10.168.3.240:8000 测试
# - AI帮你改代码,不影响生产环境!

# 提交代码
git add .
git commit -m "新功能: XXX"
```

---

### 第四步: 部署到生产

```bash
# 1. 停止生产服务 (在生产服务窗口按 Ctrl+C)

# 2. 运行部署脚本
deploy_to_prod_safe.bat

# 3. 部署脚本会自动:
#    - 备份生产数据库
#    - 合并dev代码到main
#    - 重启生产服务

# 4. 验证生产环境
#    访问: https://10.168.3.240:3500
```

---

## 🖥️ 窗口管理

### 典型工作状态

```
窗口1: 生产服务 (一直开着)
├── 分支: main
├── 端口: 3500 (HTTPS)
├── 数据库: db.sqlite3
└── 状态: 运行中 ✅

窗口2: 开发服务 (开发时开)
├── 分支: dev
├── 端口: 8000 (HTTP)
├── 数据库: db_dev.sqlite3
└── 状态: 运行中 ✅

窗口3: 代码编辑器 (VSCode)
├── 当前分支: dev
└── 修改代码,提交
```

---

## ❓ 常见问题

### Q1: 两个服务会冲突吗?

**不会!** 它们使用不同端口:
- 生产: 3500
- 开发: 8000

### Q2: 切换Git分支会影响正在运行的服务吗?

**不会!** 服务启动后,代码已经加载到内存,切换分支不影响运行中的服务。

但是:
- ⚠️ 如果修改了代码,Django会自动重载
- ⚠️ 所以生产服务运行时,不要在main分支修改代码

### Q3: 如果我在dev分支改了代码,生产环境会受影响吗?

**不会!** 因为:
1. 生产服务运行在main分支的代码
2. 你在dev分支修改代码
3. 两个分支的代码是独立的

### Q4: 数据库会混乱吗?

**不会!** 因为:
- 生产服务使用 `db.sqlite3`
- 开发服务使用 `db_dev.sqlite3`
- 两个数据库完全独立

### Q5: 我可以只运行生产环境,不开发时不启动开发环境吗?

**可以!** 开发环境只在需要开发时启动,不用时可以关闭。

### Q6: 如果我忘记在哪个分支了怎么办?

```bash
# 查看当前分支
git branch --show-current

# 或者看命令行提示符
```

---

## 🔄 完整工作流程图

```
┌─────────────────────────────────────────┐
│ 启动生产环境 (一次性)                    │
│ git checkout main                       │
│ start_prod.bat                          │
│ 保持运行 ✅                              │
└─────────────────────────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────────┐
│ 开发新功能 (日常)                        │
│ 1. 打开新窗口                            │
│ 2. switch_to_dev_branch.bat             │
│ 3. start_dev.bat                        │
│ 4. 修改代码,测试                         │
│ 5. git commit                           │
└─────────────────────────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────────┐
│ 部署到生产 (功能完成后)                  │
│ 1. 停止生产服务 (Ctrl+C)                │
│ 2. deploy_to_prod_safe.bat             │
│ 3. 验证生产环境                          │
└─────────────────────────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────────┐
│ 继续开发下一个功能                        │
│ 回到"开发新功能"步骤                      │
└─────────────────────────────────────────┘
```

---

## 💡 最佳实践

### 1. 生产服务管理

```bash
# 启动生产服务后,最小化窗口,不要关闭
# 如果需要重启:
# 1. 在生产服务窗口按 Ctrl+C
# 2. 运行 start_prod.bat
```

### 2. 开发服务管理

```bash
# 开发时启动
start_dev.bat

# 不开发时可以关闭 (Ctrl+C)
# 不影响生产环境
```

### 3. 代码管理

```bash
# 开发时始终在dev分支
git checkout dev

# 不要直接在main分支修改代码
# 使用 deploy_to_prod_safe.bat 部署
```

### 4. 数据管理

```bash
# 如果需要从生产复制最新数据到开发:
copy db.sqlite3 db_dev.sqlite3

# 注意: 这会覆盖开发数据库!
```

---

## 🎯 总结

### 核心要点

1. ✅ **可以同时运行** - 生产(3500) + 开发(8000)
2. ✅ **数据完全隔离** - db.sqlite3 vs db_dev.sqlite3
3. ✅ **代码分支隔离** - main vs dev
4. ✅ **互不影响** - 开发不影响生产

### 典型一天的工作

```
上午 9:00  - 启动生产服务 (start_prod.bat)
上午 9:05  - 切换到dev分支,启动开发服务
上午 9:10  - 开始开发新功能
中午 12:00 - 关闭开发服务,去吃饭 (生产服务继续运行)
下午 14:00 - 重启开发服务,继续开发
下午 17:00 - 功能完成,部署到生产 (deploy_to_prod_safe.bat)
下午 17:10 - 验证生产环境,下班 (生产服务继续运行)
```

---

**记住:** 生产服务像一个"服务器",一直运行;开发服务像一个"工具",需要时才用。