# 冗余清理与减行分批计划（目标 ≥ 10,000 行）

更新时间：2025-11-13 负责人：研发改造小组

## 目标与度量
- 目标：在不影响现有功能与数据完整性的前提下，分批净减少 ≥10,000 行冗余/重复/无用代码与资源。
- 范围：Python 业务代码、模板、静态资源（JS/CSS）、方案/历史文档中的明显冗余；尽量不触碰迁移历史，除非风险可控。
- 度量：以“删除−新增”的净变更行数为准；批次结束时记录行数对账，核心页面回归通过后方可进入下一批次。

## 原则
- KISS：以最小必要改动达成目标，避免过度工程化。
- DRY：删除/合并重复实现，抽取公共逻辑复用。
- SOLID：对外接口保留/提供兼容层，内部重构可替换实现。
- YAGNI：只做当下必须的整合，禁止为潜在需求预留复杂钩子。

## 风险与回滚
- 函数/类名兼容：对被广泛引用的函数提供薄适配层（1 个版本周期内保留）。
- DB/模型变更：若需字段抽取到 BaseModel，确保无破坏性迁移并具备数据备份与回滚脚本。
- 回滚：每批次变更集中在独立分支，若出现阻塞，可回滚到上一个批次标签。

---

## 批次0（已完成）
- 合并报表生成器：删除旧版 `project/services/report_generator.py`，采用统一实现并在新文件中补齐 `export_to_word/export_to_excel` 兼容接口。
- 视图导入修复：`views_reports.py` 统一从 `project.services.report_generator` 导入。
- 去重 CSS 引用：移除模板中重复引入 `edit-modal.css`，改为在 `base.html` 统一引入。
- 预计净减：≈ 900+ 行（已完成）。

---

## 批次1（高收益，优先）
1) 统计模块去重与合并
- 现状：`statistics.py` 与 `report_data_service.py` 统计逻辑重复、多处实现分叉。
- 方案：以 `ReportDataService` 为唯一统计入口，`statistics.py` 简化为适配/转调层或直接淘汰重复实现。
- 兼容：保留原函数名（薄适配），逐步迁移调用方。
- 预估净减：500–800 行。

2) 归档监控统一化
- 现状：`archive_monitor.py` 与 `monitors/archive_*` 存在相似统计/检测/查询逻辑。
- 方案：新增 `UnifiedArchiveService` 门面，整合统计、问题检测与查询，删除重复实现；公共查询下沉到共享 util。
- 兼容：保留原服务对外方法的转调层，确保调用方不感知变更。
- 预估净减：800–1200 行。

3) 视图列表 Mixin 抽取
- 现状：分页、搜索、排序逻辑在多处视图重复。
- 方案：抽取 `BaseListViewMixin`（`apply_pagination/apply_search/apply_ordering`），替换 `views_projects.py / views_procurements.py / views_contracts.py / views_payments.py` 中重复段。
- 预估净减：200–400 行。

4) 未引用静态资源清理
- 现状：历史规划中提及的 `create-modal.js/monitoring.js` 等，需以实际引用为准扫描并清理。
- 方案：以 `rg` 扫描引用；对完全未引用文件直接删除，对局部引用合并/内联。
- 预估净减：10–30 个文件，共 1,000–3,000 行。

批次1合计预估：2,500–3,800 行。

验证清单（批次1）
- 运行关键页面：报表生成、归档统计、各列表页分页/检索；Word/Excel 导出验证。
- 代码搜索：`rg -n "report_data_service|get_.*_statistics"` 无重复实现残留。
- 单元/集成：如有现成测试，执行相关用例。

---

## 批次2（中等收益）
1) 模型审核基类统一（AuditBaseModel）
- 方案：抽取 `created_at/updated_at/created_by/updated_by` 到抽象基类；模型继承替换；去掉重复 `clean()`。
- 注意：评估迁移影响，必要时新增非破坏性迁移；保留历史字段兼容。
- 预估净减：200–400 行。

2) 校验逻辑统一
- 方案：`validate_and_clean_code()` 下沉到 `validators.py` 或基类方法，统一正则/异常信息。
- 预估净减：150–250 行。

3) PDF 解析去重
- 方案：`field_extractor` 统一复用 `TextParser` 的提取方法，删除重复提取片段；抽出共用匹配模式常量。
- 预估净减：100–200 行。

4) 枚举映射统一
- 方案：以 `utils/enum_mapper.py` 为单一真源，删除 `config/field_mapping.yml` 与 `field_extractor` 中重复映射；保留加载兼容层。
- 预估净减：100–200 行。

批次2合计预估：600–1,050 行。

验证清单（批次2）
- DB 迁移：空环境迁移+样本数据迁移验证；历史环境增量迁移演练。
- PDF 导入：样例 PDF 提取字段对账。

---

## 批次3（页面与导出层整治）
1) 报表导出收敛
- 方案：导出工具集中到 `export_service`，删除过时导出路径与死代码；`WordFormatter` 保持 OCP 扩展点。
- 预估净减：200–400 行。

2) 模板去重与宏化
- 方案：将重复的卡片/列表/分页/筛选块抽为模板片段或宏；统一样式/脚本引用。
- 预估净减：300–600 行。

3) 文档清理（非代码）
- 方案：归档历史方案/计划文档中重复/过时的大段内容到 `docs/archive/`；保留索引，不影响使用。
- 预估净减：1,000–2,000 行（仓库体积优化）。

批次3合计预估：1,500–3,000 行。

验证清单（批次3）
- 报表导出页面流畅度与导出结果比对。
- 模板片段复用后的各页面打开/操作路径核验。

---

## 批次4（深度收敛与收尾）
1) 指标与工具方法归并
- 方案：`metrics/ranking/completeness` 中共性工具方法抽到 `shared/services/utils.py`，删除散落重复实现。
- 预估净减：300–600 行。

2) 无用脚本/迁移清理（谨慎）
- 方案：仅在无历史环境负担时清理无用脚本与不可达迁移；必须与运维确认后执行。
- 预估净减：200–500 行。

批次4合计预估：500–1,100 行。

---

## 里程碑与总计
- 批次1：预计完成后累计净减 2,500–3,800 行。
- 批次2：累计净减 3,100–4,850 行。
- 批次3：累计净减 4,600–7,850 行（含文档优化）。
- 批次4：累计净减 5,100–8,950+ 行（不含潜在更多静态资源/模板重复发现）。
- 结合未引用静态/模板块的扩展清理，整体达到 ≥10,000 行可达。

## 执行方式与校验
- 每批提交独立 PR，附带：
  - 减行对账（新增/删除统计）
  - 影响面说明与回滚方案
  - 验证步骤清单（页面、导出、导入、统计）
- 验证优先级：关键报表流 > 统计接口 > 列表检索/分页 > PDF 导入。

## 当前建议下一步（需确认后执行）
就绪执行“批次1”：
1) 统计模块去重：`statistics.py` → 仅保留适配层，统计实现收敛到 `ReportDataService`。
2) 归档监控统一：落地 `UnifiedArchiveService`，原接口加薄转调层。
3) 视图 Mixin：抽取并替换 4 个列表视图的分页/检索重复逻辑。
4) 静态引用扫描：清理完全未引用 JS/CSS。

备注：若你确认批次1优先范围，我将直接开始实施并在提交中记录净减行数与验证结果。

