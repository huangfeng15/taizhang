{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">{{ page_title }}</h2>
        <div class="text-muted">
            <i class="fas fa-filter"></i>
            å½“å‰ç­›é€‰ï¼š{{ filter_config.display_year|default:"å…¨éƒ¨å¹´åº¦" }}
            {% if filter_config.selected_project_value %}Â· {{ filter_config.selected_project_value }}{% else %}Â· å…¨éƒ¨é¡¹ç›®{% endif %}
        </div>
    </div>

    <!-- KPIå¡ç‰‡ -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">é‡‡è´­é½å…¨ç‡</h5>
                    <h2 class="text-primary">{{ statistics.procurement_rate }}%</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">åˆåŒé½å…¨ç‡</h5>
                    <h2 class="text-success">{{ statistics.contract_rate }}%</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">å…³è”å¼‚å¸¸</h5>
                    <h2 class="text-danger">{{ statistics.anomaly_count }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- ç­›é€‰æ  -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">é¡¹ç›®</label>
                    <input type="text" name="project" class="form-control" value="{{ selected_project }}" placeholder="é¡¹ç›®ç¼–ç ">
                </div>
                <div class="col-md-3">
                    <label class="form-label">ç»åŠäºº</label>
                    <input type="text" name="responsible_person" class="form-control" value="{{ selected_person }}" placeholder="ç»åŠäººå§“å">
                </div>
                <div class="col-md-2">
                    <label class="form-label d-block">&nbsp;</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="show_all" value="true" id="showAllCheck" {% if show_all %}checked{% endif %}>
                        <label class="form-check-label" for="showAllCheck">
                            æ˜¾ç¤ºæ‰€æœ‰è®°å½•
                        </label>
                    </div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary me-2">ç­›é€‰</button>
                    <a href="{% url 'completeness_check' %}" class="btn btn-secondary">é‡ç½®</a>
                </div>
            </form>
        </div>
    </div>

    <!-- é‡‡è´­ä¸å®Œæ•´è®°å½• -->
    {% if problems.procurement_incomplete %}
    <div class="card mb-3">
        <div class="card-header bg-warning">
            <h5 class="mb-0">ğŸ“‹ é‡‡è´­ä¸å®Œæ•´è®°å½• - {{ problems.procurement_incomplete|length }}æ¡</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ä¸šåŠ¡ç¼–ç </th>
                            <th>é¡¹ç›®åç§°</th>
                            <th>é‡‡è´­åç§°</th>
                            <th>ç»åŠäºº</th>
                            <th>å®Œæ•´ç‡</th>
                            <th>ç¼ºå¤±å­—æ®µ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in problems.procurement_incomplete %}
                        <tr>
                            <td><code>{{ item.code }}</code></td>
                            <td>{{ item.project_name }}</td>
                            <td>{{ item.name }}</td>
                            <td>{{ item.responsible_person|default:"-" }}</td>
                            <td><span class="badge bg-warning">{{ item.completeness_rate }}%</span></td>
                            <td><small class="text-danger">{{ item.missing_fields }}</small></td>
                            <td><a href="{{ item.edit_url }}" class="btn btn-sm btn-outline-primary">ç¼–è¾‘</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- åˆåŒä¸å®Œæ•´è®°å½• -->
    {% if problems.contract_incomplete %}
    <div class="card mb-3">
        <div class="card-header bg-warning">
            <h5 class="mb-0">ğŸ“‹ åˆåŒä¸å®Œæ•´è®°å½• - {{ problems.contract_incomplete|length }}æ¡</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>åˆåŒåºå·</th>
                            <th>åˆåŒç¼–ç </th>
                            <th>åˆåŒåç§°</th>
                            <th>ç»åŠäºº</th>
                            <th>å®Œæ•´ç‡</th>
                            <th>ç¼ºå¤±å­—æ®µ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in problems.contract_incomplete %}
                        <tr>
                            <td>{{ item.sequence }}</td>
                            <td><code>{{ item.code }}</code></td>
                            <td>{{ item.name }}</td>
                            <td>{{ item.responsible_person|default:"-" }}</td>
                            <td><span class="badge bg-warning">{{ item.completeness_rate }}%</span></td>
                            <td><small class="text-danger">{{ item.missing_fields }}</small></td>
                            <td><a href="{{ item.edit_url }}" class="btn btn-sm btn-outline-primary">ç¼–è¾‘</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- å…³è”å¼‚å¸¸ -->
    {% if problems.relation_anomalies %}
    <div class="card mb-3">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">âš ï¸ å…³è”å¼‚å¸¸ - {{ problems.relation_anomalies|length }}æ¡</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>å¼‚å¸¸ç±»å‹</th>
                            <th>åˆåŒåºå·</th>
                            <th>åˆåŒç¼–ç </th>
                            <th>åˆåŒåç§°</th>
                            <th>å¼‚å¸¸è¯´æ˜</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in problems.relation_anomalies %}
                        <tr>
                            <td><span class="badge bg-danger">{{ item.anomaly_type }}</span></td>
                            <td>{{ item.sequence }}</td>
                            <td><code>{{ item.code }}</code></td>
                            <td>{{ item.name }}</td>
                            <td><small>{{ item.description }}</small></td>
                            <td><a href="{{ item.edit_url }}" class="btn btn-sm btn-outline-primary">ç¼–è¾‘</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- é‡‡è´­å®Œæ•´è®°å½• -->
    {% if show_all and problems.procurement_complete %}
    <div class="card mb-3">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">âœ… é‡‡è´­å®Œæ•´è®°å½• - {{ problems.procurement_complete|length }}æ¡</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>ä¸šåŠ¡ç¼–ç </th>
                            <th>é¡¹ç›®åç§°</th>
                            <th>é‡‡è´­åç§°</th>
                            <th>ç»åŠäºº</th>
                            <th>å®Œæ•´ç‡</th>
                            <th>ç¼ºå¤±å­—æ®µ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in problems.procurement_complete %}
                        <tr>
                            <td><code>{{ item.code }}</code></td>
                            <td>{{ item.project_name }}</td>
                            <td>{{ item.name }}</td>
                            <td>{{ item.responsible_person|default:"-" }}</td>
                            <td><span class="badge bg-success">{{ item.completeness_rate }}%</span></td>
                            <td><small class="text-success">{{ item.missing_fields }}</small></td>
                            <td><a href="{{ item.edit_url }}" class="btn btn-sm btn-outline-primary">ç¼–è¾‘</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- åˆåŒå®Œæ•´è®°å½• -->
    {% if show_all and problems.contract_complete %}
    <div class="card mb-3">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">âœ… åˆåŒå®Œæ•´è®°å½• - {{ problems.contract_complete|length }}æ¡</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-sm mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>åˆåŒåºå·</th>
                            <th>åˆåŒç¼–ç </th>
                            <th>åˆåŒåç§°</th>
                            <th>ç»åŠäºº</th>
                            <th>å®Œæ•´ç‡</th>
                            <th>ç¼ºå¤±å­—æ®µ</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in problems.contract_complete %}
                        <tr>
                            <td>{{ item.sequence }}</td>
                            <td><code>{{ item.code }}</code></td>
                            <td>{{ item.name }}</td>
                            <td>{{ item.responsible_person|default:"-" }}</td>
                            <td><span class="badge bg-success">{{ item.completeness_rate }}%</span></td>
                            <td><small class="text-success">{{ item.missing_fields }}</small></td>
                            <td><a href="{{ item.edit_url }}" class="btn btn-sm btn-outline-primary">ç¼–è¾‘</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    {% if statistics.procurement_incomplete_count == 0 and statistics.contract_incomplete_count == 0 and statistics.anomaly_count == 0 %}
    <div class="alert alert-success text-center">
        <h4>âœ… å¤ªæ£’äº†ï¼æ‰€æœ‰è®°å½•éƒ½å®Œæ•´ä¸”å…³è”æ­£å¸¸</h4>
    </div>
    {% endif %}
</div>

{% endblock %}
