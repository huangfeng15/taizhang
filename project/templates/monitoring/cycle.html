{% extends "base.html" %}
{% load static %}
{% load monitor_filters %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    .view-mode-selector {
        display: inline-flex;
        border-radius: 0.375rem;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .view-mode-btn {
        padding: 0.5rem 1.5rem;
        border: none;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
    }
    .view-mode-btn:hover {
        background: #f8f9fa;
    }
    .view-mode-btn.active {
        background: #0d6efd;
        color: white;
    }
    .stats-card {
        border-left: 4px solid;
        transition: transform 0.2s;
        height: 100%;
    }
    .stats-card .card-body { padding: 0.75rem 1rem; }
    .stats-card h2, .stats-card h3 { margin: 0.25rem 0; }
    .stats-card h6 { margin-bottom: 0.25rem; }
    .stats-card:hover {
        transform: translateY(-2px);
    }
    .stats-card.procurement {
        border-left-color: #0d6efd;
    }
    .stats-card.contract {
        border-left-color: #198754;
    }
    .stats-card.overall {
        border-left-color: #6c757d;
    }
    .equal-col { display: flex; }
    .equal-col .card { height: 100%; width: 100%; }
    .progress { height: 20px; }
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
    .overdue-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
    }
    .overdue-badge.severe { background: #fff1f0; color: #ff4d4f; }
    .overdue-badge.moderate { background: #fffbe6; color: #faad14; }
    .overdue-badge.mild { background: #e6f7ff; color: #1890ff; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- é¡µé¢æ ‡é¢˜å’Œè§†å›¾åˆ‡æ¢ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0"><i class="fas fa-clock"></i> {{ page_title }}</h2>
        <div class="view-mode-selector">
            <button type="button" class="view-mode-btn {% if view_mode == 'project' %}active{% endif %}" data-mode="project">
                <i class="fas fa-project-diagram"></i> é¡¹ç›®è§†å›¾
            </button>
            <button type="button" class="view-mode-btn {% if view_mode == 'person' %}active{% endif %}" data-mode="person">
                <i class="fas fa-user"></i> ä¸ªäººè§†å›¾
            </button>
        </div>
    </div>

    <!-- å½“å‰ç­›é€‰çŠ¶æ€ -->
    <div class="alert alert-info">
        <i class="fas fa-filter"></i>
        å½“å‰ç­›é€‰ï¼š{{ filter_config.display_year|default:"å…¨éƒ¨å¹´åº¦" }}
        {% if filter_config.selected_project_value %} Â· {{ filter_config.selected_project_value }}{% else %} Â· å…¨éƒ¨é¡¹ç›®{% endif %}
    </div>

    <!-- é‡‡è´­æ–¹å¼ç­›é€‰ä¸åˆ†ç»„ï¼ˆæ–°å¢ï¼‰ -->
    <div class="card mb-3">
        <div class="card-body">
            <form id="methodFilterForm" class="row gy-2 gx-3 align-items-end" method="get">
                <div class="col-sm-6 col-md-5">
                    <label class="form-label">é‡‡è´­æ–¹å¼ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <select name="procurement_method" id="procurement_method" class="form-select" multiple size="6">
                        {% for method in procurement_method_choices %}
                            <option value="{{ method }}" {% if selected_procurement_methods and method in selected_procurement_methods %}selected{% endif %}>{{ method }}</option>
                        {% endfor %}
                        <option value="æœªæ ‡æ³¨" {% if selected_procurement_methods and 'æœªæ ‡æ³¨' in selected_procurement_methods %}selected{% endif %}>æœªæ ‡æ³¨</option>
                    </select>
                </div>
                <div class="col-sm-4 col-md-3">
                    <div class="form-check mt-4">
                        <input class="form-check-input" type="checkbox" value="procurement_method" id="groupByMethod" name="group_by" {% if group_by == 'procurement_method' %}checked{% endif %}>
                        <label class="form-check-label" for="groupByMethod">
                            æŒ‰é‡‡è´­æ–¹å¼åˆ†ç»„å±•ç¤º
                        </label>
                    </div>
                </div>
                <div class="col-sm-2 col-md-2">
                    <button type="submit" class="btn btn-primary w-100">åº”ç”¨ç­›é€‰</button>
                </div>
            </form>
        </div>
    </div>

    {% if overview_data.by_method %}
    <div class="card mb-4">
        <div class="card-header bg-light">
            <strong><i class="fas fa-layer-group"></i> æŒ‰é‡‡è´­æ–¹å¼åˆ†ç»„æ¦‚è§ˆ</strong>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th style="width:30%">é‡‡è´­æ–¹å¼</th>
                            <th>æ ·æœ¬é‡</th>
                            <th>å¹³å‡å¤©æ•°</th>
                            <th>è¾¾æ ‡ç‡</th>
                            <th>SLAé˜ˆå€¼(å¤©)</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in overview_data.by_method %}
                        <tr>
                            <td>{{ row.method }}</td>
                            <td>{{ row.count }}</td>
                            <td>{{ row.avg_cycle }}</td>
                            <td>{{ row.on_time_rate }}%</td>
                            <td>{{ row.deadline }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center text-muted">æš‚æ— æ•°æ®</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- æ±‡æ€»ç»Ÿè®¡å¡ç‰‡ -->
    {% if overview_data %}
    <div class="row mb-4">
        <div class="col-md-3 equal-col">
            <div class="card text-center stats-card overall h-100 w-100">
                <div class="card-body">
                    <h6 class="text-muted">{% if view_mode == 'project' %}é¡¹ç›®æ€»æ•°{% else %}ç»åŠäººæ•°{% endif %}</h6>
                    <h2 class="text-primary">
                        {% if view_mode == 'project' %}
                            {{ overview_data.summary.project_count }}
                        {% else %}
                            {{ overview_data.summary.person_count }}
                        {% endif %}
                    </h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 equal-col">
            <div class="card text-center stats-card procurement h-100 w-100">
                <div class="card-body">
                    <h6 class="text-muted">é‡‡è´­å‘¨æœŸ</h6>
                    <h3>{{ overview_data.summary.procurement_total }}ä¸ª</h3>
                    <small class="text-muted">å·²å®Œæˆé‡‡è´­æ•°</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 equal-col">
            <div class="card text-center stats-card contract h-100 w-100">
                <div class="card-body">
                    <h6 class="text-muted">åˆåŒå‘¨æœŸ</h6>
                    <h3>{{ overview_data.summary.contract_total }}ä¸ª</h3>
                    <small class="text-muted">å·²ç­¾è®¢åˆåŒæ•°</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 equal-col">
            <div class="card text-center stats-card overall h-100 w-100">
                <div class="card-body">
                    <h6 class="text-muted">ç»¼åˆåŠæ—¶ç‡</h6>
                    <h2 class="text-success">{{ overview_data.summary.overall_on_time_rate }}%</h2>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- æ•°æ®åˆ—è¡¨è¡¨æ ¼ -->
    {% if overview_data %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                {% if view_mode == 'project' %}é¡¹ç›®å‘¨æœŸç»Ÿè®¡æ˜ç»†{% else %}ç»åŠäººå‘¨æœŸç»Ÿè®¡æ˜ç»†{% endif %}
            </h5>
        </div>
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>{% if view_mode == 'project' %}é¡¹ç›®åç§°{% else %}ç»åŠäºº{% endif %}</th>
                        <th>é‡‡è´­æ•°é‡</th>
                        <th>é‡‡è´­å¹³å‡å‘¨æœŸ</th>
                        <th>åˆåŒæ•°é‡</th>
                        <th>åˆåŒå¹³å‡å‘¨æœŸ</th>
                        <th>ç»¼åˆåŠæ—¶ç‡</th>
                        {% if view_mode == 'person' %}<th>è´Ÿè´£é¡¹ç›®</th>{% endif %}
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    {% if view_mode == 'project' %}
                        {% for project in overview_data.projects %}
                        <tr>
                            <td><strong>{{ project.project_code }}</strong><br><small>{{ project.project_name }}</small></td>
                            <td>{{ project.procurement_count }}ä¸ª</td>
                            <td>{{ project.procurement_avg_cycle }}å¤©<br><small class="text-muted">({{ project.procurement_on_time_rate }}%)</small></td>
                            <td>{{ project.contract_count }}ä¸ª</td>
                            <td>{{ project.contract_avg_cycle }}å¤©<br><small class="text-muted">({{ project.contract_on_time_rate }}%)</small></td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ project.overall_on_time_rate }}%" 
                                         aria-valuenow="{{ project.overall_on_time_rate }}" aria-valuemin="0" aria-valuemax="100">
                                        {{ project.overall_on_time_rate }}%
                                    </div>
                                </div>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-primary view-detail-btn" data-target="{{ project.project_code }}">
                                    <i class="fas fa-eye"></i> æŸ¥çœ‹è¯¦æƒ…
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        {% for person in overview_data.persons %}
                        <tr>
                            <td><strong>{{ person.handler_name }}</strong></td>
                            <td>{{ person.procurement_count }}ä¸ª</td>
                            <td>{{ person.procurement_avg_cycle }}å¤©<br><small class="text-muted">({{ person.procurement_on_time_rate }}%)</small></td>
                            <td>{{ person.contract_count }}ä¸ª</td>
                            <td>{{ person.contract_avg_cycle }}å¤©<br><small class="text-muted">({{ person.contract_on_time_rate }}%)</small></td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ person.overall_on_time_rate }}%"
                                         aria-valuenow="{{ person.overall_on_time_rate }}" aria-valuemin="0" aria-valuemax="100">
                                        {{ person.overall_on_time_rate }}%
                                    </div>
                                </div>
                            </td>
                            <td>{{ person.project_count }}ä¸ª</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-primary view-detail-btn" data-target="{{ person.handler_name }}">
                                    <i class="fas fa-eye"></i> æŸ¥çœ‹è¯¦æƒ…
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- è¯¦æƒ…æ¨¡æ€æ¡†ï¼ˆé€‰æ‹©äº†target_codeæ—¶æ˜¾ç¤ºï¼‰ -->
    {% if target_code and detail_data %}
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">{% if view_mode == 'project' %}é¡¹ç›®è¯¦æƒ…{% else %}ç»åŠäººè¯¦æƒ…{% endif %} - {{ target_code }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
          </div>
          <div class="modal-body">
            <!-- è¯¦æƒ…æ¦‚è¦ -->
            {% if detail_data.summary %}
            <div class="row mb-4">
                <div class="col-12 col-md-4 equal-col">
                    <div class="card text-center stats-card procurement h-100 w-100">
                        <div class="card-body">
                            <h6 class="text-muted">é‡‡è´­å‘¨æœŸ</h6>
                            <h4>{{ detail_data.summary.procurement.count }}ä¸ª</h4>
                            <small class="text-muted">å¹³å‡{{ detail_data.summary.procurement.avg_cycle }}å¤© Â· åŠæ—¶ç‡ {{ detail_data.summary.procurement.on_time_rate }}%</small>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-4 equal-col">
                    <div class="card text-center stats-card contract h-100 w-100">
                        <div class="card-body">
                            <h6 class="text-muted">åˆåŒå‘¨æœŸ</h6>
                            <h4>{{ detail_data.summary.contract.count }}ä¸ª</h4>
                            <small class="text-muted">å¹³å‡{{ detail_data.summary.contract.avg_cycle }}å¤© Â· åŠæ—¶ç‡ {{ detail_data.summary.contract.on_time_rate }}%</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- è¶‹åŠ¿å›¾ -->
            <h6>å·¥ä½œå‘¨æœŸè¶‹åŠ¿</h6>
            <div id="trendChart" class="mb-4" style="height: 400px;"></div>

            <!-- è¶…æœŸè®°å½• -->
            {% if detail_data.overdue_records %}
            <h6 class="mt-4">è¶…æœŸè®°å½•</h6>
            <div class="accordion" id="overdueAccordion">
                {% for severity, records in detail_data.overdue_records.items %}
                {% if records.procurement or records.contract %}
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button {% if severity != 'severe' %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#{{ severity }}Collapse">
                            {% if severity == 'severe' %}ğŸ”´ ä¸¥é‡è¶…æœŸ{% elif severity == 'moderate' %}ğŸŸ¡ ä¸­åº¦è¶…æœŸ{% else %}ğŸŸ¢ è½»å¾®è¶…æœŸ{% endif %}
                            (é‡‡è´­{{ records.procurement|length }}æ¡ / åˆåŒ{{ records.contract|length }}æ¡)
                        </button>
                    </h2>
                    <div id="{{ severity }}Collapse" class="accordion-collapse collapse {% if severity == 'severe' %}show{% endif %}">
                        <div class="accordion-body p-0">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>ç±»å‹</th>
                                        <th>ç¼–å·</th>
                                        <th>åç§°</th>
                                        <th>ç»åŠäºº</th>
                                        <th>å‘¨æœŸ(å¤©)</th>
                                        <th>è§„å®š(å¤©)</th>
                                        <th>è¶…æœŸ(å¤©)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in records.procurement %}
                                    <tr>
                                        <td><span class="badge bg-primary">é‡‡è´­</span></td>
                                        <td>{{ item.code }}</td>
                                        <td>{{ item.name }}</td>
                                        <td>{{ item.officer }}</td>
                                        <td>{{ item.cycle_days }}</td>
                                        <td>{{ item.deadline_days }}</td>
                                        <td><span class="text-danger fw-bold">{{ item.overdue_days }}</span></td>
                                    </tr>
                                    {% endfor %}
                                    {% for item in records.contract %}
                                    <tr>
                                        <td><span class="badge bg-success">åˆåŒ</span></td>
                                        <td>{{ item.code }}</td>
                                        <td>{{ item.name }}</td>
                                        <td>{{ item.officer }}</td>
                                        <td>{{ item.cycle_days }}</td>
                                        <td>{{ item.deadline_days }}</td>
                                        <td><span class="text-danger fw-bold">{{ item.overdue_days }}</span></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- è¿›è¡Œä¸­é¡¹ç›® -->
            {% if detail_data.ongoing_records %}
            <h6 class="mt-4">è¿›è¡Œä¸­é¡¹ç›®</h6>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>ç±»å‹</th>
                        <th>ç¼–å·</th>
                        <th>åç§°</th>
                        <th>ç»åŠäºº</th>
                        <th>å·²ç”¨æ—¶(å¤©)</th>
                        <th>å‰©ä½™æ—¶é—´(å¤©)</th>
                        <th>çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in detail_data.ongoing_records.procurement %}
                    <tr>
                        <td><span class="badge bg-primary">é‡‡è´­</span></td>
                        <td>{{ item.code }}</td>
                        <td>{{ item.name }}</td>
                        <td>{{ item.officer }}</td>
                        <td>{{ item.used_days }}</td>
                        <td>{{ item.remaining_days }}</td>
                        <td>
                            {% if item.remaining_days < 0 %}
                                <span class="badge bg-warning">âš  å³å°†è¶…æœŸ</span>
                            {% else %}
                                <span class="badge bg-info">æ­£å¸¸è¿›è¡Œ</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% for item in detail_data.ongoing_records.contract %}
                    <tr>
                        <td><span class="badge bg-success">åˆåŒ</span></td>
                        <td>{{ item.code }}</td>
                        <td>{{ item.name }}</td>
                        <td>{{ item.officer }}</td>
                        <td>{{ item.used_days }}</td>
                        <td>{{ item.remaining_days }}</td>
                        <td>
                            {% if item.remaining_days < 0 %}
                                <span class="badge bg-warning">âš  å³å°†è¶…æœŸ</span>
                            {% else %}
                                <span class="badge bg-info">æ­£å¸¸è¿›è¡Œ</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // è§†å›¾æ¨¡å¼åˆ‡æ¢
    document.querySelectorAll('.view-mode-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const mode = this.dataset.mode;
            const url = new URL(window.location.href);
            url.searchParams.set('view_mode', mode);
            url.searchParams.delete('target_code');
            window.location.href = url.toString();
        });
    });

    // æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®
    document.querySelectorAll('.view-detail-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const targetCode = this.dataset.target;
            const url = new URL(window.location.href);
            url.searchParams.set('target_code', targetCode);
            window.location.href = url.toString();
        });
    });

    // è¯¦æƒ…æ¨¡æ€æ¡†ï¼šè‡ªåŠ¨å¼¹å‡ºä¸URLæ¸…ç†
    {% if target_code %}
    const detailModalEl = document.getElementById('detailModal');
    if (detailModalEl && window.bootstrap) {
        const detailModal = new bootstrap.Modal(detailModalEl);
        detailModal.show();
        detailModalEl.addEventListener('hidden.bs.modal', function() {
            const url = new URL(window.location.href);
            url.searchParams.delete('target_code');
            history.replaceState({}, '', url.toString());
        });
    }
    
    // æ¸²æŸ“è¶‹åŠ¿å›¾
    const trendData = {{ trend_data_json|safe }};
    
    function renderDetailTrend() {
        if (!(trendData && trendData.procurement && trendData.contract)) {
            const el = document.getElementById('trendChart');
            if (el) {
                el.innerHTML = '<div class="alert alert-info text-center">æš‚æ— è¶‹åŠ¿æ•°æ®</div>';
            }
            return;
        }
        
        // æ„å»ºæ ‡ç­¾åˆ—è¡¨ï¼ˆåªåŒ…å«æœ‰æ•°æ®çš„æ—¶é—´æ®µï¼‰
        const labelSet = new Set();
        trendData.procurement.forEach(item => {
            if (item.count > 0) {
                labelSet.add(item.period);
            }
        });
        trendData.contract.forEach(item => {
            if (item.count > 0) {
                labelSet.add(item.period);
            }
        });
        
        // åˆ¤æ–­ç»´åº¦å¹¶æ’åºæ ‡ç­¾
        const dimension = trendData.procurement.some(d => d.month) ? 'month' : 'year';
        let labels;
        if (dimension === 'month') {
            labels = Array.from(labelSet).sort((a, b) => {
                const aMonth = parseInt(a.replace('æœˆ', ''));
                const bMonth = parseInt(b.replace('æœˆ', ''));
                return aMonth - bMonth;
            });
        } else {
            labels = Array.from(labelSet).sort((a, b) => {
                const getKey = (lbl) => {
                    if (lbl.includes('ä¸ŠåŠå¹´')) {
                        return [parseInt(lbl.split('ä¸ŠåŠå¹´')[0]), 1];
                    }
                    if (lbl.includes('ä¸‹åŠå¹´')) {
                        return [parseInt(lbl.split('ä¸‹åŠå¹´')[0]), 2];
                    }
                    return [9999, 9];
                };
                const [aYear, aHalf] = getKey(a);
                const [bYear, bHalf] = getKey(b);
                if (aYear !== bYear) return aYear - bYear;
                return aHalf - bHalf;
            });
        }
        
        if (labels.length === 0) {
            const el = document.getElementById('trendChart');
            if (el) {
                el.innerHTML = '<div class="alert alert-info text-center">æš‚æ— è¶‹åŠ¿æ•°æ®</div>';
            }
            return;
        }
        
        // æ„å»ºé‡‡è´­å’ŒåˆåŒæ•°æ®ç³»åˆ—
        const procurementSeries = {
            name: 'é‡‡è´­å‘¨æœŸ',
            data: labels.map(label => {
                const item = trendData.procurement.find(d => d.period === label);
                return item && item.count > 0 ? item.avg_cycle : null;
            }),
            color: '#0d6efd'
        };
        
        const contractSeries = {
            name: 'åˆåŒå‘¨æœŸ',
            data: labels.map(label => {
                const item = trendData.contract.find(d => d.period === label);
                return item && item.count > 0 ? item.avg_cycle : null;
            }),
            color: '#198754'
        };
        
        // æ„å»ºå®Œæ•´çš„ç³»åˆ—æ•°ç»„
        const chartSeries = [procurementSeries, contractSeries];
        
        // ä½¿ç”¨ApexChartsæ¸²æŸ“
        if (typeof ApexCharts !== 'undefined') {
            const options = {
                chart: {
                    type: 'line',
                    height: 400,
                    toolbar: { show: true }
                },
                series: chartSeries,
                xaxis: {
                    categories: labels,
                    title: { text: 'æ—¶é—´å‘¨æœŸ' }
                },
                yaxis: {
                    title: { text: 'å¹³å‡å‘¨æœŸï¼ˆå¤©ï¼‰' },
                    labels: {
                        formatter: function(value) {
                            return value ? Math.round(value) : '';
                        }
                    }
                },
                title: {
                    text: 'å·¥ä½œå‘¨æœŸè¶‹åŠ¿',
                    align: 'left',
                    style: { fontSize: '16px', fontWeight: 600 }
                },
                stroke: {
                    curve: 'smooth',
                    width: 3
                },
                markers: {
                    size: 5
                },
                dataLabels: {
                    enabled: false
                },
                legend: {
                    show: true,
                    position: 'top',
                    horizontalAlign: 'right'
                },
                tooltip: {
                    enabled: true,
                    shared: true,
                    intersect: false,
                    y: {
                        formatter: function(value) {
                            return value !== null && value !== undefined ? Math.round(value) + 'å¤©' : 'æ— æ•°æ®';
                        }
                    }
                },
                colors: chartSeries.map(s => s.color),
                grid: {
                    borderColor: '#e7e7e7',
                    strokeDashArray: 4
                }
            };
            
            const el = document.getElementById('trendChart');
            if (el) {
                el.innerHTML = '';
                const chart = new ApexCharts(el, options);
                chart.render();
            }
        }
    }
    
    // ç¡®ä¿åœ¨æ¨¡æ€æ¡†æ˜¾ç¤ºæ—¶æ¸²æŸ“è¶‹åŠ¿å›¾
    if (detailModalEl) {
        detailModalEl.addEventListener('shown.bs.modal', function() {
            renderDetailTrend();
        });
    }
    {% endif %}
    
    // é‡‡è´­æ–¹å¼ç­›é€‰è¡¨å•ï¼šåˆå¹¶ç°æœ‰æŸ¥è¯¢å‚æ•°å†è·³è½¬
    const methodForm = document.getElementById('methodFilterForm');
    if (methodForm) {
        methodForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const url = new URL(window.location.href);
            const params = new URLSearchParams(url.search);

            // æ¸…ç†æ—§å‚æ•°
            params.delete('procurement_method');
            params.delete('group_by');

            // å†™å…¥æ–°å‚æ•°ï¼ˆå¤šé€‰ï¼‰
            const sel = document.getElementById('procurement_method');
            if (sel) {
                Array.from(sel.selectedOptions).forEach(opt => {
                    params.append('procurement_method', opt.value);
                });
            }
            // åˆ†ç»„
            const grp = document.getElementById('groupByMethod');
            if (grp && grp.checked) {
                params.set('group_by', 'procurement_method');
            }

            url.search = params.toString();
            window.location.href = url.toString();
        });
    }});
</script>
{% endblock %}

