{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    /* 总览卡片样式 */
    .stats-card {
        border-left: 4px solid;
        transition: all 0.3s ease;
        height: 100%;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stats-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .stats-card.procurement { border-left-color: #0d6efd; }
    .stats-card.contract { border-left-color: #198754; }
    .stats-card.quality { border-left-color: #ffc107; }
    .stats-card .card-body { padding: 1.25rem; }
    .stats-card .metric-value {
        font-size: 2rem;
        font-weight: 700;
        margin: 0.5rem 0;
    }
    .stats-card .metric-label {
        font-size: 0.875rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    .stats-card .metric-sub {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }
    
    /* 筛选区域 */
    .filter-section {
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .filter-section .form-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }
    
    /* 数据时间标识 */
    .data-time-badge {
        position: fixed;
        top: 80px;
        right: 20px;
        background: rgba(13, 110, 253, 0.9);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    /* 趋势图容器 */
    .trend-chart-container {
        background: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* 维度拆解表格 */
    .dimension-table {
        background: white;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .dimension-table th {
        background: #f8f9fa;
        font-weight: 600;
        border-bottom: 2px solid #dee2e6;
    }
    
    /* 明细表格 */
    .detail-table-container {
        background: white;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .detail-table {
        margin-bottom: 0;
    }
    .detail-table th {
        background: #f8f9fa;
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .detail-table tbody tr:hover {
        background-color: #f8f9fa;
    }
    
    /* 超期标识 */
    .overdue-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .overdue-badge.severe { background: #dc3545; color: white; }
    .overdue-badge.moderate { background: #ffc107; color: #000; }
    .overdue-badge.normal { background: #198754; color: white; }
    
    /* 响应式调整 */
    @media (max-width: 768px) {
        .stats-card .metric-value { font-size: 1.5rem; }
        .data-time-badge { position: static; margin-bottom: 1rem; }
    }
    
    /* 加载骨架屏 */
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
    }
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="fas fa-clock text-primary"></i> {{ page_title }}
        </h2>
        <div>
            <button type="button" class="btn btn-outline-primary" onclick="window.location.reload()">
                <i class="fas fa-sync-alt"></i> 刷新数据
            </button>
        </div>
    </div>
    
    <!-- 数据时间标识 -->
    <div class="data-time-badge">
        <i class="fas fa-clock"></i> 数据时间：{{ overview_stats.data_time }}
    </div>
    
    <!-- 当前筛选状态 -->
    <div class="alert alert-info mb-4">
        <i class="fas fa-filter"></i>
        <strong>当前筛选：</strong>
        {{ filter_config.display_year|default:"全部年度" }}
        {% if filter_config.selected_project_value %}
            · {{ filter_config.selected_project_value }}
        {% else %}
            · 全部项目
        {% endif %}
        {% if selected_procurement_methods %}
            · 采购方式：{{ selected_procurement_methods|join:", " }}
        {% endif %}
    </div>
    
    <!-- 筛选区域 -->
    <div class="filter-section">
        <form method="get" id="filterForm">
            <div class="row g-3">
                <!-- 时间维度选择 -->
                <div class="col-md-3">
                    <label class="form-label">时间维度</label>
                    <select name="time_dimension" class="form-select">
                        {% for value, label in time_dimension_choices %}
                        <option value="{{ value }}" {% if time_dimension == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <!-- 采购方式筛选 -->
                <div class="col-md-4">
                    <label class="form-label">采购方式（可多选）</label>
                    <select name="procurement_method" class="form-select" multiple size="4">
                        {% for method in procurement_method_choices %}
                        <option value="{{ method }}" {% if method in selected_procurement_methods %}selected{% endif %}>
                            {{ method }}
                        </option>
                        {% endfor %}
                        <option value="未标注" {% if '未标注' in selected_procurement_methods %}selected{% endif %}>
                            未标注
                        </option>
                    </select>
                    <small class="text-muted">按住Ctrl/Cmd可多选</small>
                </div>
                
                <!-- 分组选项 -->
                <div class="col-md-3">
                    <label class="form-label">分组展示</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="group_by" value="procurement_method" 
                               id="groupByMethod" {% if group_by == 'procurement_method' %}checked{% endif %}>
                        <label class="form-check-label" for="groupByMethod">
                            按采购方式分组
                        </label>
                    </div>
                    <div class="form-check mt-2">
                        <input class="form-check-input" type="checkbox" name="show_overdue_only" value="true"
                               id="showOverdueOnly" {% if show_overdue_only %}checked{% endif %}>
                        <label class="form-check-label" for="showOverdueOnly">
                            仅显示超期项目
                        </label>
                    </div>
                </div>
                
                <!-- 操作按钮 -->
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> 应用筛选
                    </button>
                </div>
            </div>
        </form>
    </div>
    
    <!-- 总览统计卡片 -->
    <div class="row g-3 mb-4">
        <!-- 采购周期卡片 -->
        <div class="col-md-3">
            <div class="card stats-card procurement">
                <div class="card-body">
                    <div class="metric-label">采购周期（平均）</div>
                    <div class="metric-value text-primary">
                        {{ overview_stats.procurement_cycle_avg }} 天
                    </div>
                    <div class="metric-sub">
                        P50: {{ overview_stats.procurement_cycle_p50 }}天 | 
                        P90: {{ overview_stats.procurement_cycle_p90 }}天
                    </div>
                    <div class="metric-sub mt-2">
                        项目数：{{ overview_stats.procurement_count }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 采购超期卡片 -->
        <div class="col-md-3">
            <div class="card stats-card procurement">
                <div class="card-body">
                    <div class="metric-label">采购超期情况</div>
                    <div class="metric-value {% if overview_stats.procurement_overdue_rate > 20 %}text-danger{% elif overview_stats.procurement_overdue_rate > 10 %}text-warning{% else %}text-success{% endif %}">
                        {{ overview_stats.procurement_overdue_rate }}%
                    </div>
                    <div class="metric-sub">
                        超期项目：{{ overview_stats.procurement_overdue_cnt }} 个
                    </div>
                    <div class="metric-sub mt-2">
                        SLA标准：{{ sla_procurement_default }}天
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 合同周期卡片 -->
        <div class="col-md-3">
            <div class="card stats-card contract">
                <div class="card-body">
                    <div class="metric-label">合同周期（平均）</div>
                    <div class="metric-value text-success">
                        {{ overview_stats.contract_cycle_avg }} 天
                    </div>
                    <div class="metric-sub">
                        P50: {{ overview_stats.contract_cycle_p50 }}天 | 
                        P90: {{ overview_stats.contract_cycle_p90 }}天
                    </div>
                    <div class="metric-sub mt-2">
                        项目数：{{ overview_stats.contract_count }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 合同超期卡片 -->
        <div class="col-md-3">
            <div class="card stats-card contract">
                <div class="card-body">
                    <div class="metric-label">合同超期情况</div>
                    <div class="metric-value {% if overview_stats.contract_overdue_rate > 20 %}text-danger{% elif overview_stats.contract_overdue_rate > 10 %}text-warning{% else %}text-success{% endif %}">
                        {{ overview_stats.contract_overdue_rate }}%
                    </div>
                    <div class="metric-sub">
                        超期项目：{{ overview_stats.contract_overdue_cnt }} 个
                    </div>
                    <div class="metric-sub mt-2">
                        SLA标准：{{ sla_contract }}天
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 数据质量卡片 -->
    <div class="row g-3 mb-4">
        <div class="col-md-6">
            <div class="card stats-card quality">
                <div class="card-body">
                    <div class="metric-label">数据质量 - 缺失端点</div>
                    <div class="metric-value text-warning">
                        {{ overview_stats.dq_missing_endpoints }} 个
                    </div>
                    <div class="metric-sub">
                        不满足端点齐全的项目数量
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card stats-card quality">
                <div class="card-body">
                    <div class="metric-label">数据质量 - 异常项目</div>
                    <div class="metric-value text-warning">
                        {{ overview_stats.dq_anomaly_projects }} 个
                    </div>
                    <div class="metric-sub">
                        多公示/多合同/跨系统差异等异常
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 趋势图 -->
    <div class="trend-chart-container">
        <h5 class="mb-3">
            <i class="fas fa-chart-line"></i> 工作周期趋势分析
        </h5>
        <div id="trendChart" style="height: 400px;"></div>
    </div>
    
    <!-- 按采购方式分组展示 -->
    {% if dimension_breakdown %}
    <div class="dimension-table mb-4">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0">
                    <i class="fas fa-layer-group"></i> 按采购方式分组统计
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th style="width: 25%">采购方式</th>
                                <th>样本量</th>
                                <th>平均天数</th>
                                <th>P50</th>
                                <th>P90</th>
                                <th>达标率</th>
                                <th>SLA阈值(天)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in dimension_breakdown %}
                            <tr>
                                <td><strong>{{ row.method }}</strong></td>
                                <td>{{ row.count }}</td>
                                <td>{{ row.avg_cycle }}</td>
                                <td>{{ row.p50 }}</td>
                                <td>{{ row.p90 }}</td>
                                <td>
                                    <span class="overdue-badge {% if row.on_time_rate >= 90 %}normal{% elif row.on_time_rate >= 70 %}moderate{% else %}severe{% endif %}">
                                        {{ row.on_time_rate }}%
                                    </span>
                                </td>
                                <td>{{ row.deadline }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 明细表 -->
    <div class="detail-table-container">
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table"></i> 明细记录
                    <span class="badge bg-primary ms-2">{{ detail_records|length }} 条</span>
                </h5>
                <div>
                    <a href="?{{ request.GET.urlencode }}&export=csv" class="btn btn-sm btn-outline-success">
                        <i class="fas fa-file-csv"></i> 导出CSV
                    </a>
                    <a href="?{{ request.GET.urlencode }}&export=excel" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-file-excel"></i> 导出Excel
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                    <table class="table detail-table table-sm">
                        <thead>
                            <tr>
                                <th>项目名称</th>
                                <th>需求审批</th>
                                <th>结果公示</th>
                                <th>合同签订</th>
                                <th>采购周期</th>
                                <th>合同周期</th>
                                <th>采购方式</th>
                                <th>经办人</th>
                                <th>状态</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for record in detail_records %}
                            <tr>
                                <td>
                                    <strong>{{ record.project_name }}</strong>
                                    {% if record.project_id %}
                                    <br><small class="text-muted">{{ record.project_id }}</small>
                                    {% endif %}
                                </td>
                                <td>{{ record.demand_approval_time|default:"-" }}</td>
                                <td>{{ record.result_publish_time|default:"-" }}</td>
                                <td>{{ record.contract_sign_date|default:"-" }}</td>
                                <td>
                                    {% if record.procurement_cycle_days is not None %}
                                        {{ record.procurement_cycle_days }}天
                                        {% if record.is_overdue_proc %}
                                        <span class="overdue-badge severe">超期</span>
                                        {% else %}
                                        <span class="overdue-badge normal">正常</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if record.contract_cycle_days is not None %}
                                        {{ record.contract_cycle_days }}天
                                        {% if record.is_overdue_cont %}
                                        <span class="overdue-badge severe">超期</span>
                                        {% else %}
                                        <span class="overdue-badge normal">正常</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ record.procurement_method }}</td>
                                <td>{{ record.owner|default:"-" }}</td>
                                <td>
                                    {% if record.status == '缺失端点' %}
                                    <span class="badge bg-warning">{{ record.status }}</span>
                                    {% else %}
                                    <span class="badge bg-success">{{ record.status }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="9" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                    暂无数据，请调整筛选条件
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts@3.45.0/dist/apexcharts.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 渲染趋势图
    const trendData = {{ trend_data_json|safe }};
    
    if (trendData && (trendData.procurement_trend.length > 0 || trendData.contract_trend.length > 0)) {
        renderTrendChart(trendData);
    } else {
        document.getElementById('trendChart').innerHTML = '<div class="alert alert-info text-center">暂无趋势数据</div>';
    }
    
    function renderTrendChart(data) {
        const procLabels = data.procurement_trend.map(d => d.period);
        const contLabels = data.contract_trend.map(d => d.period);
        const allLabels = [...new Set([...procLabels, ...contLabels])].sort();
        
        const procData = allLabels.map(label => {
            const item = data.procurement_trend.find(d => d.period === label);
            return item ? item.avg_cycle : null;
        });
        
        const contData = allLabels.map(label => {
            const item = data.contract_trend.find(d => d.period === label);
            return item ? item.avg_cycle : null;
        });
        
        const options = {
            chart: {
                type: 'line',
                height: 400,
                toolbar: { show: true },
                zoom: { enabled: true }
            },
            series: [
                {
                    name: '采购周期',
                    data: procData,
                    color: '#0d6efd'
                },
                {
                    name: '合同周期',
                    data: contData,
                    color: '#198754'
                }
            ],
            xaxis: {
                categories: allLabels,
                title: { text: '时间周期' }
            },
            yaxis: {
                title: { text: '平均周期（天）' },
                labels: {
                    formatter: function(value) {
                        return value ? Math.round(value) : '';
                    }
                }
            },
            stroke: {
                curve: 'smooth',
                width: 3
            },
            markers: {
                size: 5,
                hover: { size: 7 }
            },
            dataLabels: {
                enabled: false
            },
            legend: {
                show: true,
                position: 'top',
                horizontalAlign: 'right'
            },
            tooltip: {
                shared: true,
                intersect: false,
                y: {
                    formatter: function(value) {
                        return value !== null && value !== undefined ? Math.round(value) + '天' : '无数据';
                    }
                }
            },
            grid: {
                borderColor: '#e7e7e7',
                strokeDashArray: 4
            }
        };
        
        const chart = new ApexCharts(document.getElementById('trendChart'), options);
        chart.render();
    }
});
</script>
{% endblock %}