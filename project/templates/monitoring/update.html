{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }} - 项目采购与成本管理系统{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/monitoring.css' %}">
<style>
/* 更新监控专用样式 */
.update-table {
    width: 100%;
    margin-top: 20px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.update-table table {
    width: 100%;
    border-collapse: collapse;
}

.update-table th {
    background: #f8f9fa;
    padding: 12px;
    text-align: center;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
    color: #495057;
}

.update-table td {
    padding: 10px 12px;
    text-align: center;
    border-bottom: 1px solid #f0f0f0;
}

.update-table tbody tr:hover {
    background: #f8f9fa;
}

/* 状态徽章样式 */
.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 500;
}

.status-normal {
    background: #d4edda;
    color: #155724;
}

.status-warning {
    background: #fff3cd;
    color: #856404;
}

.status-error {
    background: #f8d7da;
    color: #721c24;
}

.status-no-data {
    background: #e9ecef;
    color: #6c757d;
}

/* 数据单元格样式 */
.data-cell {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
}

.data-date {
    font-size: 14px;
    font-weight: 500;
}

.data-days {
    font-size: 12px;
    color: #6c757d;
}

/* 活跃度卡片 */
.activity-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.activity-card {
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    text-align: center;
}

.activity-card .value {
    font-size: 32px;
    font-weight: bold;
    color: #667eea;
    margin: 10px 0;
}

.activity-card .label {
    font-size: 14px;
    color: #6c757d;
}

/* 沉默项目警告 */
.silent-warning {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
    padding: 15px;
    margin: 15px 0;
    border-radius: 4px;
}

.silent-warning strong {
    color: #856404;
}
</style>
{% endblock %}

{% block content %}
<div class="monitoring-dashboard">
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
        <div>
            <h1><i class="fas fa-sync-alt"></i> {{ page_title }}</h1>
            <p class="text-muted">监控各项目各模块的数据更新时效性，及时发现数据录入滞后问题</p>
        </div>
        
        <!-- 筛选器 -->
        <div class="filter-section" style="padding: 12px 16px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <form method="get" action="" id="updateFilterForm" style="display: flex; align-items: center; gap: 12px; margin: 0;">
                {% for filter in quick_filters %}
                    {% if filter.type == 'select' %}
                        <label style="font-weight: 600; color: #495057; margin: 0; white-space: nowrap;">
                            {% if filter.name == 'year' %}年份：{% elif filter.name == 'project' %}项目：{% endif %}
                        </label>
                        <select name="{{ filter.name }}"
                                class="form-control form-control-sm filter-select"
                                onchange="this.form.submit()"
                                style="width: {{ filter.width|default:'150px' }}; border-radius: 4px;">
                            {% for option in filter.options %}
                                <option value="{{ option.value }}"
                                        {% if option.value == filter.current_value %}selected{% endif %}>
                                    {{ option.label }}
                                </option>
                            {% endfor %}
                        </select>
                    {% endif %}
                {% endfor %}
                
                <label style="display: flex; align-items: center; gap: 5px; margin: 0; cursor: pointer;">
                    <input type="checkbox" name="only_active" value="true" {% if only_active %}checked{% endif %} onchange="this.form.submit()">
                    <span style="font-size: 13px; color: #495057;">仅进行中项目</span>
                </label>
            </form>
        </div>
    </div>

    <!-- 关键指标 -->
    <div class="alert alert-info mb-3">
        <i class="fas fa-info-circle"></i>
        <strong>监控标准：</strong>超过 <span class="badge badge-warning">{{ warning_days }}天</span> 未更新的模块将显示🔴红色预警；
        <span class="badge badge-warning">30-40天</span> 未更新显示🟡黄色提醒；
        <span class="badge badge-success">40天内</span>有更新显示✅绿色正常。
    </div>

    <!-- 总体统计卡片 -->
    <div class="key-metrics-grid" style="margin-bottom: 30px;">
        <div class="key-metric-card">
            <div class="key-metric-header">
                <div>
                    <div class="key-metric-title">监控项目数</div>
                    <div class="key-metric-value">{{ project_status.total_projects }}</div>
                </div>
                <div class="key-metric-icon">
                    <i class="fas fa-folder-open"></i>
                </div>
            </div>
            <div class="key-metric-trend">
                <i class="fas fa-database"></i> 总项目数
            </div>
        </div>

        <div class="key-metric-card success">
            <div class="key-metric-header">
                <div>
                    <div class="key-metric-title">正常项目</div>
                    <div class="key-metric-value">{{ project_status.normal_projects }}</div>
                </div>
                <div class="key-metric-icon success">
                    <i class="fas fa-check-circle"></i>
                </div>
            </div>
            <div class="key-metric-trend up">
                <i class="fas fa-arrow-up"></i> 数据及时更新
            </div>
        </div>

        <div class="key-metric-card warning">
            <div class="key-metric-header">
                <div>
                    <div class="key-metric-title">需关注项目</div>
                    <div class="key-metric-value">{{ project_status.warning_projects }}</div>
                </div>
                <div class="key-metric-icon warning">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
            </div>
            <div class="key-metric-trend down">
                <i class="fas fa-exclamation-circle"></i> 存在过期数据
            </div>
        </div>
    </div>

    <!-- 数据活跃度分析 -->
    {% if activity_analysis %}
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-chart-line"></i> 数据活跃度分析（最近30天）</h5>
        </div>
        <div class="card-body">
            <div class="activity-cards">
                <div class="activity-card">
                    <div class="label">总更新次数</div>
                    <div class="value">{{ activity_analysis.total_updates }}</div>
                    <div class="label">次</div>
                </div>
                <div class="activity-card">
                    <div class="label">日均更新</div>
                    <div class="value">{{ activity_analysis.daily_avg_updates }}</div>
                    <div class="label">次/天</div>
                </div>
                <div class="activity-card">
                    <div class="label">30天无更新</div>
                    <div class="value" style="color: #ffc107;">{{ activity_analysis.silent_projects.30天无更新 }}</div>
                    <div class="label">个项目</div>
                </div>
                <div class="activity-card">
                    <div class="label">60天无更新</div>
                    <div class="value" style="color: #fd7e14;">{{ activity_analysis.silent_projects.60天无更新 }}</div>
                    <div class="label">个项目</div>
                </div>
                <div class="activity-card">
                    <div class="label">90天以上无更新</div>
                    <div class="value" style="color: #dc3545;">{{ activity_analysis.silent_projects.90天以上无更新 }}</div>
                    <div class="label">个项目</div>
                </div>
            </div>
            
            {% if activity_analysis.silent_projects.30天无更新 > 0 or activity_analysis.silent_projects.60天无更新 > 0 %}
            <div class="silent-warning">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>沉默项目提醒：</strong>
                发现 <strong>{{ activity_analysis.silent_projects.30天无更新 }}</strong> 个项目超过30天未更新，
                <strong>{{ activity_analysis.silent_projects.60天无更新 }}</strong> 个项目超过60天未更新，
                请及时跟进录入最新数据。
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- 各模块数据状态概览 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-chart-bar"></i> 各模块数据状态</h5>
        </div>
        <div class="card-body">
            <div class="row" style="display: flex; flex-wrap: nowrap; justify-content: space-between;">
                
                <div class="col-3" style="flex: 0 0 24%; max-width: 24%; padding: 0 5px;">
                    <div class="card border-success" style="margin-bottom: 0;">
                        <div class="card-body text-center" style="padding: 15px 10px;">
                            <h6 style="margin-bottom: 8px; font-size: 15px;">采购</h6>
                            <div style="font-size: 36px; font-weight: bold; margin: 10px 0; color: #28a745;">
                                {{ module_overview.0.total_count|default:0 }}
                            </div>
                            <div style="font-size: 13px; color: #6c757d;">
                                <span class="badge badge-success">{{ module_overview.0.normal_count|default:0 }} 正常</span>
                                {% if module_overview.0.outdated_count > 0 %}
                                <span class="badge badge-warning">{{ module_overview.0.outdated_count }} 过期</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-3" style="flex: 0 0 24%; max-width: 24%; padding: 0 5px;">
                    <div class="card border-success" style="margin-bottom: 0;">
                        <div class="card-body text-center" style="padding: 15px 10px;">
                            <h6 style="margin-bottom: 8px; font-size: 15px;">合同</h6>
                            <div style="font-size: 36px; font-weight: bold; margin: 10px 0; color: #007bff;">
                                {{ module_overview.1.total_count|default:0 }}
                            </div>
                            <div style="font-size: 13px; color: #6c757d;">
                                <span class="badge badge-success">{{ module_overview.1.normal_count|default:0 }} 正常</span>
                                {% if module_overview.1.outdated_count > 0 %}
                                <span class="badge badge-warning">{{ module_overview.1.outdated_count }} 过期</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-3" style="flex: 0 0 24%; max-width: 24%; padding: 0 5px;">
                    <div class="card border-success" style="margin-bottom: 0;">
                        <div class="card-body text-center" style="padding: 15px 10px;">
                            <h6 style="margin-bottom: 8px; font-size: 15px;">付款</h6>
                            <div style="font-size: 36px; font-weight: bold; margin: 10px 0; color: #ffc107;">
                                {{ module_overview.2.total_count|default:0 }}
                            </div>
                            <div style="font-size: 13px; color: #6c757d;">
                                <span class="badge badge-success">{{ module_overview.2.normal_count|default:0 }} 正常</span>
                                {% if module_overview.2.outdated_count > 0 %}
                                <span class="badge badge-warning">{{ module_overview.2.outdated_count }} 过期</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="col-3" style="flex: 0 0 24%; max-width: 24%; padding: 0 5px;">
                    <div class="card border-success" style="margin-bottom: 0;">
                        <div class="card-body text-center" style="padding: 15px 10px;">
                            <h6 style="margin-bottom: 8px; font-size: 15px;">结算</h6>
                            <div style="font-size: 36px; font-weight: bold; margin: 10px 0; color: #17a2b8;">
                                {{ module_overview.3.total_count|default:0 }}
                            </div>
                            <div style="font-size: 13px; color: #6c757d;">
                                <span class="badge badge-success">{{ module_overview.3.normal_count|default:0 }} 正常</span>
                                {% if module_overview.3.outdated_count > 0 %}
                                <span class="badge badge-warning">{{ module_overview.3.outdated_count }} 过期</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <!-- 最近更新日期监控表 - 按照需求文档3.2.1设计 -->
    <div class="card">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-table"></i> 最近更新日期监控表</h5>
        </div>
        <div class="card-body p-0">
            <div class="update-table">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px;">序号</th>
                            <th style="width: 200px;">项目名称</th>
                            <th style="width: 100px;">项目状态</th>
                            <th>采购更新</th>
                            <th>合同更新</th>
                            <th>付款更新</th>
                            <th>结算更新</th>
                            <th style="width: 120px;">整体状态</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in projects %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td style="text-align: left;">
                                <a href="{% url 'project_detail' project.project_code %}" style="text-decoration: none; color: #007bff;">
                                    {{ project.project_name }}
                                </a>
                            </td>
                            <td>
                                <span class="badge {% if project.project_status == '进行中' %}badge-primary{% else %}badge-secondary{% endif %}">
                                    {{ project.project_status }}
                                </span>
                            </td>
                            
                            <!-- 采购模块 -->
                            <td>
                                {% if project.modules.采购.last_update %}
                                <div class="data-cell">
                                    <span class="data-date">{{ project.modules.采购.last_update }}</span>
                                    <span class="data-days">({{ project.modules.采购.days_ago }}天)</span>
                                    {% if project.modules.采购.status == 'normal' %}
                                        <span style="font-size: 18px;">✅</span>
                                    {% elif project.modules.采购.status == 'warning' %}
                                        <span style="font-size: 18px;">🟡</span>
                                    {% elif project.modules.采购.status == 'error' %}
                                        <span style="font-size: 18px;">🔴</span>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span class="status-badge status-no-data">未录入</span>
                                {% endif %}
                            </td>
                            
                            <!-- 合同模块 -->
                            <td>
                                {% if project.modules.合同.last_update %}
                                <div class="data-cell">
                                    <span class="data-date">{{ project.modules.合同.last_update }}</span>
                                    <span class="data-days">({{ project.modules.合同.days_ago }}天)</span>
                                    {% if project.modules.合同.status == 'normal' %}
                                        <span style="font-size: 18px;">✅</span>
                                    {% elif project.modules.合同.status == 'warning' %}
                                        <span style="font-size: 18px;">🟡</span>
                                    {% elif project.modules.合同.status == 'error' %}
                                        <span style="font-size: 18px;">🔴</span>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span class="status-badge status-no-data">未录入</span>
                                {% endif %}
                            </td>
                            
                            <!-- 付款模块 -->
                            <td>
                                {% if project.modules.付款.last_update %}
                                <div class="data-cell">
                                    <span class="data-date">{{ project.modules.付款.last_update }}</span>
                                    <span class="data-days">({{ project.modules.付款.days_ago }}天)</span>
                                    {% if project.modules.付款.status == 'normal' %}
                                        <span style="font-size: 18px;">✅</span>
                                    {% elif project.modules.付款.status == 'warning' %}
                                        <span style="font-size: 18px;">🟡</span>
                                    {% elif project.modules.付款.status == 'error' %}
                                        <span style="font-size: 18px;">🔴</span>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span class="status-badge status-no-data">未录入</span>
                                {% endif %}
                            </td>
                            
                            <!-- 结算模块 -->
                            <td>
                                {% if project.modules.结算.last_update %}
                                <div class="data-cell">
                                    <span class="data-date">{{ project.modules.结算.last_update }}</span>
                                    <span class="data-days">({{ project.modules.结算.days_ago }}天)</span>
                                    {% if project.modules.结算.status == 'normal' %}
                                        <span style="font-size: 18px;">✅</span>
                                    {% elif project.modules.结算.status == 'warning' %}
                                        <span style="font-size: 18px;">🟡</span>
                                    {% elif project.modules.结算.status == 'error' %}
                                        <span style="font-size: 18px;">🔴</span>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span class="status-badge status-no-data">-</span>
                                {% endif %}
                            </td>
                            <!-- 整体状态 -->
                            <td>
                                {% if project.overall_status == 'normal' %}
                                    <span class="status-badge status-normal">正常</span>
                                {% else %}
                                    <span class="status-badge status-error">需关注</span>
                                    <div style="font-size: 11px; color: #721c24; margin-top: 4px;">
                                        {{ project.warning_count }}个模块预警
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <i class="fas fa-inbox fa-3x text-muted mb-3" style="display: block;"></i>
                                <p class="text-muted">暂无符合条件的项目数据</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- 分页 -->
            {% if page_obj.has_other_pages %}
            <div style="padding: 15px;">
                <nav aria-label="分页导航">
                    <ul class="pagination justify-content-center mb-0">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1&warning_days={{ warning_days }}&only_active={{ only_active|yesno:'true,false' }}">首页</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}&warning_days={{ warning_days }}&only_active={{ only_active|yesno:'true,false' }}">上一页</a>
                        </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">第 {{ page_obj.number }} / {{ page_obj.paginator.num_pages }} 页</span>
                        </li>

                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}&warning_days={{ warning_days }}&only_active={{ only_active|yesno:'true,false' }}">下一页</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&warning_days={{ warning_days }}&only_active={{ only_active|yesno:'true,false' }}">末页</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 说明卡片 -->
    <div class="card mt-4">
        <div class="card-body">
            <h6><i class="fas fa-info-circle"></i> 使用说明</h6>
            <ul class="mb-0" style="font-size: 14px; color: #6c757d;">
                <li><strong>最近更新日期：</strong>显示各模块最新一条记录的创建或更新时间</li>
                <li><strong>距今天数：</strong>从最近更新日期到今天的间隔天数</li>
                <li><strong>预警规则：</strong>
                    <span class="badge badge-success">✅ 绿色</span> = 40天内有更新（正常）；
                    <span class="badge badge-warning">🟡 黄色</span> = 30-40天未更新（提醒关注）；
                    <span class="badge badge-danger">🔴 红色</span> = 超过40天未更新（需要立即处理）
                </li>
                <li><strong>整体状态：</strong>只要有一个模块出现🔴红色预警，项目整体状态即为"需关注"</li>
                <li><strong>仅进行中项目：</strong>勾选后只显示状态为"进行中"的项目，已完成项目不参与预警</li>
                <li><strong>交互功能：</strong>点击项目名称可查看该项目的详细信息</li>
            </ul>
        </div>
    </div>

    <!-- 返回按钮 -->
    <div class="mt-4 mb-4">
        <a href="{% url 'monitoring_dashboard' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> 返回监控中心
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    console.log('更新监控页面加载完成');
    
    // 可以添加一些交互功能
    // 例如：点击单元格显示详细信息
});
</script>
{% endblock %}