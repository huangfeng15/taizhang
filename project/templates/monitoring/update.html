{% extends "base.html" %}
{% load static %}
{% load monitor_filters %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    .view-mode-selector {
        display: inline-flex;
        border-radius: 0.375rem;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .view-mode-btn {
        padding: 0.5rem 1.5rem;
        border: none;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
    }
    .view-mode-btn:hover {
        background: #f8f9fa;
    }
    .view-mode-btn.active {
        background: #0d6efd;
        color: white;
    }
    .stats-card {
        border-left: 4px solid;
        transition: transform 0.2s;
        height: 100%;
    }
    .stats-card .card-body { padding: 0.75rem 1rem; }
    .stats-card h2, .stats-card h3 { margin: 0.25rem 0; }
    .stats-card h6 { margin-bottom: 0.25rem; }
    .stats-card:hover {
        transform: translateY(-2px);
    }
    .stats-card.procurement {
        border-left-color: #0d6efd;
    }
    .stats-card.contract {
        border-left-color: #198754;
    }
    .stats-card.payment {
        border-left-color: #ffc107;
    }
    .stats-card.settlement {
        border-left-color: #6f42c1;
    }
    .stats-card.overall {
        border-left-color: #6c757d;
    }
    /* Equal height helpers for cards */
    .equal-col { display: flex; }
    .equal-col .card { height: 100%; width: 100%; }
    .progress { height: 20px; }
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
    .on-time-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    .on-time-badge.high {
        background-color: #d1e7dd;
        color: #0f5132;
    }
    .on-time-badge.medium {
        background-color: #fff3cd;
        color: #664d03;
    }
    .on-time-badge.low {
        background-color: #f8d7da;
        color: #842029;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- 页面标题和视图切换 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">{{ page_title }}</h2>
        <div class="view-mode-selector">
            <button type="button" class="view-mode-btn {% if view_mode == 'project' %}active{% endif %}" data-mode="project">
                <i class="fas fa-project-diagram"></i> 项目视图
            </button>
            <button type="button" class="view-mode-btn {% if view_mode == 'person' %}active{% endif %}" data-mode="person">
                <i class="fas fa-user"></i> 个人视图
            </button>
        </div>
    </div>

    <!-- 筛选条件 -->
    <div class="card mb-3">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <!-- 保留现有参数 -->
                <input type="hidden" name="view_mode" value="{{ view_mode }}">
                {% if filter_config.selected_year_value %}
                <input type="hidden" name="year" value="{{ filter_config.selected_year_value }}">
                {% endif %}
                {% if filter_config.selected_project_value %}
                <input type="hidden" name="project" value="{{ filter_config.selected_project_value }}">
                {% endif %}
                
                <!-- 起始日期选择器 -->
                <div class="col-md-3">
                    <label for="start_date" class="form-label">
                        <i class="fas fa-calendar-alt"></i> 业务起始日期
                    </label>
                    <input type="date" class="form-control" id="start_date" name="start_date"
                           value="{{ start_date|default:'' }}"
                           title="只统计该日期之后的业务数据">
                </div>
                
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> 应用筛选
                    </button>
                    {% if start_date %}
                    <a href="?view_mode={{ view_mode }}{% if filter_config.selected_year_value %}&year={{ filter_config.selected_year_value }}{% endif %}{% if filter_config.selected_project_value %}&project={{ filter_config.selected_project_value }}{% endif %}"
                       class="btn btn-secondary">
                        <i class="fas fa-times"></i> 清除
                    </a>
                    {% endif %}
                </div>
                
                <div class="col-md-7">
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle"></i>
                        当前筛选：{{ filter_config.display_year|default:"全部年度" }}
                        {% if filter_config.selected_project_value %} · {{ filter_config.selected_project_value }}{% else %} · 全部项目{% endif %}
                        {% if start_date %} · 起始日期：{{ start_date }}{% endif %}
                        <span class="ms-3">准时规则：业务发生次月月底前更新</span>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 汇总统计卡片（6张） -->
    {% if overview_data %}
    <div class="row mb-4">
        <div class="col-md-2 equal-col">
            <div class="card text-center stats-card overall h-100 w-100">
                <div class="card-body">
                    <h6 class="text-muted">{% if view_mode == 'project' %}项目总数{% else %}经办人数{% endif %}</h6>
                    <h2 class="text-primary">
                        {% if view_mode == 'project' %}
                            {{ overview_data.summary.project_count }}
                        {% else %}
                            {{ overview_data.summary.person_count }}
                        {% endif %}
                    </h2>
                </div>
            </div>
        </div>
        <div class="col-md-2 equal-col">
            <div class="card text-center stats-card procurement h-100 w-100">
                <div class="card-body">
                    <h6 class="text-muted">采购情况</h6>
                    <h3>{{ overview_data.summary.procurement_stats.updated }}/{{ overview_data.summary.procurement_stats.total }}</h3>
                    <small class="text-muted">已更新/总数</small>
                </div>
            </div>
        </div>
        <div class="col-md-2 equal-col">
            <div class="card text-center stats-card contract h-100 w-100">
                <div class="card-body">
                    <h6 class="text-muted">合同情况</h6>
                    <h3>{{ overview_data.summary.contract_stats.updated }}/{{ overview_data.summary.contract_stats.total }}</h3>
                    <small class="text-muted">已更新/总数</small>
                </div>
            </div>
        </div>
        <div class="col-md-2 equal-col">
            <div class="card text-center stats-card payment h-100 w-100">
                <div class="card-body">
                    <h6 class="text-muted">支付情况</h6>
                    <h3>{{ overview_data.summary.payment_stats.updated }}/{{ overview_data.summary.payment_stats.total }}</h3>
                    <small class="text-muted">已更新/总数</small>
                </div>
            </div>
        </div>
        <div class="col-md-2 equal-col">
            <div class="card text-center stats-card settlement h-100 w-100">
                <div class="card-body">
                    <h6 class="text-muted">结算情况</h6>
                    <h3>{{ overview_data.summary.settlement_stats.updated }}/{{ overview_data.summary.settlement_stats.total }}</h3>
                    <small class="text-muted">已更新/总数</small>
                </div>
            </div>
        </div>
        <div class="col-md-2 equal-col">
            <div class="card text-center stats-card overall h-100 w-100">
                <div class="card-body">
                    <h6 class="text-muted">综合准时率</h6>
                    <h2 class="text-success">{{ overview_data.summary.overall_on_time_rate }}%</h2>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 数据列表表格 -->
    {% if overview_data %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                {% if view_mode == 'project' %}项目更新统计明细{% else %}经办人更新统计明细{% endif %}
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>{% if view_mode == 'project' %}项目名称{% else %}经办人{% endif %}</th>
                            <th>采购</th>
                            <th>采购准时率</th>
                            <th>合同</th>
                            <th>合同准时率</th>
                            <th>支付</th>
                            <th>支付准时率</th>
                            <th>结算</th>
                            <th>结算准时率</th>
                            <th>综合准时率</th>
                            {% if view_mode == 'person' %}<th>负责项目</th>{% endif %}
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if view_mode == 'project' %}
                            {% for project in overview_data.projects %}
                            <tr>
                                <td><strong>{{ project.project_code }}</strong><br><small>{{ project.project_name }}</small></td>
                                <td>{{ project.procurement_updated }}/{{ project.procurement_count }}<br><small class="text-muted">{{ project.procurement_avg_days }}天</small></td>
                                <td>
                                    <span class="on-time-badge {% if project.procurement_on_time_rate >= 90 %}high{% elif project.procurement_on_time_rate >= 70 %}medium{% else %}low{% endif %}">
                                        {{ project.procurement_on_time_rate }}%
                                    </span>
                                </td>
                                <td>{{ project.contract_updated }}/{{ project.contract_count }}<br><small class="text-muted">{{ project.contract_avg_days }}天</small></td>
                                <td>
                                    <span class="on-time-badge {% if project.contract_on_time_rate >= 90 %}high{% elif project.contract_on_time_rate >= 70 %}medium{% else %}low{% endif %}">
                                        {{ project.contract_on_time_rate }}%
                                    </span>
                                </td>
                                <td>{{ project.payment_updated }}/{{ project.payment_count }}<br><small class="text-muted">{{ project.payment_avg_days }}天</small></td>
                                <td>
                                    <span class="on-time-badge {% if project.payment_on_time_rate >= 90 %}high{% elif project.payment_on_time_rate >= 70 %}medium{% else %}low{% endif %}">
                                        {{ project.payment_on_time_rate }}%
                                    </span>
                                </td>
                                <td>{{ project.settlement_updated }}/{{ project.settlement_count }}<br><small class="text-muted">{{ project.settlement_avg_days }}天</small></td>
                                <td>
                                    <span class="on-time-badge {% if project.settlement_on_time_rate >= 90 %}high{% elif project.settlement_on_time_rate >= 70 %}medium{% else %}low{% endif %}">
                                        {{ project.settlement_on_time_rate }}%
                                    </span>
                                </td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar {% if project.overall_on_time_rate >= 90 %}bg-success{% elif project.overall_on_time_rate >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                             role="progressbar" style="width: {{ project.overall_on_time_rate }}%" 
                                             aria-valuenow="{{ project.overall_on_time_rate }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ project.overall_on_time_rate }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-primary view-detail-btn" data-target="{{ project.project_code }}">
                                        <i class="fas fa-eye"></i> 查看详情
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            {% for person in overview_data.persons %}
                            <tr>
                                <td><strong>{{ person.person_name }}</strong></td>
                                <td>{{ person.procurement_updated }}/{{ person.procurement_count }}<br><small class="text-muted">{{ person.procurement_avg_days }}天</small></td>
                                <td>
                                    <span class="on-time-badge {% if person.procurement_on_time_rate >= 90 %}high{% elif person.procurement_on_time_rate >= 70 %}medium{% else %}low{% endif %}">
                                        {{ person.procurement_on_time_rate }}%
                                    </span>
                                </td>
                                <td>{{ person.contract_updated }}/{{ person.contract_count }}<br><small class="text-muted">{{ person.contract_avg_days }}天</small></td>
                                <td>
                                    <span class="on-time-badge {% if person.contract_on_time_rate >= 90 %}high{% elif person.contract_on_time_rate >= 70 %}medium{% else %}low{% endif %}">
                                        {{ person.contract_on_time_rate }}%
                                    </span>
                                </td>
                                <td>{{ person.payment_updated }}/{{ person.payment_count }}<br><small class="text-muted">{{ person.payment_avg_days }}天</small></td>
                                <td>
                                    <span class="on-time-badge {% if person.payment_on_time_rate >= 90 %}high{% elif person.payment_on_time_rate >= 70 %}medium{% else %}low{% endif %}">
                                        {{ person.payment_on_time_rate }}%
                                    </span>
                                </td>
                                <td>{{ person.settlement_updated }}/{{ person.settlement_count }}<br><small class="text-muted">{{ person.settlement_avg_days }}天</small></td>
                                <td>
                                    <span class="on-time-badge {% if person.settlement_on_time_rate >= 90 %}high{% elif person.settlement_on_time_rate >= 70 %}medium{% else %}low{% endif %}">
                                        {{ person.settlement_on_time_rate }}%
                                    </span>
                                </td>
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar {% if person.overall_on_time_rate >= 90 %}bg-success{% elif person.overall_on_time_rate >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                             role="progressbar" style="width: {{ person.overall_on_time_rate }}%"
                                             aria-valuenow="{{ person.overall_on_time_rate }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ person.overall_on_time_rate }}%
                                        </div>
                                    </div>
                                </td>
                                <td>{{ person.project_count }}个</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-primary view-detail-btn" data-target="{{ person.person_name }}">
                                        <i class="fas fa-eye"></i> 查看详情
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 延迟记录列表 -->
    {% if trend_and_problems and trend_and_problems.problems %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-exclamation-triangle"></i> 
                {% if view_mode == 'project' %}
                    {% if filter_config.selected_project_value %}本项目延迟记录{% else %}所有项目延迟记录{% endif %}
                {% else %}
                    所有经办人延迟记录
                {% endif %}
                <small class="text-muted ms-2">(超过次月月底未更新)</small>
            </h5>
        </div>
        <div class="card-body">
            {% for severity, items in trend_and_problems.problems.items %}
                {% if items %}
                <div class="card mb-2">
                    <div class="card-header" data-bs-toggle="collapse" data-bs-target="#{{ severity }}-problems" style="cursor: pointer;">
                        <strong>{{ severity|upper }}</strong> ({{ items|length }}条)
                        <i class="fas fa-chevron-down float-end"></i>
                    </div>
                    <div id="{{ severity }}-problems" class="collapse">
                        <div class="card-body p-0">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>业务类型</th>
                                        <th>编号</th>
                                        <th>名称</th>
                                        <th>经办人</th>
                                        <th>业务日期</th>
                                        <th>更新截止日</th>
                                        <th>剩余天数</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in items %}
                                    <tr>
                                        <td>{{ item.module_label }}</td>
                                        <td>{{ item.code }}</td>
                                        <td>{{ item.name }}</td>
                                        <td>{{ item.responsible_person }}</td>
                                        <td>{{ item.business_date|date:"Y-m-d" }}</td>
                                        <td>{{ item.update_deadline|date:"Y-m-d" }}</td>
                                        <td class="{% if item.days_remaining < 0 %}text-danger{% elif item.days_remaining <= 3 %}text-warning{% else %}text-success{% endif %}">
                                            <strong>{{ item.days_remaining }}天</strong>
                                        </td>
                                        <td><a href="{{ item.edit_url }}" class="btn btn-sm btn-link">编辑</a></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- 详情模态框 -->
    {% if target_code and detail_data %}
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{% if view_mode == 'project' %}项目详情{% else %}经办人详情{% endif %} - {{ target_code }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <!-- 业务类型筛选 -->
                    <div class="mb-3">
                        <div class="btn-group" role="group" aria-label="业务类型筛选">
                            <input type="radio" class="btn-check" name="moduleFilter" id="moduleAll" value="all" checked>
                            <label class="btn btn-outline-primary" for="moduleAll">全部</label>
                            
                            <input type="radio" class="btn-check" name="moduleFilter" id="moduleProcurement" value="procurement">
                            <label class="btn btn-outline-primary" for="moduleProcurement">采购</label>
                            
                            <input type="radio" class="btn-check" name="moduleFilter" id="moduleContract" value="contract">
                            <label class="btn btn-outline-primary" for="moduleContract">合同</label>
                            
                            <input type="radio" class="btn-check" name="moduleFilter" id="modulePayment" value="payment">
                            <label class="btn btn-outline-primary" for="modulePayment">付款</label>
                            
                            <input type="radio" class="btn-check" name="moduleFilter" id="moduleSettlement" value="settlement">
                            <label class="btn btn-outline-primary" for="moduleSettlement">结算</label>
                        </div>
                    </div>
                    
                    <!-- 详情概要 -->
                    {% if detail_data.summary %}
                    <div class="row mb-4">
                        <div class="col-md-3 equal-col">
                            <div class="card text-center stats-card overall h-100 w-100">
                                <div class="card-body">
                                    <h6 class="text-muted">综合准时率</h6>
                                    <h2 class="text-success">{{ detail_data.summary.overall_update_rate }}%</h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 equal-col">
                            <div class="card text-center stats-card procurement h-100 w-100">
                                <div class="card-body">
                                    <h6 class="text-muted">采购</h6>
                                    <h4>{{ detail_data.summary.procurement.updated }}/{{ detail_data.summary.procurement.total }}</h4>
                                    
<small class="text-muted">准时率 {{ detail_data.summary.procurement.on_time_rate }}% · 平均{{ detail_data.summary.procurement.avg_days }}天</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 equal-col">
                            <div class="card text-center stats-card contract h-100 w-100">
                                <div class="card-body">
                                    <h6 class="text-muted">合同</h6>
                                    <h4>{{ detail_data.summary.contract.updated }}/{{ detail_data.summary.contract.total }}</h4>
                                    <small class="text-muted">准时率 {{ detail_data.summary.contract.on_time_rate }}% · 平均{{ detail_data.summary.contract.avg_days }}天</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 equal-col">
                            <div class="card text-center stats-card payment h-100 w-100">
                                <div class="card-body">
                                    <h6 class="text-muted">支付</h6>
                                    <h4>{{ detail_data.summary.payment.updated }}/{{ detail_data.summary.payment.total }}</h4>
                                    <small class="text-muted">准时率 {{ detail_data.summary.payment.on_time_rate }}% · 平均{{ detail_data.summary.payment.avg_days }}天</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-12 equal-col">
                            <div class="card text-center stats-card settlement h-100 w-100">
                                <div class="card-body">
                                    <h6 class="text-muted">结算</h6>
                                    <h4>{{ detail_data.summary.settlement.updated }}/{{ detail_data.summary.settlement.total }}</h4>
                                    <small class="text-muted">准时率 {{ detail_data.summary.settlement.on_time_rate }}% · 平均{{ detail_data.summary.settlement.avg_days }}天</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- 趋势图 -->
                    <h6>更新周期趋势</h6>
                    <div id="trendChart" class="mb-4" style="height: 400px;">
                        <div class="alert alert-warning text-center">
                            <i class="fas fa-info-circle"></i> 趋势图功能开发中，敬请期待
                        </div>
                    </div>

                    <!-- 延迟记录明细 -->
                    {% if detail_data.problems %}
                    <h6 class="mt-4">更新记录明细</h6>
                    {% for severity, items in detail_data.problems.items %}
                        {% if items %}
                        <div class="card mb-2 severity-section" data-severity="{{ severity }}">
                            <div class="card-header" data-bs-toggle="collapse" data-bs-target="#detail-{{ severity }}" style="cursor: pointer;">
                                <strong>
                                    {% if severity == 'delayed' %}已延迟
                                    {% elif severity == 'upcoming' %}即将到期
                                    {% elif severity == 'completed' %}已完成
                                    {% else %}{{ severity|upper }}
                                    {% endif %}
                                </strong>
                                <span class="severity-count">({{ items|length }}条)</span>
                                <i class="fas fa-chevron-down float-end"></i>
                            </div>
                            <div id="detail-{{ severity }}" class="collapse {% if severity == 'delayed' %}show{% endif %}">
                                <div class="card-body p-0">
                                    <table class="table table-sm mb-0">
                                        <thead>
                                            <tr>
                                                <th>业务类型</th>
                                                <th>编号</th>
                                                <th>名称</th>
                                                <th>经办人</th>
                                                <th>业务日期</th>
                                                <th>更新截止日</th>
                                                <th>剩余天数</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in items %}
                                            <tr class="problem-row" data-module="{{ item.module }}">
                                                <td>{{ item.module_label }}</td>
                                                <td>{{ item.code }}</td>
                                                <td>{{ item.name }}</td>
                                                <td>{{ item.responsible_person }}</td>
                                                <td>{{ item.business_date|date:"Y-m-d" }}</td>
                                                <td>{{ item.update_deadline|date:"Y-m-d" }}</td>
                                                <td class="{% if item.days_remaining < 0 %}text-danger{% elif item.days_remaining <= 3 %}text-warning{% else %}text-success{% endif %}">
                                                    <strong>{{ item.days_remaining }}天</strong>
                                                </td>
                                                <td><a href="{{ item.edit_url }}" class="btn btn-sm btn-link">编辑</a></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 暂无更新记录数据
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 视图模式切换
    document.querySelectorAll('.view-mode-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const mode = this.dataset.mode;
            const url = new URL(window.location.href);
            url.searchParams.set('view_mode', mode);
            url.searchParams.delete('target_code');  // 切换视图时清除目标选择
            window.location.href = url.toString();
        });
    });

    // 查看详情按钮
    document.querySelectorAll('.view-detail-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const targetCode = this.dataset.target;
            const url = new URL(window.location.href);
            url.searchParams.set('target_code', targetCode);
            window.location.href = url.toString();
        });
    });

    // 详情模态框：自动弹出与URL清理
    {% if target_code %}
    const detailModalEl = document.getElementById('detailModal');
    if (detailModalEl && window.bootstrap) {
        const detailModal = new bootstrap.Modal(detailModalEl);
        detailModal.show();
        detailModalEl.addEventListener('hidden.bs.modal', function() {
            const url = new URL(window.location.href);
            url.searchParams.delete('target_code');
            url.searchParams.delete('show_all');
            history.replaceState({}, '', url.toString());
        });
    }
    {% endif %}

    // 趋势图功能暂时禁用（数据结构需要重新设计）
    {% if target_code and detail_data %}
    // 趋势图数据暂未实现，显示提示信息
    {% endif %}

    // 模态框中的业务类型筛选功能
    {% if target_code and detail_data %}
    const moduleFilterRadios = document.querySelectorAll('input[name="moduleFilter"]');
    moduleFilterRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const selectedModule = this.value;
            filterProblemsByModule(selectedModule);
        });
    });

    function filterProblemsByModule(module) {
        const allRows = document.querySelectorAll('.problem-row');
        const severitySections = document.querySelectorAll('.severity-section');
        
        allRows.forEach(row => {
            if (module === 'all' || row.dataset.module === module) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        // 更新每个严重程度分类的计数
        severitySections.forEach(section => {
            const severity = section.dataset.severity;
            const visibleRows = section.querySelectorAll('.problem-row[style=""], .problem-row:not([style])');
            const countSpan = section.querySelector('.severity-count');
            
            let count = 0;
            visibleRows.forEach(row => {
                if (module === 'all' || row.dataset.module === module) {
                    count++;
                }
            });
            
            if (countSpan) {
                countSpan.textContent = `(${count}条)`;
            }
            
            // 如果该分类没有可见记录，隐藏整个卡片
            if (count === 0) {
                section.style.display = 'none';
            } else {
                section.style.display = '';
            }
        });
    }
    {% endif %}
});
</script>
{% endblock %}