{% extends "base.html" %}
{% load static %}
{% load monitor_filters %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    .view-mode-selector {
        display: inline-flex;
        border-radius: 0.5rem;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        background: white;
    }
    .view-mode-btn {
        padding: 0.625rem 1.75rem;
        border: none;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
        font-size: 0.95rem;
        position: relative;
    }
    .view-mode-btn:not(:last-child)::after {
        content: '';
        position: absolute;
        right: 0;
        top: 50%;
        transform: translateY(-50%);
        height: 60%;
        width: 1px;
        background: #e0e0e0;
    }
    .view-mode-btn:hover {
        background: #f8f9fa;
    }
    .view-mode-btn.active {
        background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
        color: white;
    }
    .view-mode-btn.active::after {
        display: none;
    }
    
    /* 筛选卡片优化 */
    .filter-card {
        border: none;
        box-shadow: 0 2px 12px rgba(0,0,0,0.08);
        border-radius: 0.75rem;
        margin-bottom: 1.75rem;
    }
    .filter-card .card-body {
        padding: 1.75rem 2rem;
    }
    .filter-card .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    .filter-card .form-control,
    .filter-card .form-select {
        border-radius: 0.5rem;
        border: 1px solid #dee2e6;
        padding: 0.625rem 0.875rem;
        transition: all 0.2s;
    }
    .filter-card .form-control:focus,
    .filter-card .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.15);
    }
    .filter-card .btn {
        border-radius: 0.5rem;
        padding: 0.625rem 1.25rem;
        font-weight: 500;
        transition: all 0.2s;
    }
    .filter-card .alert-info {
        background: linear-gradient(135deg, #e7f3ff 0%, #f0f8ff 100%);
        border: 1px solid #b6d4fe;
        border-radius: 0.5rem;
        color: #084298;
        font-size: 0.9rem;
    }
    
    /* 汇总卡片全新设计 */
    .stats-card {
        border: none;
        border-radius: 0.75rem;
        transition: all 0.3s ease;
        height: 100%;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        overflow: hidden;
        position: relative;
    }
    .stats-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--card-color) 0%, var(--card-color-light) 100%);
    }
    .stats-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    }
    .stats-card .card-body {
        padding: 1rem 1.25rem;
        position: relative;
    }
    .stats-card h6 {
        font-size: 0.875rem;
        font-weight: 600;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.75rem;
    }
    .stats-card h2, .stats-card h3 {
        font-weight: 700;
        margin: 0.5rem 0;
        line-height: 1.2;
    }
    .stats-card h2 {
        font-size: 2rem;
    }
    .stats-card h3 {
        font-size: 1.5rem;
    }
    .stats-card small {
        font-size: 0.8rem;
        color: #6c757d;
        font-weight: 500;
    }
    
    /* 各业务类型配色 */
    .stats-card.overall {
        --card-color: #6c757d;
        --card-color-light: #adb5bd;
    }
    .stats-card.overall h2 {
        color: #495057;
    }
    
    .stats-card.procurement {
        --card-color: #0d6efd;
        --card-color-light: #6ea8fe;
    }
    .stats-card.procurement h3 {
        color: #0d6efd;
    }
    
    .stats-card.contract {
        --card-color: #198754;
        --card-color-light: #75b798;
    }
    .stats-card.contract h3 {
        color: #198754;
    }
    
    .stats-card.payment {
        --card-color: #fd7e14;
        --card-color-light: #feb272;
    }
    .stats-card.payment h3 {
        color: #fd7e14;
    }
    
    .stats-card.settlement {
        --card-color: #6f42c1;
        --card-color-light: #a98eda;
    }
    .stats-card.settlement h3 {
        color: #6f42c1;
    }
    
    /* Equal height helpers for cards */
    .equal-col {
        display: flex;
        margin-bottom: 1rem;
        flex: 1 1 0;
        min-width: 0;
    }
    .equal-col .card {
        height: 100%;
        width: 100%;
    }
    
    /* 让卡片容器自适应分布 */
    .stats-row {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .stats-row > .equal-col {
        flex: 1 1 calc(16.666% - 1rem); /* 默认6列布局 */
        min-width: 180px;
    }
    
    .progress { height: 20px; }
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
    .on-time-badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.875rem;
        font-weight: 500;
    }
    .on-time-badge.high {
        background-color: #d1e7dd;
        color: #0f5132;
    }
    .on-time-badge.medium {
        background-color: #fff3cd;
        color: #664d03;
    }
    .on-time-badge.low {
        background-color: #f8d7da;
        color: #842029;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- 页面标题和视图切换 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">{{ page_title }}</h2>
        <div class="view-mode-selector">
            <button type="button" class="view-mode-btn {% if view_mode == 'project' %}active{% endif %}" data-mode="project">
                <i class="fas fa-project-diagram"></i> 项目视图
            </button>
            <button type="button" class="view-mode-btn {% if view_mode == 'person' %}active{% endif %}" data-mode="person">
                <i class="fas fa-user"></i> 个人视图
            </button>
        </div>
    </div>

    <!-- 筛选条件 -->
    <div class="card filter-card">
        <div class="card-body">
            <form method="get" class="row g-4 align-items-end">
                <!-- 保留现有参数 -->
                <input type="hidden" name="view_mode" value="{{ view_mode }}">
                {% if filter_config.selected_year_value %}
                <input type="hidden" name="year" value="{{ filter_config.selected_year_value }}">
                {% endif %}
                {% if filter_config.selected_project_value %}
                <input type="hidden" name="project" value="{{ filter_config.selected_project_value }}">
                {% endif %}
                
                <!-- 起始日期选择器 -->
                <div class="col-md-3">
                    <label for="start_date" class="form-label">
                        <i class="fas fa-calendar-alt me-1"></i> 业务起始日期
                    </label>
                    <input type="date" class="form-control" id="start_date" name="start_date"
                           value="{{ start_date|default:'2025-10-01' }}"
                           title="只统计该日期之后的业务数据">
                </div>

                <!-- 业务类型筛选 -->
                <div class="col-md-3">
                    <label for="module" class="form-label">
                        <i class="fas fa-layer-group me-1"></i> 业务类型
                    </label>
                    <select id="module" name="module" class="form-select">
                        <option value="all"{% if module_filter == 'all' or not module_filter %} selected{% endif %}>全部业务</option>
                        <option value="procurement"{% if module_filter == 'procurement' %} selected{% endif %}>采购</option>
                        <option value="contract"{% if module_filter == 'contract' %} selected{% endif %}>合同</option>
                        <option value="payment"{% if module_filter == 'payment' %} selected{% endif %}>付款</option>
                        <option value="settlement"{% if module_filter == 'settlement' %} selected{% endif %}>结算</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary me-2">
                        <i class="fas fa-search me-1"></i> 应用筛选
                    </button>
                    {% if start_date %}
                    <a href="?view_mode={{ view_mode }}{% if filter_config.selected_year_value %}&year={{ filter_config.selected_year_value }}{% endif %}{% if filter_config.selected_project_value %}&project={{ filter_config.selected_project_value }}{% endif %}"
                       class="btn btn-outline-secondary">
                        <i class="fas fa-redo me-1"></i> 重置
                    </a>
                    {% endif %}
                </div>

                <div class="col-md-4">
                    <div class="alert alert-info mb-0">
                        <i class="fas fa-info-circle"></i>
                        当前筛选：{{ filter_config.display_year|default:"全部年度" }}
                        {% if filter_config.selected_project_value %} · {{ filter_config.selected_project_value }}{% else %} · 全部项目{% endif %}
                        {% if start_date %} · 起始日期：{{ start_date }}{% endif %}
                        {% if module_filter and module_filter != 'all' %}
                            · 业务类型：
                            {% if module_filter == 'procurement' %}采购{% elif module_filter == 'contract' %}合同{% elif module_filter == 'payment' %}付款{% elif module_filter == 'settlement' %}结算{% endif %}
                        {% else %}
                            · 所有业务
                        {% endif %}
                        <span class="ms-3">准时规则：业务发生次月月底前更新</span>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- 汇总统计卡片 -->
    {% if overview_data %}
    <div class="stats-row">
        <div class="equal-col">
            <div class="card text-center stats-card overall h-100 w-100">
                <div class="card-body">
                    <h6>{% if view_mode == 'project' %}项目总数{% else %}经办人数{% endif %}</h6>
                    <h2>
                        {% if view_mode == 'project' %}
                            {{ overview_data.summary.project_count }}
                        {% else %}
                            {{ overview_data.summary.person_count }}
                        {% endif %}
                    </h2>
                </div>
            </div>
        </div>
        {% if module_filter == 'all' or not module_filter or module_filter == 'procurement' %}
        <div class="equal-col">
            <div class="card text-center stats-card procurement h-100 w-100">
                <div class="card-body">
                    <h6>采购情况</h6>
                    <h3>{{ overview_data.summary.procurement_stats.updated }}/{{ overview_data.summary.procurement_stats.total }}</h3>
                    <small>已更新/总数</small>
                </div>
            </div>
        </div>
        {% endif %}
        {% if module_filter == 'all' or not module_filter or module_filter == 'contract' %}
        <div class="equal-col">
            <div class="card text-center stats-card contract h-100 w-100">
                <div class="card-body">
                    <h6>合同情况</h6>
                    <h3>{{ overview_data.summary.contract_stats.updated }}/{{ overview_data.summary.contract_stats.total }}</h3>
                    <small>已更新/总数</small>
                </div>
            </div>
        </div>
        {% endif %}
        {% if module_filter == 'all' or not module_filter or module_filter == 'payment' %}
        <div class="equal-col">
            <div class="card text-center stats-card payment h-100 w-100">
                <div class="card-body">
                    <h6>支付情况</h6>
                    <h3>{{ overview_data.summary.payment_stats.updated }}/{{ overview_data.summary.payment_stats.total }}</h3>
                    <small>已更新/总数</small>
                </div>
            </div>
        </div>
        {% endif %}
        {% if module_filter == 'all' or not module_filter or module_filter == 'settlement' %}
        <div class="equal-col">
            <div class="card text-center stats-card settlement h-100 w-100">
                <div class="card-body">
                    <h6>结算情况</h6>
                    <h3>{{ overview_data.summary.settlement_stats.updated }}/{{ overview_data.summary.settlement_stats.total }}</h3>
                    <small>已更新/总数</small>
                </div>
            </div>
        </div>
        {% endif %}
        <div class="equal-col">
            <div class="card text-center stats-card overall h-100 w-100">
                <div class="card-body">
                    <h6>综合准时率</h6>
                    <h2 class="text-success">{{ overview_data.summary.overall_on_time_rate }}%</h2>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 数据列表表格 -->
    {% if overview_data %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                {% if view_mode == 'project' %}项目更新统计明细{% else %}经办人更新统计明细{% endif %}
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>{% if view_mode == 'project' %}项目名称{% else %}经办人{% endif %}</th>
                            {% if module_filter == 'all' or not module_filter or module_filter == 'procurement' %}
                            <th>采购</th>
                            <th>采购准时率</th>
                            {% endif %}
                            {% if module_filter == 'all' or not module_filter or module_filter == 'contract' %}
                            <th>合同</th>
                            <th>合同准时率</th>
                            {% endif %}
                            {% if module_filter == 'all' or not module_filter or module_filter == 'payment' %}
                            <th>支付</th>
                            <th>支付准时率</th>
                            {% endif %}
                            {% if module_filter == 'all' or not module_filter or module_filter == 'settlement' %}
                            <th>结算</th>
                            <th>结算准时率</th>
                            {% endif %}
                            <th>综合准时率</th>
                            {% if view_mode == 'person' %}<th>负责项目</th>{% endif %}
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if view_mode == 'project' %}
                            {% for project in overview_data.projects %}
                            <tr>
                                <td><strong>{{ project.project_code }}</strong><br><small>{{ project.project_name }}</small></td>
                                {% if module_filter == 'all' or not module_filter or module_filter == 'procurement' %}
                                <td>{{ project.procurement_updated }}/{{ project.procurement_count }}<br><small class="text-muted">{{ project.procurement_avg_days }}天</small></td>
                                <td>
                                    <span class="on-time-badge {% if project.procurement_on_time_rate >= 90 %}high{% elif project.procurement_on_time_rate >= 70 %}medium{% else %}low{% endif %}">
                                        {{ project.procurement_on_time_rate }}%
                                    </span>
                                </td>
                                {% endif %}
                                {% if module_filter == 'all' or not module_filter or module_filter == 'contract' %}
                                <td>{{ project.contract_updated }}/{{ project.contract_count }}<br><small class="text-muted">{{ project.contract_avg_days }}天</small></td>
                                <td>
                                    <span class="on-time-badge {% if project.contract_on_time_rate >= 90 %}high{% elif project.contract_on_time_rate >= 70 %}medium{% else %}low{% endif %}">
                                        {{ project.contract_on_time_rate }}%
                                    </span>
                                </td>
                                {% endif %}
                                {% if module_filter == 'all' or not module_filter or module_filter == 'payment' %}
                                <td>{{ project.payment_updated }}/{{ project.payment_count }}<br><small class="text-muted">{{ project.payment_avg_days }}天</small></td>
                                <td>
                                    <span class="on-time-badge {% if project.payment_on_time_rate >= 90 %}high{% elif project.payment_on_time_rate >= 70 %}medium{% else %}low{% endif %}">
                                        {{ project.payment_on_time_rate }}%
                                    </span>
                                </td>
                                {% endif %}
                                {% if module_filter == 'all' or not module_filter or module_filter == 'settlement' %}
                                <td>{{ project.settlement_updated }}/{{ project.settlement_count }}<br><small class="text-muted">{{ project.settlement_avg_days }}天</small></td>
                                <td>
                                    <span class="on-time-badge {% if project.settlement_on_time_rate >= 90 %}high{% elif project.settlement_on_time_rate >= 70 %}medium{% else %}low{% endif %}">
                                        {{ project.settlement_on_time_rate }}%
                                    </span>
                                </td>
                                {% endif %}
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar {% if project.overall_on_time_rate >= 90 %}bg-success{% elif project.overall_on_time_rate >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                             role="progressbar" style="width: {{ project.overall_on_time_rate }}%" 
                                             aria-valuenow="{{ project.overall_on_time_rate }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ project.overall_on_time_rate }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-primary view-detail-btn" data-target="{{ project.project_code }}">
                                        <i class="fas fa-eye"></i> 查看详情
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            {% for person in overview_data.persons %}
                            <tr>
                                <td><strong>{{ person.person_name }}</strong></td>
                                {% if module_filter == 'all' or not module_filter or module_filter == 'procurement' %}
                                <td>{{ person.procurement_updated }}/{{ person.procurement_count }}<br><small class="text-muted">{{ person.procurement_avg_days }}天</small></td>
                                <td>
                                    <span class="on-time-badge {% if person.procurement_on_time_rate >= 90 %}high{% elif person.procurement_on_time_rate >= 70 %}medium{% else %}low{% endif %}">
                                        {{ person.procurement_on_time_rate }}%
                                    </span>
                                </td>
                                {% endif %}
                                {% if module_filter == 'all' or not module_filter or module_filter == 'contract' %}
                                <td>{{ person.contract_updated }}/{{ person.contract_count }}<br><small class="text-muted">{{ person.contract_avg_days }}天</small></td>
                                <td>
                                    <span class="on-time-badge {% if person.contract_on_time_rate >= 90 %}high{% elif person.contract_on_time_rate >= 70 %}medium{% else %}low{% endif %}">
                                        {{ person.contract_on_time_rate }}%
                                    </span>
                                </td>
                                {% endif %}
                                {% if module_filter == 'all' or not module_filter or module_filter == 'payment' %}
                                <td>{{ person.payment_updated }}/{{ person.payment_count }}<br><small class="text-muted">{{ person.payment_avg_days }}天</small></td>
                                <td>
                                    <span class="on-time-badge {% if person.payment_on_time_rate >= 90 %}high{% elif person.payment_on_time_rate >= 70 %}medium{% else %}low{% endif %}">
                                        {{ person.payment_on_time_rate }}%
                                    </span>
                                </td>
                                {% endif %}
                                {% if module_filter == 'all' or not module_filter or module_filter == 'settlement' %}
                                <td>{{ person.settlement_updated }}/{{ person.settlement_count }}<br><small class="text-muted">{{ person.settlement_avg_days }}天</small></td>
                                <td>
                                    <span class="on-time-badge {% if person.settlement_on_time_rate >= 90 %}high{% elif person.settlement_on_time_rate >= 70 %}medium{% else %}low{% endif %}">
                                        {{ person.settlement_on_time_rate }}%
                                    </span>
                                </td>
                                {% endif %}
                                <td>
                                    <div class="progress">
                                        <div class="progress-bar {% if person.overall_on_time_rate >= 90 %}bg-success{% elif person.overall_on_time_rate >= 70 %}bg-warning{% else %}bg-danger{% endif %}" 
                                             role="progressbar" style="width: {{ person.overall_on_time_rate }}%"
                                             aria-valuenow="{{ person.overall_on_time_rate }}" aria-valuemin="0" aria-valuemax="100">
                                            {{ person.overall_on_time_rate }}%
                                        </div>
                                    </div>
                                </td>
                                <td>{{ person.project_count }}个</td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-primary view-detail-btn" data-target="{{ person.person_name }}">
                                        <i class="fas fa-eye"></i> 查看详情
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 延迟记录列表 -->
    {% if trend_and_problems %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-chart-line"></i>
                {% if view_mode == 'project' %}
                    
                {% else %}
                    
                {% endif %}
            </h5>
        </div>
        <div class="card-body">
            <div id="mainTrendChart" style="height: 400px;"></div>
        </div>
    </div>
    {% endif %}

    {% if trend_and_problems and trend_and_problems.problems %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-exclamation-triangle"></i> 
                {% if view_mode == 'project' %}
                    {% if filter_config.selected_project_value %}本项目延迟记录{% else %}所有项目延迟记录{% endif %}
                {% else %}
                    所有经办人延迟记录
                {% endif %}
                <small class="text-muted ms-2">(超过次月月底未更新)</small>
            </h5>
        </div>
        <div class="card-body">
            {% for severity, items in trend_and_problems.problems.items %}
                {% if items %}
                <div class="card mb-2">
                    <div id="{{ severity }}-problems" class="collapse show">
                        <div class="card-body p-0">
                            <table class="table table-sm mb-0">
                                <thead>
                                    <tr>
                                        <th>业务类型</th>
                                        <th>编号</th>
                                        <th>名称</th>
                                        <th>经办人</th>
                                        <th>业务日期</th>
                                        <th>更新截止日</th>
                                        <th>剩余天数</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in items %}
                                    <tr>
                                        <td>{{ item.module_label }}</td>
                                        <td>{{ item.code }}</td>
                                        <td>{{ item.name }}</td>
                                        <td>{{ item.responsible_person }}</td>
                                        <td>{{ item.business_date|date:"Y-m-d" }}</td>
                                        <td>{{ item.update_deadline|date:"Y-m-d" }}</td>
                                        <td class="{% if item.days_remaining < 0 %}text-danger{% elif item.days_remaining <= 3 %}text-warning{% else %}text-success{% endif %}">
                                            <strong>{{ item.days_remaining }}天</strong>
                                        </td>
                                        <td><a href="{{ item.edit_url }}" class="btn btn-sm btn-link">编辑</a></td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- 详情模态框 -->
    {% if target_code and detail_data %}
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{% if view_mode == 'project' %}项目详情{% else %}经办人详情{% endif %} - {{ target_code }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <!-- 业务类型筛选 -->
                    <div class="mb-3">
                        <div class="btn-group" role="group" aria-label="业务类型筛选">
                            <input type="radio" class="btn-check" name="moduleFilter" id="moduleAll" value="all" checked>
                            <label class="btn btn-outline-primary" for="moduleAll">全部</label>
                            
                            <input type="radio" class="btn-check" name="moduleFilter" id="moduleProcurement" value="procurement">
                            <label class="btn btn-outline-primary" for="moduleProcurement">采购</label>
                            
                            <input type="radio" class="btn-check" name="moduleFilter" id="moduleContract" value="contract">
                            <label class="btn btn-outline-primary" for="moduleContract">合同</label>
                            
                            <input type="radio" class="btn-check" name="moduleFilter" id="modulePayment" value="payment">
                            <label class="btn btn-outline-primary" for="modulePayment">付款</label>
                            
                            <input type="radio" class="btn-check" name="moduleFilter" id="moduleSettlement" value="settlement">
                            <label class="btn btn-outline-primary" for="moduleSettlement">结算</label>
                        </div>
                    </div>
                    
                    <!-- 详情概要 -->
                    {% if detail_data.summary %}
                    <div class="row mb-4">
                        <div class="col-md-4 equal-col">
                            <div class="card text-center stats-card overall h-100 w-100">
                                <div class="card-body">
                                    <h6 class="text-muted">综合准时率</h6>
                                    <h2 class="text-success">{{ detail_data.summary.overall_update_rate }}%</h2>
                                </div>
                            </div>
                        </div>
                        {% if module_filter == 'all' or not module_filter or module_filter == 'procurement' %}
                        <div class="col-md-4 equal-col">
                            <div class="card text-center stats-card procurement h-100 w-100">
                                <div class="card-body">
                                    <h6 class="text-muted">采购</h6>
                                    <h4>{{ detail_data.summary.procurement.updated }}/{{ detail_data.summary.procurement.total }}</h4>
                                    <small class="text-muted">准时率 {{ detail_data.summary.procurement.on_time_rate }}% · 平均{{ detail_data.summary.procurement.avg_days }}天</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% if module_filter == 'all' or not module_filter or module_filter == 'contract' %}
                        <div class="col-md-4 equal-col">
                            <div class="card text-center stats-card contract h-100 w-100">
                                <div class="card-body">
                                    <h6 class="text-muted">合同</h6>
                                    <h4>{{ detail_data.summary.contract.updated }}/{{ detail_data.summary.contract.total }}</h4>
                                    <small class="text-muted">准时率 {{ detail_data.summary.contract.on_time_rate }}% · 平均{{ detail_data.summary.contract.avg_days }}天</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% if module_filter == 'all' or not module_filter or module_filter == 'payment' %}
                        <div class="col-md-4 equal-col">
                            <div class="card text-center stats-card payment h-100 w-100">
                                <div class="card-body">
                                    <h6 class="text-muted">支付</h6>
                                    <h4>{{ detail_data.summary.payment.updated }}/{{ detail_data.summary.payment.total }}</h4>
                                    <small class="text-muted">准时率 {{ detail_data.summary.payment.on_time_rate }}% · 平均{{ detail_data.summary.payment.avg_days }}天</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% if module_filter == 'all' or not module_filter or module_filter == 'settlement' %}
                        <div class="col-md-4 equal-col">
                            <div class="card text-center stats-card settlement h-100 w-100">
                                <div class="card-body">
                                    <h6 class="text-muted">结算</h6>
                                    <h4>{{ detail_data.summary.settlement.updated }}/{{ detail_data.summary.settlement.total }}</h4>
                                    <small class="text-muted">准时率 {{ detail_data.summary.settlement.on_time_rate }}% · 平均{{ detail_data.summary.settlement.avg_days }}天</small>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <!-- 趋势图 -->
                    <h6>更新周期趋势</h6>
                    <div id="trendChart" class="mb-4" style="height: 400px;">
                        <div class="alert alert-warning text-center">
                            <i class="fas fa-info-circle"></i> 趋势图功能开发中，敬请期待
                        </div>
                    </div>

                    <!-- 延迟记录明细 -->
                    {% if detail_data.problems %}
                    <h6 class="mt-4">更新记录明细</h6>
                    {% for severity, items in detail_data.problems.items %}
                        {% if items %}
                        <div class="card mb-2 severity-section" data-severity="{{ severity }}">
                            <div id="detail-{{ severity }}" class="collapse show">
                                <div class="card-body p-0">
                                    <table class="table table-sm mb-0">
                                        <thead>
                                            <tr>
                                                <th>业务类型</th>
                                                <th>编号</th>
                                                <th>名称</th>
                                                <th>经办人</th>
                                                <th>业务日期</th>
                                                <th>更新截止日</th>
                                                <th>剩余天数</th>
                                                <th>操作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for item in items %}
                                            <tr class="problem-row" data-module="{{ item.module }}">
                                                <td>{{ item.module_label }}</td>
                                                <td>{{ item.code }}</td>
                                                <td>{{ item.name }}</td>
                                                <td>{{ item.responsible_person }}</td>
                                                <td>{{ item.business_date|date:"Y-m-d" }}</td>
                                                <td>{{ item.update_deadline|date:"Y-m-d" }}</td>
                                                <td class="{% if item.days_remaining < 0 %}text-danger{% elif item.days_remaining <= 3 %}text-warning{% else %}text-success{% endif %}">
                                                    <strong>{{ item.days_remaining }}天</strong>
                                                </td>
                                                <td><a href="{{ item.edit_url }}" class="btn btn-sm btn-link">编辑</a></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% endfor %}
                    {% else %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 暂无更新记录数据
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/scatter-chart-optimizer.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const STORAGE_KEY = 'update_monitor_filters';
    
    // 从localStorage加载筛选条件
    function loadFiltersFromStorage() {
        try {
            const stored = localStorage.getItem(STORAGE_KEY);
            return stored ? JSON.parse(stored) : {};
        } catch (e) {
            console.error('Failed to load filters from storage:', e);
            return {};
        }
    }
    
    // 保存筛选条件到localStorage
    function saveFiltersToStorage(filters) {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(filters));
        } catch (e) {
            console.error('Failed to save filters to storage:', e);
        }
    }
    
    // 获取当前筛选参数（优先从URL，其次从localStorage）
    function getCurrentFilters() {
        const url = new URL(window.location.href);
        const urlStartDate = url.searchParams.get('start_date');
        const urlModule = url.searchParams.get('module');
        
        // 如果URL中有参数，使用URL参数并保存到localStorage
        if (urlStartDate || urlModule) {
            const filters = {
                start_date: urlStartDate,
                module: urlModule
            };
            saveFiltersToStorage(filters);
            return filters;
        }
        
        // 否则从localStorage加载
        return loadFiltersFromStorage();
    }
    
    // 应用筛选参数到URL
    function applyFiltersToUrl(url, filters) {
        if (filters.start_date) {
            url.searchParams.set('start_date', filters.start_date);
        }
        if (filters.module && filters.module !== 'all') {
            url.searchParams.set('module', filters.module);
        }
        return url;
    }
    
    // 页面加载时，如果URL中没有筛选参数但localStorage有，则自动应用
    function initializeFilters() {
        const url = new URL(window.location.href);
        const hasUrlFilters = url.searchParams.has('start_date') || url.searchParams.has('module');
        
        if (!hasUrlFilters) {
            const storedFilters = loadFiltersFromStorage();
            if (storedFilters.start_date || storedFilters.module) {
                applyFiltersToUrl(url, storedFilters);
                // 使用 replaceState 避免在浏览器历史中添加新记录
                window.history.replaceState({}, '', url.toString());
                // 重新加载页面以应用筛选
                window.location.reload();
            }
        }
    }
    
    // 初始化筛选条件
    initializeFilters();
    
    // 视图模式切换
    document.querySelectorAll('.view-mode-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const mode = this.dataset.mode;
            const url = new URL(window.location.href);
            const filters = getCurrentFilters();
            
            url.searchParams.set('view_mode', mode);
            url.searchParams.delete('target_code');  // 切换视图时清除目标选择
            
            // 保留筛选条件
            applyFiltersToUrl(url, filters);
            
            window.location.href = url.toString();
        });
    });

    // 查看详情按钮
    document.querySelectorAll('.view-detail-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const targetCode = this.dataset.target;
            const url = new URL(window.location.href);
            const filters = getCurrentFilters();
            
            url.searchParams.set('target_code', targetCode);
            
            // 保留筛选条件
            applyFiltersToUrl(url, filters);
            
            window.location.href = url.toString();
        });
    });

    // 详情模态框：自动弹出与URL清理
    {% if target_code %}
    const detailModalEl = document.getElementById('detailModal');
    if (detailModalEl && window.bootstrap) {
        const detailModal = new bootstrap.Modal(detailModalEl);
        detailModal.show();
        detailModalEl.addEventListener('hidden.bs.modal', function() {
            const url = new URL(window.location.href);
            const filters = getCurrentFilters();
            
            url.searchParams.delete('target_code');
            url.searchParams.delete('show_all');
            
            // 保留筛选条件
            applyFiltersToUrl(url, filters);
            
            history.replaceState({}, '', url.toString());
        });
    }
    {% endif %}
    
    // 监听表单提交，保存筛选条件
    const filterForm = document.querySelector('form[method="get"]');
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            const startDate = document.getElementById('start_date').value;
            const module = document.getElementById('module').value;
            
            // 保存到localStorage
            saveFiltersToStorage({
                start_date: startDate,
                module: module
            });
        });
    }

    // 趋势图功能暂时禁用（数据结构需要重新设计）
    {% if target_code and detail_data %}
    // 趋势图数据暂未实现，显示提示信息
    {% endif %}

    // 模态框中的业务类型筛选功能
    {% if target_code and detail_data %}
    const moduleFilterRadios = document.querySelectorAll('input[name="moduleFilter"]');
    moduleFilterRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            const selectedModule = this.value;
            filterProblemsByModule(selectedModule);
        });
    });

    function filterProblemsByModule(module) {
        const allRows = document.querySelectorAll('.problem-row');
        const severitySections = document.querySelectorAll('.severity-section');
        
        allRows.forEach(row => {
            if (module === 'all' || row.dataset.module === module) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
        
        // 更新每个严重程度分类的计数
        severitySections.forEach(section => {
            const severity = section.dataset.severity;
            const visibleRows = section.querySelectorAll('.problem-row[style=""], .problem-row:not([style])');
            const countSpan = section.querySelector('.severity-count');
            
            let count = 0;
            visibleRows.forEach(row => {
                if (module === 'all' || row.dataset.module === module) {
                    count++;
                }
            });
            
            if (countSpan) {
                countSpan.textContent = `(${count}条)`;
            }
            
            // 如果该分类没有可见记录，隐藏整个卡片
            if (count === 0) {
                section.style.display = 'none';
            } else {
                section.style.display = '';
            }
        });
    }
    {% endif %}
});
</script>

<script>
// 更新监控趋势图（主页面 + 详情模态框）
document.addEventListener('DOMContentLoaded', function () {
    const detailTrendData = {{ trend_data_json|safe }};
    const detailScatterData = {{ detail_scatter_json|safe }};
    const mainTrendData = {{ main_trend_json|safe }};
    const detailModalEl = document.getElementById('detailModal');
    const globalYearValue = '{{ filter_config.selected_year_value }}';

    function buildTrendLabels(trend) {
        const labelSet = new Set();
        ['procurement', 'contract', 'payment', 'settlement'].forEach(key => {
            (trend[key] || []).forEach(item => {
                if (item.count > 0) {
                    labelSet.add(item.period);
                }
            });
        });

        const labels = Array.from(labelSet);
        if (!labels.length) {
            return [];
        }

        if (labels.some(lbl => lbl.includes('月') && !lbl.includes('上半年') && !lbl.includes('下半年'))) {
            return labels.sort((a, b) => {
                const aMonth = parseInt(a.replace('月', ''), 10);
                const bMonth = parseInt(b.replace('月', ''), 10);
                return aMonth - bMonth;
            });
        }

        return labels.sort((a, b) => {
            const parse = (lbl) => {
                const year = parseInt(lbl, 10);
                const half = lbl.includes('上半年') ? 1 : (lbl.includes('下半年') ? 2 : 9);
                return [year, half];
            };
            const [ay, ah] = parse(a);
            const [by, bh] = parse(b);
            return ay === by ? ah - bh : ay - bh;
        });
    }

    function buildModuleSeries(labels, trend, key, name, color) {
        const series = trend[key] || [];
        return {
            name,
            data: labels.map(label => {
                const item = series.find(d => d.period === label);
                return item && item.count > 0 ? item.avg_cycle : null;
            }),
            color,
        };
    }

    // 详情模态框：使用散点图展示每条业务的实际更新时间
    function renderDetailTrend() {
        const scatter = detailScatterData || {};
        const el = document.getElementById('trendChart');
        if (!el) return;

        const modules = ['procurement', 'contract', 'payment', 'settlement'];
        const moduleLabels = {
            procurement: '采购',
            contract: '合同',
            payment: '付款',
            settlement: '结算',
        };

        const chartSeries = [];
        const allPoints = [];

        modules.forEach(key => {
            const rawPoints = scatter[key] || [];
            if (!Array.isArray(rawPoints) || !rawPoints.length) return;

            const data = rawPoints.map(p => ({
                x: new Date(p.date).getTime(),
                y: p.cycle_days,
                code: p.code,
                name: p.name,
                person: p.person,
            }));

            chartSeries.push({
                name: moduleLabels[key] || key,
                type: 'scatter',
                data,
            });

            allPoints.push(...data);
        });

        if (!allPoints.length) {
            el.innerHTML = '<div class="alert alert-info text-center">暂无趋势数据</div>';
            return;
        }

        // 使用优化器生成配置
        const config = window.ScatterChartOptimizer.generateOptimizedScatterConfig({
            seriesData: chartSeries,
            title: '更新周期散点分布图',
            yAxisTitle: '更新周期（天）',
            baselineValue: null,
            baselineName: null,
            containerWidth: el.offsetWidth,
            enableInteraction: true
        });
        
        // 增强散点的可交互性
        config.markers.size = chartSeries.map(s => s.type === 'scatter' ? 8 : 0);
        config.markers.hover = {
            size: chartSeries.map(s => s.type === 'scatter' ? 14 : 0),
            sizeOffset: 6
        };
        config.markers.strokeWidth = 2;
        config.markers.strokeOpacity = 0.9;
        config.markers.fillOpacity = 0.9;

        // 计算X轴范围
        const allX = allPoints.map(p => p.x);
        let axisMin = Math.min(...allX);
        let axisMax = Math.max(...allX);
        const minDate = new Date(axisMin);
        const maxDate = new Date(axisMax);

        const isAllYears = !globalYearValue || globalYearValue === 'all';
        if (isAllYears) {
            const startYear = minDate.getFullYear();
            const endYear = maxDate.getFullYear();
            axisMin = new Date(startYear, 0, 1).getTime();
            axisMax = new Date(endYear, 11, 31).getTime();
            const yearSpan = endYear - startYear + 1;
            config.xaxis.min = axisMin;
            config.xaxis.max = axisMax;
            config.xaxis.tickAmount = yearSpan * 2 + 1;
        } else {
            const yearInt = parseInt(globalYearValue, 10);
            if (!isNaN(yearInt)) {
                axisMin = new Date(yearInt, 0, 1).getTime();
                axisMax = new Date(yearInt, 11, 31).getTime();
                config.xaxis.min = axisMin;
                config.xaxis.max = axisMax;
                config.xaxis.tickAmount = 12;
            }
        }

        // 添加业务类型的基准线
        const baselineDefs = [
            {key: 'procurement', value: {{ detail_data.summary.procurement.avg_days|default:0 }}, color: '#0d6efd'},
            {key: 'contract', value: {{ detail_data.summary.contract.avg_days|default:0 }}, color: '#198754'},
            {key: 'payment', value: {{ detail_data.summary.payment.avg_days|default:0 }}, color: '#fd7e14'},
            {key: 'settlement', value: {{ detail_data.summary.settlement.avg_days|default:0 }}, color: '#6f42c1'},
        ];

        baselineDefs.forEach(b => {
            if (!b.value || isNaN(b.value)) return;
            config.series.push({
                name: `${moduleLabels[b.key]}平均（${b.value}天）`,
                type: 'line',
                data: [{x: axisMin, y: b.value}, {x: axisMax, y: b.value}],
                color: b.color,
            });
        });

        // 渲染图表
        el.innerHTML = '';
        const chart = new ApexCharts(el, config);
        chart.render();

        // 启用响应式
        window.ScatterChartOptimizer.makeChartResponsive(chart, {
            seriesData: config.series,
            title: '更新周期散点分布图',
            yAxisTitle: '更新周期（天）'
        });
    }

    function renderMainTrend() {
        const trend = mainTrendData || {};
        const modules = ['procurement', 'contract', 'payment', 'settlement'];
        const el = document.getElementById('mainTrendChart');
        if (!el) return;

        const hasAnyData = modules.some(key => Array.isArray(trend[key]) && trend[key].length);
        if (!hasAnyData) {
            el.innerHTML = '<div class="alert alert-info text-center">暂无趋势数据</div>';
            return;
        }

        const labels = buildTrendLabels(trend);
        if (!labels.length) {
            el.innerHTML = '<div class="alert alert-info text-center">暂无趋势数据</div>';
            return;
        }

        const chartSeries = [
            buildModuleSeries(labels, trend, 'procurement', '采购', '#0d6efd'),
            buildModuleSeries(labels, trend, 'contract', '合同', '#198754'),
            buildModuleSeries(labels, trend, 'payment', '付款', '#fd7e14'),
            buildModuleSeries(labels, trend, 'settlement', '结算', '#6f42c1'),
        ];

        const options = {
            chart: { type: 'line', height: 400, toolbar: { show: true } },
            series: chartSeries,
            xaxis: { categories: labels, title: { text: '时间分段' } },
            yaxis: {
                title: { text: '平均更新时长（天）' },
                labels: {
                    formatter: function (value) {
                        return value ? Math.round(value) : '';
                    },
                },
            },
            title: {
                text: '整体更新周期趋势',
                align: 'left',
                style: { fontSize: '16px', fontWeight: 600 },
            },
            stroke: { curve: 'smooth', width: 3 },
            markers: { size: 5 },
            dataLabels: { enabled: false },
            legend: { show: true, position: 'top', horizontalAlign: 'right' },
            tooltip: {
                enabled: true,
                shared: true,
                intersect: false,
                y: {
                    formatter: function (value) {
                        return value !== null && value !== undefined ? Math.round(value) + '天' : '无数据';
                    },
                },
            },
            colors: chartSeries.map(s => s.color),
            grid: { borderColor: '#e7e7e7', strokeDashArray: 4 },
        };

        el.innerHTML = '';
        const chart = new ApexCharts(el, options);
        chart.render();
    }

    function waitForApexCharts(callback, maxWait = 5000) {
        const startTime = Date.now();
        const checkInterval = setInterval(function () {
            if (typeof ApexCharts !== 'undefined') {
                clearInterval(checkInterval);
                callback();
            } else if (Date.now() - startTime > maxWait) {
                clearInterval(checkInterval);
                console.error('ApexCharts 加载超时');
            }
        }, 100);
    }

    // 详情模态框打开时渲染趋势图（等待 ApexCharts 加载完成）
    {% if target_code and detail_data %}
    if (detailModalEl) {
        detailModalEl.addEventListener('shown.bs.modal', function () {
            waitForApexCharts(function() {
                renderDetailTrend();
            });
        });
    }
    {% endif %}

    // 主页面趋势图（等待 ApexCharts 加载完成）
    if (document.getElementById('mainTrendChart')) {
        waitForApexCharts(function() {
            renderMainTrend();
        });
    }
});
</script>
{% endblock %}
