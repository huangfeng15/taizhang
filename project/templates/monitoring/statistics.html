{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }} - 项目采购与成本管理系统{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/monitoring.css' %}">
<style>
.stat-nav {
    margin-bottom: 20px;
}
.stat-nav .btn-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
.stat-card {
    background: white;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.stat-card h3 {
    font-size: 1.2rem;
    margin-bottom: 15px;
    color: #333;
    border-bottom: 2px solid #007bff;
    padding-bottom: 10px;
}
.stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}
.stat-item {
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 4px solid #007bff;
}
.stat-item .label {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 5px;
}
.stat-item .value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
}
.stat-item .value.success {
    color: #28a745;
}
.stat-item .value.warning {
    color: #ffc107;
}
.stat-item .value.danger {
    color: #dc3545;
}
.chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 20px;
}
.chart-container canvas {
    max-height: 300px;
}
.year-selector {
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}
.comparison-selector {
    margin-bottom: 20px;
}
.comparison-selector label {
    margin-right: 10px;
}
.table-responsive {
    margin-top: 15px;
}
</style>
{% endblock %}

{% block content %}
<div class="monitoring-statistics">
    <div class="page-header">
        <h1><i class="fas fa-chart-bar"></i> {{ page_title }}</h1>
        <p class="text-muted">查看采购、合同、付款、结算的统计分析数据</p>
    </div>

    <!-- 统计类型切换 -->
    <div class="stat-nav">
        <div class="btn-group" role="group">
            <a href="?type=overview&year={{ selected_year }}" class="btn btn-sm {% if stat_type == 'overview' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="fas fa-tachometer-alt"></i> 综合概览
            </a>
            <a href="?type=procurement&year={{ selected_year }}" class="btn btn-sm {% if stat_type == 'procurement' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="fas fa-shopping-cart"></i> 采购统计
            </a>
            <a href="?type=contract&year={{ selected_year }}" class="btn btn-sm {% if stat_type == 'contract' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="fas fa-file-contract"></i> 合同统计
            </a>
            <a href="?type=payment&year={{ selected_year }}" class="btn btn-sm {% if stat_type == 'payment' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="fas fa-money-bill-wave"></i> 付款统计
            </a>
            <a href="?type=settlement&year={{ selected_year }}" class="btn btn-sm {% if stat_type == 'settlement' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="fas fa-calculator"></i> 结算统计
            </a>
            <a href="?type=comparison" class="btn btn-sm {% if stat_type == 'comparison' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="fas fa-chart-line"></i> 年度对比
            </a>
        </div>
    </div>

    <!-- 年份选择器（年度对比时不显示） -->
    {% if stat_type != 'comparison' %}
    <div class="year-selector">
        <label for="yearSelect"><strong>选择年份：</strong></label>
        <select id="yearSelect" class="form-control" style="width: auto;" onchange="changeYear(this.value)">
            {% for year in available_years %}
            <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}年</option>
            {% endfor %}
        </select>
    </div>
    {% endif %}

    <!-- 综合概览 -->
    {% if stat_type == 'overview' %}
    <div class="row">
        <div class="col-md-6">
            <div class="stat-card">
                <h3><i class="fas fa-shopping-cart"></i> 采购概览（{{ selected_year }}年）</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="label">采购项目总数</div>
                        <div class="value">{{ procurement_stats.total_count }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">预算总额</div>
                        <div class="value">{{ procurement_stats.total_budget|floatformat:2 }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">中标总额</div>
                        <div class="value success">{{ procurement_stats.total_winning|floatformat:2 }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">节约率</div>
                        <div class="value success">{{ procurement_stats.savings_rate }}%</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">归档率</div>
                        <div class="value {% if procurement_stats.archive_rate >= 80 %}success{% elif procurement_stats.archive_rate >= 50 %}warning{% else %}danger{% endif %}">
                            {{ procurement_stats.archive_rate }}%
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="label">平均采购周期</div>
                        <div class="value">{{ procurement_stats.avg_cycle_days }} 天</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="stat-card">
                <h3><i class="fas fa-file-contract"></i> 合同概览（{{ selected_year }}年）</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="label">合同总数</div>
                        <div class="value">{{ contract_stats.total_count }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">合同总额</div>
                        <div class="value">{{ contract_stats.total_amount|floatformat:2 }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">主合同数量</div>
                        <div class="value">{{ contract_stats.main_count }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">补充协议数量</div>
                        <div class="value">{{ contract_stats.supplement_count }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">归档率</div>
                        <div class="value {% if contract_stats.archive_rate >= 80 %}success{% elif contract_stats.archive_rate >= 50 %}warning{% else %}danger{% endif %}">
                            {{ contract_stats.archive_rate }}%
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="stat-card">
                <h3><i class="fas fa-money-bill-wave"></i> 付款概览（{{ selected_year }}年）</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="label">付款笔数</div>
                        <div class="value">{{ payment_stats.total_count }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">付款总额</div>
                        <div class="value">{{ payment_stats.total_amount|floatformat:2 }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">平均付款金额</div>
                        <div class="value">{{ payment_stats.avg_amount|floatformat:2 }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">已结算笔数</div>
                        <div class="value success">{{ payment_stats.settled_count }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">预计剩余支付</div>
                        <div class="value warning">{{ payment_stats.estimated_remaining|floatformat:2 }}</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="stat-card">
                <h3><i class="fas fa-calculator"></i> 结算概览（全部）</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="label">结算总数</div>
                        <div class="value">{{ settlement_stats.total_count }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">结算总额</div>
                        <div class="value">{{ settlement_stats.total_amount|floatformat:2 }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">平均结算金额</div>
                        <div class="value">{{ settlement_stats.avg_amount|floatformat:2 }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="label">结算率</div>
                        <div class="value {% if settlement_stats.settlement_rate >= 80 %}success{% elif settlement_stats.settlement_rate >= 50 %}warning{% else %}danger{% endif %}">
                            {{ settlement_stats.settlement_rate }}%
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="label">待结算合同</div>
                        <div class="value warning">{{ settlement_stats.pending_count }}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 采购统计详情 -->
    {% if stat_type == 'procurement' and procurement_stats %}
    <div class="stat-card">
        <h3><i class="fas fa-shopping-cart"></i> 采购统计详情（{{ procurement_stats.year }}年）</h3>
        
        <div class="stat-grid">
            <div class="stat-item">
                <div class="label">采购项目总数</div>
                <div class="value">{{ procurement_stats.total_count }}</div>
            </div>
            <div class="stat-item">
                <div class="label">预算总额（元）</div>
                <div class="value">{{ procurement_stats.total_budget|floatformat:2 }}</div>
            </div>
            <div class="stat-item">
                <div class="label">中标总额（元）</div>
                <div class="value success">{{ procurement_stats.total_winning|floatformat:2 }}</div>
            </div>
            <div class="stat-item">
                <div class="label">节约金额（元）</div>
                <div class="value success">{{ procurement_stats.savings_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item">
                <div class="label">节约率</div>
                <div class="value success">{{ procurement_stats.savings_rate }}%</div>
            </div>
            <div class="stat-item">
                <div class="label">平均采购周期</div>
                <div class="value">{{ procurement_stats.avg_cycle_days }} 天</div>
            </div>
            <div class="stat-item">
                <div class="label">已归档项目</div>
                <div class="value">{{ procurement_stats.archived_count }}</div>
            </div>
            <div class="stat-item">
                <div class="label">归档率</div>
                <div class="value {% if procurement_stats.archive_rate >= 80 %}success{% elif procurement_stats.archive_rate >= 50 %}warning{% else %}danger{% endif %}">
                    {{ procurement_stats.archive_rate }}%
                </div>
            </div>
        </div>

        <!-- 采购方式分布 -->
        {% if procurement_stats.method_distribution %}
        <h4 class="mt-4">采购方式分布</h4>
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="procurementMethodChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>采购方式</th>
                                <th>数量</th>
                                <th>金额（元）</th>
                                <th>占比</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in procurement_stats.method_distribution %}
                            <tr>
                                <td>{{ item.method }}</td>
                                <td>{{ item.count }}</td>
                                <td>{{ item.amount|floatformat:2 }}</td>
                                <td>{{ item.percentage }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 月度趋势 -->
        {% if procurement_stats.monthly_trend %}
        <h4 class="mt-4">月度采购趋势</h4>
        <div class="chart-container" style="height: 400px;">
            <canvas id="procurementTrendChart"></canvas>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- 合同统计详情 -->
    {% if stat_type == 'contract' and contract_stats %}
    <div class="stat-card">
        <h3><i class="fas fa-file-contract"></i> 合同统计详情（{{ contract_stats.year }}年）</h3>
        
        <div class="stat-grid">
            <div class="stat-item">
                <div class="label">合同总数</div>
                <div class="value">{{ contract_stats.total_count }}</div>
            </div>
            <div class="stat-item">
                <div class="label">合同总额（元）</div>
                <div class="value">{{ contract_stats.total_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item">
                <div class="label">主合同数量</div>
                <div class="value">{{ contract_stats.main_count }}</div>
            </div>
            <div class="stat-item">
                <div class="label">主合同金额（元）</div>
                <div class="value">{{ contract_stats.main_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item">
                <div class="label">补充协议数量</div>
                <div class="value">{{ contract_stats.supplement_count }}</div>
            </div>
            <div class="stat-item">
                <div class="label">补充协议金额（元）</div>
                <div class="value">{{ contract_stats.supplement_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item">
                <div class="label">已归档合同</div>
                <div class="value">{{ contract_stats.archived_count }}</div>
            </div>
            <div class="stat-item">
                <div class="label">归档率</div>
                <div class="value {% if contract_stats.archive_rate >= 80 %}success{% elif contract_stats.archive_rate >= 50 %}warning{% else %}danger{% endif %}">
                    {{ contract_stats.archive_rate }}%
                </div>
            </div>
        </div>

        <!-- 合同类型分布 -->
        {% if contract_stats.type_distribution %}
        <h4 class="mt-4">合同类型分布</h4>
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="contractTypeChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>合同类型</th>
                                <th>数量</th>
                                <th>金额（元）</th>
                                <th>占比</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in contract_stats.type_distribution %}
                            <tr>
                                <td>{{ item.type }}</td>
                                <td>{{ item.count }}</td>
                                <td>{{ item.amount|floatformat:2 }}</td>
                                <td>{{ item.percentage }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 合同来源分布 -->
        {% if contract_stats.source_distribution %}
        <h4 class="mt-4">合同来源分布</h4>
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="contractSourceChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>合同来源</th>
                                <th>数量</th>
                                <th>金额（元）</th>
                                <th>占比</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in contract_stats.source_distribution %}
                            <tr>
                                <td>{{ item.source }}</td>
                                <td>{{ item.count }}</td>
                                <td>{{ item.amount|floatformat:2 }}</td>
                                <td>{{ item.percentage }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- 月度趋势 -->
        {% if contract_stats.monthly_trend %}
        <h4 class="mt-4">月度签约趋势</h4>
        <div class="chart-container" style="height: 400px;">
            <canvas id="contractTrendChart"></canvas>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- 付款统计详情 -->
    {% if stat_type == 'payment' and payment_stats %}
    <div class="stat-card">
        <h3><i class="fas fa-money-bill-wave"></i> 付款统计详情（{{ payment_stats.year }}年）</h3>
        
        <div class="stat-grid">
            <div class="stat-item">
                <div class="label">付款笔数</div>
                <div class="value">{{ payment_stats.total_count }}</div>
            </div>
            <div class="stat-item">
                <div class="label">付款总额（元）</div>
                <div class="value">{{ payment_stats.total_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item">
                <div class="label">平均付款金额（元）</div>
                <div class="value">{{ payment_stats.avg_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item">
                <div class="label">最大单笔付款（元）</div>
                <div class="value">{{ payment_stats.max_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item">
                <div class="label">最小单笔付款（元）</div>
                <div class="value">{{ payment_stats.min_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item">
                <div class="label">已结算笔数</div>
                <div class="value success">{{ payment_stats.settled_count }}</div>
            </div>
            <div class="stat-item">
                <div class="label">已结算金额（元）</div>
                <div class="value success">{{ payment_stats.settled_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item">
                <div class="label">未结算笔数</div>
                <div class="value warning">{{ payment_stats.unsettled_count }}</div>
            </div>
            <div class="stat-item">
                <div class="label">未结算金额（元）</div>
                <div class="value warning">{{ payment_stats.unsettled_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item">
                <div class="label">预计剩余支付（元）</div>
                <div class="value warning">{{ payment_stats.estimated_remaining|floatformat:2 }}</div>
            </div>
        </div>

        <!-- 月度付款趋势 -->
        {% if payment_stats.monthly_trend %}
        <h4 class="mt-4">月度付款趋势</h4>
        <div class="chart-container" style="height: 400px;">
            <canvas id="paymentTrendChart"></canvas>
        </div>
        {% endif %}

        <!-- 结算状态分布 -->
        <h4 class="mt-4">结算状态分布</h4>
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="settlementStatusChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>状态</th>
                                <th>笔数</th>
                                <th>金额（元）</th>
                            </tr>
                        
</thead>
                        <tbody>
                            <tr>
                                <td>已结算</td>
                                <td>{{ payment_stats.settled_count }}</td>
                                <td>{{ payment_stats.settled_amount|floatformat:2 }}</td>
                            </tr>
                            <tr>
                                <td>未结算</td>
                                <td>{{ payment_stats.unsettled_count }}</td>
                                <td>{{ payment_stats.unsettled_amount|floatformat:2 }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 结算统计详情 -->
    {% if stat_type == 'settlement' and settlement_stats %}
    <div class="stat-card">
        <h3><i class="fas fa-calculator"></i> 结算统计详情（全部）</h3>
        
        <div class="stat-grid">
            <div class="stat-item">
                <div class="label">结算总数</div>
                <div class="value">{{ settlement_stats.total_count }}</div>
            </div>
            <div class="stat-item">
                <div class="label">结算总额（元）</div>
                <div class="value">{{ settlement_stats.total_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item">
                <div class="label">平均结算金额（元）</div>
                <div class="value">{{ settlement_stats.avg_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item">
                <div class="label">结算率</div>
                <div class="value {% if settlement_stats.settlement_rate >= 80 %}success{% elif settlement_stats.settlement_rate >= 50 %}warning{% else %}danger{% endif %}">
                    {{ settlement_stats.settlement_rate }}%
                </div>
            </div>
            <div class="stat-item">
                <div class="label">待结算合同数</div>
                <div class="value warning">{{ settlement_stats.pending_count }}</div>
            </div>
            <div class="stat-item">
                <div class="label">待结算金额（元）</div>
                <div class="value warning">{{ settlement_stats.pending_amount|floatformat:2 }}</div>
            </div>
        </div>

        <!-- 年度结算趋势 -->
        {% if settlement_stats.yearly_data %}
        <h4 class="mt-4">年度结算趋势</h4>
        <div class="chart-container" style="height: 400px;">
            <canvas id="settlementYearlyChart"></canvas>
        </div>
        {% endif %}

        <!-- 结算与合同差异分析 -->
        {% if settlement_stats.variance_analysis %}
        <h4 class="mt-4">结算与合同差异分析（前10条）</h4>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>结算编号</th>
                        <th>合同金额（元）</th>
                        <th>结算金额（元）</th>
                        <th>差异（元）</th>
                        <th>差异率</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in settlement_stats.variance_analysis %}
                    <tr>
                        <td>{{ item.settlement_code }}</td>
                        <td>{{ item.contract_amount|floatformat:2 }}</td>
                        <td>{{ item.settlement_amount|floatformat:2 }}</td>
                        <td class="{% if item.variance > 0 %}text-danger{% elif item.variance < 0 %}text-success{% endif %}">
                            {{ item.variance|floatformat:2 }}
                        </td>
                        <td class="{% if item.variance_rate > 0 %}text-danger{% elif item.variance_rate < 0 %}text-success{% endif %}">
                            {{ item.variance_rate }}%
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- 年度对比 -->
    {% if stat_type == 'comparison' and comparison_data %}
    <div class="comparison-selector">
        <form method="get" class="form-inline">
            <input type="hidden" name="type" value="comparison">
            <label class="mr-2"><strong>选择对比年份：</strong></label>
            {% for year in available_years %}
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="comparison_years" value="{{ year }}" 
                       id="year{{ year }}" {% if year in comparison_years %}checked{% endif %}>
                <label class="form-check-label" for="year{{ year }}">{{ year }}年</label>
            </div>
            {% endfor %}
            <button type="submit" class="btn btn-sm btn-primary ml-3">
                <i class="fas fa-sync"></i> 更新对比
            </button>
        </form>
    </div>

    <div class="stat-card">
        <h3><i class="fas fa-chart-line"></i> 年度数据对比</h3>
        
        <!-- 采购对比 -->
        <h4 class="mt-3">采购数据对比</h4>
        <div class="chart-container" style="height: 400px;">
            <canvas id="procurementComparisonChart"></canvas>
        </div>
        
        <!-- 合同对比 -->
        <h4 class="mt-4">合同数据对比</h4>
        <div class="chart-container" style="height: 400px;">
            <canvas id="contractComparisonChart"></canvas>
        </div>
        
        <!-- 付款对比 -->
        <h4 class="mt-4">付款数据对比</h4>
        <div class="chart-container" style="height: 400px;">
            <canvas id="paymentComparisonChart"></canvas>
        </div>

        <!-- 对比数据表格 -->
        <h4 class="mt-4">详细对比数据</h4>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>年份</th>
                        <th>采购项目数</th>
                        <th>采购金额（元）</th>
                        <th>合同数量</th>
                        <th>合同金额（元）</th>
                        <th>付款笔数</th>
                        <th>付款金额（元）</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in comparison_data.rows %}
                    <tr>
                        <td><strong>{{ row.year }}年</strong></td>
                        <td>{{ row.procurement_count|default:0 }}</td>
                        <td>{{ row.procurement_amount|default:0|floatformat:2 }}</td>
                        <td>{{ row.contract_count|default:0 }}</td>
                        <td>{{ row.contract_amount|default:0|floatformat:2 }}</td>
                        <td>{{ row.payment_count|default:0 }}</td>
                        <td>{{ row.payment_amount|default:0|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{% static 'js/charts.js' %}"></script>
<script>
// 年份切换
function changeYear(year) {
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('year', year);
    window.location.search = urlParams.toString();
}

// Chart.js 配置
Chart.defaults.font.family = "'Segoe UI', 'Microsoft YaHei', sans-serif";

{% if stat_type == 'procurement' and procurement_stats %}
    // 采购方式饼图
    {% if procurement_stats.method_distribution %}
    new Chart(document.getElementById('procurementMethodChart'), {
        type: 'pie',
        data: {
            labels: [{% for item in procurement_stats.method_distribution %}'{{ item.method }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for item in procurement_stats.method_distribution %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6c757d']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right' }
            }
        }
    });
    {% endif %}

    // 月度趋势图
    {% if procurement_stats.monthly_trend %}
    new Chart(document.getElementById('procurementTrendChart'), {
        type: 'line',
        data: {
            labels: [{% for item in procurement_stats.monthly_trend %}'{{ item.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '采购数量',
                data: [{% for item in procurement_stats.monthly_trend %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                yAxisID: 'y'
            }, {
                label: '采购金额（元）',
                data: [{% for item in procurement_stats.monthly_trend %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '数量' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });
    {% endif %}
{% endif %}

{% if stat_type == 'contract' and contract_stats %}
    // 合同类型饼图
    {% if contract_stats.type_distribution %}
    new Chart(document.getElementById('contractTypeChart'), {
        type: 'pie',
        data: {
            labels: [{% for item in contract_stats.type_distribution %}'{{ item.type }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for item in contract_stats.type_distribution %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: ['#007bff', '#28a745', '#ffc107']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
        }
    });
    {% endif %}

    // 合同来源饼图
    {% if contract_stats.source_distribution %}
    new Chart(document.getElementById('contractSourceChart'), {
        type: 'pie',
        data: {
            labels: [{% for item in contract_stats.source_distribution %}'{{ item.source }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for item in contract_stats.source_distribution %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: ['#17a2b8', '#6c757d']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
        }
    });
    {% endif %}

    // 月度趋势图
    {% if contract_stats.monthly_trend %}
    new Chart(document.getElementById('contractTrendChart'), {
        type: 'line',
        data: {
            labels: [{% for item in contract_stats.monthly_trend %}'{{ item.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '合同数量',
                data: [{% for item in contract_stats.monthly_trend %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                yAxisID: 'y'
            }, {
                label: '合同金额（元）',
                data: [{% for item in contract_stats.monthly_trend %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '数量' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });
    {% endif %}
{% endif %}

{% if stat_type == 'payment' and payment_stats %}
    // 月度付款趋势
    {% if payment_stats.monthly_trend %}
    new Chart(document.getElementById('paymentTrendChart'), {
        type: 'bar',
        data: {
            labels: [{% for item in payment_stats.monthly_trend %}'{{ item.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '付款笔数',
                data: [{% for item in payment_stats.monthly_trend %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(0, 123, 255, 0.7)',
                yAxisID: 'y'
            }, {
                label: '付款金额（元）',
                data: [{% for item in payment_stats.monthly_trend %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(40, 167, 69, 0.7)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '笔数' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });
    {% endif %}

    // 结算状态饼图
    new Chart(document.getElementById('settlementStatusChart'), {
        type: 'doughnut',
        data: {
            labels: ['已结算', '未结算'],
            datasets: [{
                data: [{{ payment_stats.settled_count }}, {{ payment_stats.unsettled_count }}],
                backgroundColor: ['#28a745', '#ffc107']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
        }
    });
{% endif %}

{% if stat_type == 'settlement' and settlement_stats %}
    // 年度结算趋势
    {% if settlement_stats.yearly_data %}
    new Chart(document.getElementById('settlementYearlyChart'), {
        type: 'bar',
        data: {
            labels: [{% for item in settlement_stats.yearly_data %}'{{ item.year }}年'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '结算数量',
                data: [{% for item in settlement_stats.yearly_data %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(0, 123, 255, 0.7)',
                yAxisID: 'y'
            }, {
                label: '结算金额（元）',
                data: [{% for item in settlement_stats.yearly_data %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(40, 167, 69, 0.7)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '数量' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });
    {% endif %}
{% endif %}

{% if stat_type == 'comparison' and comparison_data %}
    // 采购对比图
    new Chart(document.getElementById('procurementComparisonChart'), {
        type: 'bar',
        data: {
            labels: [{% for year in comparison_data.years %}'{{ year }}年'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '采购数量',
                data: [{% for item in comparison_data.procurement %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(0, 123, 255, 0.7)',
                yAxisID: 'y'
            }, {
                label: '采购金额（元）',
                data: [{% for item in comparison_data.procurement %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(40, 167, 69, 0.7)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '数量' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });

    // 合同对比图
    new Chart(document.getElementById('contractComparisonChart'), {
        type: 'bar',
        data: {
            labels: [{% for year in comparison_data.years %}'{{ year }}年'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '合同数量',
                data: [{% for item in comparison_data.contract %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(23, 162, 184, 0.7)',
                yAxisID: 'y'
            }, {
                label: '合同金额（元）',
                data: [{% for item in comparison_data.contract %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(255, 193, 7, 0.7)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '数量' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });

    // 付款对比图
    new Chart(document.getElementById('paymentComparisonChart'), {
        type: 'bar',
        data: {
            labels: [{% for year in comparison_data.years %}'{{ year }}年'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '付款笔数',
                data: [{% for item in comparison_data.payment %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(220, 53, 69, 0.7)',
                yAxisID: 'y'
            }, {
                label: '付款金额（元）',
                data: [{% for item in comparison_data.payment %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(108, 117, 125, 0.7)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '笔数' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });
{% endif %}
</script>
{% endblock %}