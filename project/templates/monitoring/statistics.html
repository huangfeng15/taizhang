{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }} - 项目采购与成本管理系统{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/monitoring.css' %}">
<style>
/* 导航按钮组 */
.stat-nav {
    margin-bottom: 20px;
}
.stat-nav .btn-group {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
.stat-nav .btn {
    border-radius: 8px;
    padding: 8px 16px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 5px rgba(0,0,0,0.08);
}
.stat-nav .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,123,255,0.3);
}

/* 年份选择器 */
.year-selector {
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 18px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.year-selector label {
    font-weight: 600;
    color: #495057;
    margin: 0;
}
.year-selector select {
    border-radius: 6px;
    border: 2px solid #dee2e6;
    padding: 6px 12px;
    transition: all 0.3s ease;
}
.year-selector select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,0.15);
}

/* 概览 - 紧凑多栏卡片网格 */
.overview-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
}

/* 统计数据卡片 - 紧凑列表设计 */
.stat-card-compact {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 12px;
    padding: 18px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    border-left: 4px solid #007bff;
    transition: all 0.3s ease;
}
.stat-card-compact:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 20px rgba(0,123,255,0.15);
}
.stat-card-compact .card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
    padding-bottom: 10px;
    border-bottom: 2px solid #e9ecef;
}
.stat-card-compact .card-header i {
    font-size: 1.3rem;
    background: linear-gradient(135deg, #007bff, #00d4ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
.stat-card-compact .card-header h4 {
    margin: 0;
    font-size: 1.05rem;
    font-weight: 600;
    color: #2c3e50;
}
.stat-card-compact .stat-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.stat-card-compact .stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
}
.stat-card-compact .stat-row .label {
    font-size: 0.88rem;
    color: #6c757d;
    font-weight: 500;
}
.stat-card-compact .stat-row .value {
    font-size: 1.25rem;
    font-weight: 700;
    color: #2c3e50;
}
.stat-card-compact .stat-row .value.success {
    background: linear-gradient(135deg, #28a745, #20c997);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
.stat-card-compact .stat-row .value.warning {
    background: linear-gradient(135deg, #ffc107, #ff9800);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
.stat-card-compact .stat-row .value.danger {
    background: linear-gradient(135deg, #dc3545, #e74c3c);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* 详情页 - 紧凑卡片 */
.detail-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 3px 15px rgba(0,0,0,0.08);
    border: 1px solid rgba(0,0,0,0.05);
}
.detail-card .card-title {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 3px solid transparent;
    border-image: linear-gradient(90deg, #007bff, #00d4ff) 1;
    font-size: 1.2rem;
    font-weight: 600;
    color: #2c3e50;
}
.detail-card .card-title i {
    background: linear-gradient(135deg, #007bff, #00d4ff);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-size: 1.4rem;
}

/* 统计指标网格 - 更紧凑 */
.stat-grid-compact {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
    margin-bottom: 15px;
}
.stat-item-compact {
    padding: 14px;
    background: white;
    border-radius: 10px;
    border-left: 3px solid #007bff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    transition: all 0.3s ease;
}
.stat-item-compact:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,123,255,0.15);
}
.stat-item-compact .label {
    font-size: 0.85rem;
    color: #6c757d;
    margin-bottom: 6px;
    font-weight: 500;
}
.stat-item-compact .value {
    font-size: 1.5rem;
    font-weight: 700;
    color: #2c3e50;
    line-height: 1.2;
}
.stat-item-compact .value.success {
    background: linear-gradient(135deg, #28a745, #20c997);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
.stat-item-compact .value.warning {
    background: linear-gradient(135deg, #ffc107, #ff9800);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
.stat-item-compact .value.danger {
    background: linear-gradient(135deg, #dc3545, #e74c3c);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

/* 图表区域 - 紧凑设计 */
.chart-section {
    margin-top: 15px;
}
.chart-section h5 {
    font-size: 1rem;
    color: #495057;
    margin-bottom: 12px;
    font-weight: 600;
    padding-left: 10px;
    border-left: 3px solid #007bff;
}
.chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 15px;
    background: white;
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
.chart-container canvas {
    max-height: 300px;
}

/* 对比选择器 */
.comparison-selector {
    margin-bottom: 20px;
    padding: 15px;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}
.comparison-selector label {
    margin-right: 12px;
    font-weight: 600;
    color: #495057;
}
.comparison-selector .form-check {
    margin-right: 15px;
}
.comparison-selector .form-check-input:checked {
    background-color: #007bff;
    border-color: #007bff;
}

/* 表格优化 */
.table-responsive {
    margin-top: 12px;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}
.table {
    margin-bottom: 0;
}
.table thead th {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    font-weight: 600;
    border: none;
    padding: 12px;
    font-size: 0.9rem;
}
.table tbody tr {
    transition: background-color 0.2s ease;
}
.table tbody tr:hover {
    background-color: rgba(0,123,255,0.05);
}
.table td, .table th {
    padding: 10px 12px;
    vertical-align: middle;
    font-size: 0.9rem;
}

/* 响应式优化 */
@media (max-width: 992px) {
    .overview-grid {
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }
    .stat-grid-compact {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
}

@media (max-width: 768px) {
    .overview-grid {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    .stat-card-compact {
        padding: 14px;
    }
    .stat-grid-compact {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    .detail-card {
        padding: 16px;
    }
    .chart-container {
        height: 250px;
        padding: 12px;
    }
}

@media (max-width: 576px) {
    .overview-grid {
        grid-template-columns: 1fr;
    }
    .stat-grid-compact {
        grid-template-columns: 1fr;
    }
    .stat-nav .btn-group {
        flex-direction: column;
    }
    .stat-nav .btn {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="monitoring-statistics">
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
        <div>
            <h1><i class="fas fa-chart-bar"></i> {{ page_title }}</h1>
            <p class="text-muted">查看采购、合同、付款、结算的统计分析数据</p>
        </div>
        
        <!-- 筛选器 - 右上角（年度对比时不显示） -->
        {% if stat_type != 'comparison' %}
        <div class="filter-section" style="padding: 12px 16px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 12px;">
            <form method="get" action="" id="filterForm" style="display: flex; align-items: center; gap: 12px; margin: 0;">
                <!-- 保留统计类型参数 -->
                <input type="hidden" name="type" value="{{ stat_type }}">
                
                {% for filter in quick_filters %}
                    {% if filter.type == 'select' %}
                        <label style="font-weight: 600; color: #495057; margin: 0; white-space: nowrap;">
                            {% if filter.name == 'year' %}年份：{% elif filter.name == 'project' %}项目：{% endif %}
                        </label>
                        <select name="{{ filter.name }}"
                                id="filter_{{ filter.name }}"
                                class="form-control form-control-sm filter-select"
                                style="width: {{ filter.width|default:'150px' }}; border-radius: 4px;">
                            {% for option in filter.options %}
                                <option value="{{ option.value }}"
                                        {% if option.value == filter.current_value %}selected{% endif %}>
                                    {{ option.label }}
                                </option>
                            {% endfor %}
                        </select>
                    {% endif %}
                {% endfor %}
            </form>
        </div>
        {% endif %}
    </div>

    <!-- 统计类型切换 -->
    <div class="stat-nav">
        <div class="btn-group" role="group">
            <a href="?type=overview&year={{ year_filter_value|default:'all' }}" class="btn btn-sm {% if stat_type == 'overview' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="fas fa-tachometer-alt"></i> 综合概览
            </a>
            <a href="?type=procurement&year={{ year_filter_value|default:'all' }}" class="btn btn-sm {% if stat_type == 'procurement' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="fas fa-shopping-cart"></i> 采购统计
            </a>
            <a href="?type=contract&year={{ year_filter_value|default:'all' }}" class="btn btn-sm {% if stat_type == 'contract' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="fas fa-file-contract"></i> 合同统计
            </a>
            <a href="?type=payment&year={{ year_filter_value|default:'all' }}" class="btn btn-sm {% if stat_type == 'payment' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="fas fa-money-bill-wave"></i> 付款统计
            </a>
            <a href="?type=settlement&year={{ year_filter_value|default:'all' }}" class="btn btn-sm {% if stat_type == 'settlement' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="fas fa-calculator"></i> 结算统计
            </a>
            <a href="?type=comparison" class="btn btn-sm {% if stat_type == 'comparison' %}btn-primary{% else %}btn-outline-primary{% endif %}">
                <i class="fas fa-chart-line"></i> 年度对比
            </a>
        </div>
    </div>

    <!-- 综合概览 - 紧凑多栏卡片布局 -->
    {% if stat_type == 'overview' %}
    <div class="overview-grid">
        <!-- 采购概览卡片 -->
        <div class="stat-card-compact">
            <div class="card-header">
                <i class="fas fa-shopping-cart"></i>
                <h4>采购概览（{{ selected_year }}年）</h4>
            </div>
            <div class="stat-list">
                <div class="stat-row">
                    <span class="label">项目总数</span>
                    <span class="value">{{ procurement_stats.total_count }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">预算总额</span>
                    <span class="value">{{ procurement_stats.total_budget|floatformat:2 }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">中标总额</span>
                    <span class="value success">{{ procurement_stats.total_winning|floatformat:2 }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">节约率</span>
                    <span class="value success">{{ procurement_stats.savings_rate }}%</span>
                </div>
                <div class="stat-row">
                    <span class="label">归档率</span>
                    <span class="value {% if procurement_stats.archive_rate >= 80 %}success{% elif procurement_stats.archive_rate >= 50 %}warning{% else %}danger{% endif %}">{{ procurement_stats.archive_rate }}%</span>
                </div>
                <div class="stat-row">
                    <span class="label">平均周期</span>
                    <span class="value">{{ procurement_stats.avg_cycle_days }} 天</span>
                </div>
            </div>
        </div>

        <!-- 合同概览卡片 -->
        <div class="stat-card-compact">
            <div class="card-header">
                <i class="fas fa-file-contract"></i>
                <h4>合同概览（{{ selected_year }}年）</h4>
            </div>
            <div class="stat-list">
                <div class="stat-row">
                    <span class="label">合同总数</span>
                    <span class="value">{{ contract_stats.total_count }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">合同总额</span>
                    <span class="value">{{ contract_stats.total_amount|floatformat:2 }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">主合同数</span>
                    <span class="value">{{ contract_stats.main_count }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">补充协议</span>
                    <span class="value">{{ contract_stats.supplement_count }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">归档率</span>
                    <span class="value {% if contract_stats.archive_rate >= 80 %}success{% elif contract_stats.archive_rate >= 50 %}warning{% else %}danger{% endif %}">{{ contract_stats.archive_rate }}%</span>
                </div>
            </div>
        </div>

        <!-- 付款概览卡片 -->
        <div class="stat-card-compact">
            <div class="card-header">
                <i class="fas fa-money-bill-wave"></i>
                <h4>付款概览（{{ selected_year }}年）</h4>
            </div>
            <div class="stat-list">
                <div class="stat-row">
                    <span class="label">付款笔数</span>
                    <span class="value">{{ payment_stats.total_count }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">付款总额</span>
                    <span class="value">{{ payment_stats.total_amount|floatformat:2 }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">平均金额</span>
                    <span class="value">{{ payment_stats.avg_amount|floatformat:2 }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">已结算</span>
                    <span class="value success">{{ payment_stats.settled_count }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">剩余支付</span>
                    <span class="value warning">{{ payment_stats.estimated_remaining|floatformat:2 }}</span>
                </div>
            </div>
        </div>

        <!-- 结算概览卡片 -->
        <div class="stat-card-compact">
            <div class="card-header">
                <i class="fas fa-calculator"></i>
                <h4>结算概览（全部）</h4>
            </div>
            <div class="stat-list">
                <div class="stat-row">
                    <span class="label">结算总数</span>
                    <span class="value">{{ settlement_stats.total_count }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">结算总额</span>
                    <span class="value">{{ settlement_stats.total_amount|floatformat:2 }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">平均金额</span>
                    <span class="value">{{ settlement_stats.avg_amount|floatformat:2 }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">结算率</span>
                    <span class="value {% if settlement_stats.settlement_rate >= 80 %}success{% elif settlement_stats.settlement_rate >= 50 %}warning{% else %}danger{% endif %}">{{ settlement_stats.settlement_rate }}%</span>
                </div>
                <div class="stat-row">
                    <span class="label">待结算</span>
                    <span class="value warning">{{ settlement_stats.pending_count }}</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 采购统计详情 - 紧凑版本 -->
    {% if stat_type == 'procurement' and procurement_stats %}
    <div class="detail-card">
        <div class="card-title">
            <i class="fas fa-shopping-cart"></i>
            <span>采购统计详情（{{ procurement_stats.year }}年）</span>
        </div>
        
        <div class="stat-grid-compact">
            <div class="stat-item-compact">
                <div class="label">项目总数</div>
                <div class="value">{{ procurement_stats.total_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">预算总额（元）</div>
                <div class="value">{{ procurement_stats.total_budget|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">中标总额（元）</div>
                <div class="value success">{{ procurement_stats.total_winning|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">节约金额（元）</div>
                <div class="value success">{{ procurement_stats.savings_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">节约率</div>
                <div class="value success">{{ procurement_stats.savings_rate }}%</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">平均周期</div>
                <div class="value">{{ procurement_stats.avg_cycle_days }} 天</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">已归档项目</div>
                <div class="value">{{ procurement_stats.archived_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">归档率</div>
                <div class="value {% if procurement_stats.archive_rate >= 80 %}success{% elif procurement_stats.archive_rate >= 50 %}warning{% else %}danger{% endif %}">
                    {{ procurement_stats.archive_rate }}%
                </div>
            </div>
        </div>

        <!-- 采购方式分布 -->
        {% if procurement_stats.method_distribution %}
        <div class="chart-section">
            <h5>采购方式分布</h5>
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="procurementMethodChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>采购方式</th>
                                <th>数量</th>
                                <th>金额（元）</th>
                                <th>占比</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in procurement_stats.method_distribution %}
                            <tr>
                                <td>{{ item.method }}</td>
                                <td>{{ item.count }}</td>
                                <td>{{ item.amount|floatformat:2 }}</td>
                                <td>{{ item.percentage }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>
        {% endif %}

        <!-- 月度趋势 -->
        {% if procurement_stats.monthly_trend %}
        <div class="chart-section">
            <h5>月度采购趋势</h5>
            <div class="chart-container" style="height: 350px;">
                <canvas id="procurementTrendChart"></canvas>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- 合同统计详情 - 紧凑版本 -->
    {% if stat_type == 'contract' and contract_stats %}
    <div class="detail-card">
        <div class="card-title">
            <i class="fas fa-file-contract"></i>
            <span>合同统计详情（{{ contract_stats.year }}年）</span>
        </div>
        
        <div class="stat-grid-compact">
            <div class="stat-item-compact">
                <div class="label">合同总数</div>
                <div class="value">{{ contract_stats.total_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">合同总额（元）</div>
                <div class="value">{{ contract_stats.total_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">主合同数量</div>
                <div class="value">{{ contract_stats.main_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">主合同金额（元）</div>
                <div class="value">{{ contract_stats.main_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">补充协议数量</div>
                <div class="value">{{ contract_stats.supplement_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">补充协议金额（元）</div>
                <div class="value">{{ contract_stats.supplement_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">已归档合同</div>
                <div class="value">{{ contract_stats.archived_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">归档率</div>
                <div class="value {% if contract_stats.archive_rate >= 80 %}success{% elif contract_stats.archive_rate >= 50 %}warning{% else %}danger{% endif %}">
                    {{ contract_stats.archive_rate }}%
                </div>
            </div>
        </div>

        <!-- 合同类型分布 -->
        {% if contract_stats.type_distribution %}
        <div class="chart-section">
            <h5>合同类型分布</h5>
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="contractTypeChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>合同类型</th>
                                <th>数量</th>
                                <th>金额（元）</th>
                                <th>占比</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in contract_stats.type_distribution %}
                            <tr>
                                <td>{{ item.type }}</td>
                                <td>{{ item.count }}</td>
                                <td>{{ item.amount|floatformat:2 }}</td>
                                <td>{{ item.percentage }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div>
        {% endif %}

        <!-- 合同来源分布 -->
        {% if contract_stats.source_distribution %}
        <div class="chart-section">
            <h5>合同来源分布</h5>
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="contractSourceChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>合同来源</th>
                                <th>数量</th>
                                <th>金额（元）</th>
                                <th>占比</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in contract_stats.source_distribution %}
                            <tr>
                                <td>{{ item.source }}</td>
                                <td>{{ item.count }}</td>
                                <td>{{ item.amount|floatformat:2 }}</td>
                                <td>{{ item.percentage }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div>
        {% endif %}

        <!-- 月度趋势 -->
        {% if contract_stats.monthly_trend %}
        <div class="chart-section">
            <h5>月度签约趋势</h5>
            <div class="chart-container" style="height: 350px;">
                <canvas id="contractTrendChart"></canvas>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- 付款统计详情 - 紧凑版本 -->
    {% if stat_type == 'payment' and payment_stats %}
    <div class="detail-card">
        <div class="card-title">
            <i class="fas fa-money-bill-wave"></i>
            <span>付款统计详情（{{ payment_stats.year }}年）</span>
        </div>
        
        <div class="stat-grid-compact">
            <div class="stat-item-compact">
                <div class="label">付款笔数</div>
                <div class="value">{{ payment_stats.total_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">付款总额（元）</div>
                <div class="value">{{ payment_stats.total_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">平均金额（元）</div>
                <div class="value">{{ payment_stats.avg_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">最大单笔（元）</div>
                <div class="value">{{ payment_stats.max_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">最小单笔（元）</div>
                <div class="value">{{ payment_stats.min_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">已结算笔数</div>
                <div class="value success">{{ payment_stats.settled_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">已结算金额（元）</div>
                <div class="value success">{{ payment_stats.settled_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">未结算笔数</div>
                <div class="value warning">{{ payment_stats.unsettled_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">未结算金额（元）</div>
                <div class="value warning">{{ payment_stats.unsettled_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">剩余支付（元）</div>
                <div class="value warning">{{ payment_stats.estimated_remaining|floatformat:2 }}</div>
            </div>
        </div>

        <!-- 月度付款趋势 -->
        {% if payment_stats.monthly_trend %}
        <div class="chart-section">
            <h5>月度付款趋势</h5>
            <div class="chart-container" style="height: 350px;">
                <canvas id="paymentTrendChart"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- 结算状态分布 -->
        <div class="chart-section">
            <h5>结算状态分布</h5>
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <canvas id="settlementStatusChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>状态</th>
                                <th>笔数</th>
                                <th>金额（元）</th>
                            </tr>
                        
</thead>
                        <tbody>
                            <tr>
                                <td>已结算</td>
                                <td>{{ payment_stats.settled_count }}</td>
                                <td>{{ payment_stats.settled_amount|floatformat:2 }}</td>
                            </tr>
                            <tr>
                                <td>未结算</td>
                                <td>{{ payment_stats.unsettled_count }}</td>
                                <td>{{ payment_stats.unsettled_amount|floatformat:2 }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 结算统计详情 - 紧凑版本 -->
    {% if stat_type == 'settlement' and settlement_stats %}
    <div class="detail-card">
        <div class="card-title">
            <i class="fas fa-calculator"></i>
            <span>结算统计详情（全部）</span>
        </div>
        
        <div class="stat-grid-compact">
            <div class="stat-item-compact">
                <div class="label">结算总数</div>
                <div class="value">{{ settlement_stats.total_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">结算总额（元）</div>
                <div class="value">{{ settlement_stats.total_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">平均金额（元）</div>
                <div class="value">{{ settlement_stats.avg_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">结算率</div>
                <div class="value {% if settlement_stats.settlement_rate >= 80 %}success{% elif settlement_stats.settlement_rate >= 50 %}warning{% else %}danger{% endif %}">
                    {{ settlement_stats.settlement_rate }}%
                </div>
            </div>
            <div class="stat-item-compact">
                <div class="label">待结算合同</div>
                <div class="value warning">{{ settlement_stats.pending_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">待结算金额（元）</div>
                <div class="value warning">{{ settlement_stats.pending_amount|floatformat:2 }}</div>
            </div>
        </div>

        <!-- 年度结算趋势 -->
        {% if settlement_stats.yearly_data %}
        <div class="chart-section">
            <h5>年度结算趋势</h5>
            <div class="chart-container" style="height: 350px;">
                <canvas id="settlementYearlyChart"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- 结算与合同差异分析 -->
        {% if settlement_stats.variance_analysis %}
        <div class="chart-section">
            <h5>结算与合同差异分析（前10条）</h5>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>结算编号</th>
                        <th>合同金额（元）</th>
                        <th>结算金额（元）</th>
                        <th>差异（元）</th>
                        <th>差异率</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in settlement_stats.variance_analysis %}
                    <tr>
                        <td>{{ item.settlement_code }}</td>
                        <td>{{ item.contract_amount|floatformat:2 }}</td>
                        <td>{{ item.settlement_amount|floatformat:2 }}</td>
                        <td class="{% if item.variance > 0 %}text-danger{% elif item.variance < 0 %}text-success{% endif %}">
                            {{ item.variance|floatformat:2 }}
                        </td>
                        <td class="{% if item.variance_rate > 0 %}text-danger{% elif item.variance_rate < 0 %}text-success{% endif %}">
                            {{ item.variance_rate }}%
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- 年度对比 - 紧凑版本 -->
    {% if stat_type == 'comparison' and comparison_data %}
    <div class="comparison-selector">
        <form method="get" class="form-inline">
            <input type="hidden" name="type" value="comparison">
            <label class="mr-2"><strong>选择对比年份：</strong></label>
            {% for year in available_years %}
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="comparison_years" value="{{ year }}" 
                       id="year{{ year }}" {% if year in comparison_years %}checked{% endif %}>
                <label class="form-check-label" for="year{{ year }}">{{ year }}年</label>
            </div>
            {% endfor %}
            <button type="submit" class="btn btn-sm btn-primary ml-3">
                <i class="fas fa-sync"></i> 更新对比
            </button>
        </form>
    </div>

    <div class="detail-card">
        <div class="card-title">
            <i class="fas fa-chart-line"></i>
            <span>年度数据对比</span>
        </div>
        
        <!-- 采购对比 -->
        <div class="chart-section">
            <h5>采购数据对比</h5>
            <div class="chart-container" style="height: 350px;">
            <canvas id="procurementComparisonChart"></canvas>
            </div>
        </div>
        
        <!-- 合同对比 -->
        <div class="chart-section">
            <h5>合同数据对比</h5>
            <div class="chart-container" style="height: 350px;">
            <canvas id="contractComparisonChart"></canvas>
            </div>
        </div>
        
        <!-- 付款对比 -->
        <div class="chart-section">
            <h5>付款数据对比</h5>
            <div class="chart-container" style="height: 350px;">
            <canvas id="paymentComparisonChart"></canvas>
            </div>
        </div>

        <!-- 对比数据表格 -->
        <div class="chart-section">
            <h5>详细对比数据</h5>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>年份</th>
                        <th>采购项目数</th>
                        <th>采购金额（元）</th>
                        <th>合同数量</th>
                        <th>合同金额（元）</th>
                        <th>付款笔数</th>
                        <th>付款金额（元）</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in comparison_data.rows %}
                    <tr>
                        <td><strong>{{ row.year }}年</strong></td>
                        <td>{{ row.procurement_count|default:0 }}</td>
                        <td>{{ row.procurement_amount|default:0|floatformat:2 }}</td>
                        <td>{{ row.contract_count|default:0 }}</td>
                        <td>{{ row.contract_amount|default:0|floatformat:2 }}</td>
                        <td>{{ row.payment_count|default:0 }}</td>
                        <td>{{ row.payment_amount|default:0|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{% static 'js/charts.js' %}"></script>
<script>
// Chart.js 配置
Chart.defaults.font.family = "'Segoe UI', 'Microsoft YaHei', sans-serif";

{% if stat_type == 'procurement' and procurement_stats %}
    // 采购方式饼图
    {% if procurement_stats.method_distribution %}
    new Chart(document.getElementById('procurementMethodChart'), {
        type: 'pie',
        data: {
            labels: [{% for item in procurement_stats.method_distribution %}'{{ item.method }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for item in procurement_stats.method_distribution %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6c757d']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right' }
            }
        }
    });
    {% endif %}

    // 月度趋势图
    {% if procurement_stats.monthly_trend %}
    new Chart(document.getElementById('procurementTrendChart'), {
        type: 'line',
        data: {
            labels: [{% for item in procurement_stats.monthly_trend %}'{{ item.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '采购数量',
                data: [{% for item in procurement_stats.monthly_trend %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                yAxisID: 'y'
            }, {
                label: '采购金额（元）',
                data: [{% for item in procurement_stats.monthly_trend %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '数量' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });
    {% endif %}
{% endif %}

{% if stat_type == 'contract' and contract_stats %}
    // 合同类型饼图
    {% if contract_stats.type_distribution %}
    new Chart(document.getElementById('contractTypeChart'), {
        type: 'pie',
        data: {
            labels: [{% for item in contract_stats.type_distribution %}'{{ item.type }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for item in contract_stats.type_distribution %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: ['#007bff', '#28a745', '#ffc107']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
        }
    });
    {% endif %}

    // 合同来源饼图
    {% if contract_stats.source_distribution %}
    new Chart(document.getElementById('contractSourceChart'), {
        type: 'pie',
        data: {
            labels: [{% for item in contract_stats.source_distribution %}'{{ item.source }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for item in contract_stats.source_distribution %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: ['#17a2b8', '#6c757d']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
        }
    });
    {% endif %}

    // 月度趋势图
    {% if contract_stats.monthly_trend %}
    new Chart(document.getElementById('contractTrendChart'), {
        type: 'line',
        data: {
            labels: [{% for item in contract_stats.monthly_trend %}'{{ item.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '合同数量',
                data: [{% for item in contract_stats.monthly_trend %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                yAxisID: 'y'
            }, {
                label: '合同金额（元）',
                data: [{% for item in contract_stats.monthly_trend %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '数量' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });
    {% endif %}
{% endif %}

{% if stat_type == 'payment' and payment_stats %}
    // 月度付款趋势
    {% if payment_stats.monthly_trend %}
    new Chart(document.getElementById('paymentTrendChart'), {
        type: 'bar',
        data: {
            labels: [{% for item in payment_stats.monthly_trend %}'{{ item.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '付款笔数',
                data: [{% for item in payment_stats.monthly_trend %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(0, 123, 255, 0.7)',
                yAxisID: 'y'
            }, {
                label: '付款金额（元）',
                data: [{% for item in payment_stats.monthly_trend %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(40, 167, 69, 0.7)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '笔数' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });
    {% endif %}

    // 结算状态饼图
    new Chart(document.getElementById('settlementStatusChart'), {
        type: 'doughnut',
        data: {
            labels: ['已结算', '未结算'],
            datasets: [{
                data: [{{ payment_stats.settled_count }}, {{ payment_stats.unsettled_count }}],
                backgroundColor: ['#28a745', '#ffc107']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
        }
    });
{% endif %}

{% if stat_type == 'settlement' and settlement_stats %}
    // 年度结算趋势
    {% if settlement_stats.yearly_data %}
    new Chart(document.getElementById('settlementYearlyChart'), {
        type: 'bar',
        data: {
            labels: [{% for item in settlement_stats.yearly_data %}'{{ item.year }}年'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '结算数量',
                data: [{% for item in settlement_stats.yearly_data %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(0, 123, 255, 0.7)',
                yAxisID: 'y'
            }, {
                label: '结算金额（元）',
                data: [{% for item in settlement_stats.yearly_data %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(40, 167, 69, 0.7)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '数量' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });
    {% endif %}
{% endif %}

{% if stat_type == 'comparison' and comparison_data %}
    // 采购对比图
    new Chart(document.getElementById('procurementComparisonChart'), {
        type: 'bar',
        data: {
            labels: [{% for year in comparison_data.years %}'{{ year }}年'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '采购数量',
                data: [{% for item in comparison_data.procurement %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(0, 123, 255, 0.7)',
                yAxisID: 'y'
            }, {
                label: '采购金额（元）',
                data: [{% for item in comparison_data.procurement %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(40, 167, 69, 0.7)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '数量' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });

    // 合同对比图
    new Chart(document.getElementById('contractComparisonChart'), {
        type: 'bar',
        data: {
            labels: [{% for year in comparison_data.years %}'{{ year }}年'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '合同数量',
                data: [{% for item in comparison_data.contract %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(23, 162, 184, 0.7)',
                yAxisID: 'y'
            }, {
                label: '合同金额（元）',
                data: [{% for item in comparison_data.contract %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(255, 193, 7, 0.7)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '数量' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });

    // 付款对比图
    new Chart(document.getElementById('paymentComparisonChart'), {
        type: 'bar',
        data: {
            labels: [{% for year in comparison_data.years %}'{{ year }}年'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '付款笔数',
                data: [{% for item in comparison_data.payment %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(220, 53, 69, 0.7)',
                yAxisID: 'y'
            }, {
                label: '付款金额（元）',
                data: [{% for item in comparison_data.payment %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(108, 117, 125, 0.7)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '笔数' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });
{% endif %}

// 年份和项目筛选器 - 自动提交表单
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filterForm');
    if (!filterForm) return;
    
    const filterSelects = document.querySelectorAll('.filter-select');
    
    filterSelects.forEach(function(select) {
        select.addEventListener('change', function() {
            console.log('筛选器变化:', select.name, '=', select.value);
            
            // 显示加载提示
            const container = document.querySelector('.monitoring-statistics');
            if (container) {
                container.style.opacity = '0.6';
                container.style.pointerEvents = 'none';
            }
            
            // 立即提交表单
            filterForm.submit();
        });
    });
    
    // 调试信息：显示当前筛选器状态
    console.log('筛选器初始化完成');
    filterSelects.forEach(function(select) {
        console.log('筛选器:', select.name, '当前值:', select.value);
    });
});
</script>
{% endblock %}