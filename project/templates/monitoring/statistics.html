
{% extends "base.html" %}
{% load static %}

{% block title %}业务统计分析 - 项目采购与成本管理系统{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
        --primary-color: #1890ff;
        --bg-color: #f0f2f5;
        --card-bg: #ffffff;
        --text-primary: #262626;
        --text-secondary: #595959;
        --border-color: #e8e8e8;
        --success-color: #52c41a;
        --error-color: #ff4d4f;
        --warning-color: #faad14;
        --info-color: #1890ff;
        --purple-color: #722ed1;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        --font-family: 'Source Han Sans', 'PingFang SC', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    }

    body {
        background-color: var(--bg-color);
        font-family: var(--font-family);
    }

    .dashboard-container {
        max-width: 1800px;
        margin: 0 auto;
        padding: 24px;
    }

    /* 页面头部 */
    .page-header {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        gap: 16px;
    }

    .page-title {
        font-size: 28px;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 12px;
        color: var(--text-primary);
    }
    
    .breadcrumb {
        font-size: 13px;
        color: var(--text-secondary);
        margin-top: 8px;
    }

    .breadcrumb a {
        color: var(--primary-color);
        text-decoration: none;
    }

    .breadcrumb a:hover { 
        text-decoration: underline; 
    }

    /* 筛选卡片 */
    .filter-card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 12px 16px;
        box-shadow: var(--shadow);
        display: flex;
        align-items: center;
        gap: 16px;
    }

    .filter-controls {
        display: flex;
        align-items: center;
        gap: 16px;
        flex-wrap: wrap;
    }

    .filter-controls label {
        font-size: 14px;
        color: var(--text-secondary);
        font-weight: 500;
        white-space: nowrap;
        margin: 0;
    }

    .filter-controls select {
        padding: 8px 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        font-size: 15px;
        min-width: 150px;
        transition: border-color 0.3s, box-shadow 0.3s;
        background: white;
    }

    .filter-controls select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.1);
    }

    /* KPI 卡片 */

        <!-- 付款概览卡片 -->
        <div class="stat-card-compact">
            <div class="card-header">
                <i class="fas fa-money-bill-wave"></i>
                <h4>付款概览（{{ selected_year }}{% if selected_year != '全部' %}年{% endif %}）</h4>
            </div>
            <div class="stat-list">
                <div class="stat-row">
                    <span class="label">付款笔数</span>
                    <span class="value">{{ payment_stats.total_count }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">付款总额</span>
                    <span class="value">{{ payment_stats.total_amount|floatformat:2 }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">平均金额</span>
                    <span class="value">{{ payment_stats.avg_amount|floatformat:2 }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">已结算</span>
                    <span class="value success">{{ payment_stats.settled_count }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">剩余支付</span>
                    <span class="value warning">{{ payment_stats.estimated_remaining|floatformat:2 }}</span>
                </div>
            </div>
        </div>

        <!-- 结算概览卡片 -->
        <div class="stat-card-compact">
            <div class="card-header">
                <i class="fas fa-calculator"></i>
                <h4>结算概览（全部）</h4>
            </div>
            <div class="stat-list">
                <div class="stat-row">
                    <span class="label">结算总数</span>
                    <span class="value">{{ settlement_stats.total_count }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">结算总额</span>
                    <span class="value">{{ settlement_stats.total_amount|floatformat:2 }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">平均金额</span>
                    <span class="value">{{ settlement_stats.avg_amount|floatformat:2 }}</span>
                </div>
                <div class="stat-row">
                    <span class="label">结算率</span>
                    <span class="value {% if settlement_stats.settlement_rate >= 80 %}success{% elif settlement_stats.settlement_rate >= 50 %}warning{% else %}danger{% endif %}">{{ settlement_stats.settlement_rate }}%</span>
                </div>
                <div class="stat-row">
                    <span class="label">待结算</span>
                    <span class="value warning">{{ settlement_stats.pending_count }}</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 采购统计详情 - 紧凑版本 -->
    {% if stat_type == 'procurement' and procurement_stats %}
    <div class="detail-card">
        <div class="card-title">
            <i class="fas fa-shopping-cart"></i>
            <span>采购统计详情（{{ procurement_stats.year }}年）</span>
        </div>
        
        <div class="stat-grid-compact">
            <div class="stat-item-compact">
                <div class="label">项目总数</div>
                <div class="value">{{ procurement_stats.total_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">预算总额（元）</div>
                <div class="value">{{ procurement_stats.total_budget|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">中标总额（元）</div>
                <div class="value success">{{ procurement_stats.total_winning|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">节约金额（元）</div>
                <div class="value success">{{ procurement_stats.savings_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">节约率</div>
                <div class="value success">{{ procurement_stats.savings_rate }}%</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">平均周期</div>
                <div class="value">{{ procurement_stats.avg_cycle_days }} 天</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">已归档项目</div>
                <div class="value">{{ procurement_stats.archived_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">归档率</div>
                <div class="value {% if procurement_stats.archive_rate >= 80 %}success{% elif procurement_stats.archive_rate >= 50 %}warning{% else %}danger{% endif %}">
                    {{ procurement_stats.archive_rate }}%
                </div>
            </div>
        </div>

        <!-- 采购方式分布 -->
        {% if procurement_stats.method_distribution %}
        <div class="chart-section">
            <h5>采购方式分布</h5>
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container chart-container--panel">
                    <canvas id="procurementMethodChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="table-responsive table-responsive--elevated">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>采购方式</th>
                                <th>数量</th>
                                <th>金额（元）</th>
                                <th>占比</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in procurement_stats.method_distribution %}
                            <tr>
                                <td>{{ item.method }}</td>
                                <td>{{ item.count }}</td>
                                <td>{{ item.amount|floatformat:2 }}</td>
                                <td>{{ item.percentage }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>
        {% endif %}

        <!-- 月度趋势 -->
        {% if procurement_stats.monthly_trend %}
        <div class="chart-section">
            <h5>月度采购趋势</h5>
            <div class="chart-container chart-container--panel chart-container--tall">
                <canvas id="procurementTrendChart"></canvas>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- 合同统计详情 - 紧凑版本 -->
    {% if stat_type == 'contract' and contract_stats %}
    <div class="detail-card">
        <div class="card-title">
            <i class="fas fa-file-contract"></i>
            <span>合同统计详情（{{ contract_stats.year }}年）</span>
        </div>
        
        <div class="stat-grid-compact">
            <div class="stat-item-compact">
                <div class="label">合同总数</div>
                <div class="value">{{ contract_stats.total_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">合同总额（元）</div>
                <div class="value">{{ contract_stats.total_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">主合同数量</div>
                <div class="value">{{ contract_stats.main_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">主合同金额（元）</div>
                <div class="value">{{ contract_stats.main_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">补充协议数量</div>
                <div class="value">{{ contract_stats.supplement_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">补充协议金额（元）</div>
                <div class="value">{{ contract_stats.supplement_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">已归档合同</div>
                <div class="value">{{ contract_stats.archived_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">归档率</div>
                <div class="value {% if contract_stats.archive_rate >= 80 %}success{% elif contract_stats.archive_rate >= 50 %}warning{% else %}danger{% endif %}">
                    {{ contract_stats.archive_rate }}%
                </div>
            </div>
        </div>

        <!-- 合同类型分布 -->
        {% if contract_stats.type_distribution %}
        <div class="chart-section">
            <h5>合同类型分布</h5>
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container chart-container--panel">
                    <canvas id="contractTypeChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="table-responsive table-responsive--elevated">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>合同类型</th>
                                <th>数量</th>
                                <th>金额（元）</th>
                                <th>占比</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in contract_stats.type_distribution %}
                            <tr>
                                <td>{{ item.type }}</td>
                                <td>{{ item.count }}</td>
                                <td>{{ item.amount|floatformat:2 }}</td>
                                <td>{{ item.percentage }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div>
        {% endif %}

        <!-- 合同来源分布 -->
        {% if contract_stats.source_distribution %}
        <div class="chart-section">
            <h5>合同来源分布</h5>
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container chart-container--panel">
                    <canvas id="contractSourceChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="table-responsive table-responsive--elevated">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>合同来源</th>
                                <th>数量</th>
                                <th>金额（元）</th>
                                <th>占比</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in contract_stats.source_distribution %}
                            <tr>
                                <td>{{ item.source }}</td>
                                <td>{{ item.count }}</td>
                                <td>{{ item.amount|floatformat:2 }}</td>
                                <td>{{ item.percentage }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        </div>
        {% endif %}

        <!-- 月度趋势 -->
        {% if contract_stats.monthly_trend %}
        <div class="chart-section">
            <h5>月度签约趋势</h5>
            <div class="chart-container chart-container--panel chart-container--tall">
                <canvas id="contractTrendChart"></canvas>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- 付款统计详情 - 紧凑版本 -->
    {% if stat_type == 'payment' and payment_stats %}
    <div class="detail-card">
        <div class="card-title">
            <i class="fas fa-money-bill-wave"></i>
            <span>付款统计详情（{{ payment_stats.year }}年）</span>
        </div>
        
        <div class="stat-grid-compact">
            <div class="stat-item-compact">
                <div class="label">付款笔数</div>
                <div class="value">{{ payment_stats.total_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">付款总额（元）</div>
                <div class="value">{{ payment_stats.total_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">平均金额（元）</div>
                <div class="value">{{ payment_stats.avg_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">最大单笔（元）</div>
                <div class="value">{{ payment_stats.max_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">最小单笔（元）</div>
                <div class="value">{{ payment_stats.min_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">已结算笔数</div>
                <div class="value success">{{ payment_stats.settled_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">已结算金额（元）</div>
                <div class="value success">{{ payment_stats.settled_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">未结算笔数</div>
                <div class="value warning">{{ payment_stats.unsettled_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">未结算金额（元）</div>
                <div class="value warning">{{ payment_stats.unsettled_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">剩余支付（元）</div>
                <div class="value warning">{{ payment_stats.estimated_remaining|floatformat:2 }}</div>
            </div>
        </div>

        <!-- 月度付款趋势 -->
        {% if payment_stats.monthly_trend %}
        <div class="chart-section">
            <h5>月度付款趋势</h5>
            <div class="chart-container chart-container--panel chart-container--tall">
                <canvas id="paymentTrendChart"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- 结算状态分布 -->
        <div class="chart-section">
            <h5>结算状态分布</h5>
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container chart-container--panel">
                    <canvas id="settlementStatusChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="table-responsive table-responsive--elevated">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>状态</th>
                                <th>笔数</th>
                                <th>金额（元）</th>
                            </tr>
                        
</thead>
                        <tbody>
                            <tr>
                                <td>已结算</td>
                                <td>{{ payment_stats.settled_count }}</td>
                                <td>{{ payment_stats.settled_amount|floatformat:2 }}</td>
                            </tr>
                            <tr>
                                <td>未结算</td>
                                <td>{{ payment_stats.unsettled_count }}</td>
                                <td>{{ payment_stats.unsettled_amount|floatformat:2 }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 结算统计详情 - 紧凑版本 -->
    {% if stat_type == 'settlement' and settlement_stats %}
    <div class="detail-card">
        <div class="card-title">
            <i class="fas fa-calculator"></i>
            <span>结算统计详情（全部）</span>
        </div>
        
        <div class="stat-grid-compact">
            <div class="stat-item-compact">
                <div class="label">结算总数</div>
                <div class="value">{{ settlement_stats.total_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">结算总额（元）</div>
                <div class="value">{{ settlement_stats.total_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">平均金额（元）</div>
                <div class="value">{{ settlement_stats.avg_amount|floatformat:2 }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">结算率</div>
                <div class="value {% if settlement_stats.settlement_rate >= 80 %}success{% elif settlement_stats.settlement_rate >= 50 %}warning{% else %}danger{% endif %}">
                    {{ settlement_stats.settlement_rate }}%
                </div>
            </div>
            <div class="stat-item-compact">
                <div class="label">待结算合同</div>
                <div class="value warning">{{ settlement_stats.pending_count }}</div>
            </div>
            <div class="stat-item-compact">
                <div class="label">待结算金额（元）</div>
                <div class="value warning">{{ settlement_stats.pending_amount|floatformat:2 }}</div>
            </div>
        </div>

        <!-- 年度结算趋势 -->
        {% if settlement_stats.yearly_data %}
        <div class="chart-section">
            <h5>年度结算趋势</h5>
            <div class="chart-container chart-container--panel chart-container--tall">
                <canvas id="settlementYearlyChart"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- 结算与合同差异分析 -->
        {% if settlement_stats.variance_analysis %}
        <div class="chart-section">
            <h5>结算与合同差异分析（前10条）</h5>
        <div class="table-responsive table-responsive--elevated">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>结算编号</th>
                        <th>合同金额（元）</th>
                        <th>结算金额（元）</th>
                        <th>差异（元）</th>
                        <th>差异率</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in settlement_stats.variance_analysis %}
                    <tr>
                        <td>{{ item.settlement_code }}</td>
                        <td>{{ item.contract_amount|floatformat:2 }}</td>
                        <td>{{ item.settlement_amount|floatformat:2 }}</td>
                        <td class="{% if item.variance > 0 %}text-danger{% elif item.variance < 0 %}text-success{% endif %}">
                            {{ item.variance|floatformat:2 }}
                        </td>
                        <td class="{% if item.variance_rate > 0 %}text-danger{% elif item.variance_rate < 0 %}text-success{% endif %}">
                            {{ item.variance_rate }}%
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- 年度对比 - 紧凑版本 -->
    {% if stat_type == 'comparison' and comparison_data %}
    <div class="comparison-selector">
        <form method="get" class="form-inline">
            <input type="hidden" name="type" value="comparison">
            <label class="mr-2"><strong>选择对比年份：</strong></label>
            {% for year in available_years %}
            <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" name="comparison_years" value="{{ year }}" 
                       id="year{{ year }}" {% if year in comparison_years %}checked{% endif %}>
                <label class="form-check-label" for="year{{ year }}">{{ year }}年</label>
            </div>
            {% endfor %}
            <button type="submit" class="btn btn-sm btn-primary ml-3">
                <i class="fas fa-sync"></i> 更新对比
            </button>
        </form>
    </div>

    <div class="detail-card">
        <div class="card-title">
            <i class="fas fa-chart-line"></i>
            <span>年度数据对比</span>
        </div>
        
        <!-- 采购对比 -->
        <div class="chart-section">
            <h5>采购数据对比</h5>
            <div class="chart-container chart-container--panel chart-container--tall">
            <canvas id="procurementComparisonChart"></canvas>
            </div>
        </div>
        
        <!-- 合同对比 -->
        <div class="chart-section">
            <h5>合同数据对比</h5>
            <div class="chart-container chart-container--panel chart-container--tall">
            <canvas id="contractComparisonChart"></canvas>
            </div>
        </div>
        
        <!-- 付款对比 -->
        <div class="chart-section">
            <h5>付款数据对比</h5>
            <div class="chart-container chart-container--panel chart-container--tall">
            <canvas id="paymentComparisonChart"></canvas>
            </div>
        </div>

        <!-- 对比数据表格 -->
        <div class="chart-section">
            <h5>详细对比数据</h5>
        <div class="table-responsive table-responsive--elevated">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>年份</th>
                        <th>采购项目数</th>
                        <th>采购金额（元）</th>
                        <th>合同数量</th>
                        <th>合同金额（元）</th>
                        <th>付款笔数</th>
                        <th>付款金额（元）</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in comparison_data.rows %}
                    <tr>
                        <td><strong>{{ row.year }}年</strong></td>
                        <td>{{ row.procurement_count|default:0 }}</td>
                        <td>{{ row.procurement_amount|default:0|floatformat:2 }}</td>
                        <td>{{ row.contract_count|default:0 }}</td>
                        <td>{{ row.contract_amount|default:0|floatformat:2 }}</td>
                        <td>{{ row.payment_count|default:0 }}</td>
                        <td>{{ row.payment_amount|default:0|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{% static 'js/charts.js' %}"></script>
<script>
// Chart.js 配置
Chart.defaults.font.family = "'Segoe UI', 'Microsoft YaHei', sans-serif";

{% if stat_type == 'procurement' and procurement_stats %}
    // 采购方式饼图
    {% if procurement_stats.method_distribution %}
    new Chart(document.getElementById('procurementMethodChart'), {
        type: 'pie',
        data: {
            labels: [{% for item in procurement_stats.method_distribution %}'{{ item.method }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for item in procurement_stats.method_distribution %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6c757d']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right' }
            }
        }
    });
    {% endif %}

    // 月度趋势图
    {% if procurement_stats.monthly_trend %}
    new Chart(document.getElementById('procurementTrendChart'), {
        type: 'line',
        data: {
            labels: [{% for item in procurement_stats.monthly_trend %}'{{ item.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '采购数量',
                data: [{% for item in procurement_stats.monthly_trend %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                yAxisID: 'y'
            }, {
                label: '采购金额（元）',
                data: [{% for item in procurement_stats.monthly_trend %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '数量' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });
    {% endif %}
{% endif %}

{% if stat_type == 'contract' and contract_stats %}
    // 合同类型饼图
    {% if contract_stats.type_distribution %}
    new Chart(document.getElementById('contractTypeChart'), {
        type: 'pie',
        data: {
            labels: [{% for item in contract_stats.type_distribution %}'{{ item.type }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for item in contract_stats.type_distribution %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: ['#007bff', '#28a745', '#ffc107']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
        }
    });
    {% endif %}

    // 合同来源饼图
    {% if contract_stats.source_distribution %}
    new Chart(document.getElementById('contractSourceChart'), {
        type: 'pie',
        data: {
            labels: [{% for item in contract_stats.source_distribution %}'{{ item.source }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                data: [{% for item in contract_stats.source_distribution %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: ['#17a2b8', '#6c757d']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
        }
    });
    {% endif %}

    // 月度趋势图
    {% if contract_stats.monthly_trend %}
    new Chart(document.getElementById('contractTrendChart'), {
        type: 'line',
        data: {
            labels: [{% for item in contract_stats.monthly_trend %}'{{ item.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '合同数量',
                data: [{% for item in contract_stats.monthly_trend %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                yAxisID: 'y'
            }, {
                label: '合同金额（元）',
                data: [{% for item in contract_stats.monthly_trend %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '数量' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });
    {% endif %}
{% endif %}

{% if stat_type == 'payment' and payment_stats %}
    // 月度付款趋势
    {% if payment_stats.monthly_trend %}
    new Chart(document.getElementById('paymentTrendChart'), {
        type: 'bar',
        data: {
            labels: [{% for item in payment_stats.monthly_trend %}'{{ item.month }}'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '付款笔数',
                data: [{% for item in payment_stats.monthly_trend %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(0, 123, 255, 0.7)',
                yAxisID: 'y'
            }, {
                label: '付款金额（元）',
                data: [{% for item in payment_stats.monthly_trend %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(40, 167, 69, 0.7)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '笔数' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });
    {% endif %}

    // 结算状态饼图
    new Chart(document.getElementById('settlementStatusChart'), {
        type: 'doughnut',
        data: {
            labels: ['已结算', '未结算'],
            datasets: [{
                data: [{{ payment_stats.settled_count }}, {{ payment_stats.unsettled_count }}],
                backgroundColor: ['#28a745', '#ffc107']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'right' } }
        }
    });
{% endif %}

{% if stat_type == 'settlement' and settlement_stats %}
    // 年度结算趋势
    {% if settlement_stats.yearly_data %}
    new Chart(document.getElementById('settlementYearlyChart'), {
        type: 'bar',
        data: {
            labels: [{% for item in settlement_stats.yearly_data %}'{{ item.year }}年'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '结算数量',
                data: [{% for item in settlement_stats.yearly_data %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(0, 123, 255, 0.7)',
                yAxisID: 'y'
            }, {
                label: '结算金额（元）',
                data: [{% for item in settlement_stats.yearly_data %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(40, 167, 69, 0.7)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '数量' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });
    {% endif %}
{% endif %}

{% if stat_type == 'comparison' and comparison_data %}
    // 采购对比图
    new Chart(document.getElementById('procurementComparisonChart'), {
        type: 'bar',
        data: {
            labels: [{% for year in comparison_data.years %}'{{ year }}年'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '采购数量',
                data: [{% for item in comparison_data.procurement %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(0, 123, 255, 0.7)',
                yAxisID: 'y'
            }, {
                label: '采购金额（元）',
                data: [{% for item in comparison_data.procurement %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(40, 167, 69, 0.7)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '数量' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });

    // 合同对比图
    new Chart(document.getElementById('contractComparisonChart'), {
        type: 'bar',
        data: {
            labels: [{% for year in comparison_data.years %}'{{ year }}年'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '合同数量',
                data: [{% for item in comparison_data.contract %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(23, 162, 184, 0.7)',
                yAxisID: 'y'
            }, {
                label: '合同金额（元）',
                data: [{% for item in comparison_data.contract %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(255, 193, 7, 0.7)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '数量' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });

    // 付款对比图
    new Chart(document.getElementById('paymentComparisonChart'), {
        type: 'bar',
        data: {
            labels: [{% for year in comparison_data.years %}'{{ year }}年'{% if not forloop.last %},{% endif %}{% endfor %}],
            datasets: [{
                label: '付款笔数',
                data: [{% for item in comparison_data.payment %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(220, 53, 69, 0.7)',
                yAxisID: 'y'
            }, {
                label: '付款金额（元）',
                data: [{% for item in comparison_data.payment %}{{ item.amount }}{% if not forloop.last %},{% endif %}{% endfor %}],
                backgroundColor: 'rgba(108, 117, 125, 0.7)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { type: 'linear', position: 'left', title: { display: true, text: '笔数' } },
                y1: { type: 'linear', position: 'right', title: { display: true, text: '金额（元）' }, grid: { drawOnChartArea: false } }
            }
        }
    });
{% endif %}

// 年份和项目筛选器 - 自动提交表单
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('statsFilterForm');
    if (!filterForm) return;
    
    const filterSelects = document.querySelectorAll('.filter-select');
    
    filterSelects.forEach(function(select) {
        select.addEventListener('change', function() {
            // 显示加载提示
            const container = document.querySelector('.monitoring-statistics');
            if (container) {
                container.style.opacity = '0.6';
                container.style.pointerEvents = 'none';
            }
            
            // 立即提交表单
            filterForm.submit();
        });
    });
});
</script>
{% endblock %}
