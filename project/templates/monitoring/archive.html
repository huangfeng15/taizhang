
{% extends "base.html" %}
{% load static %}
{% load monitor_filters %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    .view-mode-selector {
        display: inline-flex;
        border-radius: 0.375rem;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .view-mode-btn {
        padding: 0.5rem 1.5rem;
        border: none;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
    }
    .view-mode-btn:hover {
        background: #f8f9fa;
    }
    .view-mode-btn.active {
        background: #0d6efd;
        color: white;
    }
    .stats-card {
        border-left: 4px solid;
        transition: transform 0.2s;
        height: 100%;
    }
    .stats-card .card-body { padding: 0.75rem 1rem; }
    .stats-card h2, .stats-card h3 { margin: 0.25rem 0; }
    .stats-card h6 { margin-bottom: 0.25rem; }
    .stats-card:hover {
        transform: translateY(-2px);
    }
    .stats-card.procurement {
        border-left-color: #0d6efd;
    }
    .stats-card.contract {
        border-left-color: #198754;
    }
    .stats-card.overall {
        border-left-color: #6c757d;
    }
    /* Equal height helpers for cards */
    .equal-col { display: flex; }
    .equal-col .card { height: 100%; width: 100%; }
    .trend-chart-container {
        height: 400px;
        position: relative;
    }
    .trend-empty-overlay {
        position: absolute;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(255,255,255,0.8);
        color: #6c757d;
        font-size: 14px;
        z-index: 5;
        text-align: center;
        padding: 1rem;
    }
    .progress { height: 20px; }
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- 页面标题和视图切换 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">{{ page_title }}</h2>
        <div class="view-mode-selector">
            <button type="button" class="view-mode-btn {% if view_mode == 'project' %}active{% endif %}" data-mode="project">
                <i class="fas fa-project-diagram"></i> 项目视图
            </button>
            <button type="button" class="view-mode-btn {% if view_mode == 'person' %}active{% endif %}" data-mode="person">
                <i class="fas fa-user"></i> 个人视图
            </button>
        </div>
    </div>

    <!-- 当前筛选状态 -->
    <div class="alert alert-info">
        <i class="fas fa-filter"></i>
        当前筛选：{{ filter_config.display_year|default:"全部年度" }}
        {% if filter_config.selected_project_value %} · {{ filter_config.selected_project_value }}{% else %} · 全部项目{% endif %}
    </div>

    <!-- 汇总统计卡片 -->
    {% if overview_data %}
    <div class="row mb-4">
        <div class="col-md-3 equal-col">
            <div class="card text-center stats-card overall h-100 w-100">
                <div class="card-body">
                    <h6 class="text-muted">{% if view_mode == 'project' %}项目总数{% else %}经办人数{% endif %}</h6>
                    <h2 class="text-primary">
                        {% if view_mode == 'project' %}
                            {{ overview_data.summary.project_count }}
                        {% else %}
                            {{ overview_data.summary.person_count }}
                        {% endif %}
                    </h2>
                </div>
            </div>
        </div>
        <div class="col-md-3 equal-col">
            <div class="card text-center stats-card procurement h-100 w-100">
                <div class="card-body">
                    <h6 class="text-muted">采购情况</h6>
                    <h3>{{ overview_data.summary.procurement_archived }}/{{ overview_data.summary.procurement_total }}</h3>
                    <small class="text-muted">已归档/总数</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 equal-col">
            <div class="card text-center stats-card contract h-100 w-100">
                <div class="card-body">
                    <h6 class="text-muted">合同情况</h6>
                    <h3>{{ overview_data.summary.contract_archived }}/{{ overview_data.summary.contract_total }}</h3>
                    <small class="text-muted">已归档/总数</small>
                </div>
            </div>
        </div>
        <div class="col-md-3 equal-col">
            <div class="card text-center stats-card overall h-100 w-100">
                <div class="card-body">
                    <h6 class="text-muted">综合归档率</h6>
                    <h2 class="text-success">{{ overview_data.summary.overall_archive_rate }}%</h2>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- 数据列表表格 -->
    {% if overview_data %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                {% if view_mode == 'project' %}项目归档统计明细{% else %}经办人归档统计明细{% endif %}
            </h5>
        </div>
        <div class="card-body p-0">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>{% if view_mode == 'project' %}项目名称{% else %}经办人{% endif %}</th>
                        <th>采购数量</th>
                        <th>采购归档周期</th>
                        <th>合同数量</th>
                        <th>合同归档周期</th>
                        <th>综合归档率</th>
                        {% if view_mode == 'person' %}<th>负责项目</th>{% endif %}
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% if view_mode == 'project' %}
                        {% for project in overview_data.projects %}
                        <tr>
                            <td><strong>{{ project.project_code }}</strong><br><small>{{ project.project_name }}</small></td>
                            <td>{{ project.procurement_archived }}/{{ project.procurement_count }}</td>
                            <td>{{ project.procurement_avg_cycle }}天<br><small class="text-muted">({{ project.procurement_on_time_rate }}%)</small></td>
                            <td>{{ project.contract_archived }}/{{ project.contract_count }}</td>
                            <td>{{ project.contract_avg_cycle }}天<br><small class="text-muted">({{ project.contract_on_time_rate }}%)</small></td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" style="width: {{ project.overall_archive_rate }}%" 
                                         aria-valuenow="{{ project.overall_archive_rate }}" aria-valuemin="0" aria-valuemax="100">
                                        {{ project.overall_archive_rate }}%
                                    </div>
                                </div>
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-primary view-detail-btn" data-target="{{ project.project_code }}">
                                    <i class="fas fa-eye"></i> 查看详情
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% else %}
                        {% for person in overview_data.persons %}
                        <tr>
                            <td><strong>{{ person.handler_name }}</strong></td>
                            <td>{{ person.procurement_archived }}/{{ person.procurement_count }}</td>
                            <td>{{ person.procurement_avg_cycle }}天<br><small class="text-muted">({{ person.procurement_on_time_rate }}%)</small></td>
                            <td>{{ person.contract_archived }}/{{ person.contract_count }}</td>
                            <td>{{ person.contract_avg_cycle }}天<br><small class="text-muted">({{ person.contract_on_time_rate }}%)</small></td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" style="width: {{ person.overall_archive_rate }}%"
                                         aria-valuenow="{{ person.overall_archive_rate }}" aria-valuemin="0" aria-valuemax="100">
                                        {{ person.overall_archive_rate }}%
                                    </div>
                                </div>
                            </td>
                            <td>{{ person.project_count }}个</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-outline-primary view-detail-btn" data-target="{{ person.handler_name }}">
                                    <i class="fas fa-eye"></i> 查看详情
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- 个人视图：多个人趋势图（可切换采购/合同） -->
    {% if view_mode == 'person' %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-chart-line"></i> 所有经办人归档周期趋势（多个人）
            </h5>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="mt-proc-tab" data-bs-toggle="tab" data-bs-target="#mt-proc" type="button" role="tab">采购</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="mt-cont-tab" data-bs-toggle="tab" data-bs-target="#mt-cont" type="button" role="tab">合同</button>
                </li>
            </ul>
            <div class="tab-content border border-top-0 p-3">
                <div class="tab-pane fade show active" id="mt-proc" role="tabpanel">
                    <div class="trend-chart-container">
                        <div id="multiTrendOverlayProc" class="trend-empty-overlay">暂无趋势数据</div>
                        <canvas id="multiTrendChartProc"></canvas>
                    </div>
                </div>
                <div class="tab-pane fade" id="mt-cont" role="tabpanel">
                    <div class="trend-chart-container">
                        <div id="multiTrendOverlayCont" class="trend-empty-overlay">暂无趋势数据</div>
                        <canvas id="multiTrendChartCont"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 所有经办人超期记录汇总 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-exclamation-triangle"></i> 所有经办人超期记录汇总
            </h5>
        </div>
        <div class="card-body">
            {% if all_persons_data.problems %}
                {% for severity, items in all_persons_data.problems.items %}
                    {% if items %}
                    <div class="card mb-2">
                        <div class="card-header" data-bs-toggle="collapse" data-bs-target="#{{ severity }}-all" style="cursor: pointer;">
                            <strong>{{ severity|upper }}</strong> ({{ items|length }}条)
                            <i class="fas fa-chevron-down float-end"></i>
                        </div>
                        <div id="{{ severity }}-all" class="collapse">
                            <div class="card-body p-0">
                                <table class="table table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th>业务类型</th>
                                            <th>编号</th>
                                            <th>名称</th>
                                            <th>经办人</th>
                                            <th>业务日期</th>
                                            <th>归档截止日</th>
                                            <th>逾期天数</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in items %}
                                        <tr>
                                            <td>{{ item.module_label }}</td>
                                            <td>{{ item.code }}</td>
                                            <td>{{ item.name }}</td>
                                            <td>{{ item.responsible_person }}</td>
                                            <td>{{ item.business_date|date:"Y-m-d" }}</td>
                                            <td>{{ item.archive_deadline|date:"Y-m-d" }}</td>
                                            <td class="text-danger">{{ item.overdue_days }}天</td>
                                            <td><a href="{{ item.edit_url }}" class="btn btn-sm btn-link">编辑</a></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            {% else %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> 暂无超期记录
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- 详情模态框（选择了target_code时显示） -->
    {% if target_code %}
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">{% if view_mode == 'project' %}项目详情{% else %}经办人详情{% endif %} - {{ target_code }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
          </div>
          <div class="modal-body">
            <!-- 详情概要 -->
            {% if detail_data and detail_data.summary %}
            <div class="row mb-4">
                <div class="col-12 col-md-4 equal-col">
                    <div class="card text-center stats-card overall h-100 w-100">
                        <div class="card-body">
                            <h6 class="text-muted">综合归档率</h6>
                            <h2 class="text-success">{{ detail_data.summary.overall_archive_rate }}%</h2>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-4 equal-col">
                    <div class="card text-center stats-card procurement h-100 w-100">
                        <div class="card-body">
                            <h6 class="text-muted">采购（已归档/总数）</h6>
                            <h4>{{ detail_data.summary.procurement.count_archived }}/{{ detail_data.summary.procurement.count_total }}</h4>
                            <small class="text-muted">平均{{ detail_data.summary.procurement.avg_cycle }}天 · 及时率 {{ detail_data.summary.procurement.on_time_rate }}%</small>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-4 equal-col">
                    <div class="card text-center stats-card contract h-100 w-100">
                        <div class="card-body">
                            <h6 class="text-muted">合同（已归档/总数）</h6>
                            <h4>{{ detail_data.summary.contract.count_archived }}/{{ detail_data.summary.contract.count_total }}</h4>
                            <small class="text-muted">平均{{ detail_data.summary.contract.avg_cycle }}天 · 及时率 {{ detail_data.summary.contract.on_time_rate }}%</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- 趋势图 -->
            <h6>归档周期趋势</h6>
            <div class="trend-chart-container mb-4">
                <div id="trendChartOverlay" class="trend-empty-overlay">暂无趋势数据</div>
                <canvas id="trendChart"></canvas>
            </div>

            <!-- 归档记录明细 -->
            {% if detail_data and detail_data.records %}
            <h6 class="mt-4">归档记录明细</h6>
            <div class="row">
                <div class="col-md-12">
                    <ul class="nav nav-tabs" id="recordTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="proc-tab" data-bs-toggle="tab" data-bs-target="#proc-panel" type="button" role="tab">采购记录</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="cont-tab" data-bs-toggle="tab" data-bs-target="#cont-panel" type="button" role="tab">合同记录</button>
                        </li>
                    </ul>
                    <div class="tab-content border border-top-0 p-3">
                        <div class="tab-pane fade show active" id="proc-panel" role="tabpanel">
                            {% if detail_data.records.procurements %}
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>编号</th>
                                            <th>名称</th>
                                            <th>经办人</th>
                                            <th>业务日期</th>
                                            <th>归档截止日</th>
                                            <th>归档日期</th>
                                            <th>周期(天)</th>
                                            <th>是否及时</th>
                                            <th>逾期(天)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for r in detail_data.records.procurements %}
                                        <tr>
                                            <td>{{ r.code }}</td>
                                            <td>{{ r.name }}</td>
                                            <td>{{ r.responsible_person }}</td>
                                            <td>{{ r.business_date|date:"Y-m-d" }}</td>
                                            <td>{{ r.archive_deadline|date:"Y-m-d" }}</td>
                                            <td>{% if r.archive_date %}{{ r.archive_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
                                            <td>{% if r.cycle_days is not None %}{{ r.cycle_days }}{% else %}-{% endif %}</td>
                                            <td>{% if r.on_time is not None %}{{ r.on_time|yesno:"是,否" }}{% else %}-{% endif %}</td>
                                            <td>{% if r.overdue_days %}{{ r.overdue_days }}{% else %}-{% endif %}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-secondary">暂无采购记录</div>
                            {% endif %}
                        </div>
                        <div class="tab-pane fade" id="cont-panel" role="tabpanel">
                            {% if detail_data.records.contracts %}
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>编号</th>
                                            <th>名称</th>
                                            <th>经办人</th>
                                            <th>签订日期</th>
                                            <th>归档截止日</th>
                                            <th>归档日期</th>
                                            <th>周期(天)</th>
                                            <th>是否及时</th>
                                            <th>逾期(天)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for r in detail_data.records.contracts %}
                                        <tr>
                                            <td>{{ r.code }}</td>
                                            <td>{{ r.name }}</td>
                                            <td>{{ r.responsible_person }}</td>
                                            <td>{{ r.business_date|date:"Y-m-d" }}</td>
                                            <td>{{ r.archive_deadline|date:"Y-m-d" }}</td>
                                            <td>{% if r.archive_date %}{{ r.archive_date|date:"Y-m-d" }}{% else %}-{% endif %}</td>
                                            <td>{% if r.cycle_days is not None %}{{ r.cycle_days }}{% else %}-{% endif %}</td>
                                            <td>{% if r.on_time is not None %}{{ r.on_time|yesno:"是,否" }}{% else %}-{% endif %}</td>
                                            <td>{% if r.overdue_days %}{{ r.overdue_days }}{% else %}-{% endif %}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="alert alert-secondary">暂无合同记录</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- 超期记录列表 -->
            <h6 class="mt-4">超期记录</h6>
            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="showAllCheck" {% if show_all %}checked{% endif %}>
                <label class="form-check-label" for="showAllCheck">
                    显示所有记录（包括已归档）
                </label>
            </div>

            {% if detail_data and detail_data.problems %}
                {% for severity, items in detail_data.problems.items %}
                    {% if items %}
                    <div class="card mb-2">
                        <div class="card-header" data-bs-toggle="collapse" data-bs-target="#{{ severity }}" style="cursor: pointer;">
                            <strong>{{ severity|upper }}</strong> ({{ items|length }}条)
                            <i class="fas fa-chevron-down float-end"></i>
                        </div>
                        <div id="{{ severity }}" class="collapse show">
                            <div class="card-body p-0">
                                <table class="table table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th>业务类型</th>
                                            <th>编号</th>
                                            <th>名称</th>
                                            <th>业务日期</th>
                                            <th>归档截止日</th>
                                            <th>逾期天数</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in items %}
                                        <tr>
                                            <td>{{ item.module_label }}</td>
                                            <td>{{ item.code }}</td>
                                            <td>{{ item.name }}</td>
                                            <td>{{ item.business_date|date:"Y-m-d" }}</td>
                                            <td>{{ item.archive_deadline|date:"Y-m-d" }}</td>
                                            <td class="text-danger">{{ item.overdue_days }}天</td>
                                            <td><a href="{{ item.edit_url }}" class="btn btn-sm btn-link">编辑</a></td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            {% elif detail_data %}
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> 暂无超期记录
                </div>
            {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle"></i> 暂无详情数据，请检查筛选条件或稍后重试。
                </div>
            {% endif %}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- 项目视图：多项目/单项目经办人趋势图（可切换采购/合同） -->
    {% if view_mode == 'project' %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-chart-line"></i>
                {% if filter_config.selected_project_value %}
                    本项目经办人归档周期趋势（多经办人）
                {% else %}
                    所有项目归档周期趋势（多项目）
                {% endif %}
            </h5>
        </div>
        <div class="card-body">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="pm-proc-tab" data-bs-toggle="tab" data-bs-target="#pm-proc" type="button" role="tab">采购</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="pm-cont-tab" data-bs-toggle="tab" data-bs-target="#pm-cont" type="button" role="tab">合同</button>
                </li>
            </ul>
            <div class="tab-content border border-top-0 p-3">
                <div class="tab-pane fade show active" id="pm-proc" role="tabpanel">
                    <div class="trend-chart-container">
                        <div id="projMultiOverlayProc" class="trend-empty-overlay">暂无趋势数据</div>
                        <canvas id="projMultiChartProc"></canvas>
                    </div>
                </div>
                <div class="tab-pane fade" id="pm-cont" role="tabpanel">
                    <div class="trend-chart-container">
                        <div id="projMultiOverlayCont" class="trend-empty-overlay">暂无趋势数据</div>
                        <canvas id="projMultiChartCont"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 视图模式切换
    document.querySelectorAll('.view-mode-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const mode = this.dataset.mode;
            const url = new URL(window.location.href);
            url.searchParams.set('view_mode', mode);
            url.searchParams.delete('target_code');  // 切换视图时清除目标选择
            window.location.href = url.toString();
        });
    });

    // 查看详情按钮
    document.querySelectorAll('.view-detail-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const targetCode = this.dataset.target;
            const url = new URL(window.location.href);
            url.searchParams.set('target_code', targetCode);
            window.location.href = url.toString();
        });
    });

    // 详情模态框：自动弹出与URL清理
    {% if target_code %}
    const detailModalEl = document.getElementById('detailModal');
    if (detailModalEl && window.bootstrap) {
        const detailModal = new bootstrap.Modal(detailModalEl);
        detailModal.show();
        detailModalEl.addEventListener('hidden.bs.modal', function() {
            const url = new URL(window.location.href);
            url.searchParams.delete('target_code');
            url.searchParams.delete('show_all');
            history.replaceState({}, '', url.toString());
        });
    }
    {% endif %}

    // "显示所有记录"复选框
    const showAllCheck = document.getElementById('showAllCheck');
    if (showAllCheck) {
        showAllCheck.addEventListener('change', function() {
            const url = new URL(window.location.href);
            if (this.checked) {
                url.searchParams.set('show_all', 'true');
            } else {
                url.searchParams.delete('show_all');
            }
            window.location.href = url.toString();
        });
    }

    // 辅助：判断序列是否存在有效数据
    function hasUsableSeries(arr) {
        return Array.isArray(arr) && arr.some(v => v !== null && v !== undefined && !Number.isNaN(v));
    }

    // 渲染趋势图（详情区域）延迟到模态框显示后执行，避免隐藏渲染导致尺寸异常
    {% if target_code and detail_data %}
    const trendData = {{ trend_data_json|safe }};
    function renderDetailTrend() {
        if (!(trendData && trendData.procurement && trendData.contract)) return;
        const el = document.getElementById('trendChart');
        if (!el) return;
        const ctx = el.getContext('2d');
        const labels = trendData.procurement.map(d => d.period);
        const pSeries = trendData.procurement.map(d => d.avg_cycle);
        const cSeries = trendData.contract.map(d => d.avg_cycle);
        const overlay = document.getElementById('trendChartOverlay');
        const hasData = hasUsableSeries(pSeries) || hasUsableSeries(cSeries);

        if (!hasData) {
            if (overlay) overlay.style.display = 'flex';
            return;
        }
        if (overlay) overlay.style.display = 'none';

        const gradBlue = ctx.createLinearGradient(0,0,0,400);
        gradBlue.addColorStop(0, 'rgba(13,110,253,0.25)');
        gradBlue.addColorStop(1, 'rgba(13,110,253,0.02)');
        const gradGreen = ctx.createLinearGradient(0,0,0,400);
        gradGreen.addColorStop(0, 'rgba(25,135,84,0.25)');
        gradGreen.addColorStop(1, 'rgba(25,135,84,0.02)');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '采购归档周期',
                        data: pSeries,
                        borderColor: '#0d6efd',
                        backgroundColor: gradBlue,
                        borderWidth: 2.5,
                        pointRadius: 2.5,
                        pointHoverRadius: 5,
                        tension: 0.35,
                        spanGaps: true,
                        fill: true,
                    },
                    {
                        label: '合同归档周期',
                        data: cSeries,
                        borderColor: '#198754',
                        backgroundColor: gradGreen,
                        borderWidth: 2.5,
                        pointRadius: 2.5,
                        pointHoverRadius: 5,
                        tension: 0.35,
                        spanGaps: true,
                        fill: true,
                    },
                    {
                        label: '采购规定周期（40天）',
                        data: Array(labels.length).fill(40),
                        borderColor: '#0d6efd',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0
                    },
                    {
                        label: '合同规定周期（30天）',
                        data: Array(labels.length).fill(30),
                        borderColor: '#198754',
                        borderDash: [5, 5],
                        borderWidth: 2,
                        fill: false,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { position: 'top' } },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: '平均归档周期（天）' }, grid: { color: '#f1f3f5' } },
                    x: { grid: { color: '#f8f9fa' } },
                }
            }
        });
    }
    if (detailModalEl) {
        detailModalEl.addEventListener('shown.bs.modal', renderDetailTrend, { once: true });
    }
    {% endif %}

    // 多序列趋势图（人员/项目）
    const multiData = {{ multi_trend_json|safe }};
    function buildPalette() {
        return ['#0d6efd','#20c997','#198754','#6610f2','#fd7e14','#6f42c1','#d63384','#0dcaf0','#dc3545','#ffc107'];
    }
    function renderMultiSeries(canvasId, overlayId, labels, series, dashedLine=null) {
        const el = document.getElementById(canvasId);
        const overlay = document.getElementById(overlayId);
        if (!el) return;
        const ctx = el.getContext('2d');
        const pal = buildPalette();
        const hasAny = Array.isArray(series) && series.some(s => hasUsableSeries(s.data));
        if (!hasAny) { if (overlay) overlay.style.display = 'flex'; return; } else { if (overlay) overlay.style.display = 'none'; }
        const datasets = (series || []).map((s, idx) => ({
            label: s.name,
            data: s.data,
            borderColor: pal[idx % pal.length],
            backgroundColor: 'transparent',
            borderWidth: 2,
            pointRadius: 2,
            pointHoverRadius: 5,
            tension: 0.3,
            spanGaps: true,
            fill: false,
        }));
        if (dashedLine) {
            datasets.push({
                label: dashedLine.label,
                data: Array(labels.length).fill(dashedLine.value),
                borderColor: dashedLine.color,
                borderDash: [5,5],
                borderWidth: 2,
                fill: false,
                pointRadius: 0
            });
        }
        new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { position: 'top' } },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: '平均归档周期（天）' }, grid: { color: '#f1f3f5' } },
                    x: { grid: { color: '#f8f9fa' } },
                }
            }
        });
    }
    if (multiData && multiData.labels) {
        // 个人视图
        {% if view_mode == 'person' %}
        renderMultiSeries('multiTrendChartProc', 'multiTrendOverlayProc', multiData.labels, multiData.procurement, {label:'采购规定周期（40天）', value:40, color:'#0d6efd'});
        renderMultiSeries('multiTrendChartCont', 'multiTrendOverlayCont', multiData.labels, multiData.contract, {label:'合同规定周期（30天）', value:30, color:'#198754'});
        {% endif %}
        // 项目视图
        {% if view_mode == 'project' %}
        renderMultiSeries('projMultiChartProc', 'projMultiOverlayProc', multiData.labels, multiData.procurement, {label:'采购规定周期（40天）', value:40, color:'#0d6efd'});
        renderMultiSeries('projMultiChartCont', 'projMultiOverlayCont', multiData.labels, multiData.contract, {label:'合同规定周期（30天）', value:30, color:'#198754'});
        {% endif %}
    }
});
</script>
{% endblock %}
