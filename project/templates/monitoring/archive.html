
{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }} - 项目采购与成本管理系统{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/monitoring.css' %}">
{% endblock %}

{% block content %}
<div class="monitoring-dashboard">
    <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
        <div>
            <h1><i class="fas fa-archive"></i> {{ page_title }}</h1>
            <p class="text-muted">监控采购和合同资料的归档情况，及时发现逾期项目</p>
        </div>
        
        <!-- 筛选器 - 右上角 -->
        <div class="filter-section" style="padding: 12px 16px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 12px;">
            <form method="get" action="" id="archiveFilterForm" style="display: flex; align-items: center; gap: 12px; margin: 0;">
                {% for filter in quick_filters %}
                    {% if filter.type == 'select' %}
                        <label style="font-weight: 600; color: #495057; margin: 0; white-space: nowrap;">
                            {% if filter.name == 'year' %}年份：{% elif filter.name == 'project' %}项目：{% endif %}
                        </label>
                        <select name="{{ filter.name }}"
                                class="form-control form-control-sm filter-select"
                                onchange="this.form.submit()"
                                style="width: {{ filter.width|default:'150px' }}; border-radius: 4px;">
                            {% for option in filter.options %}
                                <option value="{{ option.value }}"
                                        {% if option.value == filter.current_value %}selected{% endif %}>
                                    {{ option.label }}
                                </option>
                            {% endfor %}
                        </select>
                    {% endif %}
                {% endfor %}
            </form>
        </div>
    </div>

    <!-- 关键指标仪表盘 - 突出显示最重要的数据 -->
    <div class="dashboard-gauge-container">
        <div class="gauge-card">
            <div class="gauge-wrapper">
                <svg class="gauge-svg" viewBox="0 0 160 160">
                    <defs>
                        <linearGradient id="gaugeGradientOverall" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle class="gauge-background" cx="80" cy="80" r="70"></circle>
                    <circle class="gauge-progress primary" cx="80" cy="80" r="70"
                            stroke-dasharray="440"
                            style="stroke-dashoffset: calc(440 - (440 * {{ archive_data.overall_rate }} / 100));"></circle>
                </svg>
                <div class="gauge-value">{{ archive_data.overall_rate }}%</div>
            </div>
            <div class="gauge-label">综合归档率</div>
            <div class="gauge-subtitle">总体归档完成度</div>
        </div>

        <div class="gauge-card {% if archive_data.overall_timely_rate >= 80 %}success{% elif archive_data.overall_timely_rate >= 60 %}warning{% else %}danger{% endif %}">
            <div class="gauge-wrapper">
                <svg class="gauge-svg" viewBox="0 0 160 160">
                    <defs>
                        <linearGradient id="gaugeGradientTimely" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#52c41a;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#73d13d;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle class="gauge-background" cx="80" cy="80" r="70"></circle>
                    <circle class="gauge-progress {% if archive_data.overall_timely_rate >= 80 %}success{% elif archive_data.overall_timely_rate >= 60 %}warning{% else %}danger{% endif %}" cx="80" cy="80" r="70"
                            stroke-dasharray="440"
                            style="stroke-dashoffset: calc(440 - (440 * {{ archive_data.overall_timely_rate }} / 100));"></circle>
                </svg>
                <div class="gauge-value">{{ archive_data.overall_timely_rate }}%</div>
            </div>
            <div class="gauge-label">归档及时率</div>
            <div class="gauge-subtitle">在规定时限内完成</div>
        </div>

        <div class="gauge-card {% if archive_data.procurement.rate >= 80 %}success{% elif archive_data.procurement.rate >= 60 %}warning{% endif %}">
            <div class="gauge-wrapper">
                <svg class="gauge-svg" viewBox="0 0 160 160">
                    <defs>
                        <linearGradient id="gaugeGradientProc" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#11998e;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#38ef7d;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle class="gauge-background" cx="80" cy="80" r="70"></circle>
                    <circle class="gauge-progress {% if archive_data.procurement.rate >= 80 %}success{% else %}warning{% endif %}" cx="80" cy="80" r="70"
                            stroke-dasharray="440"
                            style="stroke-dashoffset: calc(440 - (440 * {{ archive_data.procurement.rate }} / 100));"></circle>
                </svg>
                <div class="gauge-value">{{ archive_data.procurement.rate }}%</div>
            </div>
            <div class="gauge-label">采购归档率</div>
            <div class="gauge-subtitle">已归档 {{ archive_data.procurement.archived }}/{{ archive_data.procurement.total }}</div>
        </div>

        <div class="gauge-card {% if archive_data.contract.rate >= 80 %}success{% elif archive_data.contract.rate >= 60 %}warning{% endif %}">
            <div class="gauge-wrapper">
                <svg class="gauge-svg" viewBox="0 0 160 160">
                    <defs>
                        <linearGradient id="gaugeGradientCont" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#f093fb;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#f5576c;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle class="gauge-background" cx="80" cy="80" r="70"></circle>
                    <circle class="gauge-progress {% if archive_data.contract.rate >= 80 %}success{% else %}warning{% endif %}" cx="80" cy="80" r="70"
                            stroke-dasharray="440"
                            style="stroke-dashoffset: calc(440 - (440 * {{ archive_data.contract.rate }} / 100));"></circle>
                </svg>
                <div class="gauge-value">{{ archive_data.contract.rate }}%</div>
            </div>
            <div class="gauge-label">合同归档率</div>
            <div class="gauge-subtitle">已归档 {{ archive_data.contract.archived }}/{{ archive_data.contract.total }}</div>
        </div>

        <div class="gauge-card warning">
            <div class="gauge-wrapper">
                <svg class="gauge-svg" viewBox="0 0 160 160">
                    <circle class="gauge-background" cx="80" cy="80" r="70"></circle>
                </svg>
                <div class="gauge-value">{{ archive_data.procurement.overdue|add:archive_data.contract.overdue }}</div>
            </div>
            <div class="gauge-label">逾期项目</div>
            <div class="gauge-subtitle">需要立即处理</div>
        </div>
    </div>

    <!-- 标签页容器 - 组织多模块数据 -->
    <div class="tab-container">
        <ul class="tab-nav">
            <li class="tab-nav-item">
                <a href="#tab-procurement" class="tab-nav-link active" onclick="switchTab(event, 'tab-procurement')">
                    <i class="fas fa-shopping-cart"></i>
                    <span>采购详情</span>
                </a>
            </li>
            <li class="tab-nav-item">
                <a href="#tab-contract" class="tab-nav-link" onclick="switchTab(event, 'tab-contract')">
                    <i class="fas fa-file-contract"></i>
                    <span>合同详情</span>
                </a>
            </li>
            <li class="tab-nav-item">
                <a href="#tab-overdue" class="tab-nav-link" onclick="switchTab(event, 'tab-overdue')">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>逾期预警 ({{ archive_data.procurement.overdue|add:archive_data.contract.overdue }})</span>
                </a>
            </li>
        </ul>

        <!-- 标签页内容 -->
        <div class="tab-content">
            <!-- 采购详情 -->
            <div id="tab-procurement" class="tab-pane active">
                <div class="compact-stat-card">
                    <div class="stat-header">
                        <i class="fas fa-shopping-cart"></i>
                        <span>采购归档统计</span>
                    </div>
                    <div class="stat-body">
                        <div class="stat-item">
                            <div class="stat-number">{{ archive_data.procurement.total }}</div>
                            <div class="stat-label">应归档</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number text-success">{{ archive_data.procurement.archived }}</div>
                            <div class="stat-label">已归档</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number text-warning">{{ archive_data.procurement.overdue }}</div>
                            <div class="stat-label">逾期</div>
                        </div>
                        <div class="stat-item primary">
                            <div class="stat-number">{{ archive_data.procurement.rate }}%</div>
                            <div class="stat-label">归档率</div>
                        </div>
                    </div>
                </div>

                <!-- 归档及时性分析 - 紧凑单行布局 -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body" style="padding: 15px 20px;">
                                <div class="row align-items-center">
                                    <!-- 归档及时性指标 -->
                                    <div class="col-md-3">
                                        <div class="text-center" style="border-right: 2px solid #e9ecef; padding-right: 15px;">
                                            <div style="color: #52c41a; font-size: 42px; font-weight: bold; line-height: 1;">{{ archive_data.procurement.timely_rate }}%</div>
                                            <div style="color: #666; font-size: 13px; margin-top: 5px; font-weight: 600;">及时归档率</div>
                                            <div style="color: #999; font-size: 11px; margin-top: 2px;">40天内 | 平均{{ archive_data.procurement.avg_archive_days }}天</div>
                                        </div>
                                    </div>
                                    
                                    <!-- 逾期分级统计 -->
                                    <div class="col-md-9">
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <div style="background: linear-gradient(135deg, #fff1f0 0%, #ffccc7 100%); border-radius: 8px; padding: 15px 10px;">
                                                    <div style="color: #cf1322; font-size: 36px; font-weight: bold; line-height: 1;">{{ archive_data.procurement.overdue_breakdown.severe|default:0 }}</div>
                                                    <div style="color: #cf1322; font-size: 13px; margin-top: 5px; font-weight: 600;">严重逾期</div>
                                                    <div style="color: #999; font-size: 11px; margin-top: 2px;">超过30天</div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div style="background: linear-gradient(135deg, #fff7e6 0%, #ffe7ba 100%); border-radius: 8px; padding: 15px 10px;">
                                                    <div style="color: #d46b08; font-size: 36px; font-weight: bold; line-height: 1;">{{ archive_data.procurement.overdue_breakdown.moderate|default:0 }}</div>
                                                    <div style="color: #d46b08; font-size: 13px; margin-top: 5px; font-weight: 600;">中度逾期</div>
                                                    <div style="color: #999; font-size: 11px; margin-top: 2px;">16-30天</div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div style="background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%); border-radius: 8px; padding: 15px 10px;">
                                                    <div style="color: #0958d9; font-size: 36px; font-weight: bold; line-height: 1;">{{ archive_data.procurement.overdue_breakdown.mild|default:0 }}</div>
                                                    <div style="color: #0958d9; font-size: 13px; margin-top: 5px; font-weight: 600;">轻度逾期</div>
                                                    <div style="color: #999; font-size: 11px; margin-top: 2px;">1-15天</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 合同详情 -->
            <div id="tab-contract" class="tab-pane">
                <div class="compact-stat-card">
                    <div class="stat-header">
                        <i class="fas fa-file-contract"></i>
                        <span>合同归档统计</span>
                    </div>
                    <div class="stat-body">
                        <div class="stat-item">
                            <div class="stat-number">{{ archive_data.contract.total }}</div>
                            <div class="stat-label">应归档</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number text-success">{{ archive_data.contract.archived }}</div>
                            <div class="stat-label">已归档</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number text-warning">{{ archive_data.contract.overdue }}</div>
                            <div class="stat-label">逾期</div>
                        </div>
                        <div class="stat-item primary">
                            <div class="stat-number">{{ archive_data.contract.rate }}%</div>
                            <div class="stat-label">归档率</div>
                        </div>
                    </div>
                </div>

                <!-- 归档及时性分析 - 紧凑单行布局 -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body" style="padding: 15px 20px;">
                                <div class="row align-items-center">
                                    <!-- 归档及时性指标 -->
                                    <div class="col-md-3">
                                        <div class="text-center" style="border-right: 2px solid #e9ecef; padding-right: 15px;">
                                            <div style="color: #52c41a; font-size: 42px; font-weight: bold; line-height: 1;">{{ archive_data.contract.timely_rate }}%</div>
                                            <div style="color: #666; font-size: 13px; margin-top: 5px; font-weight: 600;">及时归档率</div>
                                            <div style="color: #999; font-size: 11px; margin-top: 2px;">30天内 | 平均{{ archive_data.contract.avg_archive_days }}天</div>
                                        </div>
                                    </div>
                                    
                                    <!-- 逾期分级统计 -->
                                    <div class="col-md-9">
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <div style="background: linear-gradient(135deg, #fff1f0 0%, #ffccc7 100%); border-radius: 8px; padding: 15px 10px;">
                                                    <div style="color: #cf1322; font-size: 36px; font-weight: bold; line-height: 1;">{{ archive_data.contract.overdue_breakdown.severe|default:0 }}</div>
                                                    <div style="color: #cf1322; font-size: 13px; margin-top: 5px; font-weight: 600;">严重逾期</div>
                                                    <div style="color: #999; font-size: 11px; margin-top: 2px;">超过30天</div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div style="background: linear-gradient(135deg, #fff7e6 0%, #ffe7ba 100%); border-radius: 8px; padding: 15px 10px;">
                                                    <div style="color: #d46b08; font-size: 36px; font-weight: bold; line-height: 1;">{{ archive_data.contract.overdue_breakdown.moderate|default:0 }}</div>
                                                    <div style="color: #d46b08; font-size: 13px; margin-top: 5px; font-weight: 600;">中度逾期</div>
                                                    <div style="color: #999; font-size: 11px; margin-top: 2px;">16-30天</div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div style="background: linear-gradient(135deg, #e6f7ff 0%, #bae7ff 100%); border-radius: 8px; padding: 15px 10px;">
                                                    <div style="color: #0958d9; font-size: 36px; font-weight: bold; line-height: 1;">{{ archive_data.contract.overdue_breakdown.mild|default:0 }}</div>
                                                    <div style="color: #0958d9; font-size: 13px; margin-top: 5px; font-weight: 600;">轻度逾期</div>
                                                    <div style="color: #999; font-size: 11px; margin-top: 2px;">1-15天</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 逾期预警 -->
            <div id="tab-overdue" class="tab-pane">
                <!-- 筛选器 -->
                <div class="card mb-3">
                    <div class="card-body">
                        <form method="get" action="{% url 'archive_monitor' %}" class="form-inline" style="display: flex; align-items: center; gap: 15px; flex-wrap: nowrap;">
                            <div class="form-group mb-0" style="display: flex; align-items: center; gap: 8px;">
                                <label class="mb-0" style="white-space: nowrap;">模块：</label>
                                <select name="module" class="form-control form-control-sm">
                                    <option value="">全部</option>
                                    <option value="procurement" {% if module_filter == 'procurement' %}selected{% endif %}>采购</option>
                                    <option value="contract" {% if module_filter == 'contract' %}selected{% endif %}>合同</option>
                                </select>
                            </div>
                            <div class="form-group mb-0" style="display: flex; align-items: center; gap: 8px;">
                                <label class="mb-0" style="white-space: nowrap;">严重程度：</label>
                                <select name="severity" class="form-control form-control-sm">
                                    <option value="">全部</option>
                                    <option value="severe" {% if severity_filter == 'severe' %}selected{% endif %}>严重</option>
                                    <option value="moderate" {% if severity_filter == 'moderate' %}selected{% endif %}>中度</option>
                                    <option value="mild" {% if severity_filter == 'mild' %}selected{% endif %}>轻度</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary btn-sm mb-0">
                                <i class="fas fa-search"></i> 筛选
                            </button>
                            <a href="{% url 'archive_monitor' %}" class="btn btn-secondary btn-sm mb-0">
                                <i class="fas fa-redo"></i> 重置
                            </a>
                        </form>
                    </div>
                </div>

                <!-- 逾期项目列表 -->
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5><i class="fas fa-exclamation-triangle"></i> 逾期项目列表 
                            <span class="badge badge-light text-danger float-right">共 {{ page_obj.paginator.count }} 项</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if overdue_list %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">序号</th>
                                        <th>模块</th>
                                        <th>编号</th>
                                        <th>名称</th>
                                        <th>项目</th>
                                        <th>参考日期</th>
                                        <th>逾期天数</th>
                                        <th>程度</th>
                                        <th>经办人</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in overdue_list %}
                                    <tr class="severity-{{ item.severity }}">
                                        <td>{{ forloop.counter }}</td>
                                        <td><span class="badge badge-secondary">{{ item.module }}</span></td>
                                        <td><code style="font-size: 12px;">{{ item.code }}</code></td>
                                        <td>{{ item.name|truncatechars:30 }}</td>
                                        <td>
                                            {% if item.project_code %}
                                            <small>{{ item.project_code }}</small><br>
                                            <small class="text-muted">{{ item.project_name|truncatechars:15 }}</small>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small>{{ item.reference_date_label }}</small><br>
                                            <small>{{ item.reference_date }}</small>
                                        </td>
                                        <td>
                                            <strong class="text-danger">{{ item.overdue_days }}</strong>天
                                            <br><small class="text-muted">(应≤{{ item.deadline_days }}天)</small>
                                        </td>
                                        <td>
                                            {% if item.severity == 'severe' %}
                                            <span class="badge badge-danger">严重</span>
                                            {% elif item.severity 
== 'moderate' %}
                                            <span class="badge badge-warning">中度</span>
                                            {% else %}
                                            <span class="badge badge-info">轻度</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ item.officer|default:"-" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <!-- 分页 -->
                        {% if page_obj.has_other_pages %}
                        <nav aria-label="分页导航" class="mt-4">
                            <ul class="pagination justify-content-center">
                                {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1{% if module_filter %}&module={{ module_filter }}{% endif %}{% if severity_filter %}&severity={{ severity_filter }}{% endif %}{% if project_filter %}&project={{ project_filter }}{% endif %}">首页</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if module_filter %}&module={{ module_filter }}{% endif %}{% if severity_filter %}&severity={{ severity_filter }}{% endif %}{% if project_filter %}&project={{ project_filter }}{% endif %}">上一页</a>
                                </li>
                                {% endif %}

                                <li class="page-item active">
                                    <span class="page-link">
                                        第 {{ page_obj.number }} / {{ page_obj.paginator.num_pages }} 页
                                    </span>
                                </li>

                                {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if module_filter %}&module={{ module_filter }}{% endif %}{% if severity_filter %}&severity={{ severity_filter }}{% endif %}{% if project_filter %}&project={{ project_filter }}{% endif %}">下一页</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% if module_filter %}&module={{ module_filter }}{% endif %}{% if severity_filter %}&severity={{ severity_filter }}{% endif %}{% if project_filter %}&project={{ project_filter }}{% endif %}">末页</a>
                                </li>
                                {% endif %}
                            </ul>
                        </nav>
                        {% endif %}

                        {% else %}
                        <div class="alert alert-success text-center mb-0">
                            <i class="fas fa-check-circle fa-3x mb-3"></i>
                            <h5>太棒了！</h5>
                            <p>当前筛选条件下没有逾期项目。</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 返回按钮 -->
    <div class="mt-4">
        <a href="{% url 'monitoring_dashboard' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> 返回监控中心
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// 标签页切换功能
function switchTab(event, tabId) {
    event.preventDefault();
    
    // 移除所有活动状态
    document.querySelectorAll('.tab-nav-link').forEach(link => {
        link.classList.remove('active');
    });
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    
    // 添加新的活动状态
    event.currentTarget.classList.add('active');
    document.getElementById(tabId).classList.add('active');
}

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    // 已删除综合概览相关图表代码
});
</script>
{% endblock %}