{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4">{{ page_title }} - {{ time_label }}</h2>

    <!-- æ—¶é—´ç»´åº¦å’Œç»´åº¦ç±»å‹åˆ‡æ¢ -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="btn-group" role="group">
                <a href="?time_dimension=recent_month&dimension_type={{ dimension_type }}"
                   class="btn btn-{% if time_dimension == 'recent_month' %}primary{% else %}outline-primary{% endif %}">æœ€è¿‘ä¸€ä¸ªæœˆ</a>
                <a href="?time_dimension=last_month&dimension_type={{ dimension_type }}"
                   class="btn btn-{% if time_dimension == 'last_month' %}primary{% else %}outline-primary{% endif %}">ä¸Šä¸€ä¸ªæœˆ</a>
                <a href="?time_dimension=current_year&dimension_type={{ dimension_type }}"
                   class="btn btn-{% if time_dimension == 'current_year' %}primary{% else %}outline-primary{% endif %}">ä»Šå¹´ç´¯è®¡</a>
            </div>
        </div>
        <div class="col-md-6 text-end">
            <div class="btn-group" role="group">
                <a href="?time_dimension={{ time_dimension }}&dimension_type=person"
                   class="btn btn-{% if dimension_type == 'person' %}success{% else %}outline-success{% endif %}">æŒ‰ä¸ªäºº</a>
                <a href="?time_dimension={{ time_dimension }}&dimension_type=project"
                   class="btn btn-{% if dimension_type == 'project' %}success{% else %}outline-success{% endif %}">æŒ‰é¡¹ç›®</a>
            </div>
        </div>
    </div>

    <!-- å·¥ä½œé‡æ’åè¡¨ -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">å·¥ä½œé‡æ’å</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>æ’å</th>
                            <th>{% if dimension_type == 'person' %}å§“å{% else %}é¡¹ç›®åç§°{% endif %}</th>
                            <th>é‡‡è´­</th>
                            <th>åˆåŒ</th>
                            <th>ä»˜æ¬¾</th>
                            <th>ç»“ç®—</th>
                            <th>åˆè®¡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in ranking %}
                        <tr>
                            <td>
                                {% if forloop.counter == 1 %}ğŸ¥‡
                                {% elif forloop.counter == 2 %}ğŸ¥ˆ
                                {% elif forloop.counter == 3 %}ğŸ¥‰
                                {% else %}{{ forloop.counter }}
                                {% endif %}
                            </td>
                            <td><strong>{{ item.name }}</strong></td>
                            <td>{{ item.procurement_count }}æ¡</td>
                            <td>{{ item.contract_count }}æ¡</td>
                            <td>{{ item.payment_count }}ç¬”</td>
                            <td>{{ item.settlement_count }}é¡¹</td>
                            <td><span class="badge bg-primary">{{ item.total }}</span></td>
                            <td>
                                <button class="btn btn-sm btn-outline-info"
                                        onclick="toggleDetails('details-{{ forloop.counter }}')">å±•å¼€æ˜ç»†</button>
                            </td>
                        </tr>
                        <tr id="details-{{ forloop.counter }}" style="display:none;">
                            <td colspan="8" class="bg-light">
                                <div class="p-3">
                                    <!-- é‡‡è´­æ˜ç»† -->
                                    {% if item.details.procurement %}
                                    <h6>ğŸ“‹ é‡‡è´­ï¼ˆ{{ item.procurement_count }}æ¡ï¼‰</h6>
                                    <table class="table table-sm table-bordered mb-3">
                                        <thead>
                                            <tr>
                                                <th>ä¸šåŠ¡ç¼–ç </th>
                                                {% if dimension_type == 'project' %}<th>ç»åŠäºº</th>{% else %}<th>é¡¹ç›®åç§°</th>{% endif %}
                                                <th>é‡‡è´­åç§°</th>
                                                <th>ç»“æœå…¬ç¤ºæ—¥æœŸ</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for p in item.details.procurement %}
                                            <tr>
                                                <td><code>{{ p.code }}</code></td>
                                                <td>{% if dimension_type == 'project' %}{{ p.person }}{% else %}{{ p.project_name }}{% endif %}</td>
                                                <td>{{ p.name }}</td>
                                                <td>{{ p.date|date:"Y-m-d" }}</td>
                                                <td><a href="{{ p.url }}" class="btn btn-xs btn-link">æŸ¥çœ‹</a></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    {% endif %}

                                    <!-- åˆåŒæ˜ç»† -->
                                    {% if item.details.contract %}
                                    <h6>ğŸ“„ åˆåŒï¼ˆ{{ item.contract_count }}æ¡ï¼‰</h6>
                                    <table class="table table-sm table-bordered mb-3">
                                        <thead>
                                            <tr>
                                                <th>åˆåŒåºå·</th>
                                                <th>åˆåŒç¼–ç </th>
                                                {% if dimension_type == 'project' %}<th>ç»åŠäºº</th>{% endif %}
                                                <th>åˆåŒåç§°</th>
                                                <th>ç­¾è®¢æ—¥æœŸ</th>
                                                <th>åˆåŒé‡‘é¢</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for c in item.details.contract %}
                                            <tr>
                                                <td>{{ c.sequence }}</td>
                                                <td><code>{{ c.code }}</code></td>
                                                {% if dimension_type == 'project' %}<td>{{ c.person }}</td>{% endif %}
                                                <td>{{ c.name }}</td>
                                                <td>{{ c.date|date:"Y-m-d" }}</td>
                                                <td>{{ c.amount|floatformat:2 }}å…ƒ</td>
                                                <td><a href="{{ c.url }}" class="btn btn-xs btn-link">æŸ¥çœ‹</a></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    {% endif %}

                                    <!-- ä»˜æ¬¾æ˜ç»† -->
                                    {% if item.details.payment %}
                                    <h6>ğŸ’° ä»˜æ¬¾ï¼ˆ{{ item.payment_count }}ç¬”ï¼‰</h6>
                                    <table class="table table-sm table-bordered mb-3">
                                        <thead>
                                            <tr>
                                                <th>ä»˜æ¬¾ç¼–å·</th>
                                                {% if dimension_type == 'project' %}<th>ç»åŠäºº</th>{% endif %}
                                                <th>åˆåŒåç§°</th>
                                                <th>ä»˜æ¬¾æ—¥æœŸ</th>
                                                <th>ä»˜æ¬¾é‡‘é¢</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for p in item.details.payment %}
                                            <tr>
                                                <td><code>{{ p.code }}</code></td>
                                                {% if dimension_type == 'project' %}<td>{{ p.person }}</td>{% endif %}
                                                <td>{{ p.contract_name }}</td>
                                                <td>{{ p.date|date:"Y-m-d" }}</td>
                                                <td>{{ p.amount|floatformat:2 }}å…ƒ</td>
                                                <td><a href="{{ p.url }}" class="btn btn-xs btn-link">æŸ¥çœ‹</a></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    {% endif %}

                                    <!-- ç»“ç®—æ˜ç»† -->
                                    {% if item.details.settlement %}
                                    <h6>âœ… ç»“ç®—ï¼ˆ{{ item.settlement_count }}é¡¹ï¼‰</h6>
                                    <table class="table table-sm table-bordered">
                                        <thead>
                                            <tr>
                                                <th>ç»“ç®—ç¼–å·</th>
                                                {% if dimension_type == 'project' %}<th>ç»åŠäºº</th>{% endif %}
                                                <th>åˆåŒåç§°</th>
                                                <th>å®Œæˆæ—¥æœŸ</th>
                                                <th>ç»“ç®—é‡‘é¢</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for s in item.details.settlement %}
                                            <tr>
                                                <td><code>{{ s.code }}</code></td>
                                                {% if dimension_type == 'project' %}<td>{{ s.person }}</td>{% endif %}
                                                <td>{{ s.contract_name }}</td>
                                                <td>{{ s.date|date:"Y-m-d" }}</td>
                                                <td>{{ s.amount|floatformat:2 }}å…ƒ</td>
                                                <td><a href="{{ s.url }}" class="btn btn-xs btn-link">æŸ¥çœ‹</a></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center text-muted">æš‚æ— æ•°æ®</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
function toggleDetails(id) {
    const row = document.getElementById(id);
    if (row.style.display === 'none') {
        row.style.display = 'table-row';
    } else {
        row.style.display = 'none';
    }
}
</script>
{% endblock %}
