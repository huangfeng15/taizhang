{% extends "base.html" %}
{% load static %}
{% load monitor_filters %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    .view-mode-selector {
        display: inline-flex;
        border-radius: 0.375rem;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .view-mode-btn {
        padding: 0.5rem 1.5rem;
        border: none;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 500;
    }
    .view-mode-btn:hover {
        background: #f8f9fa;
    }
    .view-mode-btn.active {
        background: #0d6efd;
        color: white;
    }
    .stats-card {
        border-left: 4px solid;
        transition: transform 0.2s;
    }
    .stats-card:hover {
        transform: translateY(-2px);
    }
    .stats-card.procurement {
        border-left-color: #0d6efd;
    }
    .stats-card.contract {
        border-left-color: #198754;
    }
    .stats-card.overall {
        border-left-color: #6c757d;
    }
    .trend-chart-container {
        height: 400px;
        position: relative;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">{{ page_title }}</h2>
        <div class="text-muted">
            <i class="fas fa-filter"></i>
            当前筛选：{{ filter_config.display_year|default:"全部年度" }}
            {% if filter_config.selected_project_value %}· {{ filter_config.selected_project_value }}{% else %}· 全部项目{% endif %}
        </div>
    </div>

    <!-- 视图模式切换器 -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div class="view-mode-selector">
                    <button type="button" class="view-mode-btn {% if view_mode == 'project' %}active{% endif %}" data-mode="project">
                        <i class="fas fa-project-diagram"></i> 项目视图
                    </button>
                    <button type="button" class="view-mode-btn {% if view_mode == 'person' %}active{% endif %}" data-mode="person">
                        <i class="fas fa-user"></i> 个人视图
                    </button>
                </div>

                <!-- 目标选择器 -->
                <div class="d-flex align-items-center gap-3">
                    {% if view_mode == 'project' %}
                    <div id="projectSelector" style="min-width: 300px;">
                        <select class="form-select" id="targetSelect">
                            <option value="">请选择项目</option>
                        </select>
                    </div>
                    {% else %}
                    <div id="personSelector" style="min-width: 300px;">
                        <select class="form-select" id="targetSelect">
                            <option value="">请选择经办人</option>
                            {% for person in person_list %}
                            <option value="{{ person.name }}" {% if person.name == target_code %}selected{% endif %}>
                                {{ person.name }} ({{ person.count }}条)
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="show_all" value="true" id="showAllCheck" {% if show_all %}checked{% endif %}>
                        <label class="form-check-label" for="showAllCheck">
                            显示所有记录
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 归档统计卡片（选择目标后显示） -->
    {% if archive_stats %}
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card stats-card procurement">
                <div class="card-body">
                    <h6 class="text-muted mb-2">采购平均归档周期</h6>
                    <h2 class="mb-1">{{ archive_stats.procurement_avg_cycle }} 天</h2>
                    <small class="text-muted">
                        规定周期：40天 | 及时率：{{ archive_stats.procurement_on_time_rate }}%
                        {% if archive_stats.procurement_count %}
                        <br>样本数：{{ archive_stats.procurement_count }}条
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card contract">
                <div class="card-body">
                    <h6 class="text-muted mb-2">合同平均归档周期</h6>
                    <h2 class="mb-1">{{ archive_stats.contract_avg_cycle }} 天</h2>
                    <small class="text-muted">
                        规定周期：30天 | 及时率：{{ archive_stats.contract_on_time_rate }}%
                        {% if archive_stats.contract_count %}
                        <br>样本数：{{ archive_stats.contract_count }}条
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card stats-card overall">
                <div class="card-body">
                    <h6 class="text-muted mb-2">综合归档及时率</h6>
                    <h2 class="mb-1">
                        {% if archive_stats.procurement_count > 0 or archive_stats.contract_count > 0 %}
                            {% widthratio archive_stats.procurement_on_time_rate|add:archive_stats.contract_on_time_rate 2 1|floatformat:1 %}%
                        {% else %}
                            0.0%
                        {% endif %}
                    </h2>
                    <small class="text-muted">
                        采购+合同综合评估
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- 归档周期趋势图 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-chart-line"></i> 归档周期趋势
                <small class="text-muted">（按业务日期统计）</small>
            </h5>
        </div>
        <div class="card-body">
            <div class="trend-chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- KPI卡片 -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">总体归档率</h5>
                    <h2 class="text-primary">{{ statistics.archive_rate }}%</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">及时归档率</h5>
                    <h2 class="text-success">{{ statistics.timely_rate }}%</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">待归档</h5>
                    <h2 class="text-secondary">{{ statistics.pending_count }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">逾期总数</h5>
                    <h2 class="text-danger">{{ statistics.total_problems }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- 问题列表 -->
    {% for severity, config in severity_config.items %}
        {% with items=problems|lookup:severity %}
        {% if items %}
        <div class="card mb-3">
            <div class="card-header bg-{{ config.class }}">
                <h5 class="mb-0">
                    {{ config.icon }} {{ config.label }} - {{ items|length }}条
                </h5>
            </div>
            <div class="card-body p-0">
                {% include "monitoring/includes/problem_list_table.html" with items=items %}
            </div>
        </div>
        {% endif %}
        {% endwith %}
    {% endfor %}

    {% if statistics.total_problems == 0 %}
    <div class="alert alert-success text-center">
        <h4>✅ 太棒了！所有记录都已按时归档</h4>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/archive-statistics.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始化归档统计功能
    const archiveStats = new ArchiveStatistics({
        viewMode: '{{ view_mode }}',
        targetCode: '{{ target_code }}',
        showAll: {{ show_all|yesno:"true,false" }},
        trendData: {{ trend_data_json|safe }}
    });
});
</script>
{% endblock %}
