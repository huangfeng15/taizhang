{% extends "base.html" %}
{% load static %}

{% block title %}完整率字段配置{% endblock %}

{% block extra_css %}
<style>
    .config-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    .model-tabs {
        margin-bottom: 20px;
    }
    .method-type-tabs {
        margin-bottom: 15px;
        border-bottom: 2px solid #e9ecef;
    }
    .method-type-tabs .nav-link {
        color: #495057;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 10px 20px;
        margin-bottom: -2px;
    }
    .method-type-tabs .nav-link.active {
        color: #007bff;
        border-bottom-color: #007bff;
        background: none;
    }
    .field-list {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .field-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s;
    }
    .field-item:hover {
        background-color: #f8f9fa;
    }
    .field-item:last-child {
        border-bottom: none;
    }
    .field-checkbox {
        margin-right: 15px;
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    .field-label {
        flex: 1;
        font-size: 14px;
        color: #333;
    }
    .field-name {
        color: #6c757d;
        font-size: 12px;
        font-family: monospace;
        margin-left: 10px;
    }
    .action-buttons {
        margin-top: 20px;
        display: flex;
        gap: 10px;
    }
    .stats-info {
        background: #e7f3ff;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .select-all-container {
        padding: 12px;
        background: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 10px;
    }
    .method-description {
        background: #fff3cd;
        padding: 12px;
        border-radius: 4px;
        margin-bottom: 15px;
        border-left: 4px solid #ffc107;
    }
    .method-description strong {
        color: #856404;
    }
    .tab-content {
        min-height: 400px;
    }
</style>
{% endblock %}

{% block content %}
<div class="config-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>完整率字段配置</h2>
        <a href="{% url 'completeness_check' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> 返回齐全性检查
        </a>
    </div>

    <div class="stats-info">
        <div class="row">
            <div class="col-md-12">
                <strong>说明：</strong>不同采购方式要求填写的字段不同。请为每种采购方式分别配置必填字段，系统将根据配置计算齐全率。
            </div>
        </div>
    </div>

    <!-- 模型类型切换 -->
    <ul class="nav nav-tabs model-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if model_type == 'procurement' %}active{% endif %}"
               href="{% url 'completeness_field_config' %}?model_type=procurement">
                采购字段配置（按采购方式）
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if model_type == 'contract' %}active{% endif %}"
               href="{% url 'completeness_field_config' %}?model_type=contract">
                合同字段配置
            </a>
        </li>
    </ul>

    {% if model_type == 'procurement' %}
    <!-- 采购方式类型切换（仅采购模式显示） -->
    <ul class="nav method-type-tabs" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if not method_type or method_type == 'strategic_procurement' %}active{% endif %}"
               href="{% url 'completeness_field_config' %}?model_type=procurement&method_type=strategic_procurement"
               data-method-type="strategic_procurement">
                战采结果应用
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if method_type == 'direct_commission' %}active{% endif %}"
               href="{% url 'completeness_field_config' %}?model_type=procurement&method_type=direct_commission"
               data-method-type="direct_commission">
                直接采购
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if method_type == 'single_source' %}active{% endif %}"
               href="{% url 'completeness_field_config' %}?model_type=procurement&method_type=single_source"
               data-method-type="single_source">
                单一来源采购
            </a>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link {% if method_type == 'other_methods' %}active{% endif %}"
               href="{% url 'completeness_field_config' %}?model_type=procurement&method_type=other_methods"
               data-method-type="other_methods">
                其他采购方式
            </a>
        </li>
    </ul>

    <!-- 当前采购方式说明 -->
    <div class="method-description">
        <strong>当前配置：</strong>
        {% if not method_type or method_type == 'strategic_procurement' %}
            战采结果应用（包括：战采结果应用、战略采购结果应用）
        {% elif method_type == 'direct_commission' %}
            直接采购
        {% elif method_type == 'single_source' %}
            单一来源采购（包括：单一来源采购、单一来源）
        {% elif method_type == 'other_methods' %}
            其他采购方式（包括：公开招标、邀请招标、公开询价、邀请询价、公开竞价、邀请竞价等）
        {% endif %}
    </div>
    {% endif %}

    <!-- 字段列表 -->
    <div class="field-list">
        <div class="select-all-container">
            <label>
                <input type="checkbox" id="selectAll" class="field-checkbox">
                <strong>全选/取消全选</strong>
            </label>
            <span class="text-muted ms-3">
                {% if model_type == 'procurement' %}
                    勾选的字段将作为该采购方式的必填字段纳入齐全率统计
                {% else %}
                    勾选的字段将纳入合同齐全率统计
                {% endif %}
            </span>
        </div>

        <form id="configForm">
            {% csrf_token %}
            <input type="hidden" name="model_type" value="{{ model_type }}">
            {% if model_type == 'procurement' %}
            <input type="hidden" name="method_type" value="{{ method_type|default:'strategic_procurement' }}">
            {% endif %}

            {% for config in configs %}
            <div class="field-item">
                <input type="checkbox"
                       class="field-checkbox field-enable-checkbox"
                       name="field_{{ config.field_name }}"
                       data-field-name="{{ config.field_name }}"
                       {% if model_type == 'procurement' %}
                           {% if config.is_required %}checked{% endif %}
                       {% else %}
                           {% if config.is_enabled %}checked{% endif %}
                       {% endif %}>
                <span class="field-label">
                    {{ config.field_label }}
                    <span class="field-name">({{ config.field_name }})</span>
                </span>
            </div>
            {% endfor %}
        </form>
    </div>

    <!-- 操作按钮 -->
    <div class="action-buttons">
        <button type="button" class="btn btn-primary" id="saveBtn">
            <i class="bi bi-save"></i> 保存配置
        </button>
        <button type="button" class="btn btn-secondary" id="resetBtn">
            <i class="bi bi-arrow-counterclockwise"></i> 重置
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAll');
    const fieldCheckboxes = document.querySelectorAll('.field-enable-checkbox');
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');
    const modelType = '{{ model_type }}';
    const methodType = '{{ method_type|default:"strategic_procurement" }}';

    // 全选/取消全选
    selectAllCheckbox.addEventListener('change', function() {
        fieldCheckboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });

    // 更新全选状态
    function updateSelectAllState() {
        const allChecked = Array.from(fieldCheckboxes).every(cb => cb.checked);
        const someChecked = Array.from(fieldCheckboxes).some(cb => cb.checked);
        selectAllCheckbox.checked = allChecked;
        selectAllCheckbox.indeterminate = someChecked && !allChecked;
    }

    fieldCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectAllState);
    });

    // 初始化全选状态
    updateSelectAllState();

    // 保存配置
    saveBtn.addEventListener('click', async function() {
        const fields = [];
        fieldCheckboxes.forEach(checkbox => {
            fields.push({
                field_name: checkbox.dataset.fieldName,
                is_enabled: checkbox.checked,
                is_required: checkbox.checked  // 对于采购方式配置，使用is_required
            });
        });

        const postData = {
            model_type: modelType,
            fields: fields
        };

        // 如果是采购模式，添加method_type
        if (modelType === 'procurement') {
            postData.method_type = methodType;
        }

        try {
            const response = await fetch('{% url "update_completeness_field_config" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(postData)
            });

            const result = await response.json();

            if (result.success) {
                alert('配置保存成功！');
                location.reload();
            } else {
                alert('保存失败：' + result.message);
            }
        } catch (error) {
            console.error('保存配置失败:', error);
            alert('保存失败，请稍后重试');
        }
    });

    // 重置配置
    resetBtn.addEventListener('click', function() {
        if (confirm('确定要重置配置吗？这将恢复到页面加载时的状态。')) {
            location.reload();
        }
    });
});
</script>
{% endblock %}
