
{% extends "base.html" %}
{% load static %}

{% block title %}{{ page_title }} - 项目采购与成本管理系统{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/monitoring.css' %}">
{% endblock %}

{% block content %}
<div class="monitoring-dashboard">
    <div class="monitoring-page__header">
        <div class="monitoring-page__intro">
            <h1><i class="fas fa-tachometer-alt"></i> {{ page_title }}</h1>
            <p class="text-muted">实时监控归档状态、数据更新和业务进展</p>
        </div>
        
        <!-- 右侧工具栏：筛选器和导出按钮 -->
        <div class="monitoring-page__actions">
            <!-- 导出按钮 -->
            <a href="?export=excel{% if year_filter_value %}&year={{ year_filter_value }}{% endif %}{% if selected_project_value %}&project={{ selected_project_value }}{% endif %}"
               class="btn btn-success"
               style="white-space: nowrap; padding: 8px 16px;">
                <i class="fas fa-file-excel"></i> 导出Excel
            </a>
            
            <!-- 筛选器 -->
            <div class="monitoring-page__filters">
                {% include 'components/year_project_filter.html' with available_years=available_years projects=projects selected_year=year_filter_value selected_project=selected_project_value form_id='dashboard' %}
            </div>
        </div>
    </div>

    <!-- 关键指标仪表盘 - 突出显示最重要的数据 -->
    <div class="dashboard-gauge-container">
        <div class="gauge-card">
            <div class="gauge-wrapper">
                <svg class="gauge-svg" viewBox="0 0 160 160">
                    <defs>
                        <linearGradient id="gaugeGradientPrimary" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle class="gauge-background" cx="80" cy="80" r="70"></circle>
                    <circle class="gauge-progress primary" cx="80" cy="80" r="70"
                            stroke-dasharray="440"
                            stroke-dashoffset="{{ archive_data.overall_rate|add:'0'|floatformat:0|default:0|add:',440' }}"
                            style="stroke-dashoffset: calc(440 - (440 * {{ archive_data.overall_rate }} / 100));"></circle>
                </svg>
                <div class="gauge-value">{{ archive_data.overall_rate }}%</div>
            </div>
            <div class="gauge-label">综合归档率</div>
            <div class="gauge-subtitle">总体归档完成度</div>
        </div>

        <div class="gauge-card {% if archive_data.procurement.rate >= 80 %}success{% elif archive_data.procurement.rate >= 60 %}warning{% endif %}">
            <div class="gauge-wrapper">
                <svg class="gauge-svg" viewBox="0 0 160 160">
                    <defs>
                        <linearGradient id="gaugeGradientSuccess" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#11998e;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#38ef7d;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle class="gauge-background" cx="80" cy="80" r="70"></circle>
                    <circle class="gauge-progress {% if archive_data.procurement.rate >= 80 %}success{% else %}warning{% endif %}" cx="80" cy="80" r="70"
                            stroke-dasharray="440"
                            style="stroke-dashoffset: calc(440 - (440 * {{ archive_data.procurement.rate }} / 100));"></circle>
                </svg>
                <div class="gauge-value">{{ archive_data.procurement.rate }}%</div>
            </div>
            <div class="gauge-label">采购归档率</div>
            <div class="gauge-subtitle">已归档 {{ archive_data.procurement.archived }}/{{ archive_data.procurement.total }}</div>
        </div>

        <div class="gauge-card {% if archive_data.contract.rate >= 80 %}success{% elif archive_data.contract.rate >= 60 %}warning{% endif %}">
            <div class="gauge-wrapper">
                <svg class="gauge-svg" viewBox="0 0 160 160">
                    <defs>
                        <linearGradient id="gaugeGradientWarning" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#f093fb;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#f5576c;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle class="gauge-background" cx="80" cy="80" r="70"></circle>
                    <circle class="gauge-progress {% if archive_data.contract.rate >= 80 %}success{% else %}warning{% endif %}" cx="80" cy="80" r="70"
                            stroke-dasharray="440"
                            style="stroke-dashoffset: calc(440 - (440 * {{ archive_data.contract.rate }} / 100));"></circle>
                </svg>
                <div class="gauge-value">{{ archive_data.contract.rate }}%</div>
            </div>
            <div class="gauge-label">合同归档率</div>
            <div class="gauge-subtitle">已归档 {{ archive_data.contract.archived }}/{{ archive_data.contract.total }}</div>
        </div>

        <div class="gauge-card {% if archive_data.overall_timely_rate >= 80 %}success{% elif archive_data.overall_timely_rate >= 60 %}warning{% else %}danger{% endif %}">
            <div class="gauge-wrapper">
                <svg class="gauge-svg" viewBox="0 0 160 160">
                    <defs>
                        <linearGradient id="gaugeGradientTimely" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#52c41a;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#73d13d;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle class="gauge-background" cx="80" cy="80" r="70"></circle>
                    <circle class="gauge-progress {% if archive_data.overall_timely_rate >= 80 %}success{% elif archive_data.overall_timely_rate >= 60 %}warning{% else %}danger{% endif %}" cx="80" cy="80" r="70"
                            stroke-dasharray="440"
                            style="stroke-dashoffset: calc(440 - (440 * {{ archive_data.overall_timely_rate }} / 100));"></circle>
                </svg>
                <div class="gauge-value">{{ archive_data.overall_timely_rate }}%</div>
            </div>
            <div class="gauge-label">归档及时率</div>
            <div class="gauge-subtitle">在规定时限内完成</div>
        </div>

        <div class="gauge-card warning">
            <div class="gauge-wrapper">
                <svg class="gauge-svg" viewBox="0 0 160 160">
                    <defs>
                        <linearGradient id="gaugeGradientDanger" x1="0%" y1="0%" x2="100%" y2="0%">
                            <stop offset="0%" style="stop-color:#ff4d4f;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#ff7875;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle class="gauge-background" cx="80" cy="80" r="70"></circle>
                </svg>
                <div class="gauge-value">{{ archive_data.procurement.overdue|add:archive_data.contract.overdue }}</div>
            </div>
            <div class="gauge-label">逾期项目</div>
            <div class="gauge-subtitle">需要立即处理</div>
        </div>
    </div>

    <!-- 标签页容器 - 组织多模块数据 -->
    <div class="tab-container">
        <ul class="tab-nav">
            <li class="tab-nav-item">
                <a href="#tab-overview" class="tab-nav-link active" onclick="switchTab(event, 'tab-overview')">
                    <i class="fas fa-chart-pie"></i>
                    <span>综合概览</span>
                </a>
            </li>
            <li class="tab-nav-item">
                <a href="#tab-procurement" class="tab-nav-link" onclick="switchTab(event, 'tab-procurement')">
                    <i class="fas fa-shopping-cart"></i>
                    <span>采购详情</span>
                </a>
            </li>
            <li class="tab-nav-item">
                <a href="#tab-contract" class="tab-nav-link" onclick="switchTab(event, 'tab-contract')">
                    <i class="fas fa-file-contract"></i>
                    <span>合同详情</span>
                </a>
            </li>
            <li class="tab-nav-item">
                <a href="#tab-overdue" class="tab-nav-link" onclick="switchTab(event, 'tab-overdue')">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>逾期预警 ({{ archive_data.procurement.overdue|add:archive_data.contract.overdue }})</span>
                </a>
            </li>
        </ul>

        <!-- 标签页内容 -->
        <div class="tab-content">
            <!-- 综合概览 -->
            <div id="tab-overview" class="tab-pane active">
                <div class="key-metrics-grid">
                    <div class="key-metric-card">
                        <div class="key-metric-header">
                            <div>
                                <div class="key-metric-title">采购项目总数</div>
                                <div class="key-metric-value">{{ archive_data.procurement.total }}</div>
                            </div>
                            <div class="key-metric-icon">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                        </div>
                        <div class="key-metric-trend up">
                            <i class="fas fa-arrow-up"></i> 已归档 {{ archive_data.procurement.archived }} 项
                        </div>
                    </div>

                    <div class="key-metric-card success">
                        <div class="key-metric-header">
                            <div>
                                <div class="key-metric-title">合同项目总数</div>
                                <div class="key-metric-value">{{ archive_data.contract.total }}</div>
                            </div>
                            <div class="key-metric-icon success">
                                <i class="fas fa-file-contract"></i>
                            </div>
                        </div>
                        <div class="key-metric-trend up">
                            <i class="fas fa-arrow-up"></i> 已归档 {{ archive_data.contract.archived }} 项
                        </div>
                    </div>

                    <div class="key-metric-card warning">
                        <div class="key-metric-header">
                            <div>
                                <div class="key-metric-title">待归档项目</div>
                                <div class="key-metric-value">{{ archive_data.procurement.total|add:archive_data.contract.total|add:'-'|add:archive_data.procurement.archived|add:'-'|add:archive_data.contract.archived }}</div>
                            </div>
                            <div class="key-metric-icon warning">
                                <i class="fas fa-clock"></i>
                            </div>
                        </div>
                        <div class="key-metric-trend down">
                            <i class="fas fa-exclamation-circle"></i> 其中逾期 {{ archive_data.procurement.overdue|add:archive_data.contract.overdue }} 项
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-bar"></i> 归档完成情况</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="archiveCompletionChart" style="max-height: 250px;"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-3">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-exclamation-circle"></i> 逾期严重程度分布</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="overdueDistributionChart" style="max-height: 250px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 采购详情 -->
            <div id="tab-procurement" class="tab-pane">
                <div class="compact-stat-card">
                    <div class="stat-header">
                        <i class="fas fa-shopping-cart"></i>
                        <span>采购归档统计</span>
                    </div>
                    <div class="stat-body">
                        <div class="stat-item">
                            <div class="stat-number">{{ archive_data.procurement.total }}</div>
                            <div class="stat-label">应归档</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number text-success">{{ archive_data.procurement.archived }}</div>
                            <div class="stat-label">已归档</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number text-warning">{{ archive_data.procurement.overdue }}</div>
                            <div class="stat-label">逾期</div>
                        </div>
                        <div class="stat-item primary">
                            <div class="stat-number">{{ archive_data.procurement.rate }}%</div>
                            <div class="stat-label">归档率</div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie"></i> 采购逾期分级统计</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <div class="stat-number text-success" style="font-size: 32px;">{{ archive_data.procurement.timely_rate }}%</div>
                                <div class="stat-label">及时归档率</div>
                                <small class="text-muted">40天内完成</small>
                            </div>
                            <div class="col-6">
                                <div class="stat-number text-info" style="font-size: 32px;">{{ archive_data.procurement.avg_archive_days }}</div>
                                <div class="stat-label">平均归档周期</div>
                                <small class="text-muted">公示后天数</small>
                            </div>
                        </div>
                        <div class="row text-center">
                            <div class="col-md-4 mb-3">
                                <div class="compact-stat-card">
                                    <div class="stat-number text-danger" style="font-size: 36px;">{{ archive_data.procurement.overdue_breakdown.severe }}</div>
                                    <div class="stat-label" style="font-size: 14px; color: #e74c3c;">严重逾期</div>
                                    <small class="text-muted">超过30天</small>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="compact-stat-card">
                                    <div class="stat-number" style="font-size: 36px; color: #f39c12;">{{ archive_data.procurement.overdue_breakdown.moderate }}</div>
                                    <div class="stat-label" style="font-size: 14px; color: #f39c12;">中度逾期</div>
                                    <small class="text-muted">16-30天</small>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="compact-stat-card">
                                    <div class="stat-number" style="font-size: 36px; color: #3498db;">{{ archive_data.procurement.overdue_breakdown.mild }}</div>
                                    <div class="stat-label" style="font-size: 14px; color: #3498db;">轻度逾期</div>
                                    <small class="text-muted">1-15天</small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <canvas id="procurementArchiveChart" style="max-height: 200px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 合同详情 -->
            <div id="tab-contract" class="tab-pane">
                <div class="compact-stat-card">
                    <div class="stat-header">
                        <i class="fas fa-file-contract"></i>
                        <span>合同归档统计</span>
                    </div>
                    <div class="stat-body">
                        <div class="stat-item">
                            <div class="stat-number">{{ archive_data.contract.total }}</div>
                            <div class="stat-label">应归档</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number text-success">{{ archive_data.contract.archived }}</div>
                            <div class="stat-label">已归档</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number text-warning">{{ archive_data.contract.overdue }}</div>
                            <div class="stat-label">逾期</div>
                        </div>
                        <div class="stat-item primary">
                            <div class="stat-number">{{ archive_data.contract.rate }}%</div>
                            <div class="stat-label">归档率</div>
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie"></i> 合同逾期分级统计</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center mb-3">
                            <div class="col-6">
                                <div class="stat-number text-success" style="font-size: 32px;">{{ archive_data.contract.timely_rate }}%</div>
                                <div class="stat-label">及时归档率</div>
                                <small class="text-muted">30天内完成</small>
                            </div>
                            <div class="col-6">
                                <div class="stat-number text-info" style="font-size: 32px;">{{ archive_data.contract.avg_archive_days }}</div>
                                <div class="stat-label">平均归档周期</div>
                                <small class="text-muted">签订后天数</small>
                            </div>
                        </div>
                        <div class="row text-center">
                            <div class="col-md-4 mb-3">
                                <div class="compact-stat-card">
                                    <div class="stat-number text-danger" style="font-size: 36px;">{{ archive_data.contract.overdue_breakdown.severe }}</div>
                                    <div class="stat-label" style="font-size: 14px; color: #e74c3c;">严重逾期</div>
                                    <small class="text-muted">超过30天</small>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="compact-stat-card">
                                    <div class="stat-number" style="font-size: 36px; color: #f39c12;">{{ archive_data.contract.overdue_breakdown.moderate }}</div>
                                    <div class="stat-label" style="font-size: 14px; color: #f39c12;">中度逾期</div>
                                    <small class="text-muted">16-30天</small>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="compact-stat-card">
                                    <div class="stat-number" style="font-size: 36px; color: #3498db;">{{ archive_data.contract.overdue_breakdown.mild }}</div>
                                    <div class="stat-label" style="font-size: 14px; color: #3498db;">轻度逾期</div>
                                    <small class="text-muted">1-15天</small>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 text-center">
                            <canvas id="contractArchiveChart" style="max-height: 200px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 逾期预警 -->
            <div id="tab-overdue" class="tab-pane">
                <div class="card border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5><i class="fas fa-exclamation-triangle"></i> 逾期项目列表</h5>
                    </div>
                    <div class="card-body">
                        {% if overdue_list %}
                        <div class="table-responsive table-responsive--elevated">
                            <table class="table table-hover table-sm" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>模块</th>
                                        <th>编号</th>
                                        <th>名称</th>
                                        <th>项目</th>
                                        <th>参考日期</th>
                                        <th>逾期天数</th>
                                        <th>程度</th>
                                        <th>经办人</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in overdue_list %}
                                    <tr class="severity-{{ item.severity }}">
                                        <td><span class="badge badge-secondary">{{ item.module }}</span></td>
                                        <td><code style="font-size: 12px;">{{ item.code }}</code></td>
                                        <td>{{ item.name|truncatechars:25 }}</td>
                                        <td>
                                            {% if item.project_code %}
                                            <small>{{ item.project_code }}</small><br>
                                            <small class="text-muted">{{ item.project_name|truncatechars:15 }}</small>
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small>{{ item.reference_date_label }}</small><br>
                                            <small>{{ item.reference_date }}</small>
                                        </td>
                                        <td>
                                            <strong class="text-danger">{{ item.overdue_days }}</strong>天
                                            <br><small class="text-muted">(应≤{{ item.deadline_days }}天)</small>
                                        </td>
                                        <td>
                                            {% if item.severity == 'severe' %}
                                            <span class="badge badge-danger">严重</span>
                                            {% elif item.severity == 'moderate' %}
                                            <span class="badge badge-warning">中度</span>
                                            {% else %}
                                            <span class="badge badge-info">轻度</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ item.officer|default:"-" }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <a href="{% url 'archive_monitor' %}?year={{ year_filter_value }}{% if selected_project_value %}&project={{ selected_project_value }}{% endif %}" class="btn btn-primary">
                                查看完整列表 <i class="fas fa-arrow-right"></i>
                            </a>
                        </div>
                        {% else %}
                        <div class="alert alert-success mb-0">
                            <i class="fas fa-check-circle"></i> 太棒了！当前没有逾期项目。
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="{% static 'js/charts.js' %}"></script>
<script src="{% static 'js/monitoring.js' %}"></script>
<script>
// 标签页切换功能
function switchTab(event, tabId) {
    event.preventDefault();
    
    // 移除所有活动状态
    document.querySelectorAll('.tab-nav-link').forEach(link => {
        link.classList.remove('active');
    });
    document.querySelectorAll('.tab-pane').forEach(pane => {
        pane.classList.remove('active');
    });
    
    // 添加新的活动状态
    event.currentTarget.classList.add('active');
    document.getElementById(tabId).classList.add('active');
}

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    // 归档完成情况图表
    const archiveCompletionCtx = document.getElementById('archiveCompletionChart');
    if (archiveCompletionCtx) {
        new Chart(archiveCompletionCtx, {
            type: 'bar',
            data: {
                labels: ['采购', '合同'],
                datasets: [{
                    label: '已归档',
                    data: [{{ archive_data.procurement.archived }}, {{ archive_data.contract.archived }}],
                    backgroundColor: 'rgba(82, 196, 26, 0.8)',
                }, {
                    label: '未归档',
                    data: [{{ archive_data.procurement.total|add:'-'|add:archive_data.procurement.archived }}, 
                           {{ archive_data.contract.total|add:'-'|add:archive_data.contract.archived }}],
                    backgroundColor: 'rgba(250, 173, 20, 0.8)',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { stacked: true },
                    y: { stacked: true, beginAtZero: true }
                },
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // 逾期严重程度分布图表
    const overdueDistributionCtx = document.getElementById('overdueDistributionChart');
    if (overdueDistributionCtx) {
        new Chart(overdueDistributionCtx, {
            type: 'doughnut',
            data: {
                labels: ['严重逾期', '中度逾期', '轻度逾期'],
                datasets: [{
                    data: [
                        {{ archive_data.procurement.overdue_breakdown.severe|add:archive_data.contract.overdue_breakdown.severe }},
                        {{ archive_data.procurement.overdue_breakdown.moderate|add:archive_data.contract.overdue_breakdown.moderate }},
                        {{ archive_data.procurement.overdue_breakdown.mild|add:archive_data.contract.overdue_breakdown.mild }}
                    ],
                    backgroundColor: [
                        'rgba(255, 77, 79, 0.8)',
                        'rgba(250, 173, 20, 0.8)',
                        'rgba(24, 144, 255, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right' }
                }
            }
        });
    }
    
    // 采购归档环形图
    const procurementCtx = document.getElementById('procurementArchiveChart');
    if (procurementCtx) {
        new Chart(procurementCtx, {
            type: 'doughnut',
            data: {
                labels: ['已归档', '未归档'],
                datasets: [{
                    data: [{{ archive_data.procurement.archived }}, 
                           {{ archive_data.procurement.total|add:'-'|add:archive_data.procurement.archived }}],
                    backgroundColor: ['rgba(82, 196, 26, 0.8)', 'rgba(217, 217, 217, 0.5)']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
    
    // 合同归档环形图
    const contractCtx = document.getElementById('contractArchiveChart');
    if (contractCtx) {
        new Chart(contractCtx, {
            type: 'doughnut',
            data: {
                labels: ['已归档', '未归档'],
                datasets: [{
                    data: [{{ archive_data.contract.archived }}, 
                           {{ archive_data.contract.total|add:'-'|add:archive_data.contract.archived }}],
                    backgroundColor: ['rgba(82, 196, 26, 0.8)', 'rgba(217, 217, 217, 0.5)']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
});
</script>
{% endblock %}
