{% extends 'base.html' %}
{% load static %}

{% block title %}é‡‡è´­ç®¡ç† - é¡¹ç›®é‡‡è´­ä¸æˆæœ¬ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
{% include 'components/content_header_simple.html' with title='é‡‡è´­åˆ—è¡¨' section='é‡‡è´­ç®¡ç†' %}

<!-- ä½¿ç”¨æ–°çš„ç­›é€‰ç³»ç»Ÿ -->
{% include 'components/filter_system.html' with quick_filters=quick_filters advanced_filter_groups=advanced_filter_groups search_query=search_query search_placeholder="æœç´¢æ‹›é‡‡ç¼–å·ã€é‡‡è´­é¡¹ç›®åç§°ã€ä¸­æ ‡å•ä½..." %}

<!-- é‡‡è´­åˆ—è¡¨ -->
<!-- é‡‡è´­åˆ—è¡¨ -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fas fa-shopping-cart"></i>
            å…¨éƒ¨é‡‡è´­é¡¹ç›®
        </h2>
        <div style="display: flex; gap: 12px; align-items: center;">
            <button id="batchDeleteBtn" class="btn btn-secondary" style="background: #ff4d4f; color: white;" disabled onclick="batchDeleteProcurements()">
                <i class="fas fa-trash"></i>
                æ‰¹é‡åˆ é™¤ (<span id="selectedCount">0</span>)
            </button>
            <button onclick="showImportDialog()" class="btn btn-secondary">
                <i class="fas fa-file-import"></i>
                å¯¼å…¥æ•°æ®
            </button>
            <button type="button" onclick="showColumnSelector()" class="btn btn-secondary">
                <i class="fas fa-columns"></i>
                é€‰æ‹©å­—æ®µ
            </button>
            <button type="button" class="btn btn-primary" data-create-url="{% url 'procurement_create' %}" data-title="æ–°å¢é‡‡è´­é¡¹ç›®">
                <i class="fas fa-plus"></i>
                æ–°å¢é‡‡è´­
            </button>
        </div>
    </div>
    
    {% if procurements %}
    <div class="table-container">
        <table class="data-table" id="procurementTable">
            <thead>
                <tr>
                    <th data-column="row_number">åºå·</th>
                    <th data-column="procurement_code">æ‹›é‡‡ç¼–å·</th>
                    <th data-column="project_name">é‡‡è´­é¡¹ç›®åç§°</th>
                    <th data-column="project">æ‰€å±é¡¹ç›®</th>
                    <th data-column="procurement_unit">é‡‡è´­å•ä½</th>
                    <th data-column="winning_bidder">ä¸­æ ‡å•ä½</th>
                    <th data-column="winning_contact">ä¸­æ ‡å•ä½è”ç³»äººåŠæ–¹å¼</th>
                    <th data-column="procurement_method">é‡‡è´­æ–¹å¼</th>
                    <th data-column="procurement_category">é‡‡è´­ç±»åˆ«</th>
                    <th data-column="budget_amount">é‡‡è´­é¢„ç®—é‡‘é¢(å…ƒ)</th>
                    <th data-column="control_price">é‡‡è´­æ§åˆ¶ä»·ï¼ˆå…ƒï¼‰</th>
                    <th data-column="winning_amount">ä¸­æ ‡é‡‘é¢ï¼ˆå…ƒï¼‰</th>
                    <th data-column="planned_completion_date">è®¡åˆ’ç»“æŸé‡‡è´­æ—¶é—´</th>
                    <th data-column="candidate_publicity_end_date">å€™é€‰äººå…¬ç¤ºç»“æŸæ—¶é—´</th>
                    <th data-column="result_publicity_release_date">ç»“æœå…¬ç¤ºå‘å¸ƒæ—¶é—´</th>
                    <th data-column="notice_issue_date">ä¸­æ ‡é€šçŸ¥ä¹¦å‘æ”¾æ—¥æœŸ</th>
                    <th data-column="procurement_officer">é‡‡è´­ç»åŠäºº</th>
                    <th data-column="demand_department">éœ€æ±‚éƒ¨é—¨</th>
                    <th data-column="demand_contact">ç”³è¯·äººè”ç³»ç”µè¯ï¼ˆéœ€æ±‚éƒ¨é—¨ï¼‰</th>
                    <th data-column="requirement_approval_date">é‡‡è´­éœ€æ±‚ä¹¦å®¡æ‰¹å®Œæˆæ—¥æœŸï¼ˆOAï¼‰</th>
                    <th data-column="procurement_platform">é‡‡è´­å¹³å°</th>
                    <th data-column="qualification_review_method">èµ„æ ¼å®¡æŸ¥æ–¹å¼</th>
                    <th data-column="bid_evaluation_method">è¯„æ ‡è°ˆåˆ¤æ–¹å¼</th>
                    <th data-column="bid_awarding_method">å®šæ ‡æ–¹æ³•</th>
                    <th data-column="announcement_release_date">å…¬å‘Šå‘å¸ƒæ—¶é—´</th>
                    <th data-column="registration_deadline">æŠ¥åæˆªæ­¢æ—¶é—´</th>
                    <th data-column="bid_opening_date">å¼€æ ‡æ—¶é—´</th>
                    <th data-column="evaluation_committee">è¯„æ ‡å§”å‘˜ä¼šæˆå‘˜</th>
                    <th data-column="bid_guarantee">æŠ•æ ‡æ‹…ä¿å½¢å¼åŠé‡‘é¢ï¼ˆå…ƒï¼‰</th>
                    <th data-column="bid_guarantee_return_date">æŠ•æ ‡æ‹…ä¿é€€å›æ—¥æœŸ</th>
                    <th data-column="performance_guarantee">å±¥çº¦æ‹…ä¿å½¢å¼åŠé‡‘é¢ï¼ˆå…ƒï¼‰</th>
                    <th data-column="candidate_publicity_issue">å€™é€‰äººå…¬ç¤ºæœŸè´¨ç–‘æƒ…å†µ</th>
                    <th data-column="non_bidding_explanation">åº”æ‹›æœªæ‹›è¯´æ˜ï¼ˆç”±å…¬å¼€è½¬å•ä¸€æˆ–é‚€è¯·çš„æƒ…å†µï¼‰</th>
                    <th data-column="archive_date">èµ„æ–™å½’æ¡£æ—¥æœŸ</th>
                    <th data-column="operations">æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for proc in procurements %}
                <tr data-id="{{ proc.procurement_code }}">
                    <td data-column="row_number">{{ forloop.counter }}</td>
                    <td data-column="procurement_code">{{ proc.procurement_code }}</td>
                    <td data-column="project_name" style="max-width: 300px;">{{ proc.project_name }}</td>
                    <td data-column="project">
                        {% if proc.project %}
                            <a href="{% url 'project_detail' proc.project.project_code %}" style="color: var(--primary-color); text-decoration: none;">
                                {{ proc.project.project_name }}
                            </a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td data-column="procurement_unit">{{ proc.procurement_unit|default:"-" }}</td>
                    <td data-column="winning_bidder">{{ proc.winning_bidder|default:"-" }}</td>
                    <td data-column="winning_contact">{{ proc.winning_contact|default:"-" }}</td>
                    <td data-column="procurement_method">{{ proc.procurement_method|default:"-" }}</td>
                    <td data-column="procurement_category">{{ proc.procurement_category|default:"-" }}</td>
                    <td data-column="budget_amount">
                        {% if proc.budget_amount %}
                            Â¥{{ proc.budget_amount|floatformat:2 }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td data-column="control_price">
                        {% if proc.control_price %}
                            Â¥{{ proc.control_price|floatformat:2 }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td data-column="winning_amount">
                        {% if proc.winning_amount %}
                            Â¥{{ proc.winning_amount|floatformat:2 }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td data-column="planned_completion_date">{{ proc.planned_completion_date|default:"-" }}</td>
                    <td data-column="candidate_publicity_end_date">{{ proc.candidate_publicity_end_date|default:"-" }}</td>
                    <td data-column="result_publicity_release_date">{{ proc.result_publicity_release_date|default:"-" }}</td>
                    <td data-column="notice_issue_date">{{ proc.notice_issue_date|default:"-" }}</td>
                    <td data-column="procurement_officer">{{ proc.procurement_officer|default:"-" }}</td>
                    <td data-column="demand_department">{{ proc.demand_department|default:"-" }}</td>
                    <td data-column="demand_contact">{{ proc.demand_contact|default:"-" }}</td>
                    <td data-column="requirement_approval_date">{{ proc.requirement_approval_date|default:"-" }}</td>
                    <td data-column="procurement_platform">{{ proc.procurement_platform|default:"-" }}</td>
                    <td data-column="qualification_review_method">{{ proc.qualification_review_method|default:"-" }}</td>
                    <td data-column="bid_evaluation_method">{{ proc.bid_evaluation_method|default:"-" }}</td>
                    <td data-column="bid_awarding_method">{{ proc.bid_awarding_method|default:"-" }}</td>
                    <td data-column="announcement_release_date">{{ proc.announcement_release_date|default:"-" }}</td>
                    <td data-column="registration_deadline">{{ proc.registration_deadline|default:"-" }}</td>
                    <td data-column="bid_opening_date">{{ proc.bid_opening_date|default:"-" }}</td>
                    <td data-column="evaluation_committee" style="max-width: 200px;">{{ proc.evaluation_committee|default:"-" }}</td>
                    <td data-column="bid_guarantee">{{ proc.bid_guarantee|default:"-" }}</td>
                    <td data-column="bid_guarantee_return_date">{{ proc.bid_guarantee_return_date|default:"-" }}</td>
                    <td data-column="performance_guarantee">{{ proc.performance_guarantee|default:"-" }}</td>
                    <td data-column="candidate_publicity_issue" style="max-width: 200px;">{{ proc.candidate_publicity_issue|default:"-" }}</td>
                    <td data-column="non_bidding_explanation" style="max-width: 200px;">{{ proc.non_bidding_explanation|default:"-" }}</td>
                    <td data-column="archive_date">{{ proc.archive_date|default:"-" }}</td>
                    <td data-column="operations">
                        <a href="{% url 'procurement_detail' proc.procurement_code %}" class="btn btn-primary" style="padding: 4px 12px; font-size: 12px; margin-right: 5px;">
                            <i class="fas fa-eye"></i>
                            æŸ¥çœ‹
                        </a>
                        <button type="button" class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;" data-edit-url="{% url 'procurement_edit' proc.procurement_code %}">
                            <i class="fas fa-edit"></i>
                            ç¼–è¾‘
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-shopping-cart"></i>
        <p>æš‚æ— é‡‡è´­æ•°æ®</p>
        <button type="button" class="btn btn-primary" style="margin-top: 16px;" data-create-url="{% url 'procurement_create' %}" data-title="æ–°å¢é‡‡è´­é¡¹ç›®">
            <i class="fas fa-plus"></i>
            åˆ›å»ºç¬¬ä¸€ä¸ªé‡‡è´­é¡¹ç›®
        </button>
    </div>
    {% endif %}
    
    <!-- åˆ†é¡µ -->
    {% include 'pagination.html' with module_type='procurement' %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    // ç­›é€‰å­—æ®µæ ‡ç­¾é…ç½®
    window.filterLabels = {
        'q': 'æœç´¢',
        'project': 'é¡¹ç›®',
        'procurement_code': 'æ‹›é‡‡ç¼–å·',
        'project_name': 'é‡‡è´­é¡¹ç›®åç§°',
        'procurement_unit': 'é‡‡è´­å•ä½',
        'procurement_category': 'é‡‡è´­ç±»åˆ«',
        'procurement_method': 'é‡‡è´­æ–¹å¼',
        'qualification_review_method': 'èµ„æ ¼å®¡æŸ¥æ–¹å¼',
        'bid_evaluation_method': 'è¯„æ ‡è°ˆåˆ¤æ–¹å¼',
        'bid_awarding_method': 'å®šæ ‡æ–¹æ³•',
        'winning_bidder': 'ä¸­æ ‡å•ä½',
        'budget_amount_min': 'é‡‡è´­é¢„ç®—é‡‘é¢(æœ€å°)',
        'budget_amount_max': 'é‡‡è´­é¢„ç®—é‡‘é¢(æœ€å¤§)',
        'winning_amount_min': 'ä¸­æ ‡é‡‘é¢(æœ€å°)',
        'winning_amount_max': 'ä¸­æ ‡é‡‘é¢(æœ€å¤§)',
        'announcement_release_date_start': 'å…¬å‘Šå‘å¸ƒæ—¶é—´(èµ·)',
        'announcement_release_date_end': 'å…¬å‘Šå‘å¸ƒæ—¶é—´(æ­¢)',
        'registration_deadline_start': 'æŠ¥åæˆªæ­¢æ—¶é—´(èµ·)',
        'registration_deadline_end': 'æŠ¥åæˆªæ­¢æ—¶é—´(æ­¢)',
        'bid_opening_date_start': 'å¼€æ ‡æ—¶é—´(èµ·)',
        'bid_opening_date_end': 'å¼€æ ‡æ—¶é—´(æ­¢)',
        'candidate_publicity_end_date_start': 'å€™é€‰äººå…¬ç¤ºç»“æŸæ—¶é—´(èµ·)',
        'candidate_publicity_end_date_end': 'å€™é€‰äººå…¬ç¤ºç»“æŸæ—¶é—´(æ­¢)',
        'result_publicity_release_date_start': 'ç»“æœå…¬ç¤ºå‘å¸ƒæ—¶é—´(èµ·)',
        'result_publicity_release_date_end': 'ç»“æœå…¬ç¤ºå‘å¸ƒæ—¶é—´(æ­¢)',
        'planned_completion_date_start': 'è®¡åˆ’ç»“æŸé‡‡è´­æ—¶é—´(èµ·)',
        'planned_completion_date_end': 'è®¡åˆ’ç»“æŸé‡‡è´­æ—¶é—´(æ­¢)',
        'notice_issue_date_start': 'ä¸­æ ‡é€šçŸ¥ä¹¦å‘æ”¾æ—¥æœŸ(èµ·)',
        'notice_issue_date_end': 'ä¸­æ ‡é€šçŸ¥ä¹¦å‘æ”¾æ—¥æœŸ(æ­¢)',
        'archive_date_start': 'èµ„æ–™å½’æ¡£æ—¥æœŸ(èµ·)',
        'archive_date_end': 'èµ„æ–™å½’æ¡£æ—¥æœŸ(æ­¢)',
        'candidate_publicity_issue': 'å€™é€‰äººå…¬ç¤ºæœŸè´¨ç–‘æƒ…å†µ',
        'non_bidding_explanation': 'åº”æ‹›æœªæ‹›è¯´æ˜'
    };

    // å¯ç”¨å­—æ®µé…ç½®
    const availableColumns = [
        { key: 'row_number', label: 'åºå·', required: true },
        { key: 'procurement_code', label: 'æ‹›é‡‡ç¼–å·', required: true },
        { key: 'project_name', label: 'é‡‡è´­é¡¹ç›®åç§°', required: true },
        { key: 'project', label: 'æ‰€å±é¡¹ç›®', required: false },
        { key: 'procurement_unit', label: 'é‡‡è´­å•ä½', required: false },
        { key: 'winning_bidder', label: 'ä¸­æ ‡å•ä½', required: false },
        { key: 'winning_contact', label: 'ä¸­æ ‡å•ä½è”ç³»äººåŠæ–¹å¼', required: false },
        { key: 'procurement_method', label: 'é‡‡è´­æ–¹å¼', required: false },
        { key: 'procurement_category', label: 'é‡‡è´­ç±»åˆ«', required: false },
        { key: 'budget_amount', label: 'é‡‡è´­é¢„ç®—é‡‘é¢(å…ƒ)', required: false },
        { key: 'control_price', label: 'é‡‡è´­æ§åˆ¶ä»·ï¼ˆå…ƒï¼‰', required: false },
        { key: 'winning_amount', label: 'ä¸­æ ‡é‡‘é¢ï¼ˆå…ƒï¼‰', required: false },
        { key: 'planned_completion_date', label: 'è®¡åˆ’ç»“æŸé‡‡è´­æ—¶é—´', required: false },
        { key: 'candidate_publicity_end_date', label: 'å€™é€‰äººå…¬ç¤ºç»“æŸæ—¶é—´', required: false },
        { key: 'result_publicity_release_date', label: 'ç»“æœå…¬ç¤ºå‘å¸ƒæ—¶é—´', required: false },
        { key: 'notice_issue_date', label: 'ä¸­æ ‡é€šçŸ¥ä¹¦å‘æ”¾æ—¥æœŸ', required: false },
        { key: 'procurement_officer', label: 'é‡‡è´­ç»åŠäºº', required: false },
        { key: 'demand_department', label: 'éœ€æ±‚éƒ¨é—¨', required: false },
        { key: 'demand_contact', label: 'ç”³è¯·äººè”ç³»ç”µè¯ï¼ˆéœ€æ±‚éƒ¨é—¨ï¼‰', required: false },
        { key: 'requirement_approval_date', label: 'é‡‡è´­éœ€æ±‚ä¹¦å®¡æ‰¹å®Œæˆæ—¥æœŸï¼ˆOAï¼‰', required: false },
        { key: 'procurement_platform', label: 'é‡‡è´­å¹³å°', required: false },
        { key: 'qualification_review_method', label: 'èµ„æ ¼å®¡æŸ¥æ–¹å¼', required: false },
        { key: 'bid_evaluation_method', label: 'è¯„æ ‡è°ˆåˆ¤æ–¹å¼', required: false },
        { key: 'bid_awarding_method', label: 'å®šæ ‡æ–¹æ³•', required: false },
        { key: 'announcement_release_date', label: 'å…¬å‘Šå‘å¸ƒæ—¶é—´', required: false },
        { key: 'registration_deadline', label: 'æŠ¥åæˆªæ­¢æ—¶é—´', required: false },
        { key: 'bid_opening_date', label: 'å¼€æ ‡æ—¶é—´', required: false },
        { key: 'evaluation_committee', label: 'è¯„æ ‡å§”å‘˜ä¼šæˆå‘˜', required: false },
        { key: 'bid_guarantee', label: 'æŠ•æ ‡æ‹…ä¿å½¢å¼åŠé‡‘é¢ï¼ˆå…ƒï¼‰', required: false },
        { key: 'bid_guarantee_return_date', label: 'æŠ•æ ‡æ‹…ä¿é€€å›æ—¥æœŸ', required: false },
        { key: 'performance_guarantee', label: 'å±¥çº¦æ‹…ä¿å½¢å¼åŠé‡‘é¢ï¼ˆå…ƒï¼‰', required: false },
        { key: 'candidate_publicity_issue', label: 'å€™é€‰äººå…¬ç¤ºæœŸè´¨ç–‘æƒ…å†µ', required: false },
        { key: 'non_bidding_explanation', label: 'åº”æ‹›æœªæ‹›è¯´æ˜ï¼ˆç”±å…¬å¼€è½¬å•ä¸€æˆ–é‚€è¯·çš„æƒ…å†µï¼‰', required: false },
        { key: 'archive_date', label: 'èµ„æ–™å½’æ¡£æ—¥æœŸ', required: false },
        { key: 'operations', label: 'æ“ä½œ', required: true }
    ];

    // é»˜è®¤æ˜¾ç¤ºçš„å­—æ®µ
    const defaultColumns = ['row_number', 'procurement_code', 'project_name', 'project', 'procurement_unit', 'procurement_category', 'procurement_method', 'winning_bidder', 'budget_amount', 'winning_amount', 'result_publicity_release_date', 'operations'];

    document.addEventListener('DOMContentLoaded', function() {
        var hasProcurements = {{ procurements|yesno:"true,false" }};
        if (hasProcurements) {
            BatchOperations.init('#procurementTable', 'data-id');
            
            // åˆå§‹åŒ–å­—æ®µé€‰æ‹©å™¨
            ColumnSelector.init(availableColumns, defaultColumns, 'procurement_list_columns');
            ColumnSelector.loadColumnSettings();
        }
    });
    
    // æ˜¾ç¤ºå­—æ®µé€‰æ‹©å™¨
    function showColumnSelector() {
        ColumnSelector.showColumnSelector();
    }
    
    function batchDeleteProcurements() {
        BatchOperations.batchDelete(
            '{% url "batch_delete_procurements" %}',
            `ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${BatchOperations.getSelectedIds().length} ä¸ªé‡‡è´­é¡¹ç›®å—ï¼Ÿ\næ­¤æ“ä½œå°†åŒæ—¶åˆ é™¤ç›¸å…³çš„åˆåŒå’Œä»˜æ¬¾è®°å½•ï¼Œä¸”ä¸å¯æ¢å¤ï¼`
        );
    }
    
    // æ˜¾ç¤ºå¯¼å…¥å¯¹è¯æ¡†
    function showImportDialog() {
        const html = `
            <div id="importDialog" class="modal-overlay" onclick="closeImportDialog(event)">
                <div class="modal-content" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h3 style="font-size: 20px; font-weight: 600;">
                            <i class="fas fa-file-import"></i>
                            å¯¼å…¥é‡‡è´­æ•°æ®
                        </h3>
                        <button onclick="closeImportDialog()" style="background: none; border: none; font-size: 24px; color: var(--text-secondary); cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <!-- æ–°å¢ï¼šPDFæ™ºèƒ½å¯¼å…¥å…¥å£ -->
                        <div class="form-group" style="border: 2px solid #1890ff; border-radius: 8px; padding: 20px; margin-bottom: 24px; background: linear-gradient(135deg, #e6f7ff 0%, #f0f7ff 100%);">
                            <h5 style="color: #1890ff; margin-bottom: 12px;">
                                <i class="fas fa-file-pdf"></i>
                                ğŸ“„ PDFæ™ºèƒ½å¯¼å…¥ï¼ˆæ¨èï¼‰
                            </h5>
                            <p style="color: #595959; margin-bottom: 12px; font-size: 14px;">
                                è‡ªåŠ¨è¯†åˆ«é‡‡è´­PDFæ–‡ä»¶ç±»å‹ï¼Œæ™ºèƒ½æå–22ä¸ªå…³é”®å­—æ®µï¼ŒèŠ‚çœ80%å½•å…¥æ—¶é—´
                            </p>
                            <a href="{% url 'pdf_import:upload' %}" class="btn btn-primary btn-lg" style="width: 100%; font-size: 16px;">
                                <i class="fas fa-magic"></i>
                                ä»PDFæ™ºèƒ½å¯¼å…¥
                            </a>
                            <p style="margin-top: 8px; margin-bottom: 0; font-size: 12px; color: #8c8c8c;">
                                æ”¯æŒï¼šé‡‡è´­è¯·ç¤ºã€é‡‡è´­å…¬å‘Šã€å€™é€‰äººå…¬ç¤ºã€ç»“æœå…¬ç¤ºç­‰PDFæ–‡ä»¶
                            </p>
                        </div>

                        <div style="text-align: center; margin: 20px 0; color: #bfbfbf;">
                            <span style="background: white; padding: 0 10px;">æˆ–ä½¿ç”¨ä¼ ç»ŸExcelå¯¼å…¥</span>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Excel/CSVå¯¼å…¥è¯´æ˜</label>
                            <div style="background: #f0f7ff; border: 1px solid #bae0ff; border-radius: 6px; padding: 16px; margin-bottom: 20px;">
                                <p style="margin-bottom: 8px; color: #0958d9;">
                                    <i class="fas fa-info-circle"></i>
                                    é‡‡è´­å¯¼å…¥æ”¯æŒä»¥ä¸‹åŠŸèƒ½ï¼š
                                </p>
                                <ul style="margin-left: 20px; color: #595959;">
                                    <li>æ”¯æŒ CSV å’Œ Excel æ–‡ä»¶æ ¼å¼</li>
                                    <li>è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶ç¼–ç ï¼ˆUTF-8/GBKï¼‰</li>
                                    <li>æ”¯æŒæ›´æ–°ç°æœ‰é‡‡è´­æˆ–åˆ›å»ºæ–°é‡‡è´­</li>
                                    <li>è‡ªåŠ¨å…³è”é¡¹ç›®ä¿¡æ¯</li>
                                    <li>è¯¦ç»†çš„é”™è¯¯æç¤ºå’Œå¯¼å…¥æŠ¥å‘Š</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">é€‰æ‹©æ–‡ä»¶</label>
                            <input type="file" id="importFile" accept=".csv,.xlsx,.xls" class="form-input"
                                   style="padding: 8px;">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">å¯¼å…¥æ¨¡å¼</label>
                            <select id="conflictMode" class="form-input">
                                <option value="update">å¢é‡æ¨¡å¼ - æ›´æ–°å·²æœ‰è®°å½•ï¼Œæ·»åŠ æ–°è®°å½•ï¼ˆæ¨èï¼‰</option>
                                <option value="skip">ä»…æ–°å¢æ¨¡å¼ - åªæ·»åŠ æ–°è®°å½•ï¼Œè·³è¿‡å·²å­˜åœ¨çš„</option>
                                <option value="replace">æ›¿æ¢æ¨¡å¼ - æ¸…ç©ºé¡¹ç›®æ—§æ•°æ®ï¼Œå¯¼å…¥æ–°æ•°æ®</option>
                            </select>
                            <p style="font-size: 12px; color: #8c8c8c; margin-top: 8px;">
                                <strong>å¢é‡æ¨¡å¼</strong>ï¼šé€‚åˆæ—¥å¸¸æ›´æ–°å’Œè¡¥å……æ•°æ®<br>
                                <strong>æ›¿æ¢æ¨¡å¼</strong>ï¼šæ¸…ç©ºæŒ‡å®šé¡¹ç›®çš„æ‰€æœ‰é‡‡è´­æ•°æ®åé‡æ–°å¯¼å…¥ï¼Œè°¨æ…ä½¿ç”¨ï¼
                            </p>
                        </div>
                        
                        <div class="form-group" id="projectCodeGroup" style="display: none;">
                            <label class="form-label">
                                <i class="fas fa-exclamation-triangle" style="color: #ff4d4f;"></i>
                                é¡¹ç›®ç¼–ç ï¼ˆæ›¿æ¢æ¨¡å¼å¿…å¡«ï¼‰
                            </label>
                            <input type="text" id="projectCode" class="form-input" placeholder="è¾“å…¥è¦æ›¿æ¢æ•°æ®çš„é¡¹ç›®ç¼–ç ï¼Œå¦‚: BHHY">
                            <p style="font-size: 12px; color: #ff4d4f; margin-top: 4px;">
                                è­¦å‘Šï¼šè¯¥é¡¹ç›®çš„æ‰€æœ‰é‡‡è´­è®°å½•å°†è¢«æ¸…ç©ºï¼
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="dryRun" style="cursor: pointer;">
                                <span>ä»…éªŒè¯æ•°æ®ï¼Œä¸å®é™…å¯¼å…¥ï¼ˆé¢„æ¼”æ¨¡å¼ï¼‰</span>
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-download"></i>
                                ä¸‹è½½æ¨¡æ¿
                            </label>
                            <div style="display: flex; gap: 12px;">
                                <button type="button" class="btn btn-secondary" onclick="downloadTemplate('procurement', 'long')">
                                    <i class="fas fa-file-csv"></i>
                                    CSV é•¿è¡¨æ¨¡æ¿
                                </button>
                                <a href="/docs/å¯¼å…¥åŠŸèƒ½ä½¿ç”¨è¯´æ˜.md" target="_blank"
                                   class="btn btn-secondary" style="text-decoration: none;">
                                    <i class="fas fa-book"></i>
                                    æŸ¥çœ‹æ–‡æ¡£
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" onclick="closeImportDialog()" class="btn btn-secondary">
                            å–æ¶ˆ
                        </button>
                        <button type="button" onclick="startImport()" class="btn btn-primary">
                            <i class="fas fa-upload"></i>
                            å¼€å§‹å¯¼å…¥
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', html);
        
        // æ·»åŠ æ¨¡å¼åˆ‡æ¢äº‹ä»¶ç›‘å¬å™¨
        document.getElementById('conflictMode').addEventListener('change', function() {
            const projectCodeGroup = document.getElementById('projectCodeGroup');
            if (this.value === 'replace') {
                projectCodeGroup.style.display = 'block';
            } else {
                projectCodeGroup.style.display = 'none';
            }
        });
    }
    
    // å…³é—­å¯¼å…¥å¯¹è¯æ¡†
    function closeImportDialog(event) {
        if (event && event.target.id !== 'importDialog') return;
        const modal = document.getElementById('importDialog');
        if (modal) modal.remove();
    }
    
    // å¼€å§‹å¯¼å…¥
    function startImport() {
        const fileInput = document.getElementById('importFile');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('è¯·é€‰æ‹©è¦å¯¼å…¥çš„æ–‡ä»¶');
            return;
        }
        
        // æ£€æŸ¥æ–‡ä»¶æ ¼å¼
        const fileName = file.name.toLowerCase();
        if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
            alert('ä»…æ”¯æŒ CSV å’Œ Excel æ–‡ä»¶æ ¼å¼');
            return;
        }
        
        const conflictMode = document.getElementById('conflictMode').value;
        const dryRun = document.getElementById('dryRun').checked;
        
        // æ›¿æ¢æ¨¡å¼éœ€è¦é¡¹ç›®ç¼–ç 
        if (conflictMode === 'replace') {
            const projectCode = document.getElementById('projectCode').value.trim();
            if (!projectCode) {
                alert('æ›¿æ¢æ¨¡å¼å¿…é¡»å¡«å†™é¡¹ç›®ç¼–ç ï¼');
                return;
            }
            
            // äºŒæ¬¡ç¡®è®¤
            const confirmMsg = dryRun
                ? `ç¡®è®¤è¦éªŒè¯é¡¹ç›®ã€${projectCode}ã€‘çš„æ•°æ®æ›¿æ¢å—ï¼Ÿ\n\nè¿™å°†æ¨¡æ‹Ÿæ¸…ç©ºè¯¥é¡¹ç›®çš„æ‰€æœ‰é‡‡è´­è®°å½•ã€‚`
                : `âš ï¸ è­¦å‘Šï¼šå³å°†æ¸…ç©ºé¡¹ç›®ã€${projectCode}ã€‘çš„æ‰€æœ‰é‡‡è´­è®°å½•ï¼\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
        }
        
        // åˆ›å»ºFormData
        const formData = new FormData();
        formData.append('file', file);
        formData.append('module', 'procurement');
        formData.append('conflict_mode', conflictMode);
        formData.append('dry_run', dryRun);
        if (conflictMode === 'replace') {
            formData.append('project_code', document.getElementById('projectCode').value.trim());
        }
        
        // æ˜¾ç¤ºä¸Šä¼ è¿›åº¦
        const modal = document.getElementById('importDialog');
        const modalBody = modal.querySelector('.modal-body');
        
        modalBody.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div class="spinner" style="margin: 0 auto 20px;"></div>
                <p style="font-size: 16px; color: var(--text-primary);">
                    ${dryRun ? 'æ­£åœ¨éªŒè¯æ•°æ®...' : 'æ­£åœ¨å¯¼å…¥æ•°æ®...'}
                </p>
                <p style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">
                    è¯·ç¨å€™ï¼Œè¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´
                </p>
            </div>
        `;
        
        // è·å–CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrftoken = getCookie('csrftoken');
        
        // å‘é€å¯¼å…¥è¯·æ±‚
        fetch('/api/import/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // æ˜¾ç¤ºæˆåŠŸç»“æœ
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-check-circle" style="font-size: 64px; color: var(--success-color); margin-bottom: 20px;"></i>
                        <h3 style="font-size: 20px; margin-bottom: 16px;">
                            ${dryRun ? 'éªŒè¯æˆåŠŸï¼' : (data.message_type === 'warning' ? 'å¯¼å…¥æç¤º' : 'å¯¼å…¥å®Œæˆï¼')}
                        </h3>
                        
                        <!-- ä¸»è¦æç¤ºæ¶ˆæ¯ -->
                        <div style="background: ${data.message_type === 'warning' ? '#fffbe6' : '#f6ffed'};
                                    border: 1px solid ${data.message_type === 'warning' ? '#ffe58f' : '#b7eb8f'};
                                    border-radius: 6px; padding: 16px; margin: 20px 0;">
                            <p style="color: ${data.message_type === 'warning' ? '#d46b08' : '#237804'}; font-size: 15px; font-weight: 500;">
                                ${data.message}
                            </p>
                        </div>
                        
                        <!-- è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯ -->
                        <div style="background: #fafafa; border: 1px solid #d9d9d9; border-radius: 6px; padding: 16px; margin: 20px 0; text-align: left;">
                            <p style="margin-bottom: 12px; font-weight: 600; font-size: 14px;">ğŸ“Š è¯¦ç»†ç»Ÿè®¡</p>
                            
                            ${data.stats.valid_rows > 0 ? `
                            <p style="margin: 6px 0; font-size: 13px;">
                                <strong>æ–‡ä»¶æ€»è®¡ï¼š</strong>
                                å…± ${data.stats.total_rows || data.stats.valid_rows} è¡Œ
                                ${data.stats.empty_rows > 0 ? `ï¼ˆå« ${data.stats.empty_rows} è¡Œç©ºè¡Œï¼‰` : ''}
                                ${data.stats.template_rows > 0 ? `ï¼ˆå« ${data.stats.template_rows} è¡Œæ¨¡æ¿è¯´æ˜ï¼‰` : ''}
                            </p>
                            <p style="margin: 6px 0; font-size: 13px;">
                                <strong>æœ‰æ•ˆæ•°æ®ï¼š</strong>${data.stats.valid_rows} è¡Œ
                            </p>
                            ` : `
                            <p style="margin: 6px 0; font-size: 13px;">
                                <strong>å¤„ç†è¡Œæ•°ï¼š</strong>${data.stats.total || 0} è¡Œ
                            </p>
                            `}
                            
                            <hr style="margin: 12px 0; border: none; border-top: 1px solid #e8e8e8;">
                            
                            ${data.stats.actual_imported > 0 ? `
                            <p style="margin: 6px 0; font-size: 13px; color: var(--success-color);">
                                <strong>âœ“ æˆåŠŸå¯¼å…¥ï¼š</strong>${data.stats.actual_imported} æ¡
                            </p>
                            ` : ''}
                            
                            ${data.stats.created > 0 ? `
                            <p style="margin: 6px 0 6px 20px; font-size: 13px;">
                                â€¢ æ–°å¢è®°å½•ï¼š${data.stats.created} æ¡
                            </p>
                            ` : ''}
                            
                            ${data.stats.updated > 0 ? `
                            <p style="margin: 6px 0 6px 20px; font-size: 13px;">
                                â€¢ æ›´æ–°è®°å½•ï¼š${data.stats.updated} æ¡
                            </p>
                            ` : ''}
                            
                            ${data.stats.skipped > 0 ? `
                            <p style="margin: 6px 0; font-size: 13px; color: #faad14;">
                                <strong>âŠ˜ è·³è¿‡é‡å¤ï¼š</strong>${data.stats.skipped} æ¡ï¼ˆå·²å­˜åœ¨æ•°æ®åº“ï¼‰
                            </p>
                            ` : ''}
                            
                            ${data.stats.error_rows > 0 ? `
                            <p style="margin: 6px 0; font-size: 13px; color: var(--error-color);">
                                <strong>âœ— å¯¼å…¥å¤±è´¥ï¼š</strong>${data.stats.error_rows} æ¡
                            </p>
                            ` : ''}
                        </div>
                        
                        <!-- é”™è¯¯è¯¦æƒ… -->
                        ${data.errors && data.errors.length > 0 ? `
                        <div style="background: #fff1f0; border: 1px solid #ffa39e; border-radius: 6px; padding: 16px; margin: 20px 0; text-align: left; max-height: 200px; overflow-y: auto;">
                            <p style="margin-bottom: 8px; color: var(--error-color); font-weight: 600;">âŒ é”™è¯¯è¯¦æƒ…ï¼š</p>
                            ${data.errors.map(err => `<p style="font-size: 13px; margin: 4px 0;">â€¢ ${err}</p>`).join('')}
                            ${data.has_more_errors ? '<p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">... è¿˜æœ‰æ›´å¤šé”™è¯¯ï¼Œè¯·æ£€æŸ¥å¯¼å…¥æ–‡ä»¶</p>' : ''}
                        </div>
                        ` : ''}
                        ${!dryRun ? `
                            <button onclick="window.location.reload()" class="btn btn-primary" style="margin-top: 16px;">
                                <i class="fas fa-sync"></i>
                                åˆ·æ–°é¡µé¢æŸ¥çœ‹ç»“æœ
                            </button>
                        ` : `
                            <button onclick="closeImportDialog(); showImportDialog();" class="btn btn-primary" style="margin-top: 16px;">
                                <i class="fas fa-upload"></i>
                                å¼€å§‹æ­£å¼å¯¼å…¥
                            </button>
                        `}
                    </div>
                `;
            } else {
                // æ˜¾ç¤ºé”™è¯¯
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-circle" style="font-size: 64px; color: var(--error-color); margin-bottom: 20px;"></i>
                        <h3 style="font-size: 20px; margin-bottom: 16px; color: var(--error-color);">å¯¼å…¥å¤±è´¥</h3>
                        <div style="background: #fff1f0; border: 1px solid #ffa39e; border-radius: 6px; padding: 16px; margin: 20px 0; text-align: left;">
                            <p style="color: var(--error-color);">${data.message || 'æœªçŸ¥é”™è¯¯'}</p>
                            ${data.errors ? `<pre style="margin-top: 12px; font-size: 12px; overflow-x: auto;">${data.errors}</pre>` : ''}
                        </div>
                        <button onclick="closeImportDialog(); showImportDialog();" class="btn btn-primary" style="margin-top: 16px;">
                            <i class="fas fa-redo"></i>
                            é‡æ–°å°è¯•
                        </button>
                    </div>
                `;
            }
        })
        .catch(error => {
            modalBody.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 64px; color: var(--error-color); margin-bottom: 20px;"></i>
                    <h3 style="font-size: 20px; margin-bottom: 16px; color: var(--error-color);">è¯·æ±‚å¤±è´¥</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">${error.message}</p>
                    <div style="background: #fff1f0; border: 1px solid #ffa39e; border-radius: 6px; padding: 16px; margin: 20px 0; text-align: left;">
                        <p style="font-size: 13px; color: var(--text-secondary);">
                            æç¤ºï¼šè¯·ç¡®ä¿åç«¯æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼Œå¹¶ä¸”å¯¼å…¥æ¥å£ /api/import/ å·²é…ç½®ã€‚
                        </p>
                    </div>
                    <button onclick="closeImportDialog(); showImportDialog();" class="btn btn-primary">
                        <i class="fas fa-redo"></i>
                        é‡æ–°å°è¯•
                    </button>
                </div>
            `;
        });
    }
    
    // ä¸‹è½½æ¨¡æ¿å‡½æ•°
    function downloadTemplate(module, mode) {
        const url = `{% url 'download_import_template' %}?module=${module}&mode=${mode}`;
        
        // ä½¿ç”¨fetch APIä¸‹è½½æ–‡ä»¶
        fetch(url, {
            method: 'GET',
            credentials: 'same-origin'
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('ä¸‹è½½å¤±è´¥');
            }
            return response.blob();
        })
        .then(blob => {
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const downloadUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = downloadUrl;
            a.download = `é‡‡è´­å¯¼å…¥æ¨¡æ¿_${module}_${mode}.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(downloadUrl);
            document.body.removeChild(a);
        })
        .catch(error => {
            alert('æ¨¡æ¿ä¸‹è½½å¤±è´¥ï¼š' + error.message);
        });
    }
</script>

{# edit-modal.js å·²åœ¨ base.html ä¸­å…¨å±€å¼•å…¥ #}
{% endblock %}
