{% extends 'base.html' %}
{% load static %}

{% block title %}采购管理 - 项目采购与成本管理系统{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/edit-modal.css' %}">
{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="content-title">采购管理</h1>
    <div class="breadcrumb">
        <a href="{% url 'dashboard' %}">首页</a>
        <span>/</span>
        <span>采购管理</span>
    </div>
</div>

<!-- 使用新的筛选系统 -->
{% include 'components/filter_system.html' with quick_filters=quick_filters advanced_filter_groups=advanced_filter_groups search_query=search_query search_placeholder="搜索招采编号、采购项目名称、中标单位..." %}

<!-- 采购列表 -->
<!-- 采购列表 -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fas fa-shopping-cart"></i>
            全部采购项目
        </h2>
        <div style="display: flex; gap: 12px; align-items: center;">
            <button id="batchDeleteBtn" class="btn btn-secondary" style="background: #ff4d4f; color: white;" disabled onclick="batchDeleteProcurements()">
                <i class="fas fa-trash"></i>
                批量删除 (<span id="selectedCount">0</span>)
            </button>
            <button onclick="showImportDialog()" class="btn btn-secondary">
                <i class="fas fa-file-import"></i>
                导入数据
            </button>
            <button type="button" onclick="showColumnSelector()" class="btn btn-secondary">
                <i class="fas fa-columns"></i>
                选择字段
            </button>
            <button type="button" class="btn btn-primary" data-create-url="{% url 'procurement_create' %}" data-title="新增采购项目">
                <i class="fas fa-plus"></i>
                新增采购
            </button>
        </div>
    </div>
    
    {% if procurements %}
    <div class="table-container">
        <table class="data-table" id="procurementTable">
            <thead>
                <tr>
                    <th data-column="row_number">序号</th>
                    <th data-column="procurement_code">招采编号</th>
                    <th data-column="project_name">采购项目名称</th>
                    <th data-column="project">所属项目</th>
                    <th data-column="procurement_unit">采购单位</th>
                    <th data-column="winning_bidder">中标单位</th>
                    <th data-column="winning_contact">中标单位联系人及方式</th>
                    <th data-column="procurement_method">采购方式</th>
                    <th data-column="procurement_category">采购类别</th>
                    <th data-column="budget_amount">采购预算金额(元)</th>
                    <th data-column="control_price">采购控制价（元）</th>
                    <th data-column="winning_amount">中标金额（元）</th>
                    <th data-column="planned_completion_date">计划结束采购时间</th>
                    <th data-column="candidate_publicity_end_date">候选人公示结束时间</th>
                    <th data-column="result_publicity_release_date">结果公示发布时间</th>
                    <th data-column="notice_issue_date">中标通知书发放日期</th>
                    <th data-column="procurement_officer">采购经办人</th>
                    <th data-column="demand_department">需求部门</th>
                    <th data-column="demand_contact">申请人联系电话（需求部门）</th>
                    <th data-column="requirement_approval_date">采购需求书审批完成日期（OA）</th>
                    <th data-column="procurement_platform">采购平台</th>
                    <th data-column="qualification_review_method">资格审查方式</th>
                    <th data-column="bid_evaluation_method">评标谈判方式</th>
                    <th data-column="bid_awarding_method">定标方法</th>
                    <th data-column="announcement_release_date">公告发布时间</th>
                    <th data-column="registration_deadline">报名截止时间</th>
                    <th data-column="bid_opening_date">开标时间</th>
                    <th data-column="evaluation_committee">评标委员会成员</th>
                    <th data-column="bid_guarantee">投标担保形式及金额（元）</th>
                    <th data-column="bid_guarantee_return_date">投标担保退回日期</th>
                    <th data-column="performance_guarantee">履约担保形式及金额（元）</th>
                    <th data-column="candidate_publicity_issue">候选人公示期质疑情况</th>
                    <th data-column="non_bidding_explanation">应招未招说明（由公开转单一或邀请的情况）</th>
                    <th data-column="archive_date">资料归档日期</th>
                    <th data-column="operations">操作</th>
                </tr>
            </thead>
            <tbody>
                {% for proc in procurements %}
                <tr data-id="{{ proc.procurement_code }}">
                    <td data-column="row_number">{{ forloop.counter }}</td>
                    <td data-column="procurement_code">{{ proc.procurement_code }}</td>
                    <td data-column="project_name" style="max-width: 300px;">{{ proc.project_name }}</td>
                    <td data-column="project">
                        {% if proc.project %}
                            <a href="{% url 'project_detail' proc.project.project_code %}" style="color: var(--primary-color); text-decoration: none;">
                                {{ proc.project.project_name }}
                            </a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td data-column="procurement_unit">{{ proc.procurement_unit|default:"-" }}</td>
                    <td data-column="winning_bidder">{{ proc.winning_bidder|default:"-" }}</td>
                    <td data-column="winning_contact">{{ proc.winning_contact|default:"-" }}</td>
                    <td data-column="procurement_method">{{ proc.procurement_method|default:"-" }}</td>
                    <td data-column="procurement_category">{{ proc.procurement_category|default:"-" }}</td>
                    <td data-column="budget_amount">
                        {% if proc.budget_amount %}
                            ¥{{ proc.budget_amount|floatformat:2 }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td data-column="control_price">
                        {% if proc.control_price %}
                            ¥{{ proc.control_price|floatformat:2 }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td data-column="winning_amount">
                        {% if proc.winning_amount %}
                            ¥{{ proc.winning_amount|floatformat:2 }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td data-column="planned_completion_date">{{ proc.planned_completion_date|default:"-" }}</td>
                    <td data-column="candidate_publicity_end_date">{{ proc.candidate_publicity_end_date|default:"-" }}</td>
                    <td data-column="result_publicity_release_date">{{ proc.result_publicity_release_date|default:"-" }}</td>
                    <td data-column="notice_issue_date">{{ proc.notice_issue_date|default:"-" }}</td>
                    <td data-column="procurement_officer">{{ proc.procurement_officer|default:"-" }}</td>
                    <td data-column="demand_department">{{ proc.demand_department|default:"-" }}</td>
                    <td data-column="demand_contact">{{ proc.demand_contact|default:"-" }}</td>
                    <td data-column="requirement_approval_date">{{ proc.requirement_approval_date|default:"-" }}</td>
                    <td data-column="procurement_platform">{{ proc.procurement_platform|default:"-" }}</td>
                    <td data-column="qualification_review_method">{{ proc.qualification_review_method|default:"-" }}</td>
                    <td data-column="bid_evaluation_method">{{ proc.bid_evaluation_method|default:"-" }}</td>
                    <td data-column="bid_awarding_method">{{ proc.bid_awarding_method|default:"-" }}</td>
                    <td data-column="announcement_release_date">{{ proc.announcement_release_date|default:"-" }}</td>
                    <td data-column="registration_deadline">{{ proc.registration_deadline|default:"-" }}</td>
                    <td data-column="bid_opening_date">{{ proc.bid_opening_date|default:"-" }}</td>
                    <td data-column="evaluation_committee" style="max-width: 200px;">{{ proc.evaluation_committee|default:"-" }}</td>
                    <td data-column="bid_guarantee">{{ proc.bid_guarantee|default:"-" }}</td>
                    <td data-column="bid_guarantee_return_date">{{ proc.bid_guarantee_return_date|default:"-" }}</td>
                    <td data-column="performance_guarantee">{{ proc.performance_guarantee|default:"-" }}</td>
                    <td data-column="candidate_publicity_issue" style="max-width: 200px;">{{ proc.candidate_publicity_issue|default:"-" }}</td>
                    <td data-column="non_bidding_explanation" style="max-width: 200px;">{{ proc.non_bidding_explanation|default:"-" }}</td>
                    <td data-column="archive_date">{{ proc.archive_date|default:"-" }}</td>
                    <td data-column="operations">
                        <a href="{% url 'procurement_detail' proc.procurement_code %}" class="btn btn-primary" style="padding: 4px 12px; font-size: 12px; margin-right: 5px;">
                            <i class="fas fa-eye"></i>
                            查看
                        </a>
                        <button type="button" class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;" data-edit-url="{% url 'procurement_edit' proc.procurement_code %}">
                            <i class="fas fa-edit"></i>
                            编辑
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-shopping-cart"></i>
        <p>暂无采购数据</p>
        <button type="button" class="btn btn-primary" style="margin-top: 16px;" data-create-url="{% url 'procurement_create' %}" data-title="新增采购项目">
            <i class="fas fa-plus"></i>
            创建第一个采购项目
        </button>
    </div>
    {% endif %}
    
    <!-- 分页 -->
    {% include 'pagination.html' with module_type='procurement' %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    // 筛选字段标签配置
    window.filterLabels = {
        'q': '搜索',
        'project': '项目',
        'procurement_code': '招采编号',
        'project_name': '采购项目名称',
        'procurement_unit': '采购单位',
        'procurement_category': '采购类别',
        'procurement_method': '采购方式',
        'qualification_review_method': '资格审查方式',
        'bid_evaluation_method': '评标谈判方式',
        'bid_awarding_method': '定标方法',
        'winning_bidder': '中标单位',
        'budget_amount_min': '采购预算金额(最小)',
        'budget_amount_max': '采购预算金额(最大)',
        'winning_amount_min': '中标金额(最小)',
        'winning_amount_max': '中标金额(最大)',
        'announcement_release_date_start': '公告发布时间(起)',
        'announcement_release_date_end': '公告发布时间(止)',
        'registration_deadline_start': '报名截止时间(起)',
        'registration_deadline_end': '报名截止时间(止)',
        'bid_opening_date_start': '开标时间(起)',
        'bid_opening_date_end': '开标时间(止)',
        'candidate_publicity_end_date_start': '候选人公示结束时间(起)',
        'candidate_publicity_end_date_end': '候选人公示结束时间(止)',
        'result_publicity_release_date_start': '结果公示发布时间(起)',
        'result_publicity_release_date_end': '结果公示发布时间(止)',
        'planned_completion_date_start': '计划结束采购时间(起)',
        'planned_completion_date_end': '计划结束采购时间(止)',
        'notice_issue_date_start': '中标通知书发放日期(起)',
        'notice_issue_date_end': '中标通知书发放日期(止)',
        'archive_date_start': '资料归档日期(起)',
        'archive_date_end': '资料归档日期(止)',
        'candidate_publicity_issue': '候选人公示期质疑情况',
        'non_bidding_explanation': '应招未招说明'
    };

    // 可用字段配置
    const availableColumns = [
        { key: 'row_number', label: '序号', required: true },
        { key: 'procurement_code', label: '招采编号', required: true },
        { key: 'project_name', label: '采购项目名称', required: true },
        { key: 'project', label: '所属项目', required: false },
        { key: 'procurement_unit', label: '采购单位', required: false },
        { key: 'winning_bidder', label: '中标单位', required: false },
        { key: 'winning_contact', label: '中标单位联系人及方式', required: false },
        { key: 'procurement_method', label: '采购方式', required: false },
        { key: 'procurement_category', label: '采购类别', required: false },
        { key: 'budget_amount', label: '采购预算金额(元)', required: false },
        { key: 'control_price', label: '采购控制价（元）', required: false },
        { key: 'winning_amount', label: '中标金额（元）', required: false },
        { key: 'planned_completion_date', label: '计划结束采购时间', required: false },
        { key: 'candidate_publicity_end_date', label: '候选人公示结束时间', required: false },
        { key: 'result_publicity_release_date', label: '结果公示发布时间', required: false },
        { key: 'notice_issue_date', label: '中标通知书发放日期', required: false },
        { key: 'procurement_officer', label: '采购经办人', required: false },
        { key: 'demand_department', label: '需求部门', required: false },
        { key: 'demand_contact', label: '申请人联系电话（需求部门）', required: false },
        { key: 'requirement_approval_date', label: '采购需求书审批完成日期（OA）', required: false },
        { key: 'procurement_platform', label: '采购平台', required: false },
        { key: 'qualification_review_method', label: '资格审查方式', required: false },
        { key: 'bid_evaluation_method', label: '评标谈判方式', required: false },
        { key: 'bid_awarding_method', label: '定标方法', required: false },
        { key: 'announcement_release_date', label: '公告发布时间', required: false },
        { key: 'registration_deadline', label: '报名截止时间', required: false },
        { key: 'bid_opening_date', label: '开标时间', required: false },
        { key: 'evaluation_committee', label: '评标委员会成员', required: false },
        { key: 'bid_guarantee', label: '投标担保形式及金额（元）', required: false },
        { key: 'bid_guarantee_return_date', label: '投标担保退回日期', required: false },
        { key: 'performance_guarantee', label: '履约担保形式及金额（元）', required: false },
        { key: 'candidate_publicity_issue', label: '候选人公示期质疑情况', required: false },
        { key: 'non_bidding_explanation', label: '应招未招说明（由公开转单一或邀请的情况）', required: false },
        { key: 'archive_date', label: '资料归档日期', required: false },
        { key: 'operations', label: '操作', required: true }
    ];

    // 默认显示的字段
    const defaultColumns = ['row_number', 'procurement_code', 'project_name', 'project', 'procurement_unit', 'procurement_category', 'procurement_method', 'winning_bidder', 'budget_amount', 'winning_amount', 'result_publicity_release_date', 'operations'];

    document.addEventListener('DOMContentLoaded', function() {
        {% if procurements %}
        BatchOperations.init('#procurementTable', 'data-id');
        
        // 初始化字段选择器
        ColumnSelector.init(availableColumns, defaultColumns, 'procurement_list_columns');
        ColumnSelector.loadColumnSettings();
        {% endif %}
    });
    
    // 显示字段选择器
    function showColumnSelector() {
        ColumnSelector.showColumnSelector();
    }
    
    function batchDeleteProcurements() {
        BatchOperations.batchDelete(
            '{% url "batch_delete_procurements" %}',
            `确定要删除选中的 ${BatchOperations.getSelectedIds().length} 个采购项目吗？\n此操作将同时删除相关的合同和付款记录，且不可恢复！`
        );
    }
    
    // 显示导入对话框
    function showImportDialog() {
        const html = `
            <div id="importDialog" class="modal-overlay" onclick="closeImportDialog(event)">
                <div class="modal-content" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h3 style="font-size: 20px; font-weight: 600;">
                            <i class="fas fa-file-import"></i>
                            导入采购数据
                        </h3>
                        <button onclick="closeImportDialog()" style="background: none; border: none; font-size: 24px; color: var(--text-secondary); cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">导入说明</label>
                            <div style="background: #f0f7ff; border: 1px solid #bae0ff; border-radius: 6px; padding: 16px; margin-bottom: 20px;">
                                <p style="margin-bottom: 8px; color: #0958d9;">
                                    <i class="fas fa-info-circle"></i>
                                    采购导入支持以下功能：
                                </p>
                                <ul style="margin-left: 20px; color: #595959;">
                                    <li>支持 CSV 和 Excel 文件格式</li>
                                    <li>自动检测文件编码（UTF-8/GBK）</li>
                                    <li>支持更新现有采购或创建新采购</li>
                                    <li>自动关联项目信息</li>
                                    <li>详细的错误提示和导入报告</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">选择文件</label>
                            <input type="file" id="importFile" accept=".csv,.xlsx,.xls" class="form-input"
                                   style="padding: 8px;">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">导入模式</label>
                            <select id="conflictMode" class="form-input">
                                <option value="update">增量模式 - 更新已有记录，添加新记录（推荐）</option>
                                <option value="skip">仅新增模式 - 只添加新记录，跳过已存在的</option>
                                <option value="replace">替换模式 - 清空项目旧数据，导入新数据</option>
                            </select>
                            <p style="font-size: 12px; color: #8c8c8c; margin-top: 8px;">
                                <strong>增量模式</strong>：适合日常更新和补充数据<br>
                                <strong>替换模式</strong>：清空指定项目的所有采购数据后重新导入，谨慎使用！
                            </p>
                        </div>
                        
                        <div class="form-group" id="projectCodeGroup" style="display: none;">
                            <label class="form-label">
                                <i class="fas fa-exclamation-triangle" style="color: #ff4d4f;"></i>
                                项目编码（替换模式必填）
                            </label>
                            <input type="text" id="projectCode" class="form-input" placeholder="输入要替换数据的项目编码，如: BHHY">
                            <p style="font-size: 12px; color: #ff4d4f; margin-top: 4px;">
                                警告：该项目的所有采购记录将被清空！
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="dryRun" style="cursor: pointer;">
                                <span>仅验证数据，不实际导入（预演模式）</span>
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-download"></i>
                                下载模板
                            </label>
                            <div style="display: flex; gap: 12px;">
                                <a href="{% url 'download_import_template' %}?module=procurement&mode=long" download
                                   class="btn btn-secondary" style="text-decoration: none;">
                                    <i class="fas fa-file-csv"></i>
                                    CSV 长表模板
                                </a>
                                <a href="/docs/导入功能使用说明.md" target="_blank"
                                   class="btn btn-secondary" style="text-decoration: none;">
                                    <i class="fas fa-book"></i>
                                    查看文档
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" onclick="closeImportDialog()" class="btn btn-secondary">
                            取消
                        </button>
                        <button type="button" onclick="startImport()" class="btn btn-primary">
                            <i class="fas fa-upload"></i>
                            开始导入
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', html);
        
        // 添加模式切换事件监听器
        document.getElementById('conflictMode').addEventListener('change', function() {
            const projectCodeGroup = document.getElementById('projectCodeGroup');
            if (this.value === 'replace') {
                projectCodeGroup.style.display = 'block';
            } else {
                projectCodeGroup.style.display = 'none';
            }
        });
    }
    
    // 关闭导入对话框
    function closeImportDialog(event) {
        if (event && event.target.id !== 'importDialog') return;
        const modal = document.getElementById('importDialog');
        if (modal) modal.remove();
    }
    
    // 开始导入
    function startImport() {
        const fileInput = document.getElementById('importFile');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('请选择要导入的文件');
            return;
        }
        
        // 检查文件格式
        const fileName = file.name.toLowerCase();
        if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
            alert('仅支持 CSV 和 Excel 文件格式');
            return;
        }
        
        const conflictMode = document.getElementById('conflictMode').value;
        const dryRun = document.getElementById('dryRun').checked;
        
        // 替换模式需要项目编码
        if (conflictMode === 'replace') {
            const projectCode = document.getElementById('projectCode').value.trim();
            if (!projectCode) {
                alert('替换模式必须填写项目编码！');
                return;
            }
            
            // 二次确认
            const confirmMsg = dryRun
                ? `确认要验证项目【${projectCode}】的数据替换吗？\n\n这将模拟清空该项目的所有采购记录。`
                : `⚠️ 警告：即将清空项目【${projectCode}】的所有采购记录！\n\n此操作不可恢复，确定继续吗？`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
        }
        
        // 创建FormData
        const formData = new FormData();
        formData.append('file', file);
        formData.append('module', 'procurement');
        formData.append('conflict_mode', conflictMode);
        formData.append('dry_run', dryRun);
        if (conflictMode === 'replace') {
            formData.append('project_code', document.getElementById('projectCode').value.trim());
        }
        
        // 显示上传进度
        const modal = document.getElementById('importDialog');
        const modalBody = modal.querySelector('.modal-body');
        
        modalBody.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div class="spinner" style="margin: 0 auto 20px;"></div>
                <p style="font-size: 16px; color: var(--text-primary);">
                    ${dryRun ? '正在验证数据...' : '正在导入数据...'}
                </p>
                <p style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">
                    请稍候，这可能需要几分钟时间
                </p>
            </div>
        `;
        
        // 获取CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        const csrftoken = getCookie('csrftoken');
        
        // 发送导入请求
        fetch('/api/import/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 显示成功结果
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-check-circle" style="font-size: 64px; color: var(--success-color); margin-bottom: 20px;"></i>
                        <h3 style="font-size: 20px; margin-bottom: 16px;">
                            ${dryRun ? '验证成功！' : (data.message_type === 'warning' ? '导入提示' : '导入完成！')}
                        </h3>
                        
                        <!-- 主要提示消息 -->
                        <div style="background: ${data.message_type === 'warning' ? '#fffbe6' : '#f6ffed'};
                                    border: 1px solid ${data.message_type === 'warning' ? '#ffe58f' : '#b7eb8f'};
                                    border-radius: 6px; padding: 16px; margin: 20px 0;">
                            <p style="color: ${data.message_type === 'warning' ? '#d46b08' : '#237804'}; font-size: 15px; font-weight: 500;">
                                ${data.message}
                            </p>
                        </div>
                        
                        <!-- 详细统计信息 -->
                        <div style="background: #fafafa; border: 1px solid #d9d9d9; border-radius: 6px; padding: 16px; margin: 20px 0; text-align: left;">
                            <p style="margin-bottom: 12px; font-weight: 600; font-size: 14px;">📊 详细统计</p>
                            
                            ${data.stats.valid_rows > 0 ? `
                            <p style="margin: 6px 0; font-size: 13px;">
                                <strong>文件总计：</strong>
                                共 ${data.stats.total_rows || data.stats.valid_rows} 行
                                ${data.stats.empty_rows > 0 ? `（含 ${data.stats.empty_rows} 行空行）` : ''}
                                ${data.stats.template_rows > 0 ? `（含 ${data.stats.template_rows} 行模板说明）` : ''}
                            </p>
                            <p style="margin: 6px 0; font-size: 13px;">
                                <strong>有效数据：</strong>${data.stats.valid_rows} 行
                            </p>
                            ` : `
                            <p style="margin: 6px 0; font-size: 13px;">
                                <strong>处理行数：</strong>${data.stats.total || 0} 行
                            </p>
                            `}
                            
                            <hr style="margin: 12px 0; border: none; border-top: 1px solid #e8e8e8;">
                            
                            ${data.stats.actual_imported > 0 ? `
                            <p style="margin: 6px 0; font-size: 13px; color: var(--success-color);">
                                <strong>✓ 成功导入：</strong>${data.stats.actual_imported} 条
                            </p>
                            ` : ''}
                            
                            ${data.stats.created > 0 ? `
                            <p style="margin: 6px 0 6px 20px; font-size: 13px;">
                                • 新增记录：${data.stats.created} 条
                            </p>
                            ` : ''}
                            
                            ${data.stats.updated > 0 ? `
                            <p style="margin: 6px 0 6px 20px; font-size: 13px;">
                                • 更新记录：${data.stats.updated} 条
                            </p>
                            ` : ''}
                            
                            ${data.stats.skipped > 0 ? `
                            <p style="margin: 6px 0; font-size: 13px; color: #faad14;">
                                <strong>⊘ 跳过重复：</strong>${data.stats.skipped} 条（已存在数据库）
                            </p>
                            ` : ''}
                            
                            ${data.stats.error_rows > 0 ? `
                            <p style="margin: 6px 0; font-size: 13px; color: var(--error-color);">
                                <strong>✗ 导入失败：</strong>${data.stats.error_rows} 条
                            </p>
                            ` : ''}
                        </div>
                        
                        <!-- 错误详情 -->
                        ${data.errors && data.errors.length > 0 ? `
                        <div style="background: #fff1f0; border: 1px solid #ffa39e; border-radius: 6px; padding: 16px; margin: 20px 0; text-align: left; max-height: 200px; overflow-y: auto;">
                            <p style="margin-bottom: 8px; color: var(--error-color); font-weight: 600;">❌ 错误详情：</p>
                            ${data.errors.map(err => `<p style="font-size: 13px; margin: 4px 0;">• ${err}</p>`).join('')}
                            ${data.has_more_errors ? '<p style="font-size: 12px; color: var(--text-secondary); margin-top: 8px;">... 还有更多错误，请检查导入文件</p>' : ''}
                        </div>
                        ` : ''}
                        ${!dryRun ? `
                            <button onclick="window.location.reload()" class="btn btn-primary" style="margin-top: 16px;">
                                <i class="fas fa-sync"></i>
                                刷新页面查看结果
                            </button>
                        ` : `
                            <button onclick="closeImportDialog(); showImportDialog();" class="btn btn-primary" style="margin-top: 16px;">
                                <i class="fas fa-upload"></i>
                                开始正式导入
                            </button>
                        `}
                    </div>
                `;
            } else {
                // 显示错误
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-circle" style="font-size: 64px; color: var(--error-color); margin-bottom: 20px;"></i>
                        <h3 style="font-size: 20px; margin-bottom: 16px; color: var(--error-color);">导入失败</h3>
                        <div style="background: #fff1f0; border: 1px solid #ffa39e; border-radius: 6px; padding: 16px; margin: 20px 0; text-align: left;">
                            <p style="color: var(--error-color);">${data.message || '未知错误'}</p>
                            ${data.errors ? `<pre style="margin-top: 12px; font-size: 12px; overflow-x: auto;">${data.errors}</pre>` : ''}
                        </div>
                        <button onclick="closeImportDialog(); showImportDialog();" class="btn btn-primary" style="margin-top: 16px;">
                            <i class="fas fa-redo"></i>
                            重新尝试
                        </button>
                    </div>
                `;
            }
        })
        .catch(error => {
            modalBody.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 64px; color: var(--error-color); margin-bottom: 20px;"></i>
                    <h3 style="font-size: 20px; margin-bottom: 16px; color: var(--error-color);">请求失败</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">${error.message}</p>
                    <div style="background: #fff1f0; border: 1px solid #ffa39e; border-radius: 6px; padding: 16px; margin: 20px 0; text-align: left;">
                        <p style="font-size: 13px; color: var(--text-secondary);">
                            提示：请确保后端服务器正在运行，并且导入接口 /api/import/ 已配置。
                        </p>
                    </div>
                    <button onclick="closeImportDialog(); showImportDialog();" class="btn btn-primary">
                        <i class="fas fa-redo"></i>
                        重新尝试
                    </button>
                </div>
            `;
        });
    }
</script>

<script src="{% static 'js/edit-modal.js' %}"></script>
{% endblock %}
