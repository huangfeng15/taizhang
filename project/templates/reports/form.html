{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/reports-enhanced.css' %}">
<style>
    .report-form-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .form-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 30px;
        margin-bottom: 20px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
    }
    
    .form-group select,
    .form-group input {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .form-group select:focus,
    .form-group input:focus {
        outline: none;
        border-color: #4CAF50;
        box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
    }
    
    .report-type-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }
    
    .report-type-card {
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .report-type-card:hover {
        border-color: #4CAF50;
        background-color: #f1f8f4;
    }
    
    .report-type-card.active {
        border-color: #4CAF50;
        background-color: #e8f5e9;
    }
    
    .report-type-card input[type="radio"] {
        display: none;
    }
    
    .report-type-card .icon {
        font-size: 32px;
        margin-bottom: 10px;
    }
    
    .report-type-card .label {
        font-weight: 600;
        color: #333;
    }
    
    .report-type-card .description {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
    }
    
    .dynamic-fields {
        display: none;
        animation: fadeIn 0.3s;
    }
    
    .dynamic-fields.active {
        display: block;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
    }
    
    .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 4px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-primary {
        background-color: #4CAF50;
        color: white;
    }
    
    .btn-primary:hover {
        background-color: #45a049;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-secondary {
        background-color: #2196F3;
        color: white;
    }
    
    .btn-secondary:hover {
        background-color: #0b7dda;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .info-box {
        background-color: #e3f2fd;
        border-left: 4px solid #2196F3;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
    }
    
    .info-box h4 {
        margin: 0 0 10px 0;
        color: #1976D2;
    }
    
    .info-box ul {
        margin: 0;
        padding-left: 20px;
    }
    
    .info-box li {
        margin-bottom: 5px;
        color: #555;
    }
    
    .report-form-header {
        margin-bottom: 20px;
    }

    .report-form-header h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 700;
        color: #2c3e50;
    }
</style>
{% endblock %}

{% block content %}
<div class="report-form-container">
    <div class="report-form-header">
        <h1>ğŸ“Š æŠ¥è¡¨ç”Ÿæˆ</h1>
    </div>
    
    <div class="info-box">
        <h4>ğŸ“‹ æŠ¥è¡¨è¯´æ˜</h4>
        <ul>
            <li><strong>å‘¨æŠ¥ï¼š</strong>ç»Ÿè®¡æŒ‡å®šå‘¨çš„ä¸šåŠ¡æ•°æ®</li>
            <li><strong>æœˆæŠ¥ï¼š</strong>ç»Ÿè®¡æŒ‡å®šæœˆä»½çš„ä¸šåŠ¡æ•°æ®</li>
            <li><strong>å­£æŠ¥ï¼š</strong>ç»Ÿè®¡æŒ‡å®šå­£åº¦çš„ä¸šåŠ¡æ•°æ®</li>
            <li><strong>å¹´æŠ¥ï¼š</strong>ç»Ÿè®¡å…¨å¹´ä¸šåŠ¡æ•°æ®åŠæœˆåº¦è¶‹åŠ¿</li>
        </ul>
    </div>
    
    <form method="post" id="reportForm">
        {% csrf_token %}

        <div class="form-card">
            <h3 style="margin-bottom: 20px;">1ï¸âƒ£ é€‰æ‹©æŠ¥è¡¨ç±»å‹</h3>
            
            <div class="report-type-cards">
                <label class="report-type-card active" for="weekly">
                    <input type="radio" name="report_type" id="weekly" value="weekly" checked>
                    <div class="icon">ğŸ“…</div>
                    <div class="label">å‘¨æŠ¥</div>
                    <div class="description">æœ¬å‘¨æ•°æ®ç»Ÿè®¡</div>
                </label>
                
                <label class="report-type-card" for="monthly">
                    <input type="radio" name="report_type" id="monthly" value="monthly">
                    <div class="icon">ğŸ“†</div>
                    <div class="label">æœˆæŠ¥</div>
                    <div class="description">æœ¬æœˆæ•°æ®ç»Ÿè®¡</div>
                </label>
                
                <label class="report-type-card" for="quarterly">
                    <input type="radio" name="report_type" id="quarterly" value="quarterly">
                    <div class="icon">ğŸ“Š</div>
                    <div class="label">å­£æŠ¥</div>
                    <div class="description">å­£åº¦æ•°æ®ç»Ÿè®¡</div>
                </label>
                
                <label class="report-type-card" for="annual">
                    <input type="radio" name="report_type" id="annual" value="annual">
                    <div class="icon">ğŸ“ˆ</div>
                    <div class="label">å¹´æŠ¥</div>
                    <div class="description">å¹´åº¦æ•°æ®æ€»ç»“</div>
                </label>
                
                <label class="report-type-card" for="project">
                    <input type="radio" name="report_type" id="project" value="project">
                    <div class="icon">ğŸ“‹</div>
                    <div class="label">é¡¹ç›®æŠ¥å‘Š</div>
                    <div class="description">é¡¹ç›®å…¨å‘¨æœŸæŠ¥å‘Š</div>
                </label>
            </div>
        </div>
        
        <div class="form-card">
            <h3 style="margin-bottom: 20px;">2ï¸âƒ£ è®¾ç½®æŠ¥è¡¨å‚æ•°</h3>
            
            <!-- å‘¨æŠ¥å‚æ•° -->
            <div id="weeklyFields" class="dynamic-fields active">
                <div class="form-group">
                    <label for="target_date">é€‰æ‹©æ—¥æœŸï¼ˆæ‰€åœ¨å‘¨ï¼‰ï¼š</label>
                    <input type="date" id="target_date" name="target_date" 
                           value="{{ request.GET.target_date|default:'' }}">
                    <small style="color: #666;">é€‰æ‹©ä»»æ„æ—¥æœŸï¼Œç³»ç»Ÿå°†ç”Ÿæˆè¯¥æ—¥æœŸæ‰€åœ¨å‘¨ï¼ˆå‘¨ä¸€è‡³å‘¨æ—¥ï¼‰çš„æŠ¥è¡¨</small>
                </div>
            </div>
            
            <!-- æœˆæŠ¥å‚æ•° -->
            <div id="monthlyFields" class="dynamic-fields">
                <div class="form-group">
                    <label for="year_monthly">å¹´ä»½ï¼š</label>
                    <select id="year_monthly" name="year">
                        {% for year in available_years %}
                        <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>
                            {{ year }}å¹´
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="month">æœˆä»½ï¼š</label>
                    <select id="month" name="month">
                        {% for month in available_months %}
                        <option value="{{ month }}" {% if month == current_month %}selected{% endif %}>
                            {{ month }}æœˆ
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <!-- å­£æŠ¥å‚æ•° -->
            <div id="quarterlyFields" class="dynamic-fields">
                <div class="form-group">
                    <label for="year_quarterly">å¹´ä»½ï¼š</label>
                    <select id="year_quarterly" name="year">
                        {% for year in available_years %}
                        <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>
                            {{ year }}å¹´
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="quarter">å­£åº¦ï¼š</label>
                    <select id="quarter" name="quarter">
                        {% for q in available_quarters %}
                        <option value="{{ q }}" {% if q == current_quarter %}selected{% endif %}>
                            ç¬¬{{ q }}å­£åº¦
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <!-- å¹´æŠ¥å‚æ•° -->
            <div id="annualFields" class="dynamic-fields">
                <div class="form-group">
                    <label for="year_annual">å¹´ä»½ï¼š</label>
                    <select id="year_annual" name="year">
                        {% for year in available_years %}
                        <option value="{{ year }}" {% if year == current_year %}selected{% endif %}>
                            {{ year }}å¹´
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            
            <!-- é¡¹ç›®æŠ¥å‘Šå‚æ•° -->
            <div id="projectFields" class="dynamic-fields">
                <div class="form-group">
                    <label for="project_code">é€‰æ‹©é¡¹ç›®ï¼š</label>
                    <select id="project_code" name="project_code">
                        <option value="">è¯·é€‰æ‹©é¡¹ç›®</option>
                        {% for project in selected_projects %}
                        <option value="{{ project.project_code }}">
                            {{ project.project_name }} ({{ project.project_code }})
                        </option>
                        {% endfor %}
                    </select>
                    <small style="color: #666;">ç”Ÿæˆè¯¥é¡¹ç›®çš„å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†æŠ¥å‘Š</small>
                </div>
            </div>
        </div>
        
        <div class="action-buttons">
            <button type="submit" name="export_format" value="preview" class="btn btn-primary">
                ğŸ‘ï¸ é¢„è§ˆæŠ¥è¡¨
            </button>
            <button type="submit" name="export_format" value="excel" class="btn btn-secondary">
                ğŸ“¥ å¯¼å‡ºExcel
            </button>
            <button type="submit" name="export_format" value="word" class="btn btn-secondary" style="background-color: #ff9800;">
                ğŸ“„ å¯¼å‡ºWord
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const reportTypeCards = document.querySelectorAll('.report-type-card');
    const reportTypeRadios = document.querySelectorAll('input[name="report_type"]');
    const dynamicFields = document.querySelectorAll('.dynamic-fields');
    const form = document.getElementById('reportForm');
    
    // åˆ‡æ¢æŠ¥è¡¨ç±»å‹
    function switchReportType(type) {
        // æ›´æ–°å¡ç‰‡æ ·å¼
        reportTypeCards.forEach(card => card.classList.remove('active'));
        document.querySelector(`label[for="${type}"]`).classList.add('active');
        
        // æ˜¾ç¤ºå¯¹åº”çš„å‚æ•°å­—æ®µ
        dynamicFields.forEach(field => field.classList.remove('active'));
        const targetFields = document.getElementById(`${type}Fields`);
        if (targetFields) {
            targetFields.classList.add('active');
        }
        
        // åŠ¨æ€æ§åˆ¶project_codeçš„requiredå±æ€§
        const projectCodeSelect = document.getElementById('project_code');
        if (projectCodeSelect) {
            if (type === 'project') {
                projectCodeSelect.setAttribute('required', 'required');
            } else {
                projectCodeSelect.removeAttribute('required');
            }
        }
    }
    
    // ç›‘å¬å•é€‰æŒ‰é’®å˜åŒ–
    reportTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            switchReportType(this.value);
        });
    });
    
    // ç›‘å¬å¡ç‰‡ç‚¹å‡»
    reportTypeCards.forEach(card => {
        card.addEventListener('click', function() {
            const radio = this.querySelector('input[type="radio"]');
            radio.checked = true;
            switchReportType(radio.value);
        });
    });
    
    // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
    const targetDateInput = document.getElementById('target_date');
    if (targetDateInput && !targetDateInput.value) {
        const today = new Date();
        const dateStr = today.toISOString().split('T')[0];
        targetDateInput.value = dateStr;
    }
    
    // å¤„ç†è¡¨å•æäº¤ - ä½¿ç”¨fetchä¸‹è½½æ–‡ä»¶
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const submitButton = e.submitter;
            if (!submitButton) return;
            
            const exportFormat = submitButton.value;
            
            // é¢„è§ˆæ¨¡å¼ç›´æ¥æäº¤è¡¨å•
            if (exportFormat === 'preview') {
                form.submit();
                return;
            }
            
            // Excelå’ŒWordå¯¼å‡ºä½¿ç”¨fetchå¤„ç†æ–‡ä»¶ä¸‹è½½
            const originalHTML = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ç”Ÿæˆä¸­...';
            
            const formData = new FormData(form);
            
            fetch(form.action, {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('ç”ŸæˆæŠ¥è¡¨å¤±è´¥');
                }
                
                // ä»å“åº”å¤´è·å–æ–‡ä»¶å
                const contentDisposition = response.headers.get('content-disposition');
                let filename = `æŠ¥è¡¨_${new Date().getTime()}.${exportFormat === 'excel' ? 'xlsx' : 'docx'}`;
                
                if (contentDisposition) {
                    const matches = contentDisposition.match(/filename\*=UTF-8''(.+)|filename="?([^"]+)"?/);
                    if (matches) {
                        filename = decodeURIComponent(matches[1] || matches[2]);
                    }
                }
                
                return response.blob().then(blob => ({blob, filename}));
            })
            .then(({blob, filename}) => {
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                
                // æ¸…ç†
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                // æ¢å¤æŒ‰é’®
                submitButton.disabled = false;
                submitButton.innerHTML = originalHTML;
                
                alert('æŠ¥è¡¨ç”ŸæˆæˆåŠŸ!');
            })
            .catch(error => {
                console.error('ä¸‹è½½å¤±è´¥:', error);
                alert('ç”ŸæˆæŠ¥è¡¨å¤±è´¥: ' + error.message);
                
                submitButton.disabled = false;
                submitButton.innerHTML = originalHTML;
            });
        });
    }
});
</script>
{% endblock %}
