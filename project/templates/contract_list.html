{# VSCode 语法检查提示：此文件包含 Django 模板语法，CSS/JS 检查器的错误可以忽略 #}
{% extends 'base.html' %}

{% block title %}合同管理 - 项目采购与成本管理系统{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="content-title">合同管理</h1>
    <div class="breadcrumb">
        <a href="{% url 'dashboard' %}">首页</a>
        <span>/</span>
        <span>合同管理</span>
    </div>
</div>

<!-- 搜索和过滤 -->
<div class="card">
    <form method="get" action="" class="filter-bar">
        <div class="search-box">
            <input type="text" name="q" placeholder="搜索合同编号、名称、乙方..." value="{{ search_query }}">
            <button type="submit">
                <i class="fas fa-search"></i>
            </button>
        </div>
        <select name="project" class="filter-select" onchange="this.form.submit()" style="max-width: 200px;">
            <option value="">所有项目</option>
            {% for project in projects %}
                <option value="{{ project.project_code }}" {% if project_filter == project.project_code %}selected{% endif %}>
                    {{ project.project_name }}
                </option>
            {% endfor %}
        </select>
        <select name="contract_type" class="filter-select" onchange="this.form.submit()" style="max-width: 150px;">
            <option value="">所有类型</option>
            {% for value, label in contract_types %}
                <option value="{{ value }}" {% if contract_type_filter == value %}selected{% endif %}>{{ label }}</option>
            {% endfor %}
        </select>
        <button type="button" onclick="showAdvancedFilter()" class="btn btn-secondary">
            <i class="fas fa-filter"></i>
            高级筛选
        </button>
        <button type="button" onclick="showColumnSelector()" class="btn btn-secondary">
            <i class="fas fa-columns"></i>
            选择字段
        </button>
        {% if search_query or project_filter or contract_type_filter %}
            <a href="?" class="filter-reset">
                <i class="fas fa-times"></i>
                清除筛选
            </a>
        {% endif %}
    </form>
</div>

<!-- 合同列表 -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">
            <i class="fas fa-file-contract"></i>
            全部合同
        </h2>
        <div style="display: flex; gap: 12px; align-items: center;">
            <button id="batchDeleteBtn" class="btn btn-secondary" style="background: #ff4d4f; color: white;" disabled onclick="batchDeleteContracts()">
                <i class="fas fa-trash"></i>
                批量删除 (<span id="selectedCount">0</span>)
            </button>
            <button onclick="showImportDialog()" class="btn btn-secondary">
                <i class="fas fa-file-import"></i>
                导入数据
            </button>
            <a href="/admin/contract/contract/add/" class="btn btn-primary">
                <i class="fas fa-plus"></i>
                新增合同
            </a>
        </div>
    </div>
    
    {% if contracts %}
    <div class="table-container">
        <table class="data-table" id="contractTable">
            <thead>
                <tr>
                    <th data-column="row_number">序号</th>
                    <th data-column="contract_sequence">合同序号</th>
                    <th data-column="contract_code">合同编号</th>
                    <th data-column="contract_name">合同名称</th>
                    <th data-column="project">所属项目</th>
                    <th data-column="contract_type">合同类型</th>
                    <th data-column="contract_source">合同来源</th>
                    <th data-column="party_a">甲方</th>
                    <th data-column="party_b">乙方</th>
                    <th data-column="party_b_contact">乙方负责人及联系方式</th>
                    <th data-column="party_b_contact_in_contract">合同文本内乙方联系人</th>
                    <th data-column="contract_amount">合同金额(元)</th>
                    <th data-column="total_paid_amount">累计付款金额(元)</th>
                    <th data-column="has_settlement">是否已结算</th>
                    <th data-column="settlement_amount">结算价(元)</th>
                    <th data-column="payment_ratio">累计付款比例(%)</th>
                    <th data-column="signing_date">签订日期</th>
                    <th data-column="duration">合同工期/服务期限</th>
                    <th data-column="payment_method">支付方式</th>
                    <th data-column="performance_guarantee_return_date">履约担保退回时间</th>
                    <th data-column="contract_officer">合同签订经办人</th>
                    <th data-column="operations">操作</th>
                </tr>
            </thead>
            <tbody>
                {% for contract_info in contracts %}
                {% with contract=contract_info.contract %}
                <tr data-id="{{ contract.contract_code }}">
                    <td data-column="row_number">{{ forloop.counter }}</td>
                    <td data-column="contract_sequence">{{ contract.contract_sequence|default:"-" }}</td>
                    <td data-column="contract_code">{{ contract.contract_code }}</td>
                    <td data-column="contract_name" style="max-width: 300px;">{{ contract.contract_name }}</td>
                    <td data-column="project">
                        {% if contract.project %}
                            <a href="{% url 'project_detail' contract.project.project_code %}" style="color: var(--primary-color); text-decoration: none;">
                                {{ contract.project.project_name }}
                            </a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td data-column="contract_type">
                        {% if contract.contract_type == '主合同' %}
                            <span class="badge badge-success">{{ contract.contract_type }}</span>
                        {% elif contract.contract_type == '补充协议' %}
                            <span class="badge badge-info">{{ contract.contract_type }}</span>
                        {% else %}
                            <span class="badge badge-error">{{ contract.contract_type }}</span>
                        {% endif %}
                    </td>
                    <td data-column="contract_source">
                        {% if contract.contract_source == '采购合同' %}
                            <span class="badge badge-success">{{ contract.contract_source }}</span>
                        {% else %}
                            <span class="badge badge-info">{{ contract.contract_source }}</span>
                        {% endif %}
                    </td>
                    <td data-column="party_a">{{ contract.party_a|default:"-" }}</td>
                    <td data-column="party_b">{{ contract.party_b|default:"-" }}</td>
                    <td data-column="party_b_contact">{{ contract.party_b_contact|default:"-" }}</td>
                    <td data-column="party_b_contact_in_contract">{{ contract.party_b_contact_in_contract|default:"-" }}</td>
                    <td data-column="contract_amount">
                        {% if contract.contract_amount %}
                            ¥{{ contract.contract_amount|floatformat:2 }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td data-column="total_paid_amount">
                        {% if contract_info.total_paid_amount > 0 %}
                            <span style="color: var(--success-color); font-weight: bold;">¥{{ contract_info.total_paid_amount|floatformat:2 }}</span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td data-column="has_settlement">
                        {% if contract_info.has_settlement %}
                            <span class="badge badge-success">已结算</span>
                        {% else %}
                            <span class="badge badge-secondary">未结算</span>
                        {% endif %}
                    </td>
                    <td data-column="settlement_amount">
                        {% if contract_info.settlement_amount %}
                            <span style="color: var(--primary-color); font-weight: bold;">¥{{ contract_info.settlement_amount|floatformat:2 }}</span>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td data-column="payment_ratio">
                        {% if contract_info.payment_ratio > 0 %}
                            {% if contract_info.payment_ratio >= 90 %}
                                {% with bar_color="#52c41a" text_color="var(--success-color)" %}
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="flex: 1; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden;">
                                            <div style="height: 100%; width: {{ contract_info.payment_ratio }}%; background: {{ bar_color }};"></div>
                                        </div>
                                        <span style="font-weight: bold; color: {{ text_color }};">{{ contract_info.payment_ratio|floatformat:1 }}%</span>
                                    </div>
                                {% endwith %}
                            {% elif contract_info.payment_ratio >= 70 %}
                                {% with bar_color="#faad14" text_color="var(--warning-color)" %}
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="flex: 1; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden;">
                                            <div style="height: 100%; width: {{ contract_info.payment_ratio }}%; background: {{ bar_color }};"></div>
                                        </div>
                                        <span style="font-weight: bold; color: {{ text_color }};">{{ contract_info.payment_ratio|floatformat:1 }}%</span>
                                    </div>
                                {% endwith %}
                            {% else %}
                                {% with bar_color="#1890ff" text_color="var(--primary-color)" %}
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <div style="flex: 1; height: 8px; background: #f0f0f0; border-radius: 4px; overflow: hidden;">
                                            <div style="height: 100%; width: {{ contract_info.payment_ratio }}%; background: {{ bar_color }};"></div>
                                        </div>
                                        <span style="font-weight: bold; color: {{ text_color }};">{{ contract_info.payment_ratio|floatformat:1 }}%</span>
                                    </div>
                                {% endwith %}
                            {% endif %}
                        {% else %}
                            0%
                        {% endif %}
                    </td>
                    <td data-column="signing_date">{{ contract.signing_date|default:"-" }}</td>
                    <td data-column="duration" style="max-width: 200px;">{{ contract.duration|default:"-" }}</td>
                    <td data-column="payment_method" style="max-width: 200px;">{{ contract.payment_method|default:"-" }}</td>
                    <td data-column="performance_guarantee_return_date">{{ contract.performance_guarantee_return_date|default:"-" }}</td>
                    <td data-column="contract_officer">{{ contract.contract_officer|default:"-" }}</td>
                    <td data-column="operations">
                        <a href="{% url 'contract_detail' contract.contract_code %}" class="btn btn-primary" style="padding: 4px 12px; font-size: 12px; margin-right: 4px;">
                            <i class="fas fa-eye"></i>
                            查看
                        </a>
                        <a href="/admin/contract/contract/{{ contract.contract_code }}/change/" class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;">
                            <i class="fas fa-edit"></i>
                            编辑
                        </a>
                    </td>
                </tr>
                {% endwith %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-file-contract"></i>
        <p>暂无合同数据</p>
        <a href="/admin/contract/contract/add/" class="btn btn-primary" style="margin-top: 16px;">
            <i class="fas fa-plus"></i>
            创建第一个合同
        </a>
    </div>
    {% endif %}
    
    <!-- 分页 -->
    {% include 'pagination.html' with module_type='contract' %}
</div>

{% endblock %}

{% block extra_js %}
<script>
    // 可用字段配置
    const availableColumns = [
        { key: 'row_number', label: '序号', required: true },
        { key: 'contract_sequence', label: '合同序号', required: false },
        { key: 'contract_code', label: '合同编号', required: false },
        { key: 'contract_name', label: '合同名称', required: true },
        { key: 'project', label: '所属项目', required: false },
        { key: 'contract_type', label: '合同类型', required: false },
        { key: 'contract_source', label: '合同来源', required: false },
        { key: 'party_a', label: '甲方', required: false },
        { key: 'party_b', label: '乙方', required: false },
        { key: 'party_b_contact', label: '乙方负责人及联系方式', required: false },
        { key: 'party_b_contact_in_contract', label: '合同文本内乙方联系人', required: false },
        { key: 'contract_amount', label: '合同金额', required: false },
        { key: 'total_paid_amount', label: '累计付款金额', required: false },
        { key: 'has_settlement', label: '是否已结算', required: false },
        { key: 'settlement_amount', label: '结算价', required: false },
        { key: 'payment_ratio', label: '累计付款比例', required: false },
        { key: 'signing_date', label: '签订日期', required: false },
        { key: 'duration', label: '合同工期/服务期限', required: false },
        { key: 'payment_method', label: '支付方式', required: false },
        { key: 'performance_guarantee_return_date', label: '履约担保退回时间', required: false },
        { key: 'contract_officer', label: '合同签订经办人', required: false },
        { key: 'operations', label: '操作', required: true }
    ];

    // 默认显示的字段（包含新增的付款相关字段）
    const defaultColumns = ['row_number', 'contract_sequence', 'contract_name', 'project', 'contract_type', 'contract_source', 'party_b', 'contract_amount', 'total_paid_amount', 'has_settlement', 'settlement_amount', 'payment_ratio', 'signing_date', 'operations'];

    // 高级筛选字段配置
    const filterFields = [
        { name: 'contract_code', label: '合同编号', type: 'text', placeholder: '输入合同编号' },
        { name: 'contract_sequence', label: '合同序号', type: 'text', placeholder: '输入合同序号' },
        { name: 'contract_name', label: '合同名称', type: 'text', placeholder: '输入合同名称' },
        { name: 'party_a', label: '甲方', type: 'text', placeholder: '输入甲方名称' },
        { name: 'party_b', label: '乙方', type: 'text', placeholder: '输入乙方名称' },
        { name: 'party_b_contact', label: '乙方负责人及联系方式', type: 'text', placeholder: '输入乙方负责人或联系方式' },
        { name: 'contract_officer', label: '合同签订经办人', type: 'text', placeholder: '输入经办人姓名' },
        { name: 'contract_type', label: '合同类型', type: 'select', options: [
            {% for value, label in contract_types %}
            { value: '{{ value }}', label: '{{ label }}' }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]},
        { name: 'contract_source', label: '合同来源', type: 'select', options: [
            { value: '采购合同', label: '采购合同' },
            { value: '直接签订', label: '直接签订' }
        ]},
        { name: 'has_settlement', label: '是否已结算', type: 'select', options: [
            { value: 'true', label: '已结算' },
            { value: 'false', label: '未结算' }
        ]},
        { name: 'payment_ratio_range', label: '付款比例', type: 'select', options: [
            { value: '0-50', label: '0%-50%' },
            { value: '50-80', label: '50%-80%' },
            { value: '80-100', label: '80%-100%' },
            { value: '100-', label: '100%以上' }
        ]},
        { name: 'signing_date', label: '签订日期', type: 'daterange' },
        { name: 'performance_guarantee_return_date', label: '履约担保退回时间', type: 'daterange' },
        { name: 'contract_amount', label: '合同金额', type: 'number' }
    ];

    // 初始化批量操作
    document.addEventListener('DOMContentLoaded', function() {
        {% if contracts %}
        BatchOperations.init('#contractTable', 'data-id');
        
        // 初始化字段选择器
        ColumnSelector.init(availableColumns, defaultColumns, 'contract_list_columns');
        ColumnSelector.loadColumnSettings();
        {% endif %}
    });
    
    // 显示高级筛选
    function showAdvancedFilter() {
        const currentFilters = {
            contract_code: '{{ request.GET.contract_code|default:"" }}',
            contract_sequence: '{{ request.GET.contract_sequence|default:"" }}',
            contract_name: '{{ request.GET.contract_name|default:"" }}',
            party_a: '{{ request.GET.party_a|default:"" }}',
            party_b: '{{ request.GET.party_b|default:"" }}',
            party_b_contact: '{{ request.GET.party_b_contact|default:"" }}',
            contract_officer: '{{ request.GET.contract_officer|default:"" }}',
            contract_type: '{{ request.GET.contract_type|default:"" }}',
            contract_source: '{{ request.GET.contract_source|default:"" }}',
            has_settlement: '{{ request.GET.has_settlement|default:"" }}',
            payment_ratio_range: '{{ request.GET.payment_ratio_range|default:"" }}',
            signing_date_start: '{{ request.GET.signing_date_start|default:"" }}',
            signing_date_end: '{{ request.GET.signing_date_end|default:"" }}',
            performance_guarantee_return_date_start: '{{ request.GET.performance_guarantee_return_date_start|default:"" }}',
            performance_guarantee_return_date_end: '{{ request.GET.performance_guarantee_return_date_end|default:"" }}',
            contract_amount_min: '{{ request.GET.contract_amount_min|default:"" }}',
            contract_amount_max: '{{ request.GET.contract_amount_max|default:"" }}'
        };
        AdvancedFilter.showAdvancedFilter(filterFields, currentFilters);
    }
    
    // 显示字段选择器
    function showColumnSelector() {
        ColumnSelector.showColumnSelector();
    }
    
    // 批量删除合同
    function batchDeleteContracts() {
        BatchOperations.batchDelete(
            '{% url "batch_delete_contracts" %}',
            `确定要删除选中的 ${BatchOperations.getSelectedIds().length} 个合同吗？\n此操作将同时删除相关的付款记录，且不可恢复！`
        );
    }
    
    // 显示导入对话框
    function showImportDialog() {
        const html = `
            <div id="importDialog" class="modal-overlay" onclick="closeImportDialog(event)">
                <div class="modal-content" onclick="event.stopPropagation()">
                    <div class="modal-header">
                        <h3 style="font-size: 20px; font-weight: 600;">
                            <i class="fas fa-file-import"></i>
                            导入合同数据
                        </h3>
                        <button onclick="closeImportDialog()" style="background: none; border: none; font-size: 24px; color: var(--text-secondary); cursor: pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">导入说明</label>
                            <div style="background: #f0f7ff; border: 1px solid #bae0ff; border-radius: 6px; padding: 16px; margin-bottom: 20px;">
                                <p style="margin-bottom: 8px; color: #0958d9;">
                                    <i class="fas fa-info-circle"></i>
                                    合同导入支持以下功能：
                                </p>
                                <ul style="margin-left: 20px; color: #595959;">
                                    <li>支持 CSV 和 Excel 文件格式</li>
                                    <li>自动检测文件编码（UTF-8/GBK）</li>
                                    <li>支持更新现有合同或创建新合同</li>
                                    <li>自动关联项目和采购信息</li>
                                    <li>详细的错误提示和导入报告</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">选择文件</label>
                            <input type="file" id="importFile" accept=".csv,.xlsx,.xls" class="form-input"
                                   style="padding: 8px;">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">导入模式</label>
                            <select id="conflictMode" class="form-input">
                                <option value="update">增量模式 - 更新已有记录，添加新记录（推荐）</option>
                                <option value="skip">仅新增模式 - 只添加新记录，跳过已存在的</option>
                                <option value="replace">替换模式 - 清空项目旧数据，导入新数据</option>
                            </select>
                            <p style="font-size: 12px; color: #8c8c8c; margin-top: 8px;">
                                <strong>增量模式</strong>：适合日常更新和补充数据<br>
                                <strong>替换模式</strong>：清空指定项目的所有合同数据后重新导入，谨慎使用！
                            </p>
                        </div>
                        
                        <div class="form-group" id="projectCodeGroup" style="display: none;">
                            <label class="form-label">
                                <i class="fas fa-exclamation-triangle" style="color: #ff4d4f;"></i>
                                项目编码（替换模式必填）
                            </label>
                            <input type="text" id="projectCode" class="form-input" placeholder="输入要替换数据的项目编码，如: BHHY">
                            <p style="font-size: 12px; color: #ff4d4f; margin-top: 4px;">
                                警告：该项目的所有合同及相关付款记录将被清空！
                            </p>
                        </div>
                        
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="dryRun" style="cursor: pointer;">
                                <span>仅验证数据，不实际导入（预演模式）</span>
                            </label>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-download"></i>
                                下载模板
                            </label>
                            <div style="display: flex; gap: 12px;">
                                <a href="/static/templates/contract_import_template.csv" download
                                   class="btn btn-secondary" style="text-decoration: none;">
                                    <i class="fas fa-file-csv"></i>
                                    CSV 模板
                                </a>
                                <a href="/docs/导入功能使用说明.md" target="_blank"
                                   class="btn btn-secondary" style="text-decoration: none;">
                                    <i class="fas fa-book"></i>
                                    查看文档
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" onclick="closeImportDialog()" class="btn btn-secondary">
                            取消
                        </button>
                        <button type="button" onclick="startImport()" class="btn btn-primary">
                            <i class="fas fa-upload"></i>
                            开始导入
                        </button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', html);
        
        // 添加模式切换事件监听器
        document.getElementById('conflictMode').addEventListener('change', function() {
            const projectCodeGroup = document.getElementById('projectCodeGroup');
            if (this.value === 'replace') {
                projectCodeGroup.style.display = 'block';
            } else {
                projectCodeGroup.style.display = 'none';
            }
        });
    }
    
    // 关闭导入对话框
    function closeImportDialog(event) {
        if (event && event.target.id !== 'importDialog') return;
        const modal = document.getElementById('importDialog');
        if (modal) modal.remove();
    }
    
    // 开始导入
    function startImport() {
        const fileInput = document.getElementById('importFile');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('请选择要导入的文件');
            return;
        }
        
        // 检查文件格式
        const fileName = file.name.toLowerCase();
        if (!fileName.endsWith('.csv') && !fileName.endsWith('.xlsx') && !fileName.endsWith('.xls')) {
            alert('仅支持 CSV 和 Excel 文件格式');
            return;
        }
        
        const conflictMode = document.getElementById('conflictMode').value;
        const dryRun = document.getElementById('dryRun').checked;
        
        // 替换模式需要项目编码
        if (conflictMode === 'replace') {
            const projectCode = document.getElementById('projectCode').value.trim();
            if (!projectCode) {
                alert('替换模式必须填写项目编码！');
                return;
            }
            
            // 二次确认
            const confirmMsg = dryRun
                ? `确认要验证项目【${projectCode}】的数据替换吗？\n\n这将模拟清空该项目的所有合同及相关付款数据。`
                : `⚠️ 警告：即将清空项目【${projectCode}】的所有合同及相关付款数据！\n\n此操作不可恢复，确定继续吗？`;
            
            if (!confirm(confirmMsg)) {
                return;
            }
        }
        
        // 创建FormData
        const formData = new FormData();
        formData.append('file', file);
        formData.append('module', 'contract');
        formData.append('conflict_mode', conflictMode);
        formData.append('dry_run', dryRun);
        if (conflictMode === 'replace') {
            formData.append('project_code', document.getElementById('projectCode').value.trim());
        }
        
        // 显示上传进度
        const modal = document.getElementById('importDialog');
        const modalBody = modal.querySelector('.modal-body');
        
        modalBody.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div class="spinner" style="margin: 0 auto 20px;"></div>
                <p style="font-size: 16px; color: var(--text-primary);">
                    ${dryRun ? '正在验证数据...' : '正在导入数据...'}
                </p>
                <p style="font-size: 14px; color: var(--text-secondary); margin-top: 8px;">
                    请稍候，这可能需要几分钟时间
                </p>
            </div>
        `;
        
        // 发送导入请求
        fetch('/api/import/', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 显示成功结果
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-check-circle" style="font-size: 64px; color: var(--success-color); margin-bottom: 20px;"></i>
                        <h3 style="font-size: 20px; margin-bottom: 16px;">
                            ${dryRun ? '验证成功！' : '导入完成！'}
                        </h3>
                        <div style="background: #f6ffed; border: 1px solid #b7eb8f; border-radius: 6px; padding: 16px; margin: 20px 0; text-align: left;">
                            <p style="margin-bottom: 8px;"><strong>导入统计：</strong></p>
                            <p>总行数: ${data.stats.total}</p>
                            <p style="color: var(--success-color);">成功: ${data.stats.success}</p>
                            ${data.stats.failed > 0 ? `<p style="color: var(--error-color);">失败: ${data.stats.failed}</p>` : ''}
                            ${data.stats.created > 0 ? `<p>新增: ${data.stats.created}</p>` : ''}
                            ${data.stats.updated > 0 ? `<p>更新: ${data.stats.updated}</p>` : ''}
                            ${data.stats.skipped > 0 ? `<p>跳过: ${data.stats.skipped}</p>` : ''}
                        </div>
                        ${data.errors && data.errors.length > 0 ? `
                            <div style="background: #fff1f0; border: 1px solid #ffa39e; border-radius: 6px; padding: 16px; margin: 20px 0; text-align: left; max-height: 200px; overflow-y: auto;">
                                <p style="margin-bottom: 8px; color: var(--error-color);"><strong>错误详情：</strong></p>
                                ${data.errors.map(err => `<p style="font-size: 13px;">• ${err}</p>`).join('')}
                            </div>
                        ` : ''}
                        ${!dryRun ? `
                            <button onclick="window.location.reload()" class="btn btn-primary" style="margin-top: 16px;">
                                <i class="fas fa-sync"></i>
                                刷新页面查看结果
                            </button>
                        ` : `
                            <button onclick="closeImportDialog(); showImportDialog();" class="btn btn-primary" style="margin-top: 16px;">
                                <i class="fas fa-upload"></i>
                                开始正式导入
                            </button>
                        `}
                    </div>
                `;
            } else {
                // 显示错误
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-exclamation-circle" style="font-size: 64px; color: var(--error-color); margin-bottom: 20px;"></i>
                        <h3 style="font-size: 20px; margin-bottom: 16px; color: var(--error-color);">导入失败</h3>
                        <div style="background: #fff1f0; border: 1px solid #ffa39e; border-radius: 6px; padding: 16px; margin: 20px 0; text-align: left;">
                            <p style="color: var(--error-color);">${data.message || '未知错误'}</p>
                            ${data.errors ? `<pre style="margin-top: 12px; font-size: 12px; overflow-x: auto;">${data.errors}</pre>` : ''}
                        </div>
                        <button onclick="closeImportDialog(); showImportDialog();" class="btn btn-primary" style="margin-top: 16px;">
                            <i class="fas fa-redo"></i>
                            重新尝试
                        </button>
                    </div>
                `;
            }
        })
        .catch(error => {
            modalBody.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 64px; color: var(--error-color); margin-bottom: 20px;"></i>
                    <h3 style="font-size: 20px; margin-bottom: 16px; color: var(--error-color);">请求失败</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">${error.message}</p>
                    <div style="background: #fff1f0; border: 1px solid #ffa39e; border-radius: 6px; padding: 16px; margin: 20px 0; text-align: left;">
                        <p style="font-size: 13px; color: var(--text-secondary);">
                            提示：请确保后端服务器正在运行，并且导入接口 /api/import/ 已配置。
                        </p>
                    </div>
                    <button onclick="closeImportDialog(); showImportDialog();" class="btn btn-primary">
                        <i class="fas fa-redo"></i>
                        重新尝试
                    </button>
                </div>
            `;
        });
    }
</script>
{% endblock %}