{% extends "base.html" %}

{% block title %}å¯¼å‡ºé¡¹ç›®æ•°æ® - é¡¹ç›®é‡‡è´­ä¸æˆæœ¬ç®¡ç†ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
    .export-container {
        max-width: 1200px;
        margin: 0 auto;
    }

    .selection-card {
        background: white;
        border-radius: 12px;
        padding: 28px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
    }

    .selection-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        padding-bottom: 20px;
        border-bottom: 2px solid #e8eaed;
    }

    .selection-title {
        font-size: 20px;
        font-weight: 600;
        color: #202124;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .selection-title i {
        color: #1a73e8;
        font-size: 22px;
    }

    .selection-actions {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .selection-actions .btn {
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .selection-actions .btn i {
        font-size: 14px;
    }

    .selection-actions .btn-secondary {
        background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%);
        color: white;
    }

    .selection-actions .btn-secondary:hover {
        background: linear-gradient(135deg, #096dd9 0%, #1890ff 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(24, 144, 255, 0.4);
    }

    .selection-actions .btn-secondary:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* ä¸ºå…¨é€‰æŒ‰é’®æ·»åŠ ç‰¹æ®Šæ ·å¼ - ä½¿ç”¨ä¸»è‰²è°ƒ */
    .selection-actions .btn-secondary:first-child {
        background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%);
    }

    .selection-actions .btn-secondary:first-child:hover {
        background: linear-gradient(135deg, #096dd9 0%, #1890ff 100%);
        box-shadow: 0 4px 12px rgba(24, 144, 255, 0.4);
    }

    /* ä¸ºå–æ¶ˆå…¨é€‰æŒ‰é’®æ·»åŠ ç‰¹æ®Šæ ·å¼ - ä½¿ç”¨ç°è‰²è°ƒ */
    .selection-actions .btn-secondary:last-child {
        background: linear-gradient(135deg, #8c8c8c 0%, #bfbfbf 100%);
    }

    .selection-actions .btn-secondary:last-child:hover {
        background: linear-gradient(135deg, #595959 0%, #8c8c8c 100%);
        box-shadow: 0 4px 12px rgba(140, 140, 140, 0.4);
    }

    /* ä¸šåŠ¡æ—¶é—´ç­›é€‰åŒºåŸŸç¾åŒ– */
    .business-date-filter {
        background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
        border: 2px solid #e3e8ff;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        position: relative;
        overflow: hidden;
    }

    .business-date-filter::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, #1a73e8 0%, #4285f4 100%);
    }

    .business-date-label {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 16px;
        font-weight: 600;
        color: #1a73e8;
        margin-bottom: 16px;
        cursor: default;
    }

    .business-date-label i {
        font-size: 18px;
        color: #1a73e8;
    }

    .business-date-inputs {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 12px;
        flex-wrap: wrap;
    }

    .business-date-inputs input[type="date"] {
        flex: 1;
        min-width: 180px;
        padding: 12px 16px;
        border: 2px solid #d1d9ff;
        border-radius: 8px;
        font-size: 14px;
        color: #202124;
        background: white;
        transition: all 0.3s ease;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    .business-date-inputs input[type="date"]:hover {
        border-color: #4285f4;
        box-shadow: 0 2px 8px rgba(66, 133, 244, 0.15);
    }

    .business-date-inputs input[type="date"]:focus {
        outline: none;
        border-color: #1a73e8;
        box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        background: #fafbff;
    }

    .business-date-inputs .separator {
        font-size: 14px;
        color: #5f6368;
        font-weight: 500;
        padding: 0 4px;
    }

    .business-date-help {
        font-size: 13px;
        color: #5f6368;
        line-height: 1.6;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        border-left: 3px solid #4285f4;
        margin-top: 12px;
    }

    .business-date-help::before {
        content: 'ğŸ’¡ ';
        margin-right: 4px;
    }

    .project-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 12px;
        max-height: 500px;
        overflow-y: auto;
        padding: 8px;
    }

    .project-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
    }

    .project-item:hover {
        border-color: #007bff;
        background: #f8f9fa;
    }

    .project-item input[type="checkbox"] {
        margin-right: 12px;
        cursor: pointer;
        width: 18px;
        height: 18px;
    }

    .project-info {
        flex: 1;
    }

    .project-name {
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .project-code {
        font-size: 13px;
        color: var(--text-secondary);
    }

    .export-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 24px;
        background: linear-gradient(to bottom, #fafbfc 0%, #f5f7fa 100%);
        border-top: 2px solid #e8eaed;
        border-radius: 0 0 12px 12px;
    }

    .selected-count {
        font-size: 15px;
        color: #5f6368;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .selected-count::before {
        content: 'âœ“';
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 24px;
        background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%);
        color: white;
        border-radius: 50%;
        font-size: 12px;
        font-weight: bold;
    }

    .selected-count strong {
        color: #1890ff;
        font-size: 18px;
        font-weight: 600;
    }

    .export-btn-group {
        display: flex;
        gap: 12px;
    }

    .export-btn-group .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        text-decoration: none;
    }

    .export-btn-group .btn i {
        font-size: 16px;
    }

    .export-btn-group .btn-secondary {
        background: linear-gradient(135deg, #8c8c8c 0%, #bfbfbf 100%);
        color: white;
    }

    .export-btn-group .btn-secondary:hover {
        background: linear-gradient(135deg, #595959 0%, #8c8c8c 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(140, 140, 140, 0.4);
    }

    .export-btn-group .btn-primary {
        background: linear-gradient(135deg, #1890ff 0%, #40a9ff 100%);
        color: white;
        position: relative;
        overflow: hidden;
    }

    .export-btn-group .btn-primary::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
    }

    .export-btn-group .btn-primary:hover::before {
        left: 100%;
    }

    .export-btn-group .btn-primary:hover {
        background: linear-gradient(135deg, #096dd9 0%, #1890ff 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(24, 144, 255, 0.5);
    }

    .export-btn-group .btn-primary:disabled {
        background: linear-gradient(135deg, #d9d9d9 0%, #f0f0f0 100%);
        color: #bfbfbf;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .export-btn-group .btn-primary:disabled:hover {
        transform: none;
        box-shadow: none;
    }

    .export-btn-group .btn:active {
        transform: translateY(0);
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
    }

    .empty-state i {
        font-size: 48px;
        color: #ddd;
        margin-bottom: 16px;
    }
</style>
{% endblock %}

{% block content %}
<div class="export-container">
    <div class="content-header">
        <h1 class="content-title">å¯¼å‡ºé¡¹ç›®æ•°æ®</h1>
        <div class="breadcrumb">
            <a href="{% url 'dashboard' %}">é¦–é¡µ</a>
            <span>/</span>
            <a href="{% url 'database_management' %}">æ•°æ®åº“ç®¡ç†</a>
            <span>/</span>
            <span>å¯¼å‡ºé¡¹ç›®æ•°æ®</span>
        </div>
    </div>

    <form id="exportForm" method="post" action="{% url 'export_project_data' %}{% if request.GET %}?{{ request.GET.urlencode }}{% endif %}">
        {% csrf_token %}
        
        <div class="selection-card">
            <div class="selection-header">
                <div class="selection-title">
                    <i class="fas fa-tasks"></i> é€‰æ‹©è¦å¯¼å‡ºçš„é¡¹ç›®
                </div>
            </div>

            <!-- ä¸šåŠ¡å‘ç”Ÿæ—¶é—´ç­›é€‰ï¼šé»˜è®¤ä½¿ç”¨å…¨å±€å¹´åº¦ï¼Œå¯è‡ªå®šä¹‰æ—¥æœŸèŒƒå›´ -->
            <div class="business-date-filter">
                <label class="business-date-label">
                    <i class="fas fa-calendar"></i>
                    ä¸šåŠ¡å‘ç”Ÿæ—¶é—´
                </label>
                <div class="business-date-inputs">
                    <input type="date" name="business_start_date" value="{{ business_start_date }}">
                    <span class="separator">è‡³</span>
                    <input type="date" name="business_end_date" value="{{ business_end_date }}">
                </div>
                <div class="business-date-help">
                    é»˜è®¤æ ¹æ®å…¨å±€ç­›é€‰å¹´åº¦å¡«å……ï¼ˆå¦‚ 2025-01-01 è‡³ 2025-12-31ï¼‰ï¼Œå¦‚éœ€è·¨å¹´åº¦æˆ–è‡ªå®šä¹‰æ—¶é—´æ®µï¼Œè¯·åœ¨æ­¤è°ƒæ•´ã€‚
                </div>
            </div>
                <div class="selection-actions">
                    <button type="button" class="btn btn-secondary btn-sm" onclick="selectAll()">
                        <i class="fas fa-check-square"></i> å…¨é€‰
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="selectNone()">
                        <i class="fas fa-square"></i> å–æ¶ˆå…¨é€‰
                    </button>
                </div>
            </div>

            {% if projects %}
            <div class="project-list">
                {% for project in projects %}
                <label class="project-item">
                    <input type="checkbox" name="project_codes" value="{{ project.project_code }}" class="project-checkbox">
                    <div class="project-info">
                        <div class="project-name">{{ project.project_name }}</div>
                        <div class="project-code">ç¼–ç : {{ project.project_code }}</div>
                    </div>
                </label>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-folder-open"></i>
                <p>æš‚æ— é¡¹ç›®æ•°æ®</p>
            </div>
            {% endif %}
        </div>

        <div class="export-actions">
            <div class="selected-count">
                å·²é€‰æ‹© <strong id="selectedCount">0</strong> ä¸ªé¡¹ç›®
            </div>
            <div class="export-btn-group">
                <a href="{% url 'database_management' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> è¿”å›
                </a>
                <button type="submit" class="btn btn-primary" id="exportBtn" disabled>
                    <i class="fas fa-file-export"></i> å¯¼å‡ºæ•°æ®
                </button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// æ›´æ–°é€‰ä¸­æ•°é‡
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.project-checkbox');
    const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
    document.getElementById('selectedCount').textContent = checkedCount;
    document.getElementById('exportBtn').disabled = checkedCount === 0;
}

// å…¨é€‰
function selectAll() {
    const checkboxes = document.querySelectorAll('.project-checkbox');
    checkboxes.forEach(cb => cb.checked = true);
    updateSelectedCount();
}

// å–æ¶ˆå…¨é€‰
function selectNone() {
    const checkboxes = document.querySelectorAll('.project-checkbox');
    checkboxes.forEach(cb => cb.checked = false);
    updateSelectedCount();
}

// ç›‘å¬å¤é€‰æ¡†å˜åŒ–
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.project-checkbox');
    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
    });
    
    // åˆå§‹åŒ–è®¡æ•°
    updateSelectedCount();
});

// è¡¨å•æäº¤æ—¶ä½¿ç”¨AJAXå¤„ç†ï¼Œé¿å…æŒ‰é’®çŠ¶æ€å¡ä½
document.getElementById('exportForm').addEventListener('submit', function(e) {
    e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡¨å•æäº¤
    
    const btn = document.getElementById('exportBtn');
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ­£åœ¨å¯¼å‡º...';
    
    // æ”¶é›†è¡¨å•æ•°æ®
    const formData = new FormData(this);
    
    // ä½¿ç”¨fetchä¸‹è½½æ–‡ä»¶
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || 'å¯¼å‡ºå¤±è´¥');
            });
        }
        // è·å–æ–‡ä»¶å
        const contentDisposition = response.headers.get('Content-Disposition');
        let filename = 'é¡¹ç›®æ•°æ®å¯¼å‡º.xlsx';
        if (contentDisposition) {
            const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(contentDisposition);
            if (matches != null && matches[1]) {
                filename = matches[1].replace(/['"]/g, '');
            }
        }
        return response.blob().then(blob => ({ blob, filename }));
    })
    .then(({ blob, filename }) => {
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        alert('å¯¼å‡ºæˆåŠŸï¼');
    })
    .catch(error => {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        
        // æ˜¾ç¤ºé”™è¯¯
        alert('å¯¼å‡ºå¤±è´¥ï¼š' + error.message);
    });
});
</script>
{% endblock %}