# 供应商管理模块 - 零停机部署方案

**文档版本**: v1.0  
**创建日期**: 2025-01-07  
**项目名称**: 项目采购与成本管理系统 - 供应商管理模块  
**部署策略**: 零停机、渐进式上线

---

## 目录

1. [部署策略概述](#1-部署策略概述)
2. [环境隔离方案](#2-环境隔离方案)
3. [数据库迁移策略](#3-数据库迁移策略)
4. [代码部署流程](#4-代码部署流程)
5. [功能灰度发布](#5-功能灰度发布)
6. [回滚预案](#6-回滚预案)
7. [监控与验证](#7-监控与验证)

---

## 1. 部署策略概述

### 1.1 核心原则

- **零停机**: 生产环境不中断服务
- **渐进式**: 分阶段发布，降低风险
- **可回滚**: 任何阶段都可快速回退
- **独立性**: 新模块不影响现有功能

### 1.2 部署架构

```
生产环境 (线上用户访问)
    ├── 现有功能 (project, procurement, contract, payment, settlement)
    └── 新模块 (supplier_eval) - 独立部署
```

### 1.3 时间规划

| 阶段 | 工作内容 | 预计时间 | 影响范围 |
|------|---------|---------|---------|
| 准备阶段 | 环境配置、代码合并 | 1小时 | 无 |
| 数据库迁移 | 执行migration | 5分钟 | 无影响 |
| 代码部署 | 更新代码、重启服务 | 10分钟 | 无影响 |
| 灰度测试 | 内部验证 | 2小时 | 无 |
| 全量发布 | 开放给全部用户 | 即时 | 无 |

---

## 2. 环境隔离方案

### 2.1 开发测试环境

**目的**: 完全独立的开发测试环境，不影响生产

```bash
# 1. 创建测试分支
cd f:/kaifa/taizhang
git checkout -b feature/supplier-eval-dev

# 2. 使用独立的数据库文件进行开发
# 修改 config/settings.py (仅在开发分支)
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db_dev.sqlite3',  # 开发专用数据库
    }
}

# 3. 开发环境启动
python manage.py runserver 0.0.0.0:8001  # 使用不同端口
```

### 2.2 生产环境隔离

- 生产环境继续使用 `db.sqlite3`
- 开发环境使用 `db_dev.sqlite3`
- 两者完全隔离，互不影响

---

## 3. 数据库迁移策略

### 3.1 向后兼容的迁移设计

**关键原则**: 新增字段必须可选 (nullable)

```python
# supplier_eval/migrations/0001_initial.py

class Migration(migrations.Migration):
    dependencies = [
        ('contract', '0010_last_migration'),  # 依赖现有模块
    ]

    operations = [
        migrations.CreateModel(
            name='SupplierEvaluation',
            fields=[
                ('evaluation_code', models.CharField(max_length=50, primary_key=True)),
                ('contract', models.ForeignKey(...)),
                ('supplier_name', models.CharField(max_length=200, db_index=True)),
                
                # 关键：所有新字段都设置为 nullable
                ('comprehensive_score', models.DecimalField(
                    max_digits=5, decimal_places=2, 
                    null=True, blank=True  # 可选字段
                )),
                ('last_evaluation_score', models.DecimalField(
                    max_digits=5, decimal_places=2, 
                    null=True, blank=True  # 可选字段
                )),
                # ... 其他字段同样设置为 nullable
            ],
        ),
        
        # 创建索引 - 不影响现有查询
        migrations.AddIndex(
            model_name='supplierevaluation',
            index=models.Index(fields=['supplier_name'], name='supplier_name_idx'),
        ),
    ]
```

**优势**:
- ✅ 迁移执行快速 (仅创建新表和索引)
- ✅ 不修改现有表结构
- ✅ 不会锁定现有表
- ✅ 现有功能完全不受影响

### 3.2 迁移执行计划

```bash
# 步骤1: 在开发环境测试迁移
cd f:/kaifa/taizhang
git checkout feature/supplier-eval-dev
python manage.py makemigrations supplier_eval
python manage.py migrate supplier_eval

# 步骤2: 验证迁移正确性
python manage.py sqlmigrate supplier_eval 0001  # 查看SQL
sqlite3 db_dev.sqlite3 ".schema supplier_eval_supplierevaluation"  # 验证表结构

# 步骤3: 生产环境执行迁移（零停机）
git checkout main
git merge feature/supplier-eval-dev
python manage.py migrate supplier_eval  # 执行时间 < 5秒
```

---

## 4. 代码部署流程

### 4.1 部署前准备清单

- [ ] 代码已在开发环境充分测试
- [ ] 数据库迁移已验证
- [ ] 备份当前生产数据库
- [ ] 准备回滚脚本
- [ ] 通知相关人员部署时间窗口

### 4.2 零停机部署步骤

```bash
# ===== 步骤1: 备份生产数据库 =====
cd f:/kaifa/taizhang/backups
python ../manage.py dumpdata > backup_before_supplier_eval_$(date +%Y%m%d_%H%M%S).json
cp ../db.sqlite3 db_backup_$(date +%Y%m%d_%H%M%S).sqlite3

# ===== 步骤2: 代码合并 (本地操作) =====
cd f:/kaifa/taizhang
git checkout main
git pull origin main
git merge feature/supplier-eval-dev
# 解决冲突（如果有）

# ===== 步骤3: 执行数据库迁移 (生产环境) =====
python manage.py migrate supplier_eval
# 预计执行时间: 3-5秒
# 影响: 无，仅创建新表

# ===== 步骤4: 收集静态文件 =====
python manage.py collectstatic --noinput

# ===== 步骤5: 重启Django服务 (使用滚动重启) =====
# 方法A: 使用start_server.bat重启（推荐）
taskkill /F /IM python.exe /FI "WINDOWTITLE eq Django*"
start_server.bat

# 方法B: 如果使用supervisor/systemd
# supervisorctl restart django_app
# systemctl restart django.service

# ===== 步骤6: 验证服务启动 =====
curl http://10.168.3.240:3500/  # 确认主页可访问
curl http://10.168.3.240:3500/admin/  # 确认后台可访问
```

**重启时间**: 5-10秒  
**用户影响**: 极小（仅短暂的连接等待）

### 4.3 配置更新 (config/settings.py)

确保 `supplier_eval` 已加入 `INSTALLED_APPS`:

```python
INSTALLED_APPS = [
    # ... 现有应用
    'supplier_eval.apps.SupplierEvalConfig',  # 新增
]
```

---

## 5. 功能灰度发布

### 5.1 基于权限的灰度策略

**第一阶段：内部测试（1-2天）**

```python
# 方法1: 基于用户组的访问控制
# supplier_eval/views.py

from django.contrib.auth.decorators import login_required, user_passes_test

def is_beta_tester(user):
    """仅允许管理员和测试组用户访问"""
    return user.is_superuser or user.groups.filter(name='供应商模块测试组').exists()

@login_required
@user_passes_test(is_beta_tester)
def supplier_evaluation_list(request):
    # 视图逻辑
    pass
```

**创建测试用户组**:

```bash
python manage.py shell
>>> from django.contrib.auth.models import Group
>>> test_group = Group.objects.create(name='供应商模块测试组')
>>> test_group.save()

# 添加测试用户到组
>>> from django.contrib.auth.models import User
>>> user = User.objects.get(username='test_user')
>>> user.groups.add(test_group)
```

**第二阶段：全量发布**

移除权限限制装饰器，开放给所有用户:

```python
@login_required
def supplier_evaluation_list(request):
    # 视图逻辑
    pass
```

### 5.2 基于配置的功能开关

**更灵活的方案：使用环境变量控制**

```python
# config/settings.py
SUPPLIER_EVAL_ENABLED = os.environ.get('SUPPLIER_EVAL_ENABLED', 'false').lower() == 'true'

# supplier_eval/views.py
from django.conf import settings
from django.http import HttpResponseForbidden

def supplier_evaluation_list(request):
    if not settings.SUPPLIER_EVAL_ENABLED:
        return HttpResponseForbidden("此功能尚未启用")
    # 视图逻辑
```

**启用功能**:

```bash
# .env 文件中添加
SUPPLIER_EVAL_ENABLED=true

# 重启服务即生效（无需修改代码）
```

### 5.3 导航菜单动态显示

```html
<!-- project/templates/base.html -->
{% if user.is_authenticated and SUPPLIER_EVAL_ENABLED %}
<li class="nav-item">
    <a class="nav-link" href="{% url 'supplier_evaluation_list' %}">
        供应商管理
    </a>
</li>
{% endif %}
```

---

## 6. 回滚预案

### 6.1 快速回滚步骤

**场景1: 发现严重Bug，需要立即回滚代码**

```bash
# 方法A: Git回滚
cd f:/kaifa/taizhang
git log --oneline  # 查看提交历史
git revert <commit_hash>  # 回退到部署前的提交
python manage.py collectstatic --noinput
taskkill /F /IM python.exe /FI "WINDOWTITLE eq Django*"
start_server.bat

# 方法B: 从备份分支恢复
git checkout main
git reset --hard origin/main  # 强制恢复到远程main分支状态
```

**场景2: 数据库迁移问题**

```bash
# 方法A: 回退迁移
python manage.py migrate supplier_eval zero  # 撤销supplier_eval的所有迁移

# 方法B: 恢复数据库备份
cd f:/kaifa/taizhang
rm db.sqlite3
cp backups/db_backup_YYYYMMDD_HHMMSS.sqlite3 db.sqlite3
```

### 6.2 回滚影响分析

| 回滚操作 | 现有功能影响 | 数据丢失风险 | 恢复时间 |
|---------|-------------|-------------|---------|
| 代码回滚 | 无 | 无 | 5分钟 |
| 迁移回退 | 无 | supplier_eval模块数据丢失 | 1分钟 |
| 数据库恢复 | 无 | 备份后的新增数据丢失 | 3分钟 |

---

## 7. 监控与验证

### 7.1 部署后验证清单

**立即验证（部署后5分钟内）**:

- [ ] 服务启动成功 (`http://10.168.3.240:3500/`)
- [ ] 现有功能正常（采购管理、合同管理、支付管理、结算管理）
- [ ] Admin后台可访问 (`http://10.168.3.240:3500/admin/`)
- [ ] 数据库表已创建 (`sqlite3 db.sqlite3 ".tables" | grep supplier_eval`)
- [ ] 静态文件正常加载（无404错误）

**功能验证（内部测试阶段）**:

- [ ] 供应商履约评价列表可访问
- [ ] CSV导入功能正常
- [ ] 承接项目查询正常
- [ ] 约谈记录CRUD功能正常
- [ ] 筛选和搜索功能正常
- [ ] 数据统计准确

**性能监控**:

```bash
# 监控数据库查询性能
python manage.py shell
>>> from django.db import connection
>>> from django.test.utils import override_settings
>>> with override_settings(DEBUG=True):
>>>     # 执行视图查询
>>>     print(len(connection.queries))  # 查询数量
>>>     for q in connection.queries:
>>>         print(f"{q['time']}s: {q['sql']}")
```

### 7.2 日志监控

```python
# config/settings.py 添加日志配置
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'handlers': {
        'file': {
            'level': 'INFO',
            'class': 'logging.FileHandler',
            'filename': BASE_DIR / 'logs' / 'supplier_eval.log',
        },
    },
    'loggers': {
        'supplier_eval': {
            'handlers': ['file'],
            'level': 'INFO',
            'propagate': True,
        },
    },
}
```

**监控日志文件**:

```bash
# 实时监控日志
tail -f f:/kaifa/taizhang/logs/supplier_eval.log

# 检查错误
grep -i error f:/kaifa/taizhang/logs/supplier_eval.log
```

---

## 8. 生产环境部署完整流程

### 8.1 部署时间窗口建议

- **推荐时间**: 工作日下午5:00-6:00（使用低峰期）
- **备选时间**: 周末上午10:00-11:00
- **避免时间**: 月末、季度末、年末（业务高峰期）

### 8.2 完整执行脚本

```bash
#!/bin/bash
# 生产环境部署脚本: deploy_supplier_eval.sh

echo "===== 供应商管理模块部署开始 ====="
echo "时间: $(date)"

# 1. 备份
echo "步骤1: 备份数据库..."
cd f:/kaifa/taizhang
python manage.py dumpdata > backups/backup_$(date +%Y%m%d_%H%M%S).json
cp db.sqlite3 backups/db_backup_$(date +%Y%m%d_%H%M%S).sqlite3

# 2. 合并代码
echo "步骤2: 合并代码..."
git checkout main
git pull origin main
git merge feature/supplier-eval-dev

# 3. 数据库迁移
echo "步骤3: 执行数据库迁移..."
python manage.py migrate supplier_eval

# 4. 收集静态文件
echo "步骤4: 收集静态文件..."
python manage.py collectstatic --noinput

# 5. 重启服务
echo "步骤5: 重启Django服务..."
taskkill /F /IM python.exe /FI "WINDOWTITLE eq Django*"
start start_server.bat

# 6. 验证
echo "步骤6: 验证服务..."
sleep 10
curl -f http://10.168.3.240:3500/ || echo "警告: 主页访问失败"
curl -f http://10.168.3.240:3500/admin/ || echo "警告: 后台访问失败"

echo "===== 部署完成 ====="
echo "时间: $(date)"
```

### 8.3 应急联系

- **技术负责人**: [姓名] [电话]
- **DBA**: [姓名] [电话]
- **运维负责人**: [姓名] [电话]

---

## 9. 总结

### 9.1 部署优势

✅ **零停机**: 整个部署过程用户无感知  
✅ **低风险**: 新模块完全独立，不影响现有功能  
✅ **可回滚**: 任何阶段都可快速回退  
✅ **可控性**: 灰度发布，逐步验证  
✅ **可追溯**: 完整的备份和日志记录

### 9.2 关键成功因素

1. **数据库迁移设计**: nullable字段，不锁表
2. **代码隔离性**: 新模块不依赖现有模块的修改
3. **充分测试**: 开发环境完整验证
4. **备份策略**: 部署前必须备份
5. **权限控制**: 灰度发布降低风险

### 9.3 后续优化建议

- 考虑引入 CI/CD 流程（自动化测试和部署）
- 使用 Docker 容器化部署（更彻底的环境隔离）
- 引入蓝绿部署或金丝雀发布（更高级的发布策略）
- 使用负载均衡器实现真正的零停机滚动更新

---

**文档状态**: ✅ 已完成  
**最后更新**: 2025-01-07  
**版本**: v1.0