# 归档监控页面改造说明

## 改造概述

归档监控页面已成功改造，新增了项目视图和个人视图功能，支持展示平均归档周期、归档周期趋势图，并移除了页面级筛选表单，简化了用户交互。

## 核心功能

### 1. 视图模式切换

**位置**：页面顶部卡片

**功能**：
- **项目视图**：按项目维度展示归档统计
- **个人视图**：按经办人维度展示归档统计

**使用方式**：
- 点击"项目视图"或"个人视图"按钮切换模式
- 切换时会清空当前选择的目标，保留全局筛选状态

### 2. 目标选择器

**项目视图**：
- 显示项目下拉选择器
- 支持智能搜索（如果SmartSelector已加载）
- 选择项目后自动刷新页面展示该项目的统计数据

**个人视图**：
- 显示经办人下拉选择器
- 列表按业务量排序（业务量多的排在前面）
- 选择经办人后自动刷新页面展示该经办人的统计数据

### 3. 归档统计卡片

**显示条件**：选择了项目或经办人后显示

**包含内容**：
1. **采购平均归档周期**
   - 平均周期天数
   - 规定周期：40天
   - 及时归档率
   - 样本数量

2. **合同平均归档周期**
   - 平均周期天数
   - 规定周期：30天
   - 及时归档率
   - 样本数量

3. **综合归档及时率**
   - 采购和合同的平均及时率

### 4. 归档周期趋势图

**显示条件**：选择了项目或经办人后显示

**图表类型**：Chart.js 折线图

**数据维度**：
- **全年度筛选**（year=all）：按半年统计（2024-H1, 2024-H2）
- **单年度筛选**（year=2024）：按月统计（1月-12月）

**图表内容**：
- 蓝色折线：采购归档周期
- 绿色折线：合同归档周期
- 蓝色虚线：采购规定周期（40天）
- 绿色虚线：合同规定周期（30天）

**特性**：
- 自动跳过无数据的时间点（spanGaps: true）
- 鼠标悬停显示详细数据
- 响应式设计，自适应容器大小

### 5. 全局筛选联动

**全局筛选参数**：
- 年份筛选（global_year）
- 项目筛选（global_project）

**联动效果**：
- 所有统计数据受全局筛选影响
- 项目视图下，全局项目筛选会被目标项目覆盖
- 个人视图下，全局项目筛选仍然生效

### 6. 超期列表

**保留功能**：
- 按严重程度分组展示（严重/中度/轻微/待归档）
- 自动筛选当前项目或经办人的数据
- 支持"显示所有记录"复选框

## 技术架构

### 服务层

**新增文件**：`project/services/monitors/archive_statistics.py`

**核心类**：`ArchiveStatisticsService`

**主要方法**：
```python
# 获取项目统计
get_project_statistics(project_code, year_filter, global_project)

# 获取个人统计
get_person_statistics(person_name, year_filter, global_project)

# 获取经办人列表
get_person_list(year_filter, global_project)
```

**设计原则**：
- **SRP**：专注于归档统计计算
- **DRY**：统一的计算逻辑，避免重复
- **OCP**：通过配置文件扩展周期标准

### 视图层

**修改文件**：`project/views.py` 中的 `archive_monitor()` 函数

**新增参数**：
- `view_mode`：视图模式（project/person）
- `target_code`：目标编码（项目编码或经办人姓名）

**数据流**：
```
全局筛选（年份+项目）
  → 视图模式选择（项目/个人）
    → 目标选择（具体项目/具体经办人）
      → 统计数据计算 + 超期列表查询
        → 模板渲染
```

### 模板层

**修改文件**：`project/templates/monitoring/archive_problems.html`

**新增组件**：
1. 视图模式切换器（单选按钮组）
2. 目标选择器（项目/经办人下拉框）
3. 归档统计卡片（3个卡片）
4. 归档周期趋势图（Canvas容器）

**移除组件**：
- 页面级筛选表单（项目输入框、模块下拉、经办人输入框）

### 前端层

**新增文件**：`project/static/js/archive-statistics.js`

**核心类**：`ArchiveStatistics`

**主要功能**：
- 视图模式切换逻辑
- 目标选择器联动
- Chart.js 趋势图渲染
- 全局筛选联动处理

## 数据计算逻辑

### 平均归档周期

**采购归档周期** = 归档日期 - 公示日期（已归档的记录）
**合同归档周期** = 归档日期 - 签订日期（已归档的记录）

**平均值** = sum(归档周期) / count(已归档记录)

### 及时归档率

**采购及时归档率** = (归档周期 ≤ 40天的记录数) / 总记录数 × 100%
**合同及时归档率** = (归档周期 ≤ 30天的记录数) / 总记录数 × 100%

### 趋势图数据

**分组依据**：业务日期（公示日期/签订日期）

**全年度模式**（year_filter='all'）：
- 按半年分组：2023-H1, 2023-H2, 2024-H1, 2024-H2...
- 每个半年计算平均归档周期

**单年度模式**（year_filter='2024'）：
- 按月分组：1月, 2月, 3月...12月
- 每个月计算平均归档周期

## 使用指南

### 查看项目归档统计

1. 访问归档监控页面：`/monitoring/archive/`
2. 确保"项目视图"按钮处于激活状态
3. 从项目下拉框中选择目标项目
4. 页面自动刷新，展示该项目的：
   - 采购和合同平均归档周期
   - 归档周期趋势图
   - 超出规定周期的项目列表

### 查看个人归档统计

1. 访问归档监控页面：`/monitoring/archive/`
2. 点击"个人视图"按钮切换模式
3. 从经办人下拉框中选择目标经办人
4. 页面自动刷新，展示该经办人的：
   - 采购和合同平均归档周期
   - 归档周期趋势图
   - 超出规定周期的项目列表

### 使用全局筛选

1. 使用页面顶部的全局筛选组件
2. 选择年份（全部年度或具体年份）
3. 选择项目（可选）
4. 所有统计数据自动更新

### 查看趋势图

- **全年度趋势**：全局筛选选择"全部年度"，趋势图按半年展示
- **单年度趋势**：全局筛选选择具体年份，趋势图按月展示
- 鼠标悬停在折线上可查看详细数据
- 虚线表示规定周期标准

## 测试验证

### 运行测试脚本

```bash
python test_archive_statistics.py
```

**测试内容**：
1. 获取项目列表
2. 获取项目统计数据
3. 获取经办人列表
4. 获取个人统计数据
5. 数据库统计验证

### 系统检查

```bash
python manage.py check
```

### 启动开发服务器

```bash
python manage.py runserver 0.0.0.0:3500
```

访问：`http://localhost:3500/monitoring/archive/`

## 注意事项

1. **数据要求**：
   - 采购需要有 `result_publicity_release_date` 和 `archive_date`
   - 合同需要有 `signing_date` 和 `archive_date`
   - 仅统计主合同（`file_positioning='main_contract'`）

2. **性能优化**：
   - 使用 `select_related()` 优化关联查询
   - 使用 `annotate()` 在数据库层计算周期
   - 趋势图数据在后端预计算

3. **浏览器兼容性**：
   - 需要支持 ES6 语法
   - 需要支持 Chart.js 4.x
   - 建议使用现代浏览器（Chrome、Firefox、Edge）

4. **数据准确性**：
   - 趋势图按业务日期分组，反映业务发生时间的归档周期
   - 平均周期仅计算已归档的记录
   - 及时率基于规定周期标准（采购40天、合同30天）

## 后续优化建议

1. **缓存优化**：
   - 对趋势图数据进行缓存（Redis）
   - 设置合理的缓存过期时间

2. **导出功能**：
   - 支持导出统计数据为Excel
   - 支持导出趋势图为图片

3. **对比分析**：
   - 支持多个项目对比
   - 支持多个经办人对比

4. **预警功能**：
   - 归档周期超标预警
   - 及时率低于阈值预警

## 相关文件

- 服务层：`project/services/monitors/archive_statistics.py`
- 视图层：`project/views.py` (archive_monitor函数)
- 模板层：`project/templates/monitoring/archive_problems.html`
- 前端层：`project/static/js/archive-statistics.js`
- 测试脚本：`test_archive_statistics.py`
- 配置文件：`project/services/monitors/config.py`

## 更新日期

2025-11-10
