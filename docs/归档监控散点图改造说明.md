# 归档监控散点图改造说明

## 改造目标

将归档监控页面的趋势图从**月度/半年平均值折线图**改造为**按归档完成时间的散点图**，真实反映每个业务的归档周期情况，避免平均值掩盖问题。

## 改造前后对比

### 改造前
- **数据聚合方式**：按月/半年聚合，计算平均值
- **图表类型**：折线图
- **问题**：
  - 看不到具体哪些业务超期
  - 平均值会掩盖异常值
  - 无法追踪到具体业务

### 改造后
- **数据展示方式**：每个业务一个散点，按归档完成时间精确定位
- **图表类型**：散点图 + 基准线 + 区域标注
- **优势**：
  - 每个点代表一个具体业务
  - 可以看到所有业务的分布情况
  - 异常值（如超期60天的归档）一目了然
  - 鼠标悬停显示业务详情（编号、名称、经办人）
  - 区域标注清晰区分正常/超期

## 技术实现

### 1. 后端数据生成

**文件**：`project/services/monitors/archive_statistics.py`

#### 修改的核心方法

**_calculate_trend()** - 从月度/半年聚合改为散点数据返回

**改造前返回格式**：
```python
[
    {'period': '2024-H1', 'avg_cycle': 25.5, 'count': 10},
    {'period': '2024-H2', 'avg_cycle': 30.2, 'count': 15}
]
```

**改造后返回格式**：
```python
[
    {
        'date': '2025-05-15',
        'cycle_days': 35,
        'code': 'CG-2025-001',
        'name': '项目名称',
        'person': '张三',
        'project_code': 'PRJ-001'
    },
    ...
]
```

**get_persons_multi_trend()** - 多人趋势
**get_projects_multi_trend()** - 多项目趋势
**get_project_officers_multi_trend()** - 项目内多经办人趋势

改造后统一返回格式：
```python
{
    'procurement': [
        {'name': '张三', 'points': [{date, cycle_days, ...}, ...]},
        {'name': '李四', 'points': [{date, cycle_days, ...}, ...]}
    ],
    'contract': [
        {'name': '张三', 'points': [{date, cycle_days, ...}, ...]},
        {'name': '李四', 'points': [{date, cycle_days, ...}, ...]}
    ]
}
```

### 2. 前端图表渲染

**文件**：`project/templates/monitoring/archive.html`

#### 详情模态框趋势图

**函数**：`renderDetailTrend()`

**实现步骤**：
1. 将散点数据转换为 ApexCharts 格式
2. 添加基准线（采购40天/合同30天规定周期）
3. 添加区域标注（正常区域/超期区域）
4. 配置 tooltip 显示业务详情

**关键代码**：
```javascript
// 准备散点数据
const procScatter = trendData.procurement.map(p => ({
    x: new Date(p.date).getTime(),
    y: p.cycle_days,
    code: p.code,
    name: p.name,
    person: p.person
}));

// 添加散点系列
chartSeries.push({
    name: '采购归档周期',
    type: 'scatter',
    data: procScatter,
    color: '#0d6efd'
});

// 添加基准线
chartSeries.push({
    name: '采购规定周期（40天）',
    type: 'line',
    data: [{ x: xMin, y: 40 }, { x: xMax, y: 40 }],
    color: '#0d6efd'
});
```

#### 多序列趋势图

**函数**：`renderMultiSeriesChart()`

**实现步骤**：
1. 遍历每个人/项目的散点数据
2. 为每个人/项目生成散点系列
3. 使用不同颜色区分
4. 添加统一的基准线
5. 添加区域标注

## 图表元素说明

### 散点
- **蓝色点**：采购业务
- **绿色点**：合同业务
- **点的Y轴位置**：实际归档周期天数
- **点的X轴位置**：业务归档完成日期

### 基准线
- **虚线**：规定周期标准
- **采购基准线**：固定40天
- **合同基准线**：固定30天

### 区域标注
- **绿色区域**：低于基准时间（正常）
- **红色区域**：超出基准时间（超期）

## 数据点含义示例

以 **2025年5月15日的点** 为例：

- **Y轴值 = 35天**：该业务从业务日期到归档完成用了35天
- **X轴值 = 2025-05-15**：该业务在5月15日完成归档
- **鼠标悬停信息**：
  - 归档周期：35天
  - 业务编号：CG-2025-001
  - 经办人：张三

## 应用场景

### 1. 主页面趋势图
- **项目视图**：
  - 无项目筛选：显示所有项目的散点
  - 有项目筛选：显示该项目下各经办人的散点
- **个人视图**：显示所有经办人的散点

### 2. 详情模态框趋势图
- 点击"查看详情"按钮后
- 显示该项目/经办人的具体业务散点

## 与工作周期监控的区别

### 相同点
- 都使用散点图展示
- 都有基准线和区域标注
- 都支持鼠标悬停查看详情

### 不同点
| 特性 | 工作周期监控 | 归档监控 |
|------|------------|---------|
| X轴时间 | 业务完成时间（结果公示/签订日期） | 归档完成时间 |
| Y轴含义 | 工作周期（开始到完成） | 归档周期（业务日期到归档日期） |
| 采购基准线 | 根据采购方式动态（15-45天） | 固定40天 |
| 合同基准线 | 固定30天 | 固定30天 |

## 优势总结

1. **数据真实性**：每个点代表一个真实业务，不做平均处理
2. **异常可见**：超期业务（如60天）在图上显著突出
3. **时间精确**：按实际归档完成日期精确定位
4. **对比清晰**：基准线和区域标注帮助判断是否超期
5. **交互友好**：鼠标悬停即可查看业务详情

## 注意事项

1. **数据量大时的性能**：散点数量较多时可能影响渲染速度，已通过 top_n 限制人员/项目数量
2. **基准线设置**：采购归档40天，合同归档30天（固定值）
3. **日期格式**：后端返回 ISO 格式（YYYY-MM-DD），前端转换为时间戳
4. **区域标注**：使用 ApexCharts 的 annotations 功能实现

## 测试建议

1. **数据完整性**：确保散点数据包含 date、cycle_days、code、person 等字段
2. **多种场景**：测试不同年度筛选、项目筛选
3. **边界情况**：测试无数据、单条数据、大量数据的显示
4. **交互验证**：验证 tooltip、缩放、图例点击等交互功能

## 文件修改清单

- ✅ `project/services/monitors/archive_statistics.py` - 后端数据生成逻辑
  - `_calculate_trend()` - 改为返回散点数据
  - `get_persons_multi_trend()` - 改为返回散点数据
  - `get_projects_multi_trend()` - 改为返回散点数据
  - `get_project_officers_multi_trend()` - 改为返回散点数据
- ✅ `project/templates/monitoring/archive.html` - 前端图表渲染逻辑
  - `renderDetailTrend()` - 改为散点图渲染
  - `renderMultiSeriesChart()` - 改为散点图渲染

## 兼容性说明

- 前端使用 ApexCharts 库，已在项目中使用
- 无需额外依赖
- 浏览器兼容性：支持现代浏览器（Chrome, Firefox, Safari, Edge）

## 参考文档

- [工作周期趋势图散点图改造说明](./工作周期趋势图-散点图改造说明.md)
- ApexCharts 官方文档：https://apexcharts.com/