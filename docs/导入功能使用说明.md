# 导入功能使用说明

## 概述

本文档介绍了采购台账系统的Excel/CSV导入功能，包括冲突处理模式、合同序号关联、关联数据自动继承和编码自动检测等功能。

## 功能特性

### 1. 导入模式

导入时支持三种数据导入模式：

- **增量模式（update）**：默认模式，更新已有记录，添加新记录。适合日常数据更新和补充
- **仅新增模式（skip）**：只添加新记录，跳过已存在的记录。适合首次导入或只想添加新数据的场景
- **替换模式（replace）**：清空指定项目的所有相关数据后重新导入。⚠️ **谨慎使用，此操作不可恢复！**

#### 替换模式说明

替换模式会完全清空指定项目的数据，然后导入新数据。使用此模式时：

- 必须指定项目编码（`--project-code`参数）
- 会清空该项目的所有相关模块数据：
  - **合同模块**：清空项目的所有合同及相关付款记录
  - **付款模块**：清空项目下所有合同的付款记录
  - **采购模块**：清空项目的所有采购记录
  - **评价模块**：清空项目下所有合同的供应商评价
- ⚠️ 此操作不可恢复，建议使用前先用`--dry-run`验证数据
- 适用场景：项目数据需要完全重新导入，或历史数据有重大变更需要替换

**安全提示**：
1. 使用前务必备份数据库
2. 先用`--dry-run`参数验证数据
3. 确认项目编码正确无误
4. 了解数据清空的影响范围

### 2. 合同序号关联

补充协议的关联主合同编号现在支持使用合同序号而非合同编号，提供更灵活的关联方式。

### 3. 关联数据自动继承

补充协议和解除协议在关联主合同时，会自动继承主合同的以下信息（如果用户未填写）：
- **项目信息**：自动继承主合同关联的项目
- **采购信息**：自动继承主合同关联的采购项目
- **合同来源**：自动继承主合同的合同来源（采购合同/直接签订）

这样用户在导入补充协议时，只需填写关联主合同编号，无需重复填写项目和采购信息。

### 4. 文件编码自动检测

系统会自动检测CSV文件的编码格式，支持：
- UTF-8（包括UTF-8 with BOM）
- GBK/GB2312（Windows中文默认编码）
- 其他常见编码

用户无需手动转换文件编码，系统会自动识别并使用正确的编码读取文件。

### 5. 导入模式自动识别

Web导入接口会自动识别文件格式（长表 vs 宽表）：

- **付款和评价模块**：
  - 如果CSV文件列数 > 10，自动使用**宽表模式**
  - 否则使用长表模式
  
- **其他模块**：默认使用长表模式

**宽表格式示例**（付款导入）：
```
合同编号,结算价（元）,是否办理结算,2019年1月,2019年2月,...,2025年12月
HT2025001,5700000.00,是,,1500000.00,,...
```

**长表格式示例**（付款导入）：
```
付款编号,关联合同编号,实付金额(元),付款日期
FK001,HT2025001,1500000.00,2019-02-01
```

用户无需手动指定模式，系统会根据文件结构自动选择正确的导入方式。

## 使用方法

### 基本语法

```bash
python manage.py import_excel <文件路径> [选项]
```

### 命令参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `file_path` | 必需 | - | 要导入的CSV文件路径 |
| `--mode` | 可选 | long | 导入模式：long=长表，wide=宽表转长表 |
| `--module` | 可选 | procurement | 导入模块类型：project/procurement/contract/payment/evaluation |
| `--encoding` | 可选 | utf-8-sig | 文件编码 |
| `--skip-errors` | 标志 | False | 跳过错误行继续导入 |
| `--dry-run` | 标志 | False | 仅验证数据，不实际导入 |
| `--conflict-mode` | 可选 | update | 导入模式：update（增量）/skip（仅新增）/replace（替换） |
| `--project-code` | 可选 | - | 项目编码（replace模式必需） |

### 使用示例

#### 1. 基本导入

```bash
# 导入合同数据
python manage.py import_excel data/imports/contracts.csv --module contract

# 导入采购数据
python manage.py import_excel data/imports/procurement.csv --module procurement
```

#### 2. 不同导入模式

```bash
# 增量模式（默认）- 更新已有记录，添加新记录
python manage.py import_excel data/imports/contracts.csv --module contract --conflict-mode update

# 仅新增模式 - 只添加新记录，跳过已存在的
python manage.py import_excel data/imports/contracts.csv --module contract --conflict-mode skip

# 替换模式 - 清空项目数据后重新导入（⚠️ 谨慎使用）
python manage.py import_excel data/imports/contracts.csv --module contract --conflict-mode replace --project-code BHHY
```

#### 3. 预演模式

```bash
# 验证数据但不实际导入
python manage.py import_excel data/imports/contracts.csv --module contract --dry-run
```

#### 4. 宽表导入

```bash
# 导入宽表格式的付款数据
python manage.py import_excel data/imports/payments_wide.xlsx --mode wide --module payment
```

## 合同序号关联功能

### 功能说明

在合同导入中，补充协议的"关联主合同编号"字段现在支持：

1. **合同序号**：优先尝试将值作为合同序号查找主合同
2. **合同编号**：如果作为序号查找失败，则尝试作为合同编号查找（向后兼容）

### 使用示例

在合同导入CSV中：

```csv
项目编码,关联采购编号,序号,合同序号,合同编号,合同名称,合同类型,合同来源,关联主合同编号,...
PRJ2025001,GC2025001,1,10,HT2025010,主合同,主合同,采购合同,,
PRJ2025001,GC2025001,2,11,HT2025010-BC01,补充协议,补充协议,采购合同,10,...
```

在上面的例子中，补充协议通过合同序号"10"关联到主合同。

**自动继承示例**：

当导入补充协议时，可以省略项目编码和关联采购编号：

```csv
项目编码,关联采购编号,合同类型,序号,合同序号,合同编号,合同名称,...
PRJ2025001,GC2025001,主合同,1,10,HT2025010,主合同,...
,,补充协议,2,11,HT2025010-BC01,补充协议,1,...
```

系统会自动输出：
```
补充协议自动继承主合同的采购信息: GC2025001
补充协议自动继承主合同的项目信息: PRJ2025001
补充协议自动继承主合同的合同来源: 采购合同
```

## 数据模板

### 合同导入模板

位于：`data/imports/templates/合同导入模板.csv`

包含以下字段（按顺序）：
1. 项目编码
2. 关联采购编号
3. **合同类型**（新增）：主合同/补充协议/解除协议，默认为主合同
4. 序号
5. 合同序号
6. 合同编号
7. 合同名称
8. 合同来源
9. 关联主合同编号
10. 其他合同信息字段

**合同类型说明**：
- **主合同**：独立存在的合同，不能关联其他合同
- **补充协议**：必须关联主合同，用于修改或补充主合同条款
- **解除协议**：必须关联主合同，用于解除主合同关系

**验证规则**：
- 主合同不能关联其他合同（如果填写了关联主合同编号，系统会自动清除）
- 补充协议和解除协议必须关联主合同，否则会报错
- 合同类型字段为空时，默认设置为主合同

### 采购导入模板

位于：`data/imports/templates/采购导入模板.csv`

包含完整的采购信息字段。

## 注意事项

1. **文件编码**：系统会自动检测CSV文件编码，无需手动转换。如需指定编码，可使用`--encoding`参数
2. **数据验证**：使用--dry-run参数先验证数据格式
3. **备份**：导入重要数据前建议备份数据库
4. **关联关系**：确保关联的记录已存在（如项目、采购等）
5. **合同序号**：确保作为关联的合同序号在数据库中唯一存在
6. **自动继承**：补充协议会自动继承主合同的项目、采购和合同来源信息，无需重复填写

## 错误处理

### 常见错误及解决方法

1. **编码错误**
   ```
   UnicodeDecodeError: 'utf-8' codec can't decode
   ```
   解决：使用`--encoding gbk`或转换文件编码为UTF-8-sig

2. **关联记录不存在**
   ```
   项目编码不存在: PRJ2025001
   ```
   解决：先导入关联的项目数据，或者让系统自动从主合同继承（补充协议）

3. **必填字段为空**
   ```
   合同编号不能为空
   ```
   解决：检查CSV文件中的必填字段

4. **替换模式缺少项目编码**
   ```
   replace模式必须指定--project-code参数
   ```
   解决：在命令中添加`--project-code`参数指定项目编码

5. **项目不存在**
   ```
   项目不存在: BHHY
   ```
   解决：检查项目编码是否正确

## 统计信息

导入完成后会显示统计信息：

```
==================================================
导入完成！
==================================================
总行数:         10
成功: 8
失败: 2
新增记录:       5
更新记录:       3
跳过记录:       0
==================================================
```

## 技术说明

### 实现细节

1. **导入模式处理**：
   - update模式：使用`update_or_create`方法，存在则更新，不存在则创建
   - skip模式：先检查记录是否存在，存在则跳过
   - replace模式：先清空项目数据，再执行导入
2. **合同序号关联**：支持整数序号查找，失败时回退到合同编号查找
3. **事务处理**：每行数据在独立事务中处理，确保数据一致性
4. **错误恢复**：支持跳过错误行继续导入
5. **级联删除**：replace模式清空数据时，会级联删除相关记录（如合同的付款记录）

### 性能优化

1. 批量处理可提高导入效率
2. 使用索引字段进行关联查询
3. 事务控制确保数据完整性

## 更新日志

### v1.3.0 (2025-10-21)

- 🔄 重新设计导入模式系统
- 🆕 新增replace（替换）模式，支持项目数据完全替换
- 🗑️ 移除error模式（实际使用场景较少）
- ⚠️ 替换模式增加安全提示和二次确认
- 🔒 替换模式必须指定项目编码，防止误操作
- 📊 改进前端导入对话框，提供清晰的模式说明

### v1.2.0 (2025-10-21)

- 新增关联数据自动继承功能
- 新增CSV文件编码自动检测
- 补充协议可自动继承主合同的项目、采购和合同来源信息
- 支持GBK、UTF-8等多种文件编码自动识别
- 修复付款记录导入时结算信息丢失的问题

### v1.1.0 (2025-10-21)

- 新增冲突处理模式支持（update/skip）
- 优化合同序号关联功能
- 改进错误处理和用户反馈
- 添加跳过记录统计
- 调整合同导入模板结构，合同类型字段移至第3列