# 导入功能使用说明

## 概述

本文档介绍了采购台账系统的Excel/CSV导入功能，包括冲突处理模式、合同序号关联、关联数据自动继承和编码自动检测等功能。

## 功能特性

### 1. 冲突处理模式

导入时支持三种数据冲突处理模式：

- **update（更新模式）**：默认模式，如果记录已存在则更新，不存在则创建
- **skip（跳过模式）**：如果记录已存在则跳过，只创建新记录
- **error（错误模式）**：如果记录已存在则报错停止导入

### 2. 合同序号关联

补充协议的关联主合同编号现在支持使用合同序号而非合同编号，提供更灵活的关联方式。

### 3. 关联数据自动继承

补充协议和解除协议在关联主合同时，会自动继承主合同的以下信息（如果用户未填写）：
- **项目信息**：自动继承主合同关联的项目
- **采购信息**：自动继承主合同关联的采购项目
- **合同来源**：自动继承主合同的合同来源（采购合同/直接签订）

这样用户在导入补充协议时，只需填写关联主合同编号，无需重复填写项目和采购信息。

### 4. 文件编码自动检测

系统会自动检测CSV文件的编码格式，支持：
- UTF-8（包括UTF-8 with BOM）
- GBK/GB2312（Windows中文默认编码）
- 其他常见编码

用户无需手动转换文件编码，系统会自动识别并使用正确的编码读取文件。

## 使用方法

### 基本语法

```bash
python manage.py import_excel <文件路径> [选项]
```

### 命令参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `file_path` | 必需 | - | 要导入的CSV文件路径 |
| `--mode` | 可选 | long | 导入模式：long=长表，wide=宽表转长表 |
| `--module` | 可选 | procurement | 导入模块类型：project/procurement/contract/payment/evaluation |
| `--encoding` | 可选 | utf-8-sig | 文件编码 |
| `--skip-errors` | 标志 | False | 跳过错误行继续导入 |
| `--dry-run` | 标志 | False | 仅验证数据，不实际导入 |
| `--conflict-mode` | 可选 | update | 数据冲突处理模式：update/skip/error |

### 使用示例

#### 1. 基本导入

```bash
# 导入合同数据
python manage.py import_excel data/imports/contracts.csv --module contract

# 导入采购数据
python manage.py import_excel data/imports/procurement.csv --module procurement
```

#### 2. 冲突处理模式

```bash
# 更新模式（默认）
python manage.py import_excel data/imports/contracts.csv --module contract --conflict-mode update

# 跳过模式
python manage.py import_excel data/imports/contracts.csv --module contract --conflict-mode skip

# 错误模式
python manage.py import_excel data/imports/contracts.csv --module contract --conflict-mode error
```

#### 3. 预演模式

```bash
# 验证数据但不实际导入
python manage.py import_excel data/imports/contracts.csv --module contract --dry-run
```

#### 4. 宽表导入

```bash
# 导入宽表格式的付款数据
python manage.py import_excel data/imports/payments_wide.xlsx --mode wide --module payment
```

## 合同序号关联功能

### 功能说明

在合同导入中，补充协议的"关联主合同编号"字段现在支持：

1. **合同序号**：优先尝试将值作为合同序号查找主合同
2. **合同编号**：如果作为序号查找失败，则尝试作为合同编号查找（向后兼容）

### 使用示例

在合同导入CSV中：

```csv
项目编码,关联采购编号,序号,合同序号,合同编号,合同名称,合同类型,合同来源,关联主合同编号,...
PRJ2025001,GC2025001,1,10,HT2025010,主合同,主合同,采购合同,,
PRJ2025001,GC2025001,2,11,HT2025010-BC01,补充协议,补充协议,采购合同,10,...
```

在上面的例子中，补充协议通过合同序号"10"关联到主合同。

**自动继承示例**：

当导入补充协议时，可以省略项目编码和关联采购编号：

```csv
项目编码,关联采购编号,合同类型,序号,合同序号,合同编号,合同名称,...
PRJ2025001,GC2025001,主合同,1,10,HT2025010,主合同,...
,,补充协议,2,11,HT2025010-BC01,补充协议,1,...
```

系统会自动输出：
```
补充协议自动继承主合同的采购信息: GC2025001
补充协议自动继承主合同的项目信息: PRJ2025001
补充协议自动继承主合同的合同来源: 采购合同
```

## 数据模板

### 合同导入模板

位于：`data/imports/templates/合同导入模板.csv`

包含以下字段（按顺序）：
1. 项目编码
2. 关联采购编号
3. **合同类型**（新增）：主合同/补充协议/解除协议，默认为主合同
4. 序号
5. 合同序号
6. 合同编号
7. 合同名称
8. 合同来源
9. 关联主合同编号
10. 其他合同信息字段

**合同类型说明**：
- **主合同**：独立存在的合同，不能关联其他合同
- **补充协议**：必须关联主合同，用于修改或补充主合同条款
- **解除协议**：必须关联主合同，用于解除主合同关系

**验证规则**：
- 主合同不能关联其他合同（如果填写了关联主合同编号，系统会自动清除）
- 补充协议和解除协议必须关联主合同，否则会报错
- 合同类型字段为空时，默认设置为主合同

### 采购导入模板

位于：`data/imports/templates/采购导入模板.csv`

包含完整的采购信息字段。

## 注意事项

1. **文件编码**：系统会自动检测CSV文件编码，无需手动转换。如需指定编码，可使用`--encoding`参数
2. **数据验证**：使用--dry-run参数先验证数据格式
3. **备份**：导入重要数据前建议备份数据库
4. **关联关系**：确保关联的记录已存在（如项目、采购等）
5. **合同序号**：确保作为关联的合同序号在数据库中唯一存在
6. **自动继承**：补充协议会自动继承主合同的项目、采购和合同来源信息，无需重复填写

## 错误处理

### 常见错误及解决方法

1. **编码错误**
   ```
   UnicodeDecodeError: 'utf-8' codec can't decode
   ```
   解决：使用`--encoding gbk`或转换文件编码为UTF-8-sig

2. **关联记录不存在**
   ```
   项目编码不存在: PRJ2025001
   ```
   解决：先导入关联的项目数据，或者让系统自动从主合同继承（补充协议）

3. **必填字段为空**
   ```
   合同编号不能为空
   ```
   解决：检查CSV文件中的必填字段

4. **数据冲突**
   ```
   合同编号已存在: HT2025001
   ```
   解决：使用适当的冲突处理模式

## 统计信息

导入完成后会显示统计信息：

```
==================================================
导入完成！
==================================================
总行数:         10
成功: 8
失败: 2
新增记录:       5
更新记录:       3
跳过记录:       0
==================================================
```

## 技术说明

### 实现细节

1. **冲突处理**：在导入前检查记录是否存在，根据conflict_mode参数决定处理方式
2. **合同序号关联**：支持整数序号查找，失败时回退到合同编号查找
3. **事务处理**：每行数据在独立事务中处理，确保数据一致性
4. **错误恢复**：支持跳过错误行继续导入

### 性能优化

1. 批量处理可提高导入效率
2. 使用索引字段进行关联查询
3. 事务控制确保数据完整性

## 更新日志

### v1.2.0 (2025-10-21)

- 新增关联数据自动继承功能
- 新增CSV文件编码自动检测
- 补充协议可自动继承主合同的项目、采购和合同来源信息
- 支持GBK、UTF-8等多种文件编码自动识别

### v1.1.0 (2025-10-21)

- 新增冲突处理模式支持（update/skip/error）
- 优化合同序号关联功能
- 改进错误处理和用户反馈
- 添加跳过记录统计
- 调整合同导入模板结构，合同类型字段移至第3列