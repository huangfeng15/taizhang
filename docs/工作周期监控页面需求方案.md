
# 工作周期监控页面需求方案

## 文档信息

- **创建日期**: 2025-01-12
- **文档版本**: v1.0
- **作者**: Documentation Writer
- **参考文档**: 
  - 归档监控页面完整需求文档
  - 齐全性检查监控页面改造需求方案

---

## 修订摘要（v1.1，2025-11-12）

- 新增“术语与口径”“指标与图表设计”“筛选与分组”“明细表与字段定义”“权限与安全”“数据来源与刷新”“非功能与性能”“埋点与运营指标”“验收标准（MVP）”“边界与异常处理”等章节，补齐口径、非功能与可验收要素。
- 明确两个核心周期（采购周期/合同周期）的时间边界、去重主键、排除策略与数据刷新策略，降低歧义与重复实现风险。
- 给出初版 SLA 与告警规则建议，便于聚焦超期治理与效率提升。
- 补充可执行的验收用例，确保方案落地与数据一致性校验。

> 说明：本次修订遵循 KISS（简洁）、YAGNI（只做当下必须）、DRY（避免重复）与 SOLID 中“单一职责”原则，重点补齐最小可用版本（MVP）落地所必需的口径、交互与验收内容，不对现有章节做大幅改写。

---

## 术语与口径（新增）

1) 时间与时区
- 统一采用北京时间（UTC+8），所有展示与计算基于事件时间；若来源仅有系统时间，需在数据字典中标注“使用系统时间替代事件时间”。
- 跨天按自然日计算，周期单位为“天”，向下取整到整数天（示例：36.8 小时记为 1 天）。

2) 核心周期定义
- 采购周期（天）= 结果公示完成时间 − 需求书审批完成时间
- 合同周期（天）= 合同签订日期 − 结果公示完成时间
  - 若缺失任一端点，周期为空，不纳入均值/中位数计算；但在“数据质量”卡片中计入“缺口数量”。

3) 主键与去重
- 统计粒度：采购项目ID（或标段/包ID，以下统称“项目ID”）。
- 去重规则：同一项目ID保留最新一次完整公示与合同签订配对记录；若存在多合同，按“合同签订日期最早”归属一次，其余进入“异常/多合同”指标。

4) 排除与包含
- 排除：测试/演练、作废/废标/流标、已取消项目；口径需在筛选器提供“是否包含异常项”。
- 包含：补公示、补签合同只要满足口径即可纳入，当期按最近一次事件计算。

5) 数据时效与刷新
- 刷新策略：T+1，每日 06:00 全量刷新，涉及多表时保持“同一批次”的批次号。
- 延迟声明：当日 06:00 前发生的事件最迟出现在当日 07:00 的看板中；若上游延迟，页面显著提示“数据时间：yyyy-MM-dd HH:mm”。

6) 统计方法
- 汇总指标：平均数、P50（中位数）、P90、最大值、最小值、项目数、超期项目数、超期率。
- 分布指标：周期直方图（以 5 天/10 天为桶宽，可配置），并支持箱线图查看离群点。

7) 例外场景
- 多次公示：以“最终有效公示完成时间”为准。
- 多合同：默认取最早合同签订日期，余项进入“多合同异常”。
- 缺失端点：不计算周期，列入“数据质量-缺失端点”。

## 指标与图表设计（新增）

1) 总览卡片
- 采购周期：平均、P50、P90、项目数、超期项目数、超期率
- 合同周期：平均、P50、P90、项目数、超期项目数、超期率
- 数据质量：缺失端点项目数、异常（多合同/多公示）项目数

2) 趋势与分布
- 趋势（周/月）：两类周期分别以时间维度（需求审批完成周/月）展示平均与P50曲线，支持对比 P90；可切换“按项目发生周/月”。
- 周期分布：周期直方图 + 箱线图，点击桶/异常点可下钻到明细。

3) 维度拆解
- 拆解维度：业务部门、采购方式、项目类型/专业、金额区间、供应商、年度、项目经理/经办人。
- 展示形式：维度柱状图（Top-N 可切换 5/10/20），支持排序（平均、P50、P90、项目数）。

### 总览卡文案与计算口径（新增）

| 指标唯一名 | 中文文案 | 业务含义 | 计算口径/公式 | 统计粒度 | 时间口径 | 排除/包含 | 备注 |
|---|---|---|---|---|---|---|---|
| procurement_cycle_avg | 采购周期（平均） | 采购周期的平均天数 | avg(采购周期天) | 项目ID | 跟随筛选器选择的事件时间 | 排除测试/作废/流标/撤项；端点缺失不纳入均值 | 四舍五入到整数天 |
| procurement_cycle_p50 | 采购周期（P50） | 采购周期的中位数 | P50(采购周期天) | 项目ID | 同上 | 同上 | DB函数按实际实现（percentile_disc/approx_pct） |
| procurement_cycle_p90 | 采购周期（P90） | 采购周期的90分位 | P90(采购周期天) | 项目ID | 同上 | 同上 | 同上 |
| procurement_count | 采购项目数 | 周期可计算的项目数量 | count(distinct 项目ID where 采购周期非空) | 项目ID | 同上 | 同上 | 仅统计端点齐全项目 |
| procurement_overdue_cnt | 采购超期项目数 | 超过采购SLA阈值的项目数量 | count(distinct 项目ID where 采购周期天 > SLA_采购) | 项目ID | 同上 | 同上 | SLA 见下节 |
| procurement_overdue_rate | 采购超期率 | 超期项目在可计算项目中的占比 | procurement_overdue_cnt / procurement_count | 项目ID | 同上 | 同上 | 百分比保留1位小数 |
| contract_cycle_avg | 合同周期（平均） | 合同周期的平均天数 | avg(合同周期天) | 项目ID | 同上 | 同上 | 四舍五入到整数天 |
| contract_cycle_p50 | 合同周期（P50） | 合同周期的中位数 | P50(合同周期天) | 项目ID | 同上 | 同上 | —— |
| contract_cycle_p90 | 合同周期（P90） | 合同周期的90分位 | P90(合同周期天) | 项目ID | 同上 | 同上 | —— |
| contract_count | 合同项目数 | 合同周期可计算的项目数量 | count(distinct 项目ID where 合同周期非空) | 项目ID | 同上 | 同上 | 仅统计端点齐全项目 |
| contract_overdue_cnt | 合同超期项目数 | 超过合同SLA阈值的项目数量 | count(distinct 项目ID where 合同周期天 > SLA_合同) | 项目ID | 同上 | 同上 | SLA 见下节 |
| contract_overdue_rate | 合同超期率 | 超期项目在可计算项目中的占比 | contract_overdue_cnt / contract_count | 项目ID | 同上 | 同上 | 百分比保留1位小数 |
| dq_missing_endpoints | 数据质量-缺失端点数 | 不满足端点齐全的项目数量 | count(distinct 项目ID where 端点缺失) | 项目ID | 同上 | 包含 | 用于治理，不参与均值/分位计算 |
| dq_anomaly_projects | 数据质量-异常项目数 | 多公示/多合同/跨系统差异等异常项目 | count(distinct 项目ID where 异常标记=true) | 项目ID | 同上 | 包含 | 异常枚举见下文 |

备注：
- “时间口径”随筛选器选择三者之一（需求审批/公示/合同），仅影响过滤范围，不改变周期端点定义。
- 分位数函数按目标数据栈选择等价实现（percentile_disc/percentile_cont/approx_percentile）。

## SLA 与告警规则（新增）

- 默认阈值（可配置）：
  - SLA_采购 = 30 天；SLA_合同 = 20 天。
  - 颜色规则（卡片/图表标识）：<= SLA 正常（绿），> SLA 且 <= 1.5×SLA 预警（黄），> 1.5×SLA 告警（红）。
- 告警触发：
  - 每日 T+1 刷新后生成“超期清单”；部门经理及项目经办的各自范围内 Top N 超期项目推送。
  - 周报聚合：按部门/采购方式统计超期率与较上周变化，超过阈值变动进行邮件/IM 提醒。
- 例外：
  - 经确认的特殊项目可在白名单内豁免告警，但不影响整体统计（可加“豁免”标记）。

## 筛选与分组（新增）

- 时间范围：支持按“需求审批完成时间”“公示完成时间”“合同签订时间”三种事件口径之一进行筛选（互斥，默认“需求审批完成时间”）。
- 业务维度：业务部门、采购方式、项目类型/专业、金额区间、供应商、年度、项目经理/经办人。
- 数据选项：是否包含异常（多公示/多合同/缺端点）、是否仅看逾期。
- 分组：按维度字段分组统计，并可在明细表中同步应用当前筛选器。

## 明细表与字段定义（新增）

- 字段：项目ID、项目名称、标段/包、需求审批完成时间、结果公示完成时间、合同签订日期、采购周期(天)、合同周期(天)、采购方式、金额（含币种/含税标识）、业务部门、项目经理/经办人、供应商、状态（正常/异常类型）、是否逾期、SLA 阈值、备注。
- 交互：
  - 点击任意汇总/分布/维度图表可过滤并下钻至明细（保留“返回上一级”）。
  - 明细表支持排序、关键字搜索、导出（CSV/Excel）。

### 字段字典（新增）

| 字段名 | 中文名 | 类型 | 可空 | 示例值 | 来源表/字段 | 规则/备注 |
|---|---|---|---|---|---|---|
| project_id | 项目ID | string | 否 | PRJ-2024-0001 | 各源系统统一主键 | 统计粒度主键；与标段/包组合可选 |
| project_name | 项目名称 | string | 否 | 办公楼改造 | 采购/公告系统 | —— |
| section_id | 标段/包 | string | 是 | A包 | 公告/合同系统 | 作为细分主键时参与去重 |
| demand_approval_time | 需求审批完成时间 | datetime | 是 | 2024-07-02 15:20 | 流程系统 | 周期起点（采购） |
| result_publish_time | 结果公示完成时间 | datetime | 是 | 2024-07-20 10:00 | 公告系统 | 周期终点（采购）/起点（合同） |
| contract_sign_date | 合同签订日期 | datetime | 是 | 2024-07-28 09:30 | 合同系统 | 周期终点（合同） |
| procurement_cycle_days | 采购周期(天) | int | 是 | 18 | 派生 | DATEDIFF(day,demand_approval_time,result_publish_time)；缺端点为空 |
| contract_cycle_days | 合同周期(天) | int | 是 | 8 | 派生 | DATEDIFF(day,result_publish_time,contract_sign_date)；缺端点为空 |
| procurement_method | 采购方式 | string | 是 | 公开招标 | 公告系统 | 维度字段 |
| amount | 金额 | decimal(18,2) | 是 | 1200000.00 | 合同系统 | 与币种/含税分开存储 |
| currency | 币种 | string | 是 | CNY | 合同系统 | —— |
| tax_included | 含税 | boolean | 是 | Y | 合同系统 | Y/N |
| department | 业务部门 | string | 是 | 工程部 | 流程/主数据 | 权限切分字段 |
| owner | 项目经理/经办人 | string | 是 | Zhang San | 流程系统 | 权限切分字段 |
| supplier | 供应商 | string | 是 | XX 建设 | 合同系统 | 维度字段 |
| status | 状态 | string | 否 | 正常 | 派生 | 正常/多合同/多公示/缺失端点/跨系统差异 |
| is_overdue_proc | 采购是否逾期 | boolean | 否 | N | 派生 | procurement_cycle_days > SLA_采购 |
| is_overdue_cont | 合同是否逾期 | boolean | 否 | N | 派生 | contract_cycle_days > SLA_合同 |
| sla_proc_days | 采购SLA阈值(天) | int | 否 | 30 | 配置 | 页面/后端配置写入明细便于导出复核 |
| sla_cont_days | 合同SLA阈值(天) | int | 否 | 20 | 配置 | 同上 |
| batch_no | 批次号 | string | 否 | 20250112-0600 | ETL | 追溯数据版本 |
| data_time | 数据时间 | datetime | 否 | 2025-01-12 06:00 | ETL | 页面顶部显示“数据时间” |
| remark | 备注 | string | 是 | —— | 派生 | 手工豁免/异常说明 |

### 示例SQL/逻辑（新增）

```sql
-- 示例：按项目去重后计算采购/合同周期（表名与字段按现网对齐）
WITH publish_dedup AS (
  SELECT p.project_id, p.section_id, p.publish_time,
         ROW_NUMBER() OVER (PARTITION BY p.project_id ORDER BY p.publish_time DESC) AS rn
  FROM   t_publish p
  WHERE  p.status = '有效'
),
contract_dedup AS (
  SELECT c.project_id, c.section_id, c.sign_date,
         ROW_NUMBER() OVER (PARTITION BY c.project_id ORDER BY c.sign_date ASC) AS rn
  FROM   t_contract c
  WHERE  c.status = '有效'
),
joined AS (
  SELECT d.project_id, d.approval_time AS demand_approval_time,
         p.publish_time AS result_publish_time,
         c.sign_date    AS contract_sign_date
  FROM   t_demand d
  LEFT JOIN publish_dedup p ON p.project_id = d.project_id AND p.rn = 1
  LEFT JOIN contract_dedup c ON c.project_id = d.project_id AND c.rn = 1
)
SELECT j.project_id,
       DATEDIFF(day, j.demand_approval_time, j.result_publish_time) AS procurement_cycle_days,
       DATEDIFF(day, j.result_publish_time,   j.contract_sign_date)  AS contract_cycle_days
FROM   joined j;
```

说明：
- 多公示取“最终有效公示完成时间”（rn=1）；多合同取“最早签订合同”（rn=1）。
- 缺失端点的项目，周期为空但计入数据质量计数。

## 权限与安全（新增）

- 可见性：
  - 业务负责人/高层：全量聚合与全域明细（含脱敏规则）。
  - 部门经理：本部门聚合与明细。
  - 项目经办：仅本人负责项目明细，无全量聚合。
- 审计：记录筛选条件、导出操作、异常项查看行为，保留 90 天。

## 数据来源与刷新（新增）

- 数据源：
  - 需求审批：流程系统表（需字段：项目ID、审批完成时间、经办人、部门）。
  - 结果公示：公告系统表（项目ID、公示完成时间、公示状态）。
  - 合同签订：合同系统表（项目ID、合同ID、签订日期、金额、供应商）。
- 刷新策略：T+1 06:00 批处理；提供批次号与数据时间展示；异常时顶部告警。
- 质量校验：端点缺失计数、跨系统键匹配率、时间逆序/异常负值、金额为空/为0 项数。

## 非功能与性能（新增）

- 首屏 3s 内可见核心统计卡与趋势骨架，10s 内完整渲染（P95）。
- 空/慢/错态：
  - 空：显示引导“更换时间范围或取消异常过滤”。
  - 慢：骨架屏+进度提示（含当前数据时间）。
  - 错：可重试，展示批次号与联系渠道。

## 埋点与运营指标（新增）

- 指标：日活/周活、筛选器使用次数、导出次数、Top 3 常用维度、下钻深度分布、异常项目复盘点击率。
- 用途：评估页面有效性与指导后续优化（如默认维度、默认时间范围）。

## 验收标准（MVP）（新增）

1) 计算一致性
- 给定对照样本（≥20 条），页面显示的采购/合同周期均与样本 Excel 计算一致（允许 ±1 天四舍五入差）。
- 缺失端点项目不计入均值/中位数，计入“数据质量-缺失端点”。

2) 交互与过滤
- 趋势/分布/维度点击后，明细表联动筛选，返回按钮可一级级回退。
- 筛选器在刷新后保持状态（Session 级）。

3) 非功能
- 首屏渲染 P95 ≤ 3s；全量渲染 P95 ≤ 10s；导出 ≤ 30s。

4) 权限
- 不同角色仅能查看授权范围数据；越权访问被拒绝并记录审计日志。

## 边界与异常处理（新增）

- 多公示/多合同：采取“最近有效公示/最早签订合同”的口径，其余计入异常项并可筛选查看。
- 撤项/流标/废标：默认排除；如需纳入分析，通过“包含异常”开关控制。
- 跨系统时间不一致：以“公示/合同系统”为准，若差异超 7 天，进入“数据质量-跨系统差异”。

---

---

## 一、需求背景

### 1.1 需求来源

**用户原始需求**：
> "请你了解归档监控页面的设计实现,然后设计一个关于工作周期的监控。目前第一阶段仅考虑采购和合同(仅针对采购合同)。采购周期为需求书审批完成时间至采购结果公示完成时间之间的差额。采购合同的时间为合同签订日期与采购结果公示完成时间之间的差额。针对采购、合同周期考核的特点,帮我设计一个周期的方案需求书。"

**核心诉求分析**：
1. **参照归档监控的成功设计**：采用双视图模式、概览统计、详情展示
2. **周期监控的特殊性**：关注业务流程的时效性，而非归档时效性
3. **双周期维度**：采购周期 + 采购合同周期
4. **考核导向**：识别超期项目、分析周期趋势、评估工作效率

### 1.2 业务背景

**采购流程时间节点**：
```
需求书审批完成 → 采购公告发布 → 开标评标 → 结果公示完成 → 合同签订
     ↓                                           ↓              ↓
  【采购周期起点】                         【采购周期终点】  【合同周期终点】
```

**关键时间定义**：
- **采购周期**: 需求书审批完成日期 → 结果公示发布日期
- **采购合同周期**: 结果公示发布日期 → 合同签订日期

**业务意义**：
- **采购周期**：反映采购流程的执行效率，包括公告发布、开标评标、公示等环节
- **采购合同周期**：反映合同签订的及时性，是采购流程的收尾环节
- **综合评估**：两个周期共同反映项目的整体推进效率

### 1.3 与归档监控的区别

| 对比项 | 归档监控 | 工作周期监控 |
|--------|---------|-------------|
| **关注点** | 资料归档及时性 | 业务流程执行效率 |
| **时间起点** | 业务完成日期 | 需求书审批完成日期 |
| **时间终点** | 归档日期 | 结果公示/合同签订日期 |
| **考核标准** | 规定归档期限（40天/30天） | 规定业务周期（待定） |
| **业务场景** | 事后管理 | 事中监控 |
| **数据特点** | 已完成归档的记录 | 包括进行中的项目 |

---

## 二、功能设计

### 2.1 双视图模式设计

参照归档监控的成功设计，实现**项目视图**和**个人视图**。

#### 2.1.1 项目视图

**展示维度**：以项目为单位

**页面布局**：

```
┌────────────────────────────────────────────────────────┐
│ 页面标题: 工作周期监控                                │
│ [项目视图] [个人视图]                    [全局筛选]  │
├────────────────────────────────────────────────────────┤
│ 当前筛选：2024年度 · 全部项目                         │
├────────────────────────────────────────────────────────┤
│ KPI汇总卡片（4张）                                     │
│ ┌──────┬──────┬──────┬──────┐                        │
│ │项目数│采购  │采购  │综合  │                        │
│ │      │周期  │合同  │及时率│                        │
│ │      │      │周期  │      │                        │
│ │ 15   │45.2天│12.3天│85.3% │                        │
│ └──────┴──────┴──────┴──────┘                        │
├────────────────────────────────────────────────────────┤
│ 项目周期统计明细                                       │
│ ┌────────────────────────────────────────────────┐   │
│ │项目│采购数│平均周期│合同数│平均周期│综合率│操作││   │
│ │名称│      │(及时率)│      │(及时率)│      │    ││   │
│ │────────────────────────────────────────────────│   │
│ │PRJ │25/30 │42天    │18/20 │10天    │86.7% │详情││   │
│ │001 │      │(88%)   │      │(95%)   │      │    ││   │
│ │XX  │ [进度条████████] [进度条████████]       ││   │
│ │项目│      │                                    ││   │
│ │────────────────────────────────────────────────│   │
│ │PRJ │28/30 │38天    │25/30 │8天     │91.7% │详情││   │
│ │002 │      │(93%)   │      │(100%)  │      │    ││   │
│ │YY  │ [进度条████████] [进度条████████]       ││   │
│ │项目│      │                                    ││   │
│ └────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────┘
```

**数据说明**：
- **采购数**：已完成/总数（例如：25/30表示30个采购中25个已完成结果公示）
- **平均周期**：已完成采购的平均周期天数
- **及时率**：周期在规定期限内的占比
- **综合率**：采购和合同综合及时率

#### 2.1.2 个人视图

**展示维度**：以经办人为单位

**页面布局**：

```
┌────────────────────────────────────────────────────────┐
│ 页面标题: 工作周期监控                                │
│ [项目视图] [个人视图]                    [全局筛选]  │
├────────────────────────────────────────────────────────┤
│ KPI汇总卡片（4张）                                     │
│ ┌──────┬──────┬──────┬──────┐                        │
│ │经办人│采购  │采购  │综合  │                        │
│ │总数  │周期  │合同  │及时率│                        │
│ │      │      │周期  │      │                        │
│ │ 8    │45.2天│12.3天│85.3% │                        │
│ └──────┴──────┴──────┴──────┘                        │
├────────────────────────────────────────────────────────┤
│ 经办人周期统计明细                                     │
│ ┌────────────────────────────────────────────────┐   │
│ │姓名│项目│采购数│平均  │合同数│平均  │综合│操作││   │
│ │    │数  │      │周期  │      │周期  │率  │    ││   │
│ │────────────────────────────────────────────────│   │
│ │张三│3个 │25/30 │42天  │18/20 │10天  │86% │详情││   │
│ │    │    │      │(88%) │      │(95%) │    │    ││   │
│ │────────────────────────────────────────────────│   │
│ │李四│2个 │28/30 │38天  │25/30 │8天   │92% │详情││   │
│ │    │    │      │(93%) │      │(100%)│    │    ││   │
│ └────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────┘
```

### 2.2 周期趋势图设计

**继承归档监控的趋势图设计**，但数据维度调整为周期天数。

#### 2.2.1 项目周期趋势图

**显示条件**：项目视图下，选择了具体项目时显示

**图表设计**：

```
┌────────────────────────────────────────────────────────┐
│ 项目周期趋势                                           │
│ ┌────────────────────────────────────────────────┐   │
│ │                   Chart.js 折线图               │   │
│ │  60天│                                         │   │
│ │      │        ●                                │   │
│ │  50天│    ●       ●                            │   │
│ │      │●              ●                         │   │
│ │  40天├─────────────────────────(基准线)────────│   │
│ │      │                   ●      ●              │   │
│ │  30天│                                         │   │
│ │      │                                         │   │
│ │  20天│                        ◆     ◆    ◆    │   │
│ │      │                  ◆                      │   │
│ │  10天├─────────────────────────(基准线)────────│   │
│ │      │            ◆                            │   │
│ │   0天└─────────────────────────────────────────│   │
│ │      1月  2月  3月  4月  5月  6月  7月  8月  9月│   │
│ │                                                │   │
│ │  图例：● 采购周期  ◆ 采购合同周期              │   │
│ │        ─── 采购基准(60天) ─── 合同基准(15天)  │   │
│ └────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────┘
```

**X轴**：
- 全年度模式：按半年分组（2023上半年、2023下半年...）
- 单年度模式：按月分组（1月、2月...12月）

**Y轴**：平均周期（天）

**数据系列**：
- 采购平均周期（蓝色实线 ●）
- 采购合同平均周期（绿色实线 ◆）
- 采购规定周期基准线（蓝色虚线，建议60天）
- 合同规定周期基准线（绿色虚线，建议15天）

**特性**：
- 自动跳过无数据的时间点
- 鼠标悬停显示详细数据（平均周期、完成数量、及时率）
- 响应式设计

#### 2.2.2 个人周期趋势图

**显示条件**：个人视图下始终显示（所有经办人汇总数据）

**数据范围**：基于全局筛选（年度、项目）后，所有经办人的汇总趋势

### 2.3 超期记录列表设计

**参照归档监控的超期列表设计**，按严重程度分组展示。

#### 2.3.1 严重程度分级

**采购周期分级**（假设规定周期60天）：
- 🔴 **严重超期**：超期30天以上（总周期>90天）
- 🟡 **中度超期**：超期15-30天（总周期60-90天）
- 🟢 **轻微超期**：超期1-15天（总周期60-75天）
- ⏳ **进行中**：未完成但未超期（已用时<60天）

**采购合同周期分级**（假设规定周期15天）：
- 🔴 **严重超期**：超期15天以上（总周期>30天）
- 🟡 **中度超期**：超期7-15天（总周期15-30天）
- 🟢 **轻微超期**：超期1-7天（总周期15-22天）
- ⏳ **进行中**：未签订但未超期（已用时<15天）

#### 2.3.2 超期列表布局

```
┌────────────────────────────────────────────────────────┐
│ 超期记录                           ☑ 显示所有记录     │
├────────────────────────────────────────────────────────┤
严重超期（采购：5条 / 合同：2条）                  │
│ ┌────────────────────────────────────────────────┐   │
│ │类型│编号  │名称      │经办人│起始日│到期日│超期││
│ │采购│P001  │XX采购    │张三  │01-05 │03-05 │35天││
│ │采购│P002  │YY采购    │李四  │01-10 │03-10 │32天││
│ │合同│C001  │XX合同    │张三  │03-05 │03-20 │20天││
│ └────────────────────────────────────────────────┘   │
│ ▶ 中度超期（采购：3条 / 合同：1条）                  │
│ ▶ 轻微超期（采购：2条 / 合同：0条）                  │
│ ▶ 进行中项目（采购：15条 / 合同：8条）               │
└────────────────────────────────────────────────────────┘
```

**列表特性**：
1. **分组折叠**：按严重程度分组，可展开/折叠
2. **综合展示**：采购和合同记录混合展示，用类型标识区分
3. **显示所有记录**：勾选后包括未超期和已完成的记录
4. **快速操作**：点击编号跳转到详情页面

### 2.4 详情模态框设计

**参照归档监控的模态框设计**，展示项目或经办人的详细周期数据。

#### 2.4.1 项目详情模态框

```
┌────────────────────────────────────────────────────────┐
│ 项目详情: PRJ001 - XX项目名称              [关闭×]   │
├────────────────────────────────────────────────────────┤
│ 周期统计卡片（3张）                                   │
│ ┌──────────┬──────────┬──────────┐                   │
│ │采购周期  │合同周期  │综合及时率│                   │
│ │ 平均42天 │ 平均10天 │  86.7%   │                   │
│ │ (88%及时)│ (95%及时)│ 25/30完成│                   │
│ └──────────┴──────────┴──────────┘                   │
├────────────────────────────────────────────────────────┤
│ 周期趋势图                                             │
│ [采购周期和合同周期的月度趋势折线图]                  │
├────────────────────────────────────────────────────────┤
│ 超期记录明细（Tab切换：采购/合同）                    │
│ ┌────────────────────────────────────────────────┐   │
│ │ [采购] [合同]                                  │   │
│ │ ────────────────────────────────────────────── │   │
│ │ 编号  │名称    │经办人│周期│超期│状态  │操作 │   │
│ │ P001  │XX采购  │张三  │95天│35天│严重  │🔗编辑│   │
│ │ P002  │YY采购  │李四  │92天│32天│严重  │🔗编辑│   │
│ │ P003  │ZZ采购  │王五  │70天│10天│轻微  │🔗编辑│   │
│ └────────────────────────────────────────────────┘   │
├────────────────────────────────────────────────────────┤
│ 进行中项目（未完成的采购和合同）                      │
│ ┌────────────────────────────────────────────────┐   │
│ │ 编号  │名称    │经办人│已用时│剩余时│状态      │   │
│ │ P010  │AA采购  │张三  │45天  │15天  │正常进行  │   │
│ │ C005  │BB合同  │李四  │10天  │5天   │正常进行  │   │
│ │ P011  │CC采购  │王五  │65天  │-5天  │即将超期⚠│   │
│ └────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────┘
```

**关键特性**：
1. **周期统计**：显示平均周期、及时率、完成情况
2. **趋势分析**：可视化展示周期变化趋势
3. **超期明细**：列出所有超期记录，按严重程度排序
4. **进行中项目**：显示未完成但在进行中的项目，预警即将超期的项目
5. **快速编辑**：点击🔗链接跳转到编辑页面

#### 2.4.2 经办人详情模态框

```
┌────────────────────────────────────────────────────────┐
│ 经办人详情: 张三                           [关闭×]   │
├────────────────────────────────────────────────────────┤
│ 周期统计卡片（4张）                                   │
│ ┌──────────┬──────────┬──────────┬──────────┐       │
│ │负责项目数│采购周期  │合同周期  │综合及时率│       │
│ │   3个    │ 平均42天 │ 平均10天 │  86.7%   │       │
│ │          │ (88%及时)│ (95%及时)│ 25/30完成│       │
│ └──────────┴──────────┴──────────┴──────────┘       │
├────────────────────────────────────────────────────────┤
│ 按项目分组统计                                         │
│ ┌────────────────────────────────────────────────┐   │
│ │ 项目   │采购数│平均周期│合同数│平均周期│及时率│   │
│ │ PRJ001 │15/20 │45天    │8/10  │12天    │85%   │   │
│ │ PRJ002 │10/10 │38天    │10/10 │8天     │95%   │   │
│ └────────────────────────────────────────────────┘   │
├────────────────────────────────────────────────────────┤
│ 周期趋势图（该经办人所有项目的汇总趋势）              │
├────────────────────────────────────────────────────────┤
│ 超期记录明细（同项目详情）                             │
└────────────────────────────────────────────────────────┘
```

---

## 三、数据逻辑设计

### 3.1 周期计算规则

#### 3.1.1 采购周期

**计算公式**：
```
采购周期(天) = 结果公示发布日期 - 需求书审批完成日期

数据来源：
- 起始日期: Procurement.requirement_approval_date
- 结束日期: Procurement.result_publicity_release_date
```

**计算示例**：
```
采购项目 P001：
- 需求书审批完成：2024-01-05
- 结果公示发布：2024-03-15
- 采购周期 = 70天
```

**状态判断**：
```python
if 结果公示发布日期 is None:
    状态 = "进行中"
    已用时 = 当前日期 - 需求书审批完成日期
    剩余时间 = 规定周期 - 已用时
else:
    状态 = "已完成"
    实际周期 = 结果公示发布日期 - 需求书审批完成日期
    超期天数 = max(0, 实际周期 - 规定周期)

**⚠️ 重要统计规则**：
1. **未录入结果公示发布日期的采购不纳入统计**
   - 只有录入了`result_publicity_release_date`的采购才会被统计
   - 未录入的采购记录将被自动过滤，不计入总数、平均周期、及时率等任何指标
   - 这确保统计的都是真实完成的采购流程

2. **周期计算基于采购方式**
   - 每条采购记录根据其`procurement_method`字段使用对应的规定周期
   - 超期判断：超期天数 = 实际周期 - 对应采购方式的规定周期

```python
# 统计查询示例
queryset = Procurement.objects.filter(
    requirement_approval_date__isnull=False,  # 必须有需求书审批日期
    result_publicity_release_date__isnull=False  # ⚠️ 必须有结果公示日期才纳入统计
).annotate(
    cycle_days=ExpressionWrapper(
        F('result_publicity_release_date') - F('requirement_approval_date'),
        output_field=fields.DurationField()
    )
)
```
```

#### 3.1.2 采购合同周期

**计算公式**：
```
采购合同周期(天) = 合同签订日期 - 结果公示发布日期

数据来源：
- 起始日期: Procurement.result_publicity_release_date
- 结束日期: Contract.signing_date (需关联采购合同)

关联条件：
- Contract.contract_source = '采购合同'
- Contract.procurement_id = Procurement.procurement_code
```

**计算示例**：
```
合同 C001（关联采购 P001）：
- 结果公示发布：2024-03-15（来自采购P001）
- 合同签订：2024-03-28
- 合同周期 = 13天
```

**状态判断**：
```python
if 合同签订日期 is None:
    状态 = "进行中"（合同未签订）
    已用时 = 当前日期 - 结果公示发布日期
    剩余时间 = 规定周期 - 已用时
else:
    状态 = "已完成"
    实际周期 = 合同签订日期 - 结果公示发布日期
    超期天数 = max(0, 实际周期 - 规定周期)
```

### 3.2 平均周期与及时率

#### 3.2.1 平均周期

**计算公式**：
```
平均采购周期 = SUM(已完成采购的周期) / COUNT(已完成采购)
平均合同周期 = SUM(已完成合同的周期) / COUNT(已完成合同)
```

**注意事项**：
- 只统计已完成的记录（有结束日期）
- 进行中的项目不计入平均周期

#### 3.2.2 及时率

**计算公式**：
```
采购及时率 = COUNT(周期≤规定周期的采购) / COUNT(已完成采购) × 100%
合同及时率 = COUNT(周期≤规定周期的合同) / COUNT(已完成合同) × 100%
综合及时率 = (采购及时率 + 合同及时率) / 2
```

### 3.3 规定周期标准（按采购方式区分）

**重要说明**：根据业务实际需求，不同采购方式有不同的规定周期标准。

#### 3.3.1 采购周期标准（按采购方式）

| 采购方式 | 规定周期 | 说明 | 数据来源 |
|---------|---------|------|---------|
| **直接采购** | 15天 | 需求审批完成后15天内完成 | `procurement_method` |
| **战采结果应用** | 15天 | 需求审批完成后15天内完成 | `procurement_method` |
| **单一来源** | 25天 | 需求书审批完成后25天内完成 | `procurement_method` |
| **询价** | 35天 | 需求审批完成后35天内完成 | `procurement_method` |
| **竞价** | 35天 | 需求审批完成后35天内完成 | `procurement_method` |
| **比价** | 35天 | 需求审批完成后35天内完成 | `procurement_method` |
| **竞争性谈判** | 35天 | 需求审批完成后35天内完成 | `procurement_method` |
| **公开招标** | 45天 | 需求审批完成后45天内完成 | `procurement_method` |
| **邀请招标** | 45天 | 需求审批完成后45天内完成 | `procurement_method` |

**数据字段**：`Procurement.procurement_method`

**周期分组逻辑**：
```python
def get_procurement_deadline(procurement_method):
    """根据采购方式获取规定周期"""
    deadline_map = {
        '直接采购': 15,
        '战采结果应用': 15,
        '单一来源': 25,
        '询价': 35,
        '竞价': 35,
        '比价': 35,
        '竞争性谈判': 35,
        '公开招标': 45,
        '邀请招标': 45,
    }
    return deadline_map.get(procurement_method, 45)  # 默认45天
```

#### 3.3.2 采购合同周期标准（统一）

| 周期类型 | 规定周期 | 说明 |
|---------|---------|------|
| **采购合同周期** | 15天 | 结果公示到合同签订，主要是合同准备和签订流程 |

**重要说明**：
1. **动态规定周期**：采购周期的考核标准必须根据`procurement_method`字段动态确定
2. **及时率计算**：每条采购记录根据其采购方式使用对应的规定周期来判断是否及时
3. **趋势图基准线**：
   - 如果项目包含多种采购方式，趋势图显示加权平均基准线
   - 或者分别显示不同采购方式的基准线（虚线，不同颜色）
4. **超期判断**：超期天数 = 实际周期 - 
│ ▼ 

            'moderate': 7,   # 超期7-15天为中度
            'mild': 1        # 超期1-7天为轻微
        }
    }
}


class CycleStatisticsService:
    """工作周期统计服务类（参照ArchiveStatisticsService设计）"""

    def __init__(self):
        self.procurement_deadline = CYCLE_RULES['procurement']['deadline_days']
        self.contract_deadline = CYCLE_RULES['contract']['deadline_days']

    def get_projects_cycle_overview(self, year_filter=None, project_filter=None):
        """
        获取项目维度的周期概览
        
        Returns:
            dict: {
                'summary': {汇总统计},
                'projects': [{项目列表}]
            }
        """
        pass

    def get_persons_cycle_overview(self, year_filter=None, project_filter=None):
        """
        获取个人维度的周期概览
        
        Returns:
            dict: {
                'summary': {汇总统计},
                'persons': [{经办人列表}]
            }
        """
        pass

    def get_project_cycle_detail(self, project_code, year_filter=None):
        """
        获取单个项目的周期详情
        
        Returns:
            dict: {
                'procurement_trend': [...],
                'contract_trend': [...],
                'overdue_records': {...},
                'ongoing_records': {...}
            }
        """
        pass

    def get_person_cycle_detail(self, person_name, year_filter=None, project_filter=None):
        """
        获取单个经办人的周期详情
        """
        pass

    def _calculate_procurement_cycle_statistics(self, project_code=None, person_name=None,
                                               year_filter=None, global_project=None):
        """
        计算采购周期统计
        
        Returns:
            dict: {
                'avg_cycle': 平均周期,
                'on_time_rate': 及时率,
                'count': 已完成数量,
                'total': 总数（包括进行中）
            }
        """
        pass

    def _calculate_contract_cycle_statistics(self, project_code=None, person_name=None,
                                            year_filter=None, global_project=None):
        """
        计算采购合同周期统计（仅统计采购来源的合同）
        """
        pass
```

### 4.2 关键查询逻辑

#### 4.2.1 采购周期查询

```python
def _calculate_procurement_cycle_statistics(self, **filters):
    """计算采购周期统计"""
    queryset = Procurement.objects.filter(
        requirement_approval_date__isnull=False  # 必须有需求书审批完成日期
    ).select_related('project')
    
    # 应用筛选条件
    # ... (参照归档监控的筛选逻辑)
    
    # 已完成的采购（有结果公示日期）
    completed = queryset.filter(
        result_publicity_release_date__isnull=False
    ).annotate(
        cycle_days=ExpressionWrapper(
            F('result_publicity_release_date') - F('requirement_approval_date'),
            output_field=fields.DurationField()
        )
    )
    
    # 计算平均周期
    total_completed = completed.count()
    if total_completed == 0:
        return {'avg_cycle': 0, 'on_time_rate': 0, 'count': 0, 'total': 0}
    
    avg_cycle_timedelta = completed.aggregate(avg=Avg('cycle_days'))['avg']
    avg_cycle = avg_cycle_timedelta.days if avg_cycle_timedelta else 0
    
    # 计算及时率
    on_time_count = completed.filter(
        cycle_days__lte=timedelta(days=self.procurement_deadline)
    ).count()
    on_time_rate = round(on_time_count / total_completed * 100, 1)
    
    # 总数（包括进行中的）
    total_count = queryset.count()
    
    return {
        'avg_cycle': avg_cycle,
        'on_time_rate': on_time_rate,
        'count': total_completed,
        'total': total_count
    }
```

#### 4.2.2 采购合同周期查询

```python
def _calculate_contract_cycle_statistics(self, **filters):
    """计算采购合同周期统计"""
    # 查询采购合同（必须关联采购项目）
    queryset = Contract.objects.filter(
        contract_source=ContractSource.PROCUREMENT.value,  # 仅采购合同
        procurement__isnull=False,  # 必须关联采购
        procurement__result_publicity_release_date__isnull=False  # 采购必须有公示日期
    ).select_related('project', 'procurement')
    
    # 应用筛选条件
    # ... (参照归档监控的筛选逻辑)
    
    # 已签订的合同
    completed = queryset.filter(
        signing_date__isnull=False
    ).annotate(
        cycle_days=ExpressionWrapper(
            F('signing_date') - F('procurement__result_publicity_release_date'),
            output_field=fields.DurationField()
        )
    )
    
    # 计算平均周期和及时率（同采购周期）
    # ...
```

### 4.3 视图层实现

**新建视图函数**：`project/views_monitoring.py`

```python
def cycle_monitor(request):
    """工作周期监控页面"""
    from project.services.monitors.cycle_statistics import CycleStatisticsService
    
    # 1. 解析全局筛选参数
    global_filters = _resolve_global_filters(request)
    view_mode = request.GET.get('view_mode', 'project')
    target_code = request.GET.get('target_code', '')
    
    # 2. 获取概览数据
    stats_service = CycleStatisticsService()
    
    if view_mode == 'project':
        overview_data = stats_service.get_projects_cycle_overview(
            year_filter=global_filters['year_filter'],
            project_filter=global_filters['project']
        )
    else:
        overview_data = stats_service.get_persons_cycle_overview(
            year_filter=global_filters['year_filter'],
            project_filter=global_filters['project']
        )
    
    # 3. 如果有详情目标，获取详细数据
    detail_data = None
    if target_code:
        if view_mode == 'project':
            detail_data = stats_service.get_project_cycle_detail(
                project_code=target_code,
                year_filter=global_filters['year_filter']
            )
        else:
            detail_data = stats_service.get_person_cycle_detail(
                person_name=target_code,
                year_filter=global_filters['year_filter'],
                project_filter=global_filters['project']
            )
    
    # 4. 构建上下文
    context = {
        'page_title': '工作周期监控',
        'view_mode': view_mode,
        'target_code': target_code,
        'overview_data': overview_data,
        'detail_data': detail_data,
        'filter_config': filter_config,
        'cycle_rules': CYCLE_RULES,  # 传递规定周期配置
    }
    
    return render(request, 'monitoring/cycle.html', context)
```

### 4.4 模板层实现

**新建模板**：`project/templates/monitoring/cycle.html`

**参照归档监控模板结构**：
- 页面标题和视图切换
- 当前筛选状态
- KPI汇总卡片
- 数据列表表格
- 趋势图（使用ApexCharts，参照归档监控）
- 超期记录列表（可折叠）
- 详情模态框

### 4.5 URL配置

```python
# project/urls.py
urlpatterns = [
    # ...
    path('monitoring/cycle/', views_monitoring.cycle_monitor, name='cycle_monitor'),
]
```

---

## 五、数据模型说明

### 5.1 涉及的模型字段

#### Procurement模型
```python
关键字段：
- procurement_code: 采购编号（主键）
- project: 关联项目
- procurement_officer: 采购经办人
- requirement_approval_date: 需求书审批完成日期（周期起点）
- result_publicity_release_date: 结果公示发布日期（采购周期终点）
```

#### Contract模型
```python
关键字段：
- contract_code: 合同编号（主键）
- project: 关联项目
- contract_officer: 合同经办人
- contract_source: 合同来源（必须是'采购合同'）
- procurement: 关联采购（外键）
- signing_date: 合同签订日期（合同周期终点）
```

### 5.2 数据完整性要求

**采购周期计算必需字段**：
- ✅ `requirement_approval_date`（必填）
- ✅ `result_publicity_release_date`（完成后填写）

**采购合同周期计算必需字段**：
- ✅ `Contract.procurement`（必须关联采购）
- ✅ `Contract.contract_source = '采购合同'`
- ✅ `Procurement.result_publicity_release_date`（必填）
- ✅ `Contract.signing_date`（完成后填写）

**数据质量检查**：
- 需求书审批日期必须早于结果公示日期
- 结果公示日期必须早于合同签订日期
- 采购合同必须正确关联采购项目

---

## 六、实施计划

### 6.1 开发阶段划分

**总工期**: 8-10个工作日

#### 阶段1：服务层开发（3天）
- Day1：创建`CycleStatisticsService`类，实现基础统计逻辑
- Day2：实现概览数据查询方法（项目视图/个人视图）
- Day3：实现详情数据查询方法（趋势图、超期列表、进行中项目）

#### 阶段2：视图层开发（2天）
- Day4：创建`cycle_monitor()`视图函数，处理参数和数据获取
- Day5：集成全局筛选，处理视图切换逻辑

#### 阶段3：模板层开发（3天）
- Day6：创建基础模板结构（参照归档监控）
- Day7：实现趋势图和超期列表（使用ApexCharts）
- Day8：实现详情模态框和交互功能

#### 阶段4：测试与优化（2天）
- Day9：功能测试、数据准确性验证
- Day10：性能优化、用户体验优化、文档编写

### 6.2 优先级排序

| 优先级 | 功能 | 说明 |
|--------|------|------|
| **P0** | 双视图模式、概览统计 | 核心功能 |
| **P0** | 平均周期、及时率计算 | 核心指标 |
| **P0** | 超期记录列表 | 核心功能 |
| **P1** | 周期趋势图 | 增强分析能力 |
| **P1** | 详情模态框 | 深度数据展示 |
| **P2** | 进行中项目监控 | 预警功能 |
| **P2** | 规定周期配置界面 | 灵活配置 |

---

## 七、验收标准

### 7.1 功能验收

#### 基础功能
- [ ] **F1**: 项目视图正确展示所有项目的周期统计
- [ ] **F2**: 个人视图正确展示所有经办人的周期统计
- [ ] **F3**: 视图切换功能正常，数据正确更新
- [ ] **F4**: 全局筛选正确影响数据范围
- [ ] **F5**: KPI卡片数据准确

#### 详情功能
- [ ] **F6**: 点击"查看详情"弹出模态框
- [ ] **F7**: 详情模态框显示周期统计卡片
- [ ] **F8**: 周期趋势图正确展示
- [ ] **F9**: 超期记录列表按严重程度分组展示
- [ ] **F10**: 进行中项目列表正确显示

### 7.2 数据准确性验收

#### 周期计算
- [ ] **D1**: 采购周期计算准确（需求书审批→结果公示）
- [ ] **D2**: 采购合同周期计算准确（结果公示→合同签订）
- [ ] **D3**: 平均周期计算准确
- [ ] **D4**: 及时率计算准确
- [ ] **D5**: 超期天数计算准确

#### 数据一致性
- [ ] **D6**: KPI卡片与详细表格数据一致
- [ ] **D7**: 趋势图数据与统计数据一致
- [ ] **D8**: 超期列表与实际超期记录一致

### 7.3 性能验收

| 指标 | 目标值 | 测试条件 |
|------|--------|---------|
| 页面首次加载 | < 2秒 | 100个项目数据 |
| 视图切换响应 | < 1秒 | - |
| 详情模态框打开 | < 500ms | - |
| 趋势图渲染 | < 500ms | 12个月数据点 |

### 7.4 用户体验验收

- [ ] **U1**: 界面布局与归档监控保持一致风格
- [ ] **U2**: 进度条可视化直观易懂
- [ ] **U3**: 超期严重程度颜色区分明显
- [ ] **U4**: 交互流程流畅
- [ ] **U5**: 响应式设计良好

---

## 八、风险评估与应对

### 8.1 技术风险

#### 风险1：数据完整性问题
**描述**：历史数据可能缺少需求书审批日期  
**影响**：无法计算采购周期  
**应对措施**：
- 在统计时自动过滤掉无效数据
- 

---

## 采购方式维度补充（影响采购周期）

### 背景与目标
- 问题：当前采购周期统计未区分采购方式（如公开招标、邀请招标、竞争性谈判、询价、单一来源、框架协议/电商直采等），不同方式流程长度与审批环节差异较大，导致“平均值/达标率”无法正确反映真实执行情况。
- 目标：在“口径定义、统计展示、SLA阈值、筛选/钻取、数据接口”全面纳入采购方式维度，支持按方式分组对比与筛选，形成可解释、可行动的洞察。

### 口径与字段映射（不改变既有节点定义）
- 基本口径：采购周期 = 采购启动节点 → 采购定标/中标节点（沿用现版定义，不改动时间戳来源与去重逻辑）。
- 关键字段：procurement_method（标准化枚举），建议映射为：
  - 公开招标、邀请招标、竞争性谈判、询价、单一来源、框架协议/电商直采、集中/批量采购、其他。
  - 若来源系统存在多值/别名，需在ETL层做归一映射；未知/空值归为“未标注”。
- 缺失节点：仍按“缺失节点”归类，不纳入同比对比；可在分布图中以专色提示。

### 统计与可视化（新增按方式分解）
- 卡片区：新增“按采购方式”拆分的 平均/P50/P90/样本量/达标率（各方式显示一行，取Top N + 其他合并）。
- 分布图：
  - 直方图/频数分布支持“分面/分组”按采购方式对比；
  - 新增“箱线图/小提琴图”用于展示各方式周期分布差异与异常值；
  - 支持方式维度的“TopN耗时项目/事项”钻取。
- 趋势图：按月/周展示各方式P50/P90/达标率趋势，支持全量与指定方式对比。
- SLA展示：不同方式采用不同时限口径，显式标注：
  - 配置来源：project/services/monitors/config.py 中的 CYCLE_RULES['procurement'].deadline_map；
  - 图表中以参考线或阈值提示展示（例如达标/未达标配色）。

### 筛选与交互
- 新增筛选器：采购方式（多选，默认=全部），影响卡片、分布、趋势、明细列表。
- 交互联动：点击某方式可跳转/联动到明细列表，保留当前筛选条件与时间范围。

### 数据接口与后端调整（建议最小改动）
- 请求参数：
  - procurement_method: string | string[]（多选），为空表示全部；
  - group_by: 支持 procurement_method（用于卡片/分布/趋势的分组统计）。
- 返回结构：在既有返回中，新增按方式维度的汇总与分布字段，例如：
  - y_method: [{ method, count, avg_cycle, p50, p90, on_time_rate }]
  - histogram_by_method: [{ method, buckets: [...] }]
- 拟改动点：
  - project/services/monitors/cycle_statistics.py：
    - 在统计函数中增加对 procurement_method 的 ilter 与 nnotate/alues(...).annotate(...) 分组；
    - 读取 CYCLE_RULES['procurement'].deadline_map 计算各方式SLA达标；
  - project/views_monitoring.py：解析前端传入的 procurement_method 与 group_by，透传给 service；
  - project/templates/monitoring/cycle.html：新增“采购方式”筛选控件与图表分组切换（合计/按方式）。
- 兼容性：无筛选时等同“全部方式”；不破坏现有无维度统计接口。

### 指标与告警
- 新增指标：各采购方式的 P50/P90/平均/样本量/达标率；
- 告警策略：达标率低于阈值（方式级阈值）触发；阈值由 deadline_map 或新增 lert_threshold_map 配置提供。

### 数据质量与历史回填
- 保障 procurement_method 字段为标准枚举；对历史数据做一次归一化回填；
- 空值/未知：纳入“未标注”分组，独立展示其规模与达标情况，作为治理线索。

### MVP验收标准
- 页面存在“采购方式”筛选；至少一张图表支持按方式分组；
- 接口新增 y_method 字段并返回有效数据；
- 任意选择一种方式后，各卡片与图表联动更新；
- 指标核对：随机抽样对比明细与聚合指标，误差≤1%。

### 本次修订摘要（v1.1.1 / 2025-11-12）
- 新增：在周期监控中全面纳入“采购方式”维度；
- 图表：支持卡片/分布/趋势的按方式分组与对比；
- 数据：接口新增 procurement_method 筛选与分组统计返回；
- SLA：采用 deadline_map 按方式阈值核算达标率；
- 范围：仅做增量扩展，保持原有口径与接口兼容。
