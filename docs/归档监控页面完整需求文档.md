
# 归档监控页面完整需求文档

## 需求来源

根据用户需求：
> 对归档监控页面进行改造，全局筛选的前提下，选择单个项目时，展示该项目的平均归档周期（当前只有采购归档周期和合同归档周期），同时展示归档周期中，采购和合同的归档周期趋势图（全局筛选所有年度时按半年统计平均周期展示趋势、筛选某一年度时按月统计平均周期展示趋势）。另外展示该项目超出规定周期的项目情况，这个现有页面的列表已有这个功能。移除现有归档页面的筛选功能。除此之外，归档页面还要支持按照个人展示归档平均周期、归档周期趋势图，同样的，个人展示时也受到全局筛选的影响。个人要展示的是以每个经办人的数据，而不是以采购项目。项目则要展示以项目为单位的一些统计数据，目前没有实现这一点导致混乱。

## 核心概念澄清

### 项目视图
- **定义**：基于全局筛选（年度、项目）后，展示所有项目的归档统计数据
- **数据维度**：以项目为单位
- **全局项目筛选的作用**：
  - 如果选择了具体项目，则只展示该项目的数据
  - 如果选择"全部项目"，则展示所有项目的数据列表

### 个人视图
- **定义**：基于全局筛选（年度、项目）后，展示所有经办人的归档统计数据
- **数据维度**：以每个经办人为单位
- **全局项目筛选的作用**：
  - 如果选择了具体项目，则只展示在该项目中有业务的经办人
  - 如果选择"全部项目"，则展示所有经办人

## 完整功能列表

### 1. 视图模式切换
- 提供"项目视图"和"个人视图"两个切换按钮
- 切换时保留全局筛选状态（年度和项目）
- 切换后自动刷新页面数据

### 2. 全局筛选（适用于两种视图）
- **年度筛选**：
  - 全部年度（all）
  - 具体年份（2024、2023等）
- **项目筛选**（可选）：
  - 全部项目（显示所有）
  - 具体项目（仅显示该项目相关数据）

### 3. 项目视图功能

#### 3.1 汇总统计卡片
展示基于全局筛选后的汇总数据：
- 项目总数
- 采购总数（已归档/总数）
- 合同总数（已归档/总数）
- 综合归档率

#### 3.2 项目列表表格
展示每个项目的详细统计：

| 列名 | 说明 |
|------|------|
| 项目名称 | 项目编码 - 项目名称 |
| 采购数量 | 已归档/总数 |
| 采购平均周期 | X天（及时率Y%） |
| 合同数量 | 已归档/总数 |
| 合同平均周期 | X天（及时率Y%） |
| 综合归档率 | 进度条显示 |
| 操作 | 查看详情按钮 |

**排序**：按综合归档率降序

#### 3.3 项目归档周期趋势图
- **显示条件**：选择了具体项目（全局项目筛选不为空）
- **图表类型**：Chart.js 折线图
- **X轴**：
  - 全年度模式：2023-H1, 2023-H2, 2024-H1...
  - 单年度模式：1月, 2月, 3月...12月
- **Y轴**：平均归档周期（天）
- **数据系列**：
  - 采购归档周期（蓝色实线）
  - 合同归档周期（绿色实线）
  - 采购规定周期40天（蓝色虚线）
  - 合同规定周期30天（绿色虚线）
- **特性**：
  - 自动跳过无数据的时间点
  - 鼠标悬停显示详细数据
  - 响应式设计

#### 3.4 项目超期记录列表
- **显示条件**：选择了具体项目
- **内容**：该项目下超出规定归档周期的采购和合同记录
- **分组**：按严重程度（严重/中度/轻微/待归档）
- **字段**：
  - 业务类型（采购/合同）
  - 编号（合同时为合同序号）
  - 名称
  - 经办人
  - 业务日期
  - 归档截止日
  - 逾期天数
  - 操作链接
- **功能**：
  - 支持"显示所有记录"复选框（包括未逾期且已归档的）
  - 可折叠/展开

### 4. 个人视图功能

#### 4.1 汇总统计卡片
展示基于全局筛选后的汇总数据：
- 经办人总数
- 采购总数（已归档/总数）
- 合同总数（已归档/总数）
- 综合归档率

#### 4.2 经办人列表表格
展示每个经办人的详细统计：

| 列名 | 说明 |
|------|------|
| 经办人 | 姓名 |
| 采购数量 | 已归档/总数 |
| 采购平均周期 | X天（及时率Y%） |
| 合同数量 | 已归档/总数 |
| 合同平均周期 | X天（及时率Y%） |
| 综合归档率 | 进度条显示 |
| 负责项目数 | X个 |
| 操作 | 查看详情按钮 |

**排序**：按综合归档率降序或按业务量降序

#### 4.3 经办人归档周期趋势图
- **显示条件**：个人视图下始终显示（基于全局筛选后的所有经办人数据）
- **图表类型**：Chart.js 折线图
- **X轴**：
  - 全年度模式：2023-H1, 2023-H2, 2024-H1...
  - 单年度模式：1月, 2月, 3月...12月
- **Y轴**：平均归档周期（天）
- **数据系列**：
  - 所有经办人的采购归档周期平均值（蓝色实线）
  - 所有经办人的合同归档周期平均值（绿色实线）
  - 采购规定周期40天（蓝色虚线）
  - 合同规定周期30天（绿色虚线）
- **数据范围**：基于全局筛选（年度、项目）后，所有经办人的汇总数据
- **特性**：
  - 自动跳过无数据的时间点
  - 鼠标悬停显示详细数据
  - 响应式设计
- **备注**：如果点击了某个经办人的"查看详情"，可以在详情区域显示该经办人的独立趋势图

#### 4.4 经办人超期记录列表
- **显示条件**：个人视图下始终显示（基于全局筛选后的所有经办人数据）
- **内容**：所有经办人负责的超期记录汇总
- **分组**：按严重程度（严重/中度/轻微/待归档）
- **字段**：
  - 业务类型（采购/合同）
  - 编号
  - 名称
  - **经办人**（重要：显示经办人信息）
  - 所属项目
  - 业务日期
  - 归档截止日
  - 逾期天数
  - 操作链接
- **功能**：
  - 支持"显示所有记录"复选框（包括未逾期且已归档的）
  - 可折叠/展开
  - 可按经办人筛选（前端筛选或后端分页）
- **备注**：如果点击了某个经办人的"查看详情"，可以在详情区域只显示该经办人的超期记录

### 5. 详情查看模式（可选实现）

#### 5.1 项目详情
点击项目列表中的"查看详情"按钮后：
- 在当前页面下方展开详情区域（或弹出模态框）
- 显示该项目的趋势图和超期记录列表
- 提供"关闭详情"按钮

#### 5.2 经办人详情
点击经办人列表中的"查看详情"按钮后：
- 在当前页面下方展开详情区域（或弹出模态框）
- 显示该经办人的趋势图和超期记录列表
- 显示该经办人的项目分布情况
- 提供"关闭详情"按钮

## 页面布局设计

### 项目视图布局

```
┌────────────────────────────────────────────────────────┐
│ 页面标题: 归档监控                                    │
│ [项目视图] [个人视图]                                 │
│ 当前筛选: 2024年 · 全部项目                           │
├────────────────────────────────────────────────────────┤
│ 汇总统计卡片（4张）                                   │
│ ┌──────┬──────┬──────┬──────┐                        │
│ │项目数│采购  │合同  │归档率│                        │
│ └──────┴──────┴──────┴──────┘                        │
├────────────────────────────────────────────────────────┤
│ 项目列表表格                                           │
│ ┌────────────────────────────────────────────────┐   │
│ │项目│采购│采购周期│合同│合同周期│归档率│操作│   │
│ │A   │5/10│35天85%│8/10│28天90%│87%   │详情│   │
│ │B   │...│       │    │       │      │    │   │
│ └────────────────────────────────────────────────┘   │
├────────────────────────────────────────────────────────┤
│ 【当全局选择了具体项目时显示以下区域】               │
│                                                        │
│ 项目归档周期趋势图                                     │
│ ┌────────────────────────────────────────────────┐   │
│ │  Chart.js 折线图                               │   │
│ │  - 采购周期（蓝色）                            │   │
│ │  - 合同周期（绿色）                            │   │
│ │  - 基准线（虚线）                              │   │
│ └────────────────────────────────────────────────┘   │
│                                                        │
│ 项目超期记录列表（可折叠）                            │
│ ▼ 严重逾期（3条）                                     │
│ ▼ 中度逾期（5条）                                     │
│ ▶ 轻微逾期（2条）                                     │
│ □ 显示所有记录（包括已归档）                          │
└────────────────────────────────────────────────────────┘
```

### 个人视图布局

```
┌────────────────────────────────────────────────────────┐
│ 页面标题: 归档监控                                    │
│ [项目视图] [个人视图]                                 │
│ 当前筛选: 2024年 · 全部项目                           │
├────────────────────────────────────────────────────────┤
│ 汇总统计卡片（4张）                                   │
│ ┌──────┬──────┬──────┬──────┐                        │
│ │经办人│采购  │合同  │归档率│                        │
│ └──────┴──────┴──────┴──────┘                        │
├────────────────────────────────────────────────────────┤
│ 经办人列表表格                                         │
│ ┌────────────────────────────────────────────────┐   │
│ │姓名│采购│采购周期│合同│合同周期│归档率│项目│操作│ │
│ │张三│10/12│35天│8/10│28天│87%│3个│详情│           │
│ │李四│...│    │    │    │   │   │    │           │
│ └────────────────────────────────────────────────┘   │
├────────────────────────────────────────────────────────┤
│ 【个人视图下始终显示以下区域】                        │
│                                                        │
│ 所有经办人归档周期趋势图（汇总）                      │
│ ┌────────────────────────────────────────────────┐   │
│ │  Chart.js 折线图                               │   │
│ │  - 所有经办人采购平均周期（蓝色）              │   │
│ │  - 所有经办人合同平均周期（绿色）              │   │
│ │  - 基准线（虚线）                              │   │
│ └────────────────────────────────────────────────┘   │
│                                                        │
│ 所有经办人超期记录列表（可折叠）                      │
│ ▼ 严重逾期（12条）- 涉及多个经办人                   │
│ ▼ 中度逾期（8条）                                     │
│ ▶ 轻微逾期（5条）                                     │
│ □ 显示所有记录（包括已归档）                          │
├────────────────────────────────────────────────────────┤
│ 【可选：点击"查看详情"后展开某个经办人的详情区域】   │
│                                                        │
│ 经办人详情: 张三                             [关闭]   │
│ ┌────────────────────────────────────────────────┐   │
│ │ 张三的归档周期趋势图（独立）                   │   │
│ └────────────────────────────────────────────────┘   │
│                                                        │
│ 张三的超期记录列表（仅该经办人）                      │
│ ▼ 严重逾期（2条）                                     │
│ ▶ 中度逾期（1条）                                     │
└────────────────────────────────────────────────────────┘
```

## 数据计算逻辑

### 平均归档周期
```
采购归档周期 = 归档日期 - 结果公示发布日期
合同归档周期 = 归档日期 - 合同签订日期
平均周期 = SUM(周期) / COUNT(已归档记录)
```

### 及时归档率
```
采购及时率 = COUNT(周期≤40天) / COUNT(已归档) × 100%
合同及时率 = COUNT(周期≤30天) / COUNT(已归档) × 100%
```

### 综合归档率
```
综合归档率 = (采购已归档数 + 合同已归档数) / (采购总数 + 合同总数) × 100%
```

### 趋势图数据
- 按业务日期（公示日期/签订日期）分组
- 全年度模式：按半年分组计算平均周期
- 单年度模式：按月分组计算平均周期

## 技术实现方案

### 服务层实现

#### 1. ArchiveStatisticsService 扩展

**文件位置**：`project/services/monitors/archive_statistics.py`

**新增方法**：

```python
def get_projects_archive_overview(self, year_filter=None, project_filter=None):
    """
    获取项目维度的归档概览
    
    Args:
        year_filter: 年度筛选（'all' 或具体年份）
        project_filter: 项目筛选（具体项目编码或None）
    
    Returns:
        dict: {
            'summary': {汇总统计},
            'projects': [{项目列表}]
        }
    """
    # 实现逻辑见改进方案文档
    pass

def get_persons_archive_overview(self, year_filter=None, project_filter=None):
    """
    获取个人维度的归档概览
    
    Args:
        year_filter: 年度筛选
        project_filter: 项目筛选
    
    Returns:
        dict: {
            'summary': {汇总统计},
            'persons': [{经办人列表}]
        }
    """
    # 实现逻辑见改进方案文档
    pass

def get_project_trend_and_problems(self, project_code, year_filter=None):
    """
    获取单个项目的趋势图和超期记录
    
    Returns:
        dict: {
            'procurement_trend': [...],
            'contract_trend': [...],
            'problems': {...}
        }
    """
    pass

def get_all_persons_trend_and_problems(self, year_filter=None, project_filter=None):
    """
    获取所有经办人的汇总趋势图和超期记录（用于个人视图主页面）
    
    Args:
        year_filter: 年度筛选
        project_filter: 项目筛选
    
    Returns:
        dict: {
            'procurement_trend': [...],  # 所有经办人的采购平均周期
            'contract_trend': [...],     # 所有经办人的合同平均周期
            'problems': {...}            # 所有经办人的超期记录汇总
        }
    """
    pass

def get_person_trend_and_problems(self, person_name, year_filter=None, project_filter=None):
    """
    获取单个经办人的趋势图和超期记录（用于查看详情时）
    
    Returns:
        dict: {
            'procurement_trend': [...],
            'contract_trend': [...],
            'problems': {...}
        }
    """
    pass
```

### 视图层实现

**文件位置**：`project/views.py`

**archive_monitor() 函数逻辑**：

```python
def archive_monitor(request):
    """归档监控页面"""
    # 1. 解析全局筛选参数
    global_filters = _resolve_global_filters(request)
    view_mode = request.GET.get('view_mode', 'project')
    detail_target = request.GET.get('detail_target', '')  # 查看详情的目标
    
    # 2. 获取概览数据
    stats_service = ArchiveStatisticsService()
    
    if view_mode == 'project':
        overview_data = stats_service.get_projects_archive_overview(
            year_filter=global_filters['year_filter'],
            project_filter=global_filters['project']
        )
    else:
        overview_data = stats_service.get_persons_archive_overview(
            year_filter=global_filters['year_filter'],
            project_filter=global_filters['project']
        )
    
    # 3. 如果有详情目标，获取趋势和超期数据
    detail_data = None
    if detail_target:
        if view_mode == 'project':
            detail_data = stats_service.get_project_trend_and_problems(
                project_code=detail_target,
                year_filter=global_filters['year_filter']
            )
        else:
            detail_data = stats_service.get_person_trend_and_problems(
                person_name=detail_target,
                year_filter=global_filters['year_filter'],
                project_filter=global_filters['project']
            )
    
    # 4. 构建上下文
    context = {
        'page_title': '归档监控',
        'view_mode': view_mode,
        'overview_data': overview_data,
        'detail_data': detail_data,
        'detail_target': detail_target,
        'filter_config': filter_config,
    }
    
    return render(request, 'monitoring/archive.html', context)
```

### 模板层实现

**文件位置**：`project/templates/monitoring/archive.html`

**关键模板结构**：

```html
{% extends "base.html" %}

{% block content %}
<!-- 1. 页面标题和视图切换 -->
<div class="d-flex justify-content-between mb-4">
    <h2>归档监控</h2>
    <div class="btn-group">
        <button class="btn btn-{% if view_mode == 'project' %}primary{% else %}outline-primary{% endif %}"
                onclick="switchView('project')">项目视图</button>
        <button class="btn btn-{% if view_mode == 'person' %}primary{% else %}outline-primary{% endif %}"
                onclick="switchView('person')">个人视图</button>
    </div>
</div>

<!-- 2. 当前筛选状态 -->
<div class="alert alert-info">
    当前筛选：{{ filter_config.display_year }} ·
    {% if global_project %}{{ global_project }}{% else %}全部项目{% endif %}
</div>

<!-- 3. 汇总统计卡片 -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5>{% if view_mode == 'project' %}项目总数{% else %}经办人数{% endif %}</h5>
                <h2>{{ overview_data.summary.project_count|default:overview_data.summary.person_count }}</h2>
            </div>
        </div>
    </div>
    <!-- 其他统计卡片 -->
</div>

<!-- 4. 数据列表表格 -->
<div class="card mb-4">
    <div class="card-header">
        <h5>{% if view_mode == 'project' %}项目归档统计明细{% else %}经办人归档统计明细{% endif %}</h5>
    </div>
    <div class="card-body p-0">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>{% if view_mode == 'project' %}项目名称{% else %}经办人{% endif %}</th>
                    <th>采购数量</th>
                    <th>采购周期</th>
                    <th>合同数量</th>
                    <th>合同周期</th>
                    <th>综合归档率</th>
                    {% if view_mode == 'person' %}<th>负责项目</th>{% endif %}
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% if view_mode == 'project' %}
                    {% for project in overview_data.projects %}
                    <tr>
                        <td>{{ project.project_name }}</td>
                        <td>{{ project.procurement_archived }}/{{ project.procurement_count }}</td>
                        <td>{{ project.procurement_avg_cycle }}天 ({{ project.procurement_on_time_rate }}%)</td>
                        <td>{{ project.contract_archived }}/{{ project.contract_count }}</td>
                        <td>{{ project.contract_avg_cycle }}天 ({{ project.contract_on_time_rate }}%)</td>
                        <td>
                            <div class="progress">
                                <div class="progress-bar" style="width: {{ project.overall_archive_rate }}%">
                                    {{ project.overall_archive_rate }}%
                                </div>
                            </div>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary"
                                    onclick="viewDetail('{{ project.project_code }}')">查看详情</button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    {% for person in overview_data.persons %}
                    <tr>
                        <!-- 类似结构 -->
                    </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- 5. 详情区域（当detail_data存在时显示） -->
{% if detail_data %}
<div class="card mb-4" id="detailSection">
    <div class="card-header d-flex justify-content-between">
        <h5>
            {% if view_mode == 'project' %}项目详情{% else %}经办人详情{% endif %}
            - {{ detail_target }}
        </h5>
        <button class="btn btn-sm btn-secondary" onclick="closeDetail()">关闭</button>
    </div>
    <div class="card-body">
        <!-- 5.1 趋势图 -->
        <h6>归档周期趋势</h6>
        <div style="height: 400px;">
            <canvas id="trendChart"></canvas>
        </div>
        
        <!-- 5.2 超期记录列表 -->
        <h6 class="mt-4">超期记录</h6>
        {% for severity, problems in detail_data.problems.items %}
            {% if problems %}
            <div class="card mb-2">
                <div class="card-header" data-bs-toggle="collapse" data-bs-target="#{{ severity }}">
                    {{ severity|upper }} ({{ problems|length }}条)
                </div>
                <div id="{{ severity }}" class="collapse">
                    <div class="card-body p-0">
                        <table class="table table-sm mb-0">
                            <!-- 超期记录表格 -->
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        {% endfor %}
    </div>
</div>
{% endif %}

<script>
function switchView(mode) {
    const url = new URL(window.location.href);
    url.searchParams.set('view_mode', mode);
    url.searchParams.delete('detail_target');  // 切换视图时清除详情
    window.location.href = url.toString();
}

function viewDetail(target) {
    const url = new URL(window.location.href);
    url.searchParams.set('detail_target', target);
    window.location.href = url.toString();
}

function closeDetail() {
    const url = new URL(window.location.href);
    url.searchParams.delete('detail_target');
    window.location.href = url.toString();
}

// 渲染趋势图
{% if detail_data %}
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('trendChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ detail_data.procurement_trend|map(attribute='period')|list|tojson }},
            datasets: [
                {
                    label: '采购归档周期',
                    data: {{ detail_data.procurement_trend|map(attribute='avg_cycle')|list|tojson }},
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                },
                {
                    label: '合同归档周期',
                    data: {{ detail_data.contract_trend|map(attribute='avg_cycle')|list|tojson }},
                    borderColor: '#198754',
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            spanGaps: true,
            // ... 其他配置
        }
    });
});
{% endif %}
</script>
{% endblock %}
```

### 前端JavaScript实现

**文件位置**：`project/static/js/archive-statistics.js`

简化为URL参数控制，不需要复杂的前端状态管理。

## 实施步骤

### 阶段1：服务层开发（2-3天）
1. 扩展 `ArchiveStatisticsService` 类
2. 实现 `get_projects_archive_overview()` 方法
3. 实现 `get_persons_archive_overview()` 方法
4. 实现趋势和超期数据获取方法
5. 编写单元测试

### 阶段2：视图层开发（1-2天）
1. 修改 `archive_monitor()` 视图函数
2. 处理详情目标参数
3. 集成服务层方法
4. 处理异常情况

### 阶段3：模板层开发（2-3天）
1. 重构 `archive.html` 模板
2. 实现汇总统计卡片
3. 实现数据列表表格
4. 实现详情区域（趋势图+超期列表）
5. 实现交互功能（查看详情、关闭详情）

### 阶段4：测试与优化（1-2天）
1. 功能测试
2. 数据准确性验证
3. 性能优化
4. 浏览器兼容性测试
5. 用户体验优化

## 验收标准

### 功能验收
- [ ] 项目视图正确展示所有项目的统计列表
- [ ] 个人视图正确展示所有经办人的统计列表
- [ ] 全局筛选（年度、项目）正确影响数据范围
- [ ] 点击"查看详情"正确展开趋势图和超期列表
- [ ] 趋势图数据准确，全年度按半年、单年度按月分组
- [ ] 超期列表按严重程度正确分组
- [ ] 视图切换功能正常
- [ ] 所有统计数据计算准确

### 性能验收
- [ ] 页面首次加载时间 < 2秒
- [ ] 查看详情响应时间 < 1秒
- [ ] 大数据量（100+项目）下表格渲染流畅
- [ ] 趋势图渲染时间 < 500ms

### 用户体验验收
- [ ] 界面布局清晰，信息层次分明
- [ ] 交互流程顺畅，无需多次点击
- [ ] 响应式设计良好，适配不同屏幕
- [ ] 数据展示直观，易于理解

## 相关文档

- [归档监控页面改造说明](./归档监控页面改造说明.md) - 已实现功能的技术文档
- [归档监控页面改进方案-修正版](./归档监控页面改进方案-修正版.md) - 基于正确理解的改进方案

## 更新记录

| 日期 | 版本 | 更新内容 | 更新人 |
|------|------|----------|--------|
| 2025-11-10 | 1.0 | 创建完整需求文档，包含项目视图和个人视图的完整功能规格 | Documentation Writer |
| 2025-11-10 | 1.1 | 修正个人视图：趋势图和超期记录在个人视图下始终显示所有经办人的汇总数据 | Documentation Writer |