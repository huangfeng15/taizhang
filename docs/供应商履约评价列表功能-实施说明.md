# 供应商履约评价列表功能 - 实施说明

## 一、功能概述

本次实施完成了供应商履约评价系统的两级展示结构改造，优化了数据展示逻辑，提升了用户体验。

### 核心特性

1. **主列表页面**：展示每个供应商在指定年度的最新履约评价
2. **详情页面**：展示供应商历史上所有合同的完整评价记录
3. **年度筛选**：支持切换不同年度查看评价数据
4. **趋势分析**：可视化展示供应商评分趋势

## 二、实施内容

### 2.1 数据服务层改进

**文件**：`supplier_eval/services.py`

#### 新增方法 1：`get_latest_evaluations_by_year(year=None)`

```python
功能：获取每个供应商在指定年度的最新履约评价
参数：
  - year (int, optional): 年度，默认为当前年度
返回：
  - list: 供应商最新评价列表，包含：
    * supplier_name: 供应商名称
    * evaluation: 最新评价对象
    * contract_name: 关联合同名称
    * comprehensive_score: 综合评分
    * last_evaluation_score: 末次评价得分
    * evaluation_type: 评价类型
    * evaluation_result: 综合评价结果
```

**实现逻辑**：
- 查询指定年度的所有评价记录
- 按供应商分组，获取每个供应商的最新评价（基于创建时间）
- 按综合评分降序排序

#### 新增方法 2：`get_supplier_all_evaluations(supplier_name)`

```python
功能：获取供应商的所有历史评价记录（跨年度）
参数：
  - supplier_name (str): 供应商名称
返回：
  - list: 历史评价记录列表，按时间倒序，包含：
    * evaluation: 评价对象
    * contract: 关联合同对象
    * year: 评价年度
    * comprehensive_score: 综合评分
    * evaluation_result: 评价结果
```

### 2.2 视图层改造

**文件**：`supplier_eval/views.py`

#### 改进视图 1：`supplier_evaluation_list(request)`

**主要变化**：
- 从显示所有评价记录改为显示指定年度的最新评价
- 新增年度筛选参数支持
- 调用 `SupplierAnalysisService.get_latest_evaluations_by_year()` 获取数据
- 统计数据基于当前选择的年度

**关键代码片段**：
```python
# 确定显示年度（默认当前年度）
display_year = int(year_filter) if year_filter else current_year

# 获取指定年度每个供应商的最新评价
latest_evaluations = SupplierAnalysisService.get_latest_evaluations_by_year(display_year)

# 获取可选年度列表
available_years = SupplierEvaluation.objects.dates('created_at', 'year', order='DESC')
year_choices = [year.year for year in available_years]
```

#### 新增视图 2：`supplier_evaluation_detail(request, supplier_name)`

**功能说明**：
- 展示指定供应商的所有历史评价记录
- 提供评价趋势图表
- 显示供应商基本汇总信息

**关键实现**：
```python
# 获取所有历史评价记录
all_evaluations = SupplierAnalysisService.get_supplier_all_evaluations(supplier_name)

# 计算趋势数据
trend_data = defaultdict(list)
for item in all_evaluations:
    if item['comprehensive_score']:
        trend_data[item['year']].append(float(item['comprehensive_score']))

# 转换为JSON供图表使用
trend_chart_json = json.dumps(trend_chart_data)
```

### 2.3 URL路由配置

**文件**：`supplier_eval/urls.py`

```python
urlpatterns = [
    # 供应商履约评价
    path('evaluations/', views.supplier_evaluation_list, name='supplier_evaluation_list'),
    path('evaluations/detail/<str:supplier_name>/', views.supplier_evaluation_detail, name='supplier_evaluation_detail'),  # 新增
    path('evaluations/create/', views.supplier_evaluation_create, name='supplier_evaluation_create'),
    path('evaluations/<str:evaluation_code>/edit/', views.supplier_evaluation_edit, name='supplier_evaluation_edit'),
    # ...
]
```

### 2.4 模板文件改造

#### 主列表模板：`supplier_eval/templates/supplier/evaluation_list.html`

**主要改动**：

1. **筛选栏增强**：
```html
<!-- 新增年度选择器 -->
<select name="year" class="filter-select" onchange="this.form.submit()">
    {% for year in year_choices %}
    <option value="{{ year }}" {% if year == display_year %}selected{% endif %}>
        {{ year }}年度
    </option>
    {% endfor %}
</select>
```

2. **表头调整**：
```html
<thead>
    <tr>
        <th>序号</th>
        <th>供应商名称</th>
        <th>评价合同名称</th>
        <th>当前评价得分</th>
        <th>评价类别</th>
        <th>综合评价结果</th>
        <th>操作</th>
    </tr>
</thead>
```

3. **操作按钮优化**：
```html
<a href="{% url 'supplier_eval:supplier_evaluation_detail' item.supplier_name %}"
   class="btn btn-primary">
    <i class="fas fa-info-circle"></i>
    详情
</a>
```

#### 新增详情模板：`supplier_eval/templates/supplier/evaluation_detail.html`

**核心组件**：

1. **供应商概况卡片**：
   - 承接合同总数
   - 平均评分
   - 评价记录总数
   - 合同总金额

2. **评分趋势图表**：
```javascript
new Chart(ctx, {
    type: 'line',
    data: {
        labels: trendData.map(item => item.year + '年'),
        datasets: [{
            label: '平均评分',
            data: trendData.map(item => item.avg_score),
            borderColor: 'rgb(24, 144, 255)',
            backgroundColor: 'rgba(24, 144, 255, 0.1)',
            tension: 0.3,
            fill: true
        }]
    },
    options: {
        scales: {
            y: {
                beginAtZero: false,
                min: 60,
                max: 100
            }
        }
    }
});
```

3. **历史评价记录表格**：
   - 支持分页
   - 显示评价年度、合同、评分、结果等完整信息

## 三、数据流程

### 3.1 主列表页面数据流

```
用户访问 /supplier/evaluations/?year=2024
    ↓
supplier_evaluation_list() 视图
    ↓
SupplierAnalysisService.get_latest_evaluations_by_year(2024)
    ↓
查询2024年度所有评价 → 按供应商分组 → 取最新记录
    ↓
返回每个供应商的最新评价数据
    ↓
渲染 evaluation_list.html 模板
    ↓
展示2024年度各供应商最新评价
```

### 3.2 详情页面数据流

```
用户点击"详情"按钮
    ↓
跳转到 /supplier/evaluations/detail/某供应商/
    ↓
supplier_evaluation_detail() 视图
    ↓
SupplierAnalysisService.get_supplier_all_evaluations("某供应商")
    ↓
查询该供应商所有历史评价记录（跨年度）
    ↓
计算趋势数据 + 获取汇总信息
    ↓
渲染 evaluation_detail.html 模板
    ↓
展示完整历史评价记录 + 趋势图表
```

## 四、功能特点

### 4.1 信息简洁性

**主列表页面**：
- ✅ 仅显示单一年度数据
- ✅ 每个供应商仅显示最新评价
- ✅ 避免因多年度数据造成的信息冗余
- ✅ 页面加载速度快

### 4.2 信息完整性

**详情页面**：
- ✅ 展示供应商所有历史评价
- ✅ 跨年度数据完整呈现
- ✅ 提供趋势分析可视化
- ✅ 支持深入查看

### 4.3 用户体验优化

1. **年度切换灵活**：
   - 下拉选择器快速切换年度
   - 自动提取系统中存在的年度数据

2. **导航清晰**：
   - 主列表 → 详情页面的层级关系明确
   - 面包屑导航便于返回

3. **数据可视化**：
   - Chart.js 图表展示评分趋势
   - 直观了解供应商表现变化

4. **评分标识明确**：
   - 颜色编码区分评分等级
   - 徽章样式突出显示

## 五、使用说明

### 5.1 主列表页面操作

1. **查看指定年度评价**：
   - 点击年度下拉框选择年份
   - 系统自动刷新显示该年度数据

2. **搜索供应商**：
   - 在搜索框输入供应商名称
   - 支持模糊匹配

3. **筛选评分等级**：
   - 选择评分等级过滤器
   - 可选：优秀/良好/合格/不合格

4. **查看详情**：
   - 点击"详情"按钮进入详情页面
   - 查看该供应商的完整历史记录

### 5.2 详情页面操作

1. **浏览历史评价**：
   - 表格展示所有历史评价记录
   - 支持分页查看

2. **查看趋势图**：
   - 折线图展示评分变化趋势
   - 悬停显示详细数据

3. **返回列表**：
   - 点击"返回列表"按钮
   - 或使用面包屑导航

## 六、技术要点

### 6.1 数据查询优化

```python
# 使用 select_related 减少数据库查询
evaluations = SupplierEvaluation.objects.filter(
    created_at__year=year
).select_related('contract')

# 使用 dates() 高效获取年度列表
available_years = SupplierEvaluation.objects.dates('created_at', 'year', order='DESC')
```

### 6.2 JSON序列化

```python
# 视图中将Python对象转换为JSON
import json
trend_chart_json = json.dumps(trend_chart_data)

# 模板中安全渲染
const trendData = {{ trend_chart_json|safe }};
```

### 6.3 分页处理

```python
from django.core.paginator import Paginator

# 列表数据分页
paginator = Paginator(latest_evaluations, page_size)
page_obj = paginator.get_page(page)
```

## 七、测试检查清单

### 7.1 主列表页面测试

- [ ] 默认显示当前年度数据
- [ ] 切换年度后数据正确更新
- [ ] 搜索功能正常工作
- [ ] 评分筛选功能正常
- [ ] 分页功能正常
- [ ] 每个供应商仅显示一条最新记录
- [ ] 统计卡片数据准确

### 7.2 详情页面测试

- [ ] 从主列表点击"详情"正确跳转
- [ ] 显示该供应商所有历史评价
- [ ] 趋势图正确渲染
- [ ] 汇总信息准确
- [ ] 分页功能正常
- [ ] 返回按钮正常工作
- [ ] 面包屑导航正确

### 7.3 边界情况测试

- [ ] 无评价数据时正确显示空状态
- [ ] 仅有单条评价时正常显示
- [ ] 跨多个年度的数据正确处理
- [ ] URL中供应商名称包含特殊字符时正常工作
- [ ] 不存在的年度参数时回退到当前年度

## 八、后续优化建议

1. **性能优化**：
   - 考虑为大数据量场景添加缓存
   - 评价记录超过1000条时可考虑异步加载

2. **功能增强**：
   - 添加评价记录导出功能
   - 支持批量对比多个供应商
   - 添加评价提醒功能

3. 