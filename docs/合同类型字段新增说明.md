# 合同类型字段新增技术说明

## 需求概述

在合同导入功能中新增两个验证规则：
1. **文件定位验证**: 关联主合同时，文件定位列必填
2. **合同类型自动填充**: 支持从采购类别或主合同自动继承合同类型

## 实现方案

### 1. 数据模型变更

**文件**: `contract/models.py`

新增字段：
```python
contract_type = models.CharField(
    '合同类型',
    max_length=100,
    blank=True,
    choices=get_enum_choices(ProcurementCategory),
    help_text='合同类别(工程/货物/服务等)，可从关联采购或主合同自动继承'
)
```

**可选值**: 工程、工程货物、工程服务、货物、服务

### 2. 数据库迁移

**文件**: `contract/migrations/0011_add_contract_type.py`

- 添加`contract_type`字段到Contract表
- 字段允许为空，支持历史数据兼容

### 3. 导入逻辑增强

**文件**: `procurement/management/commands/import_excel.py`

#### 验证规则1: 文件定位验证（第1218行附近）
```python
if parent_contract_sequence:
    if not file_positioning or file_positioning == '':
        raise ValueError('关联了主合同时，文件定位列为必填项。')
    
    if file_positioning not in [FilePositioning.SUPPLEMENT.value, FilePositioning.TERMINATION.value]:
        raise ValueError('关联主合同时，文件定位只能是"补充协议"或"解除协议"。')
```

#### 验证规则2: 合同类型自动填充（第1283行附近）
```python
contract_type = row.get('合同类型', '').strip()

if not contract_type:
    # 优先级1: 从采购获取
    if procurement and procurement.procurement_category:
        contract_type = procurement.procurement_category
    # 优先级2: 从主合同继承
    elif parent_contract and parent_contract.contract_type:
        contract_type = parent_contract.contract_type
    # 优先级3: 必填提示
    else:
        raise ValueError('合同类型列为必填项。请直接填写或关联采购/主合同。')
```

### 4. 导入模板配置

**文件**: `project/import_templates/contract.yml`

新增字段配置：
```yaml
- name: "合同类型"
  field: "contract_type"
  required: false
  data_type: "choice"
  choices_from_model: true
  help_text: "合同类别(工程/货物/服务等)，可从关联采购或主合同自动继承"
```

## 自动填充优先级

```
用户填写值 > 关联采购的采购类别 > 主合同的合同类型 > 必填提示
```

## 使用示例

### 场景1: 关联采购（自动填充）
```csv
合同编号,合同名称,关联采购编号,合同类型
HT2025001,XXX合同,GC2024001,
```
✅ 系统自动从采购GC2024001获取采购类别填充

### 场景2: 补充协议（继承主合同）
```csv
合同编号,关联主合同编号,文件定位,合同类型
HT2025001-BC01,HT2025001,补充协议,
```
✅ 文件定位必填
✅ 合同类型从主合同HT2025001继承

### 场景3: 直接签订（手动填写）
```csv
合同编号,合同名称,合同类型
HT2025002,XXX服务合同,服务
```
✅ 手动填写合同类型

## 部署步骤

1. **应用数据库迁移**
```bash
python manage.py migrate contract
```

2. **重启应用服务**
```bash
# 重启Django应用
```

3. **验证功能**
- 导入包含关联主合同的数据，验证文件定位必填
- 导入不含合同类型的数据，验证自动填充逻辑

## 兼容性说明

- ✅ 向后兼容：现有合同数据不受影响（字段允许为空）
- ✅ 导入兼容：支持逐步完善合同类型数据
- ✅ API兼容：不影响现有查询和展示逻辑

## 相关文档

- [合同导入验证规则说明](./合同导入验证规则说明.md) - 详细的业务规则和使用指南
