# 工作周期监控页面 V2.0 - 部署与测试指南

## 一、快速部署步骤

### 1.1 集成路由配置

在 `config/urls.py` 主路由文件中添加V2路由：

```python
# config/urls.py
from django.urls import path, include

urlpatterns = [
    # ... 现有路由 ...
    
    # 工作周期监控V2（新增）
    path('', include('config.urls_cycle_v2')),
]
```

### 1.2 验证文件完整性

确认以下文件已创建：

```bash
# 检查服务层
ls project/services/monitors/cycle_statistics_v2.py

# 检查视图层
ls project/views_monitoring_cycle_v2.py

# 检查模板
ls project/templates/monitoring/cycle_v2_new.html

# 检查路由
ls config/urls_cycle_v2.py
```

### 1.3 安装可选依赖

如果需要Excel导出功能：

```bash
pip install openpyxl
```

### 1.4 重启服务

```bash
# Windows
restart_server.bat

# Linux/Mac
python manage.py runserver
```

### 1.5 访问测试

- **V2新版本**: http://localhost:8000/monitoring/cycle/v2/
- **V1旧版本**: http://localhost:8000/monitoring/cycle/ （保持不变）

---

## 二、功能测试清单

### 2.1 基础功能测试

#### ✅ 页面加载测试
- [ ] 访问 `/monitoring/cycle/v2/` 页面正常加载
- [ ] 总览统计卡片正确显示
- [ ] 数据时间标识显示在右上角
- [ ] 筛选区域正常显示

#### ✅ 总览统计测试
- [ ] 采购周期平均值、P50、P90正确显示
- [ ] 采购超期率和超期数量正确计算
- [ ] 合同周期平均值、P50、P90正确显示
- [ ] 合同超期率和超期数量正确计算
- [ ] 数据质量指标（缺失端点、异常项目）正确显示

#### ✅ 筛选功能测试
- [ ] 时间维度切换（需求审批/公示/合同签订）生效
- [ ] 采购方式多选筛选生效
- [ ] "按采购方式分组"勾选后显示分组表格
- [ ] "仅显示超期项目"勾选后明细表正确过滤
- [ ] 应用筛选按钮正常工作

#### ✅ 趋势图测试
- [ ] 趋势图正常渲染（使用ApexCharts）
- [ ] 采购周期趋势线显示（蓝色）
- [ ] 合同周期趋势线显示（绿色）
- [ ] 鼠标悬停显示详细数据
- [ ] 单年度按月显示，全年度按半年显示

#### ✅ 维度拆解测试
- [ ] 勾选"按采购方式分组"后显示拆解表格
- [ ] 表格显示：采购方式、样本量、平均天数、P50、P90、达标率、SLA阈值
- [ ] 达标率颜色标识正确（绿/黄/红）

#### ✅ 明细表测试
- [ ] 明细表正确显示所有记录
- [ ] 字段完整：项目名称、时间节点、周期天数、采购方式、经办人、状态
- [ ] 超期标识正确显示（红色"超期"徽章）
- [ ] 状态标识正确（正常/缺失端点）
- [ ] 表格可滚动查看

#### ✅ 导出功能测试
- [ ] CSV导出按钮正常工作
- [ ] Excel导出按钮正常工作（需要openpyxl）
- [ ] 导出文件包含完整字段
- [ ] 导出文件编码正确（UTF-8-BOM）

### 2.2 数据准确性测试

#### 采购周期计算验证

**测试用例1：正常采购项目**
```
项目：TEST-001
需求审批完成：2024-01-10
结果公示完成：2024-02-20
采购方式：公开招标
预期周期：41天
预期SLA：45天
预期状态：正常
```

**测试用例2：超期采购项目**
```
项目：TEST-002
需求审批完成：2024-01-10
结果公示完成：2024-03-10
采购方式：直接采购
预期周期：60天
预期SLA：15天
预期状态：超期（超期45天）
```

**测试用例3：缺失端点**
```
项目：TEST-003
需求审批完成：2024-01-10
结果公示完成：NULL
预期：不纳入统计，计入"缺失端点"
```

#### 合同周期计算验证

**测试用例4：正常合同**
```
项目：TEST-001
结果公示完成：2024-02-20
合同签订：2024-03-05
预期周期：14天
预期SLA：15天
预期状态：正常
```

**测试用例5：超期合同**
```
项目：TEST-002
结果公示完成：2024-02-20
合同签订：2024-04-10
预期周期：50天
预期SLA：15天
预期状态：超期（超期35天）
```

### 2.3 边界条件测试

- [ ] 无数据时显示友好提示
- [ ] 筛选后无结果时显示提示信息
- [ ] 年度筛选为"全部"时按半年分组
- [ ] 单个年度时按月分组
- [ ] 采购方式为空时显示"未标注"
- [ ] 日期为NULL时显示"-"

### 2.4 性能测试

- [ ] 100条记录加载时间 < 2秒
- [ ] 1000条记录加载时间 < 5秒
- [ ] 趋势图渲染时间 < 1秒
- [ ] 导出1000条记录 < 10秒

---

## 三、常见问题排查

### 3.1 页面无法访问

**问题**: 访问 `/monitoring/cycle/v2/` 返回404

**解决方案**:
1. 检查 `config/urls.py` 是否正确引入 `urls_cycle_v2`
2. 检查 `config/urls_cycle_v2.py` 文件是否存在
3. 重启Django服务

### 3.2 数据不显示

**问题**: 页面加载但统计数据为0

**解决方案**:
1. 检查数据库中是否有数据：
```sql
-- 检查采购数据
SELECT COUNT(*) FROM procurement_procurement 
WHERE requirement_approval_date IS NOT NULL 
  AND result_publicity_release_date IS NOT NULL;

-- 检查合同数据
SELECT COUNT(*) FROM contract_contract 
WHERE contract_source = '采购合同' 
  AND signing_date IS NOT NULL;
```

2. 检查字段名称是否匹配模型定义
3. 检查筛选条件是否过于严格

### 3.3 趋势图不显示

**问题**: 趋势图区域显示"暂无趋势数据"

**解决方案**:
1. 检查浏览器控制台是否有JavaScript错误
2. 确认ApexCharts库已正确加载
3. 检查 `trend_data_json` 是否有数据
4. 查看浏览器网络请求是否成功

### 3.4 导出功能报错

**问题**: 点击导出按钮报错

**解决方案**:
1. CSV导出：检查数据编码问题
2. Excel导出：确认已安装 `openpyxl`
```bash
pip install openpyxl
```
3. 检查文件权限

### 3.5 超期判断不准确

**问题**: 超期标识与实际不符

**解决方案**:
1. 检查 `config.py` 中的SLA配置：
```python
CYCLE_RULES = {
    'procurement': {
        'deadline_map': {
            '直接采购': 15,
            '公开招标': 45,
            # ... 其他方式
        },
        'default_deadline': 45
    },
    'contract': {
        'deadline_days': 15
    }
}
```

2. 验证采购方式字段值与配置一致
3. 检查日期计算逻辑

---

## 四、数据验证SQL

### 4.1 采购周期验证

```sql
-- 验证采购周期计算
SELECT 
    procurement_code,
    project_name,
    requirement_approval_date,
    result_publicity_release_date,
    DATEDIFF(day, requirement_approval_date, result_publicity_release_date) AS cycle_days,
    procurement_method
FROM procurement_procurement
WHERE requirement_approval_date IS NOT NULL
  AND result_publicity_release_date IS NOT NULL
ORDER BY cycle_days DESC
LIMIT 10;
```

### 4.2 合同周期验证

```sql
-- 验证合同周期计算
SELECT 
    c.contract_code,
    c.contract_name,
    p.result_publicity_release_date,
    c.signing_date,
    DATEDIFF(day, p.result_publicity_release_date, c.signing_date) AS cycle_days
FROM contract_contract c
INNER JOIN procurement_procurement p ON c.procurement_id = p.procurement_code
WHERE c.contract_source = '采购合同'
  AND p.result_publicity_release_date IS NOT NULL
  AND c.signing_date IS NOT NULL
ORDER BY cycle_days DESC
LIMIT 10;
```

### 4.3 数据质量检查

```sql
-- 检查缺失端点
SELECT 
    COUNT(*) AS missing_count
FROM procurement_procurement
WHERE requirement_approval_date IS NOT NULL
  AND result_publicity_release_date IS NULL;

-- 检查采购方式分布
SELECT 
    procurement_method,
    COUNT(*) AS count
FROM procurement_procurement
WHERE requirement_approval_date IS NOT NULL
  AND result_publicity_release_date IS NOT NULL
GROUP BY procurement_method
ORDER BY count DESC;
```

---

## 五、性能优化建议

### 5.1 数据库索引

确保以下字段有索引：

```sql
-- 采购表索引
CREATE INDEX idx_proc_approval_date ON procurement_procurement(requirement_approval_date);
CREATE INDEX idx_proc_publicity_date ON procurement_procurement(result_publicity_release_date);
CREATE INDEX idx_proc_method ON procurement_procurement(procurement_method);
CREATE INDEX idx_proc_officer ON procurement_procurement(procurement_officer);

-- 合同表索引
CREATE INDEX idx_cont_signing_date ON contract_contract(signing_date);
CREATE INDEX idx_cont_source ON contract_contract(contract_source);
CREATE INDEX idx_cont_procurement ON contract_contract(procurement_id);
```

### 5.2 查询优化

- 使用 `select_related()` 预加载关联对象
- 避免N+1查询问题
- 合理使用 `only()` 和 `defer()` 限制字段

### 5.3 缓存策略

对于不常变化的数据可以考虑缓存：

```python
from django.core.cache import cache

# 缓存总览统计（5分钟）
cache_key = f'cycle_overview_{year}_{project}'
overview_stats = cache.get(cache_key)
if not overview_stats:
    overview_stats = service.get_overview_statistics(...)
    cache.set(cache_key, overview_stats, 300)
```

---

## 六、后续优化方向

### 6.1 功能增强
- [ ] 添加更多维度拆解（部门、金额区间、供应商等）
- [ ] 实现告警推送功能（邮件/IM）
- [ ] 添加周报/月报自动生成
- [ ] 支持自定义SLA阈值配置界面

### 6.2 性能优化
- [ ] 实现数据预聚合（T+1批处理）
- [ ] 添加Redis缓存层
- [ ] 优化大数据量查询

### 6.3 用户体验
- [ ] 添加数据钻取功能（点击卡片查看明细）
- [ ] 实现筛选条件保存
- [ ] 添加对比分析功能（同比/环比）
- [ ] 移动端适配优化

---

## 七、联系与支持

如遇到问题，请：

1. 查看本文档的"常见问题排查"章节
2. 检查Django日志文件
3. 查看浏览器控制台错误信息
4. 联系技术支持团队

---

**文档版本**: V1.0  
**最后更新**: 2025-01-12  
**维护人员**: 开发团队