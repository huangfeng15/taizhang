# 合同导入验证规则说明

## 概述

本文档说明合同导入时的两个关键验证规则，用于确保数据完整性和业务逻辑的正确性。

## 规则1: 文件定位列验证

### 规则描述
如果填写了"关联主合同编号"，则"文件定位"列必填，且只能是"补充协议"或"解除协议"。

### 业务逻辑
- 关联主合同意味着当前合同是主合同的附属合同
- 附属合同必须明确标识其文件定位类型
- 主合同本身不能关联其他合同

### 验证时机
导入时实时验证，不符合规则将阻止导入并提示错误。

### 错误提示示例
```
关联了主合同时，文件定位列为必填项。
合同编号: HT2025001, 关联主合同编号: HT2024100
```

或

```
关联主合同时，文件定位只能是"补充协议"或"解除协议"。
合同编号: HT2025001, 当前文件定位: 主合同
```

---

## 规则2: 合同类型自动填充

### 规则描述
"合同类型"列支持自动填充，填充优先级如下：
1. **用户填写值** - 如果用户已填写，直接使用
2. **关联采购的采购类别** - 从关联采购记录自动获取
3. **主合同的合同类型** - 从关联的主合同继承
4. **必填提示** - 如果都未关联，则提示用户必填

### 字段取值范围
合同类型的可选值（与采购类别一致）：
- 工程
- 工程货物
- 工程服务
- 货物
- 服务

### 自动填充逻辑详解

#### 场景1: 有关联采购
```csv
合同编号,合同名称,关联采购编号,合同类型
HT2025001,XXX合同,GC2024001,
```
系统会自动从采购记录GC2024001的"采购类别"字段获取值（如"工程"），并填充到合同类型。

**日志输出:**
```
合同类型已从关联采购自动填充: 工程 (合同编号: HT2025001)
```

#### 场景2: 有关联主合同但无采购
```csv
合同编号,合同名称,关联主合同编号,文件定位,合同类型
HT2025002,XXX补充协议,HT2025001,补充协议,
```
系统会自动从主合同HT2025001的"合同类型"字段继承值。

**日志输出:**
```
合同类型已从主合同继承: 工程 (合同编号: HT2025002)
```

#### 场景3: 既无采购也无主合同
```csv
合同编号,合同名称,合同类型
HT2025003,直接签订合同,
```
系统会提示错误，要求用户必须填写。

**错误提示:**
```
合同类型列为必填项。
合同编号: HT2025003。
请直接填写合同类型(工程/货物/服务等)，或关联采购/主合同以自动填充。
```

---

## 导入模板示例

### 示例1: 主合同（关联采购）
```csv
合同编号,合同名称,关联采购编号,文件定位,合同类型
HT2025001,XXX工程合同,GC2024001,主合同,
```
✅ 合同类型自动从采购GC2024001继承

### 示例2: 补充协议
```csv
合同编号,合同名称,关联主合同编号,文件定位,合同类型
HT2025001-BC01,XXX补充协议,HT2025001,补充协议,
```
✅ 文件定位已填写
✅ 合同类型自动从主合同HT2025001继承

### 示例3: 直接签订合同
```csv
合同编号,合同名称,文件定位,合同类型
HT2025002,XXX服务合同,主合同,服务
```
✅ 合同类型手动填写

---

## 常见错误及解决方案

### 错误1: 关联主合同但未填文件定位
**错误信息:**
```
关联了主合同时，文件定位列为必填项。
```

**解决方案:**
在"文件定位"列填写"补充协议"或"解除协议"

### 错误2: 合同类型缺失
**错误信息:**
```
合同类型列为必填项。请直接填写合同类型(工程/货物/服务等)，或关联采购/主合同以自动填充。
```

**解决方案（三选一）:**
1. 直接在"合同类型"列填写值（工程/货物/服务等）
2. 填写"关联采购编号"，系统自动从采购记录获取
3. 填写"关联主合同编号"，系统自动从主合同继承

---

## 技术实现

### 数据库变更
- 新增字段: `contract_type` (VARCHAR(100), 可为空)
- 迁移文件: `contract/migrations/0011_add_contract_type.py`

### 代码变更
- 模型文件: `contract/models.py` - 添加contract_type字段
- 导入逻辑: `procurement/management/commands/import_excel.py` - 添加验证和自动填充逻辑
- 模板配置: `project/import_templates/contract.yml` - 添加字段定义

---

## 版本历史

- **v1.0** (2025-10-31): 初始版本，实现两个验证规则
