# 智能选择器与级联筛选功能说明

## 概述

本次更新为采购、合同、付款模块的编辑和新增功能添加了智能选择器组件，实现了以下核心功能：

1. **关联字段补全**：所有模块都添加了必要的关联字段（项目、采购、合同）
2. **智能搜索**：支持在下拉框中搜索关键词快速筛选
3. **级联筛选**：选择项目后，相关的采购/合同列表会自动筛选
4. **分页加载**：支持大数据量的分页展示，避免性能问题
5. **用户友好**：现代化的UI设计，提升用户交互体验

## 功能特性

### 1. 采购管理模块

**新增字段：**
- 关联项目（必填）：通过智能选择器选择已存在的项目

**交互流程：**
1. 点击"新增采购"或"编辑"按钮打开模态框
2. 在"关联项目"字段点击，弹出智能选择器
3. 可通过搜索框输入项目编号或名称快速筛选
4. 选择项目后自动填充关联字段

### 2. 合同管理模块

**新增字段：**
- 关联项目（必填）：选择合同所属项目
- 关联采购（可选）：选择关联的采购记录

**级联筛选：**
1. 选择项目后，采购列表会自动筛选该项目下的采购记录
2. 支持通过采购项目名称或编号搜索
3. 未选择项目时，采购列表显示所有记录

### 3. 付款管理模块

**新增字段：**
- 关联项目（显示）：从关联合同自动获取，仅供参考
- 关联合同（必填）：选择付款对应的合同

**级联筛选：**
1. 可先选择项目筛选合同范围
2. 合同列表会根据已选项目自动过滤
3. 支持通过合同编号、序号或名称搜索

## 技术实现

### 后端API

新增了三个API端点用于支持智能选择器：

```python
# 项目列表API
GET /api/projects/?search=关键词&page=1&page_size=20

# 采购列表API  
GET /api/procurements/?search=关键词&project_id=项目编号&page=1&page_size=20

# 合同列表API
GET /api/contracts/?search=关键词&project_id=项目编号&page=1&page_size=20
```

**响应格式：**
```json
{
  "success": true,
  "data": [
    {
      "id": "唯一标识",
      "display_text": "显示文本",
      "...": "其他字段"
    }
  ],
  "pagination": {
    "current_page": 1,
    "total_pages": 5,
    "total_count": 100,
    "has_next": true,
    "has_previous": false
  }
}
```

### 前端组件

**SmartSelector 类** (`project/static/js/smart-selector.js`)

核心方法：
- `init()`: 初始化选择器UI和事件绑定
- `loadData()`: 异步加载数据
- `updateCascadeFilters(filters)`: 更新级联筛选条件
- `setValue(value, text)`: 设置选中值
- `getValue()`: 获取当前选中值

**CSS样式** (`project/static/css/smart-selector.css`)
- 现代化的下拉框设计
- 流畅的动画效果
- 响应式布局支持

### 表单集成

**EditModal 类增强** (`project/static/js/edit-modal.js`)

新增方法：
- `initializeSmartSelectors()`: 初始化所有智能选择器
- `initProjectSelector()`: 初始化项目选择器
- `initProcurementSelectors()`: 初始化采购选择器
- `initContractSelectors()`: 初始化合同选择器
- `initPaymentSelectors()`: 初始化付款选择器
- `onProjectChange(projectId)`: 处理项目变更的级联逻辑

## 数据验证

### 导入文件要求

所有导入文件中的关联字段必须满足以下条件：

1. **项目关联**：
   - 必须填写系统中已存在的项目编号
   - "序号"列可以为空（系统自动生成）

2. **采购关联**（合同模块）：
   - 如果填写关联采购编号，必须是系统中已存在的采购记录
   - 可以留空（表示直接签订的合同）

3. **合同关联**（付款模块）：
   - 必须填写系统中已存在的合同编号或合同序号
   - 支持通过合同名称进行模糊匹配

### 表单验证规则

1. 项目字段为必填项（除项目管理模块外）
2. 关联的采购/合同必须实际存在于数据库中
3. 级联关系必须一致（如合同的项目与付款的项目应一致）

## 使用示例

### 示例1：新增采购项目并关联项目

1. 进入"采购管理"页面
2. 点击"新增采购项目"按钮
3. 在"关联项目"字段点击，弹出选择器
4. 在搜索框输入"研发"，系统自动筛选包含"研发"的项目
5. 点击选择"PRJ001 - 研发中心建设项目"
6. 填写其他必填字段
7. 点击"保存"完成创建

### 示例2：新增合同并关联采购

1. 进入"合同管理"页面
2. 点击"新增合同"按钮
3. 先选择"关联项目"：选择"PRJ001 - 研发中心建设项目"
4. 此时"关联采购"下拉列表会自动筛选为该项目下的采购
5. 在"关联采购"中搜索"设备"
6. 选择"GC2024001 - 研发设备采购"
7. 填写其他字段并保存

### 示例3：新增付款并关联合同

1. 进入"付款管理"页面
2. 点击"新增付款记录"按钮
3. 可选：先选择"关联项目"进行筛选
4. 在"关联合同"中搜索合同编号或名称
5. 选择对应的合同
6. 填写付款金额和日期
7. 保存记录

## 性能优化

1. **分页加载**：每次只加载20条数据，避免一次性加载大量数据
2. **搜索防抖**：搜索输入延迟300ms后才触发请求
3. **级联缓存**：级联筛选条件会被缓存，避免重复请求
4. **懒加载**：只在打开下拉框时才加载数据

## 注意事项

1. **数据一致性**：编辑记录时，如果修改了关联项目，请确保其他关联字段也相应更新
2. **删除限制**：删除项目/采购/合同前，请先确认没有其他记录依赖它
3. **权限控制**：编辑和新增功能需要相应的权限
4. **浏览器兼容**：建议使用Chrome、Firefox、Edge等现代浏览器

## 故障排除

### 问题1：下拉框无法打开

**可能原因：**
- JavaScript文件未正确加载
- CSS样式文件缺失

**解决方法：**
1. 检查浏览器控制台是否有错误
2. 确认`smart-selector.js`和`smart-selector.css`已正确引入
3. 清除浏览器缓存后重试

### 问题2：搜索无结果

**可能原因：**
- 搜索关键词不匹配
- 级联筛选条件过严

**解决方法：**
1. 尝试更简短的关键词
2. 清除项目筛选，查看全部数据
3. 检查数据库中是否确实存在匹配的记录

### 问题3：级联筛选不生效

**可能原因：**
- 项目未正确选择
- 数据关联关系不正确

**解决方法：**
1. 重新选择项目
2. 检查数据库中的关联关系是否正确
3. 查看浏览器控制台的网络请求是否成功

## 未来改进

1. **批量操作**：支持批量修改关联关系
2. **历史记录**：记录最近选择的项目/采购/合同
3. **快捷键**：支持键盘快捷键操作
4. **更多筛选**：支持按状态、日期等更多维度筛选
5. **数据预览**：悬停显示详细信息

## 更新日志

**v1.0.0 (2025-10-30)**
- 初始版本发布
- 实现智能选择器基础功能
- 支持项目、采购、合同的级联筛选
- 添加搜索和分页功能

---

**文档版本：** 1.0.0  
**最后更新：** 2025年10月30日  
**维护人员：** 开发团队