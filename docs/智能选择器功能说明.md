# 智能选择器 (Smart Selector) 功能说明

## 文档信息

**文档版本：** v2.0
**更新日期：** 2025-10-31
**覆盖范围：** 智能选择器前端组件、后端API、级联筛选逻辑
**目标读者：** 前端开发人员、后端开发人员、系统维护人员

---

## 1. 功能概述

智能选择器是一个高度可复用的前端组件，旨在取代传统的HTML `<select>` 元素，为用户提供现代化、高性能的下拉选择体验。它被广泛应用于系统中所有需要进行关联字段选择的场景，如在创建合同时选择项目、在创建付款时选择合同等。

### 1.1 核心特性

- **动态搜索**: 支持在下拉框内输入关键词，实时从后端API筛选数据。
- **分页加载 (懒加载)**: 数据按需分页加载，即使有数万条记录也能保持流畅。
- **级联筛选**: 支持一个选择器的值作为另一个选择器的筛选条件，实现动态关联。
- **用户友好的UI**: 清晰的选中项展示、搜索框、加载状态和分页控件。
- **配置驱动**: 通过简单的JavaScript配置即可在任何表单中集成。

---

## 2. 技术实现

### 2.1 前端组件: `SmartSelector` 类

智能选择器的所有逻辑都封装在 `project/static/js/smart-selector.js` 文件中的 `SmartSelector` 类中。

#### 2.1.1 初始化

通过 `new SmartSelector(config)` 创建一个实例。

**配置对象 (`config`) 详解:**

| 属性 | 类型 | 描述 | 示例 |
| :--- | :--- | :--- | :--- |
| `container` | `HTMLElement` | **必需**。选择器将被渲染到的DOM容器元素。 | `document.getElementById('project-selector')` |
| `apiUrl` | `string` | **必需**。提供数据的后端API地址。 | `'/api/projects/'` |
| `placeholder` | `string` | 未选择任何项时的占位文本。 | `'请选择项目'` |
| `searchPlaceholder` | `string` | 搜索框内的占位文本。 | `'搜索项目编号或名称...'` |
| `displayField` | `string` | API返回数据中，用于在列表中显示的字段名。 | `'display_text'` |
| `valueField` | `string` | API返回数据中，作为实际值的字段名。 | `'id'` |
| `cascadeFilters` | `object` | 级联筛选的初始参数。 | `{ status: 'active' }` |
| `onChange` | `function` | 当用户选择一个新值时触发的回调函数。 | `(value, text) => console.log(value)` |
| `pageSize` | `number` | 分页加载时每页的项目数量，默认为20。 | `30` |

#### 2.1.2 核心方法

- **`init()`**: 构造函数自动调用，用于创建DOM元素并绑定所有内部事件。
- **`loadData()`**: 核心的数据加载函数。它会根据当前页码、搜索词和级联筛选条件，向 `apiUrl` 发起 `fetch` 请求，并处理返回的数据。
- **`toggle()`, `open()`, `close()`**: 控制下拉框的显示与隐藏。`open()` 会重置搜索词和页码并加载第一页数据。
- **`select(value, text)`**: 当用户点击列表项时调用。它会更新组件的选中值和显示文本，关闭下拉框，并触发 `onChange` 回调。
- **`setValue(value, text)`**: 外部调用的方法，用于以编程方式设置选择器的值。常用于编辑表单时加载初始数据。
- **`getValue()`**: 获取当前选中的值。
- **`clear()`**: 清空当前选择。
- **`updateCascadeFilters(filters)`**: 更新级联筛选的参数。这是实现级联功能的关键。当依赖的上级选择器值改变时，调用此方法更新筛选条件，并重新加载数据。

#### 2.1.3 事件流

1.  用户点击触发器 (`.smart-selector-trigger`)。
2.  `open()` 方法被调用，下拉框显示，加载第一页数据。
3.  用户在搜索框输入，触发 `input` 事件。
4.  事件处理器使用 `setTimeout` 实现300ms防抖，然后更新搜索词并调用 `loadData()`。
5.  用户点击分页按钮，更新页码并调用 `loadData()`。
6.  用户点击列表项 (`.smart-selector-item`)。
7.  `select()` 方法被调用，更新状态，关闭下拉框，并执行 `onChange` 回调。

### 2.2 后端API

为了支持智能选择器，后端必须提供标准化的分页和搜索API。

- **URL**: `GET /api/[resource-name]/`
- **请求参数**:
  - `search`: 搜索关键词。
  - `page`: 请求的页码。
  - `page_size`: 每页数量。
  - **级联筛选参数**: 其他任意自定义的筛选参数，如 `project_id`。
- **响应格式**:

  ```json
  {
    "success": true,
    "data": [
      {
        "id": "PRJ001",
        "display_text": "PRJ001 - 研发中心建设项目"
      }
    ],
    "pagination": {
      "current_page": 1,
      "total_pages": 5,
      "has_next": true
    }
  }
  ```

### 2.3 集成与级联实现 (`edit-modal.js`)

智能选择器通常在模态框 (`EditModal`) 中被初始化和管理。

**示例：项目与采购的级联筛选**

1.  **初始化**: 在 `EditModal.initializeSmartSelectors()` 中，同时初始化项目选择器 (`projectSelector`) 和采购选择器 (`procurementSelector`)。

2.  **设置 `onChange` 回调**: 在初始化项目选择器时，为其 `onChange` 回调函数指定级联逻辑。

    ```javascript
    // edit-modal.js (简化版)
    this.projectSelector = new SmartSelector({
        // ...其他配置
        onChange: (projectId) => {
            // 当项目改变时，更新采购选择器的级联筛选条件
            if (this.procurementSelector) {
                this.procurementSelector.updateCascadeFilters({ project: projectId });
                // 清空旧的采购选择
                this.procurementSelector.clear(); 
            }
        }
    });
    ```

3.  **更新筛选条件**: 当用户在项目选择器中选择一个项目后，`onChange` 回调被触发。
4.  回调函数内部调用采购选择器的 `updateCascadeFilters({ project: projectId })` 方法。
5.  `procurementSelector` 的 `cascadeFilters` 更新为 `{ project: 'PRJ001' }`。
6.  下次 `procurementSelector` 打开或搜索时，`loadData` 方法会自动将这个筛选条件附加到API请求中 (`/api/procurements/?project=PRJ001&...`)，从而实现级联筛选。

---

## 3. 业务应用场景

### 3.1 合同表单

- **项目选择器**: `apiUrl: '/api/projects/'`。
- **采购选择器**: `apiUrl: '/api/procurements/'`。
- **级联逻辑**: 采购选择器依赖于项目选择器。当项目选定后，采购选择器的 `cascadeFilters` 会被更新为 `{ project: [选定的项目ID] }`。

### 3.2 付款表单

- **合同选择器**: `apiUrl: '/api/contracts/'`。
- **级联逻辑**: 合同选择器可以被一个可选的项目选择器级联筛选，以缩小合同的搜索范围。

---

## 4. 性能与优化

- **搜索防抖 (Debouncing)**: 搜索框的 `input` 事件被设置为延迟300ms触发，避免用户连续输入时产生大量无效的API请求。
- **懒加载**: 仅在用户点击打开下拉框时才发起第一次数据加载请求。
- **分页**: 后端API和前端组件协同工作，确保每次只传输和渲染一小部分数据。

---

**文档状态：** ✅ 完成
**维护责任人：** 前端开发负责人
**相关文件：** `project/static/js/smart-selector.js`, `project/static/css/smart-selector.css`, `project/static/js/edit-modal.js`