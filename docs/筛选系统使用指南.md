# 筛选系统使用指南

## 概述

新的筛选系统提供了更友好的交互体验,主要特点:

1. **分层筛选** - 快速筛选+高级筛选的两层架构
2. **筛选标签** - 已应用条件可视化显示,支持单独移除
3. **侧边抽屉** - 高级筛选使用抽屉而非模态框,不阻断页面浏览
4. **实时反馈** - 显示已应用筛选数量
5. **一键清除** - 快速重置所有筛选条件
6. **项目搜索** - 支持关键词搜索项目
7. **多选支持** - 所有下拉筛选支持多选
8. **复杂搜索** - 搜索框支持"逗号且、空格或"的筛选条件

## 使用方法

### 1. 在视图中配置筛选

```python
# project/views.py
from .filter_config import get_contract_filter_config

def contract_list(request):
    # ... 现有逻辑 ...
    
    # 获取筛选配置
    filter_config = get_contract_filter_config(request)
    
    context = {
        'contracts': page_obj,
        'page_obj': page_obj,
        **filter_config,  # 展开筛选配置
    }
    return render(request, 'contract_list_v2.html', context)
```

### 2. 在模板中使用

```django
{% extends 'base.html' %}

{% block content %}
<!-- 引入筛选组件 -->
{% include 'components/filter_system.html' with 
    quick_filters=quick_filters 
    advanced_filter_groups=advanced_filter_groups 
    search_placeholder="搜索合同编号、名称、乙方..." 
%}

<!-- 数据列表 -->
<div class="card">
    <!-- ... 表格内容 ... -->
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 配置筛选字段标签
    window.filterLabels = {
        'q': '搜索',
        'project': '项目',
        'file_positioning': '文件定位',
        // ... 更多字段 ...
    };
</script>
{% endblock %}
```

### 3. 自定义筛选配置

在 `project/filter_config.py` 中添加新的配置函数:

```python
def get_your_module_filter_config(request):
    """获取你的模块的筛选配置"""
    
    # 快速筛选(3-5个最常用字段)
    quick_filters = [
        {
            'name': 'field_name',
            'type': 'select',  # 或 'text'
            'placeholder': '全部',
            'width': '200px',
            'current_value': request.GET.get('field_name', ''),
            'options': [
                {'value': '1', 'label': '选项1'},
                {'value': '2', 'label': '选项2'},
            ]
        }
    ]
    
    # 高级筛选(按类别分组)
    advanced_filter_groups = [
        {
            'title': '基本信息',
            'icon': 'fas fa-info-circle',
            'filters': [
                {
                    'name': 'text_field',
                    'label': '文本字段',
                    'type': 'text',
                    'placeholder': '输入内容',
                    'current_value': request.GET.get('text_field', '')
                },
                {
                    'name': 'select_field',
                    'label': '下拉字段',
                    'type': 'select',
                    'options': [...],
                    'current_value': request.GET.get('select_field', '')
                },
                {
                    'name': 'date_field',
                    'label': '日期范围',
                    'type': 'daterange',
                    'start_value': request.GET.get('date_field_start', ''),
                    'end_value': request.GET.get('date_field_end', '')
                },
                {
                    'name': 'number_field',
                    'label': '数字范围',
                    'type': 'number',
                    'min_value': request.GET.get('number_field_min', ''),
                    'max_value': request.GET.get('number_field_max', '')
                }
            ]
        }
    ]
    
    return {
        'quick_filters': quick_filters,
        'advanced_filter_groups': advanced_filter_groups,
        'search_query': request.GET.get('q', '')
    }
```

## 字段类型说明

### 1. text - 文本输入(支持复杂搜索)
```python
{
    'name': 'field_name',
    'label': '字段名称',
    'type': 'text',
    'placeholder': '输入提示',
    'current_value': request.GET.get('field_name', '')
}
```

**搜索规则:**
- 空格分隔 = 或条件 (例如: "张三 李四" 匹配包含"张三"或"李四")
- 逗号分隔 = 且条件 (例如: "合同,北京" 匹配同时包含"合同"和"北京")

### 2. select - 下拉选择(支持多选和搜索)
```python
{
    'name': 'field_name',
    'label': '字段名称',
    'type': 'select',
    'options': [
        {'value': 'val1', 'label': '标签1'},
        {'value': 'val2', 'label': '标签2'},
    ],
    'current_value': request.GET.getlist('field_name')  # 注意使用getlist
}
```

**特性:**
- 支持多选
- 项目筛选支持关键词搜索
- 使用 Select2 增强用户体验

### 3. daterange - 日期范围
```python
{
    'name': 'date_field',
    'label': '日期范围',
    'type': 'daterange',
    'start_value': request.GET.get('date_field_start', ''),
    'end_value': request.GET.get('date_field_end', '')
}
```
后端会接收两个参数: `date_field_start` 和 `date_field_end`

### 4. number - 数字范围
```python
{
    'name': 'amount_field',
    'label': '金额范围',
    'type': 'number',
    'min_value': request.GET.get('amount_field_min', ''),
    'max_value': request.GET.get('amount_field_max', '')
}
```
后端会接收两个参数: `amount_field_min` 和 `amount_field_max`

## 最佳实践

### 1. 快速筛选字段选择
- 只放3-5个最常用的字段
- 优先选择枚举类型字段(项目、状态、类型等)
- 避免放置需要复杂输入的字段

### 2. 高级筛选分组
- 按业务逻辑分组(基本信息、金额、日期等)
- 每组不超过5个字段
- 使用合适的图标增强识别度

### 3. 筛选标签配置
```javascript
// 在模板的 extra_js 中配置
window.filterLabels = {
    'field_name': '显示名称',
    'field_name_start': '开始日期',
    'field_name_end': '结束日期',
    'field_name_min': '最小值',
    'field_name_max': '最大值',
};
```

### 4. 后端筛选逻辑
保持现有的筛选逻辑不变,组件会自动构建正确的URL参数:

```python
# 日期范围
if request.GET.get('signing_date_start'):
    queryset = queryset.filter(signing_date__gte=request.GET['signing_date_start'])
if request.GET.get('signing_date_end'):
    queryset = queryset.filter(signing_date__lte=request.GET['signing_date_end'])

# 数字范围
if request.GET.get('amount_min'):
    queryset = queryset.filter(amount__gte=request.GET['amount_min'])
if request.GET.get('amount_max'):
    queryset = queryset.filter(amount__lte=request.GET['amount_max'])
```

## 迁移现有页面

### 步骤1: 创建筛选配置
在 `filter_config.py` 中为页面创建配置函数

### 步骤2: 更新视图
```python
from .filter_config import get_xxx_filter_config

def your_view(request):
    # ... 现有逻辑保持不变 ...
    
    filter_config = get_xxx_filter_config(request)
    context.update(filter_config)
    
    return render(request, 'your_template.html', context)
```

### 步骤3: 更新模板
替换原有的筛选栏为新组件:

```django
{# 移除旧的筛选表单 #}
{# <form method="get" class="filter-bar">...</form> #}

{# 使用新组件 #}
{% include 'components/filter_system.html' with 
    quick_filters=quick_filters 
    advanced_filter_groups=advanced_filter_groups 
%}
```

### 步骤4: 配置标签
在模板的 `extra_js` 块中添加字段标签配置

## 注意事项

1. **参数名称约定**:
   - 日期范围: `field_name_start`, `field_name_end`
   - 数字范围: `field_name_min`, `field_name_max`
   - 多选参数: 使用 `request.GET.getlist('field_name')`

2. **搜索模式**:
   - 前端通过搜索模式切换按钮指定模式
   - 后端通过 `q_mode` 参数获取: `or`(空格分隔) 或 `and`(逗号分隔)

3. **Select2 依赖**:
   - 组件已自动引入 Select2 CDN
   - 项目筛选支持搜索,其他下拉框支持多选

4. **响应式设计**:
   - 组件已适配移动端
   - 小屏幕设备上抽屉占据全屏

5. **性能考虑**:
   - 快速筛选的选项列表应控制数量
   - 项目列表较大时,搜索功能更加实用

## 使用示例

### 前端 - 合同列表模板

```django
{% extends 'base.html' %}

{% block content %}
<!-- 引入筛选组件 -->
{% include 'components/filter_system.html' with
    quick_filters=quick_filters
    advanced_filter_groups=advanced_filter_groups
    search_placeholder="搜索合同编号、名称、乙方(空格=或,逗号=且)"
%}

<!-- 数据列表 -->
<div class="card">
    <!-- 表格内容 -->
</div>
{% endblock %}

{% block extra_js %}
<script>
    // 配置筛选字段标签
    window.filterLabels = {
        'q': '搜索',
        'project': '项目',
        'file_positioning': '文件定位',
        'contract_name': '合同名称',
        // ... 更多字段
    };
</script>
{% endblock %}
```

### 后端 - 视图配置

```python
from .filter_config import get_contract_filter_config

def contract_list(request):
    # 获取多选参数
    project_filters = request.GET.getlist('project')
    file_positioning_filters = request.GET.getlist('file_positioning')
    
    # 获取搜索参数
    search_query = request.GET.get('q', '')
    search_mode = request.GET.get('q_mode', 'or')
    
    # 基础查询
    contracts = Contract.objects.select_related('project')
    
    # 应用筛选...
    
    # 获取筛选配置
    filter_config = get_contract_filter_config(request)
    
    context = {
        'contracts': page_obj,
        'page_obj': page_obj,
        **filter_config,
    }
    return render(request, 'contract_list.html', context)
```

### 完整示例参考

- 配置: [`project/filter_config.py`](project/filter_config.py:6) 中的 `get_contract_filter_config()`
- 模板: [`project/templates/contract_list.html`](project/templates/contract_list.html:1)
- 组件: [`project/templates/components/filter_system.html`](project/templates/components/filter_system.html:1)
- 视图: [`project/views.py`](project/views.py:218) 中的 `contract_list()` 函数