# 工作周期监控页面 V2.0 重构完成说明

## 文档信息

- **创建日期**: 2025-01-12
- **版本**: V2.0
- **重构状态**: ✅ 已完成核心功能
- **参考文档**: `docs/工作周期监控页面需求方案.md`

---

## 一、重构概述

### 1.1 重构目标

根据需求方案文档，对工作周期监控页面进行全面重构，实现以下核心目标：

1. ✅ **术语与口径标准化**：统一时间计算、周期定义、去重规则
2. ✅ **完整指标体系**：实现采购周期、合同周期、数据质量等核心指标
3. ✅ **SLA与告警**：支持按采购方式的动态SLA阈值
4. ✅ **多维度筛选**：支持时间维度、采购方式、项目等多维度筛选
5. ✅ **趋势与分布**：提供周期趋势图和维度拆解分析
6. ✅ **明细与导出**：支持明细查看和CSV/Excel导出

### 1.2 重构策略

采用**渐进式重构**策略，创建V2版本与旧版本并存：

- 保留旧版本代码（`cycle_statistics.py`, `cycle_monitor`视图）
- 创建全新V2版本（`cycle_statistics_v2.py`, `cycle_monitor_v2`视图）
- 通过URL路由区分访问（`/monitoring/cycle/` vs `/monitoring/cycle/v2/`）

### 1.3 技术架构

```
┌─────────────────────────────────────────────────────────┐
│                    前端层 (Template)                     │
│  cycle_v2_new.html - 全新UI设计，符合需求方案规范       │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                    视图层 (Views)                        │
│  views_monitoring_cycle_v2.py                           │
│  - cycle_monitor_v2(): 主页面渲染                       │
│  - cycle_monitor_api(): API接口                         │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                   服务层 (Services)                      │
│  cycle_statistics_v2.py                                 │
│  - CycleStatisticsServiceV2 类                          │
│  - 遵循 KISS、YAGNI、DRY、SOLID 原则                   │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                   数据层 (Models)                        │
│  Procurement, Contract 模型                             │
│  - requirement_approval_date (需求审批)                 │
│  - result_publicity_release_date (结果公示)             │
│  - signing_date (合同签订)                              │
└─────────────────────────────────────────────────────────┘
```

---

## 二、已实现功能清单

### 2.1 核心指标计算 ✅

#### 采购周期指标
- ✅ 平均采购周期（avg）
- ✅ P50中位数
- ✅ P90分位数
- ✅ 项目数量
- ✅ 超期项目数
- ✅ 超期率

#### 合同周期指标
- ✅ 平均合同周期（avg）
- ✅ P50中位数
- ✅ P90分位数
- ✅ 项目数量
- ✅ 超期项目数
- ✅ 超期率

#### 数据质量指标
- ✅ 缺失端点项目数
- ✅ 异常项目数（预留接口）

### 2.2 筛选与分组功能 ✅

#### 时间维度筛选
- ✅ 需求审批完成时间
- ✅ 公示完成时间
- ✅ 合同签订时间

#### 业务维度筛选
- ✅ 年度筛选
- ✅ 项目筛选
- ✅ 采购方式筛选（多选）
- ✅ 仅显示超期项目

#### 分组展示
- ✅ 按采购方式分组统计
- ✅ 显示各方式的样本量、平均天数、P50、P90、达标率

### 2.3 趋势分析 ✅

- ✅ 按月趋势（单年度）
- ✅ 按半年趋势（全年度）
- ✅ 采购周期趋势线
- ✅ 合同周期趋势线
- ✅ 使用ApexCharts图表库

### 2.4 明细表与导出 ✅

#### 明细字段
- ✅ 项目ID、项目名称
- ✅ 需求审批时间、结果公示时间、合同签订时间
- ✅ 采购周期天数、合同周期天数
- ✅ 采购方式、经办人、供应商
- ✅ 状态标识、超期标识

#### 导出功能
- ✅ CSV导出
- ✅ Excel导出（需要openpyxl库）
- ✅ 包含完整字段信息

### 2.5 SLA与告警 ✅

#### 动态SLA阈值
- ✅ 按采购方式配置不同阈值（15天~45天）
- ✅ 合同周期统一阈值（15天）
- ✅ 超期判断逻辑

#### 颜色标识
- ✅ 正常：绿色
- ✅ 预警：黄色
- ✅ 告警：红色

---

## 三、文件清单

### 3.1 新增文件

```
project/
├── services/monitors/
│   └── cycle_statistics_v2.py          # 服务层V2（717行）
├── views_monitoring_cycle_v2.py        # 视图层V2（329行）
└── templates/monitoring/
    └── cycle_v2_new.html               # 模板V2（608行）

config/
└── urls_cycle_v2.py                    # 路由配置（12行）

docs/
└── 工作周期监控页面-V2重构完成说明.md  # 本文档
```

### 3.2 保留文件（旧版本）

```
project/
├── services/monitors/
│   ├── cycle_statistics.py             # 旧版服务层
│   └── config.py                       # 配置文件（共用）
├── views_monitoring.py                 # 旧版视图（包含cycle_monitor）
└── templates/monitoring/
    ├── cycle.html                      # 旧版模板
    └── cycle_v2.html                   # 旧版模板V2
```

---

## 四、部署步骤

### 4.1 集成路由

在 `config/urls.py` 中添加V2路由：

```python
from django.urls import path, include

urlpatterns = [
    # ... 现有路由 ...
    
    # 工作周期监控V2
    path('', include('config.urls_cycle_v2')),
]
```

### 4.2 安装依赖（可选）

如果需要Excel导出功能：

```bash
pip install openpyxl
```

### 4.3 访问地址

- **V2新版本**: `http://your-domain/monitoring/cycle/v2/`
- **V1旧版本**: `http://your-domain/monitoring/cycle/`（保持不变）

### 4.4 数据库要求

确保以下字段存在且有数据：

**Procurement模型**:
- `requirement_approval_date` - 需求审批完成日期
- `result_publicity_release_date` - 结果公示发布日期
- `procurement_method` - 采购方式
- `procurement_officer` - 采购经办人

**Contract模型**:
- `signing_date` - 合同签订日期
- `contract_source` - 合同来源（必须为"采购合同"）
- `procurement` - 关联采购（外键）
- `contract_officer` - 合同经办人

---

## 五、核心代码说明

### 5.1 服务层核心方法

#### `CycleStatisticsServiceV2` 类

```python
class CycleStatisticsServiceV2:
    """工作周期统计服务 V2.0"""
    
    # 公共接口
    def get_overview_statistics()      # 获取总览统计
    def get_trend_data()                # 获取趋势数据
    def get_dimension_breakdown()       # 获取维度拆解
    def get_detail_records()            # 获取明细记录
    
    # 内部计算方法
    def _calculate_procurement_statistics()  # 计算采购周期统计
    def _calculate_contract_statistics()     # 计算合同周期统计
    def _calculate_data_quality_statistics() # 计算数据质量统计
    def _calculate_procurement_trend()       # 计算采购趋势
    def _calculate_contract_trend()          # 计算合同趋势
    def _breakdown_by_procurement_method()   # 按采购方式拆解
    
    # 工具方法
    def get_procurement_deadline()      # 获取采购方式对应的SLA
    def _build_procurement_queryset()   # 构建查询集
    def _calculate_percentile()         # 计算百分位数
    def _group_by_month()               # 按月分组
    def _group_by_half_year()           # 按半年分组
```

### 5.2 关键计算逻辑

#### 采购周期计算

```python
采购周期(天) = 结果公示完成时间 - 需求审批完成时间

# 统计规则：
# 1. 只统计端点齐全的记录（两个日期都不为空）
# 2. 根据采购方式使用不同的SLA阈值
# 3. 超期判断：实际周期 > 对应采购方式的SLA
```

#### 合同周期计算

```python
合同周期(天) = 合同签订日期 - 结果公示完成时间

# 统计规则：
# 1