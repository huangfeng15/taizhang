# 项目采购与成本管理系统 – 技术交接文档（面向开发同事）

> 目标：让新的开发同事在 **1–2 天内熟悉并接手维护** 本系统。
> 本文侧重架构、关键模块、重要约定和常见开发场景，不讲业务细节。

## 1. 项目概览

- **名称**：项目采购与成本管理系统
- **语言/框架**：Python 3.10+ / Django 5.2.7（settings 里）
- **数据库**：默认 SQLite（`db.sqlite3`），可按需切 PostgreSQL
- **前端**：Django Template + Bootstrap 5 + 少量 Chart.js
- **部署方式**：Windows 环境 + 批处理脚本 + 自签名 HTTPS

主要 Django 应用：

- `project`：核心业务与视图聚合，包含监控、统计、导入导出、共享服务；
- `procurement`：采购模型与逻辑；
- `contract`：合同模型与逻辑；
- `payment`：付款模型；
- `settlement`：结算模型；
- `supplier_eval`：供应商评价；
- `pdf_import`：PDF 智能导入。

重要文档：

- 业务/使用说明：`README.md`、`docs/用户使用手册.html`（导出自文档系统）；
- Django 升级与优化：`docs/Django升级建议文档.md`、`docs/Django升级建议执行情况检查报告.md`；
- 数据模型说明：`docs/数据模型使用手册.md`；
- 部署：`docs/局域网部署说明.md`、`HTTPS配置指南.md`。

## 2. 目录结构与分层

顶部结构（见 `README.md` 的项目结构章节）：

- `config/`
  - `settings.py`：统一配置，已按“安全+性能”做过强化（CSRF、安全头、连接池等）；
  - `urls.py`：集中管理 URL，明确区分前端页面、API、导入导出、监控与 Swagger 文档；
- `project/`
  - `views.py`：**聚合路由入口**，通过 `_views_xxx` 子模块分发；
  - `views_projects.py / views_procurements.py / views_contracts.py / views_payments.py`：各业务页面；
  - `views_monitoring.py`：归档监控、周期监控、更新监控、完整性检查等；
  - `views_statistics.py`：统计接口（HTML + JSON + Excel 导出）；
  - `views_ops.py`：导入导出、数据库备份等运维功能；
  - `views_api.py`：为前端组件提供的 JSON API（项目/采购/合同选择器等）；
  - `services/`：
    - `export_service.py`：统一项目数据导出服务（Excel，多 sheet）；
    - `report_data_service.py`：统一报表数据服务（复用 statistics 服务）；
    - `archive_monitor.py` 等：归档监控、周期监控、更新监控服务；
  - `middleware/`：
    - `performance.py`：性能监控中间件；
    - `query_counter.py`：开发环境下的 SQL 次数统计；
  - `middleware.py`：`LoginRequiredMiddleware` + 审计日志（轻量脱敏）；
  - `models.py`：`Project` 主模型 + 角色/用户扩展等；
  - `utils/`：分页、Excel 美化、时间分组、人员列表等通用工具；
  - `tasks.py`：基于 `django-rq` 的异步任务（目前主要用于批量项目导出）；
- 各业务 app：`procurement/contract/payment/settlement/supplier_eval`
  - `models.py` 为主；视图集中在 `project/` 中，以避免跨 app 视图散落。

整体分层理念：

- **控制器层（views/")**：尽量薄，只负责解析请求、调用 services、组织响应；
- **服务层（services/）**：封装统计、导出、监控等核心业务逻辑；
- **模型层（models.py + BaseModel）**：包含字段定义和基础校验；
- **工具层（utils/）**：通用工具（分页、时间分组、人员聚合、Excel 格式化）。

## 3. 配置与环境

### 3.1 settings 关键点（`config/settings.py`）

- `DEBUG`、`SECRET_KEY`、`ALLOWED_HOSTS`、数据库配置等均通过环境变量支持生产校验；
- 数据库连接：
  - SQLite 默认：`CONN_MAX_AGE=600`、`CONN_HEALTH_CHECKS=True`，并在连接建立时启用外键约束；
- 安全设置：
  - CSRF、Session Cookie 安全（`HTTPONLY`、`SAMESITE`、`SECURE`）；
  - 安全头（`SECURE_CONTENT_TYPE_NOSNIFF`、`X_FRAME_OPTIONS` 等）；
- 缓存：
  - 多级缓存：`default` locmem + `file` 文件缓存 + `dummy`；
  - Redis 配置示例在注释里（生产建议使用 Redis）；
- 中间件：
  - `LoginRequiredMiddleware` 放在认证与 CSRF 之后，负责登录控制与审计；
  - 性能监控和 SQL 计数中间件按环境使用；
- HTTPS 相关：
  - `SECURE_PROXY_SSL_HEADER`、`CSRF_TRUSTED_ORIGINS`、`SECURE_SSL_HOST` 等已为局域网 HTTPS 做过适配；
- 队列：
  - `django_rq` + `RQ_QUEUES`：`default/high/low` 队列，通过 `REDIS_*` 环境变量配置。

### 3.2 URL 配置（`config/urls.py`）

- 前端页面：仪表盘、列表/详情、监控、统计、工作量等；
- API：
  - 选择器 API：`api/projects/`、`api/procurements/`、`api/contracts/`；
  - 统计详情 API：`api/statistics/<module>/details/`；
- 导出/导入：
  - `api/export/project-data/`、`api/import/project-data/`；
- PDF 导入与供应商管理：子应用 URL include；
- OpenAPI & Swagger：
  - `api/schema/`：drf-spectacular schema；
  - `api/docs/`：Swagger UI。

## 4. 主要模型与关系（概要）

完整字段说明见 `docs/数据模型使用手册.md`，这里只给整体轮廓。

- `project.Project`
  - 项目基础信息、状态、负责人；
  - 反向关联：`procurements`、`contracts`、通过合同关联的 `payments`、`settlements`；
- `procurement.Procurement`
  - 招采编号、采购名称、方式/类别、预算/控制价/中标价、关键时间节点等；
- `contract.Contract`
  - 主键为 `contract_code`；
  - 关联 `project`、`procurement`、`parent_contract`（补充协议）；
  - 金额、签订日期、文件定位、合同来源等；
- `payment.Payment`
  - 关联合同、付款编号、金额、日期、结算相关字段；
- `settlement.Settlement`
  - 关联主合同、最终结算金额、差异金额/差异率等；
- `supplier_eval.SupplierEvaluation`
  - 合同维度的供应商评价，包含年度评价和不定期评价字典字段；
- 角色与用户扩展：在 `project.models` 中有 `Role`、`UserProfile` 以及基于 Django 权限系统的 RBAC。

## 5. 关键服务与逻辑

### 5.1 项目导出服务（`project/services/export_service.py`）

- 核心函数：`generate_project_excel(project, user)`
  - 返回包含五个工作表的 `BytesIO`：采购、合同、付款、结算、供应商管理；
  - 使用 pandas + openpyxl 构建表格，并调用 `excel_beautifier` 进行样式优化；
  - 已针对大数据集做内存优化：
    - 使用 `QuerySet.iterator(chunk_size=1000)` 分批获取数据（采购、合同、付款、结算、供应商评价）；
  - 排序规则由 `sort_procurement_list`、`sort_contract_list` 等提供，支持复杂编号排序逻辑。

### 5.2 报表数据服务（`project/services/report_data_service.py`）

- `ReportDataService`：统一封装统计数据获取，避免在视图中直接拼复杂查询：
  - `get_procurement_statistics / get_contract_statistics / get_payment_statistics / get_settlement_statistics`
  - `get_procurement_details / get_contract_details / get_payment_details / get_settlement_details`
  - `get_projects_overview` 等。
- 大部分统计数据最终用于：
  - 监控驾驶舱视图；
  - `statistics_detail_api`（JSON）；
  - `statistics_detail_export`（Excel 导出）。

### 5.3 监控与统计（`views_monitoring.py` / `views_statistics.py`）

- 监控视图负责展示归档、周期、更新等指标；
- 统计视图：
  - `statistics_detail_api(request, module)`：
    - 返回分页 JSON 数据，模块为 `procurement/contract/payment/settlement`；
  - `statistics_detail_page(request, module)`：
    - 返回 HTML 页面；
  - `statistics_detail_export(request, module)`：
    - 基于 `ReportDataService` 导出 Excel（含 summary 区域和明细表）。

### 5.4 导入导出与运维（`views_ops.py`）

- `database_management`：备份/恢复/清理数据库（主要针对 SQLite 文件）；
- `export_project_data`：项目数据导出入口：
  - GET：渲染项目选择页面；
  - POST：
    - 单项目：直接调用 `generate_project_excel` 返回 Excel 文件；
    - 多项目：
      - 项目数量适中时：同步打包 ZIP 并返回；
      - 项目数量大时：调用 `generate_project_export_zip_async.delay(...)` 提交到 RQ 低优先级队列，前端以 JSON 提示“完成后邮件通知”；
- `import_project_data`：从 Excel 导入项目数据，基于 `import_project_excel`，对错误进行汇总提示。

### 5.5 异步任务（`project/tasks.py`）

- 目前主要任务：`generate_project_export_zip_async`：
  - 批量生成项目导出 Excel；
  - 任务完成后通过 `send_mail` 通知提交人（如配置了邮箱）；
  - 设计为“无侵入”的后台任务，不改变现有导出接口行为。

## 6. API 层与文档（drf-spectacular）

### 6.1 API 现状

当前 API 大多为 **普通 Django 视图 + JsonResponse**，而非 DRF 的 APIView：

- 基础数据 API（`project/views_api.py`）：
  - `api_projects_list`：项目选择器；
  - `api_procurements_list`：采购选择器；
  - `api_contracts_list`：合同选择器；
- 统计详情 API（`project/views_statistics.py`）：
  - `statistics_detail_api`：按模块返回统计详情分页数据；
- 批量操作/导入导出 API（`views_ops.py`）：
  - 批量删除项目/合同/付款/采购；
  - `export_project_data`、`import_project_data`；

已经集成：

- `INSTALLED_APPS`：`rest_framework`、`drf_spectacular`；
- `REST_FRAMEWORK` 默认 schema 使用 `drf_spectacular.openapi.AutoSchema`；
- `config/urls.py`：
  - `api/schema/`（OpenAPI JSON）；
  - `api/docs/`（Swagger UI）；
- `project/views_api.py`：`api_projects_list` 已通过 `@extend_schema` 添加参数说明与 tag（后续可按同样方式扩展）。

### 6.2 API 文档继续优化建议

> （本节也是你接下来可以继续做的事情）

1. 为核心 JSON API 添加 `@extend_schema` 注解：
   - `api_procurements_list`：补充 `search/project/page/page_size` 参数描述；
   - `api_contracts_list`：说明 `project_id/project/procurement/file_positioning` 等参数；
   - `statistics_detail_api`：
     - 描述 `module` path 参数；
     - 描述 query 中年份和项目筛选（通过全局 filter）；
   - 批量删除 API：声明接收的 JSON 结构（如 `{ "ids": [...] }`）。

2. 可选：用小型 `Serializer` 表达返回数据结构：
   - 对选择器接口（项目/采购/合同）定义只读 Serializer，让 OpenAPI 中有结构化响应示例；
   - 对 `statistics_detail_api` 的 `data`/`summary` 字段，定义通用的 `StatisticsSummarySerializer`、`StatisticsItemSerializer`。

3. 如果未来迁移到 DRF 视图集：
   - 可以逐步将 `views_api.py` 迁移为 DRF 的 `APIView/ViewSet`，当前 schema 配置无需大改。

## 7. 开发与调试

### 7.1 本地启动

参考 `README.md` 的“快速开始”，关键步骤：

```bash
python -m venv .venv
.venv\Scripts\activate
pip install -r requirements.txt
python manage.py migrate
python manage.py createsuperuser
python manage.py runserver 0.0.0.0:8000
```

HTTPS 启动可使用 `start_server.bat`（会基于 `generate_ssl_cert.py` 生成自签名证书，并监听 3500 端口）。

### 7.2 常用管理命令

- 备份/恢复数据库：通过 `views_ops.database_management` 提供 Web 界面；
- 手工运行 RQ：

```bash
# 启动默认队列 worker
python manage.py rqworker default

# 启动低优先级队列
python manage.py rqworker low
```

### 7.3 代码质量与测试

- `requirements.txt` 中已经声明：black、isort、flake8、mypy、bandit、pytest、pytest-django、pytest-cov 等工具；
- `.pre-commit-config.yaml` 已配置：
  - black、isort、flake8、pytest、mypy、bandit 钩子；
- 启用 pre-commit：

```bash
pip install pre-commit
pre-commit install
```

- 测试框架：
  - 当前几乎没有自定义测试用例（`manage.py test` 会显示 0 tests），建议逐模块补上最小回归测试：
    - 核心导出服务（`generate_project_excel`）
    - 统计服务（`ReportDataService`）
    - 关键 API（项目/采购/合同选择器、统计详情 API 等）。

## 8. 命名、筛选与字段约定

详细规范见 `AGENTS.md` 和 `docs/数据模型使用手册.md`，关键点：

- 字段命名统一使用 `snake_case`；
- GET 参数 / 表单 `name` 与模型字段保持一致；
- 数值区间：`{field}_min/{field}_max`；日期区间：`{field}_start/{field}_end`；
- 多选：前端 `name="field"`，后端使用 `getlist('field')`；
- 新增筛选字段时必须同步更新：
  - `project/filter_config.py`
  - 对应视图（如 `views_contracts.py`/`views_procurements.py`）。

## 9. 交接建议与注意事项

1. **优先熟悉 `project/services/` 与 `views_statistics.py`**：这些是系统“价值密集”的部分；
2. **任何修改统计口径前先看文档 + 统计服务**：
   - 避免在多个视图里直接拼 queryset，优先扩展 `ReportDataService` 或 `statistics.py`；
3. **新增导出/报表功能时**：
   - 尽量沿用 `export_service.py` 的分层模式（service -> view -> response）；
4. **安全相关改动**：
   - 修改 `settings.py` 中的安全配置、`LoginRequiredMiddleware` 或文件上传逻辑前，请确认对生产环境的影响；
5. **异步任务**：
   - 新增耗时操作（大报表、PDF 批处理）优先考虑放入 `django-rq`；
6. **文档同步**：
   - 新增模块/统计口径后，更新：
     - `README.md` 相关章节；
     - `docs/数据模型使用手册.md`；
     - 如涉及部署/配置，更新 `docs/局域网部署说明.md` 或 HTTPS 文档。

如需更细致的字段级说明，请以 `docs/数据模型使用手册.md` 为准；如需理解 Django 升级与优化背景，可以通读 `docs/Django升级建议文档.md` 及其执行情况报告。
