# 合同管理功能说明

## 功能概述

合同管理模块现已支持完整的增删改查（CRUD）功能，并提供详细的关联信息展示。

## 主要功能

### 1. 合同列表页面 (`/contracts/`)

**功能说明：**
- 查看所有合同的列表
- 支持搜索（合同编号、名称、乙方）
- 支持按项目和合同类型筛选
- 分页显示（每页20条）

**操作按钮：**
- **查看**：进入合同详情页面，查看完整信息及关联数据
- **编辑**：跳转到Django Admin编辑页面
- **新增合同**：跳转到Django Admin新增页面

### 2. 合同详情页面 (`/contracts/<合同编号>/`)

**功能说明：**
合同详情页面展示合同的所有字段信息，以及关联的其他模块数据。

#### 2.1 基本信息区块
显示合同的核心信息：
- 合同编号
- 合同序号
- 合同名称
- 合同类型（主合同/补充协议/解除协议）
- 合同来源（采购合同/直接签订）
- 关联主合同（如果是补充协议）
- 所属项目（可点击跳转到项目详情）

#### 2.2 合同方信息区块
显示合同双方信息：
- 甲方
- 乙方
- 乙方负责人及联系方式
- 合同文本内乙方联系人及方式

#### 2.3 金额与时间区块
显示财务和时间相关信息：
- 合同金额（含税）
- 签订日期
- 合同工期/服务期限
- 签订经办人
- 履约担保退回时间
- 支付方式

#### 2.4 关联采购信息区块
如果合同来源为"采购合同"，则显示采购项目的详细信息：
- 采购编号
- 采购名称
- 采购单位
- 中标单位
- 中标金额
- 中标日期

#### 2.5 付款记录区块
显示该合同的所有付款记录：
- 累计付款金额
- 付款进度百分比
- 付款明细列表（付款编号、金额、日期）
- 支持新增付款按钮

#### 2.6 结算信息区块
如果合同是主合同且已有结算记录，显示：
- 结算编号
- 最终结算金额
- 完成日期
- 结算备注

**注意：** 补充协议会显示其主合同的结算信息

#### 2.7 履约评价区块
显示供应商的履约评价记录：
- 评价编号
- 供应商名称
- 评价类型（末次评价/履约过程评价）
- 评分
- 评价日期区间
- 评价人员
- 支持新增评价按钮

#### 2.8 补充协议区块
如果当前合同是主合同，显示所有关联的补充协议：
- 补充协议编号
- 补充协议名称
- 合同类型
- 合同金额
- 签订日期
- 可点击查看每个补充协议的详情

### 3. 操作按钮

详情页面顶部提供三个操作按钮：
- **返回列表**：返回合同列表页面
- **编辑合同**：跳转到Django Admin编辑页面，编辑后自动返回列表页
- **删除合同**：跳转到Django Admin删除确认页面

## 数据关联说明

合同模块与以下模块建立了关联关系：

### 1. 项目（Project）
- 关系：多对一
- 说明：一个合同属于一个项目

### 2. 采购（Procurement）
- 关系：多对一
- 说明：采购合同必须关联采购项目；直接签订合同无需关联

### 3. 付款（Payment）
- 关系：一对多
- 说明：一个合同可以有多条付款记录
- 验证规则：累计付款不能超过合同金额的120%

### 4. 结算（Settlement）
- 关系：一对一
- 说明：只有主合同才能有结算记录
- 补充协议共享主合同的结算信息

### 5. 履约评价（SupplierEvaluation）
- 关系：一对多
- 说明：一个合同可以有多条履约评价记录

### 6. 父合同关联（自关联）
- 关系：一对多
- 说明：补充协议和解除协议必须关联主合同

## 业务规则

### 合同类型规则
1. **主合同**：不能关联其他合同
2. **补充协议**：必须关联主合同
3. **解除协议**：必须关联主合同

### 合同来源规则
1. **采购合同**：必须关联采购项目
2. **直接签订**：不能关联采购项目

### 继承规则
补充协议和解除协议会自动继承主合同的：
- 合同来源（contract_source）
- 采购关联（procurement）

## 使用流程

### 查看合同详情
1. 访问合同列表页面 `/contracts/`
2. 找到目标合同，点击"查看"按钮
3. 在详情页面浏览所有信息和关联数据

### 编辑合同
1. 在列表页点击"编辑"，或在详情页点击"编辑合同"
2. 在Django Admin页面修改信息
3. 点击"保存"后自动返回合同列表页

### 删除合同
1. 在详情页点击"删除合同"按钮
2. 在确认页面点击"是的，我确定"
3. 删除后返回合同列表页

### 新增付款记录
1. 在合同详情页的"付款记录"区块
2. 点击"新增付款"按钮
3. 在弹出的表单中填写付款信息
4. 合同字段会自动预填充当前合同

### 新增履约评价
1. 在合同详情页的"履约评价"区块
2. 点击"新增评价"按钮
3. 在弹出的表单中填写评价信息
4. 合同字段会自动预填充当前合同

## 界面优化

1. **面包屑导航**：方便用户了解当前位置
2. **颜色标识**：不同类型的合同和来源使用不同颜色的徽章
3. **链接跳转**：相关项目、主合同、补充协议都可以点击跳转
4. **空状态提示**：没有数据时显示友好的空状态提示
5. **响应式布局**：信息以网格形式排列，清晰易读

## 技术实现

### 后端实现
- 视图函数：[`project/views.py:contract_detail()`](project/views.py:239)
- 模板文件：[`project/templates/contract_detail.html`](project/templates/contract_detail.html:1)
- URL路由：[`config/urls.py`](config/urls.py:17)

### 关键特性
1. 使用 `select_related` 优化查询性能
2. 自动计算付款进度百分比
3. 智能判断是否显示结算信息（主合同或补充协议）
4. 支持URL参数预填充（新增付款、评价时）

## 注意事项

1. **编辑返回优化**：编辑、新增、删除操作完成后都会自动返回前端列表页，而不是Django Admin页面
2. **关联数据完整性**：删除合同前需要先删除关联的付款、评价等记录
3. **权限控制**：需要登录Django Admin才能进行编辑、删除操作
4. **数据验证**：所有修改都会经过模型层的业务规则验证

## 后续优化建议

1. 在前端页面直接实现增删改功能，无需跳转到Django Admin
2. 添加批量操作功能（批量删除、批量导出等）
3. 添加合同状态跟踪（进行中、已完成、已终止等）
4. 添加合同文件附件管理
5. 添加合同变更历史记录
6. 添加合同到期提醒功能