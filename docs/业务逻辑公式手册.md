# 业务逻辑与统计公式手册

## 文档信息

**文档版本：** v2.1
**更新日期：** 2025-10-31
**覆盖范围：** 核心模型计算、统计服务、监控服务、数据校验规则
**目标读者：** 开发人员、业务分析师、数据管理员

---

## 1. 核心计算逻辑 (模型层)

本章节定义了在数据模型（`models.py`）内部实现的核心业务计算逻辑。

### 1.1 合同金额与付款比例 (`contract/models.py`)

#### 1.1.1 合同总金额 (含补充协议)

- **函数**: `Contract.get_contract_with_supplements_amount()`
- **业务需求**: 计算主合同及其所有补充协议的总金额。
- **计算公式**:
  ```
  合同总金额 = 主合同金额 + Σ(所有补充协议金额)
  ```
- **实现逻辑**:
  - 如果当前是主合同，则累加自身金额和所有关联补充协议的金额。
  - 如果当前是补充协议，则递归调用其主合同的该方法，返回主合同的完整总金额。

#### 1.1.2 付款比例

- **函数**: `Contract.get_payment_ratio()`
- **业务需求**: 计算合同的实际付款进度，用于财务监控。
- **计算公式**:
  ```
  付款比例 = (累计已付金额 / 基准金额) * 100%
  ```
- **基准金额 (分母) 确定规则**:
  1.  **优先使用结算价**: 如果主合同关联的结算记录 (`Settlement`) 存在且有最终结算金额 (`final_amount`)，则基准金额为该结算金额。
  2.  **否则使用合同总额**: 如果没有结算价，基准金额为 `合同总金额 (含补充协议)`。
  3.  **补充协议自身**: 如果是补充协议，基准金额为其自身的合同金额。
- **累计已付金额 (分子)**: 通过 `Contract.get_total_paid_amount()` 计算，即关联合同下所有付款记录 (`Payment`) 的金额总和。

### 1.2 付款编号生成 (`payment/models.py`)

- **函数**: `Payment._generate_payment_code()`
- **业务需求**: 自动生成唯一且有序的付款编号。
- **编号格式**: `[合同标识]-FK-[序号]`
- **核心规则**:
  1.  **合同标识**: 优先使用合同的 `contract_sequence` (合同序号)，如果为空，则使用 `contract_code` (合同编号)。
  2.  **序号计算**:
     - 查询关联合同下的所有付款记录。
     - **严格按 `payment_date` (付款日期) 升序排序，如果日期相同，则按 `created_at` (创建时间) 升序排序。**
     - 根据当前付款记录在此排序列表中的位置确定其3位序号（例如 `001`, `002`）。
- **触发时机**: 在 `Payment` 对象首次保存 (`save`) 且 `payment_code` 为空时自动触发。

---

## 2. 统计分析服务 (`project/services/statistics.py`)

本章节定义了系统中用于生成各类统计报表的核心服务函数。所有金额在服务层处理后，通常会转换为 **万元** 为单位。

### 2.1 采购统计 (`get_procurement_statistics`)

- **核心逻辑**:
  - **按项目名称去重**: 为了避免同一采购项目分拆为多个采购包导致重复计算，统计时按 `project_name` (采购项目名称) 进行分组去重。
  - **金额取最大值**: 对于同一项目名称下的多条记录，`budget_amount` (预算), `winning_amount` (中标), `control_price` (控制价) 均取最大值作为代表。
- **关键指标**:
  - **采购总数**: 去重后的项目总数。
  - **总预算/总中标/总控制价**: 去重后各项金额的汇总。
  - **节约金额/节约率**: `(总预算 - 总中标) / 总预算`。
  - **采购方式分布**: 按采购方式分类统计数量和金额。
  - **平均采购周期**: `(中标通知书发放日期 - 采购需求书审批完成日期)` 的平均天数。
  - **归档率**: 已归档采购数 / 总采购数。

### 2.2 合同统计 (`get_contract_statistics`)

- **核心逻辑**: 基于 `Contract` 模型，按筛选条件（年份、项目）进行聚合统计。
- **关键指标**:
  - **合同总数/总金额**: 筛选范围内的合同总数与金额。
  - **类型分布**: 按 `file_positioning` (主合同、补充协议等) 分类统计数量和金额。
  - **来源分布**: 按 `contract_source` (采购合同、直接签订) 分类统计数量和金额。
  - **归档率**: 已归档合同数 / 总合同数。
  - **月度趋势**: 按签订月份统计合同数量和金额。

### 2.3 付款统计 (`get_payment_statistics`)

- **核心逻辑**: 基于 `Payment` 模型，按筛选条件进行聚合统计。
- **关键指标**:
  - **付款总笔数/总金额**: 筛选范围内的付款总数与总额。
  - **已结算/未结算统计**: 根据 `is_settled` 字段分类统计笔数和金额。
  - **预计剩余支付**:
    - `(合同基准金额 - 累计已付金额)` 的总和。
    - 基准金额的确定逻辑与 `get_payment_ratio` 一致。
  - **支付率**: `总支付金额 / (总支付金额 + 预计剩余支付)`。

### 2.4 结算统计 (`get_settlement_statistics`)

- **核心逻辑**:
  - **数据来源**: 统计数据来源于 `Payment` 表中 `is_settled=True` 且 `settlement_amount` 有值的记录。
  - **按主合同去重**: 由于一个合同的结算价可能分散在多笔付款记录中，统计时按主合同进行去重，确保每个合同的结算价只被计算一次。
- **关键指标**:
  - **已结算合同数**: 去重后的主合同总数。
  - **结算总金额**: 去重后的 `settlement_amount` 总和。
  - **结算率**: `已结算主合同数 / 总主合同数`。
  - **待结算合同**: 筛选出尚未结算的主合同及其合同总额。
  - **结算差异分析**: `(结算金额 - 合同总额) / 合同总额`，用于分析结算价与合同原价的偏差。

### 2.5 缓存策略 (`project/services/metrics.py`)

- **目的**: 为提高统计仪表盘的加载性能，对复杂的统计计算结果进行缓存。
- **实现**: `get_combined_statistics` 函数作为统一入口，调用上述所有统计函数，并将结果缓存。
- **缓存键**: `metrics:combined:[year]:[project_codes]`
- **缓存时间**: 默认为 5 分钟 (`DEFAULT_CACHE_TIMEOUT`)。

---

## 3. 监控服务

### 3.1 归档监控 (`project/services/archive_monitor.py`)

- **服务**: `ArchiveMonitorService`
- **业务需求**: 监控采购、合同资料的归档及时性和完整性。
- **核心规则**:
  - **采购归档**:
    - **应归档**: 所有已完成公示 (`result_publicity_release_date` 有值) 的采购项目。
    - **逾期标准**: 公示完成后 **40天** 未归档。
    - **及时归档**: 在公示完成后40天内完成归档。
  - **合同归档**:
    - **应归档**: 所有已签订 (`signing_date` 有值) 的 **主合同**。
    - **逾期标准**: 签订后 **30天** 未归档。
    - **及时归档**: 在签订后30天内完成归档。
- **输出指标**:
  - **归档率**: `已归档数 / 应归档数`。
  - **及时率**: `及时归档数 / 已归档数`。
  - **逾期数量**: 按“轻微(1-15天)”、“中等(16-30天)”、“严重(>30天)”分级统计。
  - **逾期列表**: 提供详细的逾期项目清单。

### 3.2 齐全性监控 (`project/services/completeness.py`)

- **服务**: `check_procurement_field_completeness`, `check_contract_field_completeness`
- **业务需求**: 检查核心业务数据的字段填写完整度。
- **核心规则**:
  - **采购字段 (26个)**: 检查 `procurement_code`, `project_name`, `winning_bidder`, `budget_amount` 等26个关键字段的填写情况。
  - **合同字段 (17个)**: 检查 `contract_sequence`, `contract_code`, `party_b`, `contract_amount`, `signing_date` 等17个关键字段的填写情况。
- **输出指标**:
  - **总体齐全率**: `(所有记录已填写的字段总数 / 所有记录应填写的字段总数) * 100%`。
  - **字段填写率**: 单独统计每个字段在所有记录中的填写比例。
  - **不完整记录列表**: 按齐全率从低到高列出填写不完整的记录及其缺失字段。
  - **项目完整性排名**: 按项目维度综合计算采购和合同的字段齐全率，进行排名。

---

## 4. 数据校验规则 (`models.py` 的 `clean` 方法)

- **合同模型 (`Contract.clean`)**:
  - **关联校验**:
    - 补充协议/解除协议 **必须** 关联主合同。
    - 主合同 **不能** 关联主合同。
    - 采购合同 **必须** 关联采购项目。
    - 直接签订合同 **不能** 关联采购项目。
  - **数据一致性**:
    - 补充协议的 `contract_source` 和 `procurement` 字段会自动从其主合同继承，保持一致。
- **付款模型 (`Payment.clean`)**:
  - **编号清理**: `payment_code` 中的非法字符会被自动清理。

---
**文档状态：** ✅ 完成
**维护责任人：** 技术负责人
**相关文档：** [数据模型使用手册](数据模型使用手册.md), [系统架构分析文档](系统架构分析文档.md)