# 登录验证配置说明

## 概述

本系统已实施全局登录验证机制，确保所有页面都需要通过身份验证才能访问。

## 配置详情

### 1. 登录验证中间件

**文件位置**: `project/middleware.py`

**功能**: 
- 全局拦截所有HTTP请求
- 验证用户是否已登录
- 未登录用户自动重定向到登录页面
- 豁免静态资源和登录相关URL

**豁免路径列表**:
- `/accounts/login/` - 登录页面
- `/accounts/logout/` - 登出页面
- `/admin/login/` - Admin登录页面
- `/admin/logout/` - Admin登出页面
- `/static/` - 静态资源
- `/media/` - 媒体文件

### 2. 会话配置

**文件位置**: `config/settings.py`

**关键配置**:

```python
# 会话有效期：12小时（43200秒）
SESSION_COOKIE_AGE = 12 * 60 * 60

# 关闭浏览器后会话不会立即失效，保持到SESSION_COOKIE_AGE到期
SESSION_EXPIRE_AT_BROWSER_CLOSE = False

# 每次请求都更新会话的过期时间（保持活跃状态）
SESSION_SAVE_EVERY_REQUEST = True

# 会话Cookie名称
SESSION_COOKIE_NAME = 'procurement_sessionid'

# 会话存储引擎（使用数据库）
SESSION_ENGINE = 'django.contrib.sessions.backends.db'
```

### 3. 登录认证URL配置

```python
# 登录页面URL
LOGIN_URL = '/accounts/login/'

# 登录成功后重定向到首页
LOGIN_REDIRECT_URL = '/'

# 登出后重定向到登录页面
LOGOUT_REDIRECT_URL = '/accounts/login/'
```

### 4. 中间件配置

在`config/settings.py`的`MIDDLEWARE`列表中已添加：

```python
MIDDLEWARE = [
    ...
    'project.middleware.LoginRequiredMiddleware',  # 全局登录验证中间件
]
```

**注意**: 此中间件必须放在`AuthenticationMiddleware`之后。

## 使用说明

### 首次访问

1. 用户访问任何页面（如 `https://10.168.3.240:3500/`）
2. 系统检测到用户未登录
3. 自动重定向到登录页面 `https://10.168.3.240:3500/accounts/login/`
4. 用户输入用户名和密码
5. 登录成功后，系统会自动跳转回原始请求的页面

### 会话管理

- **有效期**: 登录后会话有效期为12小时
- **活跃保持**: 每次访问页面都会刷新会话有效期
- **过期处理**: 12小时内无任何操作，会话自动过期，需要重新登录

### 登出操作

- 用户可以主动登出（通过导航栏或访问 `/accounts/logout/`）
- 登出后自动跳转到登录页面
- 所有会话数据被清除

## 登录页面

**模板位置**: `project/templates/registration/login.html`

**特点**:
- 现代化、响应式设计
- 清晰的错误提示
- 显示会话有效期信息（12小时）
- 显示系统访问地址

## 安全特性

1. **全局保护**: 所有业务页面都需要登录才能访问
2. **会话超时**: 12小时自动过期，防止长期未使用的会话被利用
3. **活跃保持**: 活跃用户的会话自动延期，提升用户体验
4. **登录重定向**: 记住用户访问的原始页面，登录后自动跳转

## 测试验证

### 测试场景1：未登录访问
```
1. 清除浏览器Cookie
2. 访问 https://10.168.3.240:3500/
3. 预期：自动跳转到登录页面
```

### 测试场景2：登录后访问
```
1. 访问登录页面并登录
2. 访问任意业务页面
3. 预期：正常显示页面内容
```

### 测试场景3：会话超时
```
1. 登录系统
2. 等待超过12小时（或手动删除会话Cookie）
3. 访问任意页面
4. 预期：自动跳转到登录页面
```

### 测试场景4：登出功能
```
1. 登录系统
2. 点击登出
3. 预期：跳转到登录页面，无法直接访问业务页面
```

## 故障排查

### 问题1：无法登录
- 检查用户名和密码是否正确
- 确认用户账户是否激活（`is_active=True`）
- 查看服务器日志获取详细错误信息

### 问题2：频繁要求登录
- 检查浏览器是否禁用Cookie
- 确认`SESSION_COOKIE_AGE`配置正确
- 检查数据库中的`django_session`表是否正常

### 问题3：中间件不生效
- 确认`project.middleware.LoginRequiredMiddleware`已添加到`MIDDLEWARE`
- 确认中间件位置在`AuthenticationMiddleware`之后
- 重启Django服务器

## 管理员操作

### 创建新用户

使用Django管理命令创建用户：

```bash
python manage.py createsuperuser
```

或使用Django Admin界面：

1. 访问 `https://10.168.3.240:3500/admin/`
2. 使用管理员账号登录
3. 进入"用户"管理页面
4. 点击"添加用户"创建新账号

### 查看会话信息

在Django Admin中：
1. 访问"会话"（Sessions）管理页面
2. 可以查看所有活跃会话
3. 可以手动删除特定会话（强制用户重新登录）

## 相关文件清单

- `config/settings.py` - 会话和认证配置
- `config/urls.py` - 登录URL路由配置
- `project/middleware.py` - 登录验证中间件
- `project/templates/registration/login.html` - 登录页面模板

## 更新记录

- **2025-11-06**: 实施全局登录验证系统
  - 创建登录验证中间件
  - 配置12小时会话超时
  - 设计统一登录页面
  - 更新所有相关配置