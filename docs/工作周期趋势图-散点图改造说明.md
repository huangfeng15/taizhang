# 工作周期趋势图散点图改造说明

## 改造目标

将工作周期监控页面的趋势图从**月度平均值折线图**改造为**按完成时间的散点图+趋势线**，真实反映每个业务的工作周期情况，避免平均值掩盖问题。

## 改造前后对比

### 改造前
- **数据聚合方式**：按月/半年聚合，计算平均值
- **图表类型**：折线图
- **问题**：
  - 看不到具体哪些业务超期
  - 平均值会掩盖异常值
  - 无法追踪到具体业务

### 改造后
- **数据展示方式**：每个业务一个散点，按完成时间精确定位
- **图表类型**：散点图 + 线性回归趋势线 + 基准线
- **优势**：
  - 每个点代表一个具体业务
  - 可以看到所有业务的分布情况
  - 异常值（如80天的超期采购）一目了然
  - 趋势线显示整体变化趋势
  - 鼠标悬停显示业务详情（编号、名称、经办人）

## 技术实现

### 1. 后端数据生成

**文件**：`project/services/monitors/cycle_statistics.py`

#### 修改的核心方法

**_calculate_trend()** - 从月度聚合改为散点数据返回

改造前返回格式：月度平均值
改造后返回格式：每个业务的散点数据，包含date、cycle_days、code、name、person字段

**get_persons_multi_trend()** - 多人趋势
**get_projects_multi_trend()** - 多项目趋势
**get_project_officers_multi_trend()** - 项目内多经办人趋势

改造后统一返回格式：包含procurement和contract数组，每个数组包含多个series，每个series包含name和points

### 2. 前端图表渲染

**文件**：`project/templates/monitoring/cycle.html`

#### 详情模态框趋势图

**函数**：`renderDetailTrend()`

**实现步骤**：
1. 将散点数据转换为 ApexCharts 格式
2. 使用线性回归计算趋势线
3. 添加基准线（采购/合同规定周期）
4. 配置 tooltip 显示业务详情

#### 多序列趋势图

**函数**：`renderMultiSeriesChart()`

**实现步骤**：
1. 遍历每个人/项目的散点数据
2. 为每个人/项目生成散点系列和趋势线系列
3. 使用不同颜色区分
4. 添加统一的基准线

## 图表元素说明

### 散点
- **蓝色点**：采购业务
- **绿色点**：合同业务
- **点的Y轴位置**：实际工作周期天数
- **点的X轴位置**：业务完成日期

### 趋势线
- **实线**：线性回归趋势线，显示整体变化趋势
- **与散点同色**：采购趋势线为蓝色，合同趋势线为绿色

### 基准线
- **虚线**：规定周期标准
- **采购基准线**：根据采购方式动态设置（15-45天）
- **合同基准线**：固定15天

## 数据点含义示例

以 **2025年5月15日的点** 为例：

- **Y轴值 = 35天**：该业务从开始到完成用了35天
- **X轴值 = 2025-05-15**：该业务在5月15日完成
- **鼠标悬停信息**：
  - 工作周期：35天
  - 业务编号：CG-2025-001
  - 经办人：张三

## 应用场景

### 1. 主页面趋势图
- **项目视图**：
  - 无项目筛选：显示所有项目的散点
  - 有项目筛选：显示该项目下各经办人的散点
- **个人视图**：显示所有经办人的散点

### 2. 详情模态框趋势图
- 点击"查看详情"按钮后
- 显示该项目/经办人的具体业务散点

## 优势总结

1. **数据真实性**：每个点代表一个真实业务，不做平均处理
2. **异常可见**：超期业务（如80天）在图上显著突出
3. **时间精确**：按实际完成日期精确定位，而非月度分组
4. **趋势明显**：趋势线显示整体变化方向
5. **交互友好**：鼠标悬停即可查看业务详情
6. **对比清晰**：基准线帮助判断是否超期

## 注意事项

1. **数据量大时的性能**：散点数量较多时可能影响渲染速度，已通过 top_n 限制人员/项目数量
2. **趋势线算法**：使用简单线性回归，适用于大多数场景
3. **基准线设置**：采购方式不同，规定周期不同，需动态设置
4. **日期格式**：后端返回 ISO 格式（YYYY-MM-DD），前端转换为时间戳

## 测试建议

1. **数据完整性**：确保散点数据包含 date、cycle_days、code、person 等字段
2. **多种场景**：测试不同年度筛选、项目筛选、采购方式筛选
3. **边界情况**：测试无数据、单条数据、大量数据的显示
4. **交互验证**：验证 tooltip、缩放、图例点击等交互功能

## 文件修改清单

- ✅ `project/services/monitors/cycle_statistics.py` - 后端数据生成逻辑
- ✅ `project/templates/monitoring/cycle.html` - 前端图表渲染逻辑

## 兼容性说明

- 前端使用 ApexCharts 库，已在项目中使用
- 无需额外依赖
- 浏览器兼容性：支持现代浏览器（Chrome, Firefox, Safari, Edge）