# Excel导出美化功能说明

## 概述

系统已升级Excel导出功能，所有导出的Excel文件现在都具有专业、美观的格式：

## 主要改进

### 1. 表头美化
- **样式**：深蓝色背景（#4472C4），白色粗体文字
- **对齐**：居中对齐，支持自动换行
- **行高**：25像素，方便阅读

### 2. 数据格式化
- **金额列**：红色粗体，千分位分隔符，保留2位小数，不换行
- **日期列**：标准日期格式（YYYY-MM-DD），不换行
- **文本列**：左对齐，**自动换行**，内容完整显示
- **居中列**：支持指定列居中显示，**自动换行**

### 3. 自动调整
- **列宽**：根据内容自动调整，中文字符按2倍宽度计算
- **行高**：数据行30像素高度，足够显示换行内容
- **自动换行**：文本列自动换行，确保长内容完整显示
- **最小/最大宽度**：列宽限制在10-50之间，避免过窄或过宽

### 4. 表格边框
- **边框样式**：浅灰色细线边框（#D0D0D0）
- **统一应用**：所有单元格都有边框，表格清晰

### 5. 冻结首行
- **固定表头**：滚动时表头始终可见
- **便于查看**：处理大量数据时方便对照表头

## 受影响的功能模块

### 1. 数据库管理模块
- **项目数据导出**：所有工作表（项目信息、采购信息、合同信息、付款信息、结算信息、供应商评价、导出信息）

### 2. 统计分析模块
- **采购统计详情导出**：金额列自动标红加粗
- **合同统计详情导出**：合同金额和累计付款突出显示
- **付款统计详情导出**：付款金额和结算价醒目展示
- **结算统计详情导出**：结算相关金额清晰呈现

## 技术实现

### 工具类

#### 1. `ExcelExporter` (project/utils/excel_exporter.py)
独立的Excel导出工具类，适用于从零开始创建Excel文件。

**使用示例**：
```python
from project.utils.excel_exporter import export_data_to_excel

headers = ['项目编码', '项目名称', '合同金额', '付款比例']
data = [
    ['PRJ001', '项目A', 1000000.00, 0.75],
    ['PRJ002', '项目B', 2000000.00, 0.50],
]
column_formats = {
    2: 'money',    # 第3列（索引2）使用金额格式
    3: 'percent'   # 第4列（索引3）使用百分比格式
}

return export_data_to_excel(headers, data, '项目统计', column_formats)
```

#### 2. `beautify_worksheet` (project/utils/excel_beautifier.py)
用于美化pandas生成的Excel工作表。

**使用示例**：
```python
from project.utils.excel_beautifier import beautify_worksheet
import pandas as pd

# 使用pandas创建Excel
with pd.ExcelWriter('output.xlsx', engine='openpyxl') as writer:
    df.to_excel(writer, sheet_name='数据', index=False)
    
    # 美化工作表
    beautify_worksheet(
        writer.sheets['数据'],
        money_columns=[5, 6, 7],     # 第5、6、7列为金额列
        date_columns=[8, 9],          # 第8、9列为日期列
        center_columns=[1, 2]         # 第1、2列居中显示
    )
```

## 格式类型说明

### 支持的列格式

| 格式类型 | 说明 | 效果 |
|---------|------|------|
| `money` | 金额格式 | 红色粗体，千分位分隔，右对齐 |
| `number` | 普通数字 | 千分位分隔，右对齐 |
| `percent` | 百分比 | 百分比格式，居中 |
| `date` | 日期 | 日期格式（YYYY-MM-DD），居中 |
| `center` | 居中 | 文本居中显示 |
| `right` | 右对齐 | 文本右对齐 |
| 默认 | 文本左对齐 | 普通文本，左对齐 |

## 最佳实践

### 1. 识别金额列
在导出包含金额的数据时，务必指定金额列以突出显示：
```python
beautify_worksheet(worksheet, money_columns=[10, 11, 12])
```

### 2. 列索引计数
- 列索引从1开始（不是0）
- 与Excel列号（A=1, B=2, C=3...）保持一致

### 3. 性能考虑
- 自动列宽调整会遍历所有数据，大数据量时可能稍慢
- 建议单次导出不超过10000行数据

## 用户体验改进

### 改进前
- 列宽固定，内容可能被截断
- 无行高设置，显示拥挤
- 表头无格式，不易识别
- 金额无格式，难以阅读
- 无边框，表格不清晰

### 改进后
- ✅ 列宽自动适配内容
- ✅ 行高统一，整齐美观
- ✅ 表头深蓝色背景，醒目突出
- ✅ 金额红色加粗，千分位分隔
- ✅ 全表格边框，清晰专业
- ✅ 首行冻结，滚动查看方便

## 维护说明

### 添加新的导出功能
1. 使用pandas生成Excel
2. 调用`beautify_worksheet`美化
3. 指定相应的金额列、日期列

### 修改样式
如需调整全局样式，修改以下文件中的常量：
- `project/utils/excel_exporter.py` - 独立导出工具
- `project/utils/excel_beautifier.py` - pandas美化工具

## 注意事项

1. **兼容性**：需要openpyxl库支持（已在requirements.txt中）
2. **中文支持**：字体使用"微软雅黑"，确保中文正常显示
3. **文件大小**：格式化会略微增加文件大小，但影响很小
4. **Excel版本**：生成的.xlsx文件兼容Excel 2007及以上版本

## 更新日志

### 2025-01-06
- ✅ 创建ExcelExporter独立工具类
- ✅ 创建beautify_worksheet美化函数
- ✅ 升级项目数据导出格式
- ✅ 升级统计详情导出格式
- ✅ 添加自动列宽调整功能
- ✅ 添加首行冻结功能