# 局域网部署说明

## 概述
本文档说明如何将Django项目部署到本地局域网，使局域网内其他设备可以访问。

## 系统配置

### 1. 服务器配置
- **文件**: `config/settings.py`
- **端口**: 3500
- **监听地址**: 0.0.0.0（所有网络接口）
- **允许主机**: `ALLOWED_HOSTS = ['*']`（允许所有主机访问）

### 2. 网络要求
- 服务器与客户端设备在同一局域网
- 防火墙开放TCP 3500端口
- 服务器IP地址可访问

## 启动服务

### 方法一：标准启动命令

```bash
# 1. 激活虚拟环境
.venv\Scripts\activate

# 2. 启动局域网服务
python manage.py runserver 0.0.0.0:3500
```

### 方法二：后台运行（Windows）

创建启动脚本 `run_server.bat`：

```batch
@echo off
echo ========================================
echo 项目采购与成本管理系统
echo ========================================
echo.

REM 激活虚拟环境
call .venv\Scripts\activate.bat

REM 显示本机IP地址
echo 本机IP地址：
ipconfig | findstr "IPv4"
echo.

REM 启动服务
echo 启动服务器在端口 3500...
echo 访问地址：http://本机IP:3500
echo 按 Ctrl+C 停止服务器
echo.
python manage.py runserver 0.0.0.0:3500

pause
```

双击 `run_server.bat` 即可启动。

## 访问方式

### 1. 获取服务器IP地址

**Windows系统：**
```cmd
ipconfig | findstr "IPv4"
```

**输出示例：**
```
IPv4 地址 . . . . . . . . . . . . : 10.168.3.240
```

### 2. 访问地址

**本机访问：**
- http://127.0.0.1:3500
- http://localhost:3500

**局域网访问（其他设备）：**
- http://10.168.3.240:3500 （替换为实际IP）

**系统功能入口：**
- **管理后台**: http://10.168.3.240:3500/admin/
- **项目台账**: http://10.168.3.240:3500/
- **数据监控**: http://10.168.3.240:3500/monitoring/
  - 统计分析: http://10.168.3.240:3500/monitoring/statistics/
  - 完整性监控: http://10.168.3.240:3500/monitoring/completeness/
  - 供应商排名: http://10.168.3.240:3500/monitoring/ranking/
  - 更新监控: http://10.168.3.240:3500/monitoring/update/
- **报表导出**: http://10.168.3.240:3500/reports/

### 3. 移动设备访问

手机、平板等移动设备可通过浏览器访问：
- 确保设备连接到同一局域网（同一WiFi）
- 打开浏览器输入：http://10.168.3.240:3500
- 系统采用响应式设计，自动适配移动端

## 防火墙配置

### Windows防火墙设置

**方式一：图形界面配置**

1. 打开"控制面板" → "Windows Defender 防火墙"
2. 点击"高级设置"
3. 选择"入站规则" → "新建规则"
4. 规则类型：选择"端口"
5. 协议和端口：
   - 协议：TCP
   - 特定本地端口：3500
6. 操作：允许连接
7. 配置文件：勾选所有（域、专用、公用）
8. 名称：Django项目管理系统 - 端口3500
9. 完成

**方式二：命令行配置（需管理员权限）**

```cmd
netsh advfirewall firewall add rule name="Django Port 3500" dir=in action=allow protocol=TCP localport=3500
```

**验证规则是否生效：**
```cmd
netsh advfirewall firewall show rule name="Django Port 3500"
```

**删除规则（如需要）：**
```cmd
netsh advfirewall firewall delete rule name="Django Port 3500"
```

## 安全注意事项

⚠️ **重要警告**

当前配置适用于**内网开发和测试环境**，具有以下特点：
- `DEBUG = True` - 显示详细错误信息
- `ALLOWED_HOSTS = ['*']` - 允许所有主机访问
- SQLite数据库 - 轻量级但不支持高并发

**不要在公网或生产环境使用此配置！**

### 安全建议

**内网使用：**
1. ✅ 确保服务器仅在内网可访问
2. ✅ 定期更改管理员密码
3. ✅ 限制管理员账户数量
4. ✅ 定期备份数据库
5. ✅ 监控访问日志

**生产环境部署（如需）：**
1. 设置 `DEBUG = False`
2. 配置具体的 `ALLOWED_HOSTS`（如 `['192.168.1.100', 'project.company.com']`）
3. 使用PostgreSQL或MySQL替代SQLite
4. 使用Gunicorn/Waitress + Nginx
5. 配置HTTPS证书
6. 启用CSRF保护
7. 配置日志监控
8. 实施访问控制和审计

## 故障排查

### 问题1：局域网其他设备无法访问

**症状：**
- 本机可以访问 http://127.0.0.1:3500
- 其他设备无法访问 http://服务器IP:3500

**解决方案：**

1. **检查服务器启动方式**
   ```bash
   # 确认使用 0.0.0.0 而不是 127.0.0.1
   python manage.py runserver 0.0.0.0:3500  # ✅ 正确
   python manage.py runserver 127.0.0.1:3500  # ❌ 错误（仅本机）
   ```

2. **检查防火墙**
   ```cmd
   # 查看3500端口规则
   netsh advfirewall firewall show rule name=all | findstr "3500"
   ```

3. **测试网络连通性**
   ```cmd
   # 在客户端设备上ping服务器
   ping 10.168.3.240
   
   # 在服务器上测试端口
   netstat -an | findstr "3500"
   ```

4. **检查网络连接**
   - 确认服务器和客户端在同一局域网
   - 检查路由器或交换机配置
   - 尝试禁用VPN

### 问题2：显示"DisallowedHost"错误

**症状：**
```
Invalid HTTP_HOST header: '10.168.3.240:3500'
You may need to add '10.168.3.240' to ALLOWED_HOSTS.
```

**解决方案：**

检查 `config/settings.py`：
```python
# 方案1：允许所有主机（开发环境）
ALLOWED_HOSTS = ['*']

# 方案2：指定具体主机（推荐）
ALLOWED_HOSTS = ['127.0.0.1', 'localhost', '10.168.3.240']
```

### 问题3：端口被占用

**症状：**
```
Error: That port is already in use.
```

**解决方案：**

```cmd
# 1. 查找占用3500端口的进程
netstat -ano | findstr "3500"

# 输出示例：
# TCP    0.0.0.0:3500    0.0.0.0:0    LISTENING    12345

# 2. 结束进程（替换12345为实际PID）
taskkill /F /PID 12345

# 或者使用不同端口
python manage.py runserver 0.0.0.0:3501
```

### 问题4：静态文件无法加载

**症状：**
- 页面显示但样式混乱
- 控制台显示404错误（CSS/JS文件）

**解决方案：**

```bash
# 1. 收集静态文件
python manage.py collectstatic --noinput

# 2. 检查静态文件配置
# 在 config/settings.py 中确认：
# STATIC_URL = 'static/'
# STATIC_ROOT = BASE_DIR / 'staticfiles'

# 3. 开发环境自动处理静态文件
# 确保 DEBUG = True
```

### 问题5：数据库被锁定

**症状：**
```
django.db.utils.OperationalError: database is locked
```

**解决方案：**

```bash
# 1. 关闭所有Django进程
taskkill /F /IM python.exe

# 2. 检查是否有其他程序打开数据库
# 关闭所有数据库管理工具（如DB Browser for SQLite）

# 3. 增加超时设置（config/settings.py）
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
        'OPTIONS': {
            'timeout': 20,  # 增加到20秒
        }
    }
}

# 4. 考虑升级到PostgreSQL（高并发场景）
```

### 问题6：服务器响应慢

**可能原因：**
- 数据量过大
- 未优化的查询
- 多用户并发访问

**解决方案：**

1. **启用查询优化**
   - 查看 `docs/性能优化说明.md`
   - 使用 `select_related()` 和 `prefetch_related()`

2. **添加数据库索引**
   ```bash
   python manage.py makemigrations
   python manage.py migrate
   ```

3. **考虑迁移到PostgreSQL**
   - 更好的并发支持
   - 更强的查询性能

## 性能优化建议

### 局域网部署优化

1. **数据库优化**
   - 确保数据库文件在本地磁盘（非网络驱动器）
   - 定期执行 `VACUUM` 清理
   - 考虑使用PostgreSQL支持多用户并发

2. **静态文件优化**
   ```bash
   # 收集并压缩静态文件
   python manage.py collectstatic --noinput
   ```

3. **缓存配置（可选）**
   ```python
   # config/settings.py
   CACHES = {
       'default': {
           'BACKEND': 'django.core.cache.backends.locmem.LocMemCache',
           'LOCATION': 'unique-snowflake',
       }
   }
   ```

### 多用户并发支持

**SQLite限制：**
- 适合小型团队（<10人同时在线）
- 读操作并发性能好
- 写操作串行执行

**升级到PostgreSQL（可选）：**

```bash
# 1. 安装PostgreSQL
# 2. 安装Python驱动
pip install psycopg2-binary

# 3. 修改 config/settings.py
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'procurement_db',
        'USER': 'postgres',
        'PASSWORD': 'your_password',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}

# 4. 迁移数据
python manage.py migrate
```

## 常用管理命令

```bash
# 创建超级用户
python manage.py createsuperuser

# 修改密码
python manage.py changepassword <username>

# 数据库迁移
python manage.py makemigrations
python manage.py migrate

# 收集静态文件
python manage.py collectstatic

# 运行测试
python manage.py test

# 检查项目配置
python manage.py check

# 数据库Shell
python manage.py dbshell

# Python Shell
python manage.py shell
```

## 监控与日志

### 查看访问日志

服务器终端会实时显示访问日志：
```
[31/Oct/2025 09:13:11] "GET /monitoring/statistics/ HTTP/1.1" 200 45678
[31/Oct/2025 09:13:15] "POST /admin/login/ HTTP/1.1" 302 0
```

### 错误日志

Django错误日志位置：
- 开发环境：控制台输出
- 生产环境：`logs/` 目录（需配置）

### 监控建议

1. **定期检查系统状态**
   ```bash
   python manage.py check --deploy
   ```

2. **监控数据库大小**
   ```bash
   # Windows
   dir db.sqlite3
   
   # Linux
   ls -lh db.sqlite3
   ```

3. **备份策略**
   - 每日自动备份数据库
   - 保留最近30天备份
   - 定期测试恢复流程

## 相关文档

- [开发实践指南](./开发实践指南.md) - 代码规范和开发流程
- [系统架构分析文档](./系统架构分析文档.md) - 技术架构和设计决策
- [性能优化说明](./性能优化说明.md) - 性能调优指南
- [数据模型使用手册](./数据模型使用手册.md) - 数据库模型说明

## 技术支持

**遇到问题时的排查步骤：**

1. 查看控制台错误信息
2. 检查 Django 日志
3. 查看浏览器开发者工具（F12）网络选项卡
4. 