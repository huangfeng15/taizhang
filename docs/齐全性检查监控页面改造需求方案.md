# 齐全性检查监控页面改造需求方案

## 文档信息

- **创建日期**: 2025-01-12
- **文档版本**: v1.1
- **最后更新**: 2025-01-14
- **作者**: Documentation Writer
- **参考文档**:
  - 归档监控页面完整需求文档
  - 归档监控散点图改造说明
  - 工作周期趋势图-散点图改造说明
  - 更新监控页面改造需求方案

---

## 一、需求背景

### 1.1 改造动机

**用户原始需求**：
> "当前归档监控页面的设计、内容都非常好，我希望齐全性检查监控页面也按照这个页面的方法来调整，因为它能够调取到我想要的数据，又不会显得页面冗杂。齐全性检查中还要有个字段配置按钮，点击后弹出模态框允许勾选哪些字段纳入齐全性统计。"

**核心诉求分析**：
1. **设计一致性**：参照归档监控的成功设计模式
2. **数据精准性**：能够精准调取字段齐全性数据
3. **页面简洁性**：信息展示清晰，避免冗杂
4. **灵活配置**：支持动态配置哪些字段纳入齐全性统计

### 1.2 现有齐全性检查页面分析

当前齐全性检查页面具有以下特点：

**优点**：
- ✅ 清晰展示采购/合同不完整记录
- ✅ 显示关联异常（补充协议未关联、付款超额等）
- ✅ KPI卡片展示齐全率
- ✅ 支持筛选和"显示所有记录"功能

**不足**：
- ❌ 缺少双视图切换（项目视图/个人视图）
- ❌ 无法查看单个项目或经办人的齐全性详情
- ❌ 没有字段级齐全率分析
- ❌ 缺少字段配置功能（已有数据模型但未在页面集成）
- ❌ 缺少概览统计表格

### 1.3 现有技术基础

系统已具备以下技术基础：

✅ **数据模型已就绪**：
- `CompletenessFieldConfig` 模型已实现
- 支持动态配置采购/合同字段
- 字段启用/禁用、排序功能完整

✅ **服务层已部分实现**：
- `CompletenessChecker` 类实现基础检查逻辑
- `completeness.py` 提供字段齐全性分析
- 支持字段级别的填写率统计

✅ **视图层已存在**：
- `completeness_check()` 视图
- `completeness_field_config()` 配置视图
- 但未集成到主页面

---

## 二、改造目标

### 2.1 核心目标

**参照归档监控页面的成功设计，实现齐全性检查的双视图模式，并集成字段配置功能。**

### 2.2 具体目标

1. **双视图模式**：实现项目视图和个人视图的切换
2. **概览统计表格**：显示所有项目/经办人的齐全性排名
3. **详细数据展示**：点击项目/经办人后显示详细的齐全性分析和字段级统计
4. **字段配置集成**：在主页面集成字段配置入口，支持动态调整统计范围
5. **字段级分析**：显示每个字段的填写率统计
6. **保持现有功能**：保留关联异常检查等现有功能

---

## 三、功能设计

### 3.1 双视图模式设计

#### 3.1.1 项目视图

**展示维度**：以项目为单位

**页面布局**：

```
┌────────────────────────────────────────────────────────┐
│ 页面标题: 齐全性检查                    [字段配置⚙️]  │
│ [项目视图] [个人视图]                    [全局筛选]  │
├────────────────────────────────────────────────────────┤
│ 当前筛选：2024年度 · 全部项目                         │
├────────────────────────────────────────────────────────┤
│ KPI汇总卡片（4张）                                     │
│ ┌──────┬──────┬──────┬──────┐                        │
│ │项目数│采购  │合同  │关联  │                        │
│ │      │齐全率│齐全率│异常  │                        │
│ │ 15   │92.5% │88.3% │ 5条  │                        │
│ └──────┴──────┴──────┴──────┘                        │
├────────────────────────────────────────────────────────┤
│ 项目齐全性统计明细                                     │
│ ┌────────────────────────────────────────────────┐   │
│ │项目名称│采购数│采购率│合同数│合同率│综合率│操作││   │
│ │────────────────────────────────────────────────│   │
│ │PRJ001  │25/30 │83.3% │18/20 │90.0% │86.7% │详情││   │
│ │XX项目  │ [进度条█████░░] [进度条██████░] │    ││   │
│ │────────────────────────────────────────────────│   │
│ │PRJ002  │30/30 │100%  │25/30 │83.3% │91.7% │详情││   │
│ │YY项目  │ [进度条████████] [进度条█████░░] │    ││   │
│ └────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────┘
```

- **性能与交互约束**：
  - 个人列表按“年度+经办人”分页（默认每页30人），支持按项目筛选后自动限制结果集，避免一次查询返回全部人员。
  - KPI与列表结果同样复用缓存，且在过滤条件变化时自动失效，保证数据一致性。
  - “详情”按钮只透传经办人编码，模态框拉取数据时带上当前筛选条件，确保统计口径一致。

**数据说明**：
- **采购数**：已完整/总数（例如：25/30表示30条采购中25条字段完整）
- **采购率**：字段齐全率（所有启用字段填写完整的记录占比）
- **综合率**：采购和合同齐全率的平均值
- **进度条**：可视化展示齐全率
- **性能与交互约束**：
  - 概览列表按年度+项目维度分页展示（默认每页20条，最高100条），由后端分页+聚合完成以避免一次性加载所有项目。
  - KPI汇总与分页数据加入5分钟缓存，同步标记筛选条件，确保高频刷新场景下的可用性。
  - “详情”按钮仅在用户点击时触发异步请求，字段级统计由模态框打开时再加载，减轻首屏压力。

#### 3.1.2 个人视图

**展示维度**：以经办人为单位

**页面布局**：

```
┌────────────────────────────────────────────────────────┐
│ 页面标题: 齐全性检查                    [字段配置⚙️]  │
│ [项目视图] [个人视图]                    [全局筛选]  │
├────────────────────────────────────────────────────────┤
│ KPI汇总卡片（4张）                                     │
│ ┌──────┬──────┬──────┬──────┐                        │
│ │经办人│采购  │合同  │关联  │                        │
│ │总数  │齐全率│齐全率│异常  │                        │
│ │ 8    │92.5% │88.3% │ 5条  │                        │
│ └──────┴──────┴──────┴──────┘                        │
├────────────────────────────────────────────────────────┤
│ 经办人齐全性统计明细                                   │
│ ┌────────────────────────────────────────────────┐   │
│ │姓名│项目数│采购数│采购率│合同数│合同率│综合率│操作││ │
│ │────────────────────────────────────────────────│   │
│ │张三│3个  │25/30 │83.3% │18/20 │90.0% │86.7% │详情││ │
│ │    │      │ [进度条] │      │ [进度条] │      │    ││ │
│ │────────────────────────────────────────────────│   │
│ │李四│2个  │30/30 │100%  │25/30 │83.3% │91.7% │详情││ │
│ └────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────┘
```

### 3.2 详情展示设计（模态框）

#### 3.2.1 项目详情模态框

**触发方式**：点击项目列表中的"查看详情"按钮

**展示内容**：

```
┌────────────────────────────────────────────────────────┐
│ 项目详情: PRJ001 - XX项目名称              [关闭×]   │
├────────────────────────────────────────────────────────┤
│ 齐全性统计卡片（3张）                                 │
│ ┌──────────┬──────────┬──────────┐                   │
│ │采购齐全率│合同齐全率│综合齐全率│                   │
│ │  83.3%   │  90.0%   │  86.7%   │                   │
│ │ 25/30条  │ 18/20条  │ 43/50条  │                   │
│ └──────────┴──────────┴──────────┘                   │
├────────────────────────────────────────────────────────┤
│ 齐全率对比图（横向条形图）                             │
│ ┌────────────────────────────────────────────────┐   │
│ │ 采购齐全率  ████████████████░░░░  83.3% (25/30)│   │
│ │ 合同齐全率  ██████████████████░░  90.0% (18/20)│   │
│ │ 综合齐全率  █████████████████░░░  86.7% (43/50)│   │
│ └────────────────────────────────────────────────┘   │
├────────────────────────────────────────────────────────┤
│ 字段齐全率分析（Tab切换：采购/合同）                  │
│ ┌────────────────────────────────────────────────┐   │
│ │ [采购] [合同]                                  │   │
│ │ ────────────────────────────────────────────── │   │
│ │ 【雷达图】字段填写率分布                       │   │
│ │        中标人(100%)                            │   │
│ │           /\                                   │   │
│ │          /  \                                  │   │
│ │   联系方式  金额                               │   │
│ │   (83%)    (100%)                              │   │
│ │        \  /                                    │   │
│ │         \/                                     │   │
│ │      评标委员会(67%)                           │   │
│ │ ────────────────────────────────────────────── │   │
│ │ 【条形图】字段填写率详情                       │   │
│ │ 中标人                100%  ████████ 30/30     │   │
│ │ 中标金额              100%  ████████ 30/30     │   │
│ │ 中标人联系方式        83.3% ██████░░ 25/30     │   │
│ │ 评标委员会            66.7% █████░░░ 20/30     │   │
│ │ 付款方式              90.0% ███████░ 27/30     │   │
│ └────────────────────────────────────────────────┘   │
├────────────────────────────────────────────────────────┤
│ 不完整记录明细（Tab切换：采购/合同）                  │
│ [采购] [合同]                                         │
│ ┌────────────────────────────────────────────────┐   │
│ │ 编号 │名称    │齐全率│缺失字段        │经办人│编辑││
│ │ P001 │XX采购  │80%   │中标人联系方式  │张三  │🔗 ││
│ │ P002 │YY采购  │60%   │评标委员会、... │李四  │🔗 ││
│ └────────────────────────────────────────────────┘   │
├────────────────────────────────────────────────────────┤
│ 关联异常（如有）                                       │
│ ┌────────────────────────────────────────────────┐   │
│ │ ⚠️ 补充协议C001未关联主合同           [处理] │   │
│ │ ⚠️ 合同C002付款超额 5000元             [处理] │   │
│ └────────────────────────────────────────────────┘   │
└────────────────────────────────────────────────────────┘
```

**关键特性**：
1. **齐全率对比图**：使用横向条形图直观对比采购/合同/综合齐全率
2. **字段级分析**：
   - **雷达图**：整体展示各字段填写率分布，快速识别薄弱环节
   - **条形图**：详细列出每个字段的填写率和具体数据
3. **不完整记录**：列出所有齐全率低于100%的记录
4. **快速编辑**：点击🔗链接跳转到编辑页面
5. **关联异常**：显示该项目相关的关联问题
6. **延迟加载**：模态框打开后才触发详情接口，并附带当前筛选条件与配置版本，保证性能和口径一致。

**图表选择说明**：
- **不使用散点图**：齐全性检查没有时间维度，散点图不适用
- **横向条形图**：最适合展示齐全率对比，长度直观表示百分比
- **雷达图**：适合展示多维度字段填写率，快速识别短板

#### 3.2.2 经办人详情模态框

**展示内容**：

```
┌────────────────────────────────────────────────────────┐
│ 经办人详情: 张三                           [关闭×]   │
├────────────────────────────────────────────────────────┤
│ 齐全性统计卡片（4张）                                 │
│ ┌──────────┬──────────┬──────────┬──────────┐       │
│ │负责项目数│采购齐全率│合同齐全率│综合齐全率│       │
│ │   3个    │  83.3%   │  90.0%   │  86.7%   │       │
│ │          │ 25/30条  │ 18/20条  │ 43/50条  │       │
│ └──────────┴──────────┴──────────┴──────────┘       │
├────────────────────────────────────────────────────────┤
│ 按项目分组统计                                         │
│ ┌────────────────────────────────────────────────┐   │
│ │ 项目   │采购数│采购率│合同数│合同率│综合率│    │   │
│ │ PRJ001 │15/20 │75%   │8/10  │80%   │77.5% │    │   │
│ │ PRJ002 │10/10 │100%  │10/10 │100%  │100%  │    │   │
│ └────────────────────────────────────────────────┘   │
├────────────────────────────────────────────────────────┤
│ 字段齐全率分析（同项目详情）                           │
├────────────────────────────────────────────────────────┤
│ 不完整记录明细（同项目详情）                           │
└────────────────────────────────────────────────────────┘
```

**关键特性补充**：
- 模态框沿用项目详情的延迟加载策略，接口根据“经办人+项目筛选范围”聚合字段统计。
- 若当前筛选限定了单个项目，则按项目分组的面板自动折叠，只保留相关记录。

### 3.3 字段配置功能设计

#### 3.3.1 配置入口

**位置**：页面右上角，与全局筛选并列

```
┌────────────────────────────────────────────────────────┐
│ 齐全性检查             [字段配置⚙️] [全局筛选🔍]     │
└────────────────────────────────────────────────────────┘
```

**按钮样式**：
- 图标：⚙️ 齿轮图标
- 文字："字段配置"
- 样式：按钮风格，突出显示

#### 3.3.2 配置模态框设计




**触发方式**：点击"字段配置"按钮

**模态框布局**：

```
┌────────────────────────────────────────────────────────┐
│ 字段配置 - 齐全性统计                      [关闭×]   │
├────────────────────────────────────────────────────────┤
│ 说明：勾选字段将纳入齐全性统计，取消勾选则不统计     │
│ 配置修改后将自动刷新页面统计数据                       │
├────────────────────────────────────────────────────────┤
│ [采购字段] [合同字段]                                 │
│ ┌────────────────────────────────────────────────┐   │
│ │ 采购字段配置                                   │   │
│ │ ────────────────────────────────────────────── │   │
│ │ ☑ 中标人                                       │   │
│ │ ☑ 中标金额                                     │   │
│ │ ☑ 中标人联系方式                               │   │
│ │ ☑ 评标委员会                                   │   │
│ │ ☑ 付款方式                                     │   │
│ │ ☐ 保证金（未启用）                             │   │
│ │ ☐ 保证金退还日期（未启用）                     │   │
│ │                                                │   │
│ │ [全选] [反选] [恢复默认]                       │   │
│ └────────────────────────────────────────────────┘   │
├────────────────────────────────────────────────────────┤
│ 当前统计字段数：采购 5个 / 合同 2个                   │
├────────────────────────────────────────────────────────┤
│                              [取消] [保存并应用]      │
└────────────────────────────────────────────────────────┘
```

**功能特性**：
1. **Tab切换**：采购字段和合同字段分别配置
2. **勾选控制**：复选框控制字段是否纳入统计
3. **批量操作**：全选、反选、恢复默认
4. **实时统计**：显示当前已启用字段数量
5. **立即生效**：保存后自动刷新页面数据

#### 3.3.3 配置逻辑

**字段启用规则**：
- 勾选字段：`is_enabled = True`
- 未勾选字段：`is_enabled = False`
- 只有启用的字段才会被纳入齐全性统计

**计算影响**：
```
齐全性判断 = 所有启用字段都已填写？

例如：
- 启用字段：中标人、中标金额、中标人联系方式（3个）
- 某条记录：中标人✓、中标金额✓、中标人联系方式✗
- 该记录齐全率 = 2/3 = 66.7%
```

#### 3.3.4 配置范围、权限与回滚

- **生效范围**：字段配置按“组织机构 + 业务模块（采购/合同）”存储，默认继承平台级模板；子组织可单独覆盖且仅对本组织及下级生效。
- **权限控制**：仅系统管理员、业务负责人角色在页面右上角看到“字段配置”按钮，其他角色不可见；接口同时校验 `can_manage_completeness_field` 权限。
- **版本与回滚**：每次保存都会生成历史版本（版本号=时间戳+操作者），支持在模态框中查看最近5次调整并一键恢复默认；历史记录写入 `CompletenessFieldConfigHistory`，供审计追溯。
- **变更广播**：配置更新后通过事件总线刷新缓存（概览列表缓存 + 详情接口缓存），确保下一次查询立即采用新字段集。

---

## 四、数据逻辑设计

### 4.1 齐全率计算规则

#### 4.1.1 记录级齐全率

**计算公式**：
```
记录齐全率 = (已填写的启用字段数 / 启用字段总数) × 100%
```

**示例**：
```
采购记录 P001：
- 启用字段：中标人、中标金额、联系方式、评标委员会、付款方式（5个）
- 已填写：中标人✓、中标金额✓、联系方式✓、评标委员会✗、付款方式✓
- 齐全率 = 4/5 = 80%
```

#### 4.1.2 模块齐全率

**计算公式**：
```
模块齐全率 = (齐全率为100%的记录数 / 记录总数) × 100%
```

**示例**：
```
某项目采购统计：
- 总记录数：30条
- 100%齐全的记录：25条
- 采购齐全率 = 25/30 = 83.3%
```

#### 4.1.3 综合齐全率

**计算公式**：
```
综合齐全率 = (采购齐全率 + 合同齐全率) / 2
```

### 4.2 双视图数据范围

#### 项目视图
- **全局筛选未指定项目**：显示所有项目列表
- **全局筛选指定项目**：只显示该项目的详细信息

#### 个人视图
- **全局筛选未指定项目**：显示所有经办人的数据
- **全局筛选指定项目**：只显示在该项目中有业务的经办人

### 4.3 关联异常检查

保留现有的关联异常检查逻辑：

1. **补充协议未关联主合同**
2. **解除协议未关联主合同**
3. **付款超额**（付款总额 > 合同金额）
4. **主合同错误关联其他合同**
5. **采购合同未关联采购项目**

---

## 五、技术实现方案

### 5.1 参照归档监控的成功实践

参照归档监控页面的技术实现，保持一致的开发模式：

1. **服务层扩展**：创建 `CompletenessStatisticsService` 类
2. **URL参数管理**：view_mode、target_code、筛选参数
3. **模态框详情展示**：与归档监控一致的交互方式
4. **配置集成**：将现有配置视图集成到模态框

### 5.2 核心服务分层与接口

为避免“大而全”服务类，采用分层架构，所有服务通过依赖注入组合，便于单测与扩展：

| 服务 | 职责 | 关键方法 |
|------|------|----------|
| `CompletenessOverviewProvider` | 负责项目/经办人概览列表 | `get_projects_overview(filters, page)`、`get_persons_overview(filters, page)` |
| `CompletenessDetailProvider` | 负责详情模态框数据、关联异常 | `get_project_detail(project_code, filters)`、`get_person_detail(person_code, filters)` |
| `FieldFillRateProvider` | 读取 `completeness.py` 分析结果，输出字段级统计 | `get_field_fill_rates(model_type, filters, config_version)` |
| `CompletenessConfigService` | 管理字段配置、版本、权限校验 | `save_config(org_id, model_type, payload)`、`list_versions()`、`restore(version_id)` |
| `CompletenessCache`（抽象） | 统一管理概览/详情缓存 | `remember(key, ttl, loader)`、`invalidate(scope)` |

**接口关系**：
- `CompletenessOverviewProvider` 依赖 `FieldFillRateProvider` 计算模块齐全率，并把结果分页返回。
- `CompletenessDetailProvider` 直接读取 `CompletenessConfigService` 返回的生效字段集，附带`config_version`到 `FieldFillRateProvider`，确保统计口径可追溯。
- 所有对外视图层只依赖一个门面类 `CompletenessStatisticsFacade`，Facade 内部组合上述服务，满足DIP/OCP。

**缓存策略**：
- 概览结果：`org_id + view_mode + filters + page` 缓存5分钟，可在字段配置或基础数据更新后按scope失效。
- 详情结果：缓存60秒，命中后仍校验配置版本号，不匹配即重新计算。
- 字段配置：放入Redis Hash + 本地内存（60秒），减少频繁读取数据库。

**并发与分页**：
- 所有概览查询统一在 ORM 层使用 `select_related` + 分页器，限制每次最大返回100条。
- 详情查询通过异步任务提前拉取关联异常，接口返回Promise ID，前端轮询或等待完成（长时间操作时可扩展）。

### 5.3 视图层改造

**修改现有视图**：`completeness_check()`

```python
def completeness_check(request):
    """齐全性检查监控（项目/个人视图）"""
    from project.services.monitors.completeness_statistics import CompletenessStatisticsFacade
    
    global_filters = _resolve_global_filters(request)
    view_mode = request.GET.get('view_mode', 'project')
    target_code = request.GET.get('target_code', '')
    
    stats_service = CompletenessStatisticsFacade()  # Facade 内部注入 overview/detail/field/config 服务
    
    # 获取概览数据
    if view_mode == 'project':
        overview_data = stats_service.get_projects_completeness_overview(
            year_filter=global_filters['year_value'],
            project_filter=global_filters['project']
        )
    else:
        overview_data = stats_service.get_persons_completeness_overview(
            year_filter=global_filters['year_value'],
            project_filter=global_filters['project']
        )
    
    # 获取详情数据（如果选择了目标）
    detail_data = None
    if target_code:
        if view_mode == 'project':
            detail_data = stats_service.get_project_completeness_detail(
                project_code=target_code,
                year_filter=global_filters['year_value']
            )
        else:
            detail_data = stats_service.get_person_completeness_detail(
                person_name=target_code,
                year_filter=global_filters['year_value'],
                project_filter=global_filters['project']
            )
    
    # 准备上下文
    context = {
        'page_title': '齐全性检查',
        'view_mode': view_mode,
        'target_code': target_code,
        'overview_data': overview_data,
        'detail_data': detail_data,
        'filter_config': filter_config,
    }
    
    return render(request, 'monitoring/completeness.html', context)
```

### 5.4 前端交互设计

**视图切换**：
```javascript
function switchView(mode) {
    const url = new URL(window.location.href);
    url.searchParams.set('view_mode', mode);
    url.searchParams.delete('target_code');
    window.location.href = url.toString();
}
```

**详情查看**：
```javascript
function viewDetail(targetCode) {
    const url = new URL(window.location.href);
    url.searchParams.set('target_code', targetCode);
    window.location.href = url.toString();
}
```

**字段配置模态框**：
```javascript
// 打开配置模态框
function openFieldConfig() {
    const modal = new bootstrap.Modal(document.getElementById('fieldConfigModal'));
    modal.show();
}

// 保存配置
async function saveFieldConfig() {
    const data = {
        model_type: currentModelType, // 'procurement' 或 'contract'
        fields: getSelectedFields()
    };
    
    const response = await fetch('/monitoring/update-completeness-field-config/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });
    
    if (response.ok) {
        // 刷新页面以应用新配置
        window.location.reload();
    }
}
```

---

## 六、实施计划

### 6.1 两阶段迭代拆分

整体排期拉长至**10~12个工作日**，并通过灰度上线降低风险：

- **迭代0（1天，准备）**：梳理现有字段配置、补齐缺失数据、确认角色权限；完成缓存与分页策略设计。

- **迭代1（P0，5天）** —— “双视图+概览首发”
  - Day1：实现 `CompletenessOverviewProvider` 与 Facade 基础骨架，打通分页查询、缓存。
  - Day2：重构 `completeness_check` 视图与模板，完成项目/个人视图切换、KPI 卡片。
  - Day3：接入性能埋点、压测概览接口；实现模态框骨架但暂不开放字段分析。
  - Day4：编写自动化/单测，验证分页、筛选、权限；准备迁移脚本。
  - Day5：联调+灰度上线，仅开放概览与进度条。

- **迭代2（P0+，5天）** —— “字段配置+详情增强”
  - Day6：实现 `CompletenessDetailProvider` 与 `FieldFillRateProvider`，串联延迟加载接口。
  - Day7：完成字段配置模态框、历史版本、权限校验，打通缓存失效。
  - Day8：补齐关联异常展示、快速跳转、导出能力。
  - Day9：全量联调+性能回归，验证配置变更对缓存的影响。
  - Day10：业务试运行、收集反馈，视情况开启全量。

- **迭代3（预留2天，可选）**：应对上线反馈、补充拖拽排序/趋势分析等优化项。

### 6.2 优先级与里程碑

| 优先级 | 交付物 | 里程碑 |
|--------|--------|--------|
| **P0** | 双视图、分页概览、KPI卡片、性能监控 | 迭代1结束 |
| **P0+** | 详情模态框（字段分析+不完整记录+关联异常）、字段配置（含版本/权限/回滚） | 迭代2结束 |
| **P1** | 拖拽排序、字段模板、趋势分析、导出优化 | 迭代3或后续版本 |
| **P2** | 移动端适配、智能推荐缺失字段等增强 | 需求评审后排期 |

每个阶段均需完成：功能自测 → QA 回归 → 业务验收 → 发布评审，确保交付节奏与质量可控。

---

## 七、验收标准

七、验收标准

### 7.1 功能验收

- [ ] **F1**: 项目视图正确展示所有项目及齐全性统计
- [ ] **F2**: 个人视图正确展示所有经办人统计
- [ ] **F3**: 视图切换功能正常，数据正确更新
- [ ] **F4**: 点击"查看详情"弹出模态框，显示统计卡片、字段分析、不完整记录
- [ ] **F5**: 全局筛选正确影响两个视图的数据范围
- [ ] **F6**: 字段配置按钮显著可见
- [ ] **F7**: 字段配置模态框正常打开，支持勾选/取消勾选
- [ ] **F8**: 配置保存后自动刷新，统计数据更新
- [ ] **F9**: 字段级分析正确显示每个字段的填写率
- [ ] **F10**: 进度条可视化正确展示齐全率

### 7.2 数据准确性验收

- [ ] **D1**: 齐全率计算准确（只统计启用字段）
- [ ] **D2**: KPI卡片数据与详细统计表数据一致
- [ ] **D3**: 字段填写率统计准确
- [ ] **D4**: 关联异常检测准确
- [ ] **D5**: 配置修改立即生效，计算结果正确

### 7.3 性能验收

| 指标 | 目标值 | 测试方法 |
|------|--------|---------|
| 页面首次加载 | < 2秒 | Chrome DevTools |
| 视图切换响应 | < 1秒 | 实际测试 |
| 详情模态框打开 | < 500ms | 实际测试 |
| 配置模态框打开 | < 300ms | 实际测试 |
| 配置保存响应 | < 1秒 | 实际测试 |

### 7.4 用户体验验收

- [ ] **U1**: 界面布局与归档监控保持一致风格
- [ ] **U2**: 交互流程流畅，无需多次点击
- [ ] **U3**: 字段配置入口明显易找
- [ ] **U4**: 进度条可视化直观易懂
- [ ] **U5**: 错误提示友好
- [ ] **U6**: 响应式设计良好

---

## 八、风险评估与应对

### 8.1 技术风险

#### 风险1: 字段配置治理与权限控制
**风险等级**: 中  
**影响**: 缺少范围、权限、历史记录易造成误配或追责困难  
**应对措施**:
- 按“组织+模块”存储配置并继承，避免全局误伤。
- 按角色控制入口，接口强制校验 `can_manage_completeness_field`。
- 记录版本与操作者，暴露恢复默认与回滚能力。

#### 风险2: 大数据量下的性能瓶颈
**风险等级**: 中  
**影响**: 同时查询数百项目/经办人可能拉长响应、影响体验  
**应对措施**:
- 强制服务器端分页（项目20条/页、人员30条/页）+ 缓存。
- 详情接口延迟加载，并对字段统计结果设置短缓存。
- 在迭代1/2结束前分别进行压测，确认95线指标。

### 8.2 业务风险

#### 风险3: 用户不了解字段策略导致误操作
**风险等级**: 低  
**影响**: 勾选/取消字段后未预期，导致统计口径混乱  
**应对措施**:
- 模态框内提供“适用范围”提示与影响预览。
- 支持模拟计算（保存前显示影响记录数）。
- 推出短视频或指引文档，培训关键用户。

#### 风险4: 配置变更影响历史对比
**风险等级**: 中  
**影响**: 字段口径变化后无法复原历史报表  
**应对措施**:
- 版本号写入统计结果，报表导出附带字段列表。
- 支持按选定版本回放（导出时可指定版本）。
- 建议在一个统计周期内固定配置，变更需审批。

---

## 九、图表设计详解

### 9.1 为什么不使用散点图？

**散点图的适用场景**：
- ✅ 归档监控：X轴=归档完成时间，Y轴=归档周期天数
- ✅ 工作周期监控：X轴=业务完成时间，Y轴=工作周期天数
- ❌ 齐全性检查：**没有时间维度**，齐全率是当前状态快照

**齐全性检查的特点**：
1. **静态指标**：齐全率是当前数据的完整性状态，不是随时间变化的趋势
2. **对比需求**：需要对比各项目/经办人之间的齐全率高低
3. **多维度**：需要同时展示采购齐全率、合同齐全率、综合齐全率
4. **字段级分析**：需要展示每个字段的填写率

### 9.2 推荐的图表类型

#### 9.2.1 主页面概览 - 横向条形图（Horizontal Bar Chart）

**使用场景**：项目/经办人齐全率排名

**示例**：
```
项目A  采购 ████████████████░░░░ 80%  合同 ██████████████████░░ 90%
项目B  采购 ██████████████████░░ 90%  合同 ████████████████████ 100%
项目C  采购 ████████████░░░░░░░░ 60%  合同 ██████████████░░░░░░ 70%
```

**优势**：
- ✅ 直观对比各项目齐全率高低
- ✅ 支持采购/合同双条并列显示
- ✅ 长度直观表示百分比
- ✅ 易于识别最高分和最低分
- ✅ 支持排序（按综合齐全率）

**技术实现**：ApexCharts 横向条形图
```javascript
{
    chart: { type: 'bar', horizontal: true },
    series: [
        { name: '采购齐全率', data: [80, 90, 60] },
        { name: '合同齐全率', data: [90, 100, 70] }
    ],
    xaxis: { max: 100, labels: { formatter: val => val + '%' } }
}
```

#### 9.2.2 详情模态框 - 组合图表

**图表1：齐全率对比 - 横向条形图**

展示该项目/经办人的采购、合同、综合齐全率：
```
采购齐全率  ████████████████░░░░  83.3% (25/30)
合同齐全率  ██████████████████░░  90.0% (18/20)
综合齐全率  █████████████████░░░  86.7% (43/50)
```

**图表2：字段填写率 - 雷达图（Radar Chart）**

展示各字段的填写率分布，快速识别薄弱环节：
```
        中标人(100%)
           /\
          /  \
   联系方式  金额
   (83%)    (100%)
        \  /
         \/
    评标委员会(67%)
```

**优势**：
- ✅ 多维度对比，一目了然
- ✅ 快速识别填写率最低的字段
- ✅ 视觉冲击力强

**技术实现**：ApexCharts 雷达图
```javascript
{
    chart: { type: 'radar' },
    series: [{
        name: '字段填写率',
        data: [100, 100, 83, 67, 90]
    }],
    xaxis: {
        categories: ['中标人', '中标金额', '联系方式', '评标委员会', '付款方式']
    },
    yaxis: { max: 100 }
}
```

**图表3：字段填写率详情 - 横向条形图**

详细列出每个字段的填写率：
```
中标人          100%  ████████████████████ 30/30
中标金额        100%  ████████████████████ 30/30
中标人联系方式  83.3% ████████████████░░░░ 25/30
评标委员会      66.7% █████████████░░░░░░░ 20/30
付款方式        90.0% ██████████████████░░ 27/30
```

**优势**：
- ✅ 精确显示每个字段的填写情况
- ✅ 显示具体数值（已填写/总数）
- ✅ 支持按填写率排序

#### 9.2.3 不完整记录分布 - 堆叠条形图（Stacked Bar Chart）

展示完整/不完整记录的分布：
```
采购  ████████████████████░░░░░░  25条完整  5条不完整
合同  ████████████████████████░░  18条完整  2条不完整
```

**优势**：
- ✅ 直观显示完整率
- ✅ 同时显示完整和不完整的数量
- ✅ 支持对比采购和合同

### 9.3 图表选择对比表

| 监控类型 | 主要图表 | X轴含义 | Y轴含义 | 适用原因 |
|---------|---------|---------|---------|---------|
| **归档监控** | 散点图 | 归档完成时间 | 归档周期天数 | 有时间维度，展示趋势 |
| **工作周期监控** | 散点图 | 业务完成时间 | 工作周期天数 | 有时间维度，展示趋势 |
| **齐全性检查** | 横向条形图 | 齐全率百分比 | 项目/经办人 | 无时间维度，对比排名 |
| **齐全性检查（字段）** | 雷达图 + 条形图 | 填写率 | 字段名称 | 多维度对比，识别短板 |

### 9.4 前端实现建议

**主页面概览图表**：
```javascript
function renderCompletenessOverview(data) {
    const options = {
        chart: {
            type: 'bar',
            height: 400,
            horizontal: true
        },
        series: [
            {
                name: '采购齐全率',
                data: data.map(item => item.procurement_rate)
            },
            {
                name: '合同齐全率',
                data: data.map(item => item.contract_rate)
            }
        ],
        xaxis: {
            categories: data.map(item => item.name),
            max: 100,
            labels: {
                formatter: function(val) {
                    return val + '%';
                }
            }
        },
        plotOptions: {
            bar: {
                horizontal: true,
                dataLabels: {
                    position: 'top'
                }
            }
        },
        colors: ['#0d6efd', '#198754']
    };
    
    const chart = new ApexCharts(document.querySelector("#overview-chart"), options);
    chart.render();
}
```

**详情模态框雷达图**：
```javascript
function renderFieldRadar(fieldStats) {
    const options = {
        chart: {
            type: 'radar',
            height: 350
        },
        series: [{
            name: '字段填写率',
            data: fieldStats.map(f => f.fill_rate)
        }],
        xaxis: {
            categories: fieldStats.map(f => f.field_label)
        },
        yaxis: {
            max: 100,
            tickAmount: 5
        },
        markers: {
            size: 4
        },
        fill: {
            opacity: 0.2
        }
    };
    
    const chart = new ApexCharts(document.querySelector("#field-radar"), options);
    chart.render();
}
```

## 十、与归档监控的对比分析

### 10.1 相似点（继承的设计）

**设计模式**：
- ✅ 双视图模式（项目视图/个人视图）
- ✅ 概览统计表格
- ✅ 详情模态框展示
- ✅ URL参数管理
- ✅ 全局筛选集成

**交互方式**：
- ✅ 视图切换器
- ✅ 查看详情按钮
- ✅ 模态框自动弹出
- ✅ 进度条可视化

### 10.2 差异点（新增的特色）

**字段配置功能**：
- ⭐ 齐全性检查独有功能
- ⭐ 支持动态调整统计范围
- ⭐ 配置立即生效

**字段级分析**：
- ⭐ 显示每个字段的填写率
- ⭐ 雷达图 + 条形图组合展示
- ⭐ 识别最薄弱环节

**关联异常**：
- ⭐ 齐全性检查保留此功能
- ⭐ 归档监控无此功能

**图表类型**：
- ⭐ 归档监控：散点图（时间趋势）
- ⭐ 齐全性检查：横向条形图 + 雷达图（状态对比）

### 10.3 统计维度对比

| 对比项 | 归档监控 | 齐全性检查 |
|--------|---------|-----------|
| 核心指标 | 归档周期、归档率 | 字段齐全率 |
| 业务模块 | 采购、合同 | 采购、合同 |
| 特色功能 | 周期散点图 | 字段配置、雷达图分析 |
| 视图模式 | 项目视图、个人视图 | 项目视图、个人视图 |
| 详情展示 | 模态框 | 模态框 |
| 判断标准 | 规定天数内归档 | 所有启用字段已填写 |
| 配置功能 | 无 | 字段配置 |
| 图表类型 | 散点图（时间维度） | 条形图+雷达图（对比维度） |

---

## 十一、总结与建议

### 11.1 核心要点

1. **设计一致性**：严格参照归档监控的成功设计，保持系统一致性
2. **功能创新**：新增字段配置功能，满足用户灵活配置需求
3. **数据精准**：字段级分析帮助识别数据质量薄弱环节
4. **交互友好**：模态框展示，页面简洁不冗杂

### 11.2 图表设计要点

1. **主页面使用横向条形图**：最适合齐全率对比和排名展示
2. **详情使用雷达图**：快速识别字段填写率的薄弱环节
3. **不使用散点图**：齐全性检查没有时间维度，散点图不适用
4. **保持一致性**：与归档监控保持相同的双视图架构和交互模式

### 11.3 实施建议

**优先级推荐**：
1. **第一阶段**：实现双视图模式和概览表格（P0功能）
2. **第二阶段**：实现详情模态框和字段级分析（P0+P1功能）
3. **第三阶段**：集成字段配置功能（P0功能）
4. **第四阶段**：优化用户体验和性能（P2功能）

**成功关键因素**：
- 复用归档监控的成功代码模式
- 充分利用现有的技术基础（CompletenessFieldConfig模型、completeness.py服务）
- 保持服务层、视图层、模板层的清晰分离
- 充分的测试和用户反馈

### 11.4 后续优化方向

**短期优化（1-2周）**：
- 优化字段配置交互（拖拽排序）
- 添加配置预设模板
- 完善移动端适配

**中期优化（1-2月）**：
- 字段齐全率趋势分析
- 支持导出齐全性报告
- 添加字段填写建议

**长期规划（3-6月）**：
- 配置版本管理
- 智能提醒（低齐全率预警）
- 与归档监控数据联动分析

---

## 十二、附录

### 附录A：URL参数设计

```
# 齐全性检查主页
/monitoring/completeness/?view_mode=project&target_code=PRJ001&year=2024

参数说明：
- view_mode: project|person (视图模式)
- target_code: 项目编码或经办人姓名
- year: 年度筛选
- project: 项目筛选

# 字段配置
/monitoring/completeness-field-config/?model_type=procurement

参数说明：
- model_type: procurement|contract (模型类型)
```

### 附录B：数据表关系

```
齐全性检查涉及的数据表：
- Procurement (采购)
- Contract (合同)
- Project (项目)
- CompletenessFieldConfig (字段配置)

关键字段：
- CompletenessFieldConfig.model_type: 模型类型
- CompletenessFieldConfig.field_name: 字段名称
- CompletenessFieldConfig.is_enabled: 是否启用
- CompletenessFieldConfig.sort_order: 排序
```

### 附录C：齐全率计算示例

**示例1：记录齐全**
```
采购记录 P001：
- 启用字段：中标人、中标金额、联系方式、评标委员会、付款方式（5个）
- 已填写字段：5个全部填写
- 齐全率 = 5/5 = 100%
```

**示例2：记录不齐全**
```
采购记录 P002：
- 启用字段：中标人、中标金额、联系方式、评标委员会、付款方式（5个）
- 已填写字段：中标人✓、中标金额✓、联系方式✗、评标委员会✗、付款方式✓
- 齐全率 = 3/5 = 60%
- 缺失字段：联系方式、评标委员会
```

**示例3：模块齐全率**
```
某项目采购统计：
- 总记录：30条
- 100%齐全：25条
- 60-99%齐全：3条
- <60%齐全：2条
- 模块齐全率 = 25/30 = 83.3%
```

### 附录D：与归档监控代码对比

**服务层对比**：
```python
# 归档监控
class ArchiveStatisticsService:
    def get_projects_archive_overview()
    def get_persons_archive_overview()
    def get_project_trend_and_problems()
    def get_person_trend_and_problems()

# 齐全性检查（新增）
class CompletenessStatisticsService:
    def get_projects_completeness_overview()
    def get_persons_completeness_overview()
    def get_project_completeness_detail()
    def get_person_completeness_detail()
```

**视图层对比**：
```python
# 归档监控
def archive_monitor(request):
    view_mode = request.GET.get('view_mode', 'project')
    target_code = request.GET.get('target_code', '')
    # ...

# 齐全性检查（参照实现）
def completeness_check(request):
    view_mode = request.GET.get('view_mode', 'project')
    target_code = request.GET.get('target_code', '')
    # ...
```

---

## 文档更新记录

| 日期 | 版本 | 更新内容 | 更新人 |
|------|------|----------|--------|
| 2025-01-12 | v1.0 | 创建完整需求方案文档 | Documentation Writer |

---

## 审批流程

| 审批角色 | 审批人 | 审批日期 | 审批意见 |
|---------|--------|---------|---------|
| 需求提出人 | 待填写 | 待填写 | 待审批 |
| 技术负责人 | 待填写 | 待填写 | 待审批 |
| 项目经理 | 待填写 | 待填写 | 待审批 |

---

**文档状态**：✅ 待审核

**下一步行动**：
1. 召开需求评审会，确认方案可行性
2. 评估开发工作量和时间安排（预计6-8天）
3. 

获得批准后进入开发阶段
4. 分配开发资源，启动项目

---

**重点提示**：

⚠️ **字段配置是本次改造的核心新增功能**，需要重点关注：
1. 配置入口要显著易见
2. 配置操作要简单直观
3. 配置修改要立即生效
4. 配置逻辑要准确无误

✅ **参照归档监控的成功经验**，可以大幅降低开发风险：
1. 复用服务层架构设计
2. 复用视图层参数处理
3. 复用模板层布局风格
4. 复用前端交互逻辑

📊 **预期效果**：
- 用户可以清晰看到各项目/经办人的齐全性排名
- 用户可以深入查看具体哪些字段填写率低
- 用户可以灵活配置统计范围，满足不同阶段的管理需求
- 页面简洁不冗杂，信息层次清晰

---

*本文档最后更新: 2025-01-12*
