# é¡¹ç›®é‡‡è´­ä¸æˆæœ¬ç®¡ç†ç³»ç»Ÿ - ç³»ç»Ÿæ¶æ„åˆ†ææ–‡æ¡£

## æ–‡æ¡£ä¿¡æ¯

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0  
**åˆ›å»ºæ—¥æœŸï¼š** 2025-10-21  
**åˆ†æèŒƒå›´ï¼š** å…¨ç³»ç»Ÿæ¶æ„ã€æ•°æ®æ¨¡å‹ã€ä¸šåŠ¡æµç¨‹  
**åˆ†ææ–¹æ³•ï¼š** ä»£ç è§£æ„ä¸ä¸šåŠ¡åˆ†æ  

---

## 1. ç³»ç»Ÿæ¦‚è¿°

### 1.1 ç³»ç»Ÿå®šä½

é¡¹ç›®é‡‡è´­ä¸æˆæœ¬ç®¡ç†ç³»ç»Ÿæ˜¯ä¸€å¥—éƒ¨ç½²åœ¨å…¬å¸å†…éƒ¨å±€åŸŸç½‘çš„è½»é‡çº§æ•°æ®ç®¡ç†å¹³å°ï¼Œä¸“æ³¨äºå°†åˆ†æ•£åœ¨å¤šä¸ªExcelæ–‡ä»¶ä¸­çš„é‡‡è´­ã€åˆåŒã€ä»˜æ¬¾ã€ç»“ç®—åŠä¾›åº”å•†è¯„ä»·æ•°æ®è¿›è¡Œé›†ä¸­åŒ–ã€ç»“æ„åŒ–ç®¡ç†ã€‚

### 1.2 æ ¸å¿ƒä»·å€¼

- âœ… **æ•°æ®é›†ä¸­åŒ–**ï¼šæ¶ˆé™¤Excelåˆ†æ•£ç®¡ç†çš„ç—›ç‚¹
- âœ… **ä¸šåŠ¡æµç¨‹åŒ–**ï¼šå»ºç«‹é‡‡è´­â†’åˆåŒâ†’ä»˜æ¬¾â†’ç»“ç®—çš„å®Œæ•´é“¾æ¡
- âœ… **æŸ¥è¯¢ä¾¿æ·åŒ–**ï¼šæä¾›å¤šç»´åº¦ã€ç©¿é€å¼æ•°æ®æŸ¥è¯¢èƒ½åŠ›
- âœ… **å¯¼å…¥æ™ºèƒ½åŒ–**ï¼šæ”¯æŒé•¿è¡¨å’Œå®½è¡¨ä¸¤ç§å†å²æ•°æ®æ ¼å¼

### 1.3 æŠ€æœ¯å®šä½

é‡‡ç”¨**æ¸è¿›å¼æŠ€æœ¯æ–¹æ¡ˆ**ï¼Œä»æœ€ç®€å•çš„Django Admin + SQLiteå¼€å§‹ï¼Œæ ¹æ®å®é™…éœ€è¦é€æ­¥å‡çº§ã€‚å½“å‰ä¸ºMVPé˜¶æ®µï¼Œä¸“æ³¨åŠŸèƒ½å®ç°è€ŒéæŠ€æœ¯å¤æ‚æ€§ã€‚

---

## 2. æŠ€æœ¯æ¶æ„å…¨æ™¯

### 2.1 æŠ€æœ¯æ ˆé€‰æ‹©

```mermaid
graph TB
    subgraph "å‰ç«¯å±‚"
        A[Django Admin] --> B[ç®¡ç†åå°ç•Œé¢]
        C[HTMLæ¨¡æ¿] --> D[ç®€å•å‰ç«¯é¡µé¢]
    end
    
    subgraph "åº”ç”¨å±‚"
        E[Django 5.2.7] --> F[é¡¹ç›®è·¯ç”±]
        G[ä¸šåŠ¡è§†å›¾] --> H[æ•°æ®ç®¡ç†]
    end
    
    subgraph "æ¨¡å‹å±‚"
        I[é¡¹ç›®æ¨¡å‹] --> J[é‡‡è´­æ¨¡å‹]
        K[åˆåŒæ¨¡å‹] --> L[ä»˜æ¬¾æ¨¡å‹]
        M[ç»“ç®—æ¨¡å‹] --> N[ä¾›åº”å•†è¯„ä»·æ¨¡å‹]
    end
    
    subgraph "æ•°æ®å±‚"
        O[SQLite 3.x] --> P[æ–‡ä»¶æ•°æ®åº“]
        Q[è‡ªåŠ¨å¤‡ä»½] --> R[æ•°æ®å®‰å…¨]
    end
    
    subgraph "å·¥å…·å±‚"
        S[Pandas 2.3.3] --> T[Excelå¤„ç†]
        U[openpyxl 3.1.5] --> V[æ–‡ä»¶è§£æ]
    end
    
    A --> E
    E --> I
    I --> O
    E --> S
```

### 2.2 æ¶æ„è®¾è®¡åŸåˆ™

| åŸåˆ™ | ä½“ç° | è¯´æ˜ |
|------|------|------|
| **KISSï¼ˆç®€å•è‡³ä¸Šï¼‰** | Django Admin + SQLite | é€‰æ‹©æœ€ç®€å•å¯è¡Œçš„æŠ€æœ¯æ–¹æ¡ˆ |
| **YAGNIï¼ˆä½ ä¸éœ€è¦å®ƒï¼‰** | åŠŸèƒ½æœ€å°åŒ– | åªå®ç°å½“å‰æ˜ç¡®éœ€è¦çš„åŠŸèƒ½ |
| **DRYï¼ˆæœç»é‡å¤ï¼‰** | BaseModelæŠ½è±¡ç±» | æå–é€šç”¨çš„å®¡è®¡å­—æ®µ |
| **SOLIDï¼ˆåšå®åŸºç¡€ï¼‰** | æ¨¡å‹å•ä¸€èŒè´£ | æ¯ä¸ªæ¨¡å‹ä¸“æ³¨äºç‰¹å®šä¸šåŠ¡é¢†åŸŸ |

### 2.3 éƒ¨ç½²æ¶æ„

```
å±€åŸŸç½‘ç¯å¢ƒ (192.168.x.x)
â”œâ”€â”€ ç”¨æˆ·æµè§ˆå™¨
â”‚   â”œâ”€â”€ ç³»ç»Ÿç®¡ç†å‘˜ (1äºº)
â”‚   â””â”€â”€ æ¨¡å—æ•°æ®ç®¡ç†å‘˜ (éƒ¨é—¨è´Ÿè´£äºº)
â””â”€â”€ åº”ç”¨æœåŠ¡å™¨ (Windows Server/PC)
    â”œâ”€â”€ Djangoå¼€å‘æœåŠ¡å™¨ (0.0.0.0:8000)
    â”œâ”€â”€ SQLiteæ•°æ®åº“æ–‡ä»¶
    â””â”€â”€ å®šæ—¶å¤‡ä»½ä»»åŠ¡
```

---

## 3. æ¨¡å—æ¶æ„åˆ†æ

### 3.1 æ¨¡å—ä¾èµ–å…³ç³»

```mermaid
graph TD
    subgraph "æ ¸å¿ƒä¸šåŠ¡æ¨¡å—"
        A[projecté¡¹ç›®ç®¡ç†] --> B[procurementé‡‡è´­ç®¡ç†]
        B --> C[contractåˆåŒç®¡ç†]
        C --> D[paymentä»˜æ¬¾ç®¡ç†]
        C --> E[settlementç»“ç®—ç®¡ç†]
        C --> F[supplier_evalä¾›åº”å•†è¯„ä»·]
    end
    
    subgraph "åŸºç¡€æ”¯æ’‘æ¨¡å—"
        G[configé…ç½®ç®¡ç†] --> A
        H[projectè§†å›¾] --> I[æ¨¡æ¿æ¸²æŸ“]
        J[BaseModelæŠ½è±¡åŸºç±»] --> A
        J --> B
        J --> C
        J --> D
        J --> E
        J --> F
    end
```

### 3.2 æ¨¡å—èŒè´£åˆ’åˆ†

| æ¨¡å— | æ ¸å¿ƒèŒè´£ | å…³é”®ç±» | å¤–éƒ¨ä¾èµ– |
|------|----------|--------|----------|
| **project** | é¡¹ç›®ä¿¡æ¯ç®¡ç†ï¼Œä½œä¸ºä¸šåŠ¡æ•°æ®çš„ç»„ç»‡å®¹å™¨ | `Project` | æ—  |
| **procurement** | é‡‡è´­å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œä»éœ€æ±‚åˆ°ä¸­æ ‡ | `Procurement` | Project |
| **contract** | åˆåŒä¿¡æ¯ç®¡ç†ï¼Œæ”¯æŒä¸»åˆåŒå’Œè¡¥å……åè®® | `Contract` | Project, Procurement |
| **payment** | ä»˜æ¬¾è®°å½•ç®¡ç†ï¼Œæ”¯æŒç»“ç®—æ ‡è®° | `Payment` | Contract |
| **settlement** | ç»“ç®—ä¿¡æ¯ç®¡ç†ï¼Œä¸€å¯¹ä¸€å…³è”ä¸»åˆåŒ | `Settlement` | Contract |
| **supplier_eval** | ä¾›åº”å•†å±¥çº¦è¯„ä»·ç®¡ç† | `SupplierEvaluation` | Contract |

---

## 4. æ•°æ®æ¨¡å‹æ¶æ„

### 4.1 æ ¸å¿ƒæ•°æ®å…³ç³»

```mermaid
erDiagram
    Project ||--o{ Procurement : "1:N"
    Project ||--o{ Contract : "1:N"
    Procurement ||--o{ Contract : "1:N"
    Contract ||--o{ Payment : "1:N"
    Contract ||--o{ SupplierEvaluation : "1:N"
    Contract ||--|| Settlement : "1:1"
    Contract ||--o{ Contract : "1:N(è¡¥å……åè®®)"
    
    Project {
        string project_code PK
        string project_name
        string project_manager
        string status
        datetime created_at
        datetime updated_at
    }
    
    Procurement {
        string procurement_code PK
        string project_name
        string procurement_unit
        string winning_bidder
        decimal budget_amount
        decimal winning_amount
        date bid_opening_date
        string procurement_officer
        datetime created_at
        datetime updated_at
    }
    
    Contract {
        string contract_code PK
        string contract_name
        string file_positioning
        string contract_source
        string parent_contract_id FK
        string procurement_id FK
        string project_id FK
        string party_a
        string party_b
        decimal contract_amount
        date signing_date
        datetime created_at
        datetime updated_at
    }
    
    Payment {
        string payment_code PK
        string contract_id FK
        decimal payment_amount
        date payment_date
        decimal settlement_amount
        boolean is_settled
        datetime created_at
        datetime updated_at
    }
    
    Settlement {
        string settlement_code PK
        string main_contract_id FK
        decimal final_amount
        date completion_date
        datetime created_at
        datetime updated_at
    }
    
    SupplierEvaluation {
        string evaluation_code PK
        string contract_id FK
        string supplier_name
        string evaluation_period
        decimal score
        string evaluation_type
        datetime created_at
        datetime updated_at
    }
```

### 4.2 ç»§æ‰¿ä½“ç³»è®¾è®¡

```mermaid
classDiagram
    class BaseModel {
        +datetime created_at
        +datetime updated_at
        +string created_by
        +string updated_by
    }
    
    class Project {
        +string project_code PK
        +string project_name
        +string project_manager
        +string status
        +string description
        +string remarks
    }
    
    class Procurement {
        +string procurement_code PK
        +string project_name
        +string procurement_unit
        +string winning_bidder
        +decimal budget_amount
        +decimal winning_amount
        +date bid_opening_date
    }
    
    class Contract {
        +string contract_code PK
        +string contract_name
        +string file_positioning
        +string contract_source
        +string party_a
        +string party_b
        +decimal contract_amount
        +date signing_date
    }
    
    class Payment {
        +string payment_code PK
        +decimal payment_amount
        +date payment_date
        +decimal settlement_amount
        +boolean is_settled
    }
    
    class Settlement {
        +string settlement_code PK
        +decimal final_amount
        +date completion_date
    }
    
    class SupplierEvaluation {
        +string evaluation_code PK
        +string supplier_name
        +string evaluation_period
        +decimal score
        +string evaluation_type
    }
    
    BaseModel <|-- Project
    BaseModel <|-- Procurement
    BaseModel <|-- Contract
    BaseModel <|-- Payment
    BaseModel <|-- Settlement
    BaseModel <|-- SupplierEvaluation
```

---

## 5. æ ¸å¿ƒä¸šåŠ¡æµç¨‹æ—¶åºå›¾

### 5.1 é‡‡è´­åˆ°ä»˜æ¬¾å®Œæ•´æµç¨‹

```mermaid
sequenceDiagram
    actor ç”¨æˆ·
    participant å‰ç«¯é¡µé¢
    participant è§†å›¾å±‚
    participant é‡‡è´­æ¨¡å‹
    participant åˆåŒæ¨¡å‹
    participant ä»˜æ¬¾æ¨¡å‹
    participant æ•°æ®åº“

    Note over ç”¨æˆ·,æ•°æ®åº“: é‡‡è´­ç®¡ç†æµç¨‹
    ç”¨æˆ·->>å‰ç«¯é¡µé¢: åˆ›å»ºé‡‡è´­é¡¹ç›®
    å‰ç«¯é¡µé¢->>è§†å›¾å±‚: POST /procurement/create
    è§†å›¾å±‚->>é‡‡è´­æ¨¡å‹: Procurement.objects.create()
    é‡‡è´­æ¨¡å‹->>æ•°æ®åº“: INSERT procurement
    æ•°æ®åº“-->>é‡‡è´­æ¨¡å‹: è¿”å›åˆ›å»ºç»“æœ
    é‡‡è´­æ¨¡å‹-->>è§†å›¾å±‚: è¿”å›é‡‡è´­å¯¹è±¡
    è§†å›¾å±‚-->>å‰ç«¯é¡µé¢: è¿”å›æˆåŠŸå“åº”
    å‰ç«¯é¡µé¢-->>ç”¨æˆ·: æ˜¾ç¤ºåˆ›å»ºæˆåŠŸ

    Note over ç”¨æˆ·,æ•°æ®åº“: åˆåŒç­¾è®¢æµç¨‹
    ç”¨æˆ·->>å‰ç«¯é¡µé¢: åˆ›å»ºåˆåŒ
    å‰ç«¯é¡µé¢->>è§†å›¾å±‚: POST /contract/create
    è§†å›¾å±‚->>åˆåŒæ¨¡å‹: Contract.objects.create()
    åˆåŒæ¨¡å‹->>é‡‡è´­æ¨¡å‹: å…³è”é‡‡è´­é¡¹ç›®(å¯é€‰)
    åˆåŒæ¨¡å‹->>æ•°æ®åº“: INSERT contract
    æ•°æ®åº“-->>åˆåŒæ¨¡å‹: è¿”å›åˆ›å»ºç»“æœ
    åˆåŒæ¨¡å‹-->>è§†å›¾å±‚: è¿”å›åˆåŒå¯¹è±¡
    è§†å›¾å±‚-->>å‰ç«¯é¡µé¢: è¿”å›æˆåŠŸå“åº”

    Note over ç”¨æˆ·,æ•°æ®åº“: ä»˜æ¬¾æ‰§è¡Œæµç¨‹
    ç”¨æˆ·->>å‰ç«¯é¡µé¢: åˆ›å»ºä»˜æ¬¾è®°å½•
    å‰ç«¯é¡µé¢->>è§†å›¾å±‚: POST /payment/create
    è§†å›¾å±‚->>ä»˜æ¬¾æ¨¡å‹: Payment.objects.create()
    ä»˜æ¬¾æ¨¡å‹->>ä»˜æ¬¾æ¨¡å‹: _generate_payment_code()
    ä»˜æ¬¾æ¨¡å‹->>æ•°æ®åº“: INSERT payment
    æ•°æ®åº“-->>ä»˜æ¬¾æ¨¡å‹: è¿”å›åˆ›å»ºç»“æœ
    ä»˜æ¬¾æ¨¡å‹-->>è§†å›¾å±‚: è¿”å›ä»˜æ¬¾å¯¹è±¡
    è§†å›¾å±‚-->>å‰ç«¯é¡µé¢: è¿”å›æˆåŠŸå“åº”
```

### 5.2 Excelæ•°æ®å¯¼å…¥æµç¨‹

```mermaid
sequenceDiagram
    actor ç”¨æˆ·
    participant å¯¼å…¥å‘½ä»¤
    participant æ–‡ä»¶å¤„ç†å™¨
    participant æ•°æ®éªŒè¯å™¨
    participant æ¨¡å‹å±‚
    participant æ•°æ®åº“

    ç”¨æˆ·->>å¯¼å…¥å‘½ä»¤: python manage.py import_excel file.xlsx
    å¯¼å…¥å‘½ä»¤->>æ–‡ä»¶å¤„ç†å™¨: æ£€æµ‹æ–‡ä»¶ç¼–ç 
    æ–‡ä»¶å¤„ç†å™¨-->>å¯¼å…¥å‘½ä»¤: è¿”å›ç¼–ç ä¿¡æ¯
    
    alt é•¿è¡¨æ¨¡å¼
        å¯¼å…¥å‘½ä»¤->>æ–‡ä»¶å¤„ç†å™¨: é€è¡Œè¯»å–CSV
        loop æ¯è¡Œæ•°æ®
            æ–‡ä»¶å¤„ç†å™¨->>æ•°æ®éªŒè¯å™¨: éªŒè¯å­—æ®µæ ¼å¼
            æ•°æ®éªŒè¯å™¨-->>æ–‡ä»¶å¤„ç†å™¨: éªŒè¯ç»“æœ
            æ–‡ä»¶å¤„ç†å™¨->>æ¨¡å‹å±‚: è°ƒç”¨update_or_create
            æ¨¡å‹å±‚->>æ•°æ®åº“: INSERTæˆ–UPDATE
            æ•°æ®åº“-->>æ¨¡å‹å±‚: è¿”å›æ“ä½œç»“æœ
        end
    else å®½è¡¨æ¨¡å¼
        å¯¼å…¥å‘½ä»¤->>æ–‡ä»¶å¤„ç†å™¨: ä½¿ç”¨pandasè¯»å–Excel
        æ–‡ä»¶å¤„ç†å™¨->>æ–‡ä»¶å¤„ç†å™¨: è¯†åˆ«æ—¥æœŸåˆ—
        æ–‡ä»¶å¤„ç†å™¨->>æ–‡ä»¶å¤„ç†å™¨: meltæ“ä½œ(å®½è¡¨è½¬é•¿è¡¨)
        loop è½¬æ¢åæ¯è¡Œ
            æ–‡ä»¶å¤„ç†å™¨->>æ•°æ®éªŒè¯å™¨: éªŒè¯è½¬æ¢ç»“æœ
            æ•°æ®éªŒè¯å™¨-->>æ–‡ä»¶å¤„ç†å™¨: éªŒè¯ç»“æœ
            æ–‡ä»¶å¤„ç†å™¨->>æ¨¡å‹å±‚: åˆ›å»ºæ•°æ®è®°å½•
            æ¨¡å‹å±‚->>æ•°æ®åº“: INSERT
            æ•°æ®åº“-->>æ¨¡å‹å±‚: è¿”å›åˆ›å»ºç»“æœ
        end
    end
    
    æ¨¡å‹å±‚-->>å¯¼å…¥å‘½ä»¤: è¿”å›ç»Ÿè®¡ç»“æœ
    å¯¼å…¥å‘½ä»¤-->>ç”¨æˆ·: æ˜¾ç¤ºå¯¼å…¥å®Œæˆä¿¡æ¯
```

---

## 6. å…³é”®è®¾è®¡æ¨¡å¼åˆ†æ

### 6.1 æŠ½è±¡åŸºç±»æ¨¡å¼ (Template Method)

**ä½ç½®ï¼š** [`procurement/models.py:BaseModel`](procurement/models.py:8)

**è®¾è®¡æ„å›¾ï¼š** æå–æ‰€æœ‰ä¸šåŠ¡æ¨¡å‹çš„é€šç”¨å®¡è®¡å­—æ®µï¼Œé¿å…ä»£ç é‡å¤

```python
class BaseModel(models.Model):
    created_at = models.DateTimeField('åˆ›å»ºæ—¶é—´', auto_now_add=True)
    updated_at = models.DateTimeField('æ›´æ–°æ—¶é—´', auto_now=True)
    created_by = models.CharField('åˆ›å»ºäºº', max_length=50, blank=True)
    updated_by = models.CharField('æ›´æ–°äºº', max_length=50, blank=True)
    
    class Meta:
        abstract = True  # æŠ½è±¡åŸºç±»ï¼Œä¸åˆ›å»ºæ•°æ®åº“è¡¨
        ordering = ['-created_at']
```

**ä¼˜åŠ¿åˆ†æï¼š**
- âœ… **DRYåŸåˆ™**ï¼šæ¶ˆé™¤é‡å¤çš„å®¡è®¡å­—æ®µå®šä¹‰
- âœ… **ä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰€æœ‰æ¨¡å‹éƒ½æœ‰ç›¸åŒçš„æ—¶é—´æˆ³å­—æ®µ
- âœ… **å¯ç»´æŠ¤æ€§**ï¼šä¿®æ”¹å®¡è®¡é€»è¾‘åªéœ€åœ¨ä¸€å¤„è¿›è¡Œ

### 6.2 ç­–ç•¥æ¨¡å¼ (Strategy Pattern)

**ä½ç½®ï¼š** [`procurement/management/commands/import_excel.py`](procurement/management/commands/import_excel.py:24)

**è®¾è®¡æ„å›¾ï¼š** æ”¯æŒå¤šç§æ•°æ®å¯¼å…¥ç­–ç•¥ï¼ˆé•¿è¡¨ã€å®½è¡¨ï¼‰

```python
class Command(BaseCommand):
    def handle(self, *args, **options):
        mode = options['mode']  # long æˆ– wide
        if mode == 'long':
            self._handle_long_table(...)
        else:
            self._handle_wide_table(...)
```

**ä¼˜åŠ¿åˆ†æï¼š**
- âœ… **å¼€é—­åŸåˆ™**ï¼šå¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯è½»æ¾æ·»åŠ æ–°çš„å¯¼å…¥æ¨¡å¼
- âœ… **å•ä¸€èŒè´£**ï¼šæ¯ç§å¯¼å…¥æ¨¡å¼æœ‰ç‹¬ç«‹çš„å¤„ç†é€»è¾‘
- âœ… **ç”¨æˆ·å‹å¥½**ï¼šé€šè¿‡å‘½ä»¤è¡Œå‚æ•°é€‰æ‹©ç­–ç•¥

### 6.3 å·¥å‚æ–¹æ³•æ¨¡å¼ (Factory Method)

**ä½ç½®ï¼š** [`payment/models.py:Payment._generate_payment_code()`](payment/models.py:78)

**è®¾è®¡æ„å›¾ï¼š** è‡ªåŠ¨ç”Ÿæˆä»˜æ¬¾ç¼–å·ï¼Œå°è£…ç¼–å·ç”Ÿæˆé€»è¾‘

```python
def _generate_payment_code(self):
    """ç”Ÿæˆä»˜æ¬¾ç¼–å·ï¼šåˆåŒåºå·-FK-åºå·"""
    contract_identifier = self.contract.contract_sequence or self.contract.contract_code
    # å¤æ‚çš„åºå·è®¡ç®—é€»è¾‘...
    return f"{contract_identifier}-FK-{sequence:03d}"
```

**ä¼˜åŠ¿åˆ†æï¼š**
- âœ… **å°è£…å¤æ‚æ€§**ï¼šéšè—ç¼–å·ç”Ÿæˆçš„å¤æ‚é€»è¾‘
- âœ… **ä¸€è‡´æ€§**ï¼šç¡®ä¿æ‰€æœ‰ä»˜æ¬¾ç¼–å·æ ¼å¼ç»Ÿä¸€
- âœ… **å¯ç»´æŠ¤æ€§**ï¼šä¿®æ”¹ç¼–å·è§„åˆ™åªéœ€ä¿®æ”¹ä¸€å¤„

---

## 7. æ•°æ®å®Œæ•´æ€§ä¿éšœæœºåˆ¶

### 7.1 å¤–é”®çº¦æŸç­–ç•¥

| å…³ç³»ç±»å‹ | çº¦æŸæ–¹å¼ | ä¿æŠ¤æœºåˆ¶ | ä¸šåŠ¡å«ä¹‰ |
|---------|----------|----------|----------|
| Project â†’ Procurement | `models.PROTECT` | ç¦æ­¢åˆ é™¤æœ‰é‡‡è´­çš„é¡¹ç›® | ä¿æŠ¤é¡¹ç›®æ•°æ®å®Œæ•´æ€§ |
| Procurement â†’ Contract | `models.PROTECT` | ç¦æ­¢åˆ é™¤æœ‰åˆåŒçš„é‡‡è´­ | ä¿æŠ¤é‡‡è´­æ•°æ®å®Œæ•´æ€§ |
| Contract â†’ Payment | `models.PROTECT` | ç¦æ­¢åˆ é™¤æœ‰ä»˜æ¬¾çš„åˆåŒ | ä¿æŠ¤åˆåŒæ•°æ®å®Œæ•´æ€§ |
| Contract â†’ Settlement | `models.OneToOne` | ä¸€å¯¹ä¸€å¼ºåˆ¶çº¦æŸ | ç¡®ä¿ç»“ç®—å”¯ä¸€æ€§ |

### 7.2 ä¸šåŠ¡è§„åˆ™éªŒè¯

**ä½ç½®ï¼š** [`contract/models.py:Contract.clean()`](contract/models.py:182)

```python
def clean(self):
    """ä¸šåŠ¡è§„åˆ™éªŒè¯"""
    errors = {}
    
    # è§„åˆ™1: è¡¥å……åè®®å¿…é¡»å…³è”ä¸»åˆåŒ
    if self.file_positioning == 'è¡¥å……åè®®' and not self.parent_contract:
        errors['parent_contract'] = 'è¡¥å……åè®®å¿…é¡»å…³è”ä¸»åˆåŒ'
    
    # è§„åˆ™2: é‡‡è´­åˆåŒå¿…é¡»å…³è”é‡‡è´­é¡¹ç›®
    if self.contract_source == 'é‡‡è´­åˆåŒ' and not self.procurement:
        errors['procurement'] = 'é‡‡è´­åˆåŒå¿…é¡»å…³è”é‡‡è´­é¡¹ç›®'
    
    if errors:
        raise ValidationError(errors)
```

**éªŒè¯æ—¶æœºï¼š**
- âœ… **ä¿å­˜å‰éªŒè¯**ï¼š`save()`æ–¹æ³•è°ƒç”¨`full_clean()`
- âœ… **AdminéªŒè¯**ï¼šDjango Adminè‡ªåŠ¨è°ƒç”¨éªŒè¯
- âœ… **å¯¼å…¥éªŒè¯**ï¼šæ•°æ®å¯¼å…¥æ—¶è¿›è¡Œæ‰¹é‡éªŒè¯

---

## 8. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 8.1 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

**ä½ç½®ï¼š** [`project/views.py:contract_list()`](project/views.py:202)

```python
# ä½¿ç”¨select_relatedå‡å°‘æ•°æ®åº“æŸ¥è¯¢
contracts = Contract.objects.select_related('project')

# ä½¿ç”¨prefetch_relatedä¼˜åŒ–åå‘å…³ç³»
contracts = Contract.objects.prefetch_related('payments', 'evaluations')

# æ·»åŠ æ•°æ®åº“ç´¢å¼•
class Contract(models.Model):
    signing_date = models.DateField(db_index=True)  # æ·»åŠ ç´¢å¼•
```

### 8.2 åˆ†é¡µæŸ¥è¯¢ç­–ç•¥

```python
# åˆ†é¡µå¤„ç†ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½è¿‡å¤šæ•°æ®
paginator = Paginator(contract_data, page_size)
page_obj = paginator.get_page(page)
```

### 8.3 æ‰¹é‡æ“ä½œä¼˜åŒ–

**ä½ç½®ï¼š** [`procurement/management/commands/import_excel.py`](procurement/management/commands/import_excel.py:252)

```python
# ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ‰¹é‡æ“ä½œçš„åŸå­æ€§
with transaction.atomic():
    result = self._import_long_row(row, module, conflict_mode)
```

---

## 9. å®‰å…¨æ€§è®¾è®¡

### 9.1 æ•°æ®è®¿é—®æ§åˆ¶

- âœ… **Adminæƒé™æ§åˆ¶**ï¼šåŸºäºDjango Adminçš„ç”¨æˆ·æƒé™ç³»ç»Ÿ
- âœ… **æ“ä½œå®¡è®¡**ï¼šæ‰€æœ‰æ¨¡å‹åŒ…å«åˆ›å»ºäººã€æ›´æ–°äººå­—æ®µ
- âœ… **æ•°æ®ä¿æŠ¤**ï¼šæ•æ„Ÿæ“ä½œéœ€è¦ç¡®è®¤ï¼ˆå¦‚åˆ é™¤æ•°æ®ï¼‰

### 9.2 è¾“å…¥éªŒè¯æœºåˆ¶

```python
# æ–‡ä»¶ç±»å‹éªŒè¯
if not uploaded_file.name.endswith('.csv'):
    return JsonResponse({'success': False, 'message': 'åªæ”¯æŒCSVæ–‡ä»¶æ ¼å¼'})

# æ•°æ®æ ¼å¼éªŒè¯
payment_amount = self._parse_decimal(row.get('å®ä»˜é‡‘é¢(å…ƒ)'))
if payment_amount is None:
    raise ValueError('å®ä»˜é‡‘é¢ä¸èƒ½ä¸ºç©º')
```

---

## 10. å¯æ‰©å±•æ€§è®¾è®¡

### 10.1 æ¨¡å—åŒ–æ¶æ„

æ¯ä¸ªä¸šåŠ¡æ¨¡å—ç‹¬ç«‹è®¾è®¡ï¼Œæ”¯æŒï¼š
- âœ… **ç‹¬ç«‹å¼€å‘**ï¼šæ¯ä¸ªæ¨¡å—å¯ç‹¬ç«‹å¼€å‘å’Œæµ‹è¯•
- âœ… **ç‹¬ç«‹éƒ¨ç½²**ï¼šæ¨¡å—ä¹‹é—´æ¾è€¦åˆï¼Œä¾¿äºæ‰©å±•
- âœ… **ç‹¬ç«‹ç»´æŠ¤**ï¼šä¿®æ”¹ä¸€ä¸ªæ¨¡å—ä¸å½±å“å…¶ä»–æ¨¡å—

### 10.2 æ¸è¿›å¼å‡çº§è·¯å¾„

```mermaid
graph LR
    A[é˜¶æ®µä¸€ï¼šMVP] --> B[é˜¶æ®µäºŒï¼šæ ‡å‡†ç‰ˆ]
    B --> C[é˜¶æ®µä¸‰ï¼šä¼ä¸šç‰ˆ]
    
    A --> A1[Django Admin]
    A --> A2[SQLite]
    A --> A3[å¼€å‘æœåŠ¡å™¨]
    
    B --> B1[Vue 3å‰ç«¯]
    B --> B2[Waitress]
    B --> B3[è‡ªå®šä¹‰ç•Œé¢]
    
    C --> C1[PostgreSQL]
    C --> C2[Nginx]
    C --> C3[é«˜å¯ç”¨éƒ¨ç½²]
```

---

## 11. ç³»ç»Ÿè¾¹ç•Œä¸é›†æˆç‚¹

### 11.1 å†…éƒ¨é›†æˆ

| é›†æˆç‚¹ | é›†æˆæ–¹å¼ | æ•°æ®æµå‘ | è¯´æ˜ |
|--------|----------|----------|------|
| é‡‡è´­â†’åˆåŒ | å¤–é”®å…³è” | 1:N | ä¸€ä¸ªé‡‡è´­å¯å¯¹åº”å¤šä¸ªåˆåŒ |
| åˆåŒâ†’ä»˜æ¬¾ | å¤–é”®å…³è” | 1:N | ä¸€ä¸ªåˆåŒå¯æœ‰å¤šç¬”ä»˜æ¬¾ |
| åˆåŒâ†’ç»“ç®— | OneToOne | 1:1 | ä¸»åˆåŒåªèƒ½æœ‰ä¸€æ¡ç»“ç®—è®°å½• |

### 11.2 å¤–éƒ¨é›†æˆ

| å¤–éƒ¨ç³»ç»Ÿ | é›†æˆæ–¹å¼ | æ•°æ®æ ¼å¼ | ç”¨é€” |
|----------|----------|----------|------|
| Excelæ–‡ä»¶ | æ–‡ä»¶å¯¼å…¥ | CSV/Excel | å†å²æ•°æ®è¿ç§» |
| OAç³»ç»Ÿ | æ‰‹åŠ¨å½•å…¥ | æ–‡æœ¬ | é‡‡è´­éœ€æ±‚å®¡æ‰¹æ—¥æœŸ |
| é˜³å…‰é‡‡è´­å¹³å° | æ‰‹åŠ¨å½•å…¥ | æ–‡æœ¬ | ä¸­æ ‡ç»“æœå…¬ç¤ºä¿¡æ¯ |

---

## 12. ç›‘æ§ä¸è¿ç»´

### 12.1 æ—¥å¿—è®°å½•

```python
import logging
logger = logging.getLogger(__name__)

# è®°å½•å¯¼å…¥è¿‡ç¨‹
logger.info(f'å¼€å§‹å¯¼å…¥æ–‡ä»¶: {file_path}')
logger.error(f'å¯¼å…¥å¤±è´¥: {str(e)}')
```

### 12.2 æ•°æ®å¤‡ä»½ç­–ç•¥

**ä½ç½®ï¼š** [`backup_db.py`](scripts/backup_db.py)

```python
def backup_database():
    """å¤‡ä»½SQLiteæ•°æ®åº“"""
    timestamp = datetime.datetime.now().strftime('%Y%m%d_%H%M%S')
    backup_file = os.path.join(backup_dir, f'db_backup_{timestamp}.sqlite3')
    shutil.copy2(source, backup_file)
```

### 12.3 å¥åº·æ£€æŸ¥

- âœ… **æ•°æ®åº“è¿æ¥æ£€æŸ¥**ï¼šéªŒè¯SQLiteæ•°æ®åº“å¯è®¿é—®æ€§
- âœ… **ç£ç›˜ç©ºé—´æ£€æŸ¥**ï¼šç¡®ä¿æœ‰è¶³å¤Ÿç©ºé—´è¿›è¡Œå¤‡ä»½
- âœ… **æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥**ï¼šå®šæœŸéªŒè¯å¤–é”®å…³ç³»å®Œæ•´æ€§

---

## 13. æ¶æ„è¯„ä¼°ä¸å»ºè®®

### 13.1 æ¶æ„ä¼˜åŠ¿

| ä¼˜åŠ¿ | å…·ä½“ä½“ç° | ä¸šåŠ¡ä»·å€¼ |
|------|----------|----------|
| **ç®€å•æ€§** | Django Admin + SQLite | å¿«é€Ÿä¸Šçº¿ï¼Œå­¦ä¹ æˆæœ¬ä½ |
| **å¯é æ€§** | äº‹åŠ¡ä¿æŠ¤ + å¤–é”®çº¦æŸ | æ•°æ®ä¸€è‡´æ€§å¼º |
| **å¯ç»´æŠ¤æ€§** | æ¨¡å—åŒ–è®¾è®¡ + æ¸…æ™°åˆ†å±‚ | æ˜“äºç†è§£å’Œä¿®æ”¹ |
| **å¯æ‰©å±•æ€§** | æ¸è¿›å¼å‡çº§è·¯å¾„ | æ”¯æŒä¸šåŠ¡å¢é•¿éœ€æ±‚ |

### 13.2 æ½œåœ¨é£é™©

| é£é™© | é£é™©ç­‰çº§ | ç¼“è§£æªæ–½ |
|------|----------|----------|
| **SQLiteå¹¶å‘é™åˆ¶** | ä¸­ç­‰ | åæœŸå¯å‡çº§åˆ°PostgreSQL |
| **Adminç•Œé¢é™åˆ¶** | ä½ | åæœŸå¯æ·»åŠ Vueå‰ç«¯ |
| **æ•°æ®é‡å¢é•¿** | ä½ | é¢„ç•™å‡çº§è·¯å¾„å’Œæ€§èƒ½ä¼˜åŒ–ç©ºé—´ |

### 13.3 æ”¹è¿›å»ºè®®

1. **çŸ­æœŸæ”¹è¿›ï¼ˆ1-3ä¸ªæœˆï¼‰**
   - æ·»åŠ æ•°æ®å¯¼å‡ºåŠŸèƒ½
   - ä¼˜åŒ–æ‰¹é‡å¯¼å…¥æ€§èƒ½
   - å¢å¼ºæ•°æ®éªŒè¯è§„åˆ™

2. **ä¸­æœŸæ”¹è¿›ï¼ˆ3-6ä¸ªæœˆï¼‰**
   - æ·»åŠ è‡ªå®šä¹‰å‰ç«¯ç•Œé¢
   - å®ç°æ•°æ®ç»Ÿè®¡åˆ†æåŠŸèƒ½
   - å¢åŠ ç”¨æˆ·æƒé™ç»†åˆ†

3. **é•¿æœŸæ”¹è¿›ï¼ˆ6ä¸ªæœˆä»¥ä¸Šï¼‰**
   - å‡çº§åˆ°PostgreSQLæ•°æ®åº“
   - å®ç°é«˜å¯ç”¨éƒ¨ç½²
   - æ·»åŠ APIæ¥å£æ”¯æŒ

---

## 14. æ€»ç»“

æœ¬ç³»ç»Ÿé‡‡ç”¨**æ¸è¿›å¼æ¶æ„è®¾è®¡**ï¼Œä»¥æœ€ç®€å•çš„æŠ€æœ¯æ–¹æ¡ˆæ»¡è¶³å½“å‰ä¸šåŠ¡éœ€æ±‚ï¼ŒåŒæ—¶é¢„ç•™æ¸…æ™°çš„å‡çº§è·¯å¾„ã€‚æ ¸å¿ƒç‰¹ç‚¹åŒ…æ‹¬ï¼š

### 14.1 æ¶æ„äº®ç‚¹

- âœ… **ä¸šåŠ¡é©±åŠ¨**ï¼šæ¶æ„è®¾è®¡ç´§å¯†å›´ç»•é‡‡è´­ç®¡ç†ä¸šåŠ¡æµç¨‹
- âœ… **æ•°æ®å®Œæ•´**ï¼šé€šè¿‡å¤–é”®çº¦æŸå’Œä¸šåŠ¡è§„åˆ™ç¡®ä¿æ•°æ®è´¨é‡
- âœ… **å¯¼å…¥æ™ºèƒ½**ï¼šæ”¯æŒé•¿è¡¨å’Œå®½è¡¨ä¸¤ç§å†å²æ•°æ®æ ¼å¼
- âœ… **æ‰©å±•å‹å¥½**ï¼šæ¨¡å—åŒ–è®¾è®¡æ”¯æŒæ¸è¿›å¼åŠŸèƒ½æ‰©å±•

### 14.2 æŠ€æœ¯å†³ç­–åˆç†æ€§

| å†³ç­– | ç†ç”± | æ•ˆæœ |
|------|------|------|
| Django Admin | å¿«é€Ÿå®ç°ç®¡ç†ç•Œé¢ | 2å‘¨å†…å®ŒæˆMVP |
| SQLite | é›¶é…ç½®ï¼Œæ˜“ç»´æŠ¤ | é™ä½è¿ç»´å¤æ‚åº¦ |
| BaseModel | æ¶ˆé™¤ä»£ç é‡å¤ | æé«˜ä»£ç è´¨é‡ |
| å®½è¡¨è½¬é•¿è¡¨ | è§£å†³å†å²æ•°æ®é—®é¢˜ | é™ä½æ•°æ®è¿ç§»æˆæœ¬ |

### 14.3 ä¸šåŠ¡ä»·å€¼å®ç°

é€šè¿‡åˆç†çš„æ¶æ„è®¾è®¡ï¼Œç³»ç»ŸæˆåŠŸå®ç°äº†ï¼š
- ğŸ¯ **æ•°æ®é›†ä¸­åŒ–ç®¡ç†**ï¼šæ¶ˆé™¤Excelåˆ†æ•£ç®¡ç†ç—›ç‚¹
- ğŸ¯ **ä¸šåŠ¡æµç¨‹æ ‡å‡†åŒ–**ï¼šå»ºç«‹é‡‡è´­â†’åˆåŒâ†’ä»˜æ¬¾å®Œæ•´é“¾æ¡
- ğŸ¯ **å†å²æ•°æ®å¹³æ»‘è¿ç§»**ï¼šæ™ºèƒ½è½¬æ¢åŠŸèƒ½é™ä½è¿ç§»æˆæœ¬
- ğŸ¯ **æŸ¥è¯¢æ•ˆç‡æå‡**ï¼šå¤šç»´åº¦ã€ç©¿é€å¼æ•°æ®æŸ¥è¯¢èƒ½åŠ›

---

**æ–‡æ¡£çŠ¶æ€ï¼š** âœ… å®Œæˆ  
**å®¡æ ¸çŠ¶æ€ï¼š** å¾…å®¡æ ¸  
**ä¸‹ä¸€æ­¥ï¼š** æ ¹æ®å®¡æ ¸åé¦ˆè°ƒæ•´æ¶æ„è®¾è®¡