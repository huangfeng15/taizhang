# 项目采购与成本管理驾驶舱 - 设计方案

## 1. 设计理念：从“数据仓库”到“管理驾驶舱”

当前系统成功地将分散的Excel数据集中化、结构化，解决了“数据孤岛”的问题，这是一个坚实的基础。然而，作为管理者，我们不仅需要一个被动查询的“数据仓库”，更需要一个能够**主动预警、智能分析、辅助决策**的“管理驾驶舱”。

本方案旨在基于现有数据模型，通过构建三大核心模块，将系统升级为真正的管理工具，其核心价值在于：

- **变被动为主动：** 从“人找数据”转变为“数据找人”，系统主动推送风险与异常。
- **聚焦核心痛点：** 集中解决数据更新滞后、归档不及时、潜在风险难发现等管理难题。
- **驱动数据文化：** 通过量化指标和清晰的报表，引导各项目负责人关注数据质量，形成良性循环。

---

## 2. 核心模块一：数据健康度监控 (Data Health Monitor)

此模块旨在解决您最关心的**数据更新不及时**和**归档滞后**的问题。我们将为每个项目和核心业务环节建立一个“健康度仪表盘”。

### 2.1 数据新鲜度监控

**目标：** 直观展示各项目、各模块的数据更新频率，量化“偷懒”行为。

**实现思路：**
1.  **定义“新鲜度”指标：** 利用所有数据表中的通用字段 `updated_at` (记录更新时间)。
2.  **建立监控仪表盘：**
    - 以**项目**为单位，展示其下属所有核心模块（采购、合同、付款、结算）的“最后更新时间”。
    - **红绿灯预警机制：**
        - **绿色 (健康):** 30天内有更新。
        - **黄色 (警告):** 30-60天内无更新。
        - **红色 (危险):** 超过60天无更新。
3.  **界面展示：**
    - 在项目总览页面，为每个项目名称旁添加一个健康度状态灯。
    - 点击状态灯可下钻到详情，查看是哪个具体模块（合同、付款等）更新滞后。

| 项目名称 | 整体健康度 | 采购模块 | 合同模块 | 付款模块 | 结算模块 |
| :--- | :---: | :---: | :---: | :---: | :---: |
| 天健棚改项目 | 🔴 | 🟢 | 🟡 | 🔴 | 🟢 |
| 深圳湾超总项目 | 🟢 | 🟢 | 🟢 | 🟢 | 🟢 |

### 2.2 归档及时性监控

**目标：** 监控采购和合同资料的归档情况，确保流程闭环。

**实现思路：**
1.  **定义“归档滞后”指标：**
    - **采购归档滞后天数** = `procurement.archive_date` - `procurement.notice_issue_date` (中标通知书发放日期)。
    - **合同归档滞后天数** = `contract.archive_date` - `contract.signing_date` (合同签订日期)。
2.  **建立待归档清单：**
    - 系统自动筛选出“应归档但未归档”的记录。
    - **筛选规则：**
        - 采购：`notice_issue_date` 已超过30天，但 `archive_date` 仍为空。
        - 合同：`signing_date` 已超过30天，但 `archive_date` 仍为空。
3.  **界面展示：**
    - 在驾驶舱首页显示一个醒目的数字：“待归档文件（XX份）”。
    - 点击可进入“归档任务清单”，清晰列出责任人、项目名称、合同/采购编号及滞后天数。

---

## 3. 核心模块二：智能预警与洞察 (Intelligent Alerts & Insights)

此模块旨在回答您“如何从数据中找到异常”的问题。系统将化身“审计员”，自动扫描数据并标记潜在风险。

### 3.1 财务支付异常预警

1.  **超额支付预警 (Over-payment):**
    - **规则：** `合同付款比例 > 100%`。
    - **业务价值：** 防止资金流失，是财务内控的强力防线。该计算逻辑在 `业务逻辑公式手册.md` 中已有定义，我们只需将其产品化。

2.  **无合同支付预警 (Payment without Contract):**
    - **规则：** 理论上系统通过外键约束避免了此问题。但我们可以做一个反向检查，定期扫描是否存在游离的付款记录（虽然可能性极低）。

3.  **支付时序异常 (Abnormal Payment Timeline):**
    - **规则：** `payment.payment_date` < `contract.signing_date`。
    - **业务价值：** 识别“先上车后补票”的不合规操作。

4_  **支付进度异常 (Abnormal Payment Progress):**
    - **规则：** 长期（如90天）无任何付款记录的已签订合同；或一次性支付超过合同总额80%的款项（可能缺少过程款支付）。
    - **业务价值：** 发现僵尸合同或不寻常的支付模式。

### 3.2 成本与采购异常预警

1.  **中标价异常 (Abnormal Winning Amount):**
    - **规则 1 (贴顶预警):** `中标价 / 采购控制价 > 99%`。
    - **业务价值：** 可能意味着采购控制价制定不合理，或围标风险。
    - **规则 2 (巨额节约预警):** `中标价 / 采购控制价 < 70%`。
    - **业务价值：** 看似是好事，但可能隐藏着供应商恶意低价中标、后期变更索赔的风险。

2.  **采购流程超时 (Procurement Cycle Timeout):**
    - **规则：** `中标通知书发放日期 - 采购需求书审批完成日期 > 90天`。
    - **业务价值：** 识别效率低下的采购项目，分析瓶颈环节。

3.  **绕避采购预警 (Bypassing Procurement):**
    - **规则：** 筛选出所有 `contract_source = '直接签订'` 的合同。
    - **业务价值：** 直接签订合同是合规风险点，需要重点关注。系统应生成这类合同的专题报告，供管理者定期审阅。

### 3.3 供应商风险预警

1.  **供应商集中度过高 (High Supplier Concentration):**
    - **规则：** 按供应商（`party_b`）分组，统计其`合同总金额`或`中标总金额`占公司总盘子的比例。标记出比例过高（如 > 20%）的供应商。
    - **业务价值：** 避免对单一供应商的过度依赖，分散供应链风险。

2.  **低分评价预警 (Low Evaluation Score):**
    - **规则：** 供应商的 `SupplierEvaluation.score` 平均分低于75分。
    - **业务价值：** 提前识别并淘汰履约能力差、配合度低的供应商。

---

## 4. 核心模块三：多维分析与报告 (BI & Reporting)

此模块旨在满足您对数据分析和报告导出的需求，将数据转化为可呈现、可汇报的成果。

### 4.1 交互式数据分析仪表盘

提供一个可交互的分析页面，管理者可以通过点选、筛选，实时查看数据变化。

1.  **累计支付金额分析：**
    - **展现形式：** 时间序列图（折线图）。
    - **维度：**
        - 可按**项目**查看单个或多个项目的累计支付曲线。
        - 可按**供应商**查看对某个供应商的历年累计支付情况。
        - 可按**时间**（年/季/月）查看全公司的总支付趋势。

2.  **合同类型分析：**
    - **展现形式：** 饼图或柱状图。
    - **维度：**
        - **采购合同 vs 直接签订合同** 的数量和金额对比。
        - **主合同 vs 补充协议** 的数量和金额对比，分析补充协议占比，评估合同变更情况。

### 4.2 报告中心

提供一站式的报告生成与导出服务。

1.  **自动化周报/月报：**
    - **实现思路：** 创建一个后台定时任务（Management Command）。
    - **报告内容：**
        - **数据健康度总结：** 本期“红灯”模块列表。
        - **待办事项提醒：** 待归档文件清单。
        - **核心异常概览：** 本期新增的各类预警信息。
        - **关键指标快照：** 公司整体、各项目的合同总额、支付总额、付款比例。
    - **输出格式：** 可设计为HTML邮件推送，或生成Excel/PDF文件。

2.  **自定义数据导出 (一键导出Excel):**
    - **目标：** 提供极高灵活度的自定义导出功能。
    - **实现思路：**
        1.  **创建“导出中心”页面。**
        2.  **第一步：选择项目范围。** 提供一个复选框列表，允许用户选择一个或多个项目，并提供“全选”功能。
        3.  **第二步：选择数据模块。** 提供复选框，如 `[ ] 采购`, `[ ] 合同`, `[ ] 付款`。
        4.  **第三步：选择导出字段。** 当用户勾选一个模块（如“合同”）后，页面动态加载该模块下的所有字段，并以复选框形式展示，用户可以自由勾选需要导出的列（如 `合同编号`, `合同名称`, `合同金额`, `签订日期`）。
        5.  **第四步：生成报告。** 点击“导出”按钮，后端根据用户的选择，动态查询数据并生成一个多Sheet的Excel文件（每个模块一个Sheet），然后提供给用户下载。

---

## 5. 实施建议

建议分阶段实施此“管理驾驶舱”：

- **第一阶段（1-2周）：** 优先实现 **“数据健康度监控”** 模块。它最贴近您的当前痛点，实现成本低（主要依赖已有字段），能快速产生管理价值。
- **第二阶段（2-3周）：** 开发 **“智能预警与洞察”** 模块。将已有的业务逻辑转化为自动化的预警规则，并构建展示界面。
- **第三阶段（3-4周）：** 构建 **“多维分析与报告”** 模块。其中“自定义导出”功能最为复杂，需要投入较多开发资源，但能一劳永逸地解决各种临时性的数据提取需求。

通过以上设计，系统将不再仅仅是数据的终点，而是管理洞察的起点。