# é‡‡è´­ã€åˆåŒã€ä»˜æ¬¾æ¨¡å—å…³è”å­—æ®µå¢å¼ºå®ç°æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†ä¸ºé‡‡è´­ã€åˆåŒã€ä»˜æ¬¾æ¨¡å—æ·»åŠ å…³è”ä¿¡æ¯é€‰æ‹©åŠŸèƒ½çš„å®Œæ•´å®ç°æ–¹æ¡ˆï¼ŒåŒ…æ‹¬æ™ºèƒ½ä¸‹æ‹‰é€‰æ‹©ã€çº§è”ç­›é€‰å’Œç”¨æˆ·ä½“éªŒä¼˜åŒ–ã€‚

## ğŸ¯ æ ¸å¿ƒéœ€æ±‚

1. **é‡‡è´­ç®¡ç†**ï¼šéœ€è¦æ·»åŠ é¡¹ç›®å…³è”é€‰æ‹©åŠŸèƒ½
2. **åˆåŒç®¡ç†**ï¼šéœ€è¦æ·»åŠ é¡¹ç›®å’Œé‡‡è´­å…³è”é€‰æ‹©åŠŸèƒ½
3. **ä»˜æ¬¾ç®¡ç†**ï¼šéœ€è¦ä¼˜åŒ–åˆåŒå…³è”é€‰æ‹©åŠŸèƒ½
4. **ç”¨æˆ·ä½“éªŒ**ï¼šå®ç°æ™ºèƒ½ä¸‹æ‹‰é€‰æ‹©ï¼Œæ”¯æŒæœç´¢å’Œçº§è”ç­›é€‰
5. **æ•°æ®å®Œæ•´æ€§**ï¼šç¡®ä¿å…³è”å…³ç³»çš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§

## ğŸ”§ æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 1. è¡¨å•å­—æ®µå¢å¼º

#### 1.1 é‡‡è´­è¡¨å• (ProcurementForm)

**å½“å‰é—®é¢˜**ï¼š
- ç¼ºå°‘é¡¹ç›®å…³è”é€‰æ‹©å­—æ®µ
- ç”¨æˆ·æ— æ³•å°†é‡‡è´­ä¸é¡¹ç›®å…³è”

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
class ProcurementForm(forms.ModelForm):
    project = forms.ModelChoiceField(
        queryset=Project.objects.all(),
        required=False,
        widget=forms.Select(attrs={
            'class': 'form-control smart-selector',
            'data-url': '/api/projects/',
            'data-search-fields': 'project_code,project_name',
            'data-display-format': '{project_code} - {project_name}',
            'data-placeholder': 'æœç´¢é¡¹ç›®ç¼–ç æˆ–åç§°...',
            'data-allow-clear': 'true'
        }),
        help_text='é€‰æ‹©æ‰€å±é¡¹ç›®ï¼Œå¯æœç´¢é¡¹ç›®ç¼–ç æˆ–åç§°'
    )
    
    class Meta:
        model = Procurement
        fields = [
            'project',  # æ–°å¢é¡¹ç›®å…³è”å­—æ®µ
            'procurement_code',
            'project_name',
            'procurement_unit',
            'procurement_category',
            'procurement_platform',
            'procurement_method',
            'qualification_review_method',
            'bid_evaluation_method',
            'bid_awarding_method',
            'budget_amount',
            'control_price',
            'winning_amount',
            'procurement_officer',
            'demand_department',
            'demand_contact',
            'winning_bidder',
            'winning_contact',
            'planned_completion_date',
            'requirement_approval_date',
            'announcement_release_date',
            'registration_deadline',
            'bid_opening_date',
            'candidate_publicity_end_date',
            'result_publicity_release_date',
            'notice_issue_date',
            'archive_date',
            'evaluation_committee',
            'bid_guarantee',
            'bid_guarantee_return_date',
            'performance_guarantee',
            'candidate_publicity_issue',
            'non_bidding_explanation',
        ]
```

#### 1.2 åˆåŒè¡¨å• (ContractForm)

**å½“å‰é—®é¢˜**ï¼š
- ç¼ºå°‘é¡¹ç›®å…³è”é€‰æ‹©å­—æ®µ
- é‡‡è´­å…³è”å­—æ®µæœªä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
class ContractForm(forms.ModelForm):
    project = forms.ModelChoiceField(
        queryset=Project.objects.all(),
        required=False,
        widget=forms.Select(attrs={
            'class': 'form-control smart-selector',
            'data-url': '/api/projects/',
            'data-search-fields': 'project_code,project_name',
            'data-display-format': '{project_code} - {project_name}',
            'data-placeholder': 'æœç´¢é¡¹ç›®ç¼–ç æˆ–åç§°...',
            'data-dependent-field': '',  # é¡¶çº§å­—æ®µ
            'data-target-field': 'procurement'  # å½±å“çš„ç›®æ ‡å­—æ®µ
        }),
        help_text='é€‰æ‹©æ‰€å±é¡¹ç›®ï¼Œå¯æœç´¢é¡¹ç›®ç¼–ç æˆ–åç§°'
    )
    
    procurement = forms.ModelChoiceField(
        queryset=Procurement.objects.all(),
        required=False,
        widget=forms.Select(attrs={
            'class': 'form-control smart-selector',
            'data-url': '/api/procurements/',
            'data-search-fields': 'procurement_code,project_name',
            'data-display-format': '{procurement_code} - {project_name}',
            'data-placeholder': 'å…ˆé€‰æ‹©é¡¹ç›®ï¼Œå†æœç´¢é‡‡è´­...',
            'data-dependent-field': 'project'  # ä¾èµ–é¡¹ç›®å­—æ®µ
        }),
        help_text='é€‰æ‹©å…³è”é‡‡è´­ï¼Œå¯æœç´¢é‡‡è´­ç¼–å·æˆ–é¡¹ç›®åç§°'
    )
    
    class Meta:
        model = Contract
        fields = [
            'project',      # æ–°å¢é¡¹ç›®å…³è”å­—æ®µ
            'procurement',   # å¢å¼ºé‡‡è´­å…³è”å­—æ®µ
            'contract_code',
            'contract_name',
            'file_positioning',
            'contract_source',
            'parent_contract',
            'contract_sequence',
            'party_a',
            'party_b',
            'party_a_legal_representative',
            'party_a_contact_person',
            'party_a_manager',
            'party_b_legal_representative',
            'party_b_contact_person',
            'party_b_manager',
            'contract_amount',
            'signing_date',
            'duration',
            'contract_officer',
            'payment_method',
            'performance_guarantee_return_date',
            'archive_date',
        ]
```

#### 1.3 ä»˜æ¬¾è¡¨å• (PaymentForm)

**å½“å‰é—®é¢˜**ï¼š
- åˆåŒå…³è”å­—æ®µæœªä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
- ç¼ºå°‘é¡¹ç›®ç­›é€‰åŠŸèƒ½

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
class PaymentForm(forms.ModelForm):
    # å¯é€‰ï¼šæ·»åŠ é¡¹ç›®å­—æ®µç”¨äºç­›é€‰
    project = forms.ModelChoiceField(
        queryset=Project.objects.all(),
        required=False,
        widget=forms.Select(attrs={
            'class': 'form-control smart-selector',
            'data-url': '/api/projects/',
            'data-search-fields': 'project_code,project_name',
            'data-display-format': '{project_code} - {project_name}',
            'data-placeholder': 'é€‰æ‹©é¡¹ç›®ä»¥ç­›é€‰åˆåŒ...',
            'data-target-field': 'contract'  # å½±å“åˆåŒå­—æ®µ
        }),
        help_text='é€‰æ‹©é¡¹ç›®ä»¥ç­›é€‰åˆåŒåˆ—è¡¨ï¼ˆå¯é€‰ï¼‰'
    )
    
    contract = forms.ModelChoiceField(
        queryset=Contract.objects.all(),
        required=True,
        widget=forms.Select(attrs={
            'class': 'form-control smart-selector',
            'data-url': '/api/contracts/',
            'data-search-fields': 'contract_code,contract_name,contract_sequence',
            'data-display-format': '{contract_sequence} - {contract_name}',
            'data-placeholder': 'æœç´¢åˆåŒç¼–å·ã€åºå·æˆ–åç§°...',
            'data-dependent-field': 'project'  # å¯ä¾èµ–é¡¹ç›®å­—æ®µ
        }),
        help_text='é€‰æ‹©å…³è”åˆåŒï¼Œå¯æœç´¢åˆåŒç¼–å·ã€åºå·æˆ–åç§°'
    )
    
    class Meta:
        model = Payment
        fields = [
            'project',      # æ–°å¢é¡¹ç›®ç­›é€‰å­—æ®µ
            'contract',     # å¢å¼ºåˆåŒå…³è”å­—æ®µ
            'payment_code',
            'payment_amount',
            'payment_date',
            'settlement_amount',
            'is_settled',
            'settlement_archive_date',
        ]
```

### 2. APIæ¥å£è®¾è®¡

#### 2.1 URLé…ç½®æ›´æ–°

åœ¨ `config/urls.py` ä¸­æ·»åŠ ä»¥ä¸‹APIè·¯ç”±ï¼š

```python
# çº§è”æ•°æ®API
path('api/projects/', views.api_projects_list, name='api_projects_list'),
path('api/procurements/', views.api_procurements_list, name='api_procurements_list'),
path('api/contracts/', views.api_contracts_list, name='api_contracts_list'),
path('api/payments/', views.api_payments_list, name='api_payments_list'),
```

#### 2.2 è§†å›¾å‡½æ•°å®ç°

åœ¨ `project/views.py` ä¸­æ·»åŠ ä»¥ä¸‹APIè§†å›¾ï¼š

```python
from django.http import JsonResponse
from django.core.paginator import Paginator
from django.db.models import Q

def api_projects_list(request):
    """é¡¹ç›®åˆ—è¡¨API - æ”¯æŒæœç´¢å’Œåˆ†é¡µ"""
    search = request.GET.get('search', '')
    page = int(request.GET.get('page', 1))
    page_size = int(request.GET.get('page_size', 20))
    
    projects = Project.objects.all()
    
    if search:
        projects = projects.filter(
            Q(project_code__icontains=search) |
            Q(project_name__icontains=search)
        )
    
    paginator = Paginator(projects, page_size)
    page_obj = paginator.get_page(page)
    
    data = [{
        'id': project.project_code,
        'project_code': project.project_code,
        'project_name': project.project_name,
        'display_text': f"{project.project_code} - {project.project_name}"
    } for project in page_obj]
    
    return JsonResponse({
        'success': True,
        'data': data,
        'pagination': {
            'current_page': page_obj.number,
            'total_pages': paginator.num_pages,
            'total_count': paginator.count,
            'has_next': page_obj.has_next(),
            'has_previous': page_obj.has_previous()
        }
    })

def api_procurements_list(request):
    """é‡‡è´­åˆ—è¡¨API - æ”¯æŒé¡¹ç›®ç­›é€‰å’Œæœç´¢"""
    search = request.GET.get('search', '')
    project = request.GET.get('project', '')
    page = int(request.GET.get('page', 1))
    page_size = int(request.GET.get('page_size', 20))
    
    procurements = Procurement.objects.select_related('project')
    
    if project:
        procurements = procurements.filter(project__project_code=project)
    
    if search:
        procurements = procurements.filter(
            Q(procurement_code__icontains=search) |
            Q(project_name__icontains=search)
        )
    
    paginator = Paginator(procurements, page_size)
    page_obj = paginator.get_page(page)
    
    data = [{
        'id': procurement.procurement_code,
        'procurement_code': procurement.procurement_code,
        'project_name': procurement.project_name,
        'project_code': procurement.project.project_code if procurement.project else '',
        'display_text': f"{procurement.procurement_code} - {procurement.project_name}"
    } for procurement in page_obj]
    
    return JsonResponse({
        'success': True,
        'data': data,
        'pagination': {
            'current_page': page_obj.number,
            'total_pages': paginator.num_pages,
            'total_count': paginator.count,
            'has_next': page_obj.has_next(),
            'has_previous': page_obj.has_previous()
        }
    })

def api_contracts_list(request):
    """åˆåŒåˆ—è¡¨API - æ”¯æŒé¡¹ç›®å’Œé‡‡è´­ç­›é€‰"""
    search = request.GET.get('search', '')
    project = request.GET.get('project', '')
    procurement = request.GET.get('procurement', '')
    page = int(request.GET.get('page', 1))
    page_size = int(request.GET.get('page_size', 20))
    
    contracts = Contract.objects.select_related('project', 'procurement')
    
    if project:
        contracts = contracts.filter(project__project_code=project)
    
    if procurement:
        contracts = contracts.filter(procurement__procurement_code=procurement)
    
    if search:
        contracts = contracts.filter(
            Q(contract_code__icontains=search) |
            Q(contract_name__icontains=search) |
            Q(contract_sequence__icontains=search)
        )
    
    paginator = Paginator(contracts, page_size)
    page_obj = paginator.get_page(page)
    
    data = [{
        'id': contract.contract_code,
        'contract_code': contract.contract_code,
        'contract_name': contract.contract_name,
        'contract_sequence': contract.contract_sequence or '',
        'project_code': contract.project.project_code if contract.project else '',
        'project_name': contract.project.project_name if contract.project else '',
        'procurement_code': contract.procurement.procurement_code if contract.procurement else '',
        'display_text': f"{contract.contract_sequence or contract.contract_code} - {contract.contract_name}"
    } for contract in page_obj]
    
    return JsonResponse({
        'success': True,
        'data': data,
        'pagination': {
            'current_page': page_obj.number,
            'total_pages': paginator.num_pages,
            'total_count': paginator.count,
            'has_next': page_obj.has_next(),
            'has_previous': page_obj.has_previous()
        }
    })
```

### 3. æ™ºèƒ½é€‰æ‹©å™¨ç»„ä»¶

#### 3.1 JavaScriptç»„ä»¶å®ç°

åˆ›å»º `project/static/js/smart-selector.js`ï¼š

```javascript
/**
 * æ™ºèƒ½é€‰æ‹©å™¨ç»„ä»¶ - æ”¯æŒæœç´¢ã€åˆ†é¡µã€çº§è”ç­›é€‰
 */
class SmartSelector {
    constructor(element, options) {
        this.element = element;
        this.options = {
            url: options.url,
            dependentField: options.dependentField || null,
            searchFields: options.searchFields || ['name'],
            displayFormat: options.displayFormat || '{name}',
            valueField: options.valueField || 'id',
            placeholder: options.placeholder || 'è¯·é€‰æ‹©...',
            allowClear: options.allowClear !== false,
            pageSize: options.pageSize || 20,
            onSelect: options.onSelect || null,
            onChange: options.onChange || null
        };
        
        this.currentPage = 1;
        this.totalPages = 1;
        this.searchKeyword = '';
        this.selectedItem = null;
        this.isLoading = false;
        
        this.init();
    }
    
    init() {
        this.createDropdown();
        this.bindEvents();
        this.loadInitialData();
    }
    
    createDropdown() {
        // éšè—åŸå§‹selectå…ƒç´ 
        this.element.style.display = 'none';
        
        // åˆ›å»ºè‡ªå®šä¹‰é€‰æ‹©å™¨å®¹å™¨
        this.wrapper = document.createElement('div');
        this.wrapper.className = 'smart-selector-wrapper';
        
        // åˆ›å»ºæ˜¾ç¤ºæ¡†
        this.display = document.createElement('div');
        this.display.className = 'smart-selector-display form-control';
        this.display.innerHTML = `<span class="placeholder">${this.options.placeholder}</span>`;
        
        // åˆ›å»ºä¸‹æ‹‰ç®­å¤´
        this.arrow = document.createElement('div');
        this.arrow.className = 'smart-selector-arrow';
        this.arrow.innerHTML = 'â–¼';
        
        // åˆ›å»ºä¸‹æ‹‰é¢æ¿
        this.dropdown = document.createElement('div');
        this.dropdown.className = 'smart-selector-dropdown';
        this.dropdown.style.display = 'none';
        
        // åˆ›å»ºæœç´¢æ¡†
        this.searchContainer = document.createElement('div');
        this.searchContainer.className = 'smart-selector-search';
        this.searchInput = document.createElement('input');
        this.searchInput.type = 'text';
        this.searchInput.placeholder = 'æœç´¢...';
        this.searchContainer.appendChild(this.searchInput);
        
        // åˆ›å»ºé€‰é¡¹å®¹å™¨
        this.optionsContainer = document.createElement('div');
        this.optionsContainer.className = 'smart-selector-options';
        
        // åˆ›å»ºåˆ†é¡µå®¹å™¨
        this.paginationContainer = document.createElement('div');
        this.paginationContainer.className = 'smart-selector-pagination';
        
        // ç»„è£…ä¸‹æ‹‰é¢æ¿
        this.dropdown.appendChild(this.searchContainer);
        this.dropdown.appendChild(this.optionsContainer);
        this.dropdown.appendChild(this.paginationContainer);
        
        // ç»„è£…å®Œæ•´ç»„ä»¶
        this.display.appendChild(this.arrow);
        this.wrapper.appendChild(this.display);
        this.wrapper.appendChild(this.dropdown);
        
        // æ’å…¥åˆ°DOM
        this.element.parentNode.insertBefore(this.wrapper, this.element);
        
        // ä¿å­˜å¼•ç”¨
        this.element._smartSelector = this;
    }
    
    bindEvents() {
        // ç‚¹å‡»æ˜¾ç¤º/éšè—ä¸‹æ‹‰æ¡†
        this.display.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggle();
        });
        
        // æœç´¢è¾“å…¥
        this.searchInput.addEventListener('input', (e) => {
            clearTimeout(this.searchTimeout);
            this.searchTimeout = setTimeout(() => {
                this.search(e.target.value);
            }, 300);
        });
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        document.addEventListener('click', (e) => {
            if (!this.wrapper.contains(e.target)) {
                this.hide();
            }
        });
        
        // ç›‘å¬ä¾èµ–å­—æ®µå˜åŒ–
        if (this.options.dependentField) {
            const dependentField = document.querySelector(`[name="${this.options.dependentField}"]`);
            if (dependentField) {
                dependentField.addEventListener('change', (e) => {
                    this.filterByDependency(e.target.value);
                });
            }
        }
    }
    
    async loadInitialData() {
        await this.loadData();
    }
    
    async loadData(params = {}) {
        if (this.isLoading) return;
        
        this.isLoading = true;
        this.showLoading();
        
        try {
            const queryParams = new URLSearchParams({
                page: this.currentPage,
                page_size: this.options.pageSize,
                ...params
            });
            
            const response = await fetch(`${this.options.url}?${queryParams}`);
            const result = await response.json();
            
            if (result.success) {
                this.renderOptions(result.data);
                this.updatePagination(result.pagination);
                this.totalPages = result.pagination.total_pages;
            } else {
                this.showError('åŠ è½½æ•°æ®å¤±è´¥');
            }
        } catch (error) {
            this.showError('ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
        } finally {
            this.isLoading = false;
        }
    }
    
    renderOptions(data) {
        this.optionsContainer.innerHTML = '';
        
        if (data.length === 0) {
            this.optionsContainer.innerHTML = '<div class="smart-selector-empty">æš‚æ— æ•°æ®</div>';
            return;
        }
        
        data.forEach(item => {
            const option = document.createElement('div');
            option.className = 'smart-selector-option';
            option.innerHTML = item.display_text;
            option.dataset.value = item.id;
            option.dataset.item = JSON.stringify(item);
            
            option.addEventListener('click', () => {
                this.select(item);
            });
            
            this.optionsContainer.appendChild(option);
        });
    }
    
    select(item) {
        this.selectedItem = item;
        this.element.value = item.id;
        this.display.innerHTML = `<span class="selected-text">${item.display_text}</span>`;
        this.hide();
        
        // è§¦å‘é€‰æ‹©å›è°ƒ
        if (this.options.onSelect) {
            this.options.onSelect(item);
        }
        
        // è§¦å‘changeäº‹ä»¶
        this.element.dispatchEvent(new Event('change'));
    }
    
    async search(keyword) {
        this.searchKeyword = keyword;
        this.currentPage = 1;
        
        await this.loadData({
            search: keyword
        });
    }
    
    async filterByDependency(dependentValue) {
        this.currentPage = 1;
        this.selectedItem = null;
        this.element.value = '';
        this.display.innerHTML = `<span class="placeholder">${this.options.placeholder}</span>`;
        
        if (dependentValue) {
            await this.loadData({
                [this.options.dependentField]: dependentValue
            });
        } else {
            await this.loadData();
        }
    }
    
    show() {
        this.dropdown.style.display = 'block';
        this.searchInput.focus();
    }
    
    hide() {
        this.dropdown.style.display = 'none';
    }
    
    toggle() {
        if (this.dropdown.style.display === 'none') {
            this.show();
        } else {
            this.hide();
        }
    }
    
    showLoading() {
        this.optionsContainer.innerHTML = '<div class="smart-selector-loading">åŠ è½½ä¸­...</div>';
    }
    
    showError(message) {
        this.optionsContainer.innerHTML = `<div class="smart-selector-error">${message}</div>`;
    }
    
    updatePagination(pagination) {
        if (pagination.total_pages <= 1) {
            this.paginationContainer.innerHTML = '';
            return;
        }
        
        let paginationHTML = `<div class="pagination-info">`;
        paginationHTML += `ç¬¬ ${pagination.current_page} é¡µï¼Œå…± ${pagination.total_pages} é¡µ`;
        paginationHTML += `</div>`;
        
        if (pagination.has_previous) {
            paginationHTML += `<button class="pagination-btn" data-page="${pagination.current_page - 1}">ä¸Šä¸€é¡µ</button>`;
        }
        
        if (pagination.has_next) {
            paginationHTML += `<button class="pagination-btn" data-page="${pagination.current_page + 1}">ä¸‹ä¸€é¡µ</button>`;
        }
        
        this.paginationContainer.innerHTML = paginationHTML;
        
        // ç»‘å®šåˆ†é¡µæŒ‰é’®äº‹ä»¶
        this.paginationContainer.querySelectorAll('.pagination-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                this.currentPage = parseInt(btn.dataset.page);
                await this.loadData({
                    search: this.searchKeyword
                });
            });
        });
    }
    
    clear() {
        this.selectedItem = null;
        this.element.value = '';
        this.display.innerHTML = `<span class="placeholder">${this.options.placeholder}</span>`;
        
        if (this.options.onChange) {
            this.options.onChange(null);
        }
        
        this.element.dispatchEvent(new Event('change'));
    }
}

// è‡ªåŠ¨åˆå§‹åŒ–æ‰€æœ‰æ™ºèƒ½é€‰æ‹©å™¨
document.addEventListener('DOMContentLoaded', () => {
    const selectors = document.querySelectorAll('.smart-selector');
    selectors.forEach(selectElement => {
        new SmartSelector(selectElement, {
            url: selectElement.dataset.url,
            dependentField: selectElement.dataset.dependentField || null,
            searchFields: selectElement.dataset.searchFields.split(','),
            displayFormat: selectElement.dataset.displayFormat,
            placeholder: selectElement.dataset.placeholder,
            allowClear: selectElement.dataset.allowClear === 'true'
        });
    });
});
```

#### 3.2 CSSæ ·å¼

åˆ›å»º `project/static/css/smart-selector.css`ï¼š

```css
/* æ™ºèƒ½é€‰æ‹©å™¨æ ·å¼ */
.smart-selector-wrapper {
    position: relative;
    width: 100%;
}

.smart-selector-display {
    min-height: 38px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding-right: 12px;
    background-color: #fff;
    border: 1px solid #d9d9d9;
    border-radius: 6px;
    transition: border-color 0.3s ease;
}

.smart-selector-display:hover {
    border-color: #40a9ff;
}

.smart-selector-display:focus {
    border-color: #40a9ff;
    box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
    outline: none;
}

.smart-selector-arrow {
    font-size: 12px;
    color: #999;
    transition: transform 0.3s ease;
}

.smart-selector-wrapper.open .smart-selector-arrow {
    transform: rotate(180deg);
}

.smart-selector-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #d9d9d9;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    max-height: 320px;
    overflow: hidden;
    margin-top: 4px;
}

.smart-selector-search {
    padding: 8px 12px;
    border-bottom: 1px solid #f0f0f0;
}

.smart-selector-search input {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    outline: none;
    font-size: 14px;
}

.smart-selector-search input:focus {
    border-color: #40a9ff;
}

.smart-selector-options {
    max-height: 250px;
    overflow-y: auto;
}

.smart-selector-option {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #f5f5f5;
    font-size: 14px;
    line-height: 1.5;
    transition: background-color 0.2s ease;
}

.smart-selector-option:hover {
    background-color: #f5f5f5;
}

.smart-selector-option.selected {
    background-color: #e6f7ff;
    color: #1890ff;
}

.smart-selector-option:last-child {
    border-bottom: none;
}

.smart-selector-loading,
.smart-selector-empty,
.smart-selector-error {
    padding: 20px;
    text-align: center;
    color: #999;
    font-size: 14px;
}

.smart-selector-error {
    color: #ff4d4f;
}

.smart-selector-pagination {
    padding: 8px 12px;
    border-top: 1px solid #f0f0f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: #666;
}

.pagination-info {
    flex: 1;
}

.pagination-btn {
    padding: 4px 8px;
    margin: 0 2px;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    background: white;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.2s ease;
}

.pagination-btn:hover {
    border-color: #40a9ff;
    color: #40a9ff;
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.placeholder {
    color: #999;
}

.selected-text {
    color: #333;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .smart-selector-dropdown {
        max-height: 280px;
    }
    
    .smart-selector-options {
        max-height: 200px;
    }
    
    .smart-selector-pagination {
        flex-direction: column;
        gap: 8px;
    }
}
```

### 4. å‰ç«¯é›†æˆ

#### 4.1 åœ¨edit-modal.jsä¸­é›†æˆ

ä¿®æ”¹ `project/static/js/edit-modal.js`ï¼š

```javascript
class EditModal {
    // ... ç°æœ‰ä»£ç 
    
    async loadForm(url, title = 'ç¼–è¾‘ä¿¡æ¯') {
        // ... ç°æœ‰ä»£ç 
        
        // åˆå§‹åŒ–æ™ºèƒ½é€‰æ‹©å™¨
        this.initSmartSelectors();
    }
    
    initSmartSelectors() {
        // æŸ¥æ‰¾æ‰€æœ‰å¸¦æœ‰smart-selectorç±»çš„selectå…ƒç´ 
        const selectors = document.querySelectorAll('.smart-selector');
        
        selectors.forEach(selectElement => {
            new SmartSelector(selectElement, {
                url: selectElement.dataset.url,
                dependentField: selectElement.dataset.dependentField,
                searchFields: selectElement.dataset.searchFields.split(','),
                displayFormat: selectElement.dataset.displayFormat,
                placeholder: selectElement.dataset.placeholder,
                allowClear: selectElement.dataset.allowClear === 'true',
                onSelect: (item) => {
                    // è§¦å‘çº§è”æ›´æ–°
                    this.triggerDependentFields(selectElement, item);
                }
            });
        });
    }
    
    triggerDependentFields(changedField, selectedItem) {
        // è§¦å‘ä¾èµ–å­—æ®µçš„æ›´æ–°
        const targetFieldName = changedField.dataset.targetField;
        if (targetFieldName) {
            const targetField = document.querySelector(`[name="${targetFieldName}"]`);
            if (targetField && targetField.classList.contains('smart-selector')) {
                // æ¸…ç©ºç›®æ ‡å­—æ®µå¹¶é‡æ–°åŠ è½½æ•°æ®
                targetField.value = '';
                const selector = targetField._smartSelector;
                if (selector) {
                    selector.filterByDependency(selectedItem.id);
                }
            }
        }
    }
}
```

### 5. å®ç°æ­¥éª¤

#### æ­¥éª¤1ï¼šä¿®æ”¹è¡¨å•å®šä¹‰
1. æ›´æ–° `project/forms.py` ä¸­çš„ `ProcurementForm`
2. æ›´æ–° `project/forms.py` ä¸­çš„ `ContractForm`  
3. æ›´æ–° `project/forms.py` ä¸­çš„ `PaymentForm`

#### æ­¥éª¤2ï¼šæ·»åŠ APIæ¥å£
1. åœ¨ `config/urls.py` ä¸­æ·»åŠ APIè·¯ç”±
2. åœ¨ `project/views.py` ä¸­å®ç°APIè§†å›¾å‡½æ•°

#### æ­¥éª¤3ï¼šåˆ›å»ºå‰ç«¯ç»„ä»¶
1. åˆ›å»º `project/static/js/smart-selector.js`
2. åˆ›å»º `project/static/css/smart-selector.css`
3. ä¿®æ”¹ `project/templates/components/edit_form.html` å¼•å…¥æ–°èµ„æº

#### æ­¥éª¤4ï¼šé›†æˆåˆ°ç°æœ‰ç³»ç»Ÿ
1. ä¿®æ”¹ `project/static/js/edit-modal.js`
2. æµ‹è¯•æ‰€æœ‰è¡¨å•çš„æ™ºèƒ½é€‰æ‹©åŠŸèƒ½

#### æ­¥éª¤5ï¼šæµ‹è¯•å’Œä¼˜åŒ–
1. æµ‹è¯•çº§è”ç­›é€‰åŠŸèƒ½
2. æµ‹è¯•æœç´¢åŠŸèƒ½
3. æµ‹è¯•åˆ†é¡µåŠŸèƒ½
4. ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

## ğŸ¯ é¢„æœŸæ•ˆæœ

### ç”¨æˆ·ä½“éªŒæå‡
1. **æœç´¢åŠŸèƒ½**ï¼šç”¨æˆ·å¯ä»¥å¿«é€Ÿæœç´¢å’Œå®šä½æ‰€éœ€é¡¹ç›®
2. **çº§è”ç­›é€‰**ï¼šé€‰æ‹©é¡¹ç›®åè‡ªåŠ¨ç­›é€‰ç›¸å…³çš„é‡‡è´­ã€åˆåŒ
3. **æ™ºèƒ½æç¤º**ï¼šæ˜¾ç¤ºå®Œæ•´çš„ç¼–ç å’Œåç§°ä¿¡æ¯
4. **åˆ†é¡µåŠ è½½**ï¼šå¤§æ•°æ®é‡æ—¶æ€§èƒ½ä¼˜åŒ–

### æ•°æ®å®Œæ•´æ€§
1. **å…³è”å…³ç³»**ï¼šç¡®ä¿é‡‡è´­ã€åˆåŒã€ä»˜æ¬¾ä¸é¡¹ç›®çš„æ­£ç¡®å…³è”
2. **æ•°æ®ä¸€è‡´æ€§**ï¼šçº§è”ç­›é€‰ä¿è¯æ•°æ®é€»è¾‘ä¸€è‡´æ€§
3. **é”™è¯¯é¢„é˜²**ï¼šå‰ç«¯éªŒè¯å‡å°‘æ•°æ®è¾“å…¥é”™è¯¯

### ç³»ç»Ÿå¯ç»´æŠ¤æ€§
1. **ç»„ä»¶åŒ–**ï¼šæ™ºèƒ½é€‰æ‹©å™¨å¯å¤ç”¨äºå…¶ä»–æ¨¡å—
2. **æ ‡å‡†åŒ–**ï¼šç»Ÿä¸€çš„APIæ¥å£å’Œæ•°æ®æ ¼å¼
3. **æ‰©å±•æ€§**ï¼šæ˜“äºæ·»åŠ æ–°çš„ç­›é€‰æ¡ä»¶å’Œå­—æ®µ

## ğŸ“‹ éªŒæ”¶æ ‡å‡†

1. âœ… é‡‡è´­è¡¨å•å¯ä»¥é€‰æ‹©é¡¹ç›®
2. âœ… åˆåŒè¡¨å•å¯ä»¥é€‰æ‹©é¡¹ç›®å’Œé‡‡è´­
3. âœ… ä»˜æ¬¾è¡¨å•å¯ä»¥é€‰æ‹©åˆåŒï¼ˆæ”¯æŒé¡¹ç›®ç­›é€‰ï¼‰
4. âœ… æ‰€æœ‰é€‰æ‹©å™¨æ”¯æŒæœç´¢åŠŸèƒ½
5. âœ… çº§è”ç­›é€‰æ­£å¸¸å·¥ä½œ
6. âœ… åˆ†é¡µåŠŸèƒ½æ­£å¸¸
7. âœ… ç§»åŠ¨ç«¯é€‚é…è‰¯å¥½
8. âœ… é”™è¯¯å¤„ç†å®Œå–„
9. âœ… æ€§èƒ½è¡¨ç°è‰¯å¥½
10. âœ… æ•°æ®å…³è”æ­£ç¡®

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

1. **ç¼“å­˜ä¼˜åŒ–**ï¼šå¯¹å¸¸ç”¨æ•°æ®è¿›è¡Œç¼“å­˜
2. **é”®ç›˜å¯¼èˆª**ï¼šæ”¯æŒé”®ç›˜å¿«æ·æ“ä½œ
3. **æ‰¹é‡æ“ä½œ**ï¼šæ”¯æŒæ‰¹é‡é€‰æ‹©å’Œæ“ä½œ
4. **æ•°æ®ç»Ÿè®¡**ï¼šåœ¨é€‰æ‹©å™¨ä¸­æ˜¾ç¤ºç›¸å…³ç»Ÿè®¡ä¿¡æ¯
5. **æƒé™æ§åˆ¶**ï¼šæ ¹æ®ç”¨æˆ·æƒé™ç­›é€‰å¯é€‰æ•°æ®