# 合同分类业务规则说明书

**文档版本：** v1.0  
**编写日期：** 2025-10-20  
**关联文档：** [需求文档](需求文档.md) | [数据模型设计](../plans/2025-10-20-data-models.md)

---

## 1. 文档目的

本文档旨在明确系统中两类合同（采购合同与直接签订合同）的业务差异、处理规则和管理要求，为开发、测试和运维提供统一的业务逻辑参考。

---

## 2. 合同分类概述

### 2.1 分类定义

系统将合同分为两大类别，通过 `contract_source` 字段进行标识：

| 合同来源 | 定义 | 占比 | 关联采购要求 |
|---------|------|------|-------------|
| **采购合同** | 通过正式采购流程（招标、竞争性谈判等）产生的合同 | 绝大多数（>95%） | 必须关联采购项目 |
| **直接签订** | 不经过采购流程，直接与供应商签订的合同 | 极少数（<5%） | 不能关联采购项目 |

### 2.2 典型场景

#### 采购合同典型场景：
- 工程项目建设合同
- 设备采购合同
- 服务外包合同
- 通过8M平台、特区建工采购平台等采购的项目

#### 直接签订合同典型场景：
- 框架协议（如年度维保服务协议）
- 长期战略合作协议
- 紧急情况下的小额服务合同
- 特定供应商的独家服务合同

---

## 3. 业务规则详解

### 3.1 数据录入规则

#### 规则1：采购合同必须关联采购项目

```
IF contract_source = '采购合同' THEN
    procurement 字段必填
    系统应在保存时验证 procurement 不为空
ELSE
    保存失败，提示："采购合同必须关联采购项目"
END IF
```

**实施方式：** 在 `Contract.clean()` 方法中实现强制校验

#### 规则2：直接签订合同不能关联采购项目

```
IF contract_source = '直接签订' AND procurement IS NOT NULL THEN
    保存失败，提示："直接签订合同不应关联采购项目"
END IF
```

**实施方式：** 在 `Contract.clean()` 方法中实现强制校验

#### 规则3：补充协议继承主合同的来源类型

```
IF contract_type IN ['补充协议', '解除协议'] AND parent_contract IS NOT NULL THEN
    自动设置：contract_source = parent_contract.contract_source
    自动设置：procurement = parent_contract.procurement
    用户不能手动修改补充协议的来源类型
END IF
```

**实施方式：** 在 `Contract.clean()` 方法中自动同步

### 3.2 数据完整性保护规则

#### 规则4：删除采购项目前的保护

```
IF 尝试删除 Procurement 对象 THEN
    检查是否存在关联的采购合同
    IF 存在关联合同 THEN
        禁止删除，提示："该采购项目已关联 X 个合同，请先解除关联或删除合同"
    END IF
END IF
```

**实施方式：** 使用 `on_delete=models.PROTECT`

#### 规则5：合同来源变更保护

```
IF 尝试修改现有合同的 contract_source THEN
    IF 该合同已有付款记录 OR 已有补充协议 THEN
        警告用户："该合同已有业务数据，变更来源类型可能影响数据一致性"
        需要用户确认后才能保存
    END IF
END IF
```

**实施方式：** 在 Admin 中添加自定义验证逻辑

### 3.3 默认值规则

#### 规则6：新建合同的默认值

```
新建主合同时：
    contract_source 默认值 = '采购合同'
    contract_type 默认值 = '主合同'
    
新建补充协议时：
    contract_type = '补充协议'
    必须先选择 parent_contract
    contract_source 和 procurement 自动继承主合同
```

---

## 4. UI交互设计

### 4.1 Admin后台字段布局

```python
fieldsets = (
    ('基本信息', {
        'fields': ('contract_code', 'contract_name', 'contract_type', 'contract_source'),
        'description': '合同来源决定是否需要关联采购项目'
    }),
    ('关联信息', {
        'fields': ('parent_contract', 'procurement'),
        'description': '''
        ⚠️ 注意：
        - 采购合同必须关联采购项目
        - 直接签订合同无需关联采购
        - 补充协议自动继承主合同的关联关系
        '''
    }),
    # ... 其他字段组
)
```

### 4.2 列表页显示

**list_display 应包含：**
- `contract_code`（合同编号）
- `contract_name`（合同名称）
- `contract_type`（合同类型）
- `contract_source`（合同来源）← 新增
- `procurement`（关联采购）- 显示采购编号或"无"
- `party_b`（乙方）
- `contract_amount`（合同金额）
- `signing_date`（签订日期）

### 4.3 过滤器配置

**list_filter 应包含：**
1. `contract_type`（合同类型）
2. `contract_source`（合同来源）← 新增
3. `('procurement', admin.EmptyFieldListFilter)`（是否关联采购）← 新增
4. `signing_date`（签订日期）
5. `created_at`（创建时间）

---

## 5. 统计与查询场景

### 5.1 基础统计维度

| 统计维度 | 查询方法 | 用途 |
|---------|---------|------|
| 采购合同总数 | `Contract.objects.filter(contract_source='采购合同').count()` | 了解正式采购合同数量 |
| 直接签订合同总数 | `Contract.objects.filter(contract_source='直接签订').count()` | 了解非采购合同数量 |
| 关联采购的合同 | `Contract.objects.filter(procurement__isnull=False).count()` | 验证数据一致性 |
| 未关联采购的合同 | `Contract.objects.filter(procurement__isnull=True).count()` | 识别潜在数据问题 |

### 5.2 金额统计对比

```python
from django.db.models import Sum, Count

# 按来源分组统计
stats = Contract.objects.values('contract_source').annotate(
    count=Count('contract_code'),
    total_amount=Sum('contract_amount')
).order_by('contract_source')

# 预期结果示例：
# [
#     {'contract_source': '采购合同', 'count': 150, 'total_amount': 5000000.00},
#     {'contract_source': '直接签订', 'count': 5, 'total_amount': 200000.00}
# ]
```

### 5.3 异常数据检测

```python
# 检测1：采购合同但未关联采购
anomaly_1 = Contract.objects.filter(
    contract_source='采购合同',
    procurement__isnull=True
).count()

# 检测2：直接签订但关联了采购
anomaly_2 = Contract.objects.filter(
    contract_source='直接签订',
    procurement__isnull=False
).count()

# 检测3：补充协议来源与主合同不一致
from django.db.models import F
anomaly_3 = Contract.objects.filter(
    contract_type='补充协议',
    parent_contract__isnull=False
).exclude(
    contract_source=F('parent_contract__contract_source')
).count()
```

---

## 6. 数据导入处理

### 6.1 标准导入流程

```python
def import_contract(row):
    """导入单条合同数据"""
    contract_data = {
        'contract_code': row['合同编号'],
        'contract_name': row['合同名称'],
        'contract_type': row.get('合同类型', '主合同'),
        'contract_source': row.get('合同来源', '采购合同'),  # 默认为采购合同
    }
    
    # 如果是采购合同，必须提供采购编号
    if contract_data['contract_source'] == '采购合同':
        procurement_code = row.get('关联采购编号')
        if not procurement_code:
            raise ValueError(f"采购合同 {contract_data['contract_code']} 缺少采购编号")
        
        try:
            procurement = Procurement.objects.get(procurement_code=procurement_code)
            contract_data['procurement'] = procurement
        except Procurement.DoesNotExist:
            raise ValueError(f"采购编号 {procurement_code} 不存在")
    
    Contract.objects.update_or_create(
        contract_code=contract_data['contract_code'],
        defaults=contract_data
    )
```

### 6.2 历史数据迁移

**场景：** 历史Excel台账中未明确区分两类合同

**处理策略：**
1. 优先根据"关联采购编号"字段判断
   - 有值 → `contract_source='采购合同'`
   - 无值 → `contract_source='直接签订'`
2. 人工审核直接签订合同，确认是否真的不需要关联采购
3. 提供数据清洗脚本，批量修正误分类

---

## 7. 常见问题与解决方案

### Q1: 历史合同没有采购关联怎么办？

**A:** 分两种情况：
1. 如果是真正的直接签订合同，设置 `contract_source='直接签订'`
2. 如果是采购合同但遗漏了关联，应补充采购信息或创建对应的采购记录

### Q2: 能否将采购合同改为直接签订？

**A:** 技术上可以，但需要满足：
1. 该合同没有付款记录
2. 该合同没有补充协议
3. 系统会给出警告提示，需要管理员确认

### Q3: 补充协议能否关联不同的采购项目？

**A:** 不能。补充协议必须继承主合同的 `contract_source` 和 `procurement`，确保数据一致性。

### Q4: 统计报表如何处理两类合同？

**A:** 提供以下视图：
1. 全部合同统计
2. 采购合同统计（按 contract_source 过滤）
3. 直接签订合同统计
4. 对比分析（数量、金额占比）

---

## 8. 实施检查清单

### 8.1 开发阶段
- [ ] Contract 模型添加 `contract_source` 字段
- [ ] 实现 `clean()` 方法的6条业务规则
- [ ] Admin配置包含合同来源显示和过滤
- [ ] 数据导入脚本支持来源分类
- [ ] 编写单元测试覆盖所有规则

### 8.2 测试阶段
- [ ] 测试采购合同必须关联采购的验证
- [ ] 测试直接签订合同不能关联采购的验证
- [ ] 测试补充协议继承逻辑
- [ ] 测试历史数据导入的分类准确性
- [ ] 测试统计查询的准确性

### 8.3 上线阶段
- [ ] 用户培训：明确两类合同的定义
- [ ] 数据清洗：审核历史数据的分类准确性
- [ ] 文档交付：提供合同分类操作手册
- [ ] 持续监控：定期检查异常数据

---

## 9. 修订记录

| 版本 | 日期 | 修订内容 | 修订人 |
|-----|------|---------|-------|
| v1.0 | 2025-10-20 | 初始版本，定义两类合同业务规则 | 系统架构师 |

---

**审批状态：** 待审批  
**下一步：** 提交给业务部门审核确认