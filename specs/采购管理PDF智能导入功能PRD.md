# 采购管理PDF智能导入功能 - 产品需求文档（PRD）

**文档版本**: v1.0  
**创建日期**: 2025-01-05  
**文档状态**: 待评审  
**产品负责人**: 系统架构师  
**目标上线时间**: 2025年Q1

---

## 📋 文档目录

1. [需求概述](#1-需求概述)
2. [用户故事与使用场景](#2-用户故事与使用场景)
3. [功能需求规格](#3-功能需求规格)
4. [界面设计与交互流程](#4-界面设计与交互流程)
5. [技术实现方案](#5-技术实现方案)
6. [数据模型设计](#6-数据模型设计)
7. [非功能性需求](#7-非功能性需求)
8. [验收标准](#8-验收标准)
9. [测试计划](#9-测试计划)
10. [实施计划与里程碑](#10-实施计划与里程碑)
11. [风险评估与应对](#11-风险评估与应对)
12. [附录](#12-附录)

---

## 1. 需求概述

### 1.1 背景说明

系统已成功实现一套PDF智能识别解决方案（详见`docs/PDF智能识别导入方案-最终版.md`），该方案能够从采购相关的PDF文件中精准提取22个关键字段，自动化率达到69%（22/32字段）。为最大化技术价值，提升用户工作效率，现需将此能力无缝集成到采购管理模块。

### 1.2 业务价值

- **效率提升**: 传统手工录入需15分钟/条，智能导入仅需3-5分钟，节省80%时间
- **准确性提升**: 自动提取避免人为录入错误，枚举字段映射准确率100%
- **用户体验**: 从"下载→手工录入→上传"简化为"上传→确认→保存"
- **数据规范**: 强制枚举值验证，确保数据一致性

### 1.3 目标用户

- **主要用户**: 采购专员（日常操作）
- **次要用户**: 采购主管（审核确认）
- **系统管理员**: 维护配置、监控导入质量

### 1.4 核心目标

1. 在采购管理模块中提供"从PDF导入"功能入口
2. 支持多文件/文件夹批量上传，自动识别PDF类型
3. 智能提取22个字段，Web界面实时预览和编辑
4. 数据校验与原文对照，确保准确性
5. 一键确认后直接写入数据库，无需中间环节

---

## 2. 用户故事与使用场景

### 2.1 主用户故事

**作为一名采购专员，我希望能够：**

> 在"采购管理"模块导入数据时，直接上传一个或多个PDF格式的采购文档（审批单、公告、公示等），系统自动识别并提取关键信息，在清晰的Web界面上展示供我审核和修改，确认无误后一键保存，从而极大简化数据录入工作。

**验收标准**:
- 能在5分钟内完成一条采购记录的导入（vs 传统15分钟）
- 自动提取字段准确率≥90%
- 需手动补充的字段有清晰提示
- 可随时查看原始PDF进行核对

### 2.2 典型使用场景

#### 场景A: 新项目采购信息快速录入

**背景**: 采购专员张三收到一个新项目的采购文件夹，包含4个PDF文件：
- `2-23.采购请示OA审批.pdf`
- `2-24.采购公告.pdf`
- `2-45.中标候选人公示.pdf`
- `2-47.采购结果公示.pdf`

**操作流程**:
1. 进入"采购管理"页面，点击"导入文件"
2. 点击"从PDF导入"按钮
3. 选择包含这4个PDF的文件夹（或按住Ctrl多选4个文件）
4. 系统自动上传并识别（进度条显示：正在识别第3/4个文件...）
5. 跳转到数据审核页面，看到自动填充的22个字段
6. 检查标黄的3个需确认字段（如"采购类别"映射建议）
7. 补充11个手动字段（如中标通知书发放日期）
8. 点击"查看原文"按钮并排对照PDF核验数据
9. 点击"确认导入"，系统保存成功
10. 返回列表，看到新增的采购记录

**预期结果**: 4-5分钟完成，vs 传统手工录入15分钟

#### 场景B: 批量导入历史采购数据

**背景**: 需将2024年100个历史采购项目的PDF文档批量导入系统

**操作流程**:
1. 准备文件夹结构：`2024采购档案/TQJG20240101/`（每个项目一个子文件夹）
2. 依次选择每个项目文件夹进行导入
3. 利用智能识别节省大量时间
4. 对于识别失败的字段，手动补充

**预期收益**: 总耗时从25小时降至8小时（节省68%）

---

## 3. 功能需求规格

### 3.1 功能模块架构

```
采购管理模块
├── 列表页面（现有）
│   ├── 导入文件按钮（现有）
│   │   ├── 下载模板（现有）
│   │   ├── 上传Excel（现有）
│   │   └── 从PDF导入（新增）⭐
│   └── 其他功能...
│
└── PDF智能导入流程（新增）
    ├── 步骤1: 文件上传页面
    ├── 步骤2: 智能识别处理
    ├── 步骤3: 数据审核编辑页面
    └── 步骤4: 保存成功页面
```

### 3.2 详细功能需求

#### FR-001: 导入入口集成

**优先级**: P0（必须有）

**需求描述**:
- 在"采购管理"模块列表页的"导入文件"模态框中，新增"从PDF导入"按钮
- 按钮位置：位于"下载模板"和"上传Excel"区域旁边，三者并列
- 视觉设计：使用醒目的图标（如📄）和颜色（主题蓝色），清晰区分功能

**技术要求**:
- 修改`project/templates/procurement_list.html`模板
- 新增路由`/pdf-import/upload/`
- 权限控制：复用现有导入权限

**验收标准**:
- [ ] 按钮在导入模态框中清晰可见
- [ ] 点击按钮跳转到PDF上传页面
- [ ] 无权限用户看不到此按钮

---

#### FR-002: PDF文件上传

**优先级**: P0（必须有）

**需求描述**:
支持两种文件选择方式，满足不同用户习惯：

**方式1: 文件夹选择（推荐）**
- 用户点击"选择文件夹"按钮
- 系统自动扫描文件夹内的所有PDF文件
- 智能过滤非PDF文件
- 显示识别到的PDF数量

**方式2: 多文件选择**
- 用户点击"选择文件"按钮
- 支持按住Ctrl/Cmd键多选
- 建议最多选择10个文件（避免超时）

**文件验证规则**:
- 文件格式：仅限`.pdf`
- 文件大小：单个文件≤10MB
- 文件命名：支持中文和特殊字符
- 文件数量：1-10个文件（超出提示分批上传）

**技术要求**:
```html
<!-- 文件夹选择（HTML5） -->
<input type="file" webkitdirectory directory multiple accept=".pdf">

<!-- 多文件选择 -->
<input type="file" multiple accept=".pdf">
```

**验收标准**:
- [ ] 支持文件夹选择（Chrome/Edge/Firefox）
- [ ] 支持多文件选择（所有浏览器）
- [ ] 显示选中的PDF文件列表（文件名、大小）
- [ ] 超出限制时给出清晰提示
- [ ] 上传进度条实时反馈

---

#### FR-003: 智能PDF类型识别

**优先级**: P0（必须有）

**需求描述**:
系统自动识别上传的PDF属于以下哪一类型：

| PDF类型 | 文件模式 | 内容特征 | 提取字段数 |
|---------|---------|---------|-----------|
| 2-21: 采购控制价审批 | `2-21`、`控制价` | "采购上限价" | 1个（fallback） |
| 2-23: 采购请示 | `2-23`、`采购请示` | "申请人"、"定标方法" | 7个 |
| 2-24/25: 采购公告 | `2-24`、`特区建工` | "项目编号"、"开标时间" | 9个 |
| 2-45: 候选人公示 | `2-45`、`候选人` | "第一候选人" | 1个 |
| 2-47: 结果公示 | `2-47`、`结果公示` | "成交人"、"已中标" | 3个 |

**识别策略**:
1. **文件名匹配**（优先级高）: 基于正则表达式快速匹配
2. **内容分析**（兜底策略）: 提取PDF前2页文本，匹配关键词
3. **混合判断**: 文件名+内容双重验证，置信度评分

**处理逻辑**:
```python
if 置信度 >= 0.8:
    自动归类
elif 置信度 >= 0.5:
    标记"可能是XX类型"，提示用户确认
else:
    标记为"未识别"，跳过提取
```

**技术要求**:
- 

使用现有的`pdf_import/core/pdf_detector.py`模块
- 异步处理（前端轮询状态）或同步显示进度
- 识别结果存储在会话中

**验收标准**:
- [ ] 识别准确率≥90%（基于测试数据集）
- [ ] 识别时间≤2秒/文件
- [ ] 未识别的文件有明确提示
- [ ] 识别结果显示置信度分数

---

#### FR-004: 字段智能提取

**优先级**: P0（必须有）

**需求描述**:
根据PDF类型，自动提取对应字段（共22个可自动提取字段）：

**字段分类**:

| 类别 | 字段数 | 字段示例 | 数据来源 |
|------|-------|---------|---------|
| 基本信息 | 6 | 项目名称、采购单位、采购类别、采购方式等 | 2-23, 2-24 |
| 金额信息 | 3 | 预算金额、控制价、中标金额 | 2-23, 2-24, 2-47 |
| 人员信息 | 3 | 采购经办人、需求部门、申请人电话 | 2-23, 2-24 |
| 中标信息 | 1 | 中标单位 | 2-47 |
| 时间信息 | 9 | 计划完成时间、公告发布时间、开标时间等 | 2-23, 2-24, 2-45, 2-47 |

**特殊处理规则**:

1. **枚举字段映射**（5个字段）:
   - 采购类别、采购方式、资格审查方式、评标方式、定标方法
   - PDF识别值 → 别名映射 → 标准枚举值
   - 示例：`"询价"` → `"公开询价"`，`"综合评估法"` → `"综合评分法"`
   - 无法映射时标记为"需手动选择"

2. **金额字段处理**:
   - 自动清理千分位符号：`"1,234,567.89"` → `1234567.89`
   - 支持中文大写：`"壹佰贰拾叁万肆仟伍佰陆拾柒元捌角玖分"`
   - 单位自动转换：元/万元统一为元

3. **日期字段标准化**:
   - 多种格式支持：`2025-01-05`, `2025/01/05`, `20250105`
   - 时间戳提取：`2025-01-05 14:30:00` → `2025-01-05`
   - 无效日期标记为待确认

4. **控制价Fallback机制**:
   - 优先从2-24采购公告提取
   - 如未提取到，自动尝试从2-21控制价审批提取
   - 两者都有时优先使用2-24

**技术要求**:
- 使用`pdf_import/core/field_extractor.py`
- 配置驱动：字段提取规则定义在`config/field_mapping_v3_universal.yml`
- 后处理流程：`text_parser` → `amount_parser` → `date_parser` → `enum_mapper`

**验收标准**:
- [ ] 22个可自动提取字段的提取成功率≥85%
- [ ] 枚举字段映射准确率100%（基于已知别名）
- [ ] 金额字段格式统一为数字（decimal）
- [ ] 日期字段格式统一为YYYY-MM-DD
- [ ] 控制价fallback机制正常工作

---

#### FR-005: 数据审核与编辑界面

**优先级**: P0（必须有）

**需求描述**:
提供全屏或大型模态页面，以表格形式展示提取结果供用户审核和编辑。

**界面布局**:

```
┌─────────────────────────────────────────────────────────────────┐
│ 📄 PDF智能导入 - 数据审核                    [查看原文] [?帮助] │
├─────────────────────────────────────────────────────────────────┤
│ 📁 已识别文件 (4个)：                                            │
│   ✅ 2-23.采购请示.pdf (识别准确度: 95%)                         │
│   ✅ 2-24.采购公告.pdf (识别准确度: 92%)                         │
│   ✅ 2-45.候选人公示.pdf (识别准确度: 88%)                       │
│   ✅ 2-47.结果公示.pdf (识别准确度: 90%)                         │
├─────────────────────────────────────────────────────────────────┤
│ 📋 提取字段（共32个，已自动填充22个）                            │
│                                                                 │
│ 字段名称          | 提取值            | 状态      | 操作        │
│ ─────────────────|───────────────────|───────────|─────────── │
│ 🔵 采购项目名称   | XX小区物业服务... | ✅自动提取 | [查看原文]  │
│ 🔵 采购单位       | 深圳市特区建工... | ✅自动提取 |            │
│ 🟡 采购类别       | 服务 ▼          | ⚠️需确认  | [原值:地产营销] │
│ 🔵 采购方式       | 公开询价 ▼      | ✅自动提取 |            │
│ 🔵 预算金额(元)   | 1,234,567.89    | ✅自动提取 |            │
│ ⚪ 招采编号       | [请输入]        | ⭐必填    |            │
│ ⚪ 中标通知书日期  | [选择日期]      | 手动填写   |            │
│                                                                 │
│ 📌 需要您确认的字段 (3个)：                                      │
│   • 采购类别：PDF识别为"地产营销"，系统映射为"服务"              │
│   • 评标方式：PDF识别为"综合评估法"，已映射为"综合评分法"        │
│   • 定标方法：PDF未识别，请从下拉列表手动选择                    │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                    [取消]  [保存草稿]  [确认导入] ✅             │
└─────────────────────────────────────────────────────────────────┘
```

**字段状态标识**:
- 🔵 **蓝色**：自动提取成功的字段（可编辑）
- 🟡 **黄色**：需要确认的字段（枚举映射或低置信度）
- ⚪ **灰色**：需手动填写的字段（PDF中无此信息）
- ⭐ **红星**：必填字段（招采编号、项目名称）

**交互功能**:

1. **在线编辑**:
   - 所有字段均可直接编辑
   - 枚举字段提供下拉选择
   - 日期字段提供日期选择器
   - 金额字段自动格式化（千分位）

2. **实时验证**:
   - 必填项检查（提交前）
   - 数据格式验证（输入时）
   - 唯一性检查（招采编号）
   - 逻辑验证（如：中标金额≤控制价）

3. **原文对照**:
   - 每个字段旁有"查看原文"按钮
   - 点击后并排显示PDF（左侧）和表单（右侧）
   - 高亮显示提取位置（如可能）
   - 支持PDF翻页和缩放

4. **批量操作**:
   - "全部标记为已确认"（快速通过）
   - "重置为提取值"（撤销修改）
   - "保存草稿"（暂存，稍后继续）

**技术要求**:
- 前端框架：Bootstrap 5 + jQuery
- 表单组件：使用Django Form渲染
- PDF查看器：使用PDF.js或iframe嵌入
- 响应式设计：支持1920×1080及以上分辨率

**验收标准**:
- [ ] 界面清晰展示32个字段及其状态
- [ ] 所有字段支持在线编辑
- [ ] 实时验证反馈及时（<500ms）
- [ ] 原文对照功能正常，PDF可正常显示
- [ ] 需确认字段有明显视觉提示

---

#### FR-006: 数据校验与错误处理

**优先级**: P0（必须有）

**需求描述**:
在用户提交前进行完整性和合法性校验，防止无效数据入库。

**校验规则**:

| 校验类型 | 规则 | 示例 |
|---------|------|------|
| 必填项检查 | 招采编号、项目名称必填 | "招采编号不能为空" |
| 唯一性检查 | 招采编号不重复 | "招采编号TQJG202501已存在" |
| 格式验证 | 日期格式、金额格式、电话格式 | "日期格式错误，应为YYYY-MM-DD" |
| 枚举值验证 | 5个choice字段必须在枚举中 | "采购方式必须是有效的枚举值" |
| 逻辑验证 | 中标金额≤控制价≤预算金额 | "中标金额不能超过控制价" |
| 长度验证 | 项目名称≤200字符 | "项目名称过长" |
| 特殊字符 | 招采编号不含`/ \ ? #` | "招采编号不能包含特殊字符" |

**错误提示方式**:
1. **实时提示**（输入时）: 字段下方红色文字提示
2. **提交前验证**（点击确认导入时）: 弹窗列出所有错误
3. **字段定位**: 自动滚动到第一个错误字段并聚焦

**错误处理流程**:
```
用户点击"确认导入"
↓
前端JavaScript验证（快速反馈）
↓
AJAX提交到后端
↓
后端Django Form验证
↓
数据库唯一性检查
↓
业务逻辑验证
↓
[失败] 返回错误列表 → 前端标记错误字段
[成功] 事务性写入数据库 → 跳转成功页面
```

**技术要求**:
- 前端验证：使用Bootstrap Validator或自定义JS
- 后端验证：Django Form + 自定义validators
- 错误消息：中文提示，清晰友好

**验收标准**:
- [ ] 所有校验规则正确执行
- [ ] 错误提示准确定位到具体字段
- [ ] 无效数据无法提交
- [ ] 错误消息清晰易懂

---

#### FR-007: 数据确认与入库

**优先级**: P0（必须有）

**需求描述**:
用户确认无误后，一键将数据写入`procurement.Procurement`表。

**操作流程**:
1. 用户点击"确认导入"按钮
2. 系统执行最终校验
3. 校验通过后，显示确认对话框：
   ```
   确认导入以下采购信息？
   
   项目名称：XX小区物业服务采购
   招采编号：TQJG20250105FW0018
   预算金额：1,234,567.89元
   

   
   [取消] [确认]
   ```
4. 用户点击"确认"，系统执行：
   - 使用Django事务（`transaction.atomic()`）
   - 创建`Procurement`对象
   - 保存到数据库
   - 记录操作日志
5. 成功后跳转到成功页面，显示：
   - 导入成功提示
   - 新创建记录的详情链接
   - "继续导入"或"返回列表"按钮

**失败处理**:
- 数据库写入失败 → 回滚事务 → 显示错误 → 保留用户编辑的数据
- 网络超时 → 重试机制（最多3次）
- 系统异常 → 记录日志 → 提示联系管理员

**技术要求**:
- 使用Django ORM创建记录
- 事务保证数据一致性
- 记录创建人（`request.user.username`）
- 自动设置创建时间

**验收标准**:
- [ ] 数据成功写入`procurement_procurement`表
- [ ] 字段值与用户确认的完全一致
- [ ] 创建人和创建时间正确记录
- [ ] 失败时事务正确回滚

---

#### FR-008: 导入成功反馈

**优先级**: P1（应该有）

**需求描述**:
导入成功后，给用户清晰的成功反馈和后续操作指引。

**成功页面内容**:
```
┌─────────────────────────────────────────┐
│      ✅ 导入成功！                      │
│                                         │
│  已成功创建采购记录：                    │
│  招采编号：TQJG20250105FW0018           │
│  项目名称：XX小区物业服务采购            │
│                                         │
│  📄 关联的PDF文件（已归档）：            │
│  • 2-23.采购请示.pdf                    │
│  • 2-24.采购公告.pdf                    │
│  • 2-45.候选人公示.pdf                  │
│  • 2-47.结果公示.pdf                    │
│                                         │
│  [查看采购详情] [继续导入] [返回列表]    │
└─────────────────────────────────────────┘
```

**后续操作建议**:
- 系统自动返回采购列表页
- 新导入的记录高亮显示3秒（黄色背景闪烁）
- 顶部显示成功Toast消息

**可选功能**（P2）:
- PDF文件自动关联到采购记录（存储在`media/procurement/{procurement_code}/`）
- 生成导入报告（哪些字段自动提取、哪些手动填写）
- 发送邮件通知相关人员

**验收标准**:
- [ ] 成功页面信息完整准确
- [ ] 用户能便捷地查看新建记录
- [ ] 返回列表后能快速定位新记录

---

#### FR-009: 会话管理与数据暂存

**优先级**: P1（应该有）

**需求描述**:
用户可能需要暂停导入，稍后继续，系统应提供会话管理功能。

**会话机制**:
- 每次上传PDF创建唯一会话ID（UUID）
- 会话数据存储在`pdf_import_pdfsession`表
- 会话有效期24小时，过期自动清理
- 用户可保存草稿，继续编辑

**会话状态**:
```python
class SessionStatus:
    EXTRACTING = 'extracting'      # 提取中
    PENDING_REVIEW = 'pending_review'  # 待审核
    CONFIRMED = 'confirmed'        # 已确认
    SAVED = 'saved'                # 已保存
    EXPIRED = 'expired'            # 已过期
```

**"保存草稿"功能**:
- 用户点击"保存草稿"按钮
- 系统保存当前所有字段值（包括用户修改）
- 生成草稿链接，用户可稍后继续
- 草稿有效期延长至72小时

**"继续编辑"功能**:
- 用户可在导入历史中查看未完成的会话
- 点击"继续编辑"恢复到审核页面
- 所有字段值保持原样

**技术要求**:
- 会话数据存储为JSON格式
- 定时任务清理过期会话（Celery或cron）
- 会话列表页面（可选）

**验收标准**:
- [ ] 会话能正常创建和保存
- [ ] 草稿能正确恢复所有字段值
- [ ] 过期会话自动清理

---

### 3.3 可选功能需求（P2）

#### FR-010: 批量导入历史档案

**需求描述**:
支持批量导入多个项目的历史采购档案，提升历史数据录入效率。

**使用场景**:
用户有100个历史项目文件夹，每个文件夹包含一个项目的所有PDF。

**实现方式**:
- 用户选择顶级文件夹
- 系统遍历所有子文件夹
- 每个子文件夹视为一个项目
- 批量创建会话，队列处理

#### FR-011: 智能文件夹扫描

**需求描述**:
系统可配置监控文件夹，自动发现新增的PDF并提示导入。

**实现方式**:
- 管理员配置扫描路径（如共享文件夹）
- 定时任务扫描新文件（每小时）
- 发现新PDF后创建待处理任务
- 用户登录时提示"有N个新文件待导入"

#### FR-012: 导入质量统计

**需求描述**:
提供导入质量分析，帮助优化识别规则。

**统计指标**:
- 识别准确率（按PDF类型）
- 字段提取成功率（按字段）
- 需手动修改的字段TOP10
- 用户修改记录（用于改进算法）

---

## 4. 界面设计与交互流程

### 4.1 完整用户流程图

```
┌─────────────┐
│ 采购列表页   │
└──────┬──────┘
       │ 点击"导入文件"
       ↓
┌─────────────────────┐
│ 导入方式选择对话框   │
│ • 下载模板          │
│ • 上传Excel         │
│ • 从PDF导入 ⭐      │
└──────┬──────────────┘
       │ 选择"从PDF导入"
       ↓
┌─────────────────────────────┐
│ 步骤1: PDF文件上传页面       │
│ • 方式1: 选择文件夹          │
│ • 方式2: 多选文件            │
│ • 显示选中文件列表           │
│ [上传并识别] 按钮            │
└──────┬──────────────────────┘
       │ 提交上传
       ↓
┌─────────────────────────────┐
│ 步骤2: 智能识别处理（后台）  │
│ • PDF类型检测               │
│ • 字段提取                  │
│ • 枚举映射                  │
│ • 数据验证                  │
│ [进度条: 正在识别第3/4个...]  │
└──────┬──────────────────────┘
       │ 识别完成
       ↓
┌──────────────────────────────────┐
│ 步骤3: 数据审核编辑页面（全屏）  │
│ • 已识别文件列表（4个）          │
│ • 字段表格（32个）               │
│   - 🔵 自动提取（22个）          │
│   - 🟡 需确认（3个）             │
│   - ⚪ 手动填写（7个）           │
│ • 原文对照功能                   │
│ • 实时验证                       │
│ [保存草稿] [确认导入] 按钮       │
└──────┬───────────────────────────┘
       │ 用户编辑并确认
       ↓
┌─────────────────────┐
│ 确认对话框           │
│ "确认导入以下信息？" │
│ [取消] [确认]        │
└──────┬──────────────┘
       │ 点击确认
       ↓
┌─────────────────────────────┐
│ 步骤4: 数据写入数据库        │
│ • 最终校验                  │
│ • 事务性保存                │
│ • 记录日志                  │
└──────┬──────────────────────┘
       │ 保存成功
       ↓
┌─────────────────────────────┐
│ 成功页面                    │
│ ✅ 导入成功！                │
│ 招采编号：TQJG20250105       │
│ [查看详情] [继续导入]        │
└──────┬──────────────────────┘
       │ 3秒后自动跳转
       ↓
┌─────────────────────┐
│ 采购列表页           │
│ 新记录高亮显示       │
└─────────────────────┘
```

### 4.2 关键页面线框图

#### 页面1: PDF上传页面

```
╔═══════════════════════════════════════════════════════════╗
║ 🏠 首页 > 采购管理 > PDF智能导入                          ║
╠═══════════════════════════════════════════════════════════╣
║                                                           ║
║  📄 PDF智能导入 - 文件上传                                ║
║  ─────────────────────────────────────────────────────   ║
║                                                           ║
║  💡 提示：系统可自动识别以下PDF类型并提取22个关键字段      ║
║                                                           ║
║  ┌─────────────────────────────────────────────────────┐ ║
║  │ 方式1：选择文件夹（推荐）🗂️                          │ ║
║  │                                                       │ ║
║  │ [选择文件夹] 📁                                       │ ║
║  │                                                       │ ║
║  │ 系统会自动扫描文件夹中的所有PDF文件                   │ ║
║  └─────────────────────────────────────────────────────┘ ║
║                                                           ║
║  ───────────────── 或 ────────────────────                ║
║                                                           ║
║  ┌─────────────────────────────────────────────────────┐ ║
║  │ 方式2：多选PDF文件 📄                                 │ ║
║  │                                                       │ ║
║  │ [选择文件...] 📎                                      │ ║
║  │                                                       │ ║
║  │ 按住Ctrl/Cmd键可选择多个文件（最多10个）              │ ║
║  └─────────────────────────────────────────────────────┘ ║
║                                                           ║
║  ┌─────────────────────────────────────────────────────┐ ║
║  │ 📋 已选择文件（4个）：                                 │ ║
║  │                                                       │ ║
║  │ ✅ 📄 2-23.采购请示OA审批.pdf         (1.2 MB)        │ ║
║  │ ✅ 📄 
2-24.采购公告.pdf              (856 KB)       │ ║
║  │ ✅ 📄 2-45.中标候选人公示.pdf        (432 KB)       │ ║
║  │ ✅ 📄 2-47.采购结果公示.pdf          (298 KB)       │ ║
║  │                                                       │ ║
║  │ 总大小：2.8 MB                                        │ ║
║  └─────────────────────────────────────────────────────┘ ║
║                                                           ║
║                     [取消] [上传并识别] ➡️                ║
║                                                           ║
╠═══════════════════════════════════════════════════════════╣
║ 📌 系统支持识别的PDF类型：                                 ║
║ • 2-23: 采购请示OA审批                                    ║
║ • 2-24/25: 采购公告                                       ║
║ • 2-45: 中标候选人公示                                    ║
║ • 2-47: 采购结果公示                                      ║
╚═══════════════════════════════════════════════════════════╝
```

---

## 5. 技术实现方案

### 5.1 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                   前端层 (Browser)                       │
│  ┌────────────────┐  ┌──────────────┐  ┌─────────────┐ │
│  │ 文件上传组件    │  │ 数据审核表单  │  │ PDF查看器   │ │
│  └────────────────┘  └──────────────┘  └─────────────┘ │
│         Bootstrap 5 + jQuery + PDF.js                   │
└────────────────────────┬────────────────────────────────┘
                         │ AJAX/HTTP
┌────────────────────────┴────────────────────────────────┐
│                  Django应用层 (Views)                    │
│  ┌──────────────┐  ┌───────────────┐  ┌──────────────┐ │
│  │ upload_pdf() │→│ extract_data()│→│preview_data()│ │
│  └──────────────┘  └───────────────┘  └──────────────┘ │
│                         ↓                                │
│  ┌──────────────────────────────────────────────────┐   │
│  │            PDFImportSession (会话管理)            │   │
│  └──────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────┴────────────────────────────────┐
│               核心处理层 (pdf_import/core)               │
│  ┌──────────────┐  ┌─────────────┐  ┌───────────────┐  │
│  │ PDFDetector  │→│FieldExtractor│→│ DataValidator │  │
│  └──────────────┘  └─────────────┘  └───────────────┘  │
│         ↓                  ↓                ↓            │
│  ┌──────────────────────────────────────────────────┐   │
│  │         工具层 (pdf_import/utils)                 │   │
│  │  • text_parser   • amount_parser                 │   │
│  │  • date_parser   • enum_mapper                   │   │
│  └──────────────────────────────────────────────────┘   │
└────────────────────────┬────────────────────────────────┘
                         │
┌────────────────────────┴────────────────────────────────┐
│                  配置层 (YAML Config)                    │
│  • field_mapping_v3_universal.yml  (字段映射规则)       │
│  • pdf_patterns.yml                (PDF识别规则)        │
└─────────────────────────────────────────────────────────┘
                         │
┌────────────────────────┴────────────────────────────────┐
│                    数据层 (PostgreSQL)                   │
│  ┌────────────────────┐  ┌──────────────────────────┐   │
│  │ procurement_       │  │ pdf_import_              │   │
│  │   procurement      │  │   pdfsession             │   │
│  └────────────────────┘  └──────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

### 5.2 核心模块设计

#### 5.2.1 视图层 (Views)

**文件**: `pdf_import/views.py`

```python
# 关键视图函数
def upload_pdf(request):
    """步骤1: 处理文件上传"""
    # 1. 接收多个PDF文件
    # 2. 创建会话
    # 3. 保存文件到临时目录
    # 4. 重定向到提取页面

def extract_data(request, session_id):
    """步骤2: 提取数据"""
    # 1. 加载会话
    # 2. 批量识别PDF类型
    # 3. 提取字段
    # 4. 枚举映射
    # 5. 数据验证
    # 6. 更新会话状态
    # 7. 重定向到预览页面

def preview_data(request, session_id):
    """步骤3: 数据预览和编辑"""
    # GET: 显示Django Form
    # POST: 保存到数据库

def save_success(request, session_id):
    """步骤4: 成功页面"""
    # 显示成功信息和后续操作
```

#### 5.2.2 PDF识别模块

**文件**: `pdf_import/core/pdf_detector.py`（已实现）

**职责**: 自动识别PDF类型

**核心方法**:
```python
class PDFDetector:
    def detect(self, pdf_path) -> dict:
        """
        返回: {
            'type': 'procurement_request',
            'confidence': 0.95,
            'method': 'hybrid'
        }
        """
    
    def detect_batch(self, pdf_paths) -> dict:
        """批量识别，按类型分组"""
```

#### 5.2.3 字段提取模块

**文件**: `pdf_import/core/field_extractor.py`（已实现）

**职责**: 根据PDF类型提取对应字段

**核心方法**:
```python
class FieldExtractor:
    def extract(self, pdf_path, pdf_type) -> dict:
        """
        返回: {
            'project_name': '...',
            'budget_amount': 1234567.89,
            ...
        }
        """
    
    def extract_with_confidence(self, pdf_path, pdf_type) -> dict:
        """带置信度的提取"""
```

#### 5.2.4 数据验证模块

**文件**: `pdf_import/core/validator.py`（需新建）

**职责**: 验证提取数据的完整性和合法性

```python
class DataValidator:
    def validate(self, data: dict) -> dict:
        """
        返回: {
            'is_valid': True/False,
            'errors': [...],
            'fields': {
                'field_name': {
                    'is_valid': True,
                    'requires_manual': False,
                    'message': '...'
                }
            }
        }
        """
    
    def validate_field(self, field_name, value):
        """单字段验证"""
```

### 5.3 数据流程

```
PDF文件 
  ↓
[PDFDetector] 识别类型
  ↓
[FieldExtractor] 提取字段
  ↓
[TextParser] 文本清理
  ↓
[AmountParser] 金额解析
  ↓
[DateParser] 日期解析
  ↓
[EnumMapper] 枚举映射
  ↓
[DataValidator] 数据验证
  ↓
[PDFImportSession] 会话存储
  ↓
[User Review] 用户审核
  ↓
[Procurement.objects.create()] 入库
```

### 5.4 URL路由设计

**文件**: `pdf_import/urls.py`

```python
app_name = 'pdf_import'

urlpatterns = [
    path('upload/', views.upload_pdf, name='upload'),
    path('extract/<str:session_id>/', views.extract_data, name='extract'),
    path('preview/<str:session_id>/', views.preview_data, name='preview'),
    path('success/<str:session_id>/', views.save_success, name='success'),
    
    # 可选：草稿管理
    path('drafts/', views.list_drafts, name='drafts'),
    path('drafts/<str:session_id>/resume/', views.resume_draft, name='resume_draft'),
]
```

### 5.5 表单设计

**文件**: `pdf_import/forms.py`

```python
from django import forms
from procurement.models import Procurement

class ProcurementConfirmForm(forms.ModelForm):
    """采购信息确认表单"""
    
    class Meta:
        model = Procurement
        fields = [
            'procurement_code', 'project', 'project_name',
            'procurement_unit', 'procurement_category',
            # ... 所有32个字段
        ]
        widgets = {
            'procurement_code': forms.TextInput(attrs={
                'class': 'form-control',
                'placeholder': '格式：TQJG+年月日+类型+序号',
                'required': True
            }),
            'procurement_category': forms.Select(attrs={
                'class': 'form-select'
            }),
            'budget_amount': forms.NumberInput(attrs={
                'class': 'form-control',
                'step': '0.01'
            }),
            # ...
        }
    
    def clean_procurement_code(self):
        """验证招采编号唯一性"""
        code = self.cleaned_data['procurement_code']
        if Procurement.objects.filter(procurement_code=code).exists():
            raise forms.ValidationError(f'招采编号{code}已存在')
        return code
    
    def clean(self):
        """跨字段验证"""
        cleaned_data = super().clean()
        
        # 验证金额逻辑：中标金额 ≤ 控制价 ≤ 预算金额
        winning = cleaned_data.get('winning_amount')
        control = cleaned_data.get('control_price')
        budget = cleaned_data.get('budget_amount')
        
        if winning and control and winning > control:
            raise forms.ValidationError('中标金额不能超过控制价')
        
        if control and budget and control > budget:
            raise forms.ValidationError('控制价不能超过预算金额')
        
        return cleaned_data
```

---

## 6. 数据模型设计

### 6.1 会话表设计

**表名**: `pdf_import_pdfsession`

**文件**: `pdf_import/models.py`

```python
class PDFImportSession(models.Model):
    """PDF导入会话"""
    
    session_id = models.CharField(
        '会话ID', 
        max_length=50, 
        unique=True, 
        primary_key=True,
        default=uuid.uuid4
    )
    
    created_by = models.ForeignKey(
        User, 
        on_delete=models.CASCADE, 
        verbose_name='创建人'
    )
    
    created_at = models.DateTimeField('创建时间', auto_now_add=True)
    updated_at = models.DateTimeField('更新时间', auto_now=True)
    
    # PDF文件信息
    pdf_files = models.JSONField('PDF文件列表', default=list)
    # [{
    #     'name': '2-23.采购请示.pdf',
    #     'path': '/media/pdf_import/xxx/...',
    #     'size': 1024000,
    #     'detected_type': 'procurement_request',
    #     'confidence': 0.95
    # }]
    
    # 提取的数据
    extracted_data = models.JSONField('提取的数据', default=dict)
    # {
    #     'project_name': 'XX小区物业服务',
    #     'budget_amount': '1234567.89',
    #     ...
    # }
    
    # 验证结果
    validation_result = models.JSONField('验证结果', default=dict)
    
    # 需确认的字段
    requires_confirmation = models.JSONField('需确认字段', default=list)
    # [{
    #     'field': 'procurement_category',
    #     'extracted_value': '地产营销',
    #     'mapped_value': '服务',
    #     'reason': 'PDF别名映射'
    # }]
    
    # 会话状态
    status = models.CharField(
        '状态',
        max_length=20,
        choices=[
            ('extracting', '提取中'),
            ('pending_review', '待确认'),
            ('confirmed', '已确认'),
            ('saved', '已保存'),
            ('expired', '已过期'),
        ],
        default='extracting'
    )
    
    # 过期时间
    expires_at = models.DateTimeField('过期时间')
    
    # 最终保存的采购记录
    procurement = models.ForeignKey(
        'procurement.Procurement',
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        verbose_name='关联采购记录'
    )
    
    class Meta:
        verbose_name = 'PDF导入会话'
        verbose_name_plural = 'PDF导入会话'
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['created_by', 'status']),
            models.Index(fields=['expires_at']),
        ]
    
    def save(self, *args, **kwargs):
        if not self.expires_at:
            self.expires_at = timezone.now() + timedelta(hours=24)
        super().save(*args, **kwargs)
    
    def is_expired(self):
        return timezone.now() > self.expires_at
    
    def __str__(self):
        return f"{self.session_id} - {self.get_status_display()}"
```

---

## 7. 非功能性需求

### 7.1 性能要求

| 指标 | 要求 | 备注 |
|------|------|------|
| PDF识别速度 | ≤2秒/文件 | 基于10MB以内文件 |
| 字段提取速度 | ≤3秒/文件 | 包含OCR（如需要） |
| 页面加载时间 | ≤2秒 | 审核页面首次加载 |
| 并发用户数 | ≥10 | 同时进行PDF导入 |
| 文件大小限制 | ≤10MB/文件 | 
超大文件需提示分割 |
| 批量上传数量 | ≤10个/次 | 避免超时 |
| 会话存储大小 | ≤5MB/会话 | JSON数据 |

### 7.2 可用性要求

- **浏览器兼容性**: Chrome 90+, Edge 90+, Firefox 88+
- **分辨率支持**: 最低1366×768，推荐1920×1080
- **响应时间**: 用户操作反馈≤500ms
- **错误恢复**: 网络中断后可恢复会话（72小时内）
- **帮助文档**: 提供在线帮助和操作视频

### 7.3 安全性要求

- **权限控制**: 仅有导入权限的用户可访问
- **文件验证**: 严格验证PDF格式，防止恶意文件
- **数据隔离**: 不同用户的会话数据隔离
- **敏感信息**: 会话过期后自动清理临时文件
- **审计日志**: 记录所有导入操作（谁、何时、导入了什么）

### 7.4 可维护性要求

- **配置驱动**: 字段提取规则通过YAML配置，无需改代码
- **日志记录**: 详细记录识别过程和错误信息
- **监控指标**: 提供识别准确率、提取成功率等统计
- **代码规范**: 遵循Django最佳实践和PEP 8规范

---

## 8. 验收标准

### 8.1 功能验收标准

#### 核心流程验收

| 序号 | 验收项 | 验收标准 | 优先级 |
|------|-------|---------|--------|
| AC-001 | 导入入口 | 在采购列表页能找到"从PDF导入"按钮 | P0 |
| AC-002 | 文件夹选择 | 支持选择文件夹，自动扫描PDF | P0 |
| AC-003 | 多文件上传 | 支持按住Ctrl多选1-10个PDF | P0 |
| AC-004 | PDF类型识别 | 识别准确率≥90%（基于测试集） | P0 |
| AC-005 | 字段提取 | 22个字段提取成功率≥85% | P0 |
| AC-006 | 枚举映射 | 5个枚举字段映射准确率100% | P0 |
| AC-007 | 数据审核界面 | 清晰展示32个字段及状态 | P0 |
| AC-008 | 在线编辑 | 所有字段支持直接编辑 | P0 |
| AC-009 | 原文对照 | 能并排查看PDF和表单 | P0 |
| AC-010 | 数据校验 | 7种校验规则正确执行 | P0 |
| AC-011 | 数据入库 | 成功保存到procurement表 | P0 |
| AC-012 | 成功反馈 | 显示成功页面和新记录链接 | P0 |

#### 数据准确性验收

使用以下测试数据集验证：

| 测试场景 | 测试文件 | 预期结果 |
|---------|---------|---------|
| 完整4文件 | 2-23+2-24+2-45+2-47 | 22个字段全部提取 |
| 缺少公告 | 2-23+2-45+2-47 | 提示缺少2-24，控制价用2-21替代 |
| 仅有请示 | 2-23 | 提取7个字段，其他为空 |
| 异常文件 | 损坏的PDF | 识别失败，明确提示 |
| 枚举映射 | 包含"询价"、"综合评估法" | 正确映射为标准枚举 |

### 8.2 性能验收标准

**测试环境**: 
- CPU: 4核
- 内存: 8GB
- 网络: 局域网100Mbps

| 性能指标 | 要求 | 测试方法 |
|---------|------|---------|
| 单文件识别 | ≤2秒 | 上传单个5MB PDF，计时 |
| 4文件批量处理 | ≤10秒 | 上传4个PDF，总计15MB |
| 审核页面加载 | ≤2秒 | 从上传到显示审核页面 |
| 表单提交 | ≤3秒 | 点击确认到成功页面 |
| 并发10用户 | 无明显延迟 | JMeter压力测试 |

### 8.3 用户体验验收

**可用性测试**（5名实际用户测试）：

- [ ] 80%用户能在无指导下完成首次导入
- [ ] 平均完成时间≤5分钟/条（vs 传统15分钟）
- [ ] 用户满意度评分≥4.0/5.0
- [ ] 关键操作步骤≤5步
- [ ] 错误提示清晰度评分≥4.0/5.0

---

## 9. 测试计划

### 9.1 测试策略

#### 9.1.1 单元测试

**覆盖率要求**: ≥80%

**核心测试模块**:
```python
# pdf_import/tests/test_pdf_detector.py
class PDFDetectorTest(TestCase):
    def test_detect_procurement_request(self):
        """测试识别2-23采购请示"""
    
    def test_detect_with_confidence(self):
        """测试置信度评分"""

# pdf_import/tests/test_field_extractor.py
class FieldExtractorTest(TestCase):
    def test_extract_project_name(self):
        """测试提取项目名称"""
    
    def test_extract_amount_fields(self):
        """测试提取金额字段"""

# pdf_import/tests/test_enum_mapper.py
class EnumMapperTest(TestCase):
    def test_map_procurement_method(self):
        """测试采购方式映射"""
```

#### 9.1.2 集成测试

**测试场景**:
1. 完整流程测试：上传→识别→提取→审核→保存
2. 异常流程测试：识别失败、校验失败、网络中断
3. 会话管理测试：保存草稿、恢复会话、过期清理
4. 权限测试：无权限用户访问限制

#### 9.1.3 端到端测试

**使用工具**: Selenium WebDriver

**测试用例**:
```python
# E2E测试：完整导入流程
def test_complete_import_workflow():
    # 1. 登录
    # 2. 进入采购列表
    # 3. 点击"从PDF导入"
    # 4. 选择文件夹
    # 5. 等待识别完成
    # 6. 填写必填字段
    # 7. 点击确认导入
    # 8. 验证成功页面
    # 9. 验证数据库记录
```

### 9.2 测试数据准备

#### 测试PDF文件集

| 文件名 | 类型 | 大小 | 特点 |
|--------|------|------|------|
| 标准_2-23.pdf | 采购请示 | 1.2MB | 标准格式 |
| 标准_2-24.pdf | 采购公告 | 856KB | 标准格式 |
| 标准_2-45.pdf | 候选人公示 | 432KB | 标准格式 |
| 标准_2-47.pdf | 结果公示 | 298KB | 标准格式 |
| 异常_无标题.pdf | - | 200KB | 缺少关键字段 |
| 异常_损坏.pdf | - | 50KB | 文件损坏 |
| 边界_大文件.pdf | 采购公告 | 9.8MB | 接近上限 |
| 边界_特殊字符.pdf | 采购请示 | 1MB | 包含特殊符号 |

#### 预期提取结果

为每个测试文件准备期望的JSON输出，用于自动化验证。

### 9.3 测试时间表

| 阶段 | 时间 | 负责人 | 产出 |
|------|------|--------|------|
| 单元测试 | 开发阶段持续 | 开发工程师 | 测试报告 |
| 集成测试 | 开发完成后2天 | QA工程师 | 缺陷列表 |
| 性能测试 | 集成测试通过后1天 | QA工程师 | 性能报告 |
| 用户验收测试 | 性能测试通过后3天 | 采购专员 | UAT报告 |

---

## 10. 实施计划与里程碑

### 10.1 开发阶段划分

#### 第一阶段：基础设施（Week 1）

**时间**: 2025-01-06 ~ 2025-01-12

**任务**:
- [ ] 创建`pdf_import` Django应用
- [ ] 配置URL路由和视图骨架
- [ ] 设计并创建`PDFImportSession`模型
- [ ] 数据库迁移
- [ ] 基础模板页面搭建

**里程碑**: M1 - 基础架构就绪

---

#### 第二阶段：核心功能（Week 2-3）

**时间**: 2025-01-13 ~ 2025-01-26

**任务**:
- [ ] 实现文件上传功能（文件夹+多选）
- [ ] 集成PDF识别模块（`pdf_detector.py`）
- [ ] 集成字段提取模块（`field_extractor.py`）
- [ ] 实现枚举映射逻辑（`enum_mapper.py`）
- [ ] 实现数据验证模块（`validator.py`）
- [ ] 会话管理逻辑

**里程碑**: M2 - 核心提取功能完成

---

#### 第三阶段：用户界面（Week 4）

**时间**: 2025-01-27 ~ 2025-02-02

**任务**:
- [ ] 开发数据审核编辑页面
- [ ] 实现表单动态渲染
- [ ] 集成PDF查看器（PDF.js）
- [ ] 原文对照功能
- [ ] 实时验证反馈
- [ ] 响应式布局优化

**里程碑**: M3 - UI交互完成

---

#### 第四阶段：测试与优化（Week 5）

**时间**: 2025-02-03 ~ 2025-02-09

**任务**:
- [ ] 单元测试补充（覆盖率≥80%）
- [ ] 集成测试
- [ ] 性能测试与优化
- [ ] Bug修复
- [ ] 代码审查

**里程碑**: M4 - 测试通过

---

#### 第五阶段：部署与培训（Week 6）

**时间**: 2025-02-10 ~ 2025-02-16

**任务**:
- [ ] 生产环境部署
- [ ] 数据库迁移（生产）
- [ ] 用户培训（2场，每场2小时）
- [ ] 操作手册编写
- [ ] 试运行监控

**里程碑**: M5 - 正式上线

---

### 10.2 人力资源分配

| 角色 | 人数 | 工作量 | 主要职责 |
|------|------|--------|---------|
| 后端开发 | 1 | 全职6周 | 核心逻辑、API、数据模型 |
| 前端开发 | 1 | 全职3周 | 界面、交互、PDF查看器 |
| QA工程师 | 1 | 半职2周 | 测试、缺陷跟踪 |
| 产品经理 | 1 | 兼职6周 | 需求确认、验收 |
| 
DevOps | 1 | 兼职1周 | 部署、监控配置 |

### 10.3 关键依赖

| 依赖项 | 状态 | 影响 | 应对措施 |
|--------|------|------|---------|
| PDF识别模块已完成 | ✅已完成 | 核心功能 | 无需等待 |
| 字段提取模块已完成 | ✅已完成 | 核心功能 | 无需等待 |
| Bootstrap 5升级 | ⚠️待确认 | UI美观度 | 可降级使用现有版本 |
| 生产服务器资源 | ⚠️待申请 | 性能 | 提前2周申请 |

---

## 11. 风险评估与应对

### 11.1 技术风险

#### 风险1: PDF识别准确率不达标

**风险等级**: 🔴 高

**影响**: 核心功能无法满足需求

**概率**: 中（30%）

**应对措施**:
1. **预防**: 使用真实数据集测试识别准确率
2. **缓解**: 提供手动选择PDF类型的功能
3. **降级**: 识别失败时提示用户手动分类

**责任人**: 后端开发工程师

---

#### 风险2: 大文件处理超时

**风险等级**: 🟡 中

**影响**: 用户体验下降

**概率**: 中（40%）

**应对措施**:
1. **预防**: 限制单文件大小≤10MB
2. **缓解**: 使用异步任务处理（Celery）
3. **降级**: 提示用户压缩PDF或分批上传

**责任人**: 后端开发工程师

---

#### 风险3: 浏览器兼容性问题

**风险等级**: 🟡 中

**影响**: 部分用户无法使用

**概率**: 低（20%）

**应对措施**:
1. **预防**: 在Chrome/Edge/Firefox测试
2. **缓解**: 提供浏览器升级指引
3. **降级**: 提供传统Excel导入方式

**责任人**: 前端开发工程师

---

### 11.2 业务风险

#### 风险4: 用户接受度低

**风险等级**: 🟡 中

**影响**: 功能闲置，投资浪费

**概率**: 低（15%）

**应对措施**:
1. **预防**: 上线前充分培训和试用
2. **缓解**: 收集反馈，快速迭代优化
3. **降级**: 保留传统Excel导入方式并行

**责任人**: 产品经理

---

#### 风险5: PDF格式变化导致提取失败

**风险等级**: 🟢 低

**影响**: 部分字段提取失败

**概率**: 中（30%）

**应对措施**:
1. **预防**: 使用配置文件管理提取规则
2. **缓解**: 提供规则更新机制，无需重新部署
3. **监控**: 记录提取失败率，及时发现问题

**责任人**: 运维工程师

---

### 11.3 进度风险

#### 风险6: 开发时间超期

**风险等级**: 🟡 中

**影响**: 延期上线

**概率**: 中（35%）

**应对措施**:
1. **预防**: 合理评估工作量，留10%缓冲时间
2. **缓解**: 核心功能优先，P2功能可延后
3. **调整**: 必要时增加人力支持

**责任人**: 项目经理

---

## 12. 附录

### 12.1 术语表

| 术语 | 定义 |
|------|------|
| PDF智能识别 | 通过文件名和内容特征自动判断PDF类型的技术 |
| 字段提取 | 使用正则表达式从PDF文本中提取结构化数据 |
| 枚举映射 | 将PDF中的值映射到系统预定义的枚举值 |
| 会话 | 一次完整的PDF导入过程，包含临时数据存储 |
| Fallback机制 | 主要数据源失败时，自动尝试备用数据源 |
| 置信度 | 识别结果的可信程度，0-1之间的数值 |

### 12.2 参考文档

| 文档名称 | 路径 | 说明 |
|---------|------|------|
| PDF智能识别方案 | `docs/PDF智能识别导入方案-最终版.md` | 技术实现细节 |
| 采购模型定义 | `procurement/models.py` | 数据模型字段 |
| 枚举类定义 | `project/enums.py` | 系统枚举值 |
| 现有导入模板 | `project/import_templates/procurement.yml` | Excel导入配置 |

### 12.3 配置文件清单

| 文件名 | 用途 | 维护频率 |
|--------|------|---------|
| `field_mapping_v3_universal.yml` | 字段提取规则 | 按需调整 |
| `pdf_patterns.yml` | PDF类型识别规则 | 季度review |
| `post_processors.yml` | 数据后处理规则 | 按需调整 |

### 12.4 系统依赖

```
# Python依赖（requirements.txt新增）
pdfplumber==0.10.3       # PDF文本提取
PyYAML==6.0.1            # YAML配置解析
python-dateutil==2.8.2   # 日期解析
openpyxl==3.1.2          # Excel生成（可选）

# 前端依赖
Bootstrap 5.3+
jQuery 3.6+
PDF.js 3.x
```

### 12.5 FAQ

#### Q1: 如果PDF识别类型错误怎么办？
**A**: 系统会显示识别置信度，用户可在审核页面手动调整分类。未来版本将支持手动选择PDF类型。

#### Q2: 可以一次导入多个项目吗？
**A**: 当前版本一次导入创建一条采购记录。批量导入多个项目需要分别操作，P2版本将支持批量导入。

#### Q3: 如果提取的字段不准确怎么办？
**A**: 所有字段支持在线编辑，用户可修改后再提交。系统会记录修改，用于优化算法。

#### Q4: 会话过期后数据会丢失吗？
**A**: 会话默认24小时有效，使用"保存草稿"可延长至72小时。过期后临时文件自动清理。

#### Q5: 与现有Excel导入有什么区别？
**A**: 
- Excel导入：适合批量导入、数据转换
- PDF导入：适合单条快速录入、避免手工抄写

两种方式并存，用户可根据场景选择。

### 12.6 未来路线图

#### V1.1 (Q2 2025)
- [ ] 批量导入多个项目
- [ ] 智能文件夹监控
- [ ] 导入质量统计看板
- [ ] 移动端支持

#### V1.2 (Q3 2025)
- [ ] OCR支持（识别扫描件）
- [ ] 智能推荐（基于历史数据）
- [ ] 导入模板定制
- [ ] API接口开放

#### V2.0 (Q4 2025)
- [ ] AI增强识别（使用GPT-4V）
- [ ] 自然语言查询
- [ ] 跨模块智能关联（采购→合同→支付）

---

## 13. 变更记录

| 版本 | 日期 | 修订人 | 变更内容 |
|------|------|--------|---------|
| v1.0 | 2025-01-05 | 系统架构师 | 初始版本，完整PRD |

---

## 14. 审批签字

| 角色 | 姓名 | 签字 | 日期 |
|------|------|------|------|
| 产品经理 | _______ | _______ | _______ |
| 技术负责人 | _______ | _______ | _______ |
| 业务负责人 | _______ | _______ | _______ |
| 项目经理 | _______ | _______ | _______ |

---

## 📊 附件：快速决策矩阵

### 成本收益分析

| 项目 | 估算 |
|------|------|
| 开发成本 | 6人周 × 1万元/周 = 6万元 |
| 部署成本 | 0.5万元 |
| 培训成本 | 0.2万元 |
| **总成本** | **6.7万元** |
| | |
| 效率提升 | 80%（15分钟→3分钟） |
| 每日导入量 | 5条/人 |
| 采购人员数 | 3人 |
| 年节省时间 | 3人 × 5条 × 12分钟 × 250天 = 4,500小时 |
| 时薪 | 50元/小时 |
| **年收益** | **22.5万元** |
| | |
| **投资回报期** | 3.6个月 |
| **ROI** | 236% (第一年) |

### 推荐决策：✅ 强烈建议实施

**理由**:
1. 投资回报期短（<4个月）
2. 技术方案成熟，风险可控
3. 用户需求强烈，接受度高
4. 可扩展性强，支持未来功能扩展

---

**文档结束**

---

## 📝 总结

本PRD详细描述了"采购管理PDF智能导入"功能的完整需求、设计和实施计划。核心亮点包括：

✅ **业务价值明确**: 节省80%录入时间，投资回报期3.6个月  
✅ **技术方案成熟**: 基于已完成的PDF识别模块，风险可控  
✅ **用户体验优先**: 4步完成导入，实时验证，原文对照  
✅ **可维护性强**: 配置驱动，无需改代码即可调整规则  
✅ **完整实施路径**: 6周开发计划，清晰里程碑和验收标准  

**下一步行动**:
1. 
召开PRD评审会议，确认需求细节
2. 技术团队评估工作量和风险
3. 申请开发资源和服务器
4. 启动第一阶段开发工作

**预计正式上线时间**: 2025年2月16日