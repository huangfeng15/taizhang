## ADDED Requirements

### Requirement: 采购生命周期7阶段定义
系统 MUST 定义采购项目从立项到归档的7个标准阶段,支持阶段状态管理。

**ID**: REQ-PL-001
**优先级**: 高

#### Scenario: 阶段枚举定义
- **WHEN** 系统初始化采购生命周期模块
- **THEN** 系统应定义以下7个阶段:
  1. 完成采购计划立项
  2. 完成采购需求
  3. 完成采购文件及规则编制
  4. 完成采购请示及控制价
  5. 完成结果公示
  6. 完成采购合同签订
  7. 完成采购及采购合同归档
- **AND** 每个阶段有唯一标识符和显示名称
- **AND** 阶段按顺序编号(1-7)

#### Scenario: 阶段状态查询
- **WHEN** 用户查询某个采购项目的当前阶段
- **THEN** 系统应返回阶段编号、名称和进入时间
- **AND** 显示该阶段的完成状态(进行中/已完成)
- **AND** 显示下一阶段名称

### Requirement: 阶段转换规则
系统 MUST 实现阶段转换的业务规则,确保流程的合理性和数据完整性。

**ID**: REQ-PL-002
**优先级**: 高

#### Scenario: 单向流程验证
- **WHEN** 用户尝试将采购项目从高阶段回退到低阶段
- **THEN** 系统应拒绝该操作
- **AND** 显示错误提示:"采购流程不支持回退,只能向前推进"
- **AND** 保持当前阶段不变

#### Scenario: 允许跳过中间阶段
- **WHEN** 用户将采购项目从阶段1直接更新到阶段5
- **THEN** 系统应允许该操作
- **AND** 记录跳过的阶段(2,3,4)
- **AND** 触发信息补录检测机制
- **AND** 提示用户补全跳过阶段的必填信息

#### Scenario: 归档阶段锁定
- **WHEN** 采购项目进入阶段7(归档)
- **THEN** 系统应锁定该项目的所有信息
- **AND** 禁止修改任何字段(除非管理员解锁)
- **AND** 显示"已归档"标识
- **AND** 启用"转入台账"功能按钮

### Requirement: 阶段必填字段配置
系统 MUST 为每个阶段定义必填字段清单,支持动态验证。

**ID**: REQ-PL-003
**优先级**: 高

#### Scenario: 阶段一必填字段
- **WHEN** 采购项目处于阶段一(采购计划立项)
- **THEN** 系统应要求以下字段必填:
  - 采购项目名称(project_name)
  - 采购预算金额(budget_amount)
  - 计划结束采购时间(planned_completion_date)
- **AND** 字段为空时显示红色边框和错误提示
- **AND** 保存时验证必填字段完整性

#### Scenario: 阶段二必填字段
- **WHEN** 采购项目处于阶段二(采购需求完成)
- **THEN** 系统应要求以下字段必填:
  - 需求部门(demand_department)
  - 申请人联系电话(demand_contact)
  - 采购需求书审批完成日期(requirement_approval_date)
- **AND** 继承阶段一的必填字段要求
- **AND** 验证日期格式和手机号格式

#### Scenario: 阶段五必填字段(含爬虫字段)
- **WHEN** 采购项目处于阶段五(结果公示完成)
- **THEN** 系统应要求以下手动录入字段:
  - 招采编号(procurement_code)
  - 采购类别(procurement_category)
  - 评标委员会成员(evaluation_committee)
  - 候选人公示期质疑情况(candidate_publicity_issue)
- **AND** 以下字段可通过爬虫自动填充:
  - 采购单位、中标单位、中标金额、公示时间等
- **AND** 爬虫填充的字段允许手动修改

#### Scenario: 阶段六必填字段(合同信息)
- **WHEN** 采购项目处于阶段六(合同签订完成)
- **THEN** 系统应要求以下字段必填:
  - 关联采购编号(procurement_code)
  - 合同序号(contract_sequence)
  - 合同编号(contract_code)
  - 合同签订日期(signing_date)
  - 甲乙方联系信息
  - 合同工期/服务期限(duration)
  - 支付方式(payment_method)
  - 履约担保退回时间(performance_guarantee_return_date)
- **AND** 自动关联字段从采购信息继承:
  - 项目编码、文件定位、合同来源、合同名称等
- **AND** 验证合同编号唯一性

#### Scenario: 阶段七必填字段(归档)
- **WHEN** 采购项目处于阶段七(归档完成)
- **THEN** 系统应要求以下字段必填:
  - 资料归档完成时间(archive_date)
- **AND** 默认采购和合同使用同一归档时间
- **AND** 允许用户分别设置不同归档时间
- **AND** 验证归档时间不早于合同签订时间

### Requirement: 阶段数据存储
系统 MUST 使用JSON字段存储各阶段的详细数据,支持灵活扩展。

**ID**: REQ-PL-004
**优先级**: 中

#### Scenario: JSON数据结构
- **WHEN** 系统保存某个阶段的数据
- **THEN** 系统应将数据存储为JSON格式:
```json
{
  "stage_1": {
    "project_name": "某某项目",
    "budget_amount": 1000000.00,
    "planned_completion_date": "2025-12-31",
    "entered_at": "2025-01-15T10:30:00Z",
    "entered_by": "user123"
  },
  "stage_2": {
    "demand_department": "采购部",
    "demand_contact": "13800138000",
    "requirement_approval_date": "2025-02-01",
    "entered_at": "2025-02-05T14:20:00Z",
    "entered_by": "user123"
  }
}
```
- **AND** 每个阶段数据包含录入时间和录入人
- **AND** 支持查询和更新特定阶段数据

#### Scenario: 历史版本保留
- **WHEN** 用户修改某个阶段的数据
- **THEN** 系统应保留修改前的版本
- **AND** 在JSON中添加history数组记录变更
- **AND** 支持版本对比和回溯

### Requirement: 阶段进度可视化
系统 MUST 提供直观的进度条展示采购项目的当前阶段。

**ID**: REQ-PL-005
**优先级**: 中

#### Scenario: 进度条显示
- **WHEN** 用户查看采购项目详情
- **THEN** 系统应显示7阶段进度条
- **AND** 已完成阶段显示为绿色
- **AND** 当前阶段显示为蓝色(进行中)
- **AND** 未开始阶段显示为灰色
- **AND** 跳过的阶段显示为橙色(需补录)

#### Scenario: 阶段时间线
- **WHEN** 用户点击进度条上的某个阶段
- **THEN** 系统应显示该阶段的详细信息:
  - 进入时间
  - 完成时间(如已完成)
  - 录入人
  - 填写的字段内容
- **AND** 支持导出时间线为PDF

### Requirement: 批量阶段更新
系统 MUST 支持批量更新多个采购项目的阶段,提高录入效率。

**ID**: REQ-PL-006
**优先级**: 低

#### Scenario: 批量选择项目
- **WHEN** 用户在周报录入页面勾选多个采购项目
- **THEN** 系统应显示"批量更新阶段"按钮
- **AND** 点击后弹出批量更新对话框
- **AND** 显示选中项目的当前阶段

#### Scenario: 批量更新执行
- **WHEN** 用户选择目标阶段并点击"确认更新"
- **THEN** 系统应逐个验证每个项目是否可更新到目标阶段
- **AND** 对于可更新的项目执行更新
- **AND** 对于不可更新的项目记录原因并跳过
- **AND** 显示更新结果汇总(成功数/失败数)
- **AND** 提供失败项目的详细列表

### Requirement: 阶段统计分析
系统 MUST 提供采购项目阶段分布的统计分析功能。

**ID**: REQ-PL-007
**优先级**: 低

#### Scenario: 阶段分布统计
- **WHEN** 用户访问采购统计页面
- **THEN** 系统应显示各阶段的项目数量分布
- **AND** 使用饼图或柱状图可视化
- **AND** 支持按项目、时间范围筛选
- **AND** 显示平均停留时间(每个阶段)

#### Scenario: 阶段转换趋势
- **WHEN** 用户查看阶段转换趋势图
- **THEN** 系统应显示最近N周的阶段转换情况
- **AND** 横轴为时间(周)
- **AND** 纵轴为各阶段项目数量
- **AND** 使用折线图展示变化趋势
- **AND** 支持导出为图片或Excel