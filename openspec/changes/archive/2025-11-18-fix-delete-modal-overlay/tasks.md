# 任务清单

## 1. 优化 CustomDialog 组件的模态框关闭逻辑
**文件**: `project/static/js/custom-dialog.js`

- [ ] 修改 `_closeDialog()` 方法，确保立即移除遮罩层而不是延迟移除
- [ ] 添加 `_forceCloseDialog()` 方法，用于强制立即关闭所有模态框
- [ ] 在 `_showDialog()` 方法开始时，调用 `_forceCloseDialog()` 确保旧模态框完全关闭
- [ ] 测试快速连续弹出多个模态框的场景

**验证标准**:
- 快速连续弹出两个模态框时，不会出现遮罩层叠加
- 模态框关闭后，页面可以正常交互
- 不影响现有的模态框功能

## 2. 修复 base.html 中的批量删除逻辑
**文件**: `project/templates/base.html`

- [ ] 修改 `BatchOperations.batchDelete()` 方法
- [ ] 在删除失败时，确保先完全关闭确认模态框
- [ ] 使用 `Promise` 链式调用，确保模态框按顺序打开和关闭
- [ ] 添加适当的延迟（如50-100ms）确保DOM更新完成

**验证标准**:
- 删除失败时，错误提示模态框正常显示
- 关闭错误提示后，页面可以正常操作
- 不会出现透明遮罩层残留

## 3. 更新各列表页面的删除调用
**文件**: 
- `project/templates/procurement_list.html`
- `project/templates/contract_list.html`
- `project/templates/payment_list.html`
- `project/templates/project_list.html`

- [ ] 检查各页面的 `batchDelete` 调用是否使用统一的 `BatchOperations.batchDelete()` 方法
- [ ] 如有自定义删除逻辑，应用相同的修复方案
- [ ] 确保所有删除操作都遵循新的模态框管理规范

**验证标准**:
- 所有列表页面的批量删除功能正常
- 删除失败时不会出现遮罩层问题
- 用户体验一致

## 4. 添加防御性编程措施
**文件**: `project/static/js/custom-dialog.js`

- [ ] 添加全局遮罩层清理函数
- [ ] 在页面加载时检查并清理残留的遮罩层
- [ ] 添加 ESC 键强制关闭所有模态框的功能
- [ ] 添加点击遮罩层外部关闭模态框的功能（如果尚未实现）

**验证标准**:
- 即使出现异常情况，用户也能通过 ESC 键恢复页面操作
- 页面刷新后不会有残留的遮罩层
- 提供多种方式关闭模态框

## 5. 测试和验证
- [ ] 测试正常删除流程
- [ ] 测试删除失败场景（权限不足、网络错误等）
- [ ] 测试快速连续操作
- [ ] 测试不同浏览器的兼容性
- [ ] 测试移动端表现

**验证标准**:
- 所有场景下模态框都能正常工作
- 不会出现遮罩层叠加或残留
- 用户体验流畅

## 6. 文档更新
- [ ] 更新代码注释，说明模态框管理的最佳实践
- [ ] 如有开发文档，添加模态框使用指南
- [ ] 记录已知问题和解决方案

**验证标准**:
- 代码注释清晰易懂
- 其他开发者能够理解并遵循规范