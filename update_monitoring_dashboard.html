<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据更新监控仪表盘 - 终极版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1890ff; --bg-color: #f0f2f5; --card-bg: #ffffff;
            --text-primary: #262626; --text-secondary: #595959; --border-color: #e8e8e8;
            --success-color: #52c41a; --error-color: #ff4d4f; --pending-color: #f0f0f0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --font-family: 'Source Han Sans', 'PingFang SC', 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-primary); margin: 0; padding: 24px; }
        .dashboard-container { max-width: 1800px; margin: 0 auto; }
        .page-header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 24px; gap: 16px; }
        .page-title { font-size: 28px; font-weight: 600; margin: 0; }
        .filter-controls { display: flex; gap: 16px; align-items: center; }
        .filter-controls label { font-size: 14px; }
        .filter-controls select, .filter-controls input[type="date"] { padding: 8px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 16px; }
        .kpi-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 24px; }
        .kpi-card { background: var(--card-bg); border-radius: 12px; padding: 24px; box-shadow: var(--shadow); border-top: 4px solid var(--primary-color); }
        .kpi-card.is-success { border-top-color: var(--success-color); }
        .kpi-card.is-error { border-top-color: var(--error-color); }
        .kpi-card-title { font-size: 15px; color: var(--text-secondary); margin-bottom: 8px; }
        .kpi-card-value { font-size: 40px; font-weight: 700; }
        .kpi-card-value .unit { font-size: 22px; font-weight: 500; margin-left: 6px; }
        .main-content-card { background: var(--card-bg); border-radius: 12px; padding: 24px; box-shadow: var(--shadow); }
        .heatmap-legend { display: flex; flex-wrap: wrap; gap: 16px 24px; margin-bottom: 24px; align-items: center; padding: 16px; background: #fafafa; border-radius: 8px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .legend-color-box { width: 18px; height: 18px; border-radius: 4px; flex-shrink: 0; }
        .legend-color-box.on-time { background-color: var(--success-color); }
        .legend-color-box.delayed { background-color: var(--error-color); }
        .legend-color-box.no-event { background-color: var(--pending-color); border: 1px solid #d9d9d9; }
        .legend-color-box.mixed-event { display: flex; width: 24px; height: 14px; padding: 0; background: none; border: 1px solid #ccc; }
        .mixed-bar-on-time { background-color: var(--success-color); height: 100%; width: 60%; }
        .mixed-bar-delayed { background-color: var(--error-color); height: 100%; width: 40%; }
        .legend-rule { font-size: 13px; color: var(--text-secondary); flex-basis: 100%;}
        .legend-rule strong { color: var(--primary-color); }
        .project-heatmap-container { display: grid; gap: 24px; }
        .project-card { border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; transition: box-shadow 0.3s; }
        .project-card:hover { box-shadow: var(--shadow); }
        .project-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .project-name { font-size: 18px; font-weight: 600; }
        .project-code { font-size: 13px; color: var(--text-secondary); }
        .project-timeliness-rate { font-size: 16px; font-weight: bold; }
        .project-timeliness-rate.good { color: var(--success-color); }
        .project-timeliness-rate.bad { color: var(--error-color); }
        .heatmap-grid { display: grid; grid-template-columns: 100px repeat(12, 1fr); gap: 4px; }
        .grid-header, .module-name, .month-cell { text-align: center; padding: 8px 4px; font-size: 12px; border-radius: 4px; }
        .grid-header { background-color: #fafafa; font-weight: 600; }
        .module-name { background-color: #fafafa; font-weight: 600; display: flex; align-items: center; justify-content: center; }
        .month-cell { height: 30px; cursor: pointer; transition: transform 0.2s; position: relative; display: flex; align-items: center; justify-content: center; }
        .month-cell:hover { transform: scale(1.1); z-index: 10; }
        .month-cell.on-time { background-color: var(--success-color); }
        .month-cell.delayed { background-color: var(--error-color); }
        .month-cell.no-event { background-color: var(--pending-color); }
        .month-cell.mixed-event { padding: 0; background-color: var(--pending-color); overflow: hidden; }
        .ratio-bar { display: flex; width: 100%; height: 100%; }
        .ratio-bar-on-time { background-color: var(--success-color); }
        .ratio-bar-delayed { background-color: var(--error-color); }
        .tooltip { visibility: hidden; width: 240px; background-color: #333; color: #fff; text-align: left; border-radius: 6px; padding: 10px; position: absolute; z-index: 100; bottom: 125%; left: 50%; margin-left: -120px; opacity: 0; transition: opacity 0.3s; font-size: 12px; line-height: 1.5; }
        .tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -5px; border-width: 5px; border-style: solid; border-color: #333 transparent transparent transparent; }
        .month-cell:hover .tooltip { visibility: visible; opacity: 1; }
        .tooltip-title { font-weight: bold; margin-bottom: 5px; border-bottom: 1px solid #555; padding-bottom: 5px; }
        .tooltip-content p { margin: 4px 0; }
        .tooltip-content span { font-weight: normal; color: #ddd; }
        .tooltip-deadline { color: #faad14 !important; }
        .stats-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .stats-title { font-size: 20px; font-weight: 600; margin: 0; }
        .view-toggle { display: flex; border: 1px solid var(--primary-color); border-radius: 6px; overflow: hidden; }
        .toggle-btn { padding: 8px 16px; border: none; background-color: transparent; cursor: pointer; font-size: 14px; color: var(--primary-color); transition: background-color 0.3s, color 0.3s; }
        .toggle-btn.active { background-color: var(--primary-color); color: white; }
        .stats-table-wrapper { overflow-x: auto; }
        .stats-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .stats-table th, .stats-table td { padding: 12px 8px; border: 1px solid var(--border-color); text-align: center; white-space: nowrap; }
        .stats-table thead { background-color: #fafafa; font-weight: 600; }
        .stats-table .col-group-header { border-bottom: 2px solid var(--primary-color); }
        .stats-table .col-subheader { font-size: 12px; color: var(--text-secondary); }
        .stats-table tbody tr:hover { background-color: #f5f5f5; }
        .stats-table .timely { color: var(--success-color); }
        .stats-table .delayed { color: var(--error-color); }
        .stats-table .total { font-weight: bold; }
        .stats-table .row-header { text-align: left; font-weight: bold; }
        .stats-table .rate { font-weight: bold; }
        .stats-table .rate.good { color: var(--success-color); }
        .stats-table .rate.average { color: #faad14; }
        .stats-table .rate.bad { color: var(--error-color); }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <header class="page-header">
            <h1 class="page-title">项目更新准时率</h1>
            <div class="filter-controls">
                <label for="yearFilter">统计年份:</label>
                <select id="yearFilter">
                    <option value="2025" selected>2025年</option>
                    <option value="2024">2024年</option>
                </select>
                <label for="startDateFilter">监控起始日期:</label>
                <input type="date" id="startDateFilter">
            </div>
        </header>

        <section class="kpi-overview">
            <div class="kpi-card"><div class="kpi-card-title">监控中项目总数</div><div class="kpi-card-value" id="kpi-total-projects">-</div></div>
            <div class="kpi-card is-success"><div class="kpi-card-title">总体更新准时率</div><div class="kpi-card-value" id="kpi-timeliness-rate">-</div></div>
            <div class="kpi-card"><div class="kpi-card-title">业务事件总数</div><div class="kpi-card-value" id="kpi-total-events">-</div></div>
            <div class="kpi-card is-error"><div class="kpi-card-title">累计延迟事件数</div><div class="kpi-card-value" id="kpi-delayed-events">-</div></div>
        </section>

        <section class="main-content-card">
            <div class="heatmap-legend">
                <div class="legend-item"><div class="legend-color-box on-time"></div> 准时更新</div>
                <div class="legend-item"><div class="legend-color-box delayed"></div> 延迟更新</div>
                <div class="legend-item"><div class="legend-color-box no-event"></div> 无业务事件</div>
                <div class="legend-item">
                    <div class="legend-color-box mixed-event">
                        <div class="mixed-bar-on-time"></div><div class="mixed-bar-delayed"></div>
                    </div> 混合状态
                </div>
                <div class="legend-rule"><strong>准时更新规则：</strong>指在业务发生的 <strong>次月月底前</strong> 完成数据录入。准时率仅针对 <strong>当前筛选年份内</strong> 发生的业务进行计算。</div>
                <div class="legend-rule"><strong>历史数据规则：</strong>发生于 <strong>“监控起始日期”之前</strong> 的历史业务，不纳入准时率统计。</div>
                <div class="legend-rule"><strong>业务事件触发规则：</strong>采购(中标公示)；合同(签订日期)；付款(付款日期)；结算(完成日期)。</div>
            </div>
            <div id="project-heatmap-container" class="project-heatmap-container"></div>
        </section>

        <section class="main-content-card" style="margin-top: 24px;">
            <div class="stats-header">
                <h2 class="stats-title">详细统计数据</h2>
                <div class="view-toggle">
                    <button id="view-by-project" class="toggle-btn active">按项目统计</button>
                    <button id="view-by-person" class="toggle-btn">按人员统计</button>
                </div>
            </div>
            <div id="statistics-table-container" class="stats-table-wrapper"></div>
        </section>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const mockData = {
            '2025': [
                {
                    id: 1, name: '智慧城市一期建设项目', code: 'PRJ-2025-001',
                    modules: {
                        procurement: [ { eventDate: '2025-01-15', updateDate: '2025-02-28', handler: '张三' }, { eventDate: '2025-03-10', updateDate: '2025-05-01', handler: '李四' } ],
                        contract: [ { eventDate: '2025-02-20', updateDate: '2025-02-25', handler: '张三' }, { eventDate: '2025-02-28', updateDate: '2025-04-01', handler: '王五' } ],
                        payment: [ { eventDate: '2025-04-05', updateDate: '2025-06-01', handler: '李四' } ],
                        settlement: []
                    }
                },
                {
                    id: 2, name: '总部研发大楼智能化工程', code: 'PRJ-2025-002',
                    modules: {
                        procurement: [ { eventDate: '2025-02-10', updateDate: '2025-04-01', handler: '王五' } ],
                        contract: [ { eventDate: '2025-05-10', updateDate: '2025-05-15', handler: '张三' } ],
                        payment: [],
                        settlement: []
                    }
                }
            ],
            '2024': [
                 {
                    id: 3, name: '西北区物流仓储系统升级', code: 'PRJ-2024-001',
                    modules: {
                        procurement: [ { eventDate: '2024-08-20', updateDate: '2024-08-22', handler: '李四' } ],
                        contract: [ { eventDate: '2024-09-01', updateDate: '2024-10-30', handler: '王五' } ],
                        payment: [ { eventDate: '2024-10-15', updateDate: '2024-11-20', handler: '张三' }, { eventDate: '2024-10-20', updateDate: '2024-12-01', handler: '李四' }, { eventDate: '2024-10-25', updateDate: '2024-11-15', handler: '张三' } ],
                        settlement: [ { eventDate: '2024-12-20', updateDate: '2025-02-10', handler: '王五' } ]
                    }
                }
            ]
        };

        const yearFilter = document.getElementById('yearFilter');
        const startDateFilter = document.getElementById('startDateFilter');
        const heatmapContainer = document.getElementById('project-heatmap-container');
        const statsContainer = document.getElementById('statistics-table-container');
        const viewByProjectBtn = document.getElementById('view-by-project');
        const viewByPersonBtn = document.getElementById('view-by-person');
        let currentStatsView = 'project';
        let calculatedStats = {};

        const MODULE_KEYS = ['procurement', 'contract', 'payment', 'settlement'];
        const MODULE_NAME_MAP = { procurement: '采购', contract: '合同', payment: '付款', settlement: '结算' };

        function isTimely(eventDateStr, updateDateStr) {
            const eventDate = new Date(eventDateStr);
            const updateDate = new Date(updateDateStr);
            const monthDiff = (updateDate.getFullYear() - eventDate.getFullYear()) * 12 + (updateDate.getMonth() - eventDate.getMonth());
            return monthDiff <= 1;
        }

        function getDeadline(eventDateStr) {
            const eventDate = new Date(eventDateStr);
            const deadline = new Date(eventDate.getFullYear(), eventDate.getMonth() + 2, 0);
            return deadline.toISOString().split('T')[0];
        }

        function calculateAllStats(projects, startDate) {
            const stats = { byProject: {}, byPerson: {}, global: { totalEvents: 0, onTimeEvents: 0 } };
            const createStatObject = () => ({ timely: 0, delayed: 0, total: 0 });
            const createModuleStats = () => MODULE_KEYS.reduce((acc, key) => ({ ...acc, [key]: createStatObject() }), { total: createStatObject() });

            projects.forEach(project => {
                stats.byProject[project.name] = createModuleStats();
                MODULE_KEYS.forEach(moduleKey => {
                    project.modules[moduleKey].forEach(event => {
                        if (new Date(event.eventDate) < new Date(startDate)) {
                            return; // Exclude data before start date
                        }

                        if (!stats.byPerson[event.handler]) {
                            stats.byPerson[event.handler] = createModuleStats();
                        }
                        const timely = isTimely(event.eventDate, event.updateDate);
                        
                        const updateCounts = (obj) => {
                            obj.total++;
                            if (timely) obj.timely++; else obj.delayed++;
                        };

                        updateCounts(stats.byProject[project.name][moduleKey]);
                        updateCounts(stats.byProject[project.name].total);
                        updateCounts(stats.byPerson[event.handler][moduleKey]);
                        updateCounts(stats.byPerson[event.handler].total);
                        
                        stats.global.totalEvents++;
                        if(timely) stats.global.onTimeEvents++;
                    });
                });
            });
            return stats;
        }

        function renderDashboard() {
            const selectedYear = yearFilter.value;
            const startDate = startDateFilter.value;
            const projects = mockData[selectedYear] || [];
            heatmapContainer.innerHTML = '';
            
            calculatedStats = calculateAllStats(projects, startDate);

            const { global } = calculatedStats;
            const overallTimelinessRate = global.totalEvents > 0 ? (global.onTimeEvents / global.totalEvents) * 100 : 100;
            document.getElementById('kpi-total-projects').textContent = projects.length;
            document.getElementById('kpi-timeliness-rate').innerHTML = `${overallTimelinessRate.toFixed(1)}<span class="unit">%</span>`;
            document.getElementById('kpi-total-events').textContent = global.totalEvents;
            document.getElementById('kpi-delayed-events').textContent = global.totalEvents - global.onTimeEvents;

            projects.forEach(project => {
                const projectCard = document.createElement('div');
                projectCard.className = 'project-card';
                let totalEvents = 0;
                let onTimeEvents = 0;
                const heatmapGrid = document.createElement('div');
                heatmapGrid.className = 'heatmap-grid';
                heatmapGrid.innerHTML += `<div class="grid-header"></div>` + Array.from({length: 12}, (_, i) => `<div class="grid-header">${i+1}月</div>`).join('');

                MODULE_KEYS.forEach(moduleKey => {
                    heatmapGrid.innerHTML += `<div class="module-name">${MODULE_NAME_MAP[moduleKey]}</div>`;
                    const monthlyEvents = {};
                    project.modules[moduleKey].forEach(event => {
                        if (new Date(event.eventDate) < new Date(startDate)) return;
                        const eventMonth = new Date(event.eventDate).getMonth() + 1;
                        if (!monthlyEvents[eventMonth]) monthlyEvents[eventMonth] = [];
                        monthlyEvents[eventMonth].push(event);
                    });

                    for (let month = 1; month <= 12; month++) {
                        const events = monthlyEvents[month];
                        let cellClass = 'month-cell no-event';
                        let cellContent = '';
                        let tooltipContent = '';

                        if (events) {
                            totalEvents += events.length;
                            const onTimeCount = events.filter(e => isTimely(e.eventDate, e.updateDate)).length;
                            onTimeEvents += onTimeCount;
                            const delayedCount = events.length - onTimeCount;

                            if (events.length === 1) {
                                cellClass = onTimeCount === 1 ? 'month-cell on-time' : 'month-cell delayed';
                            } else {
                                if (delayedCount === 0) cellClass = 'month-cell on-time';
                                else if (onTimeCount === 0) cellClass = 'month-cell delayed';
                                else {
                                    cellClass = 'month-cell mixed-event';
                                    const onTimeRatio = (onTimeCount / events.length) * 100;
                                    cellContent = `<div class="ratio-bar"><div class="ratio-bar-on-time" style="width: ${onTimeRatio}%"></div><div class="ratio-bar-delayed" style="width: ${100 - onTimeRatio}%"></div></div>`;
                                }
                            }
                            tooltipContent = `<div class="tooltip-title">${month}月 - ${MODULE_NAME_MAP[moduleKey]}</div><div class="tooltip-content"><p>准时事件: <span>${onTimeCount}</span></p><p>延迟事件: <span>${delayedCount}</span></p><hr>${events.map(e => `<p>发生: ${e.eventDate} | 录入: ${e.updateDate} <br><strong class="tooltip-deadline">截止: ${getDeadline(e.eventDate)}</strong></p>`).join('')}</div>`;
                        }
                        heatmapGrid.innerHTML += `<div class="${cellClass}">${cellContent}<div class="tooltip">${tooltipContent}</div></div>`;
                    }
                });

                const overallRate = totalEvents > 0 ? (onTimeEvents / totalEvents) * 100 : 100;
                const rateClass = overallRate >= 80 ? 'good' : 'bad';
                projectCard.innerHTML = `<div class="project-header"><div><div class="project-name">${project.name}</div><div class="project-code">${project.code}</div></div><div class="project-timeliness-rate ${rateClass}">准时率: ${overallRate.toFixed(1)}%</div></div>`;
                projectCard.appendChild(heatmapGrid);
                heatmapContainer.appendChild(projectCard);
            });

            renderStatisticsTable();
        }

        function renderStatisticsTable() {
            const data = currentStatsView === 'project' ? calculatedStats.byProject : calculatedStats.byPerson;
            const headerName = currentStatsView === 'project' ? '项目名称' : '经办人';

            const tableHeaders = `
                <thead>
                    <tr>
                        <th rowspan="2">${headerName}</th>
                        ${MODULE_KEYS.map(key => `<th colspan="4" class="col-group-header">${MODULE_NAME_MAP[key]}</th>`).join('')}
                        <th colspan="4" class="col-group-header">总计</th>
                    </tr>
                    <tr>
                        ${[...MODULE_KEYS, 'total'].map(() => `<th class="col-subheader">准时</th><th class="col-subheader">延迟</th><th class="col-subheader">总数</th><th class="col-subheader">准时率</th>`).join('')}
                    </tr>
                </thead>
            `;

            const tableBody = `
                <tbody>
                    ${Object.keys(data).map(key => `
                        <tr>
                            <td class="row-header">${key}</td>
                            ${[...MODULE_KEYS, 'total'].map(moduleKey => {
                                const moduleData = data[key][moduleKey];
                                const rate = moduleData.total > 0 ? (moduleData.timely / moduleData.total) * 100 : -1;
                                let rateClass = '';
                                if (rate >= 90) rateClass = 'good';
                                else if (rate >= 60) rateClass = 'average';
                                else if (rate >= 0) rateClass = 'bad';

                                return `
                                    <td class="timely">${moduleData.timely}</td>
                                    <td class="delayed">${moduleData.delayed}</td>
                                    <td class="total">${moduleData.total}</td>
                                    <td class="rate ${rateClass}">${rate >= 0 ? rate.toFixed(1) + '%' : '-'}</td>
                                `;
                            }).join('')}
                        </tr>
                    `).join('')}
                </tbody>
            `;

            statsContainer.innerHTML = `<table class="stats-table">${tableHeaders}${tableBody}</table>`;
        }
        
        function setInitialStartDate() {
            const selectedYear = yearFilter.value;
            startDateFilter.value = `${selectedYear}-01-01`;
        }

        viewByProjectBtn.addEventListener('click', () => {
            if (currentStatsView === 'project') return;
            currentStatsView = 'project';
            viewByProjectBtn.classList.add('active');
            viewByPersonBtn.classList.remove('active');
            renderStatisticsTable();
        });

        viewByPersonBtn.addEventListener('click', () => {
            if (currentStatsView === 'person') return;
            currentStatsView = 'person';
            viewByPersonBtn.classList.add('active');
            viewByProjectBtn.classList.remove('active');
            renderStatisticsTable();
        });

        yearFilter.addEventListener('change', () => {
            setInitialStartDate();
            renderDashboard();
        });
        startDateFilter.addEventListener('change', renderDashboard);

        setInitialStartDate();
        renderDashboard();
    });
    </script>

</body>
</html>