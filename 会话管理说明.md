# 会话管理与登录策略说明

## ✅ 已配置的登录策略

### 1. 每日自动登出
- **Session有效期**：24小时（1天）
- **效果**：用户登录后，24小时后会自动失效，需要重新登录
- **场景**：每天上班时需要重新登录一次

### 2. Session安全设置
```python
SESSION_COOKIE_AGE = 86400  # 24小时后过期
SESSION_SAVE_EVERY_REQUEST = True  # 每次请求刷新过期时间
SESSION_EXPIRE_AT_BROWSER_CLOSE = False  # 不随浏览器关闭而失效
SESSION_COOKIE_SECURE = True  # 仅HTTPS传输
SESSION_COOKIE_HTTPONLY = True  # 防JS窃取
SESSION_COOKIE_SAMESITE = 'Lax'  # 防CSRF
```

---

## 🔄 清除所有现有会话（强制重新登录）

### 使用场景
1. ✅ **启用HTTPS后**（您当前的情况）- 清除HTTP时期的旧会话
2. ✅ **安全升级后** - 要求所有用户重新认证
3. ✅ **发现安全问题** - 立即让所有会话失效
4. ✅ **修改密码策略后** - 强制重新登录

### 执行步骤

#### 方法1：运行Python脚本（推荐）
```bash
python 清除所有会话.py
```

脚本会：
1. 显示当前会话数量
2. 要求确认操作（输入 yes）
3. 清除所有会话
4. 提示下一步操作

#### 方法2：Django管理命令
```bash
python manage.py shell
```

然后执行：
```python
from django.contrib.sessions.models import Session
count = Session.objects.count()
print(f"清除 {count} 个会话")
Session.objects.all().delete()
print("完成！")
```

#### 方法3：数据库直接操作（高级）
```bash
python manage.py dbshell
```

然后执行：
```sql
DELETE FROM django_session;
```

---

## 📋 完整操作流程（HTTPS升级后）

### 第1步：清除旧会话
```bash
python 清除所有会话.py
```
输入 `yes` 确认

### 第2步：重启服务器（使用HTTPS）
```bash
python manage.py runserver_plus --cert-file ssl/cert.pem --key-file ssl/key.pem 0.0.0.0:3500
```
或双击：`启动HTTPS服务器.bat`

### 第3步：通知所有用户
发送通知邮件或消息：

```
【系统升级通知】

各位同事：

系统已升级为HTTPS加密访问，请按以下步骤操作：

1. 访问新地址：https://10.168.3.240:3500 (注意是https)
2. 首次访问会提示安全警告，点击"高级" → "继续前往"
3. 使用原账号密码重新登录

变更说明：
- 新增HTTPS加密传输，提升安全性
- 所有用户需重新登录一次
- 登录有效期为24小时，每天需重新登录一次

如有问题，请联系IT部门。
```

---

## ⏰ 登录时间策略详解

### 默认策略：24小时自动登出

#### 示例场景1：正常工作日
```
周一 09:00 - 登录
周一 09:00 ~ 周二 09:00 - 可以正常使用（期间每次访问都会刷新24小时）
周二 09:01 - 如果超过24小时没访问，自动登出
```

#### 示例场景2：持续使用
```
周一 09:00 - 登录
周一 17:00 - 下班前最后一次访问（刷新到周二17:00）
周二 08:30 - 上班访问，仍然有效（距离上次访问不到24小时）
周二 08:30 - 刷新到周三08:30
```

### 其他可选策略

#### 策略A：固定每天早上9点过期
修改 `config/settings.py`：
```python
# 在中间件中添加自定义逻辑
# 或使用 django-session-timeout 包
```

#### 策略B：下班自动登出（12小时）
```python
SESSION_COOKIE_AGE = 43200  # 12小时
```

#### 策略C：关闭浏览器就登出
```python
SESSION_EXPIRE_AT_BROWSER_CLOSE = True
SESSION_COOKIE_AGE = 86400  # 保留作为备用
```

#### 策略D：一周登录一次
```python
SESSION_COOKIE_AGE = 604800  # 7天
```

---

## 🔍 会话监控

### 查看当前活跃会话
```bash
python manage.py shell
```

```python
from django.contrib.sessions.models import Session
from django.utils import timezone

# 总会话数
total = Session.objects.count()
print(f"总会话数: {total}")

# 未过期的会话
valid = Session.objects.filter(expire_date__gte=timezone.now()).count()
print(f"有效会话: {valid}")

# 已过期但未清理的会话
expired = Session.objects.filter(expire_date__lt=timezone.now()).count()
print(f"过期会话: {expired}")
```

### 定期清理过期会话
```bash
# 手动清理
python manage.py clearsessions

# 建议：每天凌晨自动执行（使用Windows计划任务）
```

---

## ❓ 常见问题

### Q1: 为什么设置了24小时，但用户用着用着还是被登出了？
**A:** 
- 检查是否设置了 `SESSION_SAVE_EVERY_REQUEST = True`
- 如果为False，只有在session数据变化时才会刷新
- 建议设置为True，每次访问都刷新过期时间

### Q2: 用户抱怨每天都要登录很麻烦怎么办？
**A:** 可以调整策略：
```python
SESSION_COOKIE_AGE = 604800  # 改为7天
# 或
SESSION_COOKIE_AGE = 2592000  # 改为30天
```
但要权衡安全性与便利性。

### Q3: 清除会话后，用户会立即被登出吗？
**A:** 
- 已登录的用户在**下次请求**时会被要求重新登录
- 不需要等24小时
- 建议通知用户刷新页面

### Q4: HTTPS升级后必须清除会话吗？
**A:** 
- **强烈建议清除**，因为：
  1. HTTP时期的Cookie不安全
  2. 新配置了 `SESSION_COOKIE_SECURE = True`
  3. 旧会话可能导致兼容问题
- 清除后所有用户需重新登录一次

### Q5: 如何只清除某个用户的会话？
**A:**
```python
from django.contrib.sessions.models import Session
from django.contrib.auth.models import User

# 获取用户
user = User.objects.get(username='张三')

# 清除该用户的所有会话
Session.objects.filter(
    session_data__contains=f'"_auth_user_id":"{user.id}"'
).delete()
```

---

## 📊 安全最佳实践

### 推荐配置（已应用）
```python
SESSION_COOKIE_AGE = 86400  # 24小时 ✅
SESSION_SAVE_EVERY_REQUEST = True  # 自动刷新 ✅
SESSION_COOKIE_SECURE = True  # 仅HTTPS ✅
SESSION_COOKIE_HTTPONLY = True  # 防窃取 ✅
SESSION_COOKIE_SAMESITE = 'Lax'  # 防CSRF ✅
```

### 额外建议
1. ✅ 定期清理过期会话（每天凌晨）
2. ✅ 监控异常登录（多地点、多设备）
3. ✅ 强制复杂密码策略
4. ✅ 记录登录日志
5. ✅ 重要操作二次验证

---

## 📞 技术支持

配置文件位置：
- Session设置：`config/settings.py` (第82-89行)
- 清理脚本：`清除所有会话.py`
- 登录中间件：`project/middleware/login_required.py`

如有问题，请联系IT部门。